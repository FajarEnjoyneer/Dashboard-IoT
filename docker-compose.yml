version: "3.8"

services:
  influxdb:
    image: influxdb:2.7
    container_name: influxdb-opt
    restart: unless-stopped
    ports:
      - "8086:8086"
    environment:
      DOCKER_INFLUXDB_INIT_MODE: "setup"
      DOCKER_INFLUXDB_INIT_USERNAME: "${INFLUX_USERNAME}"
      DOCKER_INFLUXDB_INIT_PASSWORD: "${INFLUX_PASSWORD}"
      DOCKER_INFLUXDB_INIT_ORG: "${INFLUX_ORG}"
      DOCKER_INFLUXDB_INIT_BUCKET: "${INFLUX_BUCKET}"
      DOCKER_INFLUXDB_INIT_ADMIN_TOKEN: "${INFLUX_TOKEN}"
    volumes:
      - ./influxdb/data:/var/lib/influxdb2
    networks:
      - iot-net

  grafana:  # Grafana Service
    image: grafana/grafana-enterprise:latest
    container_name: grafana-opt
    restart: unless-stopped
    depends_on:
      - influxdb
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_USER: "${GF_ADMIN_USER}"
      GF_SECURITY_ADMIN_PASSWORD: "${GF_ADMIN_PASSWORD}"
      GF_PATHS_HOME: "/usr/share/grafana"
      GF_LOG_MODE: "console"
      GF_USERS_DEFAULT_THEME: "${GF_USERS_DEFAULT_THEME:-light}"
      GF_PANELS_DISABLE_SANITIZE_HTML: "${GF_PANELS_DISABLE_SANITIZE_HTML:-true}"
      GF_NEWS_NEWS_FEED_ENABLED: "${GF_NEWS_NEWS_FEED_ENABLED:-false}"
      GF_LIVE_ENABLED: "false"
    volumes:
      - ./grafana/public:/usr/share/grafana/public
      - ./grafana/provisioning:/etc/grafana/provisioning
      - ./grafana/dashboards:/var/lib/grafana/dashboards
      - ./grafana/data:/var/lib/grafana
    networks:
      - iot-net

  grafana-provisioner:    # Provision InfluxDB datasource
    image: curlimages/curl:8.2.1
    container_name: grafana-provisioner
    depends_on:
      - grafana
    environment:
      GF_ADMIN_USER: "${GF_ADMIN_USER}"
      GF_ADMIN_PASSWORD: "${GF_ADMIN_PASSWORD}"
      INFLUX_TOKEN: "${INFLUX_TOKEN}"
      INFLUX_ORG: "${INFLUX_ORG}"
      INFLUX_BUCKET: "${INFLUX_BUCKET}"
    networks:
      - iot-net
    restart: "no"
    command: >
      /bin/sh -c '
        until curl -sSf http://grafana:3000/api/health > /dev/null 2>&1; do sleep 2; done;
        cat > /tmp/ds.json <<-JSON || exit 1
        {
          "name":"influxdb-auto",
          "type":"influxdb",
          "access":"proxy",
          "url":"http://influxdb:8086",
          "isDefault": true,
          "jsonData": { "version":"Flux", "organization":"'"${INFLUX_ORG}"'", "defaultBucket":"'"${INFLUX_BUCKET}"'" },
          "secureJsonData": { "token":"'"${INFLUX_TOKEN}"'" }
        }
        JSON
        curl -s -u "${GF_ADMIN_USER}:${GF_ADMIN_PASSWORD}" -H "Content-Type: application/json" \
          -X POST http://grafana:3000/api/datasources -d @/tmp/ds.json || true;
        echo "grafana-provisioner finished";
      '

  grafana-importer: # Import dashboards to Grafana
    image: alpine:3.18
    container_name: grafana-importer
    depends_on:
      - grafana
      - grafana-provisioner
    environment:
      GF_ADMIN_USER: "${GF_ADMIN_USER}"
      GF_ADMIN_PASSWORD: "${GF_ADMIN_PASSWORD}"
      TARGET_DS: "influxdb-auto"
      GRAFANA_URL: "http://grafana:3000"
    volumes:
      - ./uploads:/uploads
      - ./grafana/dashboards:/dashboards
      - ./grafana/import-dashboards.sh:/import-dashboards.sh
    networks:
      - iot-net
    restart: "no"
    entrypoint: ["/bin/sh", "/import-dashboards.sh"]

  nodered:  # Node-RED Service
    image: nodered/node-red:latest
    container_name: nodered-opt
    restart: unless-stopped
    ports:
      - "1880:1880"
    volumes:
      - ./nodered/data:/data
    environment:
      TZ: "Asia/Jakarta"
    networks:
      - iot-net

  mosquitto:  # Mosquitto MQTT Broker
    image: eclipse-mosquitto:latest
    container_name: mosquitto-opt
    restart: unless-stopped
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./mosquitto/config/mosquitto.conf:/mosquitto/config/mosquitto.conf
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/log:/mosquitto/log
    networks:
      - iot-net

networks:
  iot-net:
    driver: bridge
