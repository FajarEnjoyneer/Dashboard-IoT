"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[2792],{58843:(Ut,Fe,l)=>{l.d(Fe,{L5:()=>d,hr:()=>a,jN:()=>M});var e=l(79609),u=l(92745);function d(k){}function a(k){switch(k){case e.CC.Logfmt:return{label:(0,u.t)("correlations.trans-details.logfmt-label","Logfmt"),value:e.CC.Logfmt,description:(0,u.t)("correlations.trans-details.logfmt-description","Parse provided field with logfmt to get variables"),expressionDetails:{show:!1},mapValueDetails:{show:!1}};case e.CC.Regex:return{label:(0,u.t)("correlations.trans-details.regex-label","Regular expression"),value:e.CC.Regex,description:(0,u.t)("correlations.trans-details.regex-description","Field will be parsed with regex. Use named capture groups to return multiple variables, or a single unnamed capture group to add variable to named map value. Regex is case insensitive."),expressionDetails:{show:!0,required:!0,helpText:(0,u.t)("correlations.trans-details.regex-expression","Use capture groups to extract a portion of the field.")},mapValueDetails:{show:!0,required:!1,helpText:(0,u.t)("correlations.trans-details.regex-map-values","Defines the name of the variable if the capture group is not named.")}};default:return{label:k,value:k,expressionDetails:{show:!1},mapValueDetails:{show:!1}}}}const M=()=>Object.values(e.CC).map(k=>{const se=a(k);return{label:se.label,value:se.value,description:se.description}})},30411:(Ut,Fe,l)=>{l.r(Fe),l.d(Fe,{default:()=>Hi});var e=l(74848),u=l(22803),d=l(96540),a=l(92745),M=l(43173),k=l(63142),se=l(36303),Gt=l(77808),Me=l(27963),nt=l(45776),O=l(52763),Ue=l(2739),qt=function(t,s){t===void 0&&(t=!0);var o=(0,d.useCallback)(function(n){var r=typeof t=="function"?t():!0;if(r)return n.preventDefault(),s&&(n.returnValue=s),s},[t,s]);(0,d.useEffect)(function(){if(t)return(0,Ue.on)(window,"beforeunload",o),function(){return(0,Ue.AU)(window,"beforeunload",o)}},[t,o])};const vt=qt;var rt=l(64305),at=l(6773),A=l(27489),E=l(41654),U=l(45967),V=l(30703),P=l(45861),je=l(83560),_=l(72265),De=l(22787);const Ge=({onSave:t,onDiscard:s,onCancel:o,message:n})=>(0,e.jsxs)(De.a,{isOpen:!0,title:(0,a.t)("explore.correlation-unsaved-changes-modal.title-unsaved-changes-to-correlation","Unsaved changes to correlation"),onDismiss:o,icon:"exclamation-triangle",className:(0,u.css)({width:"600px"}),children:[(0,e.jsx)("h5",{children:n}),(0,e.jsxs)(De.a.ButtonRow,{children:[(0,e.jsx)(P.$n,{variant:"secondary",onClick:o,fill:"outline",children:(0,e.jsx)(a.x6,{i18nKey:"explore.correlation-unsaved-changes-modal.cancel",children:"Cancel"})}),(0,e.jsx)(P.$n,{variant:"destructive",onClick:s,children:(0,e.jsx)(a.x6,{i18nKey:"explore.correlation-unsaved-changes-modal.continue-without-saving",children:"Continue without saving"})}),(0,e.jsx)(P.$n,{variant:"primary",onClick:t,children:(0,e.jsx)(a.x6,{i18nKey:"explore.correlation-unsaved-changes-modal.save-correlation",children:"Save correlation"})})]})]});var G=l(2543),zo=(t=>(t.SOURCE_TARGET_CHANGE="cause the query in the right pane to be re-ran and links added to that data",t.FULL_QUERY_LOSS="lose the changed query",t.FULL_CORR_LOSS="cause the correlation in progress to be lost",t.INVALID_VAR="remove the variables, and your changed query may no longer be valid",t))(zo||{});const Ko=(t,s,o,n)=>{const r=(0,G.template)("<%= actionStr %> will <%= consequenceStr %>. Would you like to save before continuing?");let i="",c="";if(t===_.IW.CLOSE_PANE)if(i="Closing the pane",s)if(o)c="cause the correlation in progress to be lost";else if(n)c="cause the query in the right pane to be re-ran and links added to that data";else return;else if(o)c="cause the correlation in progress to be lost";else if(n)c="lose the changed query";else return;else if(t===_.IW.CHANGE_DATASOURCE)if(i="Changing the datasource",s)if(o)c="cause the correlation in progress to be lost";else return;else if(n)c="lose the changed query";else return;else if(t===_.IW.CLOSE_EDITOR)if(i="Closing the editor",o)c="cause the correlation in progress to be lost";else if(n)c="remove the variables, and your changed query may no longer be valid";else return;return r({actionStr:i,consequenceStr:c})};var Uo=l(80763),Re=l(707),Te=l(51845),q=l(35231),W=l(19050),Z=l(20718);const Go=({panes:t})=>{const s=(0,O.wA)(),o=(0,k.of)(qo),n=(0,O.d4)(Z.vC),r=(0,O.d4)(Z.st),[i,c]=(0,d.useState)(void 0);vt(n?.correlationDirty||!1,"Save correlation?"),vt(!n?.correlationDirty&&n?.queryEditorDirty||!1,"The query editor was changed. Save correlation before continuing?"),(0,d.useEffect)(()=>{if(n?.isExiting){const{correlationDirty:g,queryEditorDirty:x}=n;let y,R;n.postConfirmAction?(y=n.postConfirmAction.isActionLeft,R=n.postConfirmAction.action):(R=_.IW.CLOSE_EDITOR,y=!1);const b=Ko(R,y,g,x);if(b!==void 0)c(b);else if(R===_.IW.CHANGE_DATASOURCE&&n.postConfirmAction){const{exploreId:j,changeDatasourceUid:S}=n?.postConfirmAction;j&&S&&(s((0,Re.wh)({exploreId:j,datasource:S,options:{importQueries:!0}})),s((0,q.am)({isExiting:!1})))}else if(R===_.IW.CLOSE_PANE&&n.postConfirmAction){const{exploreId:j}=n?.postConfirmAction;j!==void 0&&(s((0,q.J8)(j)),s((0,q.am)({isExiting:!1})))}else R===_.IW.CLOSE_EDITOR&&s((0,q.am)({editorMode:!1}))}},[n,s,r]),(0,rt.A)(()=>{s((0,q.am)({editorMode:!1,isExiting:!1,correlationDirty:!1,label:void 0,description:void 0,canSave:!1})),t.forEach(g=>{s((0,Te.nE)({exploreId:g[0],correlationEditorHelperData:void 0})),s((0,W.Od)({exploreId:g[0]}))})});const h=()=>{s((0,q.am)({editorMode:!0,isExiting:!1,correlationDirty:!1,label:void 0,description:void 0,canSave:!1})),t.forEach(g=>{s((0,Te.nE)({exploreId:g[0],correlationEditorHelperData:void 0})),s((0,W.Od)({exploreId:g[0]}))})},m=g=>{c(void 0),s((0,q.J8)(g)),(0,A.rR)("grafana_explore_split_view_closed")},f=(g,x)=>{c(void 0),s((0,Re.wh)({exploreId:g,datasource:x,options:{importQueries:!0}}))},p=g=>{if(s((0,Uo.v)(n?.label,n?.description,n?.transformations)),!g&&n?.postConfirmAction!==void 0){const{exploreId:x,action:y,changeDatasourceUid:R}=n?.postConfirmAction;y===_.IW.CLOSE_PANE?(m(x),h()):y===_.IW.CHANGE_DATASOURCE&&R!==void 0&&((0,Re.wh)({exploreId:x,datasource:R}),h())}else s((0,q.am)({editorMode:!1,correlationDirty:!1,isExiting:!1}))};return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(je.X,{message:g=>g.pathname!=="/explore"&&n?.editorMode&&n?.correlationDirty?"You have unsaved correlation data. Continue?":!0}),i!==void 0&&(0,e.jsx)(Ge,{onDiscard:()=>{if(n?.postConfirmAction!==void 0){const{exploreId:g,action:x,changeDatasourceUid:y}=n?.postConfirmAction;x===_.IW.CLOSE_PANE?m(g):x===_.IW.CHANGE_DATASOURCE&&y!==void 0&&f(g,y),s((0,q.am)({isExiting:!1}))}else s((0,q.am)({editorMode:!1,correlationDirty:!1,isExiting:!1}))},onCancel:()=>{s((0,q.am)({isExiting:!1})),c(void 0)},onSave:()=>{p(!1)},message:i}),(0,e.jsx)("div",{className:o.correlationEditorTop,children:(0,e.jsxs)(E.B,{gap:2,justifyContent:"flex-end",alignItems:"center",children:[(0,e.jsx)(U.m,{content:(0,a.t)("explore.correlation-editor-mode-bar.content-correlations-editor-explore-experimental-feature","Correlations editor in Explore is an experimental feature."),children:(0,e.jsx)(V.I,{className:o.iconColor,name:"info-circle",size:"xl"})}),(0,e.jsx)(P.$n,{variant:"secondary",disabled:!n?.canSave,fill:"outline",className:n?.canSave?o.buttonColor:o.disabledButtonColor,onClick:()=>{p(!0)},children:(0,e.jsx)(a.x6,{i18nKey:"explore.correlation-editor-mode-bar.save",children:"Save"})}),(0,e.jsx)(P.$n,{variant:"secondary",fill:"outline",className:o.buttonColor,icon:"times",onClick:()=>{s((0,q.am)({isExiting:!0})),(0,A.rR)("grafana_explore_correlation_editor_exit_pressed")},children:(0,e.jsx)(a.x6,{i18nKey:"explore.correlation-editor-mode-bar.exit-correlation-editor",children:"Exit correlation editor"})})]})})]})},qo=t=>{const s=t.colors.getContrastText(t.colors.primary.main),o=at.MV.lighten(t.colors.primary.main,.1),n=at.MV.darken(t.colors.primary.main,.2),r=at.MV.darken(s,.2);return{correlationEditorTop:(0,u.css)({backgroundColor:t.colors.primary.main,marginTop:"3px",padding:t.spacing(1)}),iconColor:(0,u.css)({color:s}),buttonColor:(0,u.css)({color:s,borderColor:s,"&:hover":{color:s,borderColor:s,backgroundColor:o}}),disabledButtonColor:(0,u.css)({color:`${r} !important`,backgroundColor:`${n} !important`})}};var Zt=l(1503),bt=l(15130),qe=l(18615),Ze=l(11257);const Zo=()=>{const[t,s]=(0,d.useState)([]),{query:o}=(0,Zt.useKBar)(),n=(0,O.wA)(),r=(0,O.d4)(Z.Qb),i=(0,O.d4)(Z.pF),c=bt.TP.hasPermission(Ze.w.DataSourcesWrite);return(0,d.useEffect)(()=>{const h=Object.keys(r),m={name:"Explore",priority:Zt.Priority.HIGH+1},f=[];if(i)f.push({id:"explore/run-query-left",name:"Run query (left)",keywords:"query left",perform:()=>{n((0,W.Od)({exploreId:h[0]}))},section:m}),r[1]&&(f.push({id:"explore/run-query-right",name:"Run query (right)",keywords:"query right",perform:()=>{n((0,W.Od)({exploreId:h[1]}))},section:m}),f.push({id:"explore/split-view-close-left",name:"Close split view left",keywords:"split",perform:()=>{n((0,q.J8)(h[0]))},section:m}),f.push({id:"explore/split-view-close-right",name:"Close split view right",keywords:"split",perform:()=>{n((0,q.J8)(h[1]))},section:m}));else{const p=Object.values(r).some(g=>g?.datasourceInstance?.uid===qe.uv);M.$.featureToggles.correlations&&c&&!p&&f.push({id:"explore/correlations-editor",name:"Correlations editor",perform:()=>{n((0,q.am)({editorMode:!0})),n((0,W.Od)({exploreId:h[0]}))},section:m}),f.push({id:"explore/run-query",name:"Run query",keywords:"query",perform:()=>{n((0,W.Od)({exploreId:h[0]}))},section:m}),f.push({id:"explore/split-view-open",name:"Open split view",keywords:"split",perform:()=>{n((0,q.ve)())},section:m})}s(f)},[r,i,o,n,c]),(0,Zt.useRegisterActions)(o?t:[],[t,o]),null};var Yo=l(33149),Jo=l(45897);function Os(t){const{children:s,onResize:o,initialHeight:n}=t,r=(0,k.$j)(),i=(0,k.of)(_o),c=(0,Jo.l)(r),h=n||`${r.components.horizontalDrawer.defaultHeight}px`;return(0,e.jsx)(Yo.c,{className:(0,u.cx)(i.fixed,i.container,i.drawerActive),defaultSize:{width:"100%",height:h},handleClasses:{top:c.dragHandleHorizontal},enable:{top:!0,right:!1,bottom:!1,left:!1,topRight:!1,bottomRight:!1,bottomLeft:!1,topLeft:!1},maxHeight:"100vh",onResize:o,children:s})}const Xo=t=>(0,u.keyframes)`
  0% {
    transform: translateY(${t.components.horizontalDrawer.defaultHeight}px);
  }

  100% {
    transform: translateY(0px);
  }
`,_o=t=>({fixed:(0,u.css)({position:"absolute !important"}),container:(0,u.css)({bottom:0,background:t.colors.background.primary,borderTop:`1px solid ${t.colors.border.weak}`,boxShadow:t.shadows.z3,zIndex:t.zIndex.navbarFixed}),drawerActive:(0,u.css)({opacity:1,[t.transitions.handleMotion("no-preference")]:{animation:`0.5s ease-out ${Xo(t)}`}})});var fe=l(71468),en=l(19379),As=l(60188),He=l(51898),it=l(62635),tn=l(70713),Ye=l(78012),te=l(67770),pe=l(28105),Ps=l(39796),Be=l(78282),Yt=l(92807),Jt=l(3023),ks=l(36100),lt=l(53222),Ct=l(34984),Ns=l(42941),sn=l(23535),on=function(t){var s=(0,sn.A)({x:0,y:0}),o=s[0],n=s[1];return(0,d.useEffect)(function(){var r=function(){t.current&&n({x:t.current.scrollLeft,y:t.current.scrollTop})};return t.current&&(0,Ue.on)(t.current,"scroll",r,{capture:!1,passive:!0}),function(){t.current&&(0,Ue.AU)(t.current,"scroll",r)}},[t]),o};const nn=on,Ms=(0,d.createContext)(void 0);function rn({children:t,refreshDependencies:s}){const[o,n]=(0,d.useState)([]),r=(0,d.useRef)({}),i=(0,d.useCallback)(p=>{const g=p.id?p.id:(0,G.uniqueId)(`${p.panelId}-${p.title}-${p.icon}_`);return n(x=>{if(p.level==="root"){const y=r.current[p.panelId]||[];return y.length>0&&r.current[p.panelId].forEach(b=>{b.type==="filter"&&(b.ref=p.ref)}),r.current[p.panelId]=[],[...x,{...p,id:g,children:y}].sort(Hs)}if(p.level==="child"){let y=!1;if(Object.keys(r.current).forEach(v=>{if(r.current[v].find(C=>C.title===p.title&&p.type==="filter"&&p.panelId===C.panelId)){y=!0;return}}),y)return[...x];const R=x.findIndex(v=>v.panelId===p.panelId&&v.level==="root");if(R===-1)return Object.keys(r.current).find(w=>w===p.panelId)?r.current[p.panelId].push({...p,id:g}):r.current[p.panelId]=[{...p,id:g}],[...x];const b=[...x],j={...b[R]},S=j.children?.find(v=>v.title===p.title&&p.type==="filter"&&p.panelId===v.panelId);if(S&&S.highlight!==p.highlight)return j.children?.map(v=>{v.title===S?.title&&(v.highlight=p.highlight)}),[...x];if(S)return[...x];let I=p.ref;p.type==="filter"&&(I=j.ref);let L=[{...p,id:g,ref:I},...j.children||[]];return p.childOnTop||(L=Bs(L)),b[R]={...j,children:L},b}return[...x]}),g},[]),c=(0,d.useCallback)(p=>{n(g=>g.filter(x=>x.id!==p).map(x=>(x.children&&(x.children=x.children.filter(y=>y.id!==p)),x)))},[]),h=(0,d.useCallback)(p=>{n(p)},[]),m=(0,d.useCallback)((p,g)=>{n(x=>x.map(y=>y.id===p?{...y,...g}:y))},[]),f=(0,d.useCallback)((p,g)=>{n(x=>{const y=p(x);return y?x.map(R=>(R.id===y&&(R.children=R.children?.filter(b=>b.type!==g)),R)):x})},[]);return(0,d.useEffect)(()=>{n(p=>{const g=[...p];for(const x of g){const y=Bs(x.children||[]);x.children=y}return g})},[s]),(0,e.jsx)(Ms.Provider,{value:{outlineItems:o,register:i,unregister:c,updateOutlineItems:h,unregisterAllChildren:f,updateItem:m},children:t})}function Hs(t,s){if(t.ref&&s.ref){const o=t.ref.compareDocumentPosition(s.ref);if(o===Node.DOCUMENT_POSITION_PRECEDING)return 1;if(o===Node.DOCUMENT_POSITION_FOLLOWING)return-1}return 0}function Bs(t){const[s,o]=t.reduce((n,r)=>(r.childOnTop?n[0].push(r):n[1].push(r),n),[[],[]]);return o.sort(Hs),[...s,...o]}function Xt(){return(0,d.useContext)(Ms)}var an=l(30360);function _t({contentOutlineExpanded:t,title:s,icon:o,tooltip:n,tooltipPlacement:r="bottom",className:i,indentStyle:c,collapsible:h,collapsed:m,isActive:f,extraHighlight:p,sectionId:g,toggleCollapsed:x,color:y,onRemove:R,...b}){const j=(0,k.$j)(),S=ln(j,y),I=(0,u.cx)(S.button,i),L=(0,d.useRef)(null),[v,w]=(0,d.useState)(!1);(0,d.useEffect)(()=>{L.current&&w(L.current?.scrollWidth>L.current?.clientWidth)},[s]);const C=(0,e.jsxs)("div",{className:(0,u.cx)(S.buttonContainer,c),children:[h&&(0,e.jsx)("button",{className:S.collapseButton,onClick:x,"aria-label":(0,a.t)("explore.content-outline-item-button.body.aria-label-content-outline-item-collapse-button","Content outline item collapse button"),"aria-expanded":!m,"aria-controls":g,children:(0,e.jsx)($s,{icon:m?"angle-right":"angle-down"})}),(0,e.jsxs)("button",{className:(0,u.cx)(I,{[S.active]:f,[S.extraHighlight]:p}),"aria-label":n,...b,children:[(0,e.jsx)($s,{icon:o}),s&&(0,e.jsx)("span",{className:S.textContainer,ref:L,children:s})]}),R&&(0,e.jsx)(P.$n,{variant:"destructive",className:S.deleteButton,icon:"times",onClick:()=>R(),"data-testid":"content-outline-item-delete-button"})]});return n&&(!t||v)?(0,e.jsx)(U.m,{content:n,placement:r,children:C}):C}function $s({icon:t}){return t?(0,an.n6)(t)?(0,e.jsx)(V.I,{name:t,size:"lg",title:t}):t:null}const ln=(t,s)=>({buttonContainer:(0,u.css)({position:"relative",display:"flex",alignItems:"center",flexGrow:1,gap:t.spacing(.25),width:"100%",overflow:"hidden"}),button:(0,u.css)({label:"content-outline-item-button",display:"flex",alignItems:"center",height:t.spacing(t.components.height.md),gap:t.spacing(.5),color:t.colors.text.secondary,width:"100%",background:"transparent",overflow:"hidden",border:"none"}),collapseButton:(0,u.css)({display:"flex",alignItems:"center",justifyContent:"center",width:t.spacing(3),height:t.spacing(4),borderRadius:t.shape.radius.default,color:t.colors.text.secondary,background:"transparent",border:"none",overflow:"hidden","&:hover":{color:t.colors.text.primary,background:t.colors.secondary.shade}}),textContainer:(0,u.css)({whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",fontSize:t.typography.bodySmall.fontSize,marginLeft:t.spacing(.5)}),active:(0,u.css)({backgroundColor:t.colors.background.secondary,borderTopRightRadius:t.shape.radius.default,borderBottomRightRadius:t.shape.radius.default,position:"relative",height:t.spacing(t.components.height.md),"&::before":{backgroundImage:s!==void 0?"none":t.colors.gradients.brandVertical,backgroundColor:s!==void 0?s:"none",borderRadius:t.shape.radius.default,content:'" "',display:"block",height:"100%",position:"absolute",transform:"translateX(-50%)",width:t.spacing(.5),left:"2px"}}),extraHighlight:(0,u.css)({backgroundColor:t.colors.background.secondary,borderTopRightRadius:t.shape.radius.default,borderBottomRightRadius:t.shape.radius.default,position:"relative","&::before":{backgroundImage:s!==void 0?"none":t.colors.gradients.brandVertical,backgroundColor:s!==void 0?s:"none",borderRadius:t.shape.radius.default,content:'" "',display:"block",height:"100%",position:"absolute",transform:"translateX(-50%)",width:t.spacing(.5),left:"2px"}}),deleteButton:(0,u.css)({width:t.spacing(1),height:t.spacing(1),padding:t.spacing(.75,.75),marginRight:t.spacing(.5)})});function Vs(t){return t.children?.filter(s=>s.type!=="filter")||[]}function Qs(t,s,o,n){const r=s===t.id,i=o===t.id,c=!n[t.id],h=Vs(t).length>0,m=Rt(t,o)&&!n[t.id];return h?c&&(r||m):r||i}const St={visible:"grafana.explore.contentOutline.visible",expanded:"grafana.explore.contentOutline.expanded"};function cn({scroller:t,panelId:s}){const[o,n]=(0,Ns.A)(Ye.M.getBool(St.expanded,!0)),r=(0,k.of)(dn,o),i=(0,d.useRef)(t||null),{y:c}=nn(i),{outlineItems:h}=Xt()??{outlineItems:[]},[m,f]=(0,d.useState)(h[0]?.id),[p,g]=(0,d.useState)(h[0]?.children?.[0]?.id),x=h.some(v=>v.children&&!(v.mergeSingleChild&&v.children?.length===1)&&v.children.length>0),y=h.some(v=>v.children?.some(w=>w.onRemove)),[R,b]=(0,d.useState)(()=>h.reduce((v,w)=>(v[w.id]=!!w.expanded,v),{})),j=(v,w=0)=>{let C=0,D=v;if(D){do C+=D?.offsetTop||0,D=D?.offsetParent instanceof HTMLElement?D.offsetParent:void 0;while(D&&D!==t);t?.scroll({top:C+w,behavior:"smooth"})}},S=v=>{if(v.level==="child"&&v.type==="filter"){const w=h.find(C=>C.children?.find(D=>D.id===v.id));w&&j(w.ref,w.customTopOffset)}else j(v.ref,v.customTopOffset),(0,A.rR)("explore_toolbar_contentoutline_clicked",{item:"select_section",type:v.panelId})},I=()=>{Ye.M.set(St.expanded,!o),n(),(0,A.rR)("explore_toolbar_contentoutline_clicked",{item:"outline",type:o?"minimize":"expand"})},L=v=>{b(w=>({...w,[v]:!w[v]})),(0,A.rR)("explore_toolbar_contentoutline_clicked",{item:"section",type:R[v]?"expand":"minimize"})};return(0,d.useEffect)(()=>{let v;for(const w of h){let C=w?.ref?.getBoundingClientRect().top;C&&C>=0&&(v=w);const D=Vs(w).find(H=>{const N=H.customTopOffset||0;let $=H?.ref?.getBoundingClientRect().top;return $&&$>=N});if(D&&jt(w)){g(D.id),f(w.id);break}if(v){f(v.id),g(void 0);break}}},[h,c]),(0,e.jsx)(Jt._,{className:r.wrapper,id:s,children:(0,e.jsx)(Yt.P,{children:(0,e.jsxs)("div",{className:r.content,children:[(0,e.jsx)(_t,{icon:"arrow-from-right",tooltip:o?(0,a.t)("explore.content-outline.tooltip-collapse-outline","Collapse outline"):(0,a.t)("explore.content-outline.tooltip-expand-outline","Expand outline"),tooltipPlacement:o?"right":"bottom",onClick:I,className:(0,u.cx)(r.toggleContentOutlineButton,{[r.justifyCenter]:!o&&!x}),"aria-expanded":o}),h.map(v=>(0,e.jsxs)(d.Fragment,{children:[(0,e.jsx)(_t,{title:o?v.title:void 0,contentOutlineExpanded:o,className:(0,u.cx)(r.buttonStyles,{[r.justifyCenter]:!o&&!y,[r.sectionHighlighter]:Rt(v,p)&&!o}),indentStyle:(0,u.cx)({[r.indentRoot]:!jt(v)&&x,[r.sectionHighlighter]:Rt(v,p)&&!o&&R[v.id]}),icon:v.icon,onClick:()=>S(v),tooltip:v.title,collapsible:jt(v),collapsed:!R[v.id],toggleCollapsed:()=>L(v.id),isActive:Qs(v,m,p,R),sectionId:v.id,color:v.color},v.id),(0,e.jsx)("div",{id:v.id,"data-testid":`section-wrapper-${v.id}`,children:v.children&&jt(v)&&R[v.id]&&v.children.map((w,C)=>(0,e.jsxs)("div",{className:r.itemWrapper,children:[o&&(0,e.jsx)("div",{className:(0,u.cx)(r.itemConnector,{[r.firstItemConnector]:C===0,[r.lastItemConnector]:C===(v.children?.length||0)-1})}),(0,e.jsx)(_t,{title:o?w.title:void 0,contentOutlineExpanded:o,icon:o?void 0:v.icon,className:(0,u.cx)(r.buttonStyles,{[r.justifyCenter]:!o&&!y,[r.sectionHighlighter]:Rt(v,p)&&!o}),indentStyle:r.indentChild,onClick:D=>{S(w),w.onClick?.(D)},tooltip:w.title,isActive:Qs(w,m,p,R),extraHighlight:w.highlight,color:w.color,onRemove:w.onRemove?()=>w.onRemove?.(w.id):void 0},w.id)]},w.id))})]},v.id))]})})})}const dn=(t,s)=>({wrapper:(0,u.css)({label:"wrapper",position:"relative",display:"flex",justifyContent:"center",marginRight:t.spacing(1),height:"100%",backgroundColor:t.colors.background.primary,width:s?"160px":void 0,minWidth:s?"160px":void 0}),content:(0,u.css)({label:"content",marginLeft:t.spacing(.5),top:0}),buttonStyles:(0,u.css)({display:"flex","&:hover":{color:t.colors.text.primary,textDecoration:"underline"}}),toggleContentOutlineButton:(0,u.css)({"&:hover":{color:t.colors.text.primary},transform:s?"rotate(180deg)":"",marginRight:s?t.spacing(.5):void 0}),indentRoot:(0,u.css)({paddingLeft:t.spacing(3)}),indentChild:(0,u.css)({paddingLeft:s?t.spacing(5):t.spacing(2.75)}),itemWrapper:(0,u.css)({display:"flex",height:t.spacing(4),alignItems:"center"}),itemConnector:(0,u.css)({position:"relative",height:"100%",width:t.spacing(1.5),"&::before":{borderRight:`1px solid ${t.colors.border.medium}`,content:'""',height:"100%",left:t.spacing(4.75),position:"absolute",transform:"translateX(50%)"}}),firstItemConnector:(0,u.css)({"&::before":{top:t.spacing(1),height:`calc(100% - ${t.spacing(1)})`}}),lastItemConnector:(0,u.css)({"&::before":{height:`calc(100% - ${t.spacing(1)})`}}),justifyCenter:(0,u.css)({justifyContent:"center"}),sectionHighlighter:(0,u.css)({backgroundColor:t.colors.background.secondary})});function jt(t){return!!(t.children&&t.children.length>0&&(!t.mergeSingleChild||t.children.length!==1))}function Rt(t,s){return t.children?.some(o=>o.id===s)}function ye({panelId:t,title:s,icon:o,customTopOffset:n,children:r,className:i,level:c="root",mergeSingleChild:h,type:m="scrollIntoView",onClick:f}){const{register:p,unregister:g}=Xt()??{},x=(0,d.useRef)(null);return(0,d.useEffect)(()=>{if(!p||!g)return;const y=p({panelId:t,title:s,icon:o,ref:x.current,customTopOffset:n,level:c,mergeSingleChild:h,type:m});return()=>g(y)},[t,s,o,n,c,h,p,g,m,f]),(0,e.jsx)("div",{className:i,ref:x,children:r})}var Tt=l(49785),es=l(16817),Je=l(34999),wt=l(89599),Oe=l(37386),Lt=l(63527),It=l(8073),Xe=l(76319),un=l(44458),ts=l(70191),pn=l(6219),gn=l(23257),hn=l.n(gn),mn=l(72636),$e=l(18857),ss=l(58843);const Ws=({label:t,tooltipText:s})=>(0,e.jsxs)(E.B,{gap:1,direction:"row",wrap:"wrap",alignItems:"flex-start",children:[(0,e.jsx)(mn.J,{children:t}),(0,e.jsx)(U.m,{content:s,children:(0,e.jsx)(V.I,{name:"info-circle",size:"sm"})})]}),xn=({onSave:t,onCancel:s,fieldList:o,transformationToEdit:n})=>{const[r,i]=(0,d.useState)(void 0),[c,h]=(0,d.useState)({}),[m,f]=(0,d.useState)({mapValueDetails:{show:!1},expressionDetails:{show:!1}}),[p,g]=(0,d.useState)(!1),[x,y]=(0,d.useState)(!1),{getValues:R,control:b,register:j,watch:S}=(0,Tt.mN)({defaultValues:(0,d.useMemo)(()=>{if(n){const L=o[n?.field];i(L),n?.expression&&g(!0);const v=(0,ss.hr)(n?.type);f({mapValueDetails:v.mapValueDetails,expressionDetails:v.expressionDetails});const w=(0,ts.k)({type:n?.type,expression:n?.expression,mapValue:n?.mapValue},L||"",n?.field);return h({...w}),y(!0),{type:n?.type,field:n?.field,mapValue:n?.mapValue,expression:n?.expression}}else return},[o,n])}),I=(0,d.useId)();return(0,d.useEffect)(()=>{const L=S(v=>{const w=v.expression;let C=!1;if(w!==void 0){C=!0;try{new RegExp(w)}catch{C=!1}}else C=!m.expressionDetails.show;g(C);let D=[];if(v.type){const H=(0,ts.k)({type:v.type,expression:C?w:"",mapValue:v.mapValue},o[v.field]||"",v.field);D=Object.keys(H),h(D.length>0?{...H}:{})}D.length===0||!C?y(!1):y(!0)});return()=>L.unsubscribe()},[o,m.expressionDetails.show,S]),(0,e.jsxs)(De.a,{isOpen:!0,title:n?(0,a.t)("explore.correlation-transformation-add-modal.title-edit","Edit transformation"):(0,a.t)("explore.correlation-transformation-add-modal.title-add","Add transformation"),onDismiss:s,className:(0,u.css)({width:"700px"}),children:[(0,e.jsx)("p",{children:(0,e.jsx)(a.x6,{i18nKey:"explore.correlation-transformation-add-modal.body",children:"A transformation extracts variables out of a single field. These variables will be available along with your field variables."})}),(0,e.jsx)(Oe.D,{label:(0,a.t)("explore.correlation-transformation-add-modal.label-field","Field"),children:(0,e.jsx)(Tt.xI,{control:b,render:({field:{onChange:L,ref:v,...w}})=>(0,e.jsx)($e.l6,{...w,onChange:C=>{C.value&&(L(C.value),i(o[C.value]))},options:Object.entries(o).map(C=>({label:C[0],value:C[0]})),"aria-label":(0,a.t)("explore.correlation-transformation-add-modal.aria-label-field","Field")}),name:"field"})}),r&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)("pre",{children:(0,e.jsx)(hn(),{textToHighlight:r,searchWords:[p?R("expression")??"":""],autoEscape:!1})}),(0,e.jsx)(Oe.D,{label:(0,a.t)("explore.correlation-transformation-add-modal.label-type","Type"),children:(0,e.jsx)(Tt.xI,{control:b,render:({field:{onChange:L,ref:v,...w}})=>(0,e.jsx)($e.l6,{...w,onChange:C=>{L(C.value);const D=(0,ss.hr)(C.value);f({mapValueDetails:D.mapValueDetails,expressionDetails:D.expressionDetails})},options:(0,ss.jN)(),"aria-label":(0,a.t)("explore.correlation-transformation-add-modal.aria-label-type","Type")}),name:"type"})}),m.expressionDetails.show&&(0,e.jsx)(Oe.D,{label:m.expressionDetails.helpText?(0,e.jsx)(Ws,{label:(0,a.t)("explore.correlation-transformation-add-modal.label-expression","Expression"),tooltipText:m.expressionDetails.helpText}):(0,a.t)("explore.correlation-transformation-add-modal.label-expression-without-tooltip","Expression"),htmlFor:`${I}-expression`,required:m.expressionDetails.required,children:(0,e.jsx)(Lt.p,{...j("expression"),id:`${I}-expression`})}),m.mapValueDetails.show&&(0,e.jsx)(Oe.D,{label:m.mapValueDetails.helpText?(0,e.jsx)(Ws,{label:(0,a.t)("explore.correlation-transformation-add-modal.label-variable-name","Variable name"),tooltipText:m.mapValueDetails.helpText}):(0,a.t)("explore.correlation-transformation-add-modal.label-variable-name-without-tooltip","Variable name"),htmlFor:`${I}-mapValue`,children:(0,e.jsx)(Lt.p,{...j("mapValue"),id:`${I}-mapValue`})}),Object.entries(c).length>0&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(a.x6,{i18nKey:"explore.correlation-transformation-add-modal.added-variables",children:"This transformation will add the following variables:"}),(0,e.jsx)("pre",{children:Object.entries(c).map(L=>`\${${L[0]}} = ${L[1]?.value}
`)})]})]}),(0,e.jsxs)(De.a.ButtonRow,{children:[(0,e.jsx)(P.$n,{variant:"secondary",onClick:s,fill:"outline",children:(0,e.jsx)(a.x6,{i18nKey:"explore.correlation-transformation-add-modal.cancel",children:"Cancel"})}),(0,e.jsx)(P.$n,{variant:"primary",onClick:()=>t(R()),disabled:!x,children:n?(0,a.t)("explore.correlation-transformation-add-modal.edit-transformation","Edit transformation"):(0,a.t)("explore.correlation-transformation-add-modal.add-transformation","Add transformation to correlation")})]})]})},fn=({exploreId:t,correlations:s})=>{const o=(0,O.wA)(),n=(0,k.of)(yn),r=(0,O.d4)(Z.Qb),i=Object.values(r),{value:c,loading:h}=(0,es.A)(async()=>await(0,pn.tZ)(i[0],i[1]),[i[0]?.datasourceInstance,i[0]?.queries[0].datasource,i[1]?.datasourceInstance,i[1]?.queries[0].datasource]),{register:m,watch:f,getValues:p,setValue:g}=(0,Tt.mN)(),[x,y]=(0,d.useState)(!1),[R,b]=(0,d.useState)(!1),[j,S]=(0,d.useState)(!1),[I,L]=(0,d.useState)([]),[v,w]=(0,d.useState)(void 0),C=(0,O.d4)(Z.vC),D=(0,d.useId)();return(0,d.useEffect)(()=>(o((0,q.am)({canSave:!0})),()=>{o((0,q.am)({canSave:!1}))}),[o]),(0,d.useEffect)(()=>{!h&&c!==void 0&&!C?.correlationDirty&&p("label")!==""&&g("label",c)},[C?.correlationDirty,c,p,h,g]),(0,d.useEffect)(()=>{const H=f(N=>{let $=C?.correlationDirty||!1,F=N.description||"";!$&&(N.label!==c||F!=="")?$=!0:$&&N.label===c&&F.trim()===""&&($=!1),o((0,q.am)({label:N.label,description:N.description,correlationDirty:$}))});return()=>H.unsubscribe()},[C?.correlationDirty,c,o,f]),(0,d.useEffect)(()=>{const H=!C?.correlationDirty&&I.length>0?!0:C?.correlationDirty;o((0,q.am)({transformations:I,correlationDirty:H}));let N={};I.forEach($=>{const F=(0,ts.k)({type:$.type,expression:$.expression,mapValue:$.mapValue},s.vars[$.field],$.field);Object.keys(F).forEach(K=>{N[K]=F[K]?.value})}),o((0,Te.nE)({exploreId:t,correlationEditorHelperData:{resultField:s.resultField,origVars:s.origVars,vars:{...s.origVars,...N}}}))},[o,I]),(0,e.jsxs)(e.Fragment,{children:[j&&(0,e.jsx)(xn,{onCancel:()=>{w(void 0),S(!1)},onSave:H=>{if(v!==void 0){const N=[...I];N[v]=H,L(N),w(void 0)}else L([...I,H]);S(!1)},fieldList:s.origVars,transformationToEdit:v!==void 0?I[v]:void 0}),(0,e.jsxs)(Je.F,{title:(0,a.t)("explore.correlation-helper.title-correlation-details","Correlation details"),severity:"info",children:[(0,e.jsxs)(a.x6,{i18nKey:"explore.correlation-helper.body-correlation-details",values:{resultField:s.resultField},children:["The correlation link will appear by the ",(0,e.jsx)("code",{children:"{{resultField}}"})," field. You can use the following variables to set up your correlations:"]}),(0,e.jsx)("pre",{children:Object.entries(s.vars).map(H=>`\${${H[0]}} = ${H[1]}
`)}),(0,e.jsxs)(wt.S,{collapsible:!0,isOpen:x,onToggle:()=>{y(!x)},label:(0,e.jsxs)(E.B,{gap:1,direction:"row",wrap:"wrap",alignItems:"center",children:[(0,e.jsx)(a.x6,{i18nKey:"explore.correlation-helper.label-description-header",children:"Label / Description"}),!x&&!h&&(0,e.jsx)("span",{className:n.labelCollapseDetails,children:`Label: ${p("label")||c}`})]}),children:[(0,e.jsx)(Oe.D,{label:(0,a.t)("explore.correlation-helper.label-label","Label"),htmlFor:`${D}-label`,children:(0,e.jsx)(Lt.p,{...m("label"),id:`${D}-label`,onBlur:()=>{p("label")===""&&c!==void 0&&g("label",c)}})}),(0,e.jsx)(Oe.D,{label:(0,a.t)("explore.correlation-helper.label-description","Description"),htmlFor:`${D}-description`,children:(0,e.jsx)(Lt.p,{...m("description"),id:`${D}-description`})})]}),(0,e.jsxs)(wt.S,{collapsible:!0,isOpen:R,onToggle:()=>{b(!R)},label:(0,e.jsxs)(E.B,{gap:1,direction:"row",wrap:"wrap",alignItems:"center",children:[(0,e.jsx)(a.x6,{i18nKey:"explore.correlation-helper.transformations",children:"Transformations"}),(0,e.jsx)(U.m,{content:(0,a.t)("explore.correlation-helper.tooltip-transformations","A transformation extracts one or more variables out of a single field."),children:(0,e.jsx)(V.I,{name:"info-circle",size:"sm"})})]}),children:[(0,e.jsx)(P.$n,{variant:"secondary",fill:"outline",onClick:()=>{S(!0)},className:n.transformationAction,children:(0,e.jsx)(a.x6,{i18nKey:"explore.correlation-helper.add-transformation",children:"Add transformation"})}),I.map((H,N)=>{const{type:$,field:F,expression:K,mapValue:z}=H,X=[(z??"").length>0?`Variable name: ${z}`:void 0,(K??"").length>0?(0,e.jsxs)(a.x6,{i18nKey:"explore.correlation-helper.expression",values:{expression:K},children:["Expression: ",(0,e.jsx)("code",{children:"{{expression}}"})]}):void 0].filter(ne=>ne);return(0,e.jsxs)(It.Z,{children:[(0,e.jsxs)(It.Z.Heading,{children:[F,": ",$]}),X.length>0&&(0,e.jsx)(It.Z.Meta,{className:n.transformationMeta,children:X}),(0,e.jsxs)(It.Z.SecondaryActions,{children:[(0,e.jsx)(Xe.K,{name:"edit","aria-label":(0,a.t)("explore.correlation-helper.aria-label-edit-transformation","Edit transformation"),onClick:()=>{w(N),S(!0)}},"edit"),(0,e.jsx)(un.e,{"aria-label":(0,a.t)("explore.correlation-helper.aria-label-delete-transformation","Delete transformation"),onConfirm:()=>L(I.filter((ne,ce)=>N!==ce)),closeOnConfirm:!0})]})]},`trans-${N}`)})]})]})]})},yn=t=>({labelCollapseDetails:(0,u.css)({marginLeft:t.spacing(2),...t.typography.bodySmall,fontStyle:"italic"}),transformationAction:(0,u.css)({marginBottom:t.spacing(2)}),transformationMeta:(0,u.css)({alignItems:"baseline"})});var vn=l(60311),bn=l(64400),we=l(67522),Cn=l(92391),Sn=l(89381);function jn({width:t,height:s,timeZone:o,state:n,pluginId:r,frames:i,timeRange:c,splitOpenFn:h,eventBus:m}){const f=(0,Cn.d4)(r),g={dataLinkPostProcessor:(0,Sn.h)(h,c),eventBus:m,eventsScope:"explore"};return(0,e.jsx)(bn.XF,{value:g,children:(0,e.jsx)(we.NR,{title:f.name,width:t,height:s,loadingState:n,children:(x,y)=>(0,e.jsx)(vn.m,{data:{series:i,state:n,timeRange:c},pluginId:r,title:"",width:x,height:y,timeZone:o})})})}var Rn=l(78685);function Tn(t){const s=["prometheus","grafana-amazonprometheus-datasource","grafana-azureprometheus-datasource","loki","tempo","grafana-pyroscope-datasource"].includes(t.datasourceType),[o,n]=(0,Rn.A)("grafana.explore.drilldownsBoxDismissed",!1);return s&&!o&&(0,e.jsx)(Je.F,{severity:"info",title:(0,a.t)("explore.drilldownInfo.title","Explore Metrics, Logs, Traces and Profiles have moved!"),onRemove:()=>{n(!0)},children:(0,e.jsxs)(E.B,{gap:1,alignItems:"flex-end",justifyContent:"space-between",children:[(0,e.jsx)("span",{children:(0,e.jsxs)(a.x6,{i18nKey:"explore.drilldownInfo.description",children:["Looking for the Grafana Explore apps? They are now called the Grafana Drilldown apps and can be found under ",(0,e.jsx)("b",{children:"Menu > Drilldown"})]})}),(0,e.jsx)(P.z9,{variant:"secondary",href:"/drilldown",children:(0,e.jsx)(a.x6,{i18nKey:"explore.drilldownInfo.action",children:"Go to Grafana Drilldown"})})]})})}var wn=l(82143),Ln=l(84600),le=l(7895),os=l(93256),Et=l(90811),In=l(43707),En=l(76792),ns=l(73427),zs=l(69289),_e=l(25229),Ks=l(33239),Fn=l(51158),Us=l(23237);function Dn(t){const{onClick:s,isSynced:o}=t,n=()=>{const{isSynced:r}=t,i=r?"Unsync all views":"Sync all views to this time range";return(0,e.jsx)(e.Fragment,{children:i})};return(0,e.jsx)(U.m,{content:n,placement:"bottom",children:(0,e.jsx)(le.I,{icon:"link",variant:o?"active":"canvas","aria-label":o?(0,a.t)("explore.time-sync-button.aria-label-synced","Synced times"):(0,a.t)("explore.time-sync-button.aria-label-unsynced","Unsynced times"),onClick:s})})}class On extends d.Component{constructor(){super(...arguments),this.onMoveTimePicker=s=>{const{range:o,onChangeTime:n,timeZone:r}=this.props,{from:i,to:c}=(0,Us.Wb)(s,o),h={from:(0,_e.oZ)(r,i),to:(0,_e.oZ)(r,c)};n(h)},this.onMoveForward=()=>this.onMoveTimePicker(1),this.onMoveBack=()=>this.onMoveTimePicker(-1),this.onChangeTimePicker=s=>{const o=Ks.isMathString(s.raw.from)?s.raw.from:s.from,n=Ks.isMathString(s.raw.to)?s.raw.to:s.to;this.props.onChangeTime({from:o,to:n}),(0,A.rR)("grafana_explore_time_picker_time_range_changed",{timeRangeFrom:o,timeRangeTo:n})},this.onZoom=()=>{const{range:s,onChangeTime:o,timeZone:n}=this.props,{from:r,to:i}=(0,Us.Zk)(s,2),c={from:(0,_e.oZ)(n,r),to:(0,_e.oZ)(n,i)};o(c)}}render(){const{range:s,timeZone:o,fiscalYearStartMonth:n,splitted:r,syncedTimes:i,onChangeTimeSync:c,hideText:h,onChangeTimeZone:m,onChangeFiscalYearStartMonth:f}=this.props,p=r?(0,e.jsx)(Dn,{onClick:c,isSynced:i}):void 0,g={value:s,timeZone:o,fiscalYearStartMonth:n,onMoveBackward:this.onMoveBack,onMoveForward:this.onMoveForward,onZoom:this.onZoom,hideText:h};return(0,e.jsx)(Fn.mR,{isOnCanvas:!0,...g,timeSyncButton:p,isSynced:i,widthOverride:r?window.innerWidth/2:void 0,onChange:this.onChangeTimePicker,onChangeTimeZone:m,onChangeFiscalYearStartMonth:f})}}var Gs=l(66588);function An(t){const s=(0,d.useRef)(null),{start:o,pause:n,resume:r,isLive:i,isPaused:c,stop:h,splitted:m}=t,f=i&&!c?"active":"canvas",p=i?c?r:n:o;return(0,e.jsxs)(os.e,{children:[(0,e.jsx)(U.m,{content:i&&!c?(0,e.jsx)(e.Fragment,{children:(0,e.jsx)(a.x6,{i18nKey:"explore.live-tail-button.pause-the-live-stream",children:"Pause the live stream"})}):(0,e.jsx)(e.Fragment,{children:(0,e.jsx)(a.x6,{i18nKey:"explore.live-tail-button.start-live-stream-your-logs",children:"Start live stream your logs"})}),placement:"bottom",children:(0,e.jsx)(le.I,{iconOnly:m,variant:f,icon:!i||c?"play":"pause",onClick:p,children:i&&c?(0,a.t)("explore.live-tail-button.paused","Paused"):(0,a.t)("explore.live-tail-button.live","Live")})}),(0,e.jsx)(Gs.A,{mountOnEnter:!0,unmountOnExit:!0,timeout:100,in:i,classNames:{enter:Ft.stopButtonEnter,enterActive:Ft.stopButtonEnterActive,exit:Ft.stopButtonExit,exitActive:Ft.stopButtonExitActive},nodeRef:s,children:(0,e.jsx)(U.m,{content:(0,e.jsx)(e.Fragment,{children:(0,e.jsx)(a.x6,{i18nKey:"explore.live-tail-button.stop-and-exit-the-live-stream",children:"Stop and exit the live stream"})}),placement:"bottom",children:(0,e.jsx)(le.I,{ref:s,variant:f,onClick:h,icon:"square-shape"})})})]})}const Ft={stopButtonEnter:(0,u.css)({label:"stopButtonEnter",width:0,opacity:0,overflow:"hidden"}),stopButtonEnterActive:(0,u.css)({label:"stopButtonEnterActive",opacity:1,width:"32px"}),stopButtonExit:(0,u.css)({label:"stopButtonExit",width:"32px",opacity:1,overflow:"hidden"}),stopButtonExitActive:(0,u.css)({label:"stopButtonExitActive",opacity:0,width:0})};var et=l(52830),Ae=l(87063),Pn=l(30930),ct=l(88559),Dt=l(71673),tt=l(78529);function kn(){const t={key:"copy-link",label:(0,a.t)("explore.toolbar.copy-shortened-link","Copy shortened URL"),icon:"share-alt",getUrl:()=>{},shorten:!0,absTime:!1},s=(0,O.d4)(Z.Qb),[o,n]=(0,d.useState)(!1),[r,i]=(0,d.useState)(t),c=(f,p,g)=>{f?((0,Dt.VP)(g||l.g.location.href),(0,A.rR)("grafana_explore_shortened_link_clicked",{isAbsoluteTime:p})):((0,it.uJ)(g!==void 0?`${window.location.protocol}//${window.location.host}${M.$.appSubUrl}${g}`:l.g.location.href),(0,A.rR)("grafana_explore_copy_link_clicked",{isAbsoluteTime:p}))},h=[{key:"normal",label:(0,a.t)("explore.toolbar.copy-links-normal-category","Normal URL links"),items:[{key:"copy-shortened-link",icon:"link",label:(0,a.t)("explore.toolbar.copy-shortened-link","Copy shortened URL"),getUrl:()=>{},shorten:!0,absTime:!1},{key:"copy-link",icon:"link",label:(0,a.t)("explore.toolbar.copy-link","Copy URL"),getUrl:()=>{},shorten:!1,absTime:!1}]},{key:"timesync",label:(0,a.t)("explore.toolbar.copy-links-absolute-category","Time-sync URL links (share with time range intact)"),items:[{key:"copy-short-link-abs-time",icon:"clock-nine",label:(0,a.t)("explore.toolbar.copy-shortened-link-abs-time","Copy absolute shortened URL"),shorten:!0,getUrl:()=>(0,tt._O)(s),absTime:!0},{key:"copy-link-abs-time",icon:"clock-nine",label:(0,a.t)("explore.toolbar.copy-link-abs-time","Copy absolute URL"),shorten:!1,getUrl:()=>(0,tt._O)(s),absTime:!0}]}],m=(0,e.jsx)(Ae.W,{children:h.map(f=>(0,e.jsx)(Pn.r,{label:f.label,children:f.items.map(p=>(0,e.jsx)(Ae.W.Item,{label:p.label,icon:p.icon,onClick:()=>{const g=p.getUrl();c(p.shorten,p.absTime,g),i(p)}},p.key))},f.key))});return(0,e.jsxs)(os.e,{children:[(0,e.jsx)(P.$n,{tooltip:r.label,icon:r.icon,size:"sm",variant:"secondary",onClick:()=>{const f=r.getUrl();c(r.shorten,r.absTime,f)},"aria-label":(0,a.t)("explore.toolbar.copy-shortened-link","Copy shortened URL"),children:(0,e.jsx)(a.x6,{i18nKey:"explore.toolbar.copy-shortened-link-label",children:"Share"})}),(0,e.jsx)(ct.m,{overlay:m,placement:"bottom-end",onVisibleChange:n,children:(0,e.jsx)(P.$n,{variant:"secondary",size:"sm",icon:o?"angle-up":"angle-down","aria-label":(0,a.t)("explore.toolbar.copy-shortened-link-menu","Open copy link options")})})]})}var Nn=l(54092),Mn=l(46907),Hn=l(20806),qs=l(9860);const Bn=(0,d.lazy)(()=>l.e(5843).then(l.bind(l,38224)).then(({AddToDashboard:t})=>({default:t})));function $n(t){const{exploreId:s,links:o,setSelectedExtension:n,setIsModalOpen:r,isModalOpen:i,noQueriesInPane:c}=t;if(o.length<=1)return bt.TP.hasPermission(Ze.w.DashboardsCreate)||bt.TP.hasPermission(Ze.w.DashboardsWrite)?(0,e.jsx)(d.Suspense,{fallback:null,children:(0,e.jsx)(Bn,{exploreId:s})}):null;const h=(0,e.jsx)(qs.w,{extensions:o,onSelect:n});return(0,e.jsx)(e.Fragment,{children:(0,e.jsx)(ct.m,{onVisibleChange:r,placement:"bottom-start",overlay:h,children:(0,e.jsx)(le.I,{"aria-label":(0,a.t)("explore.basic-extensions.aria-label-add","Add"),disabled:!c,variant:"canvas",isOpen:i,children:(0,e.jsx)(a.x6,{i18nKey:"explore.toolbar.add-to-extensions",children:"Add"})})})})}function Vn(t){const{links:s,setSelectedExtension:o,setIsModalOpen:n,isModalOpen:r,noQueriesInPane:i}=t;if(s.length===0)return;const c=(0,e.jsx)(qs.w,{extensions:s,onSelect:o});if(s.length===1){const h=(0,G.first)(s);return(0,e.jsx)(le.I,{variant:"canvas",icon:h.icon,onClick:()=>o(h),children:(0,e.jsx)(a.x6,{i18nKey:"explore.toolbar.add-to-queryless-extensions",children:"Go queryless"})})}return(0,e.jsx)(e.Fragment,{children:(0,e.jsx)(ct.m,{onVisibleChange:n,placement:"bottom-start",overlay:c,children:(0,e.jsx)(le.I,{"aria-label":(0,a.t)("explore.queryless-apps-extensions.aria-label-go-queryless","Go queryless"),disabled:!i,variant:"canvas",isOpen:r,children:(0,e.jsx)(a.x6,{i18nKey:"explore.toolbar.add-to-queryless-extensions",children:"Go queryless"})})})})}const Zs=["grafana-pyroscope-app","grafana-lokiexplore-app","grafana-exploretraces-app","grafana-metricsdrilldown-app"];function Ys(t){const{exploreId:s,extensionsToShow:o}=t,[n,r]=(0,d.useState)(),[i,c]=(0,d.useState)(!1),h=Qn(t),{links:m}=(0,Mn.U)({extensionPointId:Nn.S.ExploreToolbarAction,context:h,limitPerPlugin:3}),f=(0,Z.qq)(s),p=!!(0,O.d4)(f)?.queries?.length,g=m.filter(y=>Zs.includes(y.pluginId)),x=m.filter(y=>!Zs.includes(y.pluginId));return(0,e.jsxs)(e.Fragment,{children:[o==="queryless"&&(0,e.jsx)(Vn,{links:g,noQueriesInPane:p,exploreId:s,setSelectedExtension:y=>{r(y),(0,A.rR)("grafana_explore_queryless_app_link_clicked",{pluginId:y.pluginId})},setIsModalOpen:c,isModalOpen:i}),o==="basic"&&(0,e.jsx)($n,{links:x,noQueriesInPane:p,exploreId:s,setSelectedExtension:r,setIsModalOpen:c,isModalOpen:i}),!!n&&!!n.path&&(0,e.jsx)(Hn.s,{path:n.path,title:n.title,onDismiss:()=>r(void 0)})]})}function Qn(t){const{exploreId:s,timeZone:o}=t,r=(0,O.d4)(Z.vC)?.editorMode||!1,{queries:i,queryResponse:c,range:h}=(0,O.d4)((0,Z.qq)(s)),m=(0,O.d4)((0,Z.Jr)(s)),f=i.map(x=>x?.datasource?.uid).filter(x=>x!==void 0),p=[...new Set(f)].length,g=bt.TP.hasPermission(Ze.w.DataSourcesWrite);return(0,d.useMemo)(()=>({exploreId:s,targets:i,data:c,timeRange:h.raw,timeZone:(0,As.O)({timeZone:o}),shouldShowAddCorrelation:M.$.featureToggles.correlations===!0&&g&&!r&&m&&p===1}),[s,i,c,h.raw,o,g,r,m,p])}var he=l(94543);function Wn(t){const s=(0,O.wA)(),o=(0,d.useCallback)(()=>{s((0,W.qk)({exploreId:t,isPaused:!0}))},[t,s]),n=(0,d.useCallback)(()=>{s((0,W.qk)({exploreId:t,isPaused:!1}))},[t,s]),r=(0,d.useCallback)(()=>{o(),s((0,he.hO)({exploreId:t,refreshInterval:Et.cC.offOption.value})),s((0,W.Od)({exploreId:t}))},[t,s,o]),i=(0,d.useCallback)(()=>{s((0,he.hO)({exploreId:t,refreshInterval:Et.cC.liveOption.value}))},[t,s]),c=(0,d.useCallback)(()=>{s((0,W.rR)({exploreId:t}))},[t,s]);return{pause:o,resume:n,stop:r,start:i,clear:c}}function Js(t){const s=Wn(t.exploreId);return t.children(s)}const zn=(t,s)=>({rotateIcon:(0,u.css)({"> div > svg":{transform:"rotate(180deg)"}}),toolbarButton:(0,u.css)({display:"flex",justifyContent:"center",marginRight:t.spacing(.5),width:s&&t.spacing(6)})});function Kn({exploreId:t,onChangeTime:s,onContentOutlineToogle:o,isContentOutlineOpen:n}){const r=(0,O.wA)(),i=(0,O.d4)(Z.pF),c=(0,k.of)(zn,i),h=(0,O.d4)(Q=>(0,Ct.O)(Q.user)),m=(0,O.d4)(Q=>(0,Ct.q)(Q.user)),{refreshInterval:f,datasourceInstance:p,range:g,isLive:x,isPaused:y,syncedTimes:R}=(0,O.d4)(Q=>({...(0,G.pick)(Q.explore.panes[t],"refreshInterval","datasourceInstance","range","isLive","isPaused"),syncedTimes:Q.explore.syncedTimes}),fe.shallowEqual),b=(0,O.d4)((0,W.h1)(t)),j=(0,O.d4)(Q=>Q.explore.largerExploreId===t),S=(0,O.d4)(Q=>i||Q.explore.panes[t].containerWidth<1210),I=(0,O.d4)(Q=>Q.explore.panes[t].containerWidth<(i?700:800)),L=(0,O.d4)(Z.K6),v=(0,O.d4)(Z.vC),w=v?.editorMode||!1,C=(0,O.d4)((0,Z.Jr)(t)),{drawerOpened:D,setDrawerOpened:H}=(0,et.sz)(),N=(0,d.useMemo)(()=>C&&j||!C&&!j,[C,j]),$=b?(0,a.t)("explore.toolbar.refresh-picker-cancel","Cancel"):(0,a.t)("explore.toolbar.refresh-picker-run","Run query"),F=async Q=>{w?v?.correlationDirty||v?.queryEditorDirty?r((0,q.am)({isExiting:!0,postConfirmAction:{exploreId:t,action:_.IW.CHANGE_DATASOURCE,changeDatasourceUid:Q.uid,isActionLeft:C}})):(C&&L.forEach(Pe=>{r((0,Te.nE)({exploreId:Pe[0],correlationEditorHelperData:void 0}))}),r((0,Re.wh)({exploreId:t,datasource:Q.uid,options:{importQueries:!0}}))):r((0,Re.wh)({exploreId:t,datasource:Q.uid,options:{importQueries:!0}}))},K=(Q=!1)=>r(Q?(0,W.hS)(t):(0,W.Od)({exploreId:t})),z=Q=>r((0,zs.Cj)(Q)),X=()=>{r((0,q.ve)()),(0,A.rR)("grafana_explore_split_view_opened",{origin:"menu"})},ne=()=>{w?v?.correlationDirty||v?.queryEditorDirty?r((0,q.am)({isExiting:!0,postConfirmAction:{exploreId:t,action:_.IW.CLOSE_PANE,isActionLeft:C}})):(L.forEach(Q=>{r((0,Te.nE)({exploreId:Q[0],correlationEditorHelperData:void 0}))}),r((0,q.J8)(t)),(0,A.rR)("grafana_explore_split_view_closed")):(r((0,q.J8)(t)),(0,A.rR)("grafana_explore_split_view_closed"))},ce=()=>{r(j?(0,q.JA)():(0,q.tP)({exploreId:t}))},Ee=()=>{r((0,he.iO)(t))},$t=Q=>r((0,zs.c1)(Q)),Ce=Q=>{r((0,he.hO)({exploreId:t,refreshInterval:Q}))},Vt=[(0,e.jsx)(P.$n,{size:"sm",variant:"secondary","aria-label":(0,a.t)("explore.secondary-actions.query-history-button-aria-label","Query history"),onClick:()=>H(!D),"data-testid":He.XF.QueryTab.queryHistoryButton,icon:"history",children:(0,e.jsx)(a.x6,{i18nKey:"explore.secondary-actions.query-history-button",children:"Query history"})},"query-history"),(0,e.jsx)(kn,{},"share")];return(0,e.jsxs)("div",{children:[f&&(0,e.jsx)(wn.u,{func:K,interval:f,loading:b}),(0,e.jsx)(In.H,{actions:Vt}),(0,e.jsx)(Ln.d,{"aria-label":(0,a.t)("explore.toolbar.aria-label","Explore toolbar"),leftItems:[(0,e.jsx)(le.I,{variant:"canvas",tooltip:(0,a.t)("explore.explore-toolbar.tooltip-content-outline","Content outline"),icon:"list-ui-alt",iconOnly:i,onClick:o,"aria-expanded":n,"aria-controls":n?"content-outline-container":void 0,className:c.toolbarButton,children:(0,e.jsx)(a.x6,{i18nKey:"explore.explore-toolbar.outline",children:"Outline"})},"content-outline"),(0,e.jsx)(En.s,{mixed:!w,onChange:F,current:p?.getRef(),hideTextValue:I,width:I?8:void 0},`${t}-ds-picker`),(0,e.jsx)(Ys,{exploreId:t,timeZone:h,extensionsToShow:"queryless"},"toolbar-extension-point")].filter(Boolean),forceShowLeftItems:!0,children:[i?(0,e.jsxs)(os.e,{children:[(0,e.jsx)(le.I,{variant:"canvas",tooltip:j?(0,a.t)("explore.toolbar.split-narrow","Narrow pane"):(0,a.t)("explore.toolbar.split-widen","Widen pane"),onClick:ce,icon:j?"gf-movepane-left":"gf-movepane-right",iconOnly:!0,className:(0,u.cx)(N&&c.rotateIcon)}),(0,e.jsx)(le.I,{tooltip:(0,a.t)("explore.toolbar.split-close-tooltip","Close split pane"),onClick:ne,icon:"times",variant:"canvas",children:(0,e.jsx)(a.x6,{i18nKey:"explore.toolbar.split-close",children:" Close "})})]},"split-controls"):(0,e.jsx)(le.I,{variant:"canvas",tooltip:(0,a.t)("explore.toolbar.split-tooltip","Split the pane"),onClick:X,icon:"columns",disabled:x,children:(0,e.jsx)(a.x6,{i18nKey:"explore.toolbar.split-title",children:"Split"})},"split"),(0,e.jsx)(Ys,{exploreId:t,timeZone:h,extensionsToShow:"basic"},"toolbar-extension-point"),!x&&(0,e.jsx)(On,{exploreId:t,range:g,timeZone:h,fiscalYearStartMonth:m,onChangeTime:s,splitted:i,syncedTimes:R,onChangeTimeSync:Ee,hideText:S,onChangeTimeZone:z,onChangeFiscalYearStartMonth:$t},"timeControls"),(0,e.jsx)(Et.cC,{onIntervalChanged:Ce,value:f,isLoading:b,text:S?void 0:$,tooltip:S?$:void 0,intervals:ns.TP.getValidIntervals(Et.cb),isLive:x,onRefresh:()=>K(b),noIntervalPicker:x,primary:!0,width:(S?35:108)+"px"},"refreshPicker"),p?.meta.streaming&&(0,e.jsx)(Js,{exploreId:t,children:Q=>{const Pe={...Q,start:()=>{(0,A.rR)("grafana_explore_logs_live_tailing_clicked",{datasourceType:p?.type}),Q.start()}};return(0,e.jsx)(An,{splitted:i,isLive:x,isPaused:y,start:Pe.start,pause:Pe.pause,resume:Pe.resume,stop:Pe.stop})}},"liveControls")].filter(Boolean)})]})}var Le=l(1906),Un=l(10020);function Ot(t,s={}){(0,A.rR)(`grafana_flamegraph_${t}`,{app:Le.Jk.Unknown,grafana_version:M.$.buildInfo.version,...s})}const Gn=t=>{const s=(0,k.of)(o=>qn(o));return(0,e.jsx)("div",{className:s.container,children:(0,e.jsx)(Un.Ay,{data:t.dataFrames[0],stickyHeader:!0,getTheme:()=>M.$.theme2,onTableSymbolClick:()=>Ot("table_item_selected"),onViewSelected:o=>Ot("view_selected",{view:o}),onTextAlignSelected:o=>Ot("text_align_selected",{align:o}),onTableSort:o=>Ot("table_sort_selected",{sort:o})})})},qn=t=>({container:(0,u.css)({background:t.colors.background.primary,display:"flow-root",padding:t.spacing(0,1,1,1),border:`1px solid ${t.components.panel.borderColor}`,borderRadius:t.shape.radius.default})});var Zn=l(5929),Xs=l(84140),oe=l(739),_s=l(80011),Yn=l(25461),Jn=l(21429),ue=l(74746),Xn=l(66178),_n=l(55555);const eo=150,er=({resetKey:t,humanize:s,className:o})=>{const[n,r]=(0,d.useState)(0);return(0,Xn.A)(()=>r(n+eo),eo),(0,d.useEffect)(()=>r(0),[t]),(0,e.jsx)(_n.g,{timeInMs:n,className:o,humanize:s})};var tr=l(83953);const sr=t=>{const s=(0,u.keyframes)({from:{backgroundColor:(0,Xs.A)(t.colors.info.transparent).setAlpha(.25).toString()},to:{backgroundColor:"transparent"}});return{logsRowsLive:(0,u.css)({label:"logs-rows-live",fontFamily:t.typography.fontFamilyMonospace,fontSize:t.typography.bodySmall.fontSize,display:"flex",flexFlow:"column nowrap",height:"60vh",overflowY:"scroll",":first-child":{marginTop:"auto !important"}}),logsRowFade:(0,u.css)({label:"logs-row-fresh",color:t.colors.text.primary,backgroundColor:(0,Xs.A)(t.colors.info.transparent).setAlpha(.25).toString(),[t.transitions.handleMotion("no-preference","reduce")]:{animation:`${s} 1s ease-out 1s 1 normal forwards`}}),logsRowsIndicator:(0,u.css)({fontSize:t.typography.h6.fontSize,paddingTop:t.spacing(1),display:"flex",alignItems:"center"}),button:(0,u.css)({marginRight:t.spacing(1)}),fullWidth:(0,u.css)({width:"100%"})}};class or extends d.PureComponent{constructor(s){super(s),this.liveEndDiv=null,this.scrollContainerRef=d.createRef(),this.onScroll=o=>{const{isPaused:n,onPause:r}=this.props,{scrollTop:i,clientHeight:c,scrollHeight:h}=o.currentTarget;h-(i+c)>=5&&!n&&r()},this.rowsToRender=()=>{const{isPaused:o}=this.props;let{logRowsToRender:n=[]}=this.state;return o||(n=(0,ue.oR)(n,oe.uH.Ascending).slice(-100)),n},this.state={logRowsToRender:s.logRows}}static getDerivedStateFromProps(s,o){return s.isPaused&&s.clearedAtIndex?{logRowsToRender:(0,tr.pg)(s.clearedAtIndex,o.logRowsToRender)}:s.isPaused?null:{logRowsToRender:s.logRows}}render(){const{theme:s,timeZone:o,onPause:n,onResume:r,onClear:i,isPaused:c}=this.props,h=sr(s),{logsRow:m,logsRowLocalTime:f,logsRowMessage:p}=(0,Jn.D)(s);return(0,e.jsxs)("div",{children:[(0,e.jsx)("table",{className:h.fullWidth,children:(0,e.jsxs)("tbody",{onScroll:c?void 0:this.onScroll,className:h.logsRowsLive,ref:this.scrollContainerRef,children:[this.rowsToRender().map(g=>(0,e.jsxs)("tr",{className:(0,u.cx)(m,h.logsRowFade),children:[(0,e.jsx)("td",{className:f,children:(0,_s.LE)(g.timeEpochMs,{timeZone:o})}),(0,e.jsx)("td",{className:p,children:g.hasAnsi?(0,e.jsx)(Yn.$,{value:g.raw}):g.entry})]},g.uid)),(0,e.jsx)("tr",{ref:g=>{this.liveEndDiv=g,this.liveEndDiv&&this.scrollContainerRef.current?.scrollTo&&!c&&this.scrollContainerRef.current?.scrollTo(0,this.scrollContainerRef.current.scrollHeight)}})]})}),(0,e.jsxs)("div",{className:h.logsRowsIndicator,children:[(0,e.jsx)(P.$n,{icon:c?"play":"pause",variant:"secondary",onClick:c?r:n,className:h.button,children:c?(0,a.t)("explore.live-logs.resume","Resume"):(0,a.t)("explore.live-logs.pause","Pause")}),(0,e.jsx)(P.$n,{icon:"trash-alt",variant:"secondary",onClick:i,className:h.button,children:(0,e.jsx)(a.x6,{i18nKey:"explore.live-logs.clear-logs",children:"Clear logs"})}),(0,e.jsx)(P.$n,{icon:"square-shape",variant:"secondary",onClick:this.props.stopLive,className:h.button,children:(0,e.jsx)(a.x6,{i18nKey:"explore.live-logs.exit-live-mode",children:"Exit live mode"})}),c||this.rowsToRender().length>0&&(0,e.jsx)("span",{children:(0,e.jsxs)(a.x6,{i18nKey:"explore.live-logs.last-line-received",components:{elapsedTime:(0,e.jsx)(er,{resetKey:this.props.logRows,humanize:!0})},children:["Last line received: ","<elapsedTime />"," ago"]})})]})]})}}const nr=(0,k.cV)(or);var rr=l(84596),ar=l(17548),to=l(57852),so=l(83175),At=l(49256),Pt=l(77824),ir=l(97095),Ie=l(18027),Ve=l(21285),re=l(29043),lr=l(44376),cr=l(17896),oo=l(48575),dr=l(27789),no=l(49356),ro=l(29457),rs=l(37234),kt=l(7795),ur=l(24162),dt=l(8535);function pr(){(0,A.rR)("explore_toolbar_contentoutline_clicked",{item:"section",type:"Logs:pinned:pinned-log-added"})}function gr(){(0,A.rR)("explore_toolbar_contentoutline_clicked",{item:"section",type:"Logs:pinned:pinned-log-deleted"})}function hr(){(0,A.rR)("explore_toolbar_contentoutline_clicked",{item:"section",type:"Logs:pinned:pinned-log-limit-reached"})}function mr(){(0,A.rR)("explore_toolbar_contentoutline_clicked",{item:"section",type:"Logs:pinned:pinned-log-clicked"})}function xr(){(0,A.rR)("explore_toolbar_contentoutline_clicked",{item:"section",type:"Logs:pinned:pinned-log-deleted"})}function pl(t){reportInteraction("explore_toolbar_contentoutline_clicked",{item:"section",type:`Logs:filter:${t}`})}var ao=l(55133),fr=l(89640);function yr({feedbackUrl:t}){return(0,e.jsx)(E.B,{children:(0,e.jsx)(fr.Y,{href:t,external:!0,children:(0,e.jsx)(a.x6,{i18nKey:"explore.logs-feedback.give-feedback",children:"Give feedback"})})})}var io=l(59896);const lo=t=>({metaContainer:(0,u.css)({flex:1,color:t.colors.text.secondary,marginBottom:t.spacing(2),minWidth:"30%",display:"flex",flexWrap:"wrap"}),metaItem:(0,u.css)({marginRight:t.spacing(2),marginTop:t.spacing(.5),display:"flex",alignItems:"center",".logs-meta-item__error":{color:t.colors.error.text}}),metaLabel:(0,u.css)({marginRight:`calc(${t.spacing(2)} / 2)`,fontSize:t.typography.bodySmall.fontSize,fontWeight:t.typography.fontWeightMedium,whiteSpace:"nowrap"}),metaValue:(0,u.css)({fontFamily:t.typography.fontFamilyMonospace,fontSize:t.typography.bodySmall.fontSize})}),vr=(0,d.memo)(function(s){const o=(0,k.of)(lo),{label:n,value:r}=s;return(0,e.jsxs)("div",{"data-testid":"meta-info-text-item",className:o.metaItem,children:[n&&(0,e.jsxs)("span",{className:o.metaLabel,children:[n,":"]}),(0,e.jsx)("span",{className:o.metaValue,children:r})]})}),as=(0,d.memo)(function(s){const o=(0,k.of)(lo),{metaItems:n}=s;return(0,e.jsx)("div",{className:o.metaContainer,"data-testid":"meta-info-text",children:n.map((r,i)=>(0,e.jsx)(vr,{label:r.label,value:r.value},`${i}-${r.label}`))})});var ee=l(70159);const br=()=>({metaContainer:(0,u.css)({flex:1,display:"flex",flexWrap:"wrap","& span":{fontWeight:"normal",lineHeight:"1.25em"}})}),co=(0,d.memo)(({meta:t,dedupStrategy:s,dedupCount:o,displayedFields:n,clearDetectedFields:r,logRows:i})=>{const c=(0,k.of)(br),h=[...t];s!==oe.fY.none&&h.push({label:(0,a.t)("explore.logs-meta-row.label.deduplication-count","Deduplication count"),value:o,kind:te.tG.Number}),n?.length>0&&h.push({label:(0,a.t)("explore.logs-meta-row.label.showing-only-selected-fields","Showing only selected fields"),value:(0,e.jsx)(io.A,{labels:n})},{label:"",value:(0,e.jsx)(P.$n,{variant:"primary",fill:"outline",size:"sm",onClick:r,children:(0,e.jsx)(a.x6,{i18nKey:"explore.logs-meta-row.show-original-line",children:"Show original line"})})});function m(x){(0,A.rR)("grafana_logs_download_logs_clicked",{app:Le.Jk.Explore,format:x,area:"logs-meta-row"}),(0,ue.K7)(x,i,t)}const f=(0,e.jsxs)(Ae.W,{children:[(0,e.jsx)(Ae.W.Item,{label:"txt",onClick:()=>m(ue.s.Text)}),(0,e.jsx)(Ae.W.Item,{label:"json",onClick:()=>m(ue.s.Json)}),(0,e.jsx)(Ae.W.Item,{label:"csv",onClick:()=>m(ue.s.CSV)})]}),g={onDisplayMaxToggle:x=>{Ye.M.set(ee.$Z.commonLabels,x)},displayMax:3,displayAll:Ye.M.getBool(ee.$Z.commonLabels,!1)};return(0,e.jsx)(e.Fragment,{children:h&&(0,e.jsxs)("div",{className:c.metaContainer,children:[(0,e.jsx)(as,{metaItems:h.map(x=>({label:x.label,value:"kind"in x?Cr(x.value,x.kind,g):x.value}))}),!M.$.featureToggles.logsPanelControls&&!M.$.featureToggles.newLogsPanel&&!M.$.exploreHideLogsDownload&&(0,e.jsx)(ct.m,{overlay:f,children:(0,e.jsx)(le.I,{isOpen:!1,variant:"canvas",icon:"download-alt",children:(0,e.jsx)(a.x6,{i18nKey:"explore.logs-meta-row.download",children:"Download"})})})]})})});co.displayName="LogsMetaRow";function Cr(t,s,o){return typeof t=="string"||typeof t=="number"?(0,e.jsx)(e.Fragment,{children:t}):s===te.tG.LabelsMap?(0,e.jsx)(io.h,{labels:t,...o}):s===te.tG.Error?(0,e.jsx)("span",{className:"logs-meta-item__error",children:t.toString()}):(console.error(`Meta type ${typeof t} ${t} not recognized.`),(0,e.jsx)(e.Fragment,{}))}var is=l(68079),Sr=l(31937),jr=l(5421);function Rr({pages:t,currentPageIndex:s,oldestLogsFirst:o,timeZone:n,loading:r,onClick:i}){const c=p=>`${(0,_s.LE)(p,{format:jr.WC.interval.second,timeZone:n})}`,h=(p,g)=>{if(s===g&&r)return(0,e.jsx)(is.y,{});const x=c(o?p.logsRange.from:p.logsRange.to),y=c(o?p.logsRange.to:p.logsRange.from);return`${x} \u2014 ${y}`},m=(0,k.$j)(),f=Tr(m,r);return(0,e.jsx)(Yt.P,{children:(0,e.jsx)("div",{className:f.pagesWrapper,"data-testid":"logsNavigationPages",children:(0,e.jsx)("div",{className:f.pagesContainer,children:t.map((p,g)=>(0,e.jsxs)("button",{type:"button","data-testid":`page${g+1}`,className:(0,u.cx)((0,P.my)(m),f.page),onClick:()=>{i(p,g+1)},disabled:r,children:[(0,e.jsx)("div",{className:(0,u.cx)(f.line,{selectedBg:s===g})}),(0,e.jsx)("div",{className:(0,u.cx)(f.time,{selectedText:s===g}),children:h(p,g)})]},p.queryRange.to))})})})}const Tr=(t,s)=>({pagesWrapper:(0,u.css)({height:"100%",paddingLeft:t.spacing(.5),display:"flex",flexDirection:"column","&::after":{content:"''",display:"block",background:`repeating-linear-gradient(135deg, ${t.colors.background.primary}, ${t.colors.background.primary} 5px, ${t.colors.background.secondary} 5px, ${t.colors.background.secondary} 15px)`,width:"3px",height:"inherit",marginBottom:t.spacing(1)}}),pagesContainer:(0,u.css)({display:"flex",padding:0,flexDirection:"column"}),page:(0,u.css)({display:"flex",margin:t.spacing(2,0),cursor:s?"auto":"pointer",whiteSpace:"normal",".selectedBg":{background:t.colors.primary.main},".selectedText":{color:t.colors.primary.main}}),line:(0,u.css)({width:"3px",height:"100%",alignItems:"center",background:t.colors.text.secondary}),time:(0,u.css)({width:"60px",minHeight:"80px",fontSize:t.v1.typography.size.sm,paddingLeft:t.spacing(.5),display:"flex",alignItems:"center"})});function wr({absoluteRange:t,logsSortOrder:s,timeZone:o,loading:n,onChangeTime:r,scrollToTopLogs:i,scrollToBottomLogs:c,visibleRange:h,queries:m,clearCache:f,addResultsToCache:p}){const[g,x]=(0,d.useState)([]),y=(0,d.useRef)(),R=(0,d.useRef)(),b=(0,d.useRef)(0),j=(0,d.useMemo)(()=>g.findIndex(z=>z.queryRange.to===t.to),[t.to,g]),S=s===oe.uH.Ascending,I=S?j===g.length-1:j===0,L=S?j===0:j===g.length-1,v=(0,k.$j)(),w=Ir(v,S);(0,d.useEffect)(()=>{const z={logsRange:h,queryRange:t};let X=[];!(0,G.isEqual)(R.current,t)||!(0,G.isEqual)(y.current,m)?(f(),x([z]),y.current=m,b.current=t.to-t.from):x(ne=>(X=ne.filter(ce=>!(0,G.isEqual)(z.queryRange,ce.queryRange)),X=[...X,z].sort((ce,Ee)=>D(ce,Ee,s)),X))},[h,t,s,m,f,p]);const C=(0,d.useCallback)(({from:z,to:X})=>{p(),R.current={from:z,to:X},r({from:z,to:X})},[r,p]),D=(z,X,ne)=>ne===oe.uH.Ascending?z.queryRange.to>X.queryRange.to?1:-1:z.queryRange.to>X.queryRange.to?-1:1,H=(0,e.jsx)(P.$n,{"data-testid":"olderLogsButton",className:w.navButton,variant:"secondary",onClick:()=>{if((0,A.rR)("grafana_explore_logs_pagination_clicked",{pageType:"olderLogsButton"}),L)C({from:h.from-b.current,to:h.from});else{const z=S?-1:1;C({from:g[j+z].queryRange.from,to:g[j+z].queryRange.to})}i()},disabled:n,children:(0,e.jsxs)("div",{className:w.navButtonContent,children:[n?(0,e.jsx)(is.y,{}):(0,e.jsx)(V.I,{name:S?"angle-up":"angle-down",size:"lg"}),(0,e.jsx)(a.x6,{i18nKey:"logs.logs-navigation.older-logs",children:"Older logs"})]})}),N=(0,e.jsx)(P.$n,{"data-testid":"newerLogsButton",className:w.navButton,variant:"secondary",onClick:()=>{if((0,A.rR)("grafana_explore_logs_pagination_clicked",{pageType:"newerLogsButton"}),!I){const z=S?1:-1;C({from:g[j+z].queryRange.from,to:g[j+z].queryRange.to})}i()},disabled:n||I,children:(0,e.jsxs)("div",{className:w.navButtonContent,children:[n&&(0,e.jsx)(is.y,{}),I||n?null:(0,e.jsx)(V.I,{name:S?"angle-down":"angle-up",size:"lg"}),I?(0,a.t)("logs.logs-navigation.start-of-range","Start of range"):(0,a.t)("logs.logs-navigation.newer-logs","Newer logs")]})}),$=(0,d.useCallback)((z,X)=>{(0,A.rR)("grafana_explore_logs_pagination_clicked",{pageType:"page",pageNumber:X}),C({from:z.queryRange.from,to:z.queryRange.to}),i()},[C,i]),F=(0,d.useCallback)(()=>{(0,A.rR)("grafana_explore_logs_scroll_top_clicked"),i()},[i]),K=(0,d.useCallback)(()=>{(0,A.rR)("grafana_explore_logs_scroll_bottom_clicked"),c?.()},[c]);return(0,e.jsxs)("div",{className:w.navContainer,children:[!M.$.featureToggles.logsInfiniteScrolling&&(0,e.jsxs)(e.Fragment,{children:[S?H:N,(0,e.jsx)(Rr,{pages:g,currentPageIndex:j,oldestLogsFirst:S,timeZone:o,loading:n,onClick:$}),S?N:H]}),c&&(0,e.jsx)(P.$n,{"data-testid":"scrollToBottom",className:w.scrollToBottomButton,variant:"secondary",onClick:K,title:(0,a.t)("logs.logs-navigation.scroll-bottom","Scroll to bottom"),children:(0,e.jsx)(V.I,{name:"arrow-down",size:"lg"})}),(0,e.jsx)(P.$n,{"data-testid":"scrollToTop",className:w.scrollToTopButton,variant:"secondary",onClick:F,title:(0,a.t)("logs.logs-navigation.scroll-top","Scroll to top"),children:(0,e.jsx)(V.I,{name:"arrow-up",size:"lg"})})]})}const Lr=(0,d.memo)(wr),Ir=(t,s)=>{const o=`calc(100vh - 2*${t.spacing(2)} - 2*${(0,Sr.vn)()}px)`;return{navContainer:(0,u.css)({maxHeight:o,width:s&&!M.$.featureToggles.newLogsPanel?"58px":"auto",display:"flex",flexDirection:"column",justifyContent:M.$.featureToggles.logsInfiniteScrolling?"flex-end":s?"flex-start":"space-between",position:"sticky",top:t.spacing(2),right:0}),navButton:(0,u.css)({width:"58px",height:"68px",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",lineHeight:1}),navButtonContent:(0,u.css)({display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",width:"100%",height:"100%",whiteSpace:"normal"}),scrollToBottomButton:(0,u.css)({width:"40px",height:"40px",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",position:"absolute",top:0}),scrollToTopButton:(0,u.css)({width:"40px",height:"40px",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",marginTop:t.spacing(1)})}};var uo=l(25984),Er=l(16515),Fr=l(76732);const Dr=100;function Nt(t){const[s,o]=(0,d.useState)(!1),[n,r]=(0,d.useState)(!1),{dismissable:i,error:c,title:h,suggestedAction:m,onSuggestedAction:f,onRemove:p,severity:g="warning"}=t,x=t.message??c?.message??c?.data?.message??"",y=typeof x=="string"&&x.length>Dr,R=(0,k.$j)(),b=Or(R),j=(0,d.useCallback)(()=>{r(!0)},[]),S=i?j:p;return n?null:(0,e.jsx)("div",{className:b.supplementaryErrorContainer,children:(0,e.jsx)(Je.F,{title:h,severity:g,onRemove:S,children:y?(0,e.jsx)("div",{className:b.messageWrapper,children:s?x:(0,e.jsx)(P.$n,{variant:"secondary",size:"xs",onClick:()=>{o(!0)},children:(0,e.jsx)(a.x6,{i18nKey:"explore.supplementary-result-error.show-details",children:"Show details"})})}):(0,e.jsxs)("div",{className:`${b.messageWrapper} ${b.suggestedActionWrapper}`,children:[x,m&&f&&(0,e.jsx)(P.$n,{variant:"primary",size:"xs",onClick:f,children:m})]})})})}const Or=t=>({supplementaryErrorContainer:(0,u.css)({width:"60%",minWidth:`${t.breakpoints.values.sm}px`,maxWidth:`${t.breakpoints.values.md}px`,margin:"0 auto"}),messageWrapper:(0,u.css)({minHeight:t.spacing(3),ul:{paddingLeft:t.spacing(2)},button:{position:"absolute",bottom:t.spacing(2),right:t.spacing(2)}}),suggestedActionWrapper:(0,u.css)({paddingBottom:t.spacing(5)})});var Ar=l(97486);function Pr(t){const{width:s,timeZone:o,splitOpen:n,onUpdateTimeRange:r,onHiddenSeriesChanged:i,allLogsVolumeMaximum:c,toggleLegendRef:h}=t,m=(0,k.$j)(),f=(0,k.of)(kr),p=parseInt(m.spacing(2).slice(0,-2),10),g=150,x=t.logsVolumeData,y=(0,ue.Dm)(x?.data);let R=y?`${y.name}`:"";(0,ue.e3)(x.data)&&(R=[R,"This datasource does not support full-range histograms. The graph below is based on the logs seen in the response."].filter(G.identity).join(". "));let b=(0,e.jsx)("span",{children:R});return x.state===pe.Gu.Streaming&&(b=(0,e.jsxs)(e.Fragment,{children:[b,(0,e.jsx)(U.m,{content:(0,a.t)("explore.logs-volume-panel.content-streaming","Streaming"),children:(0,e.jsx)(V.I,{name:"circle-mono",size:"md",className:f.streaming,"data-testid":"logs-volume-streaming"})})]})),(0,e.jsxs)("div",{style:{height:g},className:f.contentContainer,children:[(0,e.jsx)(Ar.k,{toggleLegendRef:h,vizLegendOverrides:{calcs:["sum"]},graphStyle:"lines",loadingState:x.state??pe.Gu.Done,data:x.data,height:g,width:s-p*2,timeRange:t.timeRange,onChangeTime:r,timeZone:o,splitOpenFn:n,tooltipDisplayMode:oe.$N.Multi,onHiddenSeriesChanged:i,anchorToZero:!0,yAxisMaximum:c,eventBus:t.eventBus,annotations:t.annotations}),b&&(0,e.jsx)("div",{className:f.extraInfoContainer,children:b})]})}const kr=t=>({extraInfoContainer:(0,u.css)({display:"flex",justifyContent:"end",position:"absolute",right:"5px",top:"-10px",fontSize:t.typography.bodySmall.fontSize,color:t.colors.text.secondary}),contentContainer:(0,u.css)({display:"flex",alignItems:"center",justifyContent:"center",position:"relative"}),streaming:(0,u.css)({color:t.colors.success.text})});function Nr(t){return!t||!t.error&&!t.errors?!1:(t.error?[t.error]:t.errors||[]).some(o=>(`${o.message||o.data?.message}`?.toLowerCase()).includes("timeout"))}const Mr=({logsVolumeData:t,absoluteRange:s,onUpdateTimeRange:o,width:n,onLoadLogsVolume:r,onDisplayedSeriesChanged:i,eventBus:c,splitOpen:h,timeZone:m,onClose:f,toggleLegendRef:p})=>{const{logVolumes:g,maximumValue:x,maximumRange:y,annotations:R}=(0,d.useMemo)(()=>{let H=-1/0;const N=t?.data.filter(ne=>ne.meta?.dataTopic!==oe.QR.Annotations),$=t?.data.filter(ne=>ne.meta?.dataTopic===oe.QR.Annotations)||[],F=(0,G.sortBy)(N||[],"meta.custom.datasourceName"),K=(0,G.groupBy)(F,"meta.custom.datasourceName"),z=(0,G.mapValues)(K,ne=>{const ce=(0,ue.oT)(ne);return H=Math.max(H,ce.maximum),ce.dataFrames}),X=(0,ue.Dx)((0,G.flatten)(Object.values(z)));return{maximumValue:H,maximumRange:X,logVolumes:z,annotations:$}},[t]),b=(0,k.of)(Hr),j=Object.keys(g).length,S=Object.values(g).some(H=>{const N=Br(H,s);return!(0,ue.e3)(H)&&N&&N<1}),I=M.$.featureToggles.lokiShardSplitting&&t&&t.data.length>0,L=Nr(t),v=(0,_e.KQ)(Math.max(s.from,y.from)),w=(0,_e.KQ)(Math.min(s.to,y.to)),C={from:v,to:w,raw:{from:v,to:w}},D=(0,d.useCallback)(H=>{if(j>1)return;const N=[...new Set(Object.values(g).map(F=>F.map(K=>(0,Er.Ri)(K))).flat())],$=N.filter(F=>!H.includes(F));i((0,Fr.ab)(N,$)?[]:$)},[g,j,i]);return t?.state===pe.Gu.Loading?(0,e.jsx)("span",{children:(0,e.jsx)(a.x6,{i18nKey:"explore.logs-volume-panel-list.loading",children:"Loading..."})}):L&&!I?(0,e.jsx)(Nt,{title:(0,a.t)("explore.logs-volume-panel-list.title-unable-to-show-log-volume","Unable to show log volume"),message:(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)("p",{children:(0,e.jsx)(a.x6,{i18nKey:"explore.logs.logs-volume.much-data",children:"The query is trying to access too much data. Try one or more of the following:"})}),(0,e.jsxs)("ul",{children:[(0,e.jsx)("li",{children:(0,e.jsx)(a.x6,{i18nKey:"explore.logs.logs-volume.add-filters",children:"Add more labels to your query to narrow down your search."})}),(0,e.jsx)("li",{children:(0,e.jsx)(a.x6,{i18nKey:"explore.logs.logs-volume.decrease-timerange",children:"Decrease the time range of your query."})})]})]}),severity:"info",suggestedAction:"Retry",onSuggestedAction:r,onRemove:f}):t?.error!==void 0&&!I?(0,e.jsx)(Nt,{error:t.error,title:(0,a.t)("explore.logs-volume-panel-list.title-failed-volume-query","Failed to load log volume for this query")}):j===0&&t?.state!==pe.Gu.Streaming?(0,e.jsx)("div",{className:b.alertContainer,children:(0,e.jsx)(Je.F,{severity:"info",title:(0,a.t)("explore.logs-volume-panel-list.title-no-logs-volume-available","No logs volume available"),children:(0,e.jsx)(a.x6,{i18nKey:"explore.logs-volumne-panel-list.body-no-logs-volume-available",children:"No volume information available for the current queries and time range."})})}):(0,e.jsxs)("div",{className:b.listContainer,children:[L&&I&&(0,e.jsx)(Nt,{title:(0,a.t)("explore.logs-volume-panel-list.title-showing-partial-data","Showing partial data"),message:"The query is trying to access too much data and some sharded requests could not be completed. Try decreasing the time range or adding more labels to your query.",severity:"info",dismissable:!0}),Object.keys(g).map((H,N)=>(0,e.jsx)(Pr,{toggleLegendRef:p,timeRange:C,allLogsVolumeMaximum:x,width:n,logsVolumeData:{data:g[H],state:t?.state},onUpdateTimeRange:o,timeZone:m,splitOpen:h,onLoadLogsVolume:r,onHiddenSeriesChanged:j>1?()=>{}:D,eventBus:c,annotations:R},N)),S&&(0,e.jsx)("div",{className:b.extraInfoContainer,children:(0,e.jsx)(Ie.I,{label:(0,a.t)("explore.logs-volume-panel-list.label-reload-log-volume","Reload log volume"),transparent:!0,children:(0,e.jsx)(P.$n,{size:"xs",icon:"sync",variant:"secondary",onClick:r,id:"reload-volume"})})})]})},Hr=t=>({listContainer:(0,u.css)({paddingTop:"10px"}),extraInfoContainer:(0,u.css)({display:"flex",justifyContent:"end",position:"absolute",right:"5px",top:"5px"}),oldInfoText:(0,u.css)({fontSize:t.typography.bodySmall.fontSize,color:t.colors.text.secondary}),alertContainer:(0,u.css)({width:"50%",minWidth:`${t.breakpoints.values.sm}px`,margin:"0 auto"})});function Br(t,s){const o=t&&t[0]&&t[0].meta?.custom?.absoluteRange;return o?(s.from-s.to)/(o.from-o.to):void 0}const $r=[oe.fY.none,oe.fY.exact,oe.fY.numbers,oe.fY.signature],ls=()=>{const t=re.A.get(ee.r3);return t==="table"?"table":t==="logs"?"logs":M.$.featureToggles.logsExploreTableDefaultVisualization?"table":"logs"},Mt=10,cs="Pinned log",po="Pin to content outline",Ht="Logs",Vr=t=>{const{width:s,splitOpen:o,logRows:n,logsMeta:r,logsVolumeEnabled:i,logsVolumeData:c,loadLogsVolumeData:h,loading:m=!1,onClickFilterLabel:f,onClickFilterOutLabel:p,timeZone:g,scanning:x,scanRange:y,showContextToggle:R,absoluteRange:b,onChangeTime:j,getFieldLinks:S,theme:I,logsQueries:L,clearCache:v,addResultsToCache:w,exploreId:C,getRowContext:D,getLogRowContextUi:H,getRowContextQuery:N,loadMoreLogs:$,panelState:F,eventBus:K,onPinLineCallback:z,scrollElement:X}=t,[ne,ce]=(0,d.useState)(re.A.getBool(ee.$Z.showLabels,!1)),[Ee,$t]=(0,d.useState)(re.A.getBool(ee.$Z.showTime,!0)),[Ce,Vt]=(0,d.useState)(re.A.getBool(ee.$Z.wrapLogMessage,!0)),[Q,Pe]=(0,d.useState)(re.A.getBool(ee.$Z.prettifyLogMessage,!1)),[ze,Eo]=(0,d.useState)(oe.fY.none),[ke,Vi]=(0,d.useState)(re.A.get(ee.$Z.logsSortOrder)||oe.uH.Descending),[Qi,Fo]=(0,d.useState)(!1),[me,gt]=(0,d.useState)([]),[Wi,Do]=(0,d.useState)(!1),[Ke,Oo]=(0,d.useState)(void 0),[ys,Ao]=(0,d.useState)(po),[de,Po]=(0,d.useState)(F?.logs?.visualisationType??ls()),ve=(0,d.useRef)(null),Ne=(0,O.wA)(),ko=(0,rr.A)(m),zi=K.newScopedBus("logsvolume",{onlyLocal:!1}),{register:No,unregister:vs,outlineItems:st,updateItem:bs}=Xt()??{},Cs=(0,d.useRef)(void 0),Ss=(0,d.useRef)(void 0),Qt=(0,d.useRef)(()=>{}),js=(0,d.useRef)(null),[Mo,Ho]=(0,d.useState)(void 0),Ki=(0,uo.z)(),Y=Wr(I,Ce||de==="table",Ki),ht=n&&n.length>0,Ui=y?`Scanning ${ar.describeTimeRange(y)}`:"Scanning...",Bo=st?.find(T=>T.panelId===Ht&&T.level==="root"),mt=(0,d.useMemo)(()=>Bo?.children?.filter(T=>T.title===cs).map(T=>T.id),[Bo?.children]),xt=(0,d.useCallback)(()=>st?.find(B=>B.panelId===Ht&&B.level==="root")?.children?.filter(B=>B.title===cs).length??0,[st]);(0,d.useEffect)(()=>{xt()===Mt?Ao((0,e.jsxs)("span",{style:{display:"flex",textAlign:"center"},children:["\u2757\uFE0F",(0,e.jsxs)(a.x6,{i18nKey:"explore.logs.maximum-pinned-logs",children:["Maximum of ",{PINNED_LOGS_LIMIT:Mt}," pinned logs reached. Unpin a log to add another."]})]})):Ao(po)},[st,xt]),(0,d.useEffect)(()=>{m&&!ko&&F?.logs?.id&&(delete F.logs.id,Ne((0,Te.EA)(C,"logs",{...F})))},[Ne,C,m,F,ko]),(0,d.useEffect)(()=>{const T=F?.logs?.visualisationType??ls();Po(T),re.A.set(ee.r3,T)},[F?.logs?.visualisationType]),(0,d.useEffect)(()=>{let T=[];Array.isArray(F?.logs?.displayedFields)?T=F?.logs?.displayedFields:F?.logs?.displayedFields&&typeof F?.logs?.displayedFields=="object"&&(T=Object.values(F?.logs?.displayedFields)),gt(T)},[F?.logs?.displayedFields]),(0,rt.A)(()=>{Cs&&window.clearTimeout(Cs.current),Ss&&window.clearTimeout(Ss.current)}),(0,rt.A)(()=>{(F?.logs?.columns||F?.logs?.refId||F?.logs?.labelFieldName||F?.logs?.displayedFields)&&Ne((0,Te.EA)(C,"logs",{...F?.logs,columns:void 0,visualisationType:de,labelFieldName:void 0,refId:void 0,displayedFields:void 0}))});const Se=(0,d.useCallback)(T=>{const B=(0,dt.Gu)().explore.panes[C];B?.panelsState&&Ne((0,Te.EA)(C,"logs",{...B.panelsState.logs,columns:T.columns??F?.logs?.columns,visualisationType:T.visualisationType??de,labelFieldName:T.labelFieldName,refId:T.refId??F?.logs?.refId,displayedFields:T.displayedFields??F?.logs?.displayedFields}))},[Ne,C,F?.logs?.columns,F?.logs?.displayedFields,F?.logs?.refId,de]),Rs=(0,d.useCallback)(T=>{T?t.eventBus.publish(new to.b_({point:{time:T.timeEpochMs}})):t.eventBus.publish(new to.ql)},[t.eventBus]),Gi=(0,d.useCallback)(T=>{if(M.$.featureToggles.logsInfiniteScrolling){ve.current&&(js.current?.scrollIntoView(),ve.current.scroll({behavior:"smooth",top:ve.current.scrollTop+T.getBoundingClientRect().top-window.innerHeight/2}));return}X&&X.scroll({behavior:"smooth",top:X.scrollTop+T.getBoundingClientRect().top-window.innerHeight/2})},[X]),Wt=(0,d.useCallback)(T=>{if(!L)return;let B=!1;const J=L.map(ae=>{if(ae.datasource?.type!=="loki"||!(0,ur.kr)(ae)||ae.direction===kt.ti.Scan)return ae;B=!0;const xe=T===oe.uH.Ascending?kt.ti.Forward:kt.ti.Backward;return xe!==ae.direction&&(ae.direction=xe),ae});B&&(Ne((0,W.bO)({exploreId:C,queries:J})),Ne((0,W.Od)({exploreId:C})))},[Ne,C,L]),qi=(0,d.useCallback)(T=>{Fo(!0),Cs.current=window.setTimeout(()=>{re.A.set(ee.$Z.logsSortOrder,T),Wt(T),Vi(T)},0),Ss.current=window.setTimeout(()=>Fo(!1),1e3)},[Wt]),Zi=(0,d.useCallback)(T=>{Po(T);const B={...F?.logs,visualisationType:T};Se(B),(0,A.rR)("grafana_explore_logs_visualisation_changed",{newVisualizationType:T,datasourceType:t.datasourceType??"unknown",defaultVisualisationType:M.$.featureToggles.logsExploreTableDefaultVisualization?"table":"logs"})},[F?.logs,t.datasourceType,Se]),Yi=(0,d.useCallback)(T=>{(0,A.rR)("grafana_explore_logs_deduplication_clicked",{deduplicationType:T,datasourceType:t.datasourceType}),Eo(T)},[t.datasourceType]),Ji=(0,d.useCallback)(T=>{const{target:B}=T;if(B){const J=B.checked;ce(J),re.A.set(ee.$Z.showLabels,J)}},[]),Xi=(0,d.useCallback)(T=>{const{target:B}=T;if(B){const J=B.checked;$t(J),re.A.set(ee.$Z.showTime,J)}},[]),_i=(0,d.useCallback)(T=>{const{target:B}=T;if(B){const J=B.checked;Vt(J),re.A.set(ee.$Z.wrapLogMessage,J)}},[]),el=(0,d.useCallback)(T=>{const{target:B}=T;if(B){const J=B.checked;Pe(J),re.A.set(ee.$Z.prettifyLogMessage,J)}},[]),$o=(0,d.useCallback)(T=>{t.onSetLogsVolumeEnabled(!T),(0,A.rR)("grafana_explore_logs_histogram_toggle_clicked",{datasourceType:t.datasourceType,type:T?"close":"open"})},[t]),tl=(0,d.useCallback)(T=>{T.preventDefault(),t.onStartScanning&&(t.onStartScanning(),(0,A.rR)("grafana_explore_logs_scanning_button_clicked",{type:"start",datasourceType:t.datasourceType}))},[t]),sl=(0,d.useCallback)(T=>{T.preventDefault(),t.onStopScanning&&t.onStopScanning()},[t]),Ts=(0,d.useCallback)(T=>{if(me.indexOf(T)===-1){const J=me.concat(T);gt(J),Se({...F?.logs,displayedFields:J})}},[me,F?.logs,Se]),ws=(0,d.useCallback)(T=>{if(me.indexOf(T)>-1){const J=me.filter(ae=>T!==ae);gt(J),Se({...F?.logs,displayedFields:J})}},[me,F?.logs,Se]),ol=(0,d.useCallback)(()=>{Se({...F?.logs,displayedFields:[]}),gt([])},[F?.logs,Se]),Ls=(0,d.useRef)(()=>{});let nl=(0,d.useCallback)(()=>{Do(!1),Oo(void 0),(0,A.rR)("grafana_explore_logs_log_context_closed",{datasourceType:Ke?.datasourceType,logRowUid:Ke?.uid}),Ls?.current()},[Ke?.datasourceType,Ke?.uid,Ls]);const ft=(0,d.useCallback)((T,B)=>{Do(!0),Oo(T),(0,A.rR)("grafana_explore_logs_log_context_opened",{datasourceType:T.datasourceType,logRowUid:T.uid}),Ls.current=B},[]),Is=(0,d.useCallback)(async T=>{if(T.rowId===void 0)return;const B=(0,ao.m)((0,dt.Gu)().explore.panes[C]);B.panelsState={...F,logs:{id:T.uid,visualisationType:de??ls(),displayedFields:me}},B.range=(0,Dt.sU)(T,n,b);const J=(0,so.Pp)(B),ae=/.*(?=\/explore)/.exec(`${window.location.href}`)[0],xe=so.kM.renderUrl(`${ae}/explore`,{left:J});await(0,Dt.VP)(xe),(0,A.rR)("grafana_explore_logs_permalink_clicked",{datasourceType:T.datasourceType??"unknown",logRowUid:T.uid,logRowLevel:T.logLevel})},[b,me,C,n,F,de]),rl=(0,d.useCallback)(()=>{M.$.featureToggles.logsInfiniteScrolling&&ve.current&&ve.current.scroll({behavior:"auto",top:0}),js.current?.scrollIntoView()},[]),ot=(0,d.useCallback)((T,B=!0)=>{if(xt()===Mt&&!B){hr();return}const J=st?.find(xe=>xe.panelId===Ht&&xe.level==="root");J&&bs&&bs(J.id,{expanded:!0});const ae=mt?.find(xe=>xe===T.rowId);ae&&T.rowId&&B?(vs?.(T.rowId),gr()):xt()!==Mt&&!ae&&(No?.({id:T.rowId,icon:"gf-logs",title:cs,panelId:Ht,level:"child",ref:null,color:rs.cZ[T.logLevel],childOnTop:!0,onClick:()=>{ft(T,()=>{}),mr()},onRemove:xe=>{vs?.(xe),xr()}}),pr()),z?.()},[xt,ft,z,st,mt,No,vs,bs]),al=(0,d.useMemo)(()=>zr(n),[n]),{dedupedRows:Es,dedupCount:il}=(0,d.useMemo)(()=>Kr(n,ze),[ze,n]),ll=(0,d.useMemo)(()=>Ur(n),[n]),Vo=(0,d.useMemo)(()=>!L?.some(T=>"direction"in T&&T.direction===kt.ti.Scan),[L]),zt=(0,d.useRef)(!0),Qo=(0,d.useCallback)((T,B)=>{if(T==="sortOrder"&&(0,ro.Q4)(B))Wt(B);else if(T==="dedupStrategy"&&(0,ro.KB)(B))Eo(B);else if(T==="filterLevels"&&Array.isArray(B)&&i){const J=c?.data.filter(yt=>yt.meta?.dataTopic!==oe.QR.Annotations)??[],ae=(0,G.groupBy)(J,"meta.custom.datasourceName");if(Object.keys(ae).length>1)return;const Wo=[...new Set(J.map(yt=>{const{level:Kt}=(0,ue.tX)(yt,J);return(0,ue.EK)(Kt)}))];Ho(yt=>{const Kt=B.map(ge=>(0,ue.EK)(ge)),Fs=Kt.filter(ge=>Wo.includes(ge)),Ds=yt?.filter(ge=>Wo.includes(ge))??[];if(!Fs.length){Qt.current?.(void 0,At.B.ToggleSelection);return}const dl=Fs.filter(ge=>!Ds.includes(ge)),ul=Ds.filter(ge=>!Fs.includes(ge));return dl.forEach(ge=>{zt.current=!0,Qt.current?.(ge,Ds.length?At.B.AppendToSelection:At.B.ToggleSelection)}),ul.forEach(ge=>{zt.current=!0,Qt.current?.(ge,At.B.AppendToSelection)}),Kt})}},[c?.data,i,Wt]),cl=(0,d.useCallback)(T=>{if(zt.current){zt.current=!1;return}Ho(T.map(B=>(0,ue.EK)(B)))},[]);return(0,e.jsxs)(e.Fragment,{children:[D&&Ke&&(0,e.jsx)(dr.V,{open:Wi,row:Ke,onClose:nl,getRowContext:(T,B)=>D(T,Ke,B),getRowContextQuery:N,getLogRowContextUi:H,logsSortOrder:ke,timeZone:g}),(0,e.jsx)(we.NR,{title:(0,a.t)("explore.unthemed-logs.title-logs-volume","Logs volume"),collapsible:!0,collapsed:!i,onToggleCollapse:$o,children:i&&(0,e.jsx)(Mr,{toggleLegendRef:Qt,absoluteRange:b,width:s,logsVolumeData:c,onUpdateTimeRange:j,timeZone:g,splitOpen:o,onLoadLogsVolume:h,onDisplayedSeriesChanged:cl,eventBus:zi,onClose:()=>$o(!0)})}),(0,e.jsxs)(we.NR,{titleItems:[M.$.featureToggles.logsExploreTableVisualisation?de==="logs"?null:(0,e.jsx)(we.NR.TitleItem,{title:(0,a.t)("explore.unthemed-logs.title-feedback","Feedback"),children:(0,e.jsx)(yr,{feedbackUrl:"https://forms.gle/5YyKdRQJ5hzq4c289"})},"A"):null],title:(0,a.t)("explore.unthemed-logs.title-logs","Logs"),actions:(0,e.jsx)(e.Fragment,{children:M.$.featureToggles.logsExploreTableVisualisation&&(0,e.jsx)("div",{className:Y.visualisationType,children:(0,e.jsx)(Pt.z,{className:Y.visualisationTypeRadio,options:[{label:(0,a.t)("explore.unthemed-logs.label.logs","Logs"),value:"logs",description:(0,a.t)("explore.unthemed-logs.description.show-results-in-logs-visualisation","Show results in logs visualisation")},{label:(0,a.t)("explore.unthemed-logs.label.table","Table"),value:"table",description:(0,a.t)("explore.unthemed-logs.description.show-results-in-table-visualisation","Show results in table visualisation")}],size:"sm",value:de,onChange:Zi})})}),loadingState:m?pe.Gu.Loading:pe.Gu.Done,children:[(0,e.jsxs)("div",{className:Y.stickyNavigation,children:[de!=="table"&&!M.$.featureToggles.newLogsPanel&&!M.$.featureToggles.logsPanelControls&&(0,e.jsxs)("div",{className:Y.logOptions,children:[(0,e.jsxs)(ir.C,{children:[(0,e.jsx)(Ie.I,{label:(0,a.t)("explore.unthemed-logs.label-time","Time"),className:Y.horizontalInlineLabel,transparent:!0,children:(0,e.jsx)(Ve.K,{value:Ee,onChange:Xi,className:Y.horizontalInlineSwitch,transparent:!0,id:`show-time_${C}`})}),(0,e.jsx)(Ie.I,{label:(0,a.t)("explore.unthemed-logs.label-unique-labels","Unique labels"),className:Y.horizontalInlineLabel,transparent:!0,children:(0,e.jsx)(Ve.K,{value:ne,onChange:Ji,className:Y.horizontalInlineSwitch,transparent:!0,id:`unique-labels_${C}`})}),(0,e.jsx)(Ie.I,{label:(0,a.t)("explore.unthemed-logs.label-wrap-lines","Wrap lines"),className:Y.horizontalInlineLabel,transparent:!0,children:(0,e.jsx)(Ve.K,{value:Ce,onChange:_i,className:Y.horizontalInlineSwitch,transparent:!0,id:`wrap-lines_${C}`})}),(0,e.jsx)(Ie.I,{label:(0,a.t)("explore.unthemed-logs.label-prettify-json","Prettify JSON"),className:Y.horizontalInlineLabel,transparent:!0,children:(0,e.jsx)(Ve.K,{value:Q,onChange:el,className:Y.horizontalInlineSwitch,transparent:!0,id:`prettify_${C}`})}),(0,e.jsx)(Ie.I,{label:(0,a.t)("explore.unthemed-logs.label-deduplication","Deduplication"),className:Y.horizontalInlineLabel,transparent:!0,children:(0,e.jsx)(Pt.z,{options:$r.map(T=>({label:(0,G.capitalize)(T),value:T,description:te._C[T]})),value:ze,onChange:Yi,className:Y.radioButtons})})]}),(0,e.jsx)("div",{children:(0,e.jsx)(Ie.I,{label:(0,a.t)("explore.unthemed-logs.label-display-results","Display results"),className:Y.horizontalInlineLabel,transparent:!0,disabled:Qi||m,children:(0,e.jsx)(Pt.z,{options:[{label:(0,a.t)("explore.unthemed-logs.label.newest-first","Newest first"),value:oe.uH.Descending,description:(0,a.t)("explore.unthemed-logs.description.show-results-newest-to-oldest","Show results newest to oldest")},{label:(0,a.t)("explore.unthemed-logs.label.oldest-first","Oldest first"),value:oe.uH.Ascending,description:(0,a.t)("explore.unthemed-logs.description.show-results-oldest-to-newest","Show results oldest to newest")}],value:ke,onChange:qi,className:Y.radioButtons})})})]}),(0,e.jsx)("div",{ref:js}),(0,e.jsx)(co,{logRows:n,meta:r||[],dedupStrategy:ze,dedupCount:il,displayedFields:me,clearDetectedFields:ol})]}),(0,e.jsxs)("div",{className:(0,u.cx)(Y.logsSection,de==="table"?Y.logsTable:void 0),children:[!M.$.featureToggles.logsPanelControls&&de==="table"&&ht&&(0,e.jsx)("div",{className:Y.logRows,"data-testid":"logRowsTable",children:(0,e.jsx)(uo.Y,{logsSortOrder:ke,range:t.range,splitOpen:o,timeZone:g,width:s-80,logsFrames:t.logsFrames??[],onClickFilterLabel:f,onClickFilterOutLabel:p,panelState:F?.logs,theme:I,updatePanelState:Se,datasourceType:t.datasourceType})}),(!M.$.featureToggles.newLogsPanel||de==="table")&&M.$.featureToggles.logsPanelControls&&ht&&(0,e.jsx)("div",{className:Y.logRowsWrapper,"data-testid":"logRows",children:(0,e.jsx)(lr.U,{logsTableFrames:t.logsFrames,width:s,updatePanelState:Se,panelState:F?.logs,datasourceType:t.datasourceType,splitOpen:o,visualisationType:de,loading:m,loadMoreLogs:Vo?$:void 0,range:t.range,pinnedLogs:mt,logRows:n,deduplicatedRows:Es,dedupStrategy:ze,onClickFilterLabel:f,onClickFilterOutLabel:p,showContextToggle:R,getRowContextQuery:N,showLabels:ne,showTime:Ee,enableLogDetails:!0,wrapLogMessage:Ce,prettifyLogMessage:Q,timeZone:g,getFieldLinks:S,logsSortOrder:ke,displayedFields:me,onClickShowField:Ts,onClickHideField:ws,app:Le.Jk.Explore,onLogRowHover:Rs,onOpenContext:ft,onPermalinkClick:Is,permalinkedRowId:F?.logs?.id,isFilterLabelActive:t.isFilterLabelActive,onClickFilterString:t.onClickFilterString,onClickFilterOutString:t.onClickFilterOutString,onUnpinLine:ot,onPinLine:ot,pinLineButtonTooltipTitle:ys,logsMeta:r,logOptionsStorageKey:ee.OY,onLogOptionsChange:Qo,hasUnescapedContent:al,filterLevels:Mo})}),!M.$.featureToggles.logsPanelControls&&!M.$.featureToggles.newLogsPanel&&de==="logs"&&ht&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)("div",{className:M.$.featureToggles.logsInfiniteScrolling?Y.scrollableLogRows:Y.logRows,"data-testid":"logRows",ref:ve,children:(0,e.jsx)(cr.u8,{loading:m,loadMoreLogs:Vo?$:void 0,range:t.range,timeZone:g,rows:n,scrollElement:ve.current,sortOrder:ke,app:Le.Jk.Explore,children:(0,e.jsx)(oo.k,{pinnedLogs:mt,logRows:n,deduplicatedRows:Es,dedupStrategy:ze,onClickFilterLabel:f,onClickFilterOutLabel:p,showContextToggle:R,getRowContextQuery:N,showLabels:ne,showTime:Ee,enableLogDetails:!0,wrapLogMessage:Ce,prettifyLogMessage:Q,timeZone:g,getFieldLinks:S,logsSortOrder:ke,displayedFields:me,onClickShowField:Ts,onClickHideField:ws,app:Le.Jk.Explore,onLogRowHover:Rs,onOpenContext:ft,onPermalinkClick:Is,permalinkedRowId:F?.logs?.id,scrollIntoView:Gi,isFilterLabelActive:t.isFilterLabelActive,scrollElement:ve.current,onClickFilterString:t.onClickFilterString,onClickFilterOutString:t.onClickFilterOutString,onUnpinLine:ot,onPinLine:ot,pinLineButtonTooltipTitle:ys,renderPreview:!0})})}),(0,e.jsx)(Lr,{logsSortOrder:ke,visibleRange:ll??b,absoluteRange:b,timeZone:g,onChangeTime:j,loading:m,queries:L??[],scrollToTopLogs:rl,addResultsToCache:w,clearCache:v})]}),M.$.featureToggles.newLogsPanel&&de==="logs"&&ht&&(0,e.jsx)("div",{"data-testid":"logRows",ref:ve,className:Y.logRowsWrapper,children:ve.current&&(0,e.jsx)(no.Z,{app:Le.Jk.Explore,containerElement:ve.current,enableLogDetails:!0,dedupStrategy:ze,displayedFields:me,filterLevels:Mo,getFieldLinks:S,getRowContextQuery:N,isLabelFilterActive:t.isFilterLabelActive,loading:m,loadMore:$,logOptionsStorageKey:ee.OY,logs:Es,logsMeta:r,logSupportsContext:R,onClickShowField:Ts,onClickHideField:ws,onClickFilterLabel:f,onClickFilterOutLabel:p,onClickFilterString:t.onClickFilterString,onClickFilterOutString:t.onClickFilterOutString,onLogOptionsChange:Qo,onLogLineHover:Rs,onOpenContext:ft,onPermalinkClick:Is,onPinLine:ot,onUnpinLine:ot,permalinkedLogId:F?.logs?.id,pinLineButtonTooltipTitle:ys,pinnedLogs:mt,setDisplayedFields:gt,showControls:!0,showTime:Ee,sortOrder:ke,timeRange:t.range,timeZone:g,wrapLogMessage:Ce})}),!m&&!ht&&!x&&(0,e.jsx)("div",{className:Y.noDataWrapper,children:(0,e.jsxs)("div",{className:Y.noData,children:[(0,e.jsx)(a.x6,{i18nKey:"explore.logs.no-logs-found",children:"No logs found."}),(0,e.jsx)(P.$n,{size:"sm",variant:"secondary",className:Y.scanButton,onClick:tl,children:(0,e.jsx)(a.x6,{i18nKey:"explore.logs.scan-for-older-logs",children:"Scan for older logs"})})]})}),x&&(0,e.jsx)("div",{className:Y.noDataWrapper,children:(0,e.jsxs)("div",{className:Y.noData,children:[(0,e.jsx)("span",{children:Ui}),(0,e.jsx)(P.$n,{size:"sm",variant:"secondary",className:Y.scanButton,onClick:sl,children:(0,e.jsx)(a.x6,{i18nKey:"explore.logs.stop-scan",children:"Stop scan"})})]})})]})]})]})},Qr=(0,k.cV)(Vr),Wr=(t,s,o)=>({noDataWrapper:(0,u.css)({display:"flex",justifyContent:"center",width:"100%",paddingBottom:t.spacing(2)}),noData:(0,u.css)({display:"inline-block"}),scanButton:(0,u.css)({marginLeft:t.spacing(1)}),logOptions:(0,u.css)({display:"flex",justifyContent:"space-between",alignItems:"baseline",flexWrap:"wrap",backgroundColor:t.colors.background.primary,padding:`${t.spacing(1)} ${t.spacing(2)}`,borderRadius:t.shape.radius.default,margin:`${t.spacing(0,0,1)}`,border:`1px solid ${t.colors.border.medium}`}),headerButton:(0,u.css)({margin:`${t.spacing(.5,0,0,1)}`}),horizontalInlineLabel:(0,u.css)({"& > label":{marginRight:"0"}}),horizontalInlineSwitch:(0,u.css)({padding:`0 ${t.spacing(1)} 0 0`}),radioButtons:(0,u.css)({margin:"0"}),logsSection:(0,u.css)({display:"flex",flexDirection:"row",justifyContent:"space-between",position:"relative"}),logsTable:(0,u.css)({maxHeight:`${o}px`}),scrollableLogRows:(0,u.css)({overflowY:"scroll",width:"100%",maxHeight:"80vh"}),logRows:(0,u.css)({overflowX:`${s?"unset":"scroll"}`,overflowY:"visible",width:"100%"}),logRowsWrapper:(0,u.css)({width:"100%"}),visualisationType:(0,u.css)({display:"flex",flex:"1",justifyContent:"space-between"}),visualisationTypeRadio:(0,u.css)({margin:`0 0 0 ${t.spacing(1)}`}),stickyNavigation:(0,u.css)({overflow:"visible",...M.$.featureToggles.logsInfiniteScrolling&&{marginBottom:"0px"}})}),zr=t=>t.some(s=>s.hasUnescapedContent),Kr=(t,s)=>{const o=(0,rs.M0)(t,s),n=o.reduce((r,i)=>i.duplicates?r+i.duplicates:r,0);return{dedupedRows:o,dedupCount:n}},Ur=t=>{if(!t||t.length===0)return;const s=t[0].timeEpochMs,o=t[t.length-1].timeEpochMs;return o<s?{from:o,to:s}:{from:s,to:o}},ds=500,us=100,Gr=t=>({logsEnter:(0,u.css)({label:"logsEnter",position:"absolute",opacity:0,height:"auto",width:"100%"}),logsEnterActive:(0,u.css)({label:"logsEnterActive",opacity:1,[t.transitions.handleMotion("no-preference","reduce")]:{transition:`opacity ${ds}ms ease-out ${us}ms`}}),logsExit:(0,u.css)({label:"logsExit",position:"absolute",opacity:1,height:"auto",width:"100%"}),logsExitActive:(0,u.css)({label:"logsExitActive",opacity:0,[t.transitions.handleMotion("no-preference","reduce")]:{transition:`opacity ${ds}ms ease-out ${us}ms`}})});function go(t){const{visible:s,children:o}=t,n=(0,d.useRef)(null),r=(0,k.of)(Gr);return(0,e.jsx)(Gs.A,{in:s,mountOnEnter:!0,unmountOnExit:!0,timeout:ds+us,classNames:{enter:r.logsEnter,enterActive:r.logsEnterActive,exit:r.logsExit,exitActive:r.logsExitActive},nodeRef:n,children:(0,e.jsx)("div",{ref:n,children:o})})}class qr extends d.PureComponent{constructor(){super(...arguments),this.state={dsInstances:{}},this.onChangeTime=s=>{const{exploreId:o,updateTimeRange:n}=this.props;n({exploreId:o,absoluteRange:s})},this.loadMoreLogs=s=>{const{exploreId:o,loadMoreLogs:n}=this.props;n({exploreId:o,absoluteRange:s})},this.getLogRowContext=async(s,o,n)=>{const{logsQueries:r}=this.props;if(!o.dataFrame.refId||!this.state.dsInstances[o.dataFrame.refId])return Promise.resolve({data:[]});const i=this.state.dsInstances[o.dataFrame.refId];if(!(0,te.Ol)(i))return Promise.resolve({data:[]});const c=this.getQuery(r,o,i);return c?i.getLogRowContext(s,n,c):Promise.resolve({data:[]})},this.getLogRowContextQuery=async(s,o,n=!0)=>{const{logsQueries:r}=this.props;if(!s.dataFrame.refId||!this.state.dsInstances[s.dataFrame.refId])return Promise.resolve(null);const i=this.state.dsInstances[s.dataFrame.refId];if(!(0,te.Ol)(i))return Promise.resolve(null);const c=this.getQuery(r,s,i);return c&&i.getLogRowContextQuery?i.getLogRowContextQuery(s,o,c,n):Promise.resolve(null)},this.getLogRowContextUi=(s,o)=>{const{logsQueries:n}=this.props;if(!s.dataFrame.refId||!this.state.dsInstances[s.dataFrame.refId])return(0,e.jsx)(e.Fragment,{});const r=this.state.dsInstances[s.dataFrame.refId];if(!(0,te.Ol)(r))return(0,e.jsx)(e.Fragment,{});const i=this.getQuery(n,s,r);return i&&(0,te.wj)(r)&&r.getLogRowContextUi?r.getLogRowContextUi(s,o,i):(0,e.jsx)(e.Fragment,{})},this.showContextToggle=s=>!s?.dataFrame.refId||!this.state.dsInstances[s.dataFrame.refId]?!1:(0,te.Ol)(this.state.dsInstances[s.dataFrame.refId]),this.getFieldLinks=(s,o,n,r)=>{const{splitOpenFn:i,range:c}=this.props;return(0,tt.QL)({field:s,rowIndex:o,splitOpenFn:i,range:c,dataFrame:n,vars:r})},this.logDetailsFilterAvailable=()=>Object.values(this.state.dsInstances).some(s=>s?.modifyQuery||(0,te._0)(s)||(0,te.FP)(s)),this.filterValueAvailable=()=>Object.values(this.state.dsInstances).some(s=>(0,te._0)(s)&&s?.getSupportedQueryModifications().includes("ADD_STRING_FILTER")),this.filterOutValueAvailable=()=>Object.values(this.state.dsInstances).some(s=>(0,te._0)(s)&&s?.getSupportedQueryModifications().includes("ADD_STRING_FILTER_OUT")),this.addResultsToCache=()=>{this.props.addResultsToCache(this.props.exploreId)},this.clearCache=()=>{this.props.clearCache(this.props.exploreId)},this.loadLogsVolumeData=()=>{this.props.loadSupplementaryQueryData(this.props.exploreId,te.cF.LogsVolume)},this.onSetLogsVolumeEnabled=s=>{this.props.setSupplementaryQueryEnabled(this.props.exploreId,s,te.cF.LogsVolume)}}componentDidMount(){this.updateDataSourceInstances()}componentDidUpdate(s){s.logsQueries!==this.props.logsQueries&&this.updateDataSourceInstances()}updateDataSourceInstances(){const{logsQueries:s,datasourceInstance:o}=this.props;if(!s||!o)return;const n={};if(o.uid!==qe.uv){s.forEach(({refId:i})=>{n[i]=o}),this.setState({dsInstances:n});return}const r=[];for(const i of s){if(!i.datasource)continue;(!n[i.refId]||n[i.refId].uid!==i.datasource.uid)&&r.push(new Promise(h=>{(0,Be.l)().get(i.datasource).then(m=>{h({ds:m,refId:i.refId})})}))}r.length&&Promise.all(r).then(i=>{i.forEach(({ds:c,refId:h})=>{n[h]=c}),this.setState({dsInstances:n})})}getQuery(s,o,n){return(s??[]).find(r=>r.refId===o.dataFrame.refId&&r.datasource!=null&&r.datasource.type===n.type)}render(){const{loading:s,loadingState:o,logRows:n,logsMeta:r,logsSeries:i,logsQueries:c,onClickFilterLabel:h,onClickFilterOutLabel:m,onStartScanning:f,onStopScanning:p,absoluteRange:g,timeZone:x,visibleRange:y,scanning:R,range:b,width:j,splitOpenFn:S,isLive:I,exploreId:L,logsVolume:v,scrollElement:w,onPinLineCallback:C}=this.props;return n?(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(go,{visible:I,children:(0,e.jsx)(wt.S,{label:(0,a.t)("explore.logs-container.label-logs","Logs"),loading:!1,isOpen:!0,children:(0,e.jsx)(Js,{exploreId:L,children:D=>(0,e.jsx)(nr,{logRows:n,timeZone:x,stopLive:D.stop,isPaused:this.props.isPaused,onPause:D.pause,onResume:D.resume,onClear:D.clear,clearedAtIndex:this.props.clearedAtIndex})})})}),(0,e.jsx)(go,{visible:!I,children:(0,e.jsx)(Qr,{exploreId:L,datasourceType:this.props.datasourceInstance?.type,logRows:n,logsMeta:r,logsSeries:i,logsVolumeEnabled:v.enabled,onSetLogsVolumeEnabled:this.onSetLogsVolumeEnabled,logsVolumeData:v.data,logsQueries:c,width:j,splitOpen:S,loading:s,loadingState:o,loadLogsVolumeData:this.loadLogsVolumeData,onChangeTime:this.onChangeTime,loadMoreLogs:this.loadMoreLogs,onClickFilterLabel:this.logDetailsFilterAvailable()?h:void 0,onClickFilterOutLabel:this.logDetailsFilterAvailable()?m:void 0,onStartScanning:f,onStopScanning:p,absoluteRange:g,visibleRange:y,timeZone:x,scanning:R,scanRange:b.raw,showContextToggle:this.showContextToggle,getRowContext:this.getLogRowContext,getRowContextQuery:this.getLogRowContextQuery,getLogRowContextUi:this.getLogRowContextUi,getFieldLinks:this.getFieldLinks,addResultsToCache:this.addResultsToCache,clearCache:this.clearCache,eventBus:this.props.eventBus,panelState:this.props.panelState,logsFrames:this.props.logsFrames,scrollElement:w,isFilterLabelActive:this.logDetailsFilterAvailable()?this.props.isFilterLabelActive:void 0,range:b,onPinLineCallback:C,onClickFilterString:this.filterValueAvailable()?this.props.onClickFilterString:void 0,onClickFilterOutString:this.filterOutValueAvailable()?this.props.onClickFilterOutString:void 0})})]}):null}}function Zr(t,{exploreId:s}){const n=t.explore.panes[s],{logsResult:r,scanning:i,datasourceInstance:c,isLive:h,isPaused:m,clearedAtIndex:f,range:p,absoluteRange:g,supplementaryQueries:x}=n,y=(0,W.h1)(s)(t),R=n.panelsState,b=(0,Ct.O)(t.user),j=x[te.cF.LogsVolume];return{loading:y,logRows:r?.rows,logsMeta:r?.meta,logsSeries:r?.series,logsQueries:r?.queries,visibleRange:r?.visibleRange,scanning:i,timeZone:b,datasourceInstance:c,isLive:h,isPaused:m,clearedAtIndex:f,range:p,absoluteRange:g,logsVolume:j,panelState:R,logsFrames:n.queryResponse.logsFrames}}const Yr={updateTimeRange:he.GH,loadMoreLogs:he.zY,addResultsToCache:W.He,clearCache:W.IL,loadSupplementaryQueryData:W.Az,setSupplementaryQueryEnabled:W.TO},Jr=(0,fe.connect)(Zr,Yr)(qr);function Xr(t){const{queryResponse:s,timeZone:o,enabled:n,setLogsSampleEnabled:r,datasourceInstance:i,queries:c,splitOpen:h}=t,m=(0,k.of)(_r),f=(0,d.useRef)(null),p=y=>{r(y),(0,A.rR)("grafana_explore_logs_sample_toggle_clicked",{datasourceType:i?.type??"unknown",type:y?"open":"close"})},g=()=>{if(!i||!(0,te.Nc)(i,te.cF.LogsSample))return null;const y=c.map(b=>i.getSupplementaryQuery({type:te.cF.LogsSample},b)).filter(b=>!!b);if(!y.length)return null;const R=()=>{h({queries:y,datasourceUid:i.uid}),(0,A.rR)("grafana_explore_logs_sample_split_button_clicked",{datasourceType:i?.type??"unknown",queriesCount:y.length})};return(0,e.jsx)(P.$n,{size:"sm",className:m.logSamplesButton,onClick:R,children:(0,e.jsx)(a.x6,{i18nKey:"explore.logs-sample-panel.open-in-split-view-button.open-logs-in-split-view",children:"Open logs in split view"})})};let x;if(s===void 0)x=null;else if(s.error!==void 0)x=(0,e.jsx)(Nt,{error:s.error,title:(0,a.t)("explore.logs-sample-panel.title-failed-sample-query","Failed to load logs sample for this query")});else if(s.state===pe.Gu.Loading)x=(0,e.jsx)("span",{children:(0,e.jsx)(a.x6,{i18nKey:"explore.logs-sample-panel.logs-sample-is-loading",children:"Logs sample is loading..."})});else if(s.data.length===0||s.data.every(y=>y.length===0))x=(0,e.jsx)("span",{children:(0,e.jsx)(a.x6,{i18nKey:"explore.logs-sample-panel.no-logs-sample-data",children:"No logs sample data."})});else{const y=(0,rs.HT)(s.data);x=M.$.featureToggles.newLogsPanel&&f.current?(0,e.jsx)(no.Z,{app:Le.Jk.Explore,containerElement:f.current,enableLogDetails:!0,dedupStrategy:oe.fY.none,displayedFields:[],logOptionsStorageKey:ee.OY,logs:y.rows,showControls:!0,showTime:re.A.getBool(ee.$Z.showTime,!0),sortOrder:re.A.get(ee.$Z.logsSortOrder)||oe.uH.Descending,timeRange:t.timeRange,timeZone:o,wrapLogMessage:re.A.getBool(ee.$Z.wrapLogMessage,!0)}):(0,e.jsx)(oo.k,{logRows:y.rows,dedupStrategy:oe.fY.none,showLabels:re.A.getBool(ee.$Z.showLabels,!1),showTime:re.A.getBool(ee.$Z.showTime,!0),wrapLogMessage:re.A.getBool(ee.$Z.wrapLogMessage,!0),prettifyLogMessage:re.A.getBool(ee.$Z.prettifyLogMessage,!1),timeZone:o,enableLogDetails:!0,scrollElement:null})}return s?.state!==pe.Gu.NotStarted?(0,e.jsxs)(wt.S,{label:(0,e.jsxs)("div",{children:[(0,e.jsx)(a.x6,{i18nKey:"explore.logs-sample-panel.label",children:"Logs sample"}),(0,e.jsx)(U.m,{content:(0,a.t)("explore.logs-sample-panel.tooltip","Show log lines that contributed to visualized metrics"),children:(0,e.jsx)(V.I,{name:"info-circle",className:m.infoTooltip})})]}),isOpen:n,collapsible:!0,onToggle:p,children:[(0,e.jsx)(g,{}),(0,e.jsx)("div",{className:m.logContainer,ref:f,children:x})]}):null}const _r=t=>({logSamplesButton:(0,u.css)({position:"absolute",top:t.spacing(1),right:t.spacing(1)}),logContainer:(0,u.css)({overflow:M.$.featureToggles.newLogsPanel?"visible":"scroll"}),infoTooltip:(0,u.css)({marginLeft:t.spacing(1)})}),ea=()=>{const t=(0,k.of)(ta);return(0,e.jsx)(e.Fragment,{children:(0,e.jsx)(Jt._,{"data-testid":"explore-no-data",className:t.wrapper,children:(0,e.jsx)("span",{className:t.message,children:"No data"})})})},ta=t=>({wrapper:(0,u.css)({label:"no-data-card",padding:t.spacing(3),background:t.colors.background.primary,borderRadius:t.shape.radius.default,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",flexGrow:1}),message:(0,u.css)({fontSize:t.typography.h2.fontSize,padding:t.spacing(4),color:t.colors.text.disabled})});var sa=l(43951);function oa(t){return(0,u.css)({maxWidth:`${t.breakpoints.values.lg}px`,marginTop:t.spacing(2),alignSelf:"center"})}const na=()=>{const t=(0,k.of)(oa),s=ns.TP.hasPermission(Ze.w.DataSourcesCreate)&&ns.TP.hasPermission(Ze.w.DataSourcesWrite),o="Explore requires at least one data source. Once you have added a data source, you can query it here.",n=(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(V.I,{name:"rocket"}),(0,e.jsx)(e.Fragment,{children:(0,e.jsxs)(a.x6,{i18nKey:"explore.no-data-source-call-to-action.footer.pro-tip-define-sources-through-configuration-files",children:[" ","ProTip: You can also define data sources through configuration files."," "]})}),(0,e.jsx)("a",{href:"http://docs.grafana.org/administration/provisioning/?utm_source=explore#data-sources",target:"_blank",rel:"noreferrer",className:"text-link",children:(0,e.jsx)(a.x6,{i18nKey:"explore.no-data-source-call-to-action.footer.learn-more",children:"Learn more"})})]}),r=(0,e.jsx)(P.z9,{size:"lg",href:"datasources/new",icon:"database",disabled:!s,children:(0,e.jsx)(a.x6,{i18nKey:"explore.no-data-source-call-to-action.cta-element.add-data-source",children:"Add data source"})});return(0,e.jsx)(sa.c,{callToActionElement:r,className:t,footer:n,message:o})};var ps=l(52908),gs=l(60519),ho=l(29147),mo=l(18209),ra=l(81753);const aa=t=>({warningText:(0,u.css)({label:"warningText",display:"flex",alignItems:"center",fontSize:t.typography.bodySmall.fontSize,color:t.colors.text.secondary})});function ia(t){const{dataFrames:s,range:o,splitOpenFn:n,withTraceView:r,datasourceType:i}=t,c=(0,tt.JQ)(o,n),h=(0,k.$j)(),m=(0,k.of)(aa),f=(0,gs.we)({fieldConfig:{defaults:{},overrides:[]},data:s,replaceVariables:C=>C,theme:h}),{nodes:p}=(0,ra.d)(f),[g,x]=(0,Ns.A)(!0),R=(p[0]?.length||0)>ho.E?mo.S.Force:mo.S.Layered,b=()=>{x(),(0,A.rR)("grafana_traces_node_graph_panel_clicked",{datasourceType:i,grafana_version:M.$.buildInfo.version,isExpanded:!g})},{height:j}=(0,ps.A)(),S=(0,d.useRef)(null),[I,L]=(0,d.useState)(250);(0,d.useEffect)(()=>{if(S.current){const{top:C}=S.current.getBoundingClientRect();L(C)}},[S]);const v=j-I-32,w=r&&p[0]?.length>1e3?(0,e.jsxs)("span",{className:m.warningText,children:[" ",(0,e.jsxs)(a.x6,{i18nKey:"explore.unconnected-node-graph-container.count-warning",values:{numNodes:p[0].length},children:["(","{{numNodes}}"," nodes, can be slow to load)"]})]}):null;return(0,e.jsx)(we.NR,{title:(0,a.t)("explore.unconnected-node-graph-container.title-node-graph","Node graph"),titleItems:w,collapsible:!!r,collapsed:r?g:!1,onToggleCollapse:r?b:void 0,children:(0,e.jsx)("div",{ref:S,style:r?{height:500}:{minHeight:600,height:v},children:(0,e.jsx)(ho.F,{dataFrames:f,getLinks:c,layoutAlgorithm:R})})})}function la(t,{exploreId:s}){return{range:t.explore.panes[s].range}}const ca=(0,fe.connect)(la,{})(ia);var ut=l(25508),da=l(28998),ua=l(65966);const pa=t=>{const s=(0,Z.qq)(t);return{getQueries:(0,ut.Mz)(s,o=>o.queries),getQueryResponse:(0,ut.Mz)(s,o=>o.queryResponse),getHistory:(0,ut.Mz)(s,o=>o.history),getEventBridge:(0,ut.Mz)(s,o=>o.eventBridge),getDatasourceInstanceSettings:(0,ut.Mz)(s,o=>(0,da.tR)().getInstanceSettings(o.datasourceInstance?.uid))}},ga=({exploreId:t})=>{const s=(0,O.wA)(),{getQueries:o,getDatasourceInstanceSettings:n,getQueryResponse:r,getHistory:i,getEventBridge:c}=(0,d.useMemo)(()=>pa(t),[t]),h=(0,O.d4)(o),m=(0,O.d4)(n),f=(0,O.d4)(r),p=(0,O.d4)(i),g=(0,O.d4)(c),x=(0,d.useCallback)(()=>{s((0,W.Od)({exploreId:t}))},[s,t]),y=(0,d.useCallback)(v=>{s((0,W.bO)({exploreId:t,queries:v}))},[s,t]),R=(0,d.useCallback)(v=>{s((0,Re.wh)({exploreId:t,datasource:v}))},[s,t]),b=(0,d.useCallback)(v=>{y([...h,{...v,refId:(0,Ps.M)(h)}])},[y,h]),j=()=>{(0,A.rR)("grafana_explore_query_row_copy")},S=()=>{(0,A.rR)("grafana_explore_query_replaced_from_library")},I=()=>{(0,A.rR)("grafana_explore_query_row_remove")},L=v=>{(0,A.rR)("grafana_query_row_toggle",v===void 0?{}:{queryEnabled:v})};return(0,e.jsx)(ua.L,{dsSettings:m,queries:h,onQueriesChange:y,onUpdateDatasources:R,onAddQuery:b,onRunQueries:x,onQueryCopied:j,onQueryRemoved:I,onQueryToggled:L,onQueryReplacedFromLibrary:S,data:f,app:Le.Jk.Explore,history:p,eventBus:g,queryRowWrapper:(v,w)=>(0,e.jsx)(ye,{title:w,icon:"arrow",panelId:"Queries",customTopOffset:-10,level:"child",children:v},w)})};var Bt=l(2863),xo=l(24343),hs=l(65642),ha=l(95943),ma=l(97222),xa=l(44720),fa=l(3642),fo=l(53593);const pt={wrapper:(0,u.css)({height:"100%",overflow:"scroll"}),switchWrapper:(0,u.css)({display:"flex",flexDirection:"row",marginBottom:0}),switchLabel:(0,u.css)({marginLeft:"15px",marginBottom:0}),switch:(0,u.css)({marginLeft:"10px"}),resultCount:(0,u.css)({marginBottom:"4px"}),header:(0,u.css)({display:"flex",justifyContent:"space-between",alignItems:"center",padding:"10px 0",fontSize:"12px",lineHeight:1.25})},ya=480,va=2,ba=t=>{const{tableResult:s}=t,o=(0,G.cloneDeep)(s),n=(0,d.useRef)(null),r=o.fields.filter(y=>y.name.includes("Value")),i=(0,fo.E)(o),{width:c}=(0,ps.A)(),[h,m]=(0,d.useState)(c<=ya||r.length>va),f=()=>{m(!h);const y={isExpanded:!h};(0,A.rR)("grafana_explore_prometheus_instant_query_ui_raw_toggle_expand",y)};(0,d.useEffect)(()=>{n.current?.resetAfterIndex(0,!0)},[h]);const p=y=>{if(y<10){let j=0;for(let S=0;S<y;S++)j+=g(S,!0);return Math.min(600,j)}return 600},g=(y,R)=>{if(!R)return 32;const S=i[y];return 1.5*32+(Object.keys(S).length-r.length)*22},x=`isExpandedView ${(0,d.useId)()}`;return(0,e.jsxs)("section",{children:[(0,e.jsxs)("header",{className:pt.header,children:[(0,e.jsx)(Oe.D,{className:pt.switchWrapper,label:(0,a.t)("explore.raw-list-container.label-expand-results","Expand results"),htmlFor:"isExpandedView",children:(0,e.jsx)("div",{className:pt.switch,children:(0,e.jsx)(Ve.d,{onChange:f,id:x,value:h,label:(0,a.t)("explore.raw-list-container.label-expand-results","Expand results")})})}),(0,e.jsx)("div",{className:pt.resultCount,children:(0,e.jsxs)(a.x6,{i18nKey:"explore.raw-list-container.item-count",values:{numItems:i.length},children:["Result series: ","{{numItems}}"]})})]}),(0,e.jsx)("div",{role:"table",children:(0,e.jsxs)(e.Fragment,{children:[r.length>1&&!h&&(0,e.jsx)(xa.d,{valueLabels:r,expanded:h}),(0,e.jsx)(ma._m,{ref:n,itemCount:i.length,className:pt.wrapper,itemSize:y=>g(y,h),height:p(i.length),width:"100%",children:({index:y,style:R})=>{let b;return h&&(b=r.filter(j=>{const S=i[y][j.name];return S&&S!==fo.M})),(0,e.jsx)("div",{role:"row",style:{...R,overflow:"hidden"},children:(0,e.jsx)(fa.Ay,{isExpandedView:h,valueLabels:b,totalNumberOfValues:r.length,listKey:i[y].__name__,listItemData:i[y]})})}})]})})]})};function Ca(t,{exploreId:s}){const n=t.explore.panes[s],{tableResult:r,rawPrometheusResult:i,range:c,queryResponse:h}=n,m=i?[i]:[],f=(r?.length??0)>0&&i?r:m;return{loading:h.state,tableResult:f,range:c}}const Sa=(0,fe.connect)(Ca,{});class ja extends d.PureComponent{constructor(s){super(s),this.onChangeResultsStyle=o=>{this.setState({resultsStyle:o})},this.renderLabel=()=>{const o=(0,u.css)({display:"flex",justifyContent:"space-between",flex:"1"}),n=_.jH.map(r=>({value:r,label:r[0].toUpperCase()+r.slice(1).replace(/_/," ")}));return(0,e.jsx)("div",{className:o,children:(0,e.jsx)(Pt.z,{onClick:()=>{const r={state:this.state.resultsStyle===_.aA.table?_.aA.raw:_.aA.table};(0,A.rR)("grafana_explore_prometheus_instant_query_ui_toggle_clicked",r)},size:"sm",options:n,value:this.state?.resultsStyle,onChange:this.onChangeResultsStyle})})},s.showRawPrometheus&&(this.state={resultsStyle:_.aA.raw})}getTableHeight(){const{tableResult:s}=this.props;return!s||s.length===0?200:Math.max(Math.min(600,s[0].length*35)+35)}render(){const{loading:s,onCellFilterAdded:o,tableResult:n,width:r,splitOpenFn:i,range:c,ariaLabel:h,timeZone:m}=this.props,f=this.getTableHeight(),p=r-hs.$W.theme.panelPadding*2-ha.IZ;let g=n;const x=(0,tt.YV)(i,c);g?.length&&(g=(0,gs.we)({data:g,timeZone:m,theme:hs.$W.theme2,replaceVariables:(0,Bt.w)().replace.bind((0,Bt.w)()),fieldConfig:{defaults:{},overrides:[]},dataLinkPostProcessor:x}));const y=g?.filter(S=>!!S&&S.length!==0),R=this.state.resultsStyle===_.aA.raw?"Raw":"Table",b=this.state?.resultsStyle!==void 0?this.renderLabel():"Table",j=!this.state?.resultsStyle||this.state?.resultsStyle===_.aA.table;return(0,e.jsxs)(we.NR,{title:R,actions:b,loadingState:s,children:[y?.length&&(0,e.jsxs)(e.Fragment,{children:[j&&(0,e.jsx)(xo.X,{ariaLabel:h,data:y[0],width:p,height:f,onCellFilterAdded:o}),this.state?.resultsStyle===_.aA.raw&&(0,e.jsx)(ba,{tableResult:y[0]})]}),!y?.length&&(0,e.jsx)(as,{metaItems:[{value:"0 series returned"}]})]})}}const Ra=Sa(ja);var Ta=l(22669);const wa=t=>{const s=(0,d.useRef)(null),o={transition:`opacity ${t.duration}ms linear`,opacity:0},n={exited:{opacity:0,display:"none"},entering:{opacity:0},entered:{opacity:1},exiting:{opacity:0}};return(0,e.jsx)(Ta.Ay,{in:t.in,timeout:t.duration,unmountOnExit:t.unmountOnExit||!1,onExited:t.onExited,nodeRef:s,children:r=>(0,e.jsx)("div",{ref:s,style:{...o,...n[r]},children:t.children})})},La=t=>{const{queryError:s}=t,o=!!s,n=o?100:10,r=s?"Query error":"Unknown error",i=s?.message||s?.data?.message||null;return(0,e.jsx)(wa,{in:o,duration:n,children:(0,e.jsx)(Je.F,{severity:"error",title:r,topSpacing:2,children:i})})};function Ia(t){const s=(0,O.d4)(n=>n.explore.panes[t.exploreId].queryResponse),o=s?.state===pe.Gu.Error?s?.error:void 0;return o?.refId?null:(0,e.jsx)(La,{queryError:o})}var ie=l(81970),yo=l(98838);const Ea=t=>({containerMargin:(0,u.css)({display:"flex",flexWrap:"wrap",gap:t.spacing(1),marginTop:t.spacing(2)})});function Fa({addQueryRowButtonDisabled:t,addQueryRowButtonHidden:s,onClickAddQueryRowButton:o,onClickQueryInspectorButton:n,onSelectQueryFromLibrary:r,queryInspectorButtonActive:i}){const c=(0,k.$j)(),h=Ea(c),m=(0,O.d4)(Z.Kl),f=(0,ie.TR)(),p=m.dsToExplore.map(y=>f.find(R=>R.uid===y.datasource?.uid)?.name).filter(y=>!!y&&y!==qe.uv),{queryLibraryEnabled:g,openDrawer:x}=(0,yo.Y)();return(0,e.jsxs)("div",{className:h.containerMargin,children:[!s&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(le.I,{variant:"canvas","aria-label":(0,a.t)("explore.secondary-actions.query-add-button-aria-label","Add query"),onClick:o,disabled:t,icon:"plus",children:(0,e.jsx)(a.x6,{i18nKey:"explore.secondary-actions.query-add-button",children:"Add query"})}),g&&(0,e.jsx)(le.I,{"data-testid":He.Tp.pages.Explore.General.addFromQueryLibrary,"aria-label":(0,a.t)("explore.secondary-actions.add-from-query-library","Add query from library"),variant:"canvas",onClick:()=>x(p,r),icon:"plus",children:(0,e.jsx)(a.x6,{i18nKey:"explore.secondary-actions.add-from-query-library",children:"Add query from library"})})]}),(0,e.jsx)(le.I,{variant:i?"active":"canvas","aria-label":(0,a.t)("explore.secondary-actions.query-inspector-button-aria-label","Query inspector"),onClick:n,icon:"info-circle",children:(0,e.jsx)(a.x6,{i18nKey:"explore.secondary-actions.query-inspector-button",children:"Query inspector"})})]})}var Da=l(95004),vo=l(32776),Oa=l(15757);const bo=20;function Aa(t,{exploreId:s}){const n=t.explore.panes[s],{tableResult:r,range:i}=n,c=(0,W.h1)(s);return{loading:r&&r.length>0?!1:c,tableResult:r,range:i}}const Pa=(0,fe.connect)(Aa,{});class Co extends d.PureComponent{constructor(){super(...arguments),this.state={showAll:!1},this.hasSubFrames=s=>s.fields.some(o=>o.type===Da.PU.nestedFrames)}getTableHeight(s,o){return s===0?200:Math.min(600,Math.max(s*36,o?300:0)+40+46)}getTableTitle(s,o,n){let r=o.name;return!r&&(s?.length??0)>1&&(r=o.refId||`${n}`),r?(0,a.t)("explore.table.title-with-name","Table - {{name}}",{name:r,interpolation:{escapeValue:!1}}):(0,a.t)("explore.table.title","Table")}showAll(){this.setState({showAll:!0})}render(){const{loading:s,onCellFilterAdded:o,tableResult:n,width:r,splitOpenFn:i,range:c,ariaLabel:h,timeZone:m,theme:f}=this.props,{showAll:p}=this.state;let g=(0,vo.gy)(n)?(0,vo.S5)(n):n;const x=(0,tt.YV)(i,c);let y=!1;g?.length&&(g=g.map(b=>(b.fields.forEach((j,S)=>{const I=p?!1:S>=bo;j.config.custom={hidden:I},y=y||I}),b)),g=(0,gs.we)({data:g,timeZone:m,theme:hs.$W.theme2,replaceVariables:(0,Bt.w)().replace.bind((0,Bt.w)()),fieldConfig:{defaults:{},overrides:[]},dataLinkPostProcessor:x}));const R=g?.filter(b=>!!b&&b.length!==0);return(0,e.jsxs)(e.Fragment,{children:[R&&R.length===0&&(0,e.jsx)(we.NR,{title:(0,a.t)("explore.table.title","Table"),width:r,height:200,children:()=>(0,e.jsx)(as,{metaItems:[{value:(0,a.t)("explore.table.no-data","0 series returned")}]})}),R&&R.length>0&&(0,e.jsx)("div",{className:(0,u.css)({display:"flex",flexDirection:"column",gap:f.spacing(1)}),children:R.map((b,j)=>(0,e.jsx)(we.NR,{title:this.getTableTitle(g,b,j),titleItems:[!p&&y&&(0,e.jsx)(Oa.m,{toggleShowAllSeries:()=>this.showAll(),info:(0,e.jsxs)(a.x6,{i18nKey:"table.container.show-only-series",children:["Showing only ",{MAX_NUMBER_OF_COLUMNS:bo}," columns"]}),tooltip:(0,a.t)("table.container.content","Showing too many columns in a single table may impact performance and make data harder to read. Consider refining your queries."),buttonLabel:(0,e.jsx)(a.x6,{i18nKey:"table.container.show-all-series",children:"Show all columns"})})],width:r,height:this.getTableHeight(b.length,this.hasSubFrames(b)),loadingState:s?pe.Gu.Loading:void 0,children:(S,I)=>(0,e.jsx)(xo.X,{ariaLabel:h,data:b,width:S,height:I,onCellFilterAdded:o})},b.refId||`table-${j}`))})]})}}const xl=(0,k.cV)(Co),ka=(0,k.cV)(Pa(Co));var Na=l(38138),Ma=l(23398);function Ha(t){const s=t.dataFrames[0],{dataFrames:o,splitOpenFn:n,exploreId:r,scrollElement:i,timeRange:c}=t,h=(0,d.useMemo)(()=>(0,Ma.L)(s),[s]),m=(0,O.d4)(f=>f.explore.panes[t.exploreId]?.datasourceInstance??void 0);return h?(0,e.jsx)(we.NR,{padding:"none",title:(0,a.t)("explore.trace-view-container.title-trace","Trace"),children:(0,e.jsx)(Na.V,{exploreId:r,dataFrames:o,splitOpenFn:n,scrollElement:i,traceProp:h,datasource:m,timeRange:c})}):null}const Ba=t=>({exploreMain:(0,u.css)({label:"exploreMain",position:"relative",marginTop:"21px",display:"flex",flexDirection:"column",gap:t.spacing(1)}),queryContainer:(0,u.css)({label:"queryContainer",padding:t.spacing(1)}),exploreContainer:(0,u.css)({label:"exploreContainer",display:"flex",flexDirection:"column",paddingRight:t.spacing(2),marginBottom:t.spacing(2)}),wrapper:(0,u.css)({position:"absolute",top:0,left:t.spacing(2),right:0,bottom:0,display:"flex"})});class $a extends d.PureComponent{constructor(s){super(s),this.onChangeTime=o=>{const{updateTimeRange:n,exploreId:r}=this.props;n({exploreId:r,rawRange:o})},this.onClickExample=o=>{this.props.setQueries(this.props.exploreId,[o])},this.onCellFilterAdded=o=>{const{value:n,key:r,operator:i}=o;i===ks.mc&&this.onClickFilterLabel(r,n),i===ks.Zi&&this.onClickFilterOutLabel(r,n)},this.onContentOutlineToogle=()=>{Ye.M.set(St.visible,!this.state.contentOutlineVisible),this.setState(o=>((0,A.rR)("explore_toolbar_contentoutline_clicked",{item:"outline",type:o.contentOutlineVisible?"close":"open"}),{contentOutlineVisible:!o.contentOutlineVisible}))},this.isFilterLabelActive=async(o,n,r)=>{const i=this.props.queries.find(h=>h.refId===r);if(!i)return!1;const c=await(0,Be.l)().get(i.datasource);return!!((0,te.FP)(c)&&c.queryHasFilter(i,{key:o,value:n.toString()}))},this.onClickFilterLabel=(o,n,r)=>{this.onModifyQueries({type:"ADD_FILTER",options:{key:o,value:n.toString()},frame:r},r?.refId)},this.onClickFilterOutLabel=(o,n,r)=>{this.onModifyQueries({type:"ADD_FILTER_OUT",options:{key:o,value:n.toString()},frame:r},r?.refId)},this.onClickFilterString=(o,n)=>{this.onModifyQueries({type:"ADD_STRING_FILTER",options:{value:o.toString()}},n)},this.onClickFilterOutString=(o,n)=>{this.onModifyQueries({type:"ADD_STRING_FILTER_OUT",options:{value:o.toString()}},n)},this.onClickAddQueryRowButton=()=>{const{exploreId:o,queryKeys:n}=this.props;this.props.addQueryRow(o,n.length)},this.onModifyQueries=(o,n)=>{const r=async(i,c)=>{if(n&&n!==i.refId)return i;const{datasource:h}=i;if(h==null)return i;const m=await(0,Be.l)().get(h),f=["ADD_FILTER","ADD_FILTER_OUT"];return(0,te.FP)(m)&&f.includes(c.type)?m.toggleQueryFilter(i,{type:c.type==="ADD_FILTER"?"FILTER_FOR":"FILTER_OUT",options:c.options??{},frame:c.frame}):m.modifyQuery?m.modifyQuery(i,c):i};this.props.modifyQueries(this.props.exploreId,o,r)},this.onResize=o=>{this.props.changeSize(this.props.exploreId,o)},this.onStartScanning=()=>{this.props.scanStart(this.props.exploreId)},this.onStopScanning=()=>{this.props.scanStopAction({exploreId:this.props.exploreId})},this.onUpdateTimeRange=o=>{const{exploreId:n,updateTimeRange:r}=this.props;r({exploreId:n,absoluteRange:o})},this.onSplitOpen=o=>async n=>{if(this.props.splitOpen(n),n&&this.props.datasourceInstance){const r=(await(0,Be.l)().get(n.datasourceUid)).type,i=this.props.datasourceInstance.uid===qe.uv?(0,G.get)(this.props.queries,"0.datasource.type"):this.props.datasourceInstance.type,c={origin:"panel",panelType:o,source:i,target:r,exploreId:this.props.exploreId};(0,A.rR)("grafana_explore_split_view_opened",c)}},this.onPinLineCallback=()=>{this.setState({contentOutlineVisible:!0})},this.splitOpenFnLogs=this.onSplitOpen("logs"),this.state={contentOutlineVisible:Ye.M.getBool(St.visible,!0)},this.graphEventBus=s.eventBus.newScopedBus("graph",{onlyLocal:!1}),this.logsEventBus=s.eventBus.newScopedBus("logs",{onlyLocal:!1})}renderEmptyState(s){return(0,e.jsx)("div",{className:(0,u.cx)(s),children:(0,e.jsx)(na,{})})}renderNoData(){return(0,e.jsx)(ea,{})}renderCustom(s){const{timeZone:o,queryResponse:n,eventBus:r}=this.props,i=(0,G.groupBy)(n?.customFrames,"meta.preferredVisualisationPluginId");return Object.entries(i).map(([c,h],m)=>(0,e.jsx)(ye,{panelId:c,title:c,icon:"plug",children:(0,e.jsx)(jn,{timeZone:o,pluginId:c,frames:h,state:n.state,timeRange:n.timeRange,height:400,width:s,splitOpenFn:this.onSplitOpen(c),eventBus:r},m)},m))}renderGraphPanel(s){const{graphResult:o,timeZone:n,queryResponse:r,showFlameGraph:i}=this.props;return(0,e.jsx)(ye,{panelId:"Graph",title:(0,a.t)("explore.explore.title-graph","Graph"),icon:"graph-bar",children:(0,e.jsx)(Zn.y,{data:o,height:i?180:400,width:s,timeRange:r.timeRange,timeZone:n,onChangeTime:this.onUpdateTimeRange,annotations:r.annotations,splitOpenFn:this.onSplitOpen("graph"),loadingState:r.state,eventBus:this.graphEventBus})})}renderTablePanel(s){const{exploreId:o,timeZone:n}=this.props;return(0,e.jsx)(ye,{panelId:"Table",title:(0,a.t)("explore.explore.title-table","Table"),icon:"table",children:(0,e.jsx)(ka,{ariaLabel:He.Tp.pages.Explore.General.table,width:s,exploreId:o,onCellFilterAdded:this.onCellFilterAdded,timeZone:n,splitOpenFn:this.onSplitOpen("table")})})}renderRawPrometheus(s){const{exploreId:o,datasourceInstance:n,timeZone:r}=this.props;return(0,e.jsx)(ye,{panelId:"Raw Prometheus",title:(0,a.t)("explore.explore.title-raw-prometheus","Raw Prometheus"),icon:"gf-prometheus",children:(0,e.jsx)(Ra,{showRawPrometheus:!0,ariaLabel:He.Tp.pages.Explore.General.table,width:s,exploreId:o,onCellFilterAdded:n?.modifyQuery?this.onCellFilterAdded:void 0,timeZone:r,splitOpenFn:this.onSplitOpen("table")})})}renderLogsPanel(s){const{exploreId:o,syncedTimes:n,theme:r,queryResponse:i}=this.props,c=parseInt(r.spacing(2).slice(0,-2),10),h=(0,u.css)({display:"flex",flexDirection:"column",gap:r.spacing(1)});return(0,e.jsx)(ye,{panelId:"Logs",title:(0,a.t)("explore.explore.title-logs","Logs"),icon:"gf-logs",className:h,children:(0,e.jsx)(Jr,{exploreId:o,loadingState:i.state,syncedTimes:n,width:s-c,onClickFilterLabel:this.onClickFilterLabel,onClickFilterOutLabel:this.onClickFilterOutLabel,onStartScanning:this.onStartScanning,onStopScanning:this.onStopScanning,eventBus:this.logsEventBus,splitOpenFn:this.splitOpenFnLogs,scrollElement:this.scrollElement,isFilterLabelActive:this.isFilterLabelActive,onClickFilterString:this.onClickFilterString,onClickFilterOutString:this.onClickFilterOutString,onPinLineCallback:this.onPinLineCallback})})}renderLogsSamplePanel(){const{logsSample:s,timeZone:o,setSupplementaryQueryEnabled:n,exploreId:r,datasourceInstance:i,queries:c,queryResponse:h}=this.props;return(0,e.jsx)(ye,{panelId:"Logs Sample",title:(0,a.t)("explore.explore.title-logs-sample","Logs sample"),icon:"gf-logs",children:(0,e.jsx)(Xr,{queryResponse:s.data,timeZone:o,enabled:s.enabled,queries:c,datasourceInstance:i,splitOpen:this.onSplitOpen("logsSample"),setLogsSampleEnabled:m=>n(r,m,te.cF.LogsSample),timeRange:h.timeRange})})}renderNodeGraphPanel(){const{exploreId:s,showTrace:o,queryResponse:n,datasourceInstance:r}=this.props,i=r?r?.type:"unknown";return(0,e.jsx)(ye,{panelId:"Node Graph",title:(0,a.t)("explore.explore.title-node-graph","Node graph"),icon:"code-branch",children:(0,e.jsx)(ca,{dataFrames:n.nodeGraphFrames,exploreId:s,withTraceView:o,datasourceType:i,splitOpenFn:this.onSplitOpen("nodeGraph")})})}renderFlameGraphPanel(){const{queryResponse:s}=this.props;return(0,e.jsx)(ye,{panelId:"Flame Graph",title:(0,a.t)("explore.explore.title-flame-graph","Flame graph"),icon:"fire",children:(0,e.jsx)(Gn,{dataFrames:s.flameGraphFrames})})}renderTraceViewPanel(){const{queryResponse:s,exploreId:o}=this.props,n=s.series.filter(r=>r.meta?.preferredVisualisationType==="trace");return n.length&&(0,e.jsx)(ye,{panelId:"Traces",title:(0,a.t)("explore.explore.title-traces","Traces"),icon:"file-alt",children:(0,e.jsx)(Ha,{exploreId:o,dataFrames:n,splitOpenFn:this.onSplitOpen("traceView"),scrollElement:this.scrollElement,timeRange:s.timeRange})})}render(){const{datasourceInstance:s,exploreId:o,graphResult:n,queryResponse:r,isLive:i,theme:c,showMetrics:h,showTable:m,showRawPrometheus:f,showLogs:p,showTrace:g,showCustom:x,showNodeGraph:y,showFlameGraph:R,showLogsSample:b,correlationEditorDetails:j,correlationEditorHelperData:S,showQueryInspector:I,setShowQueryInspector:L}=this.props,{contentOutlineVisible:v}=this.state,w=Ba(c),C=r&&r.state!==pe.Gu.NotStarted,D=!(0,lt.gQ)().queryHistoryAvailable,H=r.state===pe.Gu.Done&&[r.logsFrames,r.graphFrames,r.nodeGraphFrames,r.flameGraphFrames,r.tableFrames,r.rawPrometheusFrames,r.traceFrames,r.customFrames].every(K=>K.length===0);let N;const $=j?.editorMode;return!!($||j?.correlationDirty)&&S!==void 0&&(N=(0,e.jsx)(fn,{exploreId:o,correlations:S})),(0,e.jsxs)(rn,{refreshDependencies:this.props.queries,children:[(0,e.jsx)(Kn,{exploreId:o,onChangeTime:this.onChangeTime,onContentOutlineToogle:this.onContentOutlineToogle,isContentOutlineOpen:v}),(0,e.jsx)("div",{style:{position:"relative",height:"100%",paddingLeft:c.spacing(2)},children:(0,e.jsxs)("div",{className:w.wrapper,children:[v&&(0,e.jsx)(cn,{scroller:this.scrollElement,panelId:`content-outline-container-${o}`}),(0,e.jsx)(Yt.P,{"data-testid":He.Tp.pages.Explore.General.scrollView,ref:K=>this.scrollElement=K||void 0,children:(0,e.jsx)("div",{className:w.exploreContainer,children:s?(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(ye,{panelId:"Queries",title:(0,a.t)("explore.explore.title-queries","Queries"),icon:"arrow",mergeSingleChild:!0,children:(0,e.jsxs)(Jt._,{className:w.queryContainer,children:[(0,e.jsx)(Tn,{datasourceType:s?.type||""}),N,(0,e.jsx)(ga,{exploreId:o}),(0,e.jsx)(Fa,{addQueryRowButtonDisabled:i||$&&s.meta.mixed,addQueryRowButtonHidden:!1,richHistoryRowButtonHidden:D,queryInspectorButtonActive:I,onClickAddQueryRowButton:this.onClickAddQueryRowButton,onClickQueryInspectorButton:()=>L(!I),onSelectQueryFromLibrary:async K=>{const{changeDatasource:z,queries:X,setQueries:ne}=this.props,ce=[...X,{...K,refId:(0,Ps.M)(X)}];if(ne(o,ce),K.datasource?.uid){const Ce={uid:new Set(ce.map(Q=>Q.datasource?.uid)).size>1?qe.uv:K.datasource.uid};s.uid!==Ce.uid&&await z({exploreId:o,datasource:Ce})}}}),(0,e.jsx)(Ia,{exploreId:o})]})}),(0,e.jsx)(tn.Ay,{onResize:this.onResize,disableHeight:!0,children:({width:K})=>K===0?null:(0,e.jsx)("main",{className:(0,u.cx)(w.exploreMain),style:{width:K},children:(0,e.jsx)(se.Xw,{children:C&&(0,e.jsxs)(e.Fragment,{children:[h&&n&&(0,e.jsx)(se.Xw,{children:this.renderGraphPanel(K)}),f&&(0,e.jsx)(se.Xw,{children:this.renderRawPrometheus(K)}),m&&(0,e.jsx)(se.Xw,{children:this.renderTablePanel(K)}),p&&(0,e.jsx)(se.Xw,{children:this.renderLogsPanel(K)}),y&&(0,e.jsx)(se.Xw,{children:this.renderNodeGraphPanel()}),R&&(0,e.jsx)(se.Xw,{children:this.renderFlameGraphPanel()}),g&&(0,e.jsx)(se.Xw,{children:this.renderTraceViewPanel()}),b&&(0,e.jsx)(se.Xw,{children:this.renderLogsSamplePanel()}),x&&(0,e.jsx)(se.Xw,{children:this.renderCustom(K)}),H&&(0,e.jsx)(se.Xw,{children:this.renderNoData()})]})})})})]}):this.renderEmptyState(w.exploreContainer)})})]})})]})}}function Va(t,{exploreId:s}){const o=t.explore,{syncedTimes:n}=o,r=o.panes[s],i=(0,Ct.O)(t.user),{datasourceInstance:c,queryKeys:h,queries:m,isLive:f,graphResult:p,tableResult:g,logsResult:x,showLogs:y,showMetrics:R,showTable:b,showTrace:j,showCustom:S,queryResponse:I,showNodeGraph:L,showFlameGraph:v,showRawPrometheus:w,supplementaryQueries:C,correlationEditorHelperData:D}=r,H=(0,W.h1)(s)(t),N=C[te.cF.LogsSample],$=!!(N.dataProvider!==void 0&&!x&&(p||g));return{datasourceInstance:c,queryKeys:h,queries:m,isLive:f,graphResult:p,logsResult:x??void 0,queryResponse:I,syncedTimes:n,timeZone:i,showLogs:y,showMetrics:R,showTable:b,showTrace:j,showCustom:S,showNodeGraph:L,showRawPrometheus:w,showFlameGraph:v,splitted:(0,Z.pF)(t),loading:H,logsSample:N,showLogsSample:$,correlationEditorHelperData:D,correlationEditorDetails:o.correlationEditorDetails,exploreActiveDS:(0,Z.Kl)(t)}}const Qa={changeDatasource:Re.wh,changeSize:Te.QZ,modifyQueries:W.PD,scanStart:W.GI,scanStopAction:W.q9,setQueries:W.Rk,updateTimeRange:he.GH,addQueryRow:W._0,splitOpen:q.ve,setSupplementaryQueryEnabled:W.TO},Wa=(0,fe.connect)(Va,Qa),za=(0,k.cV)(Wa($a));var So=l(64467),Ka=l(42836),Ua=l(80307),Ga=l(82049),qa=l(55072),Za=l(96065);function Ya(t){const{onClose:s,queryResponse:o,timeZone:n,isMixed:r,exploreId:i}=t,[c,h]=(0,d.useState)({withTransforms:!1,withFieldConfig:!0}),m=o?.series||[];let f=o?.errors;!f?.length&&o?.error&&(f=[o.error]);const p=(0,k.of)(_a);(0,d.useEffect)(()=>{(0,A.rR)("grafana_explore_query_inspector_opened")},[]);const g={label:(0,a.t)("explore.explore-query-inspector.stats-tab.label.stats","Stats"),value:"stats",icon:"chart-line",content:(0,e.jsx)(qa.N,{data:o,timeZone:o?.request?.timezone??oe.vp})},x={label:(0,a.t)("explore.explore-query-inspector.json-tab.label.json","JSON"),value:"json",icon:"brackets-curly",content:(0,e.jsx)(Ga.w,{data:o,onClose:s})},y={label:(0,a.t)("explore.explore-query-inspector.data-tab.label.data","Data"),value:"data",icon:"database",content:(0,e.jsx)(Ka.q,{data:m,dataName:"Explore",isLoading:o.state===pe.Gu.Loading,options:c,timeZone:n,app:Le.Jk.Explore,formattedDataDescription:"Matches the format in the panel",onOptionsChange:h})},R={label:(0,a.t)("explore.explore-query-inspector.query-tab.label.query","Query"),value:"query",icon:"info-circle",content:(0,e.jsx)("div",{className:p.queryInspectorWrapper,children:(0,e.jsx)(Za.e,{instanceId:r?(0,qe.qM)(0,(0,it.uq)(i)):(0,it.uq)(i),data:o,onRefreshQuery:()=>t.runQueries({exploreId:i})})})},b=[g,R,x,y];if(f?.length){const j={label:(0,a.t)("explore.explore-query-inspector.error-tab.label.error","Error"),value:"error",icon:"exclamation-triangle",content:(0,e.jsx)(Ua.y,{errors:f})};b.push(j)}return(0,e.jsx)(Os,{children:(0,e.jsx)(So.q,{tabs:b,onClose:s,closeIconTooltip:"Close query inspector"})})}function Ja(t,{exploreId:s}){const n=t.explore.panes[s],{queryResponse:r}=n;return{queryResponse:r,isMixed:n.datasourceInstance?.meta.mixed||!1}}const Xa={runQueries:W.Od},_a=t=>({queryInspectorWrapper:(0,u.css)({paddingBottom:t.spacing(3)})}),ei=(0,fe.connect)(Ja,Xa)(Ya),ti=(0,u.css)({label:"explorePaneContainer",display:"flex",flexDirection:"column",minWidth:"600px",height:"100%"});function si({exploreId:t}){ri(t);const s=(0,d.useRef)(new en.o),o=(0,d.useRef)(null),[n,r]=(0,d.useState)(!1);return(0,d.useEffect)(()=>{const i=s.current;return()=>i.removeAllListeners()},[]),(0,e.jsxs)("div",{className:ti,ref:o,"data-testid":He.Tp.pages.Explore.General.container,children:[(0,e.jsx)(za,{exploreId:t,eventBus:s.current,showQueryInspector:n,setShowQueryInspector:r}),n&&(0,e.jsx)(ei,{exploreId:t,onClose:()=>r(!1),timeZone:(0,As.O)()})]})}function oi(t,s){return{pane:t.explore.panes[s.exploreId]}}const ni=(0,fe.connect)(oi)(si);function ri(t){const s=(0,d.useMemo)(()=>(0,Z.qq)(t),[t]),o=(0,d.useRef)();o.current=(0,O.d4)(s),(0,d.useEffect)(()=>()=>{(0,it._u)(o.current?.querySubscription)},[])}var be=l(11280),ai=l(21103),jo=l(12737),Qe=l(75234),ii=l(87105),ms=l(6890),xs=l(64762),We=l(87745),li=l(19729);const ci={setQueries:W.Rk,changeDatasource:Re.wh},di=(0,fe.connect)(void 0,ci);function ui({rootDatasourceUid:t,queries:s,disabled:o=!1,onClick:n,changeDatasource:r,setQueries:i}){const[c,h]=(0,d.useState)(!1),m=(0,O.d4)(Z.pF),f=(0,O.d4)(Z.Kl),p=(0,O.d4)(Z.K6),g=(b,j)=>!f.dsToExplore.find(S=>S.datasource.uid===b)?.exploreIds.includes(j),x=(b,j)=>j!==void 0&&b!==void 0&&g(j,b)?{fallbackText:"Switch data source and run query",translation:(0,a.t)("explore.run-query.switch-datasource-button","Switch data source and run query")}:{fallbackText:"Run query",translation:(0,a.t)("explore.run-query.run-query-button","Run query")},y=async b=>{const j=g(t,b);j&&await r({exploreId:b,datasource:t}),i(b,s),(0,A.rR)("grafana_explore_query_history_run",{queryHistoryEnabled:M.$.queryHistoryEnabled,differentDataSource:j})},R=()=>{const b=o||s.length===0||t===void 0;if(m){const j=(0,e.jsx)(Ae.W,{children:p.map((S,I)=>{const L=x(S[0],t),v=I===0?(0,a.t)("explore.run-query.left-pane","Left pane"):(0,a.t)("explore.run-query.right-pane","Right pane");return(0,e.jsx)(Ae.W.Item,{ariaLabel:L.fallbackText,onClick:()=>{y(S[0]),n?.()},label:`${v}: ${L.translation}`,disabled:b||S[0]===void 0},I)})});return(0,e.jsx)(ct.m,{onVisibleChange:S=>h(S),placement:"bottom-start",overlay:j,children:(0,e.jsx)(le.I,{"aria-label":(0,a.t)("explore.explore-run-query-button.run-button.aria-label-run-query-options","Run query options"),variant:"canvas",isOpen:c,children:(0,a.t)("explore.run-query.run-query-button","Run query")})})}else{const j=f.exploreToDS[0]?.exploreId,S=x(j,t);return(0,e.jsx)(P.$n,{variant:"primary","aria-label":S.translation,onClick:()=>{y(j),n?.()},disabled:b||j===void 0,children:S.translation})}};return(0,e.jsx)(e.Fragment,{children:R()})}const pi=di(ui),gi=({query:t})=>{const[s,o]=(0,d.useState)(!1),{openAddQueryModal:n,queryLibraryEnabled:r}=(0,yo.Y)(),i=(0,a.t)("explore.rich-history-card.add-to-library","Add to library");return r&&!s?(0,e.jsx)(e.Fragment,{children:(0,e.jsx)(P.$n,{variant:"secondary","aria-label":i,onClick:()=>{n(t,{onSave:()=>o(!0),context:"richHistory"})},children:i})}):void 0},hi={changeDatasource:Re.wh,deleteHistoryItem:be.VM,commentHistoryItem:be.H9,starHistoryItem:be.sh,setQueries:W.Rk},mi=(0,fe.connect)(void 0,hi),xi=t=>{const s="240px",o="170px",n=t.colors.background.secondary;return{queryCard:(0,u.css)({position:"relative",display:"flex",flexDirection:"column",border:`1px solid ${t.colors.border.weak}`,margin:t.spacing(1,0),backgroundColor:n,borderRadius:t.shape.radius.default,".starred":{color:t.v1.palette.orange}}),cardRow:(0,u.css)({display:"flex",alignItems:"center",justifyContent:"space-between",padding:t.spacing(1),borderBottom:"none",":first-of-type":{borderBottom:`1px solid ${t.colors.border.weak}`,padding:t.spacing(.5,1)},img:{height:`${t.typography.fontSize}px`,maxWidth:`${t.typography.fontSize}px`,marginRight:t.spacing(1)}}),queryActionButtons:(0,u.css)({maxWidth:o,display:"flex",justifyContent:"flex-end",fontSize:t.typography.size.base,button:{marginLeft:t.spacing(1)}}),queryContainer:(0,u.css)({fontWeight:t.typography.fontWeightMedium,width:`calc(100% - ${s})`}),updateCommentContainer:(0,u.css)({width:`calc(100% + ${s})`,marginTop:t.spacing(1)}),comment:(0,u.css)({overflowWrap:"break-word",fontSize:t.typography.bodySmall.fontSize,fontWeight:t.typography.fontWeightRegular,marginTop:t.spacing(.5)}),commentButtonRow:(0,u.css)({"> *":{marginTop:t.spacing(1),marginRight:t.spacing(1)}}),textArea:(0,u.css)({width:"100%"}),runButton:(0,u.css)({maxWidth:o,display:"flex",justifyContent:"flex-end",button:{height:"auto",padding:t.spacing(.5,2),lineHeight:1.4,span:{whiteSpace:"normal !important"}}}),loader:(0,u.css)({position:"absolute",width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:t.colors.background.secondary})}};function fi(t){const{queryHistoryItem:s,commentHistoryItem:o,starHistoryItem:n,deleteHistoryItem:r,datasourceInstances:i}=t,[c,h]=(0,d.useState)(!1),[m,f]=(0,d.useState)(s.comment),p=(0,k.of)(xi),g=i?i.find(C=>C.uid===s.datasourceUid):void 0,x=async()=>{const C=[...s.queries.map(H=>H.datasource?.type||"unknown")];(0,A.rR)("grafana_explore_query_history_copy_query",{datasources:C,mixed:!!g?.meta.mixed});const D=s.queries.map(H=>{let N=i?.find($=>$.uid===s.datasourceUid);return N?.meta.mixed&&(N=i?.find($=>$.uid===H.datasource?.uid)),(0,ie.Ax)(H,N)}).join(`
`);(0,it.uJ)(D),(0,dt.JD)((0,ms.dx)((0,xs.tZ)((0,a.t)("explore.rich-history-notification.query-copied","Query copied to clipboard"))))},y=async()=>{const C=(0,ie.U3)(s);await(0,Dt.VP)(C)},R=()=>{const C=D=>{r(D),(0,dt.JD)((0,ms.dx)((0,xs.tZ)((0,a.t)("explore.rich-history-notification.query-deleted","Query deleted")))),(0,A.rR)("grafana_explore_query_history_deleted",{queryHistoryEnabled:M.$.queryHistoryEnabled})};s.starred?(0,Qe.J7)().publish(new We.bY({title:(0,a.t)("explore.rich-history-card.delete-query-confirmation-title","Delete"),text:(0,a.t)("explore.rich-history-card.delete-starred-query-confirmation-text","Are you sure you want to permanently delete your starred query?"),yesText:(0,a.t)("explore.rich-history-card.confirm-delete","Delete"),icon:"trash-alt",onConfirm:()=>C(s.id)})):C(s.id)},b=()=>{n(s.id,!s.starred),(0,A.rR)("grafana_explore_query_history_starred",{queryHistoryEnabled:M.$.queryHistoryEnabled,newValue:!s.starred})},j=()=>h(!c),S=()=>{o(s.id,m),h(!1),(0,A.rR)("grafana_explore_query_history_commented",{queryHistoryEnabled:M.$.queryHistoryEnabled})},I=()=>{h(!1),f(s.comment)},L=C=>{C.key==="Enter"&&(C.shiftKey||C.ctrlKey)&&S(),C.key==="Escape"&&I()},v=(0,e.jsxs)("div",{className:p.updateCommentContainer,"aria-label":m?(0,a.t)("explore.rich-history-card.update-comment-form","Update comment form"):(0,a.t)("explore.rich-history-card.add-comment-form","Add comment form"),children:[(0,e.jsx)(ii.f,{onKeyDown:L,value:m,placeholder:m?void 0:(0,a.t)("explore.rich-history-card.optional-description","An optional description of what the query does."),onChange:C=>f(C.currentTarget.value),className:p.textArea}),(0,e.jsxs)("div",{className:p.commentButtonRow,children:[(0,e.jsx)(P.$n,{onClick:S,children:(0,e.jsx)(a.x6,{i18nKey:"explore.rich-history-card.save-comment",children:"Save comment"})}),(0,e.jsx)(P.$n,{variant:"secondary",onClick:I,children:(0,e.jsx)(a.x6,{i18nKey:"explore.rich-history-card.cancel",children:"Cancel"})})]})]}),w=(0,e.jsxs)("div",{className:p.queryActionButtons,children:[(0,e.jsx)(Xe.K,{name:"comment-alt",onClick:j,tooltip:s.comment?.length>0?(0,a.t)("explore.rich-history-card.edit-comment-tooltip","Edit comment"):(0,a.t)("explore.rich-history-card.add-comment-tooltip","Add comment")}),(0,e.jsx)(Xe.K,{name:"copy",onClick:x,tooltip:(0,a.t)("explore.rich-history-card.copy-query-tooltip","Copy query to clipboard")}),g&&(0,e.jsx)(Xe.K,{name:"share-alt",onClick:y,tooltip:(0,e.jsx)(a.x6,{i18nKey:"explore.rich-history-card.copy-shortened-link-tooltip",children:"Copy shortened link to clipboard"})}),(0,e.jsx)(Xe.K,{name:"trash-alt",title:(0,a.t)("explore.rich-history-card.delete-query-title","Delete query"),tooltip:(0,a.t)("explore.rich-history-card.delete-query-tooltip","Delete query"),onClick:R}),(0,e.jsx)(Xe.K,{name:s.starred?"favorite":"star",iconType:s.starred?"mono":"default",onClick:b,tooltip:s.starred?(0,a.t)("explore.rich-history-card.unstar-query-tooltip","Unstar query"):(0,a.t)("explore.rich-history-card.star-query-tooltip","Star query")})]});return(0,e.jsxs)("div",{className:p.queryCard,children:[(0,e.jsxs)("div",{className:p.cardRow,children:[(0,e.jsx)(Ro,{dsApi:g,size:"sm"}),w]}),(0,e.jsxs)("div",{className:(0,u.cx)(p.cardRow),children:[(0,e.jsxs)("div",{className:p.queryContainer,children:[s?.queries.map((C,D)=>{const H=i?.find(N=>N.uid===C.datasource?.uid);return(0,e.jsx)(vi,{query:{query:C,datasource:H},showDsInfo:g?.meta.mixed},`${C}-${D}`)}),!c&&s.comment&&(0,e.jsx)("div",{"aria-label":(0,a.t)("explore.rich-history-card.query-comment-label","Query comment"),className:p.comment,children:s.comment}),c&&v]}),!c&&(0,e.jsx)(gi,{query:s?.queries[0]}),!c&&(0,e.jsx)("div",{className:p.runButton,children:(0,e.jsx)(pi,{queries:s.queries,rootDatasourceUid:g?.uid})})]})]})}const yi=t=>({queryRow:(0,u.css)({borderTop:`1px solid ${t.colors.border.weak}`,display:"flex",flexDirection:"row",padding:t.spacing(.5,0),gap:t.spacing(.5),":first-child":{borderTop:"none"}}),dsInfoContainer:(0,u.css)({display:"flex",alignItems:"center"}),queryText:(0,u.css)({wordBreak:"break-all"})}),vi=({query:t,showDsInfo:s=!1})=>{const o=(0,k.of)(yi);return(0,e.jsxs)("div",{className:o.queryRow,children:[s&&(0,e.jsxs)("div",{className:o.dsInfoContainer,children:[(0,e.jsx)(Ro,{dsApi:t.datasource,size:"md"}),": "]}),(0,e.jsx)("span",{"aria-label":(0,a.t)("explore.rich-history-card.query-text-label","Query text"),className:o.queryText,children:(0,ie.Ax)(t.query,t.datasource)})]})},bi=t=>s=>(0,u.css)({display:"flex",alignItems:"center",fontSize:s.typography[t==="sm"?"bodySmall":"body"].fontSize,fontWeight:s.typography.fontWeightMedium,whiteSpace:"nowrap"});function Ro({dsApi:t,size:s}){const o=(0,d.useCallback)(r=>bi(s)(r),[s]),n=(0,k.of)(o);return(0,e.jsxs)("div",{className:n,children:[(0,e.jsx)("img",{src:t?.meta.info.logos.small||li,alt:t?.type||(0,a.t)("explore.rich-history-card.datasource-not-exist","Data source does not exist anymore"),"aria-label":(0,a.t)("explore.rich-history-card.datasource-icon-label","Data source icon")}),(0,e.jsx)("div",{"aria-label":(0,a.t)("explore.rich-history-card.datasource-name-label","Data source name"),children:t?.name||(0,a.t)("explore.rich-history-card.datasource-not-exist","Data source does not exist anymore")})]})}const To=mi(fi),Ci=(t,s)=>({container:(0,u.css)({display:"flex"}),labelSlider:(0,u.css)({fontSize:t.typography.bodySmall.fontSize,"&:last-of-type":{marginTop:t.spacing(3)},"&:first-of-type":{fontWeight:t.typography.fontWeightMedium,marginBottom:t.spacing(2)}}),containerContent:(0,u.css)({width:"calc(100% - 134px)"}),containerSlider:(0,u.css)({width:"129px",marginRight:t.spacing(1)}),fixedSlider:(0,u.css)({position:"fixed"}),slider:(0,u.css)({bottom:"10px",height:`${s-180}px`,width:"129px",padding:t.spacing(1,0)}),selectors:(0,u.css)({display:"flex",justifyContent:"space-between",flexWrap:"wrap"}),filterInput:(0,u.css)({marginBottom:t.spacing(1)}),multiselect:(0,u.css)({width:"100%",marginBottom:t.spacing(1)}),sort:(0,u.css)({width:"170px"}),sessionName:(0,u.css)({display:"flex",alignItems:"flex-start",justifyContent:"flex-start",marginTop:t.spacing(3),h4:{margin:"0 10px 0 0"}}),heading:(0,u.css)({fontSize:t.typography.h4.fontSize,margin:t.spacing(2,.25,1,.25)}),footer:(0,u.css)({height:"60px",display:"flex",justifyContent:"center",alignItems:"center",fontWeight:t.typography.fontWeightLight,fontSize:t.typography.bodySmall.fontSize,a:{fontWeight:t.typography.fontWeightMedium,marginLeft:t.spacing(.25)}}),queries:(0,u.css)({fontSize:t.typography.bodySmall.fontSize,fontWeight:t.typography.fontWeightRegular,marginLeft:t.spacing(.5)})});function Si(t){const{queries:s,totalQueries:o,loading:n,richHistorySearchFilters:r,updateFilters:i,clearRichHistoryResults:c,loadMoreRichHistory:h,richHistorySettings:m,height:f,listOfDatasources:p,activeDatasources:g}=t,x=(0,k.of)(Ci,f);(0,d.useEffect)(()=>{const L=!m.activeDatasourcesOnly&&m.lastUsedDatasourceFilters?m.lastUsedDatasourceFilters:g,v={search:"",sortOrder:ie.xB.Descending,datasourceFilters:L,from:0,to:m.retentionPeriod,starred:!1};return i(v),()=>{c()}},[]);const{value:y,loading:R}=(0,es.A)(async()=>{const v=p.map(w=>w.uid).map(async w=>{try{return(0,Be.l)().get(w)}catch{return Promise.resolve()}});return v!==void 0?(await Promise.all(v)).filter(C=>!!C):[]},[r?.datasourceFilters]);if(!r)return(0,e.jsx)("span",{children:(0,e.jsx)(a.x6,{i18nKey:"explore.rich-history-queries-tab.loading",children:"Loading..."})});const b=(0,ie.x8)(s,r.sortOrder),j=wo(),S=s.length&&s.length!==o,I=[r.from||0,r.to||m.retentionPeriod];return(0,e.jsxs)("div",{className:x.container,children:[(0,e.jsx)("div",{className:x.containerSlider,children:(0,e.jsxs)("div",{className:x.fixedSlider,children:[(0,e.jsx)("div",{className:x.labelSlider,children:(0,e.jsx)(a.x6,{i18nKey:"explore.rich-history-queries-tab.filter-history",children:"Filter history"})}),(0,e.jsx)("div",{className:x.labelSlider,children:(0,ie.IA)(I[0])}),(0,e.jsx)("div",{className:x.slider,children:(0,e.jsx)(ai.F,{tooltipAlwaysVisible:!1,min:0,max:m.retentionPeriod,value:I,orientation:"vertical",formatTooltipResult:ie.IA,reverse:!0,onAfterChange:L=>{i({from:L[0],to:L[1]})}})}),(0,e.jsx)("div",{className:x.labelSlider,children:(0,ie.IA)(I[1])})]})}),(0,e.jsxs)("div",{className:x.containerContent,"data-testid":"query-history-queries-tab",children:[(0,e.jsxs)("div",{className:x.selectors,children:[!m.activeDatasourcesOnly&&(0,e.jsx)($e.KF,{className:x.multiselect,options:p.map(L=>({value:L.name,label:L.name})),value:r.datasourceFilters,placeholder:(0,a.t)("explore.rich-history-queries-tab.filter-placeholder","Filter queries for data sources(s)"),"aria-label":(0,a.t)("explore.rich-history-queries-tab.filter-aria-label","Filter queries for data sources(s)"),onChange:L=>{i({datasourceFilters:L.map(v=>v.value)})}}),(0,e.jsx)("div",{className:x.filterInput,children:(0,e.jsx)(jo.Z,{escapeRegex:!1,placeholder:(0,a.t)("explore.rich-history-queries-tab.search-placeholder","Search queries"),value:r.search,onChange:L=>i({search:L})})}),(0,e.jsx)("div",{"aria-label":(0,a.t)("explore.rich-history-queries-tab.sort-aria-label","Sort queries"),className:x.sort,children:(0,e.jsx)($e.l6,{value:j.filter(L=>L.value===r.sortOrder),options:j,placeholder:(0,a.t)("explore.rich-history-queries-tab.sort-placeholder","Sort queries by"),onChange:L=>i({sortOrder:L.value})})})]}),(n||R)&&(0,e.jsx)("span",{children:(0,e.jsx)(a.x6,{i18nKey:"explore.rich-history-queries-tab.loading-results",children:"Loading results..."})}),!(n||R)&&Object.keys(b).map(L=>(0,e.jsxs)("div",{children:[(0,e.jsxs)("div",{className:x.heading,children:[L," ",(0,e.jsx)("span",{className:x.queries,children:S?(0,e.jsx)(a.x6,{i18nKey:"explore.rich-history-queries-tab.displaying-partial-queries",defaults:"Displaying {{ count }} queries",values:{count:b[L].length}}):(0,e.jsx)(a.x6,{i18nKey:"explore.rich-history-queries-tab.displaying-queries",defaults:"{{ count }} queries",values:{count:b[L].length}})})]}),b[L].map(v=>(0,e.jsx)(To,{datasourceInstances:y,queryHistoryItem:v},v.id))]},L)),S?(0,e.jsx)("div",{children:(0,e.jsx)(a.x6,{i18nKey:"explore.rich-history-queries-tab.showing-queries",defaults:"Showing {{ shown }} of {{ total }} <0>Load more</0>",values:{shown:s.length,total:o},components:[(0,e.jsx)(P.$n,{onClick:h,children:"Load more"},"loadMoreButton")]})}):null,(0,e.jsx)("div",{className:x.footer,children:M.$.queryHistoryEnabled?"":(0,a.t)("explore.rich-history-queries-tab.history-local","The history is local to your browser and is not shared with others.")})]})]})}var ji=l(66594);const Ri=t=>({container:(0,u.css)({fontSize:t.typography.bodySmall.fontSize}),spaceBetween:(0,u.css)({marginBottom:t.spacing(3)}),input:(0,u.css)({maxWidth:"200px"}),bold:(0,u.css)({fontWeight:t.typography.fontWeightBold}),bottomMargin:(0,u.css)({marginBottom:t.spacing(1)})});function Ti(t){const{retentionPeriod:s,starredTabAsFirstTab:o,activeDatasourcesOnly:n,onChangeRetentionPeriod:r,toggleStarredTabAsFirstTab:i,toggleActiveDatasourcesOnly:c,deleteRichHistory:h}=t,m=(0,k.of)(Ri),f=[{value:2,label:(0,a.t)("explore.rich-history-settings-tab.retention-period.2-days","2 days")},{value:5,label:(0,a.t)("explore.rich-history-settings-tab.retention-period.5-days","5 days")},{value:7,label:(0,a.t)("explore.rich-history-settings-tab.retention-period.1-week","1 week")},{value:14,label:(0,a.t)("explore.rich-history-settings-tab.retention-period.2-weeks","2 weeks")}],p=f.find(x=>x.value===s),g=()=>{(0,Qe.J7)().publish(new We.bY({title:(0,a.t)("explore.rich-history-settings-tab.delete-title","Delete"),text:(0,a.t)("explore.rich-history-settings-tab.delete-confirm-text","Are you sure you want to permanently delete your query history?"),yesText:(0,a.t)("explore.rich-history-settings-tab.delete-confirm","Delete"),icon:"trash-alt",onConfirm:()=>{h(),(0,dt.JD)((0,ms.dx)((0,xs.tZ)((0,a.t)("explore.rich-history-settings-tab.query-history-deleted","Query history deleted"))))}}))};return(0,e.jsxs)("div",{className:m.container,children:[(0,lt.gQ)().changeRetention?(0,e.jsx)(Oe.D,{label:(0,a.t)("explore.rich-history-settings-tab.history-time-span","History time span"),description:(0,a.t)("explore.rich-history-settings-tab.history-time-span-description","Select the period of time for which Grafana will save your query history. Up to {{MAX_HISTORY_ITEMS}} entries will be stored.",{MAX_HISTORY_ITEMS:ji.$H}),children:(0,e.jsx)("div",{className:m.input,children:(0,e.jsx)($e.l6,{value:p,options:f,onChange:r})})}):(0,e.jsx)(Je.F,{severity:"info",title:(0,a.t)("explore.rich-history-settings-tab.history-time-span","History time span"),children:(0,a.t)("explore.rich-history-settings-tab.alert-info","Grafana will keep entries up to {{optionLabel}}.Starred entries won't be deleted.",{optionLabel:p?.label})}),(0,e.jsx)(Ie.I,{label:(0,a.t)("explore.rich-history-settings-tab.change-default-tab","Change the default active tab from \u201CQuery history\u201D to \u201CStarred\u201D"),className:m.spaceBetween,children:(0,e.jsx)(Ve.K,{id:"explore-query-history-settings-default-active-tab",value:o,onChange:i})}),(0,lt.gQ)().onlyActiveDataSource&&(0,e.jsx)(Ie.I,{label:(0,a.t)("explore.rich-history-settings-tab.only-show-active-datasource","Only show queries for data source currently active in Explore"),className:m.spaceBetween,children:(0,e.jsx)(Ve.K,{id:"explore-query-history-settings-data-source-behavior",value:n,onChange:c})}),(0,lt.gQ)().clearHistory&&(0,e.jsxs)("div",{children:[(0,e.jsx)("div",{className:m.bold,children:(0,e.jsx)(a.x6,{i18nKey:"explore.rich-history-settings-tab.clear-query-history",children:"Clear query history"})}),(0,e.jsx)("div",{className:m.bottomMargin,children:(0,e.jsx)(a.x6,{i18nKey:"explore.rich-history-settings-tab.clear-history-info",children:"Delete all of your query history, permanently."})}),(0,e.jsx)(P.$n,{variant:"destructive",onClick:g,children:(0,e.jsx)(a.x6,{i18nKey:"explore.rich-history-settings-tab.clear-query-history-button",children:"Clear query history"})})]})]})}const wi=t=>({container:(0,u.css)({display:"flex"}),containerContent:(0,u.css)({width:"100%"}),selectors:(0,u.css)({display:"flex",justifyContent:"space-between",flexWrap:"wrap"}),multiselect:(0,u.css)({width:"100%",marginBottom:t.spacing(1)}),filterInput:(0,u.css)({marginBottom:t.spacing(1)}),sort:(0,u.css)({width:"170px"}),footer:(0,u.css)({height:"60px",display:"flex",justifyContent:"center",alignItems:"center",fontWeight:t.typography.fontWeightLight,fontSize:t.typography.bodySmall.fontSize,a:{fontWeight:t.typography.fontWeightMedium,marginLeft:t.spacing(.25)}})});function Li(t){const{updateFilters:s,clearRichHistoryResults:o,loadMoreRichHistory:n,richHistorySettings:r,queries:i,totalQueries:c,loading:h,richHistorySearchFilters:m}=t,f=(0,k.of)(wi),p=(0,O.d4)(Z.Kl),g=(0,ie.TR)();(0,d.useEffect)(()=>{const b=r.activeDatasourcesOnly&&r.lastUsedDatasourceFilters?r.lastUsedDatasourceFilters:p.dsToExplore.map(S=>g.find(I=>I.uid===S.datasource?.uid)?.name).filter(S=>!!S),j={search:"",sortOrder:ie.xB.Descending,datasourceFilters:b,from:0,to:r.retentionPeriod,starred:!0};return s(j),()=>{o()}},[]);const{value:x,loading:y}=(0,es.A)(async()=>{const j=await(m?.datasourceFilters&&m?.datasourceFilters.length>0?m?.datasourceFilters:g.map(S=>S.uid)).map(async S=>{try{return(0,Be.l)().get(S)}catch{return Promise.resolve()}});return j!==void 0?(await Promise.all(j)).filter(I=>!!I):[]},[m?.datasourceFilters]);if(!m)return(0,e.jsxs)("span",{children:[(0,e.jsx)(a.x6,{i18nKey:"explore.rich-history-starred-tab.loading",children:"Loading..."}),";"]});const R=wo();return(0,e.jsx)("div",{className:f.container,children:(0,e.jsxs)("div",{className:f.containerContent,children:[(0,e.jsxs)("div",{className:f.selectors,children:[!r.activeDatasourcesOnly&&(0,e.jsx)($e.KF,{className:f.multiselect,options:g.map(b=>({value:b.name,label:b.name})),value:m.datasourceFilters,placeholder:(0,a.t)("explore.rich-history-starred-tab.filter-queries-placeholder","Filter queries for data sources(s)"),"aria-label":(0,a.t)("explore.rich-history-starred-tab.filter-queries-aria-label","Filter queries for data sources(s)"),onChange:b=>{s({datasourceFilters:b.map(j=>j.value)})}}),(0,e.jsx)("div",{className:f.filterInput,children:(0,e.jsx)(jo.Z,{escapeRegex:!1,placeholder:(0,a.t)("explore.rich-history-starred-tab.search-queries-placeholder","Search queries"),value:m.search,onChange:b=>s({search:b})})}),(0,e.jsx)("div",{"aria-label":(0,a.t)("explore.rich-history-starred-tab.sort-queries-aria-label","Sort queries"),className:f.sort,children:(0,e.jsx)($e.l6,{value:R.filter(b=>b.value===m.sortOrder),options:R,placeholder:(0,a.t)("explore.rich-history-starred-tab.sort-queries-placeholder","Sort queries by"),onChange:b=>s({sortOrder:b.value})})})]}),h&&y&&(0,e.jsx)("span",{children:(0,e.jsx)(a.x6,{i18nKey:"explore.rich-history-starred-tab.loading-results",children:"Loading results..."})}),!(h&&y)&&i.map(b=>(0,e.jsx)(To,{queryHistoryItem:b,datasourceInstances:x},b.id)),i.length&&i.length!==c?(0,e.jsx)("div",{children:(0,e.jsx)(a.x6,{i18nKey:"explore.rich-history-starred-tab.showing-queries",defaults:"Showing {{ shown }} of {{ total }} <0>Load more</0>",values:{shown:i.length,total:c},components:[(0,e.jsx)(P.$n,{onClick:n,children:"Load more"},"loadMoreButton")]})}):null,(0,e.jsx)("div",{className:f.footer,children:M.$.queryHistoryEnabled?"":(0,a.t)("explore.rich-history-starred-tab.local-history-message","The history is local to your browser and is not shared with others.")})]})})}const wo=()=>[{label:(0,a.t)("explore.rich-history.newest-first","Newest first"),value:ie.xB.Descending},{label:(0,a.t)("explore.rich-history.oldest-first","Oldest first"),value:ie.xB.Ascending},{label:(0,a.t)("explore.rich-history.datasource-a-z","Data source A-Z"),value:ie.xB.DatasourceAZ},{label:(0,a.t)("explore.rich-history.datasource-z-a","Data source Z-A"),value:ie.xB.DatasourceZA}].filter(t=>(0,lt.gQ)().availableFilters.includes(t.value));function Ii(t){const{richHistory:s,richHistoryTotal:o,height:n,deleteRichHistory:r,onClose:i,firstTab:c}=t,[h,m]=(0,d.useState)(!1),f=C=>{t.updateHistorySettings({...t.richHistorySettings,...C})},p=C=>{const D={...t.richHistorySearchFilters,...C,page:1};t.updateHistorySearchFilters(D),g()},g=(0,G.debounce)(()=>{t.loadRichHistory(),m(!0)},300),x=C=>{C.value!==void 0&&f({retentionPeriod:C.value})},y=()=>f({starredTabAsFirstTab:!t.richHistorySettings.starredTabAsFirstTab}),R=()=>f({activeDatasourcesOnly:!t.richHistorySettings.activeDatasourcesOnly});(0,d.useEffect)(()=>{m(!1)},[s]);const b=(0,O.d4)(Z.Kl),j=(0,ie.TR)(),S=b.dsToExplore.map(C=>j.find(D=>D.uid===C.datasource?.uid)?.name).filter(C=>!!C),I={label:(0,a.t)("explore.rich-history.query-history","Query history"),value:et.tU.RichHistory,content:(0,e.jsx)(Si,{queries:s,totalQueries:o||0,loading:h,updateFilters:p,clearRichHistoryResults:()=>t.clearRichHistoryResults(),loadMoreRichHistory:()=>t.loadMoreRichHistory(),richHistorySettings:t.richHistorySettings,richHistorySearchFilters:t.richHistorySearchFilters,height:n,activeDatasources:S,listOfDatasources:j}),icon:"history"},L={label:(0,a.t)("explore.rich-history.starred","Starred"),value:et.tU.Starred,content:(0,e.jsx)(Li,{queries:s,totalQueries:o||0,loading:h,updateFilters:p,clearRichHistoryResults:()=>t.clearRichHistoryResults(),loadMoreRichHistory:()=>t.loadMoreRichHistory(),richHistorySettings:t.richHistorySettings,richHistorySearchFilters:t.richHistorySearchFilters}),icon:"star"},v={label:(0,a.t)("explore.rich-history.settings","Settings"),value:et.tU.Settings,content:(0,e.jsx)(Ti,{retentionPeriod:t.richHistorySettings.retentionPeriod,starredTabAsFirstTab:t.richHistorySettings.starredTabAsFirstTab,activeDatasourcesOnly:t.richHistorySettings.activeDatasourcesOnly,onChangeRetentionPeriod:x,toggleStarredTabAsFirstTab:y,toggleActiveDatasourcesOnly:R,deleteRichHistory:r}),icon:"sliders-v-alt"};let w=[I,L,v];return(0,e.jsx)(So.q,{tabs:w,onClose:i,defaultTab:c,closeIconTooltip:(0,a.t)("explore.rich-history.close-tooltip","Close query history"),testId:He.Tp.pages.Explore.QueryHistory.container})}function Ei(t){const s=t.explore,o=s.richHistorySearchFilters,{richHistorySettings:n,richHistory:r,richHistoryTotal:i}=s;return{richHistory:r,richHistoryTotal:i,richHistorySettings:n,richHistorySearchFilters:o}}const Fi={initRichHistory:be.PA,loadRichHistory:be.jX,loadMoreRichHistory:be.Uu,clearRichHistoryResults:be.wk,updateHistorySettings:be.fP,updateHistorySearchFilters:be.Bj,deleteRichHistory:be.s1},Di=(0,fe.connect)(Ei,Fi);function Oi(t){const s=(0,k.$j)(),{richHistory:o,richHistoryTotal:n,deleteRichHistory:r,initRichHistory:i,loadRichHistory:c,loadMoreRichHistory:h,clearRichHistoryResults:m,richHistorySettings:f,updateHistorySettings:p,richHistorySearchFilters:g,updateHistorySearchFilters:x,onClose:y}=t;(0,d.useEffect)(()=>{i()},[i]);const{selectedTab:R}=(0,et.sz)(),[b,j]=(0,d.useState)(!1);return(0,d.useEffect)(()=>{b||(j(!0),(0,A.rR)("grafana_explore_query_history_opened",{queryHistoryEnabled:M.$.queryHistoryEnabled,selectedTab:R}))},[b,R]),f?(0,e.jsx)(Ii,{richHistory:o,richHistoryTotal:n,firstTab:R,onClose:y,height:s.components.horizontalDrawer.defaultHeight,deleteRichHistory:r,richHistorySettings:f,richHistorySearchFilters:g,updateHistorySettings:p,updateHistorySearchFilters:x,loadRichHistory:c,loadMoreRichHistory:h,clearRichHistoryResults:m}):(0,e.jsx)("span",{children:(0,e.jsx)(a.x6,{i18nKey:"explore.rich-history-container.loading",children:"Loading..."})})}const Ai=Di(Oi);var Lo=l(92948),Io=l(8692);function Pi(t){const s=(0,nt.C)("explore"),{chrome:o}=(0,Me.Il)();(0,d.useEffect)(()=>{if(!t.panes||typeof t.panes!="string")return;let n;try{n=JSON.parse(t.panes)}catch{return}typeof n!="object"||n===null||Promise.allSettled(Object.values(n).map(r=>!r||typeof r!="object"||!(0,Io.C)("datasource",r)||!r.datasource||typeof r.datasource!="string"?Promise.reject():(0,Be.l)().get(r.datasource))).then(r=>r.filter(Io.s).map(i=>i.value)).then(r=>{if(r.length===0){l.g.document.title=`${s.main.text} - ${Lo.M.AppTitle}`,o.update({pageNav:void 0});return}const i=r.map(c=>c.name).join(" | ");o.update({pageNav:{text:i}}),l.g.document.title=`${s.main.text} - ${i} - ${Lo.M.AppTitle}`})},[t.panes,s.main.text,o])}function ki(){const{keybindings:t}=(0,Me.Il)(),s=(0,O.wA)();(0,d.useEffect)(()=>{t.setupTimeRangeBindings(!1);const o=[];return o.push((0,Qe.J7)().subscribe(We.Rh,()=>{s((0,he.$_)())})),o.push((0,Qe.J7)().subscribe(We.Io,n=>{s((0,he.Iy)(n.payload.direction))})),o.push((0,Qe.J7)().subscribe(We.U0,n=>{s((0,he.ke)(n.payload.scale))})),o.push((0,Qe.J7)().subscribe(We.Bt,()=>{s((0,he.Xk)())})),o.push((0,Qe.J7)().subscribe(We.VZ,()=>{s((0,he.GA)())})),()=>{o.forEach(n=>n.unsubscribe())}},[s,t])}const Ni=t=>{const s=(0,O.wA)(),{width:o}=(0,ps.A)(),n=(0,O.d4)(Z.K6),r=(0,O.d4)(Z.pF),[i,c]=(0,d.useState)(.5),h=(0,O.d4)(p=>p.explore),m=p=>{const g=o/2,x=(0,G.inRange)(p,g-100,g+100);s(x?(0,q.nD)({largerExploreId:void 0}):(0,q.nD)({largerExploreId:p>g?n[1][0]:n[0][0]})),c(p/o)};let f=0;return r&&(!h.evenSplitPanes&&h.maxedExploreId?f=h.maxedExploreId===n[1][0]?o-t:t:h.evenSplitPanes?f=Math.floor(o/2):i!==void 0&&(f=o*i)),{updateSplitSize:m,widthCalc:f}};function Mi(){const{location:t}=(0,Me.Il)();(0,d.useEffect)(()=>{const s=t.getSearchObject();(s.from||s.to)&&t.partial({from:void 0,to:void 0},!0)},[t])}const fs=200;function Hi(t){return(0,e.jsx)(Bi,{...t})}function Bi(t){const s=(0,k.of)($i),o=(0,k.$j)();Mi(),(0,ao.s)(t.queryParams),Pi(t.queryParams);const{chrome:n}=(0,Me.Il)(),r=(0,nt.C)("explore"),{updateSplitSize:i,widthCalc:c}=Ni(fs),h=(0,O.d4)(Z.K6),m=(0,O.d4)(Z.pF),f=(0,O.d4)(Z.vC),{drawerOpened:p,setDrawerOpened:g}=(0,et.sz)(),x=M.$.featureToggles.correlations&&(f?.editorMode||!1);return(0,d.useEffect)(()=>{n.update({sectionNav:r})},[n,r]),ki(),(0,e.jsxs)("div",{className:(0,u.cx)(s.pageScrollbarWrapper,{[s.correlationsEditorIndicator]:x}),children:[(0,e.jsx)("h1",{className:"sr-only",children:(0,e.jsx)(a.x6,{i18nKey:"nav.explore.title"})}),(0,e.jsx)(Zo,{}),x&&(0,e.jsx)(Go,{panes:h}),(0,e.jsx)(Gt.g,{splitOrientation:"vertical",paneSize:c,minSize:fs,maxSize:fs*-1,primary:"second",splitVisible:m,parentStyle:x?{height:`calc(100% - ${o.spacing(6)}`}:{},paneStyle:{overflow:"auto",display:"flex",flexDirection:"column"},onDragFinished:y=>y&&i(y),children:h.map(([y])=>(0,e.jsx)(se.Xw,{style:"page",children:(0,e.jsx)(ni,{exploreId:y})},y))}),p&&(0,e.jsx)(Os,{children:(0,e.jsx)(Ai,{onClose:()=>{g(!1)}})})]})}const $i=t=>({pageScrollbarWrapper:(0,u.css)({width:"100%",flexGrow:1,minHeight:0,height:"100%",position:"relative",overflow:"hidden"}),correlationsEditorIndicator:(0,u.css)({borderLeft:`4px solid ${t.colors.primary.main}`,borderRight:`4px solid ${t.colors.primary.main}`,borderBottom:`4px solid ${t.colors.primary.main}`,overflow:"scroll"})})},32776:(Ut,Fe,l)=>{l.d(Fe,{S5:()=>at,fq:()=>k,gy:()=>A,l1:()=>vt});var e=l(2543),u=l.n(e),d=l(57866),a=l(33553),M=l(95004);const k=E=>(!E.pluginVersion&&"columns"in E&&console.log("Was angular table",E),E.options),se={timeseries_to_rows:"seriesToRows",timeseries_to_columns:"seriesToColumns",timeseries_aggregations:"reduce",table:"merge"},Gt={avg:"mean",min:"min",max:"max",total:"sum",current:"lastNotNull",count:"count"},Me={cell:"color-background",row:"color-background",value:"color-text"},nt=(E,U)=>[-1/0,...E].map((V,P)=>({color:U[P],value:(0,e.isNumber)(V)?V:parseInt(V,10)})),O=(E,U)=>{const V=E.transformations??[];if(Object.keys(se).includes(U.transform)){const P={reducers:[]};U.transform==="timeseries_aggregations"&&(P.includeTimeField=!1,P.reducers=U.columns.map(je=>Gt[je.value])),V.push({id:se[U.transform],options:P})}return V},Ue=E=>{const V={matcher:{id:/^\/.*\/$/.test(E.pattern)?d.Ct.byRegexp:d.Ct.byName,options:E.pattern},properties:[]};return E.alias&&V.properties.push({id:"displayName",value:E.alias}),E.unit&&V.properties.push({id:"unit",value:E.unit}),E.decimals&&V.properties.push({id:"decimals",value:E.decimals}),E.type==="date"&&V.properties.push({id:"unit",value:`time: ${E.dateFormat}`}),E.type==="hidden"&&V.properties.push({id:"custom.hidden",value:!0}),E.link&&V.properties.push({id:"links",value:[{title:(0,e.defaultTo)(E.linkTooltip,""),url:(0,e.defaultTo)(E.linkUrl,""),targetBlank:(0,e.defaultTo)(E.linkTargetBlank,!1)}]}),E.colorMode&&V.properties.push({id:"custom.cellOptions",value:{type:Me[E.colorMode]}}),E.align&&V.properties.push({id:"custom.align",value:E.align==="auto"?null:E.align}),E.thresholds?.length&&V.properties.push({id:"thresholds",value:{mode:a.O.Absolute,steps:nt(E.thresholds,E.colors)}}),V},qt=E=>{let U={custom:{}};if(E){if(U=(0,e.omitBy)({unit:E.unit,decimals:E.decimals,displayName:E.alias,custom:{align:E.align==="auto"?null:E.align}},e.isNil),E.thresholds.length){const V={mode:a.O.Absolute,steps:nt(E.thresholds,E.colors)};U.thresholds=V}E.colorMode&&(U.custom.cellOptions={type:Me[E.colorMode]})}return U},vt=(E,U,V)=>{if(U==="table-old"&&V.angular){const P=V.angular,je=O(E,P),_=P.styles.find(G=>G.pattern==="/.*/"),De=qt(_),Ge=P.styles.filter(G=>G.pattern!=="/.*/").map(Ue);E.transformations=je,E.fieldConfig={defaults:De,overrides:Ge}}return{}},rt=E=>E?.filter(U=>U.meta?.custom?.parentRowIndex===void 0)||[E?.[0]],at=E=>{const U=[];return rt(E).filter(P=>!!P&&P.length!==0)?.forEach(P=>{const je=E?.filter(G=>P.refId===G.refId&&G.meta?.custom?.parentRowIndex!==void 0),_=(0,e.groupBy)(je,G=>G.meta?.custom?.parentRowIndex),De=Object.keys(_).map(G=>_[G]),Ge={...P};je&&je.length>0&&Ge.fields.push({name:"nested",type:M.PU.nestedFrames,config:{},values:De}),U.push(Ge)}),U},A=E=>E?.some(U=>U.meta?.custom?.parentRowIndex!==void 0)},66178:(Ut,Fe,l)=>{l.d(Fe,{A:()=>d});var e=l(96540),u=function(a,M){var k=(0,e.useRef)(function(){});(0,e.useEffect)(function(){k.current=a}),(0,e.useEffect)(function(){if(M!==null){var se=setInterval(function(){return k.current()},M||0);return function(){return clearInterval(se)}}},[M])};const d=u}}]);

//# sourceMappingURL=2792.e29cf12182578312711c.js.map