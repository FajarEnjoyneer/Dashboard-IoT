"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[4302],{47220:(z,R,e)=>{e.d(R,{o:()=>n});var t=e(74848),E=e(96540),f=e(36638),o=e(57866),j=e(95004),h=e(60519),d=e(54735),y=e(36192),S=e(92790),i=e(17669);function g(m,s,r=[]){for(const a of r)if(typeof a=="function"){if(!a(m,s))return!1}else if(s[a]!==m[a])return!1;return!0}const P={x:f.sJ.get(o.Ct.firstTimeField).get({}),y:f.sJ.get(o.Ct.byTypes).get(new Set([j.PU.number,j.PU.enum]))};class n extends E.Component{constructor(s){super(s),this.getTimeRange=()=>this.props.timeRange;let r=this.prepState(s);r.alignedData=r.config.prepData([r.alignedFrame]),this.state=r,this.plotInstance=E.createRef()}prepState(s,r=!0){let a=null;const{frames:u,fields:l=P,preparePlotFrame:C,replaceVariables:I,dataLinkPostProcessor:O}=s,U=C??i.m,N=u.some(D=>D.fields.some(_=>(_.config.links?.length??0)>0)),p=U(u,{...l,y:N?()=>!0:l.y},s.timeRange);if((0,y.uY)("GraphNG",!1,"data aligned",p),p){let D=p;if(N){const G=Array.isArray(this.props.timeZone)?this.props.timeZone[0]:this.props.timeZone;let V=u.map((T,B)=>({...T,fields:p.fields.filter((W,$)=>$===0||W.state?.origin?.frameIndex===B),length:p.length}));V.forEach((T,B)=>{T.fields.forEach(W=>{W.getLinks=(0,h._M)(T,W,{...W.state?.scopedVars,__dataContext:{value:{data:V,field:W,frame:T,frameIndex:B}}},I,G,O)})}),D={...p,fields:p.fields.filter((T,B)=>B===0||l.y(T,p,[p]))}}if(s.omitHideFromViz){const G=D.fields.filter(V=>V.config.custom?.hideFrom?.viz!==!0);D={...D,fields:G,length:G.length}}let _=this.state?.config;r&&(_=s.prepConfig(D,this.props.frames,this.getTimeRange),(0,y.uY)("GraphNG",!1,"config prepared",_)),a={alignedFrame:D,config:_},(0,y.uY)("GraphNG",!1,"data prepared",a.alignedData)}return a}componentDidUpdate(s){const{frames:r,structureRev:a,timeZone:u,cursorSync:l,propsToDiff:C}=this.props,I=!g(s,this.props,C);if(r!==s.frames||I||u!==s.timeZone||l!==s.cursorSync){let O=this.prepState(this.props,!1);O&&((this.state.config===void 0||u!==s.timeZone||l!==s.cursorSync||a!==s.structureRev||!a||I)&&(O.config=this.props.prepConfig(O.alignedFrame,this.props.frames,this.getTimeRange),(0,y.uY)("GraphNG",!1,"config recreated",O.config)),O.alignedData=O.config.prepData([O.alignedFrame]),this.setState(O))}}render(){const{width:s,height:r,children:a,renderLegend:u}=this.props,{config:l,alignedFrame:C,alignedData:I}=this.state;return l?(0,t.jsx)(d.KU,{width:s,height:r,legend:u(l),children:(O,U)=>(0,t.jsx)(S.Z,{config:l,data:I,width:O,height:U,plotRef:N=>this.plotInstance.current=N,children:a?a(l,C):null})}):null}}},17669:(z,R,e)=>{e.d(R,{m:()=>S});var t=e(95004),E=e(63409),f=e(8721);function o(i,g,P){let n,m;for(let s=0;s<g.length;s++)if(g[s]==null)m==null&&n!=null&&(m=s);else{if(m!=null&&n!=null){if(i[s]-n<P)for(;m<s;)g[m++]=void 0;m=null}n=i[s]}return g}var j=e(739);function h(i){return i.type===t.PU.number&&i.config.custom?.drawStyle===j.GR.Bars&&!i.config.custom?.hideFrom?.viz}function d(i,g){return i.fields.find(P=>g!=null?P.name===g:P.type===t.PU.time)}function y(i,g){const P=d(i,g);let n=P?.values;for(let m=0;m<i.fields.length;m++){let s=i.fields[m];if(s===P||h(s))continue;let r=s.config.custom?.spanNulls;typeof r=="number"&&r!==-1&&n&&(s.values=o(n,s.values,r))}return i}function S(i,g,P){let n;e:for(let a of i)for(let u of a.fields)if(g.x(u,a,i)){n=u;break e}i=i.map(a=>n?.state?.nullThresholdApplied?a:(0,E.M)({frame:a,refFieldName:n.name,refFieldPseudoMin:P?.from.valueOf(),refFieldPseudoMax:P?.to.valueOf()}));let m=i.reduce((a,u)=>a+u.fields.reduce((l,C)=>l+(h(C)?1:0),0),0),s=1/0;m>1&&i.forEach(a=>{if(!a.fields.some(h))return;const u=n.values;for(let l=0;l<u.length;l++)l>0&&(s=Math.min(s,u[l]-u[l-1]))});let r=(0,f.Fd)({frames:i,joinBy:g.x,keep:g.y,keepOriginIndices:!0,keepDisplayNames:!0,nullMode:a=>{if(h(a))return f.WO;let u=a.config.custom?.spanNulls;return u===!0?f.RC:u===-1?f.WO:f.JI}});return r?(r=y(r,n.name),s!==1/0&&(r.fields.forEach((a,u)=>{let l=a.values;if(u===0){let C=l[l.length-1];l.push(C+s,C+2*s)}else h(a)?l.push(null,null):l.push(void 0,void 0)}),r.length+=2),r):null}},16608:(z,R,e)=>{e.d(R,{I:()=>g});var t=e(74848),E=e(96540),f=e(64394),o=e(95004),j=e(739),h=e(54735),d=e(4268),y=e(47220),S=e(68706);const i=["rowHeight","colWidth","showValue","mergeValues","alignValue","tooltip","paginationRev"];class g extends E.Component{constructor(){super(...arguments),this.getValueColor=(n,m,s)=>{const r=this.props.frames[n]?.fields[m];if(r?.display){const a=r.display(s);if(a.color)return a.color}return f.F},this.prepConfig=(n,m,s)=>(0,S.iE)({frame:n,getTimeRange:s,allFrames:this.props.frames,...this.props,timeZones:Array.isArray(this.props.timeZone)?this.props.timeZone:[this.props.timeZone],rowHeight:n.fields.length>2?this.props.rowHeight:1,getValueColor:this.getValueColor,hoverMulti:this.props.tooltip?.mode===j.$N.Multi}),this.renderLegend=n=>{const{legend:m,legendItems:s}=this.props;return!n||!s||!m||m.showLegend===!1?null:(0,t.jsx)(h.KU.Legend,{placement:m.placement,children:(0,t.jsx)(d.t,{placement:m.placement,items:s,displayMode:m.displayMode,readonly:!0})})}}render(){return(0,t.jsx)(y.o,{...this.props,fields:{x:n=>n.type===o.PU.time,y:n=>n.type===o.PU.number||n.type===o.PU.boolean||n.type===o.PU.string||n.type===o.PU.enum},prepConfig:this.prepConfig,propsToDiff:i,renderLegend:this.renderLegend,omitHideFromViz:!0})}}},59614:(z,R,e)=>{e.d(R,{U:()=>E});var t=e(5709);const E=t.H.injectEndpoints({endpoints:f=>({getRuleHistory:f.query({query:({ruleUid:o,from:j,to:h,limit:d=100})=>({url:"/api/v1/rules/history",params:{ruleUID:o,from:j,to:h,limit:d}})})})})},88215:(z,R,e)=>{e.d(R,{A:()=>i});var t=e(74848),E=e(96540),f=e(70713),o=e(92745),j=e(739),h=e(63142),d=e(16608),y=e(68706);const S=g=>g,i=(0,E.memo)(({frames:g,timeRange:P})=>{const n=(0,h.$j)();return(0,t.jsx)(f.Ay,{disableHeight:!0,children:({width:m})=>(0,t.jsx)(d.I,{frames:g,timeRange:P,timeZone:"browser",mode:y.pm.Changes,height:18*g.length+50,width:m,showValue:j.yL.Never,theme:n,rowHeight:.8,legend:{calcs:[],displayMode:j.lm.List,placement:"bottom",showLegend:!0},legendItems:[{label:(0,o.t)("alerting.log-timeline-viewer.label.normal","Normal"),color:n.colors.success.main,yAxis:1},{label:(0,o.t)("alerting.log-timeline-viewer.label.pending","Pending"),color:n.colors.warning.main,yAxis:1},{label:(0,o.t)("alerting.log-timeline-viewer.label.recovering","Recovering"),color:n.colors.warning.main,yAxis:1},{label:(0,o.t)("alerting.log-timeline-viewer.label.firing","Firing"),color:n.colors.error.main,yAxis:1},{label:(0,o.t)("alerting.log-timeline-viewer.label.no-data","No Data"),color:n.colors.info.main,yAxis:1},{label:(0,o.t)("alerting.log-timeline-viewer.label.mixed","Mixed"),color:n.colors.text.secondary,yAxis:1}],replaceVariables:S})})});i.displayName="LogTimelineViewer"},54302:(z,R,e)=>{e.r(R),e.d(R,{default:()=>de,getStyles:()=>te,useFrameSubset:()=>q});var t=e(74848),E=e(22803),f=e(2543),o=e(96540),j=e(49785),h=e(25229),d=e(92745),y=e(63142),S=e(34999),i=e(41654),g=e(66404),P=e(45967),n=e(30703),m=e(45861),s=e(37386),r=e(72636),a=e(63527),u=e(59614),l=e(86017),C=e(7840),I=e(38055),O=e(74226),U=e(80011),N=e(37658),p=e(78793),D=e(65420),_=e(41542);function G(c){const v=c.reduce((x,M)=>{const A=x.get(M.timestamp);return A?A.push(M):x.set(M.timestamp,[M]),x},new Map);return new Map([...v].sort((x,M)=>M[0]-x[0]))}const V=(0,o.memo)(({records:c,commonLabels:v,onLabelClick:x,onRecordsRendered:M})=>{const A=(0,y.of)($),b=G(c),L=new Map;return(0,o.useEffect)(()=>{M&&M(L)}),(0,t.jsx)("ul",{className:A.logsScrollable,"aria-label":(0,d.t)("alerting.log-record-viewer-by-timestamp.aria-label-state-history-by-timestamp","State history by timestamp"),children:Array.from(b.entries()).map(([F,H])=>(0,t.jsxs)("li",{id:F.toString(10),"data-testid":F,ref:K=>K&&L.set(F,K),className:A.listItemWrapper,children:[(0,t.jsx)(B,{time:F}),(0,t.jsx)("div",{className:A.logsContainer,children:H.map(({line:K})=>(0,t.jsxs)(o.Fragment,{children:[(0,t.jsx)(D.C,{state:K.previous,size:"sm",muted:!0}),(0,t.jsx)(n.I,{name:"arrow-right",size:"sm"}),(0,t.jsx)(D.C,{state:K.current}),(0,t.jsx)(i.B,{children:K.values&&(0,t.jsx)(W,{record:K.values})}),(0,t.jsx)("div",{children:K.labels&&(0,t.jsx)(N.L,{tags:(0,_.$)(Object.entries(K.labels),v).map(([Z,Y])=>`${Z}=${Y}`),onClick:x})})]},(0,f.uniqueId)()))})]},F))})});V.displayName="LogRecordViewerByTimestamp";function T({records:c,commonLabels:v}){const x=useStyles2($),M=groupBy(c,A=>JSON.stringify(A.line.labels));return jsx(Fragment,{children:Object.entries(M).map(([A,b])=>jsxs(Stack,{direction:"column",children:[jsx("h4",{children:jsx(TagList,{tags:omitLabels(Object.entries(b[0].line.labels??{}),v).map(([L,F])=>`${L}=${F}`)})}),jsx("div",{className:x.logsContainer,children:b.map(({line:L,timestamp:F})=>jsxs("div",{children:[jsx(AlertStateTag,{state:L.previous,size:"sm",muted:!0}),jsx(Icon,{name:"arrow-right",size:"sm"}),jsx(AlertStateTag,{state:L.current}),jsx(Stack,{children:L.values&&jsx(W,{record:L.values})}),jsx("div",{children:dateTimeFormat(F)})]},uniqueId()))})]},A))})}const B=({time:c})=>{const v=new Date(c),x=(0,y.of)($);return(0,t.jsx)("div",{className:x.timestampWrapper,children:(0,t.jsxs)(i.B,{alignItems:"center",gap:1,children:[(0,t.jsx)(n.I,{name:"clock-nine",size:"sm"}),(0,t.jsx)("span",{className:x.timestampText,children:(0,U.LE)(v)}),(0,t.jsx)("small",{children:(0,t.jsxs)(d.x6,{i18nKey:"alerting.timestamp.time-ago",values:{time:(0,O.B)(v)},children:["(","{{time}}"," ago)"]})})]})})},W=(0,o.memo)(({record:c})=>{const v=Object.entries(c);return(0,t.jsx)(t.Fragment,{children:v.map(([x,M])=>(0,t.jsx)(p.J,{label:x,value:M},x))})});W.displayName="AlertInstanceValues";const $=c=>({logsContainer:(0,E.css)({display:"grid",gridTemplateColumns:"max-content max-content max-content auto max-content",gap:c.spacing(2,1),alignItems:"center"}),logsScrollable:(0,E.css)({height:"500px",overflow:"scroll",flex:1}),timestampWrapper:(0,E.css)({color:c.colors.text.secondary}),timestampText:(0,E.css)({color:c.colors.text.primary,fontSize:c.typography.bodySmall.fontSize,fontWeight:c.typography.fontWeightBold}),listItemWrapper:(0,E.css)({background:"transparent",outline:"1px solid transparent",padding:`${c.spacing(1)} ${c.spacing(1.5)}`,[c.transitions.handleMotion("no-preference","reduce")]:{transition:"background 150ms, outline 150ms"}})});var re=e(88215),ie=e(93571);const le=10*1e3,oe=12,ce=({ruleUID:c})=>{const v=(0,y.of)(te),[x,M]=(0,o.useState)(""),A=(0,o.useRef)(new Map),{getValues:b,setValue:L,register:F,handleSubmit:H}=(0,j.mN)({defaultValues:{query:""}}),{useGetRuleHistoryQuery:K}=u.U,Z=(0,o.useMemo)(()=>me(),[]),{currentData:Y,isLoading:ue,isError:ge,error:se}=K({ruleUid:c,from:Z.from.unix(),to:Z.to.unix(),limit:250},{refetchOnFocus:!0,refetchOnReconnect:!0,pollingInterval:le}),{dataFrames:X,historyRecords:fe,commonLabels:w,totalRecordsCount:k}=(0,ie.mW)(Y,x),{frameSubset:Q,frameTimeRange:he}=q(X),pe=(0,o.useCallback)(J=>{const ae=(0,l.EU)(b("query"),J);M(ae),L("query",ae)},[M,L,b]),ne=(0,o.useCallback)(()=>{M(""),L("query","")},[M,L]);if(ue)return(0,t.jsx)("div",{children:(0,t.jsx)(d.x6,{i18nKey:"alerting.loki-state-history.loading",children:"Loading..."})});if(ge)return(0,t.jsx)(S.F,{title:(0,d.t)("alerting.loki-state-history.title-error-fetching-the-state-history","Error fetching the state history"),severity:"error",children:se instanceof Error?se.message:(0,d.t)("alerting.loki-state-history.error-unable-to-fetch","Unable to fetch alert state history")});const ye=Q.length<X.length,xe=k>0?`No matches were found for the given filters among the ${k} instances`:"No state transitions have occurred in the last 30 days";return(0,t.jsxs)("div",{className:v.fullSize,children:[(0,t.jsxs)("form",{onSubmit:H(J=>M(J.query)),children:[(0,t.jsx)(ee,{...F("query"),showClearFilterSuffix:!!x,onClearFilterClick:ne}),(0,t.jsx)("input",{type:"submit",hidden:!0})]}),!(0,f.isEmpty)(w)&&(0,t.jsxs)(i.B,{gap:1,alignItems:"center",wrap:"wrap",children:[(0,t.jsxs)(i.B,{gap:.5,alignItems:"center",minWidth:"fit-content",children:[(0,t.jsx)(g.E,{variant:"bodySmall",children:(0,t.jsx)(d.x6,{i18nKey:"alerting.loki-state-history.common-labels",children:"Common labels"})}),(0,t.jsx)(P.m,{content:(0,d.t)("alerting.loki-state-history.tooltip-common-labels","Common labels are the ones attached to all of the alert instances"),children:(0,t.jsx)(n.I,{name:"info-circle",size:"sm"})})]}),(0,t.jsx)(C.m,{labels:(0,f.fromPairs)(w),size:"sm"})]}),(0,f.isEmpty)(Q)?(0,t.jsxs)("div",{className:v.emptyState,children:[xe,k>0&&(0,t.jsx)(m.$n,{variant:"secondary",type:"button",onClick:ne,children:(0,t.jsx)(d.x6,{i18nKey:"alerting.loki-state-history.clear-filters",children:"Clear filters"})})]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{className:v.graphWrapper,children:(0,t.jsx)(re.A,{frames:Q,timeRange:he})}),ye&&(0,t.jsx)("div",{className:v.moreInstancesWarning,children:(0,t.jsxs)(i.B,{direction:"row",alignItems:"center",gap:1,children:[(0,t.jsx)(n.I,{name:"exclamation-triangle",size:"sm"}),(0,t.jsx)("small",{children:`Only showing ${Q.length} out of ${X.length} instances. Click on the labels to narrow down the results`})]})}),(0,t.jsx)(V,{records:fe,commonLabels:w,onRecordsRendered:J=>A.current=J,onLabelClick:pe})]})]})};function q(c){return(0,o.useMemo)(()=>{const v=(0,f.take)(c,oe),x=(0,f.sortBy)((0,f.uniq)(v.flatMap(H=>H.fields[0].values))),M=Math.min(...x),A=Math.max(...x),b=(0,h.KQ)(M),L=(0,h.KQ)(A);return{frameSubset:v,frameSubsetTimestamps:x,frameTimeRange:{from:b,to:L,raw:{from:b,to:L}}}},[c])}const ee=o.forwardRef(({showClearFilterSuffix:c,onClearFilterClick:v,...x},M)=>(0,t.jsx)(s.D,{label:(0,t.jsx)(r.J,{htmlFor:"instancesSearchInput",children:(0,t.jsxs)(i.B,{gap:.5,children:[(0,t.jsx)("span",{children:(0,t.jsx)(d.x6,{i18nKey:"alerting.search-field-input.filter-instances",children:"Filter instances"})}),(0,t.jsx)(I.B,{content:(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(d.x6,{i18nKey:"alerting.search-field-input.filter-instances-tooltip",children:"Use label matcher expression or click on an instance label to filter instances, for example:"}),(0,t.jsx)("div",{children:(0,t.jsx)("code",{children:"{foo=bar}"})})]}),children:(0,t.jsx)(n.I,{name:"info-circle",size:"sm"})})]})}),children:(0,t.jsx)(a.p,{id:"instancesSearchInput",prefix:(0,t.jsx)(n.I,{name:"search"}),suffix:c&&(0,t.jsx)(m.$n,{fill:"text",icon:"times",size:"sm",onClick:v,children:(0,t.jsx)(d.x6,{i18nKey:"alerting.search-field-input.clear",children:"Clear"})}),placeholder:(0,d.t)("alerting.search-field-input.instancesSearchInput-placeholder-filter-instances","Filter instances"),ref:M,...x})}));ee.displayName="SearchFieldInput";function me(){const c=(0,h.KQ)().subtract(30,"days"),v=(0,h.KQ)();return{from:c,to:v,raw:{from:c,to:v}}}const te=c=>({fullSize:(0,E.css)({minWidth:"100%",height:"100%",display:"flex",flexDirection:"column"}),graphWrapper:(0,E.css)({padding:`${c.spacing()} 0`}),emptyState:(0,E.css)({color:c.colors.text.secondary,display:"flex",flexDirection:"column",gap:c.spacing(2),alignItems:"center",margin:"auto auto"}),moreInstancesWarning:(0,E.css)({color:c.colors.warning.text,padding:c.spacing()}),highlightedLogRecord:(0,E.css)({background:`${c.colors.primary.transparent} !important`,outline:`1px solid ${c.colors.primary.shade} !important`})}),de=ce},41542:(z,R,e)=>{e.d(R,{$:()=>f,Q:()=>o});var t=e(2543),E=e.n(t);function f(j,h){return j.filter(d=>!h.find(y=>JSON.stringify(y)===JSON.stringify(d)))}function o(j){const h=j.flatMap(y=>y);return(0,t.uniqBy)(h.filter(y=>h.filter(i=>(0,t.isEqual)(y,i)).length===Object.keys(j).length),y=>JSON.stringify(y))}},93571:(z,R,e)=>{e.d(R,{PA:()=>m,bF:()=>n,mW:()=>P});var t=e(2543),E=e.n(t),f=e(96540),o=e(95004),j=e(11576),h=e(92446),d=e(21275),y=e(63142),S=e(86017),i=e(63895),g=e(41542);function P(r,a){const u=(0,y.$j)();return(0,f.useMemo)(()=>{const l=r?.data?.values[0]??[],C=n(l)?l:[],I=r?.data?.values[1]??[],O=C.reduce((T,B,W)=>{const $=I[W];return m($)&&T.push({timestamp:B,line:$}),T},[]),U=(0,t.groupBy)(O,T=>JSON.stringify(T.line.labels)),p=Object.keys(U).map(T=>Object.entries(JSON.parse(T))),D=(0,g.Q)(p),_=a?(0,i.Zc)(a):[],V=Object.entries(U).filter(([T])=>{const B=JSON.parse(T);return(0,S.Av)(B,_)}).map(([T,B])=>s(T,B,D,u));return{historyRecords:O.filter(({line:T})=>T.labels&&(0,S.Av)(T.labels,_)),dataFrames:V,commonLabels:D,totalRecordsCount:O.length}},[r,a,u])}function n(r){return r.every(a=>typeof a=="number")}function m(r){return typeof r=="object"&&r!==null&&"current"in r&&"previous"in r}function s(r,a,u,l){const C=Object.entries(JSON.parse(r)),I={name:"time",type:o.PU.time,values:[...a.map(p=>p.timestamp),Date.now()],config:{displayName:"Time",custom:{fillOpacity:100}}},O=I.values.map((p,D)=>D);O.sort((0,h.i)(I));const U=[...a.map(p=>p.line.current),a.at(-1)?.line.current],N={fields:[{...I,values:I.values.map((p,D)=>I.values[O[D]])},{name:"State",type:o.PU.string,values:U.map((p,D)=>U[O[D]]),config:{displayName:(0,g.$)(C,u).map(([p,D])=>`${p}=${D}`).join(", "),color:{mode:"thresholds"},custom:{fillOpacity:100},mappings:[{type:d.dM.RegexToText,options:{pattern:"/^normal/i",result:{color:l.colors.success.main}}},{type:d.dM.RegexToText,options:{pattern:"/Alerting/",result:{color:l.colors.error.main}}},{type:d.dM.ValueToText,options:{Pending:{color:l.colors.warning.main},Recovering:{color:l.colors.warning.main},NoData:{color:l.colors.info.main}}}],thresholds:{mode:d.Ol.Absolute,steps:[]}}}],length:I.values.length,name:r};return N.fields.forEach(p=>{p.display=(0,j.J)({field:p,theme:l})}),N}}}]);

//# sourceMappingURL=4302.b4a72b3e0e7a73fec896.js.map