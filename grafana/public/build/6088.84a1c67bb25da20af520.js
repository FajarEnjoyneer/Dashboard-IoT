"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[6088],{97976:(At,rt,s)=>{s.d(rt,{L:()=>Ee});var d=s(74848),N=s(96540),lt=s(71468),q=s(87390),V=s(89224),dt=s(94701);function S({children:e,width:t,height:i,onLoad:n,onChange:a}){const o=(0,N.useId)(),[r,l]=(0,N.useState)(!1),[c,u]=(0,N.useState)(!1),f=(0,N.useRef)(null);return(0,dt.A)(()=>{S.addCallback(o,D=>{!r&&D.isIntersecting&&(l(!0),n?.()),u(D.isIntersecting),a?.(D.isIntersecting)});const C=f.current;return C&&S.observer.observe(C),()=>{delete S.callbacks[o],C&&S.observer.unobserve(C),Object.keys(S.callbacks).length===0&&S.observer.disconnect()}}),(0,d.jsx)("div",{id:o,ref:f,style:{width:t,height:i},children:r&&(typeof e=="function"?e({isInView:c}):e)})}const _={};S.callbacks=_,S.addCallback=(e,t)=>S.callbacks[e]=t,S.observer=new IntersectionObserver(e=>{for(const t of e)S.callbacks[t.target.id]&&S.callbacks[t.target.id](t)},{rootMargin:"100px"});var ct=s(2543),ht=s(64423),tt=s(84229),U=s(1906),H=s(57852),B=s(25229),ut=s(48480),P=s(28105),J=s(22592),et=s(41119),gt=s(75234),pt=s(64400),W=s(67522),nt=s(36303),ft=s(45229),j=s(65642),O=s(1505),A=s(17097),mt=s(28998),vt=s(48421),Ct=s(22747),st=s(57866),Et=s(64394);const w=(e,t,i)=>{const{overrides:n}=i,a=i.overrides.findIndex(u=>u.matcher.id===st.Ct.byName&&u.matcher.options===e);if(a<0)return{...i,overrides:[...i.overrides,at(e,t)]};const o=Array.from(n),r=o[a],l=r.properties.findIndex(u=>u.id==="color");if(l<0)return o[a]={...r,properties:[...r.properties,k(t)]},{...i,overrides:o};const c=Array.from(r.properties);return c[l]=k(t),o[a]={...r,properties:c},{...i,overrides:o}},at=(e,t)=>({matcher:{id:st.Ct.byName,options:e},properties:[k(t)]}),k=e=>({id:"color",value:{mode:Et.Y.Fixed,fixedColor:e}});var z=s(8535),yt=s(87745),Z=s(78767),m=s(32380),p=s(75421),x=s(67458),v=s(2863),I=s(36490),h=s(23289),F=s(26689),$=s(302),R=s(22803),K=s(76190),X=s(63142),St=s(45967),Y=s(30703),G=s(91867),y=s(92745),Q=s(87063),Ft=s(88559),Rt=s(7895);function bt({panelLinks:e,onShowPanelLinks:t}){const i=(0,X.of)(Lt),n=()=>{const a=t();return(0,d.jsx)(Q.W,{children:a?.map((o,r)=>(0,d.jsx)(Q.W.Item,{label:o.title,url:o.href,target:o.target,onClick:o.onClick},r))})};if(e.length===1){const a=t()[0];return(0,d.jsx)(W.NR.TitleItem,{href:a.href,onClick:a.onClick,target:a.target,title:a.title,children:(0,d.jsx)(Y.I,{name:"external-link-alt",size:"md"})})}else return(0,d.jsx)(Ft.m,{overlay:n,children:(0,d.jsx)(Rt.I,{icon:"external-link-alt",iconSize:"md","aria-label":(0,y.t)("dashboard.panel-links.aria-label-panel-links","Panel links"),className:i.menuTrigger})})}const Lt=e=>({menuTrigger:(0,R.css)({height:"100%",background:"inherit",border:"none",borderRadius:`${e.shape.radius.default}`,cursor:"context-menu"})});var Mt=s(46429);function Vt(e){const{alertState:t,data:i,panelId:n,onShowPanelLinks:a,panelLinks:o}=e,r=(0,X.of)(Ut),l=(0,d.jsx)(St.m,{content:t??"unknown",children:(0,d.jsx)(W.NR.TitleItem,{className:(0,R.cx)({[r.ok]:t===K.O.OK,[r.pending]:t===K.O.Pending||t===K.O.Recovering,[r.alerting]:t===K.O.Alerting}),children:(0,d.jsx)(Y.I,{name:t==="alerting"?"heart-break":"heart",size:"md"})})}),c=(0,d.jsx)(d.Fragment,{children:i.request&&i.request.timeInfo&&(0,d.jsx)(St.m,{content:(0,d.jsx)(G.xS,{timeRange:i.request?.range,timeZone:i.request?.timezone}),children:(0,d.jsxs)(W.NR.TitleItem,{className:r.timeshift,children:[(0,d.jsx)(Y.I,{name:"clock-nine",size:"md"})," ",i.request?.timeInfo]})})});return(0,d.jsxs)(d.Fragment,{children:[o&&o.length>0&&a&&(0,d.jsx)(bt,{onShowPanelLinks:a,panelLinks:o}),(0,d.jsx)(Mt.Z,{panelId:n,frames:i.series}),c,t&&l]})}const Ut=e=>({ok:(0,R.css)({color:e.colors.success.text,"&:hover":{color:e.colors.emphasize(e.colors.success.text,.03)}}),pending:(0,R.css)({color:e.colors.warning.text,"&:hover":{color:e.colors.emphasize(e.colors.warning.text,.03)}}),alerting:(0,R.css)({color:e.colors.error.text,"&:hover":{color:e.colors.emphasize(e.colors.error.text,.03)}}),timeshift:(0,R.css)({color:e.colors.text.link,gap:e.spacing(.5),whiteSpace:"nowrap","&:hover":{color:e.colors.emphasize(e.colors.text.link,.03)}}),angularNotice:(0,R.css)({color:e.colors.warning.text})});function jt(e){function t(){return e.data.request&&e.data.request.timeInfo?!1:!e.panel.hasTitle()}const i=()=>{const E=(0,v.w)().replace(e.panel.description,e.panel.scopedVars);return(0,x.G)(E)},n=()=>{const E=(0,$.E7)(e.panel);if(!E)return[];const L=E&&E.getLinks(e.panel.replaceVariables);return L.map(ot=>({...ot,onClick:(...it)=>{h.c.panelLinkClicked({has_multiple_links:L.length>1}),ot.onClick?.(...it)}}))},a=(E,L)=>{E.stopPropagation(),I.Ny.partial({inspect:e.panel.id,inspectTab:L})},o=E=>{E.stopPropagation(),I.Ny.partial({inspect:e.panel.id,inspectTab:F.q.Error}),h.c.panelStatusMessageClicked()},r=()=>{e.panel.getQueryRunner().cancelQuery(),h.c.panelCancelQueryClicked({data_state:e.data.state})},l=e.plugin.noPadding?"none":"md",c=e.data.alertState?.state,f=(e.panel.links&&e.panel.links.length>0&&n||e.data.series.length>0&&e.data.series.some(E=>(E.meta?.notices?.length??0)>0)||e.data.request&&e.data.request.timeInfo||c)&&(0,d.jsx)(Vt,{alertState:c,data:e.data,panelId:e.panel.id,panelLinks:e.panel.links,onShowPanelLinks:n}),C=e.panel.description?i:void 0,D=!(e.isViewing||e.isEditing)&&(e.isDraggable??!0)?"grid-drag-handle":"",b=e.panel.getDisplayTitle();return{hasOverlayHeader:t,onShowPanelDescription:i,onShowPanelLinks:n,onOpenInspector:a,onOpenErrorInspect:o,onCancelQuery:r,padding:l,description:C,dragClass:D,title:b,titleItems:f}}var Gt=s(27359),Ht=s(60519),Wt=s(18030);function wt(e,t){const i=(0,et.Bt)(e.snapshotData),n=new Wt.F,a={dashboard:t,range:(0,J.E2)()},o=n.canWork(a)?n.getAnnotationsInSnapshot(t,e.id):[],r=[(0,Gt.I)(o)];return{timeRange:(0,A.nk)(e,(0,p.jG)().timeRange()).timeRange,state:P.Gu.Done,series:(0,Ht.we)({data:i,fieldConfig:{defaults:{},overrides:[]},replaceVariables:e.replaceVariables,fieldConfigRegistry:e.plugin.fieldConfigRegistry,theme:j.$W.theme2,timeZone:t.getTimezone()}),structureRev:1,annotations:r}}var zt=s(51898);function Qt({items:e}){const t=i=>i.map(n=>{switch(n.type){case"divider":return(0,d.jsx)(Q.W.Divider,{},n.text);case"group":return(0,d.jsx)(Q.W.Group,{label:n.text,children:n.subMenu?t(n.subMenu):void 0},n.text);default:return(0,d.jsx)(Q.W.Item,{label:n.text,icon:n.iconClassName,childItems:n.subMenu?t(n.subMenu):void 0,url:n.href,onClick:n.onClick,shortcut:n.shortcut,testId:zt.Tp.components.Panels.Panel.menuItems(n.text)},n.text)}});return(0,d.jsx)(Q.W,{children:t(e)})}var Bt=s(54092),Jt=s(60188),kt=s(46907),Zt=s(83175),$t=s(64762),Kt=s(12066),Nt=s(15130),Xt=s(47797),Yt=s(62635),qt=s(20437),_t=s(75515),te=s(3260),ee=s(9931),ne=s(54),se=s(35231);function ae(e,t,i){const n=g=>{g.preventDefault(),I.Ny.partial({viewPanel:t.id})},a=g=>{g.preventDefault(),I.Ny.partial({editPanel:t.id})},o=g=>{g.preventDefault(),(0,A.Mc)(e,t)},r=g=>{g.preventDefault(),(0,A.d7)(e,t)},l=g=>{g.preventDefault(),(0,A.ZY)(t)},c=g=>{I.Ny.partial({inspect:t.id,inspectTab:g})},u=g=>{g.preventDefault(),(0,A.iU)(e,t)},f=g=>{g.preventDefault(),(0,A.KJ)(t)},C=g=>{g.preventDefault(),(0,A.FC)(e,t,!0)},D=g=>{g.preventDefault();const Dt=g.ctrlKey||g.metaKey?xt=>window.open(xt):void 0;z.M_.dispatch((0,se.ow)(t,{timeRange:(0,p.jG)().timeRange(),getExploreUrl:Yt.Xe,openInNewWindow:Dt}))},b=g=>{g.preventDefault(),(0,A.ET)(t)},E=[];t.isEditing||E.push({text:(0,y.t)("panel.header-menu.view","View"),iconClassName:"eye",onClick:n,shortcut:"v"}),e.canEditPanel(t)&&!t.isEditing&&E.push({text:(0,y.t)("panel.header-menu.edit","Edit"),iconClassName:"edit",onClick:a,shortcut:"e"}),E.push({text:(0,y.t)("panel.header-menu.share","Share"),iconClassName:"share-alt",onClick:o,shortcut:"p s"}),Nt.TP.hasAccessToExplore()&&!(t.plugin&&t.plugin.meta.skipDataQuery)&&t.datasource?.uid!==ee.K&&E.push({text:(0,y.t)("panel.header-menu.explore","Explore"),iconClassName:"compass",onClick:D,shortcut:"p x"});const L=[];t.plugin&&!t.plugin.meta.skipDataQuery&&(L.push({text:(0,y.t)("panel.header-menu.inspect-data","Data"),onClick:g=>c(F.q.Data)}),e.meta.canEdit&&L.push({text:(0,y.t)("panel.header-menu.query","Query"),onClick:g=>c(F.q.Query)})),L.push({text:(0,y.t)("panel.header-menu.inspect-json","Panel JSON"),onClick:g=>c(F.q.JSON)}),E.push({type:"submenu",text:(0,y.t)("panel.header-menu.inspect","Inspect"),iconClassName:"info-circle",shortcut:"i",subMenu:L});const ot=async()=>{let g;try{g=await(0,qt.mp)(t,e)}catch(xt){const ye=`Error getting rule values from the panel: ${(0,Xt.q6)(xt)}`;(0,z.JD)((0,Kt.dx)((0,$t.gi)(ye)));return}const Dt=Zt.kM.renderUrl("/alerting/new",{defaults:JSON.stringify(g),returnTo:window.location.pathname+window.location.search});I.Ny.push(Dt)},it=g=>{g.preventDefault(),ot()},T=[],Tt=e.canEditPanel(t),Ot=(0,ne.q0)();return t.isViewing||t.isEditing||(Tt?(T.push({text:(0,y.t)("panel.header-menu.duplicate","Duplicate"),onClick:u,shortcut:"p d"}),T.push({text:(0,y.t)("panel.header-menu.copy","Copy"),onClick:f}),(0,_t.X)(t)?T.push({text:(0,y.t)("panel.header-menu.unlink-library-panel","Unlink library panel"),onClick:l}):T.push({text:(0,y.t)("panel.header-menu.create-library-panel","Create library panel"),onClick:r})):Nt.TP.isEditor&&T.push({text:(0,y.t)("panel.header-menu.copy","Copy"),onClick:f})),Ot&&T.push({text:(0,y.t)("panel.header-menu.new-alert-rule","New alert rule"),onClick:it}),t.options.legend&&T.push({text:t.options.legend.showLegend?(0,y.t)("panel.header-menu.hide-legend","Hide legend"):(0,y.t)("panel.header-menu.show-legend","Show legend"),onClick:b,shortcut:"p l"}),t.isEditing&&(T.length=0,Ot&&T.push({text:(0,y.t)("panel.header-menu.new-alert-rule","New alert rule"),onClick:it})),Tt&&t.plugin&&!t.plugin.meta.skipDataQuery&&T.push({text:(0,y.t)("panel.header-menu.get-help","Get help"),onClick:g=>c(F.q.Help)}),i.length>0&&!t.isEditing&&E.push({text:(0,y.t)("dashboard.get-panel-menu.text.extensions","Extensions"),iconClassName:"plug",type:"submenu",subMenu:(0,te.N9)(i)}),T.length&&E.push({type:"submenu",text:(0,y.t)("panel.header-menu.more","More..."),iconClassName:"cube",subMenu:T}),e.canEditPanel(t)&&!t.isEditing&&!t.isViewing&&(E.push({type:"divider",text:""}),E.push({text:(0,y.t)("panel.header-menu.remove","Remove"),iconClassName:"trash-alt",onClick:C,shortcut:"p r"})),E}function oe({panel:e,dashboard:t,loadingState:i,children:n}){const[a,o]=(0,N.useState)([]),r=(0,N.useMemo)(()=>ie(e,t),[e,t]),{links:l}=(0,kt.U)({extensionPointId:Bt.S.DashboardPanelMenu,context:r,limitPerPlugin:3});return(0,N.useEffect)(()=>{o(ae(t,e,l))},[t,e,i,o,l]),n({items:a})}function ie(e,t){return{id:e.id,pluginId:e.type,title:e.title,timeRange:t.time,timeZone:(0,Jt.O)({timeZone:t.timezone}),dashboard:{uid:t.uid,title:t.title,tags:Array.from(t.tags)},targets:e.targets,scopedVars:e.scopedVars,data:e.getQueryRunner().getLastResult()}}function re({style:e,panel:t,dashboard:i,loadingState:n}){return(0,d.jsx)(oe,{panel:t,dashboard:i,loadingState:n,children:({items:a})=>(0,d.jsx)(Qt,{style:e,items:a})})}var Pt=s(32631),M=(e=>(e.FIELD_CONFIG_OVERRIDES_CHANGED_EVENT="field config overrides changed",e.NEW_PANEL_OPTION_EVENT="new panel option",e.PANEL_OPTION_CHANGED_EVENT="panel option changed",e.NEW_DEFAULT_FIELD_CONFIG_EVENT="new default field config",e.DEFAULT_FIELD_CONFIG_CHANGED_EVENT="default field config changed",e.NEW_CUSTOM_FIELD_CONFIG_EVENT="new custom field config",e.CUSTOM_FIELD_CONFIG_CHANGED_EVENT="custom field config changed",e.MEASURE_PANEL_LOAD_TIME_EVENT="measure panel load time",e.THRESHOLDS_COUNT_CHANGED_EVENT="thresholds count changed",e.THRESHOLDS_MODE_CHANGED_EVENT="thresholds mode changed",e.MAPPINGS_COUNT_CHANGED_EVENT="mappings count changed",e.LINKS_COUNT_CHANGED_EVENT="links count changed",e.PANEL_ERROR="panel error",e))(M||{});const le="overrides",de="custom",ce=e=>{const t=performance.now();return(0,N.useEffect)(()=>{j.$W.grafanaJavascriptAgent.enabled&&requestAnimationFrame(()=>{setTimeout(()=>{Pt.P.api.pushMeasurement({type:M.MEASURE_PANEL_LOAD_TIME_EVENT,values:{start_loading_time_ms:t,load_time_ms:performance.now()-t}},{context:{panel_type:e.panelType,panel_id:String(e.panelId),panel_title:e.panelTitle}})},0)})},[]),null};var he=s(78013),It=s(4405);class ue{constructor(t,i,n){this.logChanges=(a,o)=>{this.logPanelOptionChanges(a,this.initialPanelOptions),this.logFieldConfigChanges(o,this.initialFieldConfig),this.initialPanelOptions=a,this.initialFieldConfig=o},this.logPanelEvent=(a,o,r,l)=>{if(!j.$W.grafanaJavascriptAgent.enabled)return;const c={key:o,newValue:r,oldValue:l??"",panelTitle:this.panelLogInfo.panelTitle,panelId:this.panelLogInfo.panelId,panelType:this.panelLogInfo.panelType};Pt.P.api.pushEvent(a,c)},this.logPanelOptionChanges=(a,o)=>{if(typeof a!="object"||a===null||typeof o!="object"||o===null)return;const r={...o};for(const[l,c]of Object.entries(a)){const u=typeof c!="string"?JSON.stringify(c):c,f=typeof c!="string"?JSON.stringify(r[l]):String(r[l]);r[l]===void 0?this.logPanelEvent(M.NEW_PANEL_OPTION_EVENT,l,u):f!==u&&this.logPanelEvent(M.PANEL_OPTION_CHANGED_EVENT,l,u,f)}},this.logFieldConfigChanges=(a,o)=>{const r=JSON.stringify(o.overrides),l=JSON.stringify(a.overrides);r!==l&&this.logPanelEvent(M.FIELD_CONFIG_OVERRIDES_CHANGED_EVENT,le,l,r);const c={...o.defaults};for(const[f,C]of Object.entries(a.defaults)){if(f===de)continue;const D=typeof C!="string"?JSON.stringify(C):C,b=typeof C!="string"?JSON.stringify(c[f]):String(c[f]);c[f]===void 0?this.logPanelEvent(M.NEW_DEFAULT_FIELD_CONFIG_EVENT,f,D):b!==D&&this.logPanelEvent(M.DEFAULT_FIELD_CONFIG_CHANGED_EVENT,f,D,b)}if(!a.defaults.custom||c.custom===void 0)return;const u={...c.custom};for(const[f,C]of Object.entries(a.defaults.custom)){if(c.custom===null||u[f]===null)continue;const D=typeof C!="string"?JSON.stringify(C):C,b=typeof C!="string"?JSON.stringify(u[f]):String(u[f]);u[f]===void 0?this.logPanelEvent(M.NEW_CUSTOM_FIELD_CONFIG_EVENT,f,D):b!==D&&this.logPanelEvent(M.CUSTOM_FIELD_CONFIG_CHANGED_EVENT,f,D,b)}},this.initialPanelOptions=t,this.initialFieldConfig=i,this.panelLogInfo=n}}const ge="Error in plugin";class pe extends N.PureComponent{constructor(t){super(t),this.timeSrv=(0,p.jG)(),this.subs=new ht.yU,this.eventFilter={onlyLocal:!0},this.panelOptionsLogger=void 0,this.getSync=()=>this.props.isEditing?tt.y.Off:this.props.dashboard.graphTooltip,this.onInstanceStateChange=n=>{this.props.onInstanceStateChange(n),this.setState({context:{...this.state.context,instanceState:n}})},this.onUpdateData=n=>(0,Ct.H)(this.props.panel,n),this.onSeriesColorChange=(n,a)=>{this.onFieldConfigChange(w(n,a,this.props.panel.fieldConfig))},this.onSeriesVisibilityChange=(n,a)=>{this.onFieldConfigChange((0,he.M)(n,a,this.props.panel.fieldConfig,this.state.data.series))},this.onToggleLegendSort=n=>{const a=this.props.panel.options.legend;if(!a)return;let o=a.sortDesc,r=a.sortBy;n!==r&&(o=void 0),o===!1?(r=void 0,o=void 0):(o=!o,r=n),this.onOptionsChange({...this.props.panel.options,legend:{...a,sortBy:r,sortDesc:o}})},this.onRefresh=()=>{const{dashboard:n,panel:a,isInView:o,width:r}=this.props;if(!n.snapshot&&!o){a.refreshWhenInView=!0;return}const l=(0,A.nk)(a,this.timeSrv.timeRange());if(this.wantsQueryExecution){if(r<0)return;a.refreshWhenInView=!1,a.runAllPanelQueries({dashboardUID:n.uid,dashboardTimezone:n.getTimezone(),dashboardTitle:n.title,timeData:l,width:r})}else this.setState({data:{...this.state.data,timeRange:this.timeSrv.timeRange()},renderCounter:this.state.renderCounter+1,liveTime:void 0})},this.onRender=()=>{const n={renderCounter:this.state.renderCounter+1};this.setState(n)},this.onOptionsChange=n=>{this.props.panel.updateOptions(n)},this.onFieldConfigChange=n=>{this.props.panel.updateFieldConfig(n)},this.onPanelError=n=>{j.Ay.featureToggles.panelMonitoring&&this.getPanelContextApp()===U.Jk.PanelEditor&&this.logPanelChangesOnError();const a=n.message||ge;this.state.errorMessage!==a&&this.setState({errorMessage:a})},this.onPanelErrorRecover=()=>{this.setState({errorMessage:void 0})},this.onAnnotationCreate=async n=>{const a=n.from!==n.to,o={dashboardUID:this.props.dashboard.uid,panelId:this.props.panel.id,isRegion:a,time:n.from,timeEnd:a?n.to:0,tags:n.tags,text:n.description};await(0,Z.vJ)(o),(0,m.Dh)().run({dashboard:this.props.dashboard,range:this.timeSrv.timeRange()}),this.state.context.eventBus.publish(new H.We(o))},this.onAnnotationDelete=async n=>{await(0,Z.Xm)({id:n}),(0,m.Dh)().run({dashboard:this.props.dashboard,range:this.timeSrv.timeRange()}),this.state.context.eventBus.publish(new H.We({id:n}))},this.onAnnotationUpdate=async n=>{const a=n.from!==n.to,o={id:n.id,dashboardUID:this.props.dashboard.uid,panelId:this.props.panel.id,isRegion:a,time:n.from,timeEnd:a?n.to:0,tags:n.tags,text:n.description};await(0,Z.rJ)(o),(0,m.Dh)().run({dashboard:this.props.dashboard,range:this.timeSrv.timeRange()}),this.state.context.eventBus.publish(new H.We(o))},this.onChangeTimeRange=n=>{this.timeSrv.setTime({from:(0,B.yT)(n.from),to:(0,B.yT)(n.to)})},this.onAddAdHocFilter=n=>{const{key:a,value:o,operator:r}=n,l=(0,mt.tR)().getInstanceSettings(this.props.panel.datasource),c=l&&(0,ut.p$)(l);c&&(0,z.JD)((0,vt.z_)({datasource:c,key:a,operator:r,value:o}))};const i=t.dashboard.events.newScopedBus(`panel:${t.panel.id}`,this.eventFilter);if(this.debouncedSetPanelAttention=(0,ct.debounce)(this.setPanelAttention.bind(this),100),this.state={isFirstLoad:!0,renderCounter:0,context:{eventsScope:"__global_",eventBus:i,app:this.getPanelContextApp(),sync:this.getSync,onSeriesColorChange:this.onSeriesColorChange,onToggleSeriesVisibility:this.onSeriesVisibilityChange,onAnnotationCreate:this.onAnnotationCreate,onAnnotationUpdate:this.onAnnotationUpdate,onAnnotationDelete:this.onAnnotationDelete,onInstanceStateChange:this.onInstanceStateChange,onToggleLegendSort:this.onToggleLegendSort,canAddAnnotations:t.dashboard.canAddAnnotations.bind(t.dashboard),canEditAnnotations:t.dashboard.canEditAnnotations.bind(t.dashboard),canDeleteAnnotations:t.dashboard.canDeleteAnnotations.bind(t.dashboard),onAddAdHocFilter:this.onAddAdHocFilter,onUpdateData:this.onUpdateData},data:this.getInitialPanelDataState()},j.Ay.featureToggles.panelMonitoring&&this.getPanelContextApp()===U.Jk.PanelEditor){const n={panelId:String(t.panel.id),panelType:t.panel.type,panelTitle:t.panel.title};this.panelOptionsLogger=new ue(t.panel.getOptions(),t.panel.fieldConfig,n)}}getPanelContextApp(){return this.props.isEditing?U.Jk.PanelEditor:this.props.isViewing?U.Jk.PanelViewer:U.Jk.Dashboard}getInitialPanelDataState(){return{state:P.Gu.NotStarted,series:[],timeRange:(0,J.E2)()}}componentDidMount(){const{panel:t,dashboard:i}=this.props;if(this.subs.add(t.events.subscribe(gt._,this.onRefresh)),this.subs.add(t.events.subscribe(yt.XM,this.onRender)),i.panelInitialized(this.props.panel),this.hasPanelSnapshot){this.setState({data:wt(t,i),isFirstLoad:!1});return}this.wantsQueryExecution||this.setState({isFirstLoad:!1}),this.subs.add(t.getQueryRunner().getData({withTransforms:!0,withFieldConfig:!0}).subscribe({next:n=>this.onDataUpdate(n)})),It.a.listen(this)}componentWillUnmount(){this.subs.unsubscribe(),It.a.remove(this)}liveTimeChanged(t){const{data:i}=this.state;if(i.timeRange){const n=t.to.valueOf()-i.timeRange.to.valueOf();if(n<100){console.log("Skip tick render",this.props.panel.title,n);return}}this.setState({liveTime:t})}componentDidUpdate(t){const{isInView:i,width:n,panel:a}=this.props,{context:o}=this.state,r=this.getPanelContextApp();o.app!==r&&this.setState({context:{...o,app:r}}),i!==t.isInView&&i&&a.refreshWhenInView&&this.onRefresh(),n!==t.width&&It.a.updateInterval(this)}onDataUpdate(t){const{dashboard:i,panel:n,plugin:a}=this.props;if(a.meta.skipDataQuery){this.setState({data:this.getInitialPanelDataState()});return}let{isFirstLoad:o}=this.state,r;switch(t.state){case P.Gu.Loading:if(this.state.data.state===P.Gu.Loading)return;break;case P.Gu.Error:const{error:l,errors:c}=t;c?.length?c.length===1?r=c[0].message:r="Multiple errors found. Click for more details":l&&r!==l.message&&(r=l.message);break;case P.Gu.Done:i.snapshot&&(n.snapshotData=t.series.map(u=>(0,et.Kl)(u))),o&&(o=!1);break}this.setState({isFirstLoad:o,errorMessage:r,data:t,liveTime:void 0})}logPanelChangesOnError(){this.panelOptionsLogger.logChanges(this.props.panel.getOptions(),this.props.panel.fieldConfig)}get hasPanelSnapshot(){const{panel:t}=this.props;return t.snapshotData&&t.snapshotData.length}get wantsQueryExecution(){return!(this.props.plugin.meta.skipDataQuery||this.hasPanelSnapshot)}shouldSignalRenderingCompleted(t,i){return t===P.Gu.Done||t===P.Gu.Streaming||t===P.Gu.Error||i.skipDataQuery}skipFirstRender(t){const{isFirstLoad:i}=this.state;return this.wantsQueryExecution&&i&&(t===P.Gu.Loading||t===P.Gu.NotStarted)}renderPanelContent(t,i){const{panel:n,plugin:a,dashboard:o}=this.props,{renderCounter:r,data:l}=this.state,{state:c}=l;if(this.skipFirstRender(c))return null;this.shouldSignalRenderingCompleted(c,a.meta)&&O.E.renderingCompleted();const u=a.panel,f=this.state.liveTime??l.timeRange??this.timeSrv.timeRange(),C=n.getOptions();return this.eventFilter.onlyLocal=o.graphTooltip===0,(0,d.jsx)(d.Fragment,{children:(0,d.jsxs)(pt.XF,{value:this.state.context,children:[(0,d.jsx)(u,{id:n.id,data:l,title:n.title,timeRange:f,timeZone:this.props.dashboard.getTimezone(),options:C,fieldConfig:n.fieldConfig,transparent:n.transparent,width:t,height:i,renderCounter:r,replaceVariables:n.replaceVariables,onOptionsChange:this.onOptionsChange,onFieldConfigChange:this.onFieldConfigChange,onChangeTimeRange:this.onChangeTimeRange,eventBus:o.events}),j.Ay.featureToggles.panelMonitoring&&this.state.errorMessage===void 0&&(0,d.jsx)(ce,{panelType:a.meta.id,panelId:n.id,panelTitle:n.title})]})})}setPanelAttention(){ft.A.publish(new H.Tp({panelId:this.props.panel.id}))}debouncedSetPanelAttention(){}render(){const{dashboard:t,panel:i,width:n,height:a,plugin:o}=this.props,{errorMessage:r,data:l}=this.state,{transparent:c}=i,u=jt({...this.props,data:l}),f=(i.gridPos?.y??0)===0?-16:void 0,C=(0,d.jsx)("div",{"data-testid":"panel-dropdown",children:(0,d.jsx)(re,{panel:i,dashboard:t,loadingState:l.state})});return(0,d.jsx)(W.NR,{width:n,height:a,title:u.title,loadingState:l.state,statusMessage:r,statusMessageOnClick:u.onOpenErrorInspect,description:u.description,titleItems:u.titleItems,menu:this.props.hideMenu?void 0:C,dragClass:u.dragClass,dragClassCancel:"grid-drag-cancel",padding:u.padding,hoverHeaderOffset:f,hoverHeader:u.hasOverlayHeader(),displayMode:c?"transparent":"default",onCancelQuery:u.onCancelQuery,onFocus:()=>this.setPanelAttention(),onMouseEnter:()=>this.setPanelAttention(),onMouseMove:()=>this.debouncedSetPanelAttention(),children:(D,b)=>(0,d.jsx)(d.Fragment,{children:(0,d.jsx)(nt.tH,{dependencies:[l,o,i.getOptions()],onError:this.onPanelError,onRecover:this.onPanelErrorRecover,children:({error:E})=>E?null:this.renderPanelContent(D,b)})})})}}const fe=(e,t)=>{const i=e.panels[t.stateKey];return i?{plugin:i.plugin,instanceState:i.instanceState}:{plugin:void 0}},me={initPanelState:q.Ap,setPanelInstanceState:V.nF},ve=(0,lt.connect)(fe,me);class Ce extends N.PureComponent{constructor(){super(...arguments),this.onInstanceStateChange=t=>{this.props.setPanelInstanceState({key:this.props.stateKey,value:t})},this.onVisibilityChange=t=>{this.props.panel.isInView=t},this.onPanelLoad=()=>{this.props.plugin||this.props.initPanelState(this.props.panel)},this.renderPanel=({isInView:t})=>{const{dashboard:i,panel:n,isViewing:a,isEditing:o,width:r,height:l,plugin:c,timezone:u,hideMenu:f,isDraggable:C=!0}=this.props;return c?(0,d.jsx)(pe,{plugin:c,panel:n,dashboard:i,isViewing:a,isEditing:o,isInView:t,isDraggable:C,width:r,height:l,onInstanceStateChange:this.onInstanceStateChange,timezone:u,hideMenu:f}):null}}static{this.defaultProps={lazy:!0}}componentDidMount(){this.props.panel.isInView=!this.props.lazy,this.props.lazy||this.onPanelLoad()}render(){const{width:t,height:i,lazy:n}=this.props;return n?(0,d.jsx)(S,{width:t,height:i,onChange:this.onVisibilityChange,onLoad:this.onPanelLoad,children:this.renderPanel}):this.renderPanel({isInView:!0})}}const Ee=ve(Ce)},27081:(At,rt,s)=>{s.d(rt,{v:()=>yt});var d=s(92138),N=s(25229),lt=s(57852),q=s(92745),V=s(36490),dt=s(68143),S=s(43173),_=s(6890),ct=s(45229),ht=s(64762),tt=s(83873),U=s(29043),H=s(60017),B=s(48600),ut=s(22429),P=s(75421),J=s(41644),et=s(84019),gt=s(66198),pt=s(17621);function W(m){return async p=>{const x=await tt.IB.getFolderByUid(m);return p((0,pt.jl)(x)),p((0,_.Vz)((0,gt.R4)(x))),x}}var nt=s(79718),ft=s(4590),j=s(99305),O=s(6262),A=s(32380),mt=s(39167),vt=s(93612),Ct=s(95710),st=s(7817),Et=s(83127),w=s(37918);const at="initDashboard";async function k(m,p,x){try{switch(m.routeName){case O.Z4.Home:{const I=(0,J.sP)("v1").getDashboardFromCache(J.m6);if(I)return I;const h=await tt.IB.get("/api/dashboards/home");if((0,O.U)(h)){const F=d.I.stripBaseFromUrl(h.redirectUri);return V.Ny.replace(F),null}return h.meta.canSave=!1,h.meta.canShare=!1,h.meta.canStar=!1,h}case O.Z4.Public:return await B.np.loadDashboard("public",m.urlSlug,m.accessToken);case O.Z4.Normal:{const v=await B.np.loadDashboard(m.urlType,m.urlSlug,m.urlUid);if(v.meta.folderUid)try{await p(W(v.meta.folderUid))}catch(I){console.warn("Error fetching parent folder",v.meta.folderUid,"for dashboard",I)}if(m.fixUrl&&v.meta.url&&!ft._o.state.isPlaying){const I=d.I.stripBaseFromUrl(v.meta.url),h=V.Ny.getLocation().pathname;I!==h&&(V.Ny.replace({...V.Ny.getLocation(),pathname:I}),console.log("not correct url correcting",I,h))}return v}case O.Z4.New:return m.urlFolderUid&&await p(W(m.urlFolderUid)),await(0,et.X)(m.urlFolderUid);default:throw{message:"Unknown route "+m.routeName}}}catch(v){return(0,dt.NF)(v)&&v.cancelled||(p((0,w.ig)({message:(0,q.t)("dashboard.fetch-dashboard.message.failed-to-fetch-dashboard","Failed to fetch dashboard"),error:v})),console.error(v)),null}}const z=(m,p={})=>(m.forEach(x=>{x.panels?z(x.panels,p):x.targets&&x.targets.forEach(v=>{v.datasource?.type&&(p[v.datasource.type]?p[v.datasource.type].push(v):p[v.datasource.type]=[v])})}),p);function yt(m){return async(p,x)=>{(0,H.j)(at),p((0,w.xS)());const v=await k(m,p,x),I=v?.dashboard?.version;if(!v)return;Z(v),p((0,w.X1)());let h;try{h=new st.G(v.dashboard,v.meta)}catch(G){p((0,w.ig)({message:(0,q.t)("dashboard.init-dashboard.message.failed-create-dashboard-model","Failed create dashboard model"),error:G})),console.error(G);return}const F=x(),$=V.Ny.getSearchObject();$.orgId||V.Ny.partial({orgId:F.user.orgId},!0);const R=(0,P.jG)();(0,ut.UA)().setCurrent(h),R.init(h);const X=(0,j.q4)(m.urlUid??h.uid);if(await p((0,mt._q)(X,h)),(0,A.nm)({dashboard:h,timeSrv:R}).run({dashboard:h,range:R.timeRange()}),(0,vt.Tk)(x())!==X||x().dashboard.initPhase!==O._g.Services)return;try{h.processRepeats(),$.autofitpanels&&h.autoFitPanels(window.innerHeight,$.kiosk),S.$.publicDashboardAccessToken||m.keybindingSrv.setupDashboardBindings(h)}catch(G){G instanceof Error&&p((0,_.dx)((0,ht.gi)("Dashboard init failed",G))),console.error(G)}m.routeName!==O.Z4.New?((0,Et.B)(h),nt.t.watch(h.uid)):nt.t.leave(),h.weekStart!==""&&h.weekStart!==void 0?(0,N.$D)(h.weekStart):(0,N.$D)(S.$.bootData.user.weekStart),ct.A.publish(new lt.gc({dashboardId:h.uid,orgId:F.user.orgId,userId:F.user.user?.id,grafanaVersion:S.$.buildInfo.version,queries:z(h.panels)}));const Y=(0,H.z)(at);(0,Ct.dM)(h,Y?.duration,I),p((0,w.O9)(h))}}function Z(m){const p=U.A.getObject(O.us);p&&(p.dashboard.panels&&(m.dashboard.panels=p.dashboard.panels.concat(m.dashboard.panels)),p.dashboard.time&&(m.dashboard.time=p.dashboard.time),U.A.delete(O.us))}}}]);

//# sourceMappingURL=6088.84a1c67bb25da20af520.js.map