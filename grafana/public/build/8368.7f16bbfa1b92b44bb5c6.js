"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[8368],{78368:(Be,te,n)=>{n.d(te,{q:()=>ut,g:()=>Ie});var l=n(74848),y=n(22803),ne=n(2543),o=n(96540),U=n(50832),oe=n(75505),V=n(739),M=n(67770),L=n(57852),c=n(1906),$e=n(28105),Ne=n(83175),W=n(25229),We=n(17548),qe=n(92745),Ke=n(75234),B=n(43173),ze=n(63142),Ge=n(64400),Qe=n(92807),Xe=n(78529),Ye=n(44376),Ze=n(17896),_e=n(27789),et=n(49356),tt=n(88642),nt=n(23235),je=n(71673),ot=n(59896),st=n(48575),se=n(37234);function re(e){return typeof e=="function"}function ae(e){return typeof e=="function"}function le(e){return typeof e=="function"}function ie(e){return typeof e=="function"}function ce(e){return typeof e=="function"}function rt(e){return typeof e=="function"}function at(e){return typeof e=="function"}function lt(e){return typeof e=="function"}function Te(e){return typeof e=="function"}function q(e){return Array.isArray(e)&&e.every(o.isValidElement)}function de(e){const r=Object.values(c.Jk).map(p=>p.toString());return typeof e=="string"&&r.includes(e)}function it(e){return Array.isArray(e)&&e.every(r=>"divider"in r||"onClick"in r&&"label"in r)}var ct=n(24567);const dt={},ut=({data:e,timeZone:r,fieldConfig:p,options:{showControls:P,controlsStorageKey:v,showLabels:k,showTime:O,wrapLogMessage:j,showCommonLabels:T,prettifyLogMessage:E,sortOrder:d,dedupStrategy:C,enableLogDetails:fe,showLogContextToggle:Ae,onClickFilterLabel:I,onClickFilterOutLabel:A,onClickFilterOutString:D,onClickFilterString:H,onLogOptionsChange:K,isFilterLabelActive:J,logRowMenuIconsBefore:z,logRowMenuIconsAfter:G,logLineMenuCustomItems:De,enableInfiniteScrolling:$,onNewLogsReceived:ge,fontSize:vt,syntaxHighlighting:mt,detailsMode:pt,...S},id:ve})=>{const g=d===V.uH.Ascending,b=(0,ze.of)(ft),me=(0,o.useRef)(null),[Q,He]=(0,o.useState)(null),[i,pe]=(0,o.useState)(null),[u,X]=(0,o.useState)(S.displayedFields??[]),[Ce,Je]=(0,o.useState)(!1),he=(0,o.useRef)(!1),[s,be]=(0,o.useState)(e),h=(0,ct.O)(s.request?.targets),F=(0,o.useRef)(null);let N=(0,o.useRef)();const{app:x,eventBus:Y,onAddAdHocFilter:w}=(0,Ge.d2)();(0,o.useEffect)(()=>{(0,Ke.J7)().publish(new M.Df({order:d}))},[d]);const ye=(0,o.useCallback)(t=>{t&&Y.publish(new L.b_({point:{time:t.timeEpochMs}}))},[Y]),Le=(0,o.useCallback)(()=>{Y.publish(new L.ql)},[Y]),Ct=(0,o.useCallback)(()=>{He(null),N.current&&N.current()},[N]),xe=(0,o.useCallback)((t,a)=>{He(t),N.current=a},[N]),Pe=(0,o.useCallback)(t=>{if(!t.dataFrame.refId||!h||!Ae&&s.request?.app!==c.Jk.Dashboard&&s.request?.app!==c.Jk.PanelEditor&&s.request?.app!==c.Jk.PanelViewer)return!1;const a=h.get(t.dataFrame.refId);return(0,M.Ol)(a)},[h,Ae,s.request?.app]),we=(0,o.useCallback)(()=>!(s.request?.app!==c.Jk.Dashboard&&s.request?.app!==c.Jk.PanelEditor&&s.request?.app!==c.Jk.PanelViewer),[s.request?.app]),ht=(0,o.useCallback)(async(t,a,f)=>{if(!a.dataFrame.refId||!h)return Promise.resolve({data:[]});const m=s.request?.targets[0];if(!m)return Promise.resolve({data:[]});const ee=h.get(a.dataFrame.refId);return(0,M.Ol)(ee)?(f.scopedVars=s.request?.scopedVars,ee.getLogRowContext(t,f,m)):Promise.resolve({data:[]})},[s.request?.targets,s.request?.scopedVars,h]),yt=(0,o.useCallback)((t,a)=>{if(!t.dataFrame.refId||!h)return(0,l.jsx)(l.Fragment,{});const f=s.request?.targets[0];if(!f)return(0,l.jsx)(l.Fragment,{});const m=h.get(t.dataFrame.refId);return(0,M.wj)(m)?m.getLogRowContextUi?m.getLogRowContextUi(t,a,f,s.request?.scopedVars):(0,l.jsx)(l.Fragment,{}):(0,l.jsx)(l.Fragment,{})},[s.request?.targets,s.request?.scopedVars,h]),[R,Z,Ue]=(0,o.useMemo)(()=>{const t=s?(0,se.HT)(s.series,s.request?.intervalMs,void 0,s.request?.targets,!!$):null,a=t?.rows||[],f=t?.meta?.find(ee=>ee.label===se.yR),m=(0,se.M0)(a,C);return[a,m,f]},[C,$,s]),Se=(0,o.useCallback)(async t=>await gt(t,R,s.timeRange),[s.timeRange,R]);(0,o.useEffect)(()=>{e.state!==$e.Gu.Loading&&be(e)},[e]),(0,o.useLayoutEffect)(()=>{if(!B.$.featureToggles.newLogsPanel){if(!me.current||!i||F.current){F.current=F.current==="infinite-scroll"?null:F.current;return}(s.request?.app===c.Jk.Dashboard||s.request?.app===c.Jk.PanelEditor)&&i.scrollTo(0,g?me.current.scrollHeight:0)}},[s.request?.app,g,i,R]);const Fe=(0,o.useCallback)((t,a,f,m)=>(0,Xe.QL)({field:t,rowIndex:a,range:s.timeRange,dataFrame:f,vars:m}),[s]),Ve=(0,o.useCallback)(t=>{i?.scrollTo({top:t.offsetTop,behavior:"smooth"})},[i]),Lt=(0,o.useCallback)((t,a)=>{w?.({key:t,value:a,operator:"="})},[w]),xt=(0,o.useCallback)((t,a)=>{w?.({key:t,value:a,operator:"!="})},[w]),Pt=(0,o.useCallback)(t=>{u?.indexOf(t)===-1&&X(u?.concat(t))},[u]),St=(0,o.useCallback)(t=>{const a=u?.indexOf(t);a!==void 0&&a>-1&&X(u?.filter(f=>t!==f))},[u]);(0,o.useEffect)(()=>{S.displayedFields&&X(S.displayedFields)},[S.displayedFields]),(0,o.useEffect)(()=>{function t(){if(!i)return;F.current="user";const a=i.scrollHeight-i.scrollTop-i.clientHeight===0;(i.scrollTop===0&&!g||a&&g)&&(F.current=null)}return i?.addEventListener("scroll",t),i?.addEventListener("wheel",t),()=>{i?.removeEventListener("scroll",t),i?.removeEventListener("wheel",t)}},[g,i]);const Re=(0,o.useCallback)(async t=>{if(!e.request||!B.$.featureToggles.logsInfiniteScrolling||he.current)return;he.current=!0,Je(!0);const a=lt(ge)?ge:void 0;let f=[];try{f=await Ie(h,s,t,r,a)}catch(m){console.error(m)}finally{Je(!1),he.current=!1}F.current="infinite-scroll",be({...s,series:f})},[e.request,h,ge,s,r]),_=()=>(0,l.jsxs)("div",{className:(0,y.cx)(b.labelContainer,g&&b.labelContainerAscending),children:[(0,l.jsx)("span",{className:b.label,children:(0,l.jsx)(qe.x6,{i18nKey:"logs.logs-panel.render-common-labels.common-labels",children:"Common labels:"})}),(0,l.jsx)(ot.h,{labels:typeof Ue?.value=="object"?Ue?.value:dt,emptyMessage:"(no common labels)"})]}),Ft=(0,o.useMemo)(()=>(x===c.Jk.Dashboard||x===c.Jk.PanelEditor)&&d===V.uH.Ascending?"bottom":"top",[x,d]),Rt=(0,o.useMemo)(()=>{if(v)return v;if(e.request)return`${e.request?.dashboardUID}.${ve}`},[v,e.request,ve]);if(!e||R.length===0)return(0,l.jsx)(tt.a,{fieldConfig:p,panelId:ve,data:e,needsStringField:!0});const ke=w?Lt:void 0,Ee=w?xt:void 0,Me=rt(S.onClickShowField)?S.onClickShowField:Pt,Oe=at(S.onClickHideField)?S.onClickHideField:St;return(0,l.jsxs)(l.Fragment,{children:[Q&&(0,l.jsx)(_e.V,{open:Q!==null,row:Q,onClose:Ct,getRowContext:(t,a)=>ht(t,Q,a),logsSortOrder:d,timeZone:r,getLogRowContextUi:yt}),B.$.featureToggles.newLogsPanel&&(0,l.jsx)("div",{onMouseLeave:Le,className:b.logListContainer,ref:t=>pe(t),children:Z.length>0&&i&&(0,l.jsx)(et.Z,{app:de(x)?x:c.Jk.Dashboard,containerElement:i,dedupStrategy:C,detailsMode:pt,displayedFields:u,enableLogDetails:fe,fontSize:vt,getFieldLinks:Fe,isLabelFilterActive:ce(J)?J:void 0,initialScrollPosition:Ft,loading:Ce,logLineMenuCustomItems:it(De)?De:void 0,logs:Z,logSupportsContext:Pe,loadMore:$?Re:void 0,onClickFilterLabel:re(I)?I:ke,onClickFilterOutLabel:ae(A)?A:Ee,onClickFilterString:le(H)?H:void 0,onClickFilterOutString:ie(D)?D:void 0,onClickShowField:u!==void 0?Me:void 0,onClickHideField:u!==void 0?Oe:void 0,onLogLineHover:ye,onLogOptionsChange:Te(K)?K:void 0,onOpenContext:xe,onPermalinkClick:we()?Se:void 0,permalinkedLogId:ue()?.logs?.id??void 0,setDisplayedFields:X,showControls:!!P,showTime:O,sortOrder:d,logOptionsStorageKey:Rt,syntaxHighlighting:mt,timeRange:e.timeRange,timeZone:r,wrapLogMessage:j})}),!B.$.featureToggles.newLogsPanel&&!P&&(0,l.jsx)(Qe.P,{ref:t=>pe(t),children:(0,l.jsxs)("div",{onMouseLeave:Le,className:b.container,ref:me,children:[T&&!g&&_(),(0,l.jsx)(Ze.u8,{loading:Ce,loadMoreLogs:$?Re:void 0,range:e.timeRange,timeZone:r,rows:R,scrollElement:i,sortOrder:d,children:(0,l.jsx)(st.k,{scrollElement:i,scrollIntoView:Ve,permalinkedRowId:ue()?.logs?.id??void 0,onPermalinkClick:we()?Se:void 0,logRows:R,showContextToggle:Pe,deduplicatedRows:Z,dedupStrategy:C,showLabels:k,showTime:O,wrapLogMessage:j,prettifyLogMessage:E,timeZone:r,getFieldLinks:Fe,logsSortOrder:d,enableLogDetails:fe,previewLimit:g?R.length:void 0,onLogRowHover:ye,app:de(x)?x:c.Jk.Dashboard,onOpenContext:xe,onClickFilterLabel:re(I)?I:ke,onClickFilterOutLabel:ae(A)?A:Ee,onClickFilterString:le(H)?H:void 0,onClickFilterOutString:ie(D)?D:void 0,isFilterLabelActive:ce(J)?J:void 0,displayedFields:u,onClickShowField:u!==void 0?Me:void 0,onClickHideField:u!==void 0?Oe:void 0,logRowMenuIconsBefore:q(z)?z:void 0,logRowMenuIconsAfter:q(G)?G:void 0,renderPreview:!g})}),T&&g&&_()]})}),!B.$.featureToggles.newLogsPanel&&P&&(0,l.jsxs)("div",{onMouseLeave:Le,className:b.controlledLogsContainer,children:[T&&!g&&_(),(0,l.jsx)(Ye.U,{ref:t=>pe(t),visualisationType:"logs",loading:Ce,loadMoreLogs:$?Re:void 0,range:e.timeRange,logRows:R,deduplicatedRows:Z,dedupStrategy:C,onClickFilterLabel:re(I)?I:ke,onClickFilterOutLabel:ae(A)?A:Ee,showContextToggle:Pe,showLabels:k,showTime:O,enableLogDetails:fe,wrapLogMessage:j,prettifyLogMessage:E,timeZone:r,getFieldLinks:Fe,logsSortOrder:d,displayedFields:u,onClickShowField:u!==void 0?Me:void 0,onClickHideField:u!==void 0?Oe:void 0,app:de(x)?x:c.Jk.Dashboard,onLogRowHover:ye,onOpenContext:xe,onPermalinkClick:Se,permalinkedRowId:ue()?.logs?.id??void 0,scrollIntoView:Ve,isFilterLabelActive:ce(J)?J:void 0,onClickFilterString:le(H)?H:void 0,onClickFilterOutString:ie(D)?D:void 0,logRowMenuIconsBefore:q(z)?z:void 0,logRowMenuIconsAfter:q(G)?G:void 0,onLogOptionsChange:Te(K)?K:void 0,logOptionsStorageKey:v,renderPreview:!g}),T&&g&&_()]})]})},ft=e=>({container:(0,y.css)({marginBottom:e.spacing(1.5)}),logListContainer:(0,y.css)({minHeight:"100%",maxHeight:"100%",display:"flex",flex:1,flexDirection:"column"}),controlledLogsContainer:(0,y.css)({height:"100%"}),labelContainer:(0,y.css)({margin:e.spacing(0,0,.5,.5),display:"flex",alignItems:"center"}),labelContainerAscending:(0,y.css)({margin:e.spacing(.5,0,.5,0)}),label:(0,y.css)({marginRight:e.spacing(.5),fontSize:e.typography.bodySmall.fontSize,fontWeight:e.typography.fontWeightMedium})});function ue(){const r=Ne.kM.getUrlSearchParams()?.panelState;if(r&&Array.isArray(r)&&r?.length>0&&typeof r[0]=="string")try{return JSON.parse(r[0])}catch(p){console.error("error parsing logsPanelState",p)}}async function gt(e,r,p){if(e.rowId===void 0||!e.dataFrame.refId)return;const P={logs:{id:e.uid}},v=new URL(window.location.href);v.searchParams.set("panelState",JSON.stringify(P));const k=(0,je.sU)(e,r,{from:(0,W.yT)(p.from).valueOf(),to:(0,W.yT)(p.to).valueOf()});return v.searchParams.set("from",k.from.toString()),v.searchParams.set("to",k.to.toString()),await(0,je.VP)(v.toString()),Promise.resolve()}async function Ie(e,r,p,P,v){if(!r.request)return[];const k=We.convertRawToRange({from:(0,W.oZ)(P,p.from),to:(0,W.oZ)(P,p.to)}),O=(0,ne.groupBy)(r.request.targets,"datasource.uid"),j=[];for(const d in O){const C=e.get(r.request.targets[0].refId);if(!C){console.warn(`Could not resolve data source for target ${r.request.targets[0].refId}`);continue}j.push(C.query({...r.request,range:k,targets:O[d]}))}const T=await Promise.all(j);let E=r.series;for(const d of T){const C=(0,U.A)(d)?await(0,oe.s)(d):d;E=(0,nt.Wn)({data:E},{data:C.data}).data,v&&v(E,C.data)}return E}},24567:(Be,te,n)=>{n.d(te,{O:()=>o});var l=n(96540),y=n(16817),ne=n(78282);const o=U=>{const[oe,V]=(0,l.useState)(new Map);return(0,y.A)(async()=>{if(!U){V(new Map);return}const M=await Promise.all(U.filter(L=>!!L.datasource?.uid).map(L=>(0,ne.l)().get(L.datasource?.uid).then(c=>({key:L.refId,ds:c}))));V(new Map(M.map(({key:L,ds:c})=>[L,c])))},[U]),oe}}}]);

//# sourceMappingURL=8368.7f16bbfa1b92b44bb5c6.js.map