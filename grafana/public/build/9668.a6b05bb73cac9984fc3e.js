"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[9668],{25471:(ve,_,a)=>{a.d(_,{A:()=>x});var e=a(74848),n=a(22803),R=a(1932),p=a(96540),g=a(49785),F=a(42941),o=a(92745),N=a(63142),w=a(41654),M=a(66404),B=a(63527),L=a(87105),Q=a(37386),K=a(45861),h=a(95443),ne=a(29609);const J=({field:t})=>{const s=(0,N.of)(Z);return(0,e.jsxs)("div",{children:[(0,e.jsx)("span",{className:s.annotationTitle,children:(0,e.jsx)(o.x6,{i18nKey:"alerting.custom-annotation-header-field.custom-annotation-name-and-content",children:"Custom annotation name and content"})}),(0,e.jsx)(B.p,{placeholder:(0,o.t)("alerting.custom-annotation-header-field.placeholder-enter-custom-annotation-name","Enter custom annotation name..."),width:18,...t,className:s.customAnnotationInput})]})},Z=t=>({annotationTitle:(0,n.css)({color:t.colors.text.primary,marginBottom:"3px"}),customAnnotationInput:(0,n.css)({marginTop:"5px",width:"100%"})}),m=J,D=({annotationField:t,annotations:s,annotation:d,index:b,labelId:f})=>{const{control:l}=(0,g.xW)();return(0,e.jsxs)(w.B,{direction:"column",gap:0,children:[(0,e.jsx)("label",{htmlFor:f,children:(0,e.jsx)(g.xI,{name:`annotations.${b}.key`,defaultValue:t.key,render:({field:{ref:u,...v}})=>{if(!h.J3[d])return(0,e.jsx)(m,{field:v});let y;switch(t.key){case h.YH.dashboardUID:y="Dashboard and panel";break;case h.YH.panelID:y="";break;default:y=h.J3[d]&&h.J3[d]+" (optional)"}return(0,e.jsx)("span",{"data-testid":`annotation-key-${b}`,children:(0,e.jsx)(M.E,{color:"primary",variant:"bodySmall",children:y})})},control:l,rules:{required:{value:!!s[b]?.value,message:(0,o.t)("alerting.annotation-header-field.message.required","Required.")}}})}),(0,e.jsx)(M.E,{variant:"bodySmall",color:"secondary",children:h.H8[d]})]})};var c=a(30703),C=a(77256);const P=({dashboard:t,panel:s,dashboardUid:d,panelId:b,onEditClick:f,onDeleteClick:l})=>{const u=(0,N.of)(k),v=(0,C.JM)(t?.uid||d),y=(0,C.D2)(t?.uid||d,s?.id?.toString()||b);return(0,e.jsxs)("div",{className:u.container,children:[t&&(0,e.jsxs)("a",{href:v,className:u.link,target:"_blank",rel:"noreferrer","data-testid":"dashboard-annotation",children:[t.title," ",(0,e.jsx)(c.I,{name:"external-link-alt"})]}),!t&&(0,e.jsx)(M.E,{color:"secondary",children:(0,e.jsxs)(o.x6,{i18nKey:"alerting.annotations.dashboard-annotation-field.dashboard",values:{dashboardUid:d},children:["Dashboard ",{dashboardUid:d}]})}),s&&(0,e.jsxs)("a",{href:y,className:u.link,target:"_blank",rel:"noreferrer","data-testid":"panel-annotation",children:[s.title||"<No title>"," ",(0,e.jsx)(c.I,{name:"external-link-alt"})]}),!s&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)("span",{children:" - "}),(0,e.jsx)(M.E,{color:"secondary",children:(0,e.jsxs)(o.x6,{i18nKey:"alerting.annotations.dashboard-annotation-field.panel",values:{panelId:b},children:["Panel ",{panelId:b}]})})]}),(t||s)&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(c.I,{name:"pen",onClick:f,className:u.icon}),(0,e.jsx)(c.I,{name:"trash-alt",onClick:l,className:u.icon})]})]})},k=t=>({container:(0,n.css)({marginTop:"5px"}),noLink:(0,n.css)({color:t.colors.text.secondary}),link:(0,n.css)({color:t.colors.text.link,marginRight:t.spacing(1.5)}),icon:(0,n.css)({marginRight:t.spacing(1),cursor:"pointer"})}),H=P;var ce=a(2543),Te=a(40996),ue=a(70713),be=a(97222),ye=a(45967),je=a(22787),De=a(34999),ge=a(12737),Se=a(6975),oe=a(5709);const he=oe.H.injectEndpoints({endpoints:t=>({search:t.query({query:({query:s})=>{const d=new URLSearchParams({type:"dash-db",limit:"1000",page:"1",sort:"name_sort"});return s&&d.set("query",s),{url:`/api/search?${d.toString()}`}}}),dashboard:t.query({query:({uid:s})=>({url:`/api/dashboards/uid/${s}`})})})});var Me=a(41811),pe=a(7817);const Be=(0,Me.default)(t=>{const{dashboard:s,meta:d}=structuredClone(t);return new pe.G(s,d)});function Ie(t){return he.endpoints.dashboard.useQuery({uid:t??""},{skip:!t,selectFromResult:({currentData:d,data:b,...f})=>({dashboardModel:d?Be(d):void 0,...f})})}function Oe(t,s){return t.title&&s.title?t.title.localeCompare(s.title):t.title&&!s.title?1:!t.title&&s.title?-1:0}const Ne=({dashboardUid:t,panelId:s,isOpen:d,onChange:b,onDismiss:f})=>{const l=(0,N.of)(fe),[u,v]=(0,p.useState)(t),[y,W]=(0,p.useState)(s),[ee,le]=(0,p.useState)(""),[re,V]=(0,p.useState)(""),[G,X]=(0,p.useState)(""),{useSearchQuery:$}=he,{currentData:A=[],isFetching:O}=$({query:re}),{dashboardModel:U,isFetching:z}=Ie(u),q=(0,p.useCallback)(I=>{v(I),W(void 0)},[]),Ee=me(U),Le=Ee.filter(I=>I.title?.toLowerCase().includes(G.toLowerCase())).sort(Oe)??[],xe=Ee.find(I=>Ce(I)&&I.id?.toString()===y),de=(0,p.useMemo)(()=>A.map(I=>I.uid).indexOf(u??""),[A,u]),E=t&&t===u,T=de>=0,te=(0,p.useCallback)(I=>{const ae=de>=0;E&&ae&&I?.scrollToItem(de,"smart")},[E,de]);(0,Te.A)(()=>{V(ee)},500,[ee]);const se=({index:I,style:ae})=>{const Y=A[I],Re=u===Y.uid;return(0,e.jsxs)("button",{type:"button",title:Y.title,style:ae,className:(0,n.cx)(l.rowButton,{[l.rowOdd]:I%2===1,[l.rowSelected]:Re}),onClick:()=>q(Y.uid),children:[(0,e.jsx)("div",{className:(0,n.cx)(l.dashboardTitle,l.rowButtonTitle),children:Y.title}),(0,e.jsxs)("div",{className:l.dashboardFolder,children:[(0,e.jsx)(c.I,{name:"folder"})," ",Y.folderTitle??"Dashboards"]})]})},ie=({index:I,style:ae})=>{const Y=Le[I],Re=Y.title||"<No title>",Fe=!!Y.id&&y===Y.id,we=Y.type==="graph"||Y.type==="timeseries",Pe=!Ce(Y);return(0,e.jsxs)("button",{type:"button",style:ae,disabled:Pe,className:(0,n.cx)(l.rowButton,l.panelButton,{[l.rowOdd]:I%2===1,[l.rowSelected]:Fe}),onClick:()=>Pe?ce.noop:W(Y.id),children:[(0,e.jsx)("div",{className:l.rowButtonTitle,title:Re,children:Re}),!we&&!Pe&&(0,e.jsx)(ye.m,{content:(0,o.t)("alerting.dashboard-picker.panel-row.tooltip-alert-tab-support","The alert tab and alert annotations are only supported on graph and timeseries panels."),children:(0,e.jsx)(c.I,{name:"exclamation-triangle",className:l.warnIcon,"data-testid":"warning-icon"})}),Pe&&(0,e.jsx)(ye.m,{content:(0,o.t)("alerting.dashboard-picker.panel-row.content-panel-valid-identifier","This panel does not have a valid identifier."),children:(0,e.jsx)(c.I,{name:"info-circle","data-testid":"info-icon"})})]})},Ae=(0,o.t)("alerting.dashboard-picker.fallback-dashboards-string","Dashboards");return(0,e.jsxs)(je.a,{title:(0,o.t)("alerting.dashboard-picker.title-select-dashboard-and-panel","Select dashboard and panel"),closeOnEscape:!0,isOpen:d,onDismiss:f,className:l.modal,contentClassName:l.modalContent,children:[!T&&t&&U&&(0,e.jsxs)(De.F,{title:(0,o.t)("alerting.dashboard-picker.title-current-selection","Current selection"),severity:"info",topSpacing:0,bottomSpacing:1,className:l.modalAlert,children:[(0,e.jsx)("div",{children:(0,e.jsxs)(o.x6,{i18nKey:"alerting.dashboard-picker.current-selection-dashboard",values:{dashboardTitle:U.title,dashboardUid:U.uid,folderTitle:U.meta?.folderTitle??Ae},children:["Dashboard: ","{{dashboardTitle}}"," (","{{ dashboardUid }}",") in folder ","{{ folderTitle }}"]})}),xe&&(0,e.jsx)("div",{children:(0,e.jsxs)(o.x6,{i18nKey:"alerting.dashboard-picker.current-selection-panel",values:{panelTitle:xe.title,panelId:xe.id},children:["Panel: ","{{ panelTitle }}"," (","{{ panelId }}",")"]})})]}),(0,e.jsxs)("div",{className:l.container,children:[(0,e.jsx)(ge.Z,{value:ee,onChange:le,title:(0,o.t)("alerting.dashboard-picker.title-search-dashboard","Search dashboard"),placeholder:(0,o.t)("alerting.dashboard-picker.placeholder-search-dashboard","Search dashboard"),autoFocus:!0}),(0,e.jsx)(ge.Z,{value:G,onChange:X,title:(0,o.t)("alerting.dashboard-picker.title-search-panel","Search panel"),placeholder:(0,o.t)("alerting.dashboard-picker.placeholder-search-panel","Search panel")}),(0,e.jsxs)("div",{className:l.column,children:[O&&(0,e.jsx)(Se._,{text:(0,o.t)("alerting.dashboard-picker.text-loading-dashboards","Loading dashboards..."),className:l.loadingPlaceholder}),!O&&(0,e.jsx)(ue.Ay,{children:({height:I,width:ae})=>(0,e.jsx)(be.Y1,{ref:te,itemSize:50,height:I,width:ae,itemCount:A.length,children:se})})]}),(0,e.jsxs)("div",{className:l.column,children:[!u&&!z&&(0,e.jsx)("div",{className:l.selectDashboardPlaceholder,children:(0,e.jsx)("div",{children:(0,e.jsx)(o.x6,{i18nKey:"alerting.dashboard-picker.select-dashboard-available-panels",children:"Select a dashboard to get a list of available panels"})})}),z&&(0,e.jsx)(Se._,{text:(0,o.t)("alerting.dashboard-picker.text-loading-dashboard","Loading dashboard..."),className:l.loadingPlaceholder}),u&&!z&&(0,e.jsx)(ue.Ay,{children:({width:I,height:ae})=>(0,e.jsx)(be.Y1,{itemSize:32,height:ae,width:I,itemCount:Le.length,children:ie})})]})]}),(0,e.jsxs)(je.a.ButtonRow,{children:[(0,e.jsx)(K.$n,{type:"button",variant:"secondary",onClick:f,fill:"text",children:(0,e.jsx)(o.x6,{i18nKey:"alerting.common.cancel",children:"Cancel"})}),(0,e.jsx)(K.$n,{type:"button",variant:"primary",disabled:!(u&&y),onClick:()=>{u&&y&&b(u,y)},children:(0,e.jsx)(o.x6,{i18nKey:"alerting.dashboard-picker.confirm",children:"Confirm"})})]})]})};function me(t){if(!t)return[];const s=t.panels.filter(f=>f.type!=="row"),d=t.panels.filter(f=>f.collapsed).flatMap(f=>f.panels??[]);return[...s,...d]}const Ce=t=>{const s=typeof t.id=="number",d=typeof t.type=="string",b="libraryPanel"in t;return s&&(d||b)},fe=t=>{const s=(0,K.my)(t);return{container:(0,n.css)({display:"grid",gridTemplateColumns:"1fr 1fr",gridTemplateRows:"min-content auto",gap:t.spacing(2),flex:1}),column:(0,n.css)({flex:"1 1 auto"}),dashboardTitle:(0,n.css)({height:"22px",fontWeight:t.typography.fontWeightBold}),dashboardFolder:(0,n.css)({height:"20px",fontSize:t.typography.bodySmall.fontSize,color:t.colors.text.secondary,display:"flex",flexDirection:"row",justifyContent:"flex-start",columnGap:t.spacing(1),alignItems:"center"}),rowButton:(0,n.css)(s,{padding:t.spacing(.5),overflow:"hidden",textOverflow:"ellipsis",textAlign:"left",whiteSpace:"nowrap",cursor:"pointer",border:"2px solid transparent","&:disabled":{cursor:"not-allowed",color:t.colors.text.disabled}}),rowButtonTitle:(0,n.css)({textOverflow:"ellipsis",overflow:"hidden"}),rowSelected:(0,n.css)({borderColor:t.colors.primary.border}),rowOdd:(0,n.css)({backgroundColor:t.colors.background.secondary}),panelButton:(0,n.css)({display:"flex",gap:t.spacing(1),justifyContent:"space-between",alignItems:"center"}),loadingPlaceholder:(0,n.css)({height:"100%",display:"flex",justifyContent:"center",alignItems:"center"}),selectDashboardPlaceholder:(0,n.css)({width:"100%",height:"100%",display:"flex",flexDirection:"column",justifyContent:"center",textAlign:"center",fontWeight:t.typography.fontWeightBold}),modal:(0,n.css)({height:"100%"}),modalContent:(0,n.css)({flex:1,display:"flex",flexDirection:"column"}),modalAlert:(0,n.css)({flexGrow:0}),warnIcon:(0,n.css)({fill:t.colors.warning.main})}};var ke=a(25521),r=a(58872);const i=()=>{const t=(0,N.of)(S),[s,d]=(0,F.A)(!1),{control:b,register:f,watch:l,formState:{errors:u},setValue:v}=(0,g.xW)(),y=l("annotations"),W=l("type"),{fields:ee,append:le,remove:re}=(0,g.jz)({control:b,name:"annotations"}),V=y.find(E=>E.key===h.YH.dashboardUID)?.value,G=Number(y.find(E=>E.key===h.YH.panelID)?.value),[X,$]=(0,p.useState)(void 0),[A,O]=(0,p.useState)(void 0),{dashboardModel:U,isFetching:z}=Ie(V);(0,p.useEffect)(()=>{if(z||!U)return;$(U);const T=me(U).find(te=>te.id===G);O(T)},[G,U,z]);const q=(E,T)=>{const te=(0,R.jM)(y,se=>{const ie=se.find(I=>I.key===h.YH.dashboardUID),Ae=se.find(I=>I.key===h.YH.panelID);ie?ie.value=E:se.push({key:h.YH.dashboardUID,value:E}),Ae?Ae.value=T.toString():se.push({key:h.YH.panelID,value:T.toString()})});v("annotations",te),d(!1)},Ee=()=>{const E=y.filter(T=>T.key!==h.YH.dashboardUID&&T.key!==h.YH.panelID);v("annotations",E),$(void 0),O(void 0)},Le=()=>{d(!0)};function xe(){return(0,e.jsxs)(w.B,{direction:"row",gap:.5,alignItems:"center",children:[(0,e.jsx)(M.E,{variant:"bodySmall",color:"secondary",children:(0,e.jsx)(o.x6,{i18nKey:"alerting.annotations.description",children:"Add more context to your alert notifications."})}),(0,e.jsx)(ke.G,{externalLink:"https://grafana.com/docs/grafana/latest/alerting/fundamentals/alert-rules/annotation-label/#annotations",linkText:"Read about annotations",contentText:(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)("p",{children:(0,o.t)("alerting.rule-form.annotations.description1","Annotations add additional information to alerts, helping alert responders identify and address potential issues.")}),(0,e.jsx)("p",{children:(0,o.t)("alerting.rule-form.annotations.description2","For example, add a Summary annotation to tell you which value caused the alert to fire or which server it happened on.")}),(0,o.t)("alerting.rule-form.annotations.description3","Annotations can contain a combination of text and template code, which is used to include data from queries.")]}),title:(0,o.t)("alerting.annotations-step.get-annotations-section-description.title-annotations","Annotations")})]})}const de=(0,ne.H2)(W)?6:5;return(0,e.jsx)(r.P,{stepNo:de,title:(0,o.t)("alerting.annotations.title","Configure notification message"),description:xe(),fullWidth:!0,children:(0,e.jsxs)(w.B,{direction:"column",gap:1,children:[ee.map((E,T)=>{const te=y[T]?.key?.toLocaleLowerCase().endsWith("url"),se=te?B.p:L.f,ie=E.key;return(0,e.jsx)("div",{className:t.flexRow,children:(0,e.jsxs)("div",{children:[(0,e.jsx)(D,{annotationField:E,annotations:y,annotation:ie,index:T,labelId:`annotation-${T}`}),V&&G&&E.key===h.YH.dashboardUID&&(0,e.jsx)(H,{dashboard:X,panel:A,dashboardUid:V.toString(),panelId:G.toString(),onEditClick:Le,onDeleteClick:Ee}),(0,e.jsxs)("div",{className:t.annotationValueContainer,children:[(0,e.jsx)(Q.D,{hidden:E.key===h.YH.dashboardUID||E.key===h.YH.panelID,className:(0,n.cx)(t.flexRowItemMargin,t.field),invalid:!!u.annotations?.[T]?.value?.message,error:u.annotations?.[T]?.value?.message,children:(0,e.jsx)(se,{"data-testid":`annotation-value-${T}`,id:`annotation-${T}`,className:(0,n.cx)(t.annotationValueInput,{[t.textarea]:!te}),...f(`annotations.${T}.value`),placeholder:te?"https://":E.key&&(0,o.t)("alerting.annotations-step.placeholder-value-input","Enter a {{key}}...",{key:E.key})||(0,o.t)("alerting.annotations-step.placeholder-value-input-default","Enter custom annotation content..."),defaultValue:E.value})}),!h.J3[ie]&&(0,e.jsx)(K.$n,{type:"button",className:t.deleteAnnotationButton,"aria-label":(0,o.t)("alerting.annotations-step.aria-label-delete-annotation","delete annotation"),icon:"trash-alt",variant:"secondary",onClick:()=>re(T)})]})]})},E.id)}),(0,e.jsx)(w.B,{direction:"row",gap:1,children:(0,e.jsxs)("div",{className:t.addAnnotationsButtonContainer,children:[(0,e.jsx)(K.$n,{icon:"plus",type:"button",variant:"secondary",onClick:()=>{le({key:"",value:""})},children:(0,e.jsx)(o.x6,{i18nKey:"alerting.annotations-step.add-custom-annotation",children:"Add custom annotation"})}),!X&&(0,e.jsx)(K.$n,{type:"button",variant:"secondary",icon:"dashboard",onClick:()=>d(!0),children:(0,e.jsx)(o.x6,{i18nKey:"alerting.annotations-step.link-dashboard-and-panel",children:"Link dashboard and panel"})})]})}),s&&(0,e.jsx)(Ne,{isOpen:!0,dashboardUid:V,panelId:G,onChange:q,onDismiss:()=>d(!1)})]})})},S=t=>({annotationValueInput:(0,n.css)({width:"394px"}),textarea:(0,n.css)({height:"76px"}),addAnnotationsButtonContainer:(0,n.css)({marginTop:t.spacing(1),gap:t.spacing(1),display:"flex"}),field:(0,n.css)({marginBottom:t.spacing(.5)}),flexRow:(0,n.css)({display:"flex",flexDirection:"row",justifyContent:"flex-start"}),flexRowItemMargin:(0,n.css)({marginTop:t.spacing(1)}),deleteAnnotationButton:(0,n.css)({display:"inline-block",marginTop:"10px",marginLeft:"10px"}),annotationTitle:(0,n.css)({color:t.colors.text.primary,marginBottom:"3px"}),annotationContainer:(0,n.css)({marginTop:"5px"}),annotationDescription:(0,n.css)({color:t.colors.text.secondary}),annotationValueContainer:(0,n.css)({display:"flex"})}),x=i},25521:(ve,_,a)=>{a.d(_,{G:()=>w});var e=a(74848),n=a(22803),R=a(92745),p=a(63142),g=a(59243),F=a(41654),o=a(30703),N=a(66404);function w({contentText:B,externalLink:L,linkText:Q,title:K="Need help?"}){const h=(0,p.of)(M);return(0,e.jsx)(g.G,{content:(0,e.jsx)("div",{className:h.mutedText,children:B}),title:(0,e.jsxs)(F.B,{gap:.5,direction:"row",alignItems:"center",children:[(0,e.jsx)(o.I,{name:"question-circle"}),K]}),footer:L?(0,e.jsx)("a",{href:L,target:"_blank",rel:"noreferrer",children:(0,e.jsx)(F.B,{direction:"row",gap:.5,alignItems:"center",children:(0,e.jsxs)(N.E,{color:"link",children:[Q," ",(0,e.jsx)(o.I,{size:"sm",name:"external-link-alt"})]})})}):void 0,closeButton:!0,placement:"bottom-start",children:(0,e.jsx)("div",{className:h.helpInfo,children:(0,e.jsxs)(F.B,{direction:"row",alignItems:"center",gap:.5,children:[(0,e.jsx)(o.I,{name:"question-circle",size:"sm"}),(0,e.jsx)(N.E,{variant:"bodySmall",color:"primary",children:(0,e.jsx)(R.x6,{i18nKey:"alerting.need-help-info.need-help",children:"Need help?"})})]})})})}const M=B=>({mutedText:(0,n.css)({color:B.colors.text.secondary,fontSize:B.typography.size.sm}),helpInfo:(0,n.css)({cursor:"pointer",textDecoration:"underline"})})},58872:(ve,_,a)=>{a.d(_,{P:()=>M});var e=a(74848),n=a(22803),R=a(51898),p=a(92745),g=a(63142),F=a(16780),o=a(41654),N=a(66404),w=a(21285);const M=({title:L,stepNo:Q,children:K,fullWidth:h=!1,description:ne,switchMode:J})=>{const Z=(0,g.of)(B),m=R.Tp.components.AlertRules;return(0,e.jsx)("div",{className:Z.parent,"data-testid":m.step(Q.toString()),children:(0,e.jsx)(F.n,{className:(0,n.cx)(h&&Z.fullWidth),label:(0,e.jsxs)(o.B,{direction:"row",alignItems:"center",justifyContent:"space-between",children:[(0,e.jsxs)(N.E,{variant:"h3",children:[Q,". ",L]}),J&&(0,e.jsx)(N.E,{variant:"bodySmall",children:(0,e.jsx)(w.K,{"data-testid":m.stepAdvancedModeSwitch(Q.toString()),value:J.isAdvancedMode,onChange:j=>{J.setAdvancedMode(j.currentTarget.checked)},label:(0,p.t)("alerting.rule-editor-section.label-advanced-options","Advanced options"),showLabel:!0,transparent:!0,className:Z.reverse})})]}),children:(0,e.jsxs)(o.B,{direction:"column",children:[ne&&(0,e.jsx)("div",{className:Z.description,children:ne}),K]})})})},B=L=>({parent:(0,n.css)({display:"flex",flexDirection:"row",border:`solid 1px ${L.colors.border.weak}`,borderRadius:L.shape.radius.default,padding:`${L.spacing(2)} ${L.spacing(3)}`}),description:(0,n.css)({marginTop:`-${L.spacing(2)}`}),fullWidth:(0,n.css)({width:"100%"}),reverse:(0,n.css)({flexDirection:"row-reverse",gap:L.spacing(1)})})},8402:(ve,_,a)=>{a.d(_,{DI:()=>he,C1:()=>Me,Ay:()=>ke});var e=a(74848),n=a(22803),R=a(96540),p=a(49785),g=a(92745),F=a(63142),o=a(41654),N=a(66404),w=a(35137),M=a(45861),B=a(6975),L=a(37386),Q=a(79233),K=a(63527),h=a(2869),ne=a(5709);const J=ne.H.injectEndpoints({endpoints:r=>({getLabels:r.query({query:()=>({url:`/api/plugins/${h.W.Labels}/resources/v1/labels/keys`}),providesTags:["GrafanaLabels"]}),getLabelValues:r.query({query:({key:i})=>({url:`/api/plugins/${h.W.Labels}/resources/v1/labels/name/${i}`}),providesTags:["GrafanaLabels"]})})});var Z=a(3986),m=a(67817),j=a(39659),D=a(29609),c=a(58064),C=a(18857);const P=(0,c.c)({ignoreCase:!1});function k(r,i){return P({label:r.label??"",value:r.value??"",data:{}},i)}const H=(r,i,S)=>{const x=S.some(s=>s.label===r),t=r.trim().length;return!x&&!!t},ce=(0,R.forwardRef)(function({onChange:i,options:S,defaultValue:x,type:t,onOpenMenu:s=()=>{}},d){const b=(0,F.of)(Te);return(0,e.jsx)("div",{ref:d,children:(0,e.jsx)(L.D,{disabled:!1,"data-testid":`alertlabel-${t}-picker`,className:b.resetMargin,children:(0,e.jsx)(C.l6,{placeholder:(0,g.t)("alerting.alert-label-dropdown.placeholder-select","Choose {{type}}",{type:t}),width:29,className:"ds-picker select-container",backspaceRemovesValue:!1,onChange:i,onOpenMenu:s,filterOption:k,isValidNewOption:H,options:S,maxMenuHeight:500,noOptionsMessage:(0,g.t)("alerting.label-picker.no-options-message","No labels found"),defaultValue:x,allowCustomValue:!0})})})}),Te=()=>({resetMargin:(0,n.css)({marginBottom:0})}),ue=ce;var be=a(7840),ye=a(25521),je=a(59672);function De({remove:r,index:i}){return(0,e.jsx)(M.$n,{"aria-label":(0,g.t)("alerting.remove-button.aria-label-delete-label","delete label"),icon:"trash-alt","data-testid":`delete-label-${i}`,variant:"secondary",onClick:()=>{r(i)}})}function ge({append:r}){return(0,e.jsx)(M.$n,{icon:"plus",type:"button",variant:"secondary",onClick:r,children:(0,e.jsx)(g.x6,{i18nKey:"alerting.add-button.add-more",children:"Add more"})})}const Se=r=>{const{currentData:i,isLoading:S}=J.endpoints.getLabels.useQuery(void 0,{skip:r});return{loading:S,labelsOpsKeys:i}};function oe(r=[],i){const S=new Set(i?i.map(x=>x.key):[]);return Array.from(r,x=>({label:x,value:x,isDisabled:S.has(x)}))}const he=({labels:r})=>{const i=r.reduce((S,x)=>(x.key&&(S[x.key]=x.value),S),{});return(0,e.jsx)(be.m,{labels:i})};function Me({dataSourceName:r,onClose:i,initialLabels:S}){const x=(0,F.of)(fe),{watch:t}=(0,p.xW)(),s=t("type")??m.Z.grafana,d=u=>{i(u.labelsInSubform)},b=()=>{i()},f=(0,R.useMemo)(()=>({labelsInSubform:S}),[S]),l=(0,p.mN)({defaultValues:f});return(0,e.jsx)(p.Op,{...l,children:(0,e.jsx)("form",{onSubmit:l.handleSubmit(d),children:(0,e.jsxs)(o.B,{direction:"column",gap:4,children:[(0,e.jsxs)(o.B,{direction:"column",gap:1,children:[(0,e.jsx)(N.E,{children:me(s)}),(0,e.jsx)(N.E,{variant:"bodySmall",color:"secondary",children:Ce()})]}),(0,e.jsxs)(o.B,{direction:"column",gap:1,children:[(0,e.jsx)(Ie,{dataSourceName:r}),(0,e.jsx)(w.$,{v:2}),(0,e.jsx)(he,{labels:l.watch("labelsInSubform")}),(0,e.jsx)(w.$,{v:1}),(0,e.jsxs)("div",{className:x.confirmButton,children:[(0,e.jsx)(M.$n,{type:"button",variant:"secondary",onClick:b,children:(0,e.jsx)(g.x6,{i18nKey:"alerting.common.cancel",children:"Cancel"})}),(0,e.jsx)(M.$n,{type:"submit",children:(0,e.jsx)(g.x6,{i18nKey:"alerting.labels-sub-form.save",children:"Save"})})]})]})]})})})}const pe=r=>!(0,j.F2)(r);function Be(r,i,S,x,t){const{labels:s,isLoading:d}=(0,je.DJ)(r),{loading:b,labelsOpsKeys:f=[]}=Se(!i||S),l=(0,R.useMemo)(()=>f.reduce((O,U)=>(O[U.name]=new Set,O),{}),[f]),u=(0,R.useMemo)(()=>oe(Object.keys(l).filter(pe),x),[l,x]),v=(0,R.useMemo)(()=>oe(Array.from(s.keys()).filter(pe),x),[s,x]),y=[{label:(0,g.t)("alerting.use-combined-labels.grouped-options.label.from-alerts","From alerts"),options:v,expanded:!0},{label:(0,g.t)("alerting.use-combined-labels.grouped-options.label.from-system","From system"),options:u,expanded:!0}],W=s.has(t),ee=l[t]!==void 0&&l[t]?.size>0,le=!W&&!ee,re=!W&&l[t]?.size>0,{currentData:V,isLoading:G=!1,error:X}=J.endpoints.getLabelValues.useQuery({key:t},{skip:!i||!t||W||re||le}),$=(0,R.useMemo)(()=>{if(W)return[];const O=l[t];if(O?.size>0)return oe(O);if(!G&&V?.values?.length&&!X){const z=V?.values.map(q=>q.name);return l[t]=new Set(z),oe(z)}return[]},[W,l,t,G,V,X]),A=(0,R.useCallback)(O=>pe(O)?W||!i?oe(s.get(O)):$:[],[s,i,$,W]);return{loading:d||b,keysFromExistingAlerts:v,groupedOptions:y,getValuesForLabel:A}}function Ie({dataSourceName:r}){const i=(0,F.of)(fe),{control:S,watch:x,formState:{errors:t}}=(0,p.xW)(),s=x("labelsInSubform"),{fields:d,remove:b,append:f}=(0,p.jz)({control:S,name:"labelsInSubform"}),l=(0,R.useCallback)(()=>{f({key:"",value:""})},[f]),{installed:u=!1,loading:v}=(0,Z._)(h.W.Labels),[y,W]=(0,R.useState)(""),{loading:ee,keysFromExistingAlerts:le,groupedOptions:re,getValuesForLabel:V}=Be(r,u,v,s,y),G=(0,R.useMemo)(()=>V(y),[y,V]),X=ee||v;return(0,e.jsxs)(e.Fragment,{children:[X&&(0,e.jsx)(B._,{text:(0,g.t)("alerting.labels-with-suggestions.text-loading-existing-labels","Loading existing labels")}),!X&&(0,e.jsxs)(o.B,{direction:"column",gap:1,alignItems:"flex-start",children:[d.map(($,A)=>(0,e.jsxs)("div",{className:(0,n.cx)(i.flexRow,i.centerAlignRow),children:[(0,e.jsx)(L.D,{className:i.labelInput,invalid:!!t.labelsInSubform?.[A]?.key?.message,error:t.labelsInSubform?.[A]?.key?.message,"data-testid":`labelsInSubform-key-${A}`,children:(0,e.jsx)(p.xI,{name:`labelsInSubform.${A}.key`,control:S,rules:{required:s[A]?.value?"Required.":!1},render:({field:{onChange:O,ref:U,...z}})=>(0,e.jsx)(ue,{...z,defaultValue:$.key?{label:$.key,value:$.key}:void 0,options:u?re:le,onChange:q=>{O(q.value),W(q.value)},type:"key"})})}),(0,e.jsx)(Q.c,{className:i.equalSign,children:"="}),(0,e.jsx)(L.D,{className:i.labelInput,invalid:!!t.labelsInSubform?.[A]?.value?.message,error:t.labelsInSubform?.[A]?.value?.message,"data-testid":`labelsInSubform-value-${A}`,children:(0,e.jsx)(p.xI,{control:S,name:`labelsInSubform.${A}.value`,rules:{required:s[A]?.value?"Required.":!1},render:({field:{onChange:O,ref:U,...z}})=>(0,e.jsx)(ue,{...z,defaultValue:$.value?{label:$.value,value:$.value}:void 0,options:G,onChange:q=>{O(q.value)},onOpenMenu:()=>{W(s[A].key)},type:"value"})})}),(0,e.jsx)(De,{index:A,remove:b})]},$.id)),(0,e.jsx)(ge,{append:l})]})]})}const Oe=()=>{const r=(0,F.of)(fe),{register:i,control:S,watch:x,formState:{errors:t}}=(0,p.xW)(),s=x("labels"),{fields:d,remove:b,append:f}=(0,p.jz)({control:S,name:"labels"}),l=(0,R.useCallback)(()=>{f({key:"",value:""})},[f]);return(0,e.jsxs)(e.Fragment,{children:[d.map((u,v)=>(0,e.jsx)("div",{children:(0,e.jsxs)("div",{className:(0,n.cx)(r.flexRow,r.centerAlignRow),"data-testid":"alertlabel-input-wrapper",children:[(0,e.jsx)(L.D,{className:r.labelInput,invalid:!!t.labels?.[v]?.key?.message,error:t.labels?.[v]?.key?.message,children:(0,e.jsx)(K.p,{...i(`labels.${v}.key`,{required:{value:!!s[v]?.value,message:(0,g.t)("alerting.labels-without-suggestions.message.required","Required.")}}),placeholder:(0,g.t)("alerting.labels-without-suggestions.placeholder-key","key"),"data-testid":`label-key-${v}`,defaultValue:u.key})}),(0,e.jsx)(Q.c,{className:r.equalSign,children:"="}),(0,e.jsx)(L.D,{className:r.labelInput,invalid:!!t.labels?.[v]?.value?.message,error:t.labels?.[v]?.value?.message,children:(0,e.jsx)(K.p,{...i(`labels.${v}.value`,{required:{value:!!s[v]?.key,message:(0,g.t)("alerting.labels-without-suggestions.message.required","Required.")}}),placeholder:(0,g.t)("alerting.labels-without-suggestions.placeholder-value","value"),"data-testid":`label-value-${v}`,defaultValue:u.value})}),(0,e.jsx)(De,{index:v,remove:b})]})},u.id)),(0,e.jsx)(ge,{append:l})]})};function Ne(){const{watch:r}=(0,p.xW)(),i=r("type")??m.Z.grafana;return(0,e.jsxs)("div",{children:[(0,e.jsxs)(o.B,{direction:"column",gap:1,children:[(0,e.jsx)(N.E,{element:"h5",children:(0,e.jsx)(g.x6,{i18nKey:"alerting.labels-field.labels",children:"Labels"})}),(0,e.jsxs)(o.B,{direction:"row",gap:1,children:[(0,e.jsx)(N.E,{variant:"bodySmall",color:"secondary",children:me(i)}),(0,e.jsx)(ye.G,{externalLink:"https://grafana.com/docs/grafana/latest/alerting/fundamentals/alert-rules/annotation-label/",linkText:"Read about labels",contentText:`The dropdown only displays labels that you have previously used for alerts.
            Select a label from the options below or type in a new one.`,title:(0,g.t)("alerting.labels-field.title-labels","Labels")})]})]}),(0,e.jsx)(Oe,{})]})}function me(r){return(r?(0,D.vE)(r):!1)?(0,g.t)("alerting.alertform.labels.recording","Add labels to your rule."):(0,g.t)("alerting.alertform.labels.alerting","Add labels to your rule for searching, silencing, or routing to a notification policy.")}function Ce(){return(0,g.t)("alerting.labels-sub-form.description","Select a label key/value from the options below, or type a new one and press Enter.")}const fe=r=>({flexColumn:(0,n.css)({display:"flex",flexDirection:"column"}),flexRow:(0,n.css)({display:"flex",flexDirection:"row",justifyContent:"flex-start"}),centerAlignRow:(0,n.css)({alignItems:"center",gap:r.spacing(.5)}),equalSign:(0,n.css)({alignSelf:"flex-start",width:"28px",justifyContent:"center",margin:0}),labelInput:(0,n.css)({width:"175px",margin:0}),confirmButton:(0,n.css)({display:"flex",flexDirection:"row",gap:r.spacing(1),marginLeft:"auto"})}),ke=Ne},59672:(ve,_,a)=>{a.d(_,{$i:()=>Q,DJ:()=>L,h$:()=>K});var e=a(10378),n=a(96540),R=a(70327),p=a(55143),g=a(74869);const{usePrometheusRuleNamespacesQuery:F,useLazyRulerRulesQuery:o,useRulerRulesQuery:N}=R.hK,{useDiscoverDsFeaturesQuery:w}=p.L,M={},B=(0,g.wS)();function L(m){const{data:j,isLoading:D}=w({rulesSourceName:m}),[c,{data:C=M,isLoading:P}]=o(),{data:k=[],isLoading:H}=F({ruleSourceName:m},{skip:!B});return(0,n.useEffect)(()=>{j?.rulerConfig&&!B&&c({rulerConfig:j.rulerConfig})},[j?.rulerConfig,c]),{labels:(0,n.useMemo)(()=>H||P?new Map:B?J(k):Z(C),[k,C,H,P]),isLoading:H||P||D}}function Q(m){const{data:j,isLoading:D}=w(m?{rulesSourceName:m}:e.hT,{skip:!m}),[c,{data:C=M,isLoading:P}]=o(),{data:k=[],isLoading:H}=F(m&&B?{ruleSourceName:m}:e.hT);return(0,n.useEffect)(()=>{j?.rulerConfig&&!B&&c({rulerConfig:j.rulerConfig})},[j?.rulerConfig,c]),{namespaceGroups:(0,n.useMemo)(()=>H||P?new Map:B?h(k):ne(C),[k,C,H,P]),isLoading:H||P||D,promNamespaces:k}}function K(m){const{data:j,isLoading:D}=w(m?{rulesSourceName:m}:e.hT),{data:c=M,isLoading:C}=N(j?.rulerConfig?{rulerConfig:j.rulerConfig}:e.hT);return{isLoading:C||D,rulerRules:c}}function h(m){const j=new Map;return m.forEach(D=>{j.set(D.name,D.groups.map(c=>c.name))}),j}function ne(m){const j=new Map;return Object.entries(m).forEach(([D,c])=>{j.set(D,c.map(C=>C.name))}),j}function J(m){return m.flatMap(D=>D.groups).flatMap(D=>D.rules).reduce((D,c)=>(c.labels&&Object.entries(c.labels).forEach(([C,P])=>{if(!C||!P)return;const k=D.get(C);k?k.add(P):D.set(C,new Set([P]))}),D),new Map)}function Z(m){const j=new Map;return Object.entries(m).flatMap(([c,C])=>C).flatMap(c=>c.rules).reduce((c,C)=>(C.labels&&Object.entries(C.labels).forEach(([P,k])=>{if(!P||!k)return;const H=c.get(P);H?H.add(k):c.set(P,new Set([k]))}),c),j)}}}]);

//# sourceMappingURL=9668.a6b05bb73cac9984fc3e.js.map