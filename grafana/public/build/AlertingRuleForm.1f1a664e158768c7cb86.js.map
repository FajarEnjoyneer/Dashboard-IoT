{"version":3,"file":"AlertingRuleForm.1f1a664e158768c7cb86.js","mappings":"4SAiBO,MAAMA,GAAkB,CAAC,CAAE,SAAAC,EAAS,IAA8C,CACvF,KAAM,CAACC,EAAkBC,EAAmB,KAAI,YAAS,EAAK,EACxDC,GAAgBC,GAAmB,CACvCJ,GAASI,CAAM,EACfF,GAAoB,EAAK,CAC3B,EACA,SACE,oBACE,oBAAC,MACC,QAAS,IAAMA,GAAoB,EAAI,EACvC,KAAK,SACL,KAAK,OACL,KAAK,UACL,QAAQ,YACR,SAAU,CAAC,KAAW,cAAc,KAAoB,aAAa,EAErE,mBAAC,KAAK,CAAC,QAAQ,wCAAwC,sBAAU,EACnE,EACCD,MAAoB,OAACI,EAAA,CAAoB,SAAUF,GAAc,QAAS,IAAMD,GAAoB,EAAK,EAAG,GAC/G,CAEJ,EAEA,SAASG,EAAoB,CAC3B,QAAAC,GACA,SAAAN,CACF,EAGuB,CACrB,MAAMO,MAAS,MAAWC,CAAS,EAC7BC,MAAY,MAAmB,EAC/B,CAACC,EAAOC,CAAQ,KAAI,YAAS,EAAE,EAC/B,CAACC,EAAY,KAAI,OAAqB,EAEtCC,GAAW,SAAY,CAC3B,KAAM,CAAE,KAAAC,EAAM,MAAAC,EAAM,EAAI,MAAMH,GAAa,CAAE,MAAAF,CAAM,CAAC,EAEhDK,GACFN,GAAU,MAAM,yBAAyB,EAChCK,IACTd,EAAS,CAAE,MAAOc,EAAK,MAAO,IAAKA,EAAK,GAAI,CAAC,EAC7CL,GAAU,QAAQ,gBAAgB,EAEtC,EAEA,SACE,OAAC,KACC,UAAWF,GAAO,MAClB,OAAM,GACN,SAAO,KAAE,8CAA+C,YAAY,EACpE,UAAWD,GACX,gBAAiBA,GAEjB,oBAAC,IAAK,CAAC,UAAU,SAAS,IAAK,EAC7B,oBAAC,KACC,SACE,OAAC,IAAK,CAAC,QAAQ,SACb,mBAAC,KAAK,CAAC,QAAQ,yCAAyC,uBAAW,EACrE,EAGF,mBAAC,KACC,cAAa,KAAU,WAAW,WAAW,mBAC7C,UAAW,GACX,GAAG,aACH,eAAa,KAAE,sDAAuD,cAAc,EACpF,MAAOI,EACP,SAAWM,GAAML,EAASK,EAAE,cAAc,KAAK,EACjD,EACF,KAEA,QAAC,IAAM,UAAN,CACC,oBAAC,KAAM,CAAC,QAAQ,YAAY,KAAK,SAAS,QAASV,GACjD,mBAAC,KAAK,CAAC,QAAQ,2CAA2C,kBAAM,EAClE,KACA,OAAC,MACC,QAASO,GACT,SAAU,CAACH,EACX,cAAa,KAAU,WAAW,WAAW,0BAE7C,mBAAC,KAAK,CAAC,QAAQ,2CAA2C,kBAAM,EAClE,GACF,GACF,EACF,CAEJ,CAEA,MAAMF,EAAaS,KAA0B,CAC3C,SAAO,OAAI,CACT,MAAO,GAAGA,GAAM,YAAY,OAAO,EAAE,IACvC,CAAC,CACH,E,4GCxGA,SAASC,GAA2B,CAClC,SACE,OAAC,KACC,MAAM,aACN,QAAS,CACP,QAAM,KAAE,qEAAsE,yBAAyB,EACvG,SAAU,gGACZ,EAEA,mBAAC,KAAoB,EAAC,EACxB,CAEJ,CAEA,WAAe,KAAsBA,CAAwB,C,uOCF7D,SAASC,IAAsB,CAC7B,KAAM,CAAE,GAAAC,CAAG,KAAI,KAAU,EACnBC,MAAiB,WAAoC,IAClD,KAAgBD,EAAI,EAAI,EAC9B,CAACA,CAAE,CAAC,EAEP,OAAKC,MAUE,OAACC,EAAA,CAAiB,eAAAD,EAAA,CAAgC,KARrD,OAAC,IAAK,CAAC,SAAO,KAAE,uDAAwD,iBAAiB,EAAG,SAAS,QACnG,mBAAC,KAAK,CAAC,QAAQ,sDAAsD,wFAErE,EACF,CAKN,CAEA,SAASC,EAAiB,CAAE,eAAAD,CAAe,EAAuC,CAChF,KAAM,CAAE,QAAAE,GAAS,MAAAR,GAAO,OAAQS,CAAU,KAAI,MAAoB,CAAE,eAAAH,CAA+B,CAAC,EAEpG,OAAIE,MACK,OAAC,IAAkB,CAAC,QAAM,KAAE,oDAAqD,qBAAqB,EAAG,EAG9GR,MAEA,OAAC,KACC,SAAO,KAAE,8DAA+D,2BAA2B,EACnG,SAAS,QAER,kBAAmBA,EAAK,EAC3B,EAIA,CAACS,GAAa,CAACD,MAGf,OAAC,KACC,SAAO,KAAE,iDAAkD,+CAA+C,EAC1G,cAAc,wBACd,SAAU,IAAM,KAAgB,WAAQ,KAAkB,gBAAgB,CAAC,EAC7E,EAIAC,GAAa,CAAC,IAAc,QAAQ,KAAKA,EAAU,IAAI,KAGvD,OAAC,KACC,SAAO,KACL,yDACA,+CACF,EACA,cAAc,wBACd,SAAU,IAAM,KAAgB,WAAQ,KAAkB,gBAAgB,CAAC,EAC7E,EAIAA,GAAa,IAAc,QAAQ,KAAKA,EAAU,IAAI,KAEtD,OAAC,OACC,YAAU,MAA2BA,CAAS,EAC9C,SAAUA,EAAU,KAAK,cAAc,IACzC,KAIG,OAAC,IAAK,CAAC,SAAO,KAAE,kDAAmD,eAAe,EAAG,CAC9F,CAEA,SAASC,GAA0B,CACjC,SACE,OAAC,MACC,MAAM,aACN,QAAS,CACP,QAAM,KAAE,yDAA0D,eAAe,EACjF,SACE,oIACJ,EAEA,mBAACN,GAAA,EAAoB,EACvB,CAEJ,CAEA,YAAe,KAAsBM,CAAuB,C,wLC7F5D,MAAMC,EAAsCC,KAAwB,CAClE,WAAS,MAA6BA,EAAI,EACtC,oIACA,kIACJ,MAAO,4BACT,GAMaC,GAAyB,IAAM,CAC1C,KAAM,CACJ,QAAAC,GACA,SAAAC,GACA,MAAAC,EACA,UAAW,CAAE,OAAAC,CAAO,EACpB,SAAAC,EACF,KAAI,MAA+B,EAE7BC,EAAeH,EAAM,MAAM,EACjC,GAAI,CAACG,EACH,OAAO,KAET,MAAMC,MAAc,MAAsBD,CAAY,EAChDE,MAAyB,MAA6BF,CAAY,EAClEG,KAAuB,MAA2BH,CAAY,EAC9DI,EAAiBF,GAAyB,4BAA8B,iBACxEG,GAAkBJ,GAAc,iBAAmB,aACnDK,GAAaL,GAAcG,EAAiB,aAClD,SACE,OAAC,KACC,OAAQ,EACR,SAAO,KAAE,oDAAqD,4BAA6B,CAAE,WAAAE,EAAW,CAAC,EACzG,eACE,OAAC,IAAI,CAAC,QAAQ,YAAY,MAAM,YAC9B,oBAAC,KAAK,CAAC,QAAQ,0DAA0D,2CACxC,CAAE,WAAAA,EAAW,EAAE,KAChD,EACF,EAGF,oBAAC,IAAK,CAAC,UAAU,SACf,oBAAC,KACC,SAAO,KAAE,iDAAkD,MAAM,EACjE,MAAOR,GAAQ,MAAM,QACrB,QAAS,CAAC,CAACA,EAAO,MAAM,QAExB,mBAAC,KACC,cAAa,KAAU,WAAW,WAAW,cAC7C,GAAG,OACH,MAAO,GACN,GAAGF,GAAS,OAAQ,CACnB,SAAU,CACR,MAAO,GACP,WAAS,KAAE,gEAAiE,mBAAmB,CACjG,EACA,QAASO,EACLX,EAAmC,IAAa,cAAc,EAC9D,MACN,CAAC,EACD,gBAAY,KAAE,sDAAuD,MAAM,EAC3E,eAAa,KACX,uDACA,uCACA,CAAE,gBAAAa,EAAgB,CACpB,EACF,EACF,EACCH,OACC,OAAC,KACC,SAAO,KAAE,mDAAoD,QAAQ,EACrE,MAAOJ,GAAQ,QAAQ,QACvB,QAAS,CAAC,CAACA,EAAO,QAAQ,QAE1B,mBAAC,KACC,GAAG,SACH,MAAO,GACN,GAAGF,GAAS,SAAU,CACrB,SAAU,CACR,MAAO,GACP,WAAS,KACP,uEACA,0BACF,CACF,EACA,QAASJ,EAAmC,IAAa,gBAAgB,CAC3E,CAAC,EACD,gBAAY,KAAE,+DAAgE,QAAQ,EACtF,eAAa,KACX,yEACA,0CACF,EACF,EACF,EAGDU,OACC,OAAC,KACC,GAAG,qBACH,cAAY,qBACZ,SAAO,KAAE,oDAAqD,oBAAoB,EAClF,eAAa,KACX,0DACA,wDACF,EACA,MAAOJ,EAAO,qBAAqB,QACnC,QAAS,CAAC,CAACA,EAAO,qBAAqB,QAEvC,mBAAC,MACC,OAAQ,CAAC,CAAE,MAAO,CAAE,SAAAS,EAAU,IAAAC,GAAK,GAAGC,EAAM,CAAE,OAC5C,OAAC,KACE,GAAGA,GACJ,QAASA,GAAM,MACf,UAAS,GAET,OAAQ,KACR,SAAWC,IAAmC,CAC5CX,GAAS,sBAAuBW,GAAG,GAAG,CACxC,EACF,EAEF,KAAK,sBACL,QAAAf,GACA,MAAO,CACL,SAAU,CACR,MAAO,GACP,WAAS,KACP,0EACA,6BACF,CACF,CACF,EACF,EACF,GAEJ,EACF,CAEJ,C,oFC1IO,SAASgB,EAAuB,CAAE,MAAAC,EAAO,SAAAC,EAAU,GAAGC,CAAM,EAAuB,CACxF,KAAM,CAAE,sBAAuBC,EAAsB,UAAAC,CAAU,KAAI,KAAyB,EAEtFC,KAAmB,eACtBP,GACQK,EAAqB,KAAK,CAAC,CAAE,IAAAG,CAAI,IAAMA,IAAQR,EAAG,GAAG,EAE9D,CAACK,CAAoB,CACvB,EAEA,SACE,OAAC,KACC,SAAUC,GAAaH,EACvB,UAAS,GACT,SAAQ,GACR,OAAQI,EACR,QAASL,EACR,GAAGE,CAAA,CACN,CAEJ,C,iKCzBO,SAASK,GAAiB,CAC/B,KAAM,CACJ,UAAW,CAAE,OAAArB,CAAO,EACpB,SAAAC,EACA,MAAAF,EACF,KAAI,MAA+B,EAE7BuB,KAAa,eAAY,IAAM,CACnCrB,EAAS,QAAS,EAAE,CACtB,EAAG,CAACA,CAAQ,CAAC,EAEP7B,GAAS2B,GAAM,QAAQ,EAEvBwB,GAAwBnD,GAAmB,CAC/CkD,EAAW,EACXrB,EAAS,SAAU7B,CAAM,CAC3B,EAEA,SACE,OAACoD,EAAA,EAAK,CAAC,WAAW,SAEd,mBAACC,EAAA,GACC,SACE,OAACC,EAAA,GACC,QAAQ,SACR,eAAa,KACX,qDACA,wCACF,EAEA,mBAAC,KAAK,CAAC,QAAQ,kCAAkC,kBAAM,EACzD,EAEF,MAAO1B,EAAO,QAAQ,QACtB,cAAY,gBAEZ,oBAACwB,EAAA,EAAK,CAAC,UAAU,MAAM,WAAW,SAChC,oBAAC,MACC,OAAQ,CAAC,CAAE,MAAO,CAAE,IAAAd,EAAK,GAAGC,CAAM,CAAE,OAClC,OAAC,OAAI,MAAO,CAAE,MAAO,GAAI,EACvB,mBAACgB,EAAA,oBACC,WAAW,OACX,eAAgB,GAChB,QAAS,CAAC,CAAC3B,EAAO,QAAQ,QACzB,GAAGW,EACJ,MAAOvC,IAAQ,IACf,SAAU,CAACgD,GAAK1C,KAAU,CACpB0C,IAAO1C,GACTuB,EAAS,SAAU,CAAE,MAAAvB,GAAO,IAAA0C,EAAI,CAAC,EAEjCnB,EAAS,SAAU,MAAS,EAG9BqB,EAAW,CACb,EACF,EACF,EAEF,KAAK,SACL,MAAO,CACL,SAAU,CACR,MAAO,GACP,WAAS,KAAE,mDAAoD,iBAAiB,CAClF,CACF,EACF,KACA,OAACvD,EAAA,EAAe,CAAC,SAAUwD,EAAA,CAAsB,GACnD,EACF,EAEJ,CAEJ,C,kDCjEO,SAASK,IAA6B,CAC3C,KAAM,CAAE,SAAA3B,EAAU,UAAA4B,CAAU,KAAI,MAA+B,EACzD,CAACC,GAAkBC,CAAmB,KAAI,YAAS,EAAK,EAE9D,SAASC,GAAoBC,EAAgC,CACvDA,GACFhC,EAAS,SAAUgC,CAAc,EAEnCF,EAAoB,EAAK,CAC3B,CAEA,SAASG,IAAqB,CAC5B,SACE,QAACV,EAAA,EAAK,CAAC,UAAU,MAAM,IAAK,GAAK,WAAW,SAC1C,oBAACW,EAAA,EAAI,CAAC,QAAQ,YAAY,MAAM,YAC9B,mBAAC,KAAK,CAAC,QAAQ,uCAAuC,qEAEtD,EACF,KACA,OAACC,EAAA,GACC,eACE,oBACE,oBAAC,KACE,iBACC,uCACA,qJACF,EACF,KACA,OAAC,KACE,iBACC,sCACA,uIACF,EACF,GACF,EAEJ,GACF,CAEJ,CAEA,SACE,OAACC,EAAA,GACC,OAAQ,EACR,SAAO,KAAE,sEAAuE,uBAAuB,EACvG,eAAa,OAACH,GAAA,EAAmB,EAEjC,oBAACV,EAAA,EAAK,CAAC,UAAU,SAAS,kBAAgB,aAAa,cAAY,aACjE,oBAACH,EAAc,EAAC,KAChB,OAACiB,GAAA,EAAiB,CAAC,YAAa,IAAMP,EAAoB,EAAI,EAAG,KACjE,OAACQ,GAAA,GACC,OAAQT,GACR,QAASE,GACT,eAAgB,KAChB,cAAeH,EAAU,QAAQ,EACnC,GACF,EACF,CAEJ,C,uVC7DO,SAAS,EAAqB,CAAE,aAAAW,CAAa,EAA8B,CAChF,KAAM,CAAE,QAAA3C,EAAS,MAAAE,EAAO,QAAA0C,CAAQ,KAAI,MAA+B,EAE7DC,EAA4B,iBAAiBF,CAAY,wBACzDG,EAAqB5C,EAAM2C,CAAyB,EAIpD,CAAE,YAAAE,EAAa,OAAAC,CAAO,EAAI,KAAY,UAAU,aAAa,SAAS,CAC1E,cAAe,cAAcF,CAAkB,EACjD,CAAC,EAEKG,GAAuBH,GAAsBE,IAAW,KAAY,cAAa,YAAQD,GAAa,KAAK,EAGjH,sBAAU,IAAM,CACVD,GAAsBE,IAAW,KAAY,WAC/CJ,EAAQC,EAA2B,CAAE,YAAa,EAAK,CAAC,CAE5D,EAAG,CAACC,EAAoBD,EAA2BG,EAAQJ,CAAO,CAAC,KAGjE,OAACjB,EAAA,EAAK,CAAC,UAAU,MAAM,WAAW,SAChC,mBAACC,EAAA,GACC,SAAO,KAAE,2EAA4E,eAAe,EACpG,cAAY,uBAEZ,mBAAC,MACC,KAAMiB,EACN,OAAQ,CAAC,CAAE,MAAO,CAAE,SAAAjC,EAAS,EAAG,WAAY,CAAE,MAAA1B,EAAM,CAAE,OACpD,oBACE,qBAACyC,EAAA,EAAK,CACJ,oBAAC,KACC,YAAa,GACb,SAAWuB,IAAiBtC,GAASsC,GAAa,KAAK,KAAK,EAC5D,MAAO,GACP,MAAOJ,CAAA,CACT,KACA,OAACK,GAAA,EAAoB,GACvB,EAKCjE,OAAS,OAACkE,GAAA,EAAsB,CAAE,SAAAlE,IAAO,QAAQ,GACpD,EAEF,MAAO,CACL,SAAU,IACJ+D,MACK,KACL,6CACA,sDACA,CACE,aAAcH,CAChB,CACF,EAEK,GAET,SAAU,CACR,MAAO,GACP,WAAS,KACP,oEACA,4BACF,CACF,CACF,EACA,QAAA9C,CAAA,CACF,EACF,EACF,CAEJ,CACA,SAASmD,IAAsB,CAE7B,SACE,OAACE,EAAA,GACC,SAAQ,GACR,QAAM,MAJkB,yBAImB,EAC3C,gBAAY,KACV,2EACA,+BACF,EAEA,mBAAC,KAAK,CAAC,QAAQ,gEAAgE,yCAE/E,EACF,CAEJ,C,4BC7FO,SAASC,GAAmB,CAAE,aAAAC,CAAa,EAAyB,CACzE,MAAM7E,KAAS,MAAWC,EAAS,EAC7B,CACJ,QAAAqB,EACA,UAAW,CAAE,OAAAG,CAAO,CACtB,KAAI,MAA+B,EAEnC,SACE,OAACyB,EAAA,GACC,SAAO,KAAE,6EAA8E,gBAAgB,EACvG,cAAY,0BACZ,eAAa,KACX,iFACA,sFACF,EACA,UAAWlD,EAAO,gBAClB,QAAS,CAAC,CAACyB,EAAO,gBAAgBoD,CAAY,GAAG,oBAEjD,mBAAC,MACC,OAAQ,CAAC,CAAE,MAAO,CAAE,SAAA3C,EAAU,IAAAC,EAAK,GAAGC,CAAM,CAAE,OAC5C,OAAC0C,GAAA,GACC,aAAAD,EACA,YAAa,CACX,GAAGzC,EACH,SAAWG,GAAUL,KAAS,OAA6BK,CAAK,CAAC,CACnE,EACF,EAEF,QAAAjB,EACA,KAAM,iBAAiBuD,CAAY,uBACrC,EACF,CAEJ,CACA,MAAM5E,GAAaS,IAA0B,CAC3C,mBAAiB,OAAI,CACnB,UAAWA,EAAM,QAAQ,CAAC,CAC5B,CAAC,CACH,GCtCO,SAASqE,GAAiB,CAAE,aAAAF,CAAa,EAAyB,CACvE,MAAM7E,KAAS,MAAW,EAAS,EAC7B,CACJ,QAAAsB,EACA,UAAW,CAAE,OAAAG,CAAO,CACtB,KAAI,MAA+B,EAEnC,SACE,OAACyB,EAAA,GACC,SAAO,KAAE,uEAAwE,cAAc,EAC/F,cAAY,wBACZ,eAAa,KACX,6EACA,mFACF,EACA,UAAWlD,EAAO,gBAClB,QAAS,CAAC,CAACyB,EAAO,gBAAgBoD,CAAY,GAAG,kBAEjD,mBAAC,MACC,OAAQ,CAAC,CAAE,MAAO,CAAE,SAAA3C,EAAU,IAAAC,EAAK,GAAGC,CAAM,CAAE,OAC5C,OAAC0C,GAAA,GACC,aAAAD,EACA,YAAa,CACX,GAAGzC,EACH,SAAWG,GAAUL,KAAS,OAA6BK,CAAK,CAAC,CACnE,EACF,EAEF,QAAAjB,EACA,KAAM,iBAAiBuD,CAAY,qBACrC,EACF,CAEJ,CACA,MAAM,GAAanE,IAA0B,CAC3C,mBAAiB,OAAI,CACnB,UAAWA,EAAM,QAAQ,CAAC,CAC5B,CAAC,CACH,G,oGCnCO,SAASsE,GAAa,CAAE,aAAAf,CAAa,EAAsB,CAChE,MAAMgB,KAAa,MAAW,IAAa,EACrC,CACJ,SAAA1D,EACA,UAAW,CAAE,OAAAE,CAAO,EACpB,UAAA6B,CACF,KAAI,MAA+B,EACnC,SACE,oBACE,oBAACJ,EAAA,GACC,MAAOgC,GAAA,EAAmB,UAAU,MACpC,YAAaA,GAAA,EAAmB,UAAU,YAC1C,QAAS,CAAC,CAACzD,EAAO,gBAAgBwC,CAAY,GAAG,eACjD,MAAOxC,EAAO,gBAAgBwC,CAAY,GAAG,gBAAgB,QAE7D,mBAACkB,GAAA,GACE,GAAG5D,EAAS,iBAAiB0C,CAAY,kBAAmB,CAAE,SAAU,KAAsB,CAAC,EAChG,aAAYiB,GAAA,EAAmB,UAAU,UACzC,UAAWD,EAAW,kBACtB,YAAa,KAAwB,WACvC,EACF,KACA,OAAC/B,EAAA,GACC,MAAOgC,GAAA,EAAmB,cAAc,MACxC,YAAaA,GAAA,EAAmB,cAAc,YAC9C,QAAS,CAAC,CAACzD,EAAO,gBAAgBwC,CAAY,GAAG,mBACjD,MAAOxC,EAAO,gBAAgBwC,CAAY,GAAG,oBAAoB,QAEjE,mBAACkB,GAAA,GACE,GAAG5D,EAAS,iBAAiB0C,CAAY,sBAAuB,CAC/D,SAAU,KACZ,CAAC,EACD,aAAYiB,GAAA,EAAmB,cAAc,UAC7C,UAAWD,EAAW,kBACtB,YAAa,KAAwB,eACvC,EACF,KACA,OAAC/B,EAAA,GACC,MAAOgC,GAAA,EAAmB,eAAe,MACzC,YAAaA,GAAA,EAAmB,eAAe,YAC/C,QAAS,CAAC,CAACzD,EAAO,gBAAgBwC,CAAY,GAAG,oBACjD,MAAOxC,EAAO,gBAAgBwC,CAAY,GAAG,qBAAqB,QAElE,mBAACkB,GAAA,GACE,GAAG5D,EAAS,iBAAiB0C,CAAY,uBAAwB,CAChE,SAAW1B,GAAkB,CAC3B,MAAM6C,EAAgB9B,EAAU,iBAAiBW,CAAY,sBAAsB,EACnF,SAAO,OAAwB1B,EAAO6C,CAAa,CACrD,CACF,CAAC,EACD,aAAYF,GAAA,EAAmB,eAAe,UAC9C,UAAWD,EAAW,kBACtB,YAAa,KAAwB,gBACvC,EACF,GACF,CAEJ,CClDA,MAAMI,GAA6B,CAAC,iBAAkB,WAAW,EAE3DC,EAAmB,CACvB,eAAgB,KAAwB,WACxC,mBAAoB,KAAwB,eAC5C,oBAAqB,KAAwB,eAC/C,EACMC,GAAmB,MAKZC,GAAkB,CAAC,CAAE,aAAAvB,CAAa,IAA4B,CACzE,MAAMgB,KAAa,MAAW,IAAa,EACrC,CACJ,QAAA3D,EACA,MAAAE,EACA,SAAAD,EACA,SAAAG,EACA,UAAW,CAAE,OAAAD,CAAO,CACtB,KAAI,MAA+B,EAC7B,CAACgE,EAAgBC,EAAiB,KAAI,eAAS,OAA0B,CAAC,CAAC,CAAC,EAC5E,CAAE,mBAAAC,GAAoB,eAAAC,GAAgB,oBAAAC,EAAoB,EAAIP,EAC9DQ,GAAmBtE,EAAM,iBAAiByC,CAAY,mBAAmB,EACzE8B,GAAkBvE,EAAM,iBAAiByC,CAAY,kBAAkB,EACvE+B,GAAexE,EAAM,iBAAiByC,CAAY,UAAU,GAAG,QAAU,EAEzEjE,KAAS,MAAW,CAAS,KACnC,aAAU,IAAM,CACV8F,IAAoBE,KAAiB,GACvCtE,EAAS,iBAAiBuC,CAAY,WAAYoB,EAA0B,CAEhF,EAAG,CAACS,GAAkBpE,EAAUuC,EAAc+B,EAAY,CAAC,EAE3D,MAAMC,KAAY,OAAC,QAAK,cAAE,EAE1B,SACE,QAAChD,EAAA,EAAK,CAAC,UAAU,SACf,qBAACA,EAAA,EAAK,CAAC,UAAU,MAAM,IAAK,EAAG,WAAW,SAAS,eAAe,gBAChE,oBAACiD,GAAA,GACC,SAAO,KAAE,oDAAqD,mBAAmB,EACjF,YAAa,GACb,UAAWlG,EAAO,cAElB,mBAACmG,GAAA,EAAM,CAAC,GAAG,2BAA4B,GAAG5E,EAAS,iBAAiB0C,CAAY,mBAAmB,EAAG,EACxG,EACC,CAAC6B,OACA,OAAClC,EAAA,EAAI,CAAC,QAAQ,OAAO,MAAM,YACzB,oBAAC,MACC,QAAQ,qCACR,OAAQ,CAAE,OAAQyB,GAA2B,KAAK,IAAI,CAAE,EACzD,0BACW,OAAC,UAAQ,sBAAa,GAClC,EACF,GAEJ,EACCS,OACC,OAAC5C,EAAA,GACC,SAAO,KAAE,2CAA4C,UAAU,EAC/D,eAAa,KACX,iDACA,+JACF,EACC,GAAG3B,EAAS,iBAAiB0C,CAAY,UAAU,EACpD,QAAS,CAAC,CAACxC,EAAO,gBAAgBwC,CAAY,GAAG,QACjD,UAAWjE,EAAO,gBAElB,mBAAC,MACC,MAAO,CACL,SAAWuC,GACL,CAACA,GAASA,EAAM,SAAW,EACtB,4CAELA,EAAM,SAAW,GAAKA,EAAM,CAAC,IAAMgD,IAIRF,GAA2B,MAAOjD,IAAUG,EAAM,SAASH,EAAK,CAAC,EAHvF,GAKA,yBAAyBiD,GAA2B,KAAK,IAAI,CAAC,EAI3E,EACA,OAAQ,CAAC,CAAE,MAAO,CAAE,SAAAnD,EAAU,IAAAC,EAAK,GAAGC,EAAM,EAAG,WAAY,CAAE,MAAA5B,CAAM,CAAE,OACnE,oBACE,oBAAC,OACC,gBAAY,KAAE,gDAAiD,UAAU,EACxE,GAAG4B,GACJ,iBAAgB,GAChB,UAAW6C,EAAW,MACtB,eAAiBmB,GAAgB,CAC/BV,GAAmBW,IAAS,CAAC,GAAGA,MAAM,OAAwBD,CAAG,CAAC,CAAC,EAGnE1E,EAAS,iBAAiBuC,CAAY,WAAY,CAAC,GAAG7B,GAAM,MAAOgE,CAAG,CAAC,CACzE,EACA,SAAW7D,GACFL,KAAS,OAA6BK,CAAK,CAAC,EAErD,QAAS,CAAC,GAAG,MAAsB,GAAGkD,CAAc,EACpD,WAAY,CACV,iBACEhD,EAUA,CACA,KAAM,CAAE,KAAAlC,EAAK,EAAIkC,EACjB,OAAIlC,GAAK,QACA,QAEF+F,GAAA,GAAiB7D,CAAK,CAC/B,CACF,EACF,EACCjC,MAAS,OAACkE,GAAA,EAAsB,CAAE,SAAAlE,EAAM,QAAQ,GACnD,EAEF,KAAM,iBAAiByD,CAAY,WACnC,QAAA3C,CAAA,CACF,EACF,KAEF,QAAC2B,EAAA,EAAK,CAAC,UAAU,MAAM,IAAK,EAAG,WAAW,SAAS,eAAe,gBAChE,oBAACiD,GAAA,GACC,SAAO,KAAE,mDAAoD,kBAAkB,EAC/E,YAAa,GACb,UAAWlG,EAAO,cAElB,mBAACmG,GAAA,EAAM,CAAC,GAAG,0BAA2B,GAAG5E,EAAS,iBAAiB0C,CAAY,kBAAkB,EAAG,EACtG,EACC,CAAC8B,OACA,QAACnC,EAAA,EAAI,CAAC,QAAQ,OAAO,MAAM,YACzB,qBAAC,KAAK,CAAC,QAAQ,uCAAuC,OAAQ,CAAE,eAAAgC,EAAe,EAAG,4BACpE,OAAC,UAAQ,8BAAqB,GAC5C,EACCK,KACD,QAAC,KAAK,CAAC,QAAQ,2CAA2C,OAAQ,CAAE,mBAAAN,EAAmB,EAAG,gCACxE,OAAC,UAAQ,kCAAyB,GACpD,EACCM,KACD,QAAC,KAAK,CAAC,QAAQ,4CAA4C,OAAQ,CAAE,oBAAAJ,EAAoB,EAAG,iCACzE,OAAC,UAAQ,mCAA0B,GACtD,GACF,GAEJ,EACCE,OACC,OAAC,OAAI,UAAW/F,EAAO,gBACrB,mBAACgF,GAAY,CAAC,aAAAf,CAAA,CAA4B,EAC5C,GAEJ,CAEJ,EAEM,EAAavD,IAA0B,CAC3C,iBAAe,OAAI,CACjB,SAAU,cACV,IAAKA,EAAM,QAAQ,CAAC,EACpB,WAAY,QACd,CAAC,EACD,mBAAiB,OAAI,CACnB,WAAY,OACZ,aAAcA,EAAM,QAAQ,CAAC,CAC/B,CAAC,CACH,GChLO,SAAS6F,GAA0B,CAAE,aAAAtC,CAAa,EAAmC,CAC1F,MAAMjE,KAAS,MAAW,EAAS,EAE7BwG,EAAmBvC,EAAa,KAEhC,CAAE,MAAAzC,CAAM,KAAI,MAA+B,EAE3CiF,EACJjF,EAAM,iBAAiBgF,CAAgB,mBAAmB,GAC1DhF,EAAM,iBAAiBgF,CAAgB,kBAAkB,GACzDhF,EAAM,iBAAiBgF,CAAgB,oBAAoB,GAAG,OAAS,EAEzE,SACE,QAACvD,EAAA,EAAK,CAAC,UAAU,SACf,qBAACA,EAAA,EAAK,CAAC,UAAU,MAAM,WAAW,SAChC,oBAAC,OAAI,UAAWjD,EAAO,sBAAuB,KAC9C,QAAC,OAAI,UAAWA,EAAO,iBACrB,oBAAC,KAAK,CAAC,QAAQ,uDAAuD,yBAAa,KACnF,OAAC,OAAI,IAAKiE,EAAa,OAAQ,IAAI,qBAAqB,UAAWjE,EAAO,IAAK,EAC9EwG,CAAA,EACH,KACA,OAAC,OAAI,UAAWxG,EAAO,uBAAwB,GACjD,KACA,OAACiD,EAAA,EAAK,CAAC,UAAU,MAAM,IAAK,EAAG,WAAW,SACxC,mBAAC,EAAoB,CAAC,aAAcuD,CAAA,CAAkB,EACxD,KAKA,OAAC,OAAI,UAAWxG,EAAO,eACrB,mBAAC0G,GAAA,GACC,SAAO,KACL,mFACA,yCACF,EACA,OAAQD,EACR,UAAWzG,EAAO,mBAClB,iBAAkBA,EAAO,0BAEzB,oBAACiD,EAAA,EAAK,CAAC,UAAU,SAAS,IAAK,EAC7B,qBAACA,EAAA,EAAK,CAAC,UAAU,MAAM,IAAK,GAAK,WAAW,SAC1C,oBAACW,EAAA,EAAI,CAAC,QAAQ,YAAY,MAAM,YAC9B,mBAAC,KAAK,CAAC,QAAQ,kEAAkE,qEAEjF,EACF,KACA,OAACC,GAAA,GACC,SAAO,KACL,0EACA,+BACF,EACA,SAAU,mCACV,aACE,yGAEF,eACE,oBACE,oBAAC,KACE,iBACC,iEACA,+IACF,EACF,KACC,KACC,iEACA,qJACF,GACF,EAEJ,GACF,KACA,OAACkB,GAAgB,CAAC,aAAcyB,CAAA,CAAkB,KAClD,OAAC5B,GAAkB,CAAC,aAAc4B,CAAA,CAAkB,KACpD,OAAChB,GAAe,CAAC,aAAcgB,CAAA,CAAkB,GACnD,EACF,EACF,GACF,CAEJ,CAEA,MAAM,GAAa9F,IAA0B,CAC3C,yBAAuB,OAAI,CACzB,OAAQ,EACR,MAAOA,EAAM,QAAQ,CAAC,EACtB,gBAAiBA,EAAM,OAAO,UAAU,IAC1C,CAAC,EACD,oBAAkB,OAAI,CACpB,KAAM,aACR,CAAC,EACD,0BAAwB,OAAI,CAC1B,OAAQ,MACR,MAAO,OACP,KAAM,EACN,gBAAiBA,EAAM,OAAO,UAAU,IAC1C,CAAC,EACD,OAAK,OAAI,CACP,WAAYA,EAAM,QAAQ,CAAC,EAC3B,MAAOA,EAAM,QAAQ,CAAC,EACtB,OAAQA,EAAM,QAAQ,CAAC,EACvB,YAAaA,EAAM,QAAQ,CAAC,CAC9B,CAAC,EACD,sBAAoB,OAAI,CACtB,MAAO,cACP,SAAUA,EAAM,WAAW,KAAK,QAClC,CAAC,EACD,6BAA2B,OAAI,CAC7B,QAAS,GACX,CAAC,EACD,kBAAgB,OAAI,CAClB,QAAS,OACT,cAAe,SACf,SAAUA,EAAM,YAAY,OAAO,GACnC,OAAQ,aAAaA,EAAM,OAAO,OAAO,IAAI,GAC7C,aAAcA,EAAM,MAAM,OAAO,QACjC,QAAS,GAAGA,EAAM,QAAQ,CAAC,CAAC,IAAIA,EAAM,QAAQ,CAAC,CAAC,GAChD,UAAWA,EAAM,QAAQ,CAAC,CAC5B,CAAC,CACH,GClIO,SAASiG,IAAoB,CAClC,KAAM,CAAE,UAAArD,CAAU,KAAI,MAA+B,EAC/CsD,EAAuBtD,EAAU,eAAe,EAWhDuD,KAT+B,OAAuC,cAAc,EAO5B,6BAES,OAAQC,GAAOA,EAAG,mBAAmB,EAyB5G,SAtB+C,WAC7C,IACED,EAAsC,IAAKC,GAAO,CAChD,MAAMC,EAAuBH,EAAuBA,EAAqBE,EAAG,IAAI,EAAI,OACpF,MAAO,CACL,aAAcA,EACd,qBAAsBC,GAAsB,sBAAwB,GACpE,cAAe,CACb,kBAAmBA,GAAsB,mBAAqB,CAAC,EAC/D,oBAAqBA,GAAsB,qBAAuB,CAAC,EACnE,iBAAkBA,GAAsB,kBAAoB,GAC5D,QAASA,GAAsB,SAAW,CAAC,EAC3C,gBAAiBA,GAAsB,iBAAmB,GAC1D,eAAgBA,GAAsB,gBAAkB,GACxD,mBAAoBA,GAAsB,oBAAsB,GAChE,oBAAqBA,GAAsB,qBAAuB,EACpE,CACF,CACF,CAAC,EACH,CAACF,EAAuCD,CAAoB,CAC9D,EAE8C,IAAI,CAACI,EAA0BC,OAEzE,OAAC,MACC,WAAY,eACZ,uBAAwBD,EAAyB,aAAa,KAG9D,mBAACT,GAAyB,CAAC,aAAcS,EAAyB,aAAc,GAF3EA,EAAyB,aAAa,KAAOC,CAGpD,CAEH,CACH,C,+DC/CA,MAAMC,MAAoC,QAAK,IAAM,+BAA6C,EAarFC,GAAsB,CAAC,CAClC,aAAAC,EACA,aAAAC,EACA,UAAAC,EACA,OAAAzH,EACA,UAAA0H,EACA,SAAAC,CACF,IAAgC,CAC9B,MAAMhF,EAAW,CAAC8E,GAAa,CAACzH,EAE1B4H,EAAkBC,GAAA,GAAa,UAAU,QAEzC,CAACxD,GAAS,CAAE,KAAA3D,GAAO,CAAC,EAAG,UAAAoC,GAAW,gBAAiBgF,EAAqB,CAAC,EAAIF,EAAgB,YAAY,EAIzGG,MAAqB,YAAQrH,GAAK,QAASsH,GAAUA,GAAO,MAAM,CAAC,EAEnEC,GAAY,IAAM,CAClB,CAACjI,GAAU,CAACyH,GAKhBpD,GAAQ,CACN,aAAAkD,EACA,UAAAE,EACA,aAAAD,EACA,OAAAxH,EACA,UAAA0H,EACA,SAAAC,CACF,CAAC,CACH,EAGMO,MAA0B,OAAmD,cAAc,EAE3FC,EAAYD,GAAwB,SAAW,EAErD,SACE,QAAC9E,EAAA,EAAK,CAAC,UAAU,SACf,qBAACA,EAAA,EAAK,CAAC,UAAU,MAAM,WAAW,aAAa,eAAe,gBAC5D,qBAACA,EAAA,EAAK,CAAC,UAAU,SAAS,IAAK,EAC7B,oBAACW,EAAA,EAAI,CAAC,QAAQ,KACZ,mBAAC,KAAK,CAAC,QAAQ,sCAAsC,0CAA8B,EACrF,EACCjB,IAAagF,OACZ,OAAC/D,EAAA,EAAI,CAAC,MAAM,YAAY,QAAQ,YAC9B,mBAAC,KAAK,CAAC,QAAQ,0BAA0B,sBAAU,EACrD,EAED+D,MACC,OAAC/D,EAAA,EAAI,CAAC,MAAM,YAAY,QAAQ,YAC9B,mBAAC,KAAK,CAAC,QAAQ,8CAA8C,yIAG7D,EACF,KAEA,OAACA,EAAA,EAAI,CAAC,MAAM,YAAY,QAAQ,YAC9B,mBAAC,KAAK,CAAC,QAAQ,4CAA4C,qKAG3D,EACF,GAEJ,KACA,OAACqE,GAAA,GAAM,CAAC,KAAK,OAAO,QAAQ,YAAY,KAAK,SAAS,QAASH,GAAW,SAAAtF,EACxE,mBAAC,KAAK,CAAC,QAAQ,gDAAgD,2BAAe,EAChF,GACF,EACC,CAACG,IAAa,CAACgF,IAAwBC,GAAmB,OAAS,MAClE,OAAC,YACC,YACE,OAACM,GAAA,EAAkB,CAAC,QAAM,KAAE,qDAAsD,oBAAoB,EAAG,EAG1G,SAAAH,GAAwB,IAAKI,MAC5B,OAACjB,GAAA,CACC,mBAAAiB,EACA,mBAAAP,GACA,UAAAI,CAAA,EACKG,EAAmB,IAC1B,CACD,EACH,GAEJ,CAEJ,ECvFA,IAAKC,IAAAA,IACHA,EAAA,mBAAqB,sBACrBA,EAAA,aAAe,gBAFZA,IAAAA,IAAA,IAKL,SAASC,IAAoC,CAC3C,KAAM,CAAE,8CAAAC,CAA8C,EAAIC,EAAA,EACpD,CAAE,YAAaC,CAAe,EAAIF,EAA8C,MAAS,EAC/F,OACEE,GAAgB,sBAAwB,KAAmB,UAC3DA,GAAgB,sBAAwB,KAAmB,GAE/D,CAEO,MAAMC,GAAoB,CAAC,CAAE,SAAAjB,CAAS,IAA8B,CACzE,KAAM,CAAE,MAAAhG,EAAO,UAAA8B,EAAW,SAAA5B,CAAS,KAAI,MAA+B,EAChE1B,KAAS,MAAW,EAAS,EAE7B,CAACoB,EAAMsH,CAAa,EAAIlH,EAAM,CAAC,OAAQ,eAAe,CAAC,EACvD,CAAC+B,EAAkBC,EAAmB,KAAI,YAAS,EAAK,EAExDmF,GAAiBnH,EAAM,gBAAgB,GAAK,MAC5CoH,MAAmB,OAA2BxH,CAAI,EAClDyH,GAA2CC,EAAA,EAAO,eAAe,+BAAiC,GAClGC,GAAsB3H,IAAS,IAAa,QAC5C4H,GAAiCX,GAAkC,EAEnEY,GAA+B7H,IAAS,IAAa,SAAW4H,GAEtE,SAASvF,EAAoBC,GAAgC,CACvDA,IACFhC,EAAS,SAAUgC,EAAc,EAEnCF,GAAoB,EAAK,CAC3B,CAEA,MAAI,OAA6BpC,CAAI,EACnC,OAAO,KAGT,MAAM8H,EAAQN,GAAuB,EAAJ,EAE3BO,EACJP,IAAoBC,GAChB,CACE,eAAgB,CAACH,EACjB,gBAAkBU,IAAwB,CACxC1H,EAAS,8CAA+C,CAAC0H,EAAU,EACnE1H,EAAS,gBAAiB,CAAC0H,EAAU,CACvC,CACF,EACA,OAEAjJ,KACA,OAAsBiB,CAAI,EACrB,aAELwH,GACK,0BAEF,qCAGT,SACE,QAAC9E,EAAA,GACC,OAAQoF,EACR,MAAA/I,EACA,eACE,OAAC8C,EAAA,EAAK,CAAC,UAAU,MAAM,IAAK,GAAK,WAAW,SACzC,mBAAsB7B,CAAI,KACzB,OAACwC,EAAA,EAAI,CAAC,QAAQ,YAAY,MAAM,YAC9B,mBAAC,KAAK,CAAC,QAAQ,mEAAmE,sEAElF,EACF,EAEAqF,OACE,OAACrF,EAAA,EAAI,CAAC,QAAQ,YAAY,MAAM,YAC9B,mBAAC,KAAK,CAAC,QAAQ,2DAA2D,8EAE1E,EACF,EAGN,EAEF,WAAAuF,EACA,UAAS,GAER,WAACP,OACA,oBACE,oBAAC7E,GAAA,EAAiB,CAAC,YAAa,IAAMP,GAAoB,EAAI,EAAG,KACjE,OAACQ,GAAA,GACC,OAAQT,EACR,QAASE,EACT,eAAAkF,GACA,cAAerF,EAAU,QAAQ,EACnC,GACF,EAED2F,OACC,OAAC,OAAI,UAAWjJ,EAAO,uBACrB,mBAAC4D,EAAA,EAAI,CAAC,QAAQ,KACZ,mBAAC,KAAK,CAAC,QAAQ,wCAAwC,qBAAS,EAClE,EACF,EAEDqF,IAAgCJ,OAC/B,OAACQ,GAAA,CAAoC,SAAA7B,CAAA,CAAoB,EAE1DyB,IAAgC,CAACJ,OAChC,OAACS,GAAA,CAA0B,SAAA9B,CAAA,CAAoB,EAEhD,CAACyB,IAAgCF,OAAuB,OAACQ,GAAA,CAAiB,SAAA/B,CAAA,CAAoB,GACjG,CAEJ,EAYA,SAAS8B,GAA0B,CAAE,SAAA9B,CAAS,EAA0B,CACtE,KAAM,CAAE,MAAAhG,EAAO,SAAAE,CAAS,KAAI,MAA+B,EACrD1B,KAAS,MAAW,EAAS,EAE7B,CAAC0I,CAAa,EAAIlH,EAAM,CAAC,eAAe,CAAC,EAEzCgI,EAAiB,CACrB,CACE,SAAO,KACL,mFACA,sBACF,EACA,MAAO,eACT,EACA,CACE,SAAO,KACL,sFACA,yBACF,EACA,MAAO,qBACT,CACF,EAEMC,EAAyBC,GAA2B,CACxDhI,EAAS,gBAAiBgI,IAAW,eAA2B,CAClE,EAEA,SACE,QAACzG,EAAA,EAAK,CAAC,UAAU,SAAS,IAAK,EAC7B,oBAACA,EAAA,EAAK,CAAC,UAAU,SACf,mBAAC0G,EAAA,GACC,cAAajB,EAAgB,gCAAkC,sCAC/D,QAASc,EACT,MAAOd,EAAgB,gBAA8B,sBACrD,SAAUe,EACV,UAAWzJ,EAAO,eACpB,EACF,KAEA,OAAC4J,GAAA,CAAyB,cAAAlB,CAAA,CAA8B,EAEvDA,KAAgB,OAAC/B,GAAiB,EAAC,KAAK,OAAC4C,GAAA,CAAiB,SAAA/B,CAAA,CAAoB,GACjF,CAEJ,CAaA,SAAS6B,GAAoC,CAAE,SAAA7B,CAAS,EAA0B,CAChF,KAAM,CAAE,MAAAhG,CAAM,KAAI,MAA+B,EAE3C,CAACkH,CAAa,EAAIlH,EAAM,CAAC,eAAe,CAAC,EAE/C,SACE,QAACyB,EAAA,EAAK,CAAC,UAAU,SAAS,IAAK,EAC7B,oBAAC2G,GAAA,CAAyB,cAAAlB,CAAA,CAA8B,EAEvDA,KAAgB,OAAC/B,GAAiB,EAAC,KAAK,OAAC4C,GAAA,CAAiB,SAAA/B,CAAA,CAAoB,GACjF,CAEJ,CAMA,SAAS+B,GAAiB,CAAE,SAAA/B,CAAS,EAA0B,CAC7D,KAAM,CAAE,MAAAhG,CAAM,KAAI,MAA+B,EAC3C,CAACqI,EAAQC,EAASxC,EAAWzH,EAAQ0H,CAAS,EAAI/F,EAAM,CAC5D,SACA,UACA,YACA,SACA,OACA,eACF,CAAC,EACD,SACE,OAAC2F,GAAA,CACC,aAAc2C,EACd,aAAcD,EACd,UAAAvC,EACA,OAAAzH,EACA,UAAA0H,EACA,SAAAC,CAAA,CACF,CAEJ,CAGA,SAASuC,IAAoC,CAC3C,SACE,OAAClG,GAAA,GACC,eACE,QAACZ,EAAA,EAAK,CAAC,IAAK,EAAG,UAAU,SACvB,oBAACA,EAAA,EAAK,CAAC,UAAU,SAAS,IAAK,EAC7B,mBAAC,KAAK,CAAC,QAAQ,wEAAwE,6JAGvF,EACF,KACA,QAACA,EAAA,EAAK,CAAC,UAAU,SAAS,IAAK,EAC7B,oBAAC,KAAK,CAAC,QAAQ,gEAAgE,wLAG/E,KACA,OAAC0B,EAAA,GACC,KAAM,qGACN,SAAQ,GAER,mBAAC,KAAK,CAAC,QAAQ,4DAA4D,6CAE3E,EACF,GACF,GACF,EAEF,SAAO,KAAE,6EAA8E,sBAAsB,EAC/G,CAEJ,CAEA,SAASqF,IAA8B,CACrC,SACE,OAACnG,GAAA,GACC,eACE,oBACE,oBAAC,KAAK,CAAC,QAAQ,gEAAgE,kEAE/E,KACA,OAAC,OAAG,KACJ,OAAC,KAAK,CAAC,QAAQ,mEAAmE,oGAElF,KACA,OAAC,OAAG,KACJ,OAAC,OAAG,KACJ,QAAC,KAAK,CAAC,QAAQ,iEAAiE,0CACpD,OAAC,KAAE,4BAAgB,EAAI,uFAEnD,GACF,EAEF,aAAa,+EACb,SAAS,gCACT,SAAO,KACL,qFACA,qCACF,EACF,CAEJ,CAKO,MAAM+F,GAA2B,CAAC,CAAE,cAAAlB,CAAc,OAErD,QAACzF,EAAA,EAAK,CAAC,WAAW,SAChB,oBAACW,EAAA,EAAI,CAAC,QAAQ,YAAY,MAAM,YAC7B,SAAA8E,KACG,KACE,6CACA,yEACF,KACA,KACE,sDACA,yHACF,EACN,EACCA,KAAgB,OAACsB,GAAA,EAA4B,KAAK,OAACD,GAAA,EAAkC,GACxF,EAIE,GAAarJ,IAA0B,CAC3C,kBAAgB,OAAI,CAClB,MAAO,aACT,CAAC,EACD,0BAAwB,OAAI,CAC1B,QAAS,OACT,cAAe,SACf,UAAWA,EAAM,QAAQ,CAAC,CAC5B,CAAC,CACH,E,mTC/TO,SAASuJ,EAAsBC,EAAiE,CACrG,MAAO,SAAUA,CACnB,CAEO,SAASC,EAAwBD,EAAmE,CACzG,MAAO,sBAAuBA,CAChC,C,4BCVO,SAASE,EAAiBF,EAA8D,CAC7F,GAAID,EAAsBC,CAAO,EAC/B,OAAOG,GAAsBH,EAASA,EAAQ,cAAe,KAAa,aAAa,EAGzF,GAAIC,EAAwBD,CAAO,EACjC,OAAOG,GAAsBH,EAAS,MAA2B,KAAa,OAAO,EAGvF,MAAM,IAAI,MAAM,kCAAkC,CACpD,CAMA,SAASG,GACPH,EACAI,GACAC,GACiC,CACjC,SAAOC,EAAA,GAAqB,CAC1B,aAAcC,GAAeF,EAAQ,EACrC,UAAQ,OAAc,EACnB,MAAgC,CAC/B,OAAQ,OACR,IAAK,qBAAqBD,EAAa,GACvC,KAAMJ,CACR,CAAC,EACA,QACCQ,GAAA,GAAI,CAAC,CAAE,KAAAnK,CAAK,IACHkK,GAAeF,GAAU,CAC9B,MAAO,KAAa,KACpB,OAAQhK,EAAK,UAAU,IAAI,KAAiB,CAC9C,CAAC,CACF,KACDoK,GAAA,GAAYnK,MACHoK,GAAA,IACLH,GAAeF,GAAU,CACvB,MAAO,KAAa,MACpB,SAAOM,GAAA,GAAiBrK,CAAK,CAC/B,CAAC,CACH,CACD,KACDsK,EAAA,GAAM,CACR,CACJ,CAAC,CACH,CAEA,SAASL,GAAeF,EAAwBhK,GAA2B,CAAC,EAAwB,CAClG,MAAO,CACL,SAAAgK,EACA,KAAM,CACJ,MAAO,KAAa,QACpB,OAAQ,CAAC,EACT,aAAW,MAAoB,EAC/B,GAAGhK,EACL,CACF,CACF,C,sFChEO,SAASwK,GAAkBtI,EAAyC,CACzE,KAAM,CAAE,QAAAuI,EAAQ,EAAIvI,EACdzC,MAAS,MAAWC,EAAS,EAE7BgL,EAAiC,CACrC,SAAU,CAAC,EACX,UAAW,CACT,CACE,QAAS,CAAE,GAAI,MAAe,OAAQ,QAAS,MAAO,EACtD,WAAY,CAAC,CAAE,GAAI,qBAAsB,MAAO,MAAqB,QAAS,CAAC,CACjF,CACF,CACF,EAEA,GAAI,CAACD,GACH,OAAO,KAGT,KAAM,CAAE,KAAAzK,GAAM,SAAAgK,EAAS,EAAIS,GAE3B,OAAIzK,GAAK,QAAU,KAAa,WAE5B,OAAC,OAAI,UAAWP,GAAO,UACrB,mBAAC,QACC,mBAAC,KAAK,CAAC,QAAQ,+CAA+C,8BAAkB,EAClF,EACF,EAIAO,GAAK,QAAU,KAAa,SAE5B,OAAC,OAAI,UAAWP,GAAO,UACpB,SAAAO,GAAK,SACF,OAAiBA,GAAK,KAAK,KAC3B,KAAE,8CAA+C,8BAA8B,EACrF,KAKF,QAAC,OAAI,UAAWP,GAAO,UACrB,oBAAC,KAAK,CAAC,QAAQ,6DAA6D,8EAE5E,EACCuK,KAAa,KAAa,YACzB,OAAC,KAAK,CAAC,QAAQ,kEAAkE,4EAEjF,KAEF,OAAC,OAAI,UAAWvK,GAAO,MACrB,mBAAC,MAAS,CACP,UAAC,CAAE,MAAAkL,GAAO,OAAAC,EAAO,OAChB,OAAC,OAAI,MAAO,CAAE,MAAO,GAAGD,EAAK,KAAM,OAAQ,GAAGC,EAAM,IAAK,EACvD,mBAACC,GAAA,GACC,MAAM,GACN,MAAAF,GACA,OAAAC,GACA,SAAS,QACT,KAAA5K,GACA,YAAA0K,CAAA,CACF,EACF,EAEJ,EACF,GACF,CAEJ,CAEA,SAAShL,GAAUS,EAAsB,CACvC,MAAO,CACL,aAAW,OAAI,CACb,OAAQ,GAAGA,EAAM,QAAQ,CAAC,CAAC,IAC7B,CAAC,EACD,SAAO,OAAI,CACT,KAAM,WACN,OAAQ,QACR,UAAWA,EAAM,QAAQ,CAAC,EAC1B,OAAQ,aAAaA,EAAM,OAAO,OAAO,MAAM,GAC/C,aAAcA,EAAM,MAAM,OAAO,OACnC,CAAC,CACH,CACF,CChFA,MAAM2K,GAAsC,CAAC,OAAQ,iBAAkB,YAAa,UAAW,YAAY,EAEpG,SAASC,IAAyC,CACvD,MAAMtL,KAAS,MAAW,EAAS,EAC7B,CAACgL,GAASlD,EAAS,EAAIyD,GAAW,EAClC,CAAE,MAAA/J,CAAM,KAAI,MAA+B,EAC3C,CAACJ,GAAMkG,GAAWwC,EAAO,EAAItI,EAAM,CAAC,OAAQ,YAAa,SAAS,CAAC,EACnE,CAAE,wBAAAgK,EAAwB,KAAIC,GAAA,GAAsB3B,EAAO,EAEjE,GAAI,CAAC1I,OAAQ,OAA8BA,EAAI,EAC7C,OAAO,KAGT,MAAMsK,GAAqB,EAAQpE,IAAckE,GAEjD,SACE,QAAC,OAAI,UAAWxL,EAAO,UACrB,qBAACiD,EAAA,EAAK,CACH,UAAAuI,OACC,OAACvD,EAAA,GAAM,CAAC,SAAU,CAACyD,GAAoB,KAAK,SAAS,QAAQ,UAAU,QAAS5D,GAC9E,mBAAC,KAAK,CAAC,QAAQ,uCAAuC,0BAAc,EACtE,EAED,CAAC0D,OACA,OAACG,EAAA,GACC,SAAO,KAAE,uDAAwD,0BAA0B,EAC3F,SAAS,UAET,mBAAC,KAAK,CAAC,QAAQ,sDAAsD,6GAErE,EACF,GAEJ,KACA,OAACZ,GAAiB,CAAC,QAAAC,EAAA,CAAkB,GACvC,CAEJ,CAEO,SAASO,IAA4D,CAC1E,KAAM,CAACP,EAASY,EAAU,KAAI,YAA0C,EAClE,CAAE,UAAAtI,EAAU,KAAI,MAA+B,EAC/CuI,KAAYC,EAAA,GAAgB,EAE5BhE,MAAY,eAAY,IAAM,CAClC,MAAMiE,GAASzI,GAAU+H,EAAM,EACzBnB,GAAU8B,GAAqBD,EAAM,EAE3C3B,EAAiBF,EAAO,EACrB,QAAK+B,EAAA,GAAWC,IAAa,CAACC,GAAYD,EAAQ,EAAG,EAAI,CAAC,EAC1D,UAAWA,IAAa,CAClBL,EAAU,GAGfD,GAAWM,EAAQ,CACrB,CAAC,CACL,EAAG,CAAC5I,GAAWuI,CAAS,CAAC,EAEzB,MAAO,CAACb,EAASlD,EAAS,CAC5B,CAEA,SAASkE,GAAqBD,EAAmC,CAC/D,KAAM,CAAC3K,GAAMuH,GAAgBrB,EAAWwC,GAASsC,EAAU,EAAIL,EACzDM,MAAa,KAAiB,EAAE,oBAAoB1D,EAAc,EACxE,GAAI,CAAC0D,GACH,MAAM,IAAI,MAAM,wCAAwC1D,EAAc,EAAE,EAG1E,OAAQvH,GAAM,CACZ,KAAK,KAAa,cAChB,MAAO,CACL,cAAeiL,GAAW,IAC1B,eAAA1D,GACA,KAAMyD,EACR,EAEF,KAAK,KAAa,QAChB,MAAO,CACL,kBAAmB,CACjB,UAAA9E,EACA,KAAMwC,GACN,OAAK,MAAkB,KAAK,IAAI,CAAC,CACnC,CACF,EAEF,QACE,MAAM,IAAI,MAAM,cAAc1I,EAAI,4BAA4B,CAClE,CACF,CAEA,SAAS+K,GAAYD,EAAwC,CAC3D,OAAQA,EAAS,KAAK,MAAO,CAC3B,KAAK,KAAa,KAClB,KAAK,KAAa,MAChB,MAAO,GACT,QACE,MAAO,EACX,CACF,CAEA,SAAS,GAAUxL,EAAsB,CACvC,MAAO,CACL,aAAW,OAAI,CACb,UAAWA,EAAM,QAAQ,CAAC,EAC1B,SAAU,GAAGA,EAAM,YAAY,OAAO,GAAG,IAC3C,CAAC,CACH,CACF,C,yVC1FO,SAAS4L,EAAqB,CAAE,SAAAC,GAAU,SAAA/E,EAAS,EAA8B,CACtF,MAAMgF,MAA0C,WAAQ,IAAM,CAC5D,MAAMC,EAAkB,KAAa,QAErC,MAAO,CACL,MAAG,MAAqB,EACxB,UAAW,IACX,WAAS,OAAkB,EAAK,EAChC,KAAMA,EACN,cAAe,IACjB,CACF,EAAG,CAAC,CAAC,EAECC,MAAU,MAAwB,CACtC,KAAM,WACN,cAAeH,IAAYC,GAC3B,iBAAkB,EACpB,CAAC,EAEKG,GAAW,EAAQJ,GACnBrM,MAAY,MAAmB,EAC/B,CAAE,SAAA0M,EAAS,KAAI,KAAY,gBAAgB,EAE3C,CAACC,GAAYC,EAAa,KAAI,YAAqC,MAAS,EAC5E,CAACC,GAAmBC,EAAoB,KAAI,YAAS,EAAE,EAEvDC,GAAY,IAAY,CAC5B/M,GAAU,MAAM,kEAAkE,CACpF,EAEMgN,EAAsB,CAACC,EAAM,KAAO,CACxCH,GAAqBG,CAAG,CAC1B,EAEMC,GAAUP,GAA2C,CACzD,GAAIE,KAAsB,GAAI,CAC5B7M,GAAU,MAAM6M,EAAiB,EACjC,MACF,CACAD,GAAcD,CAAU,CAC1B,EAEM9M,MAAU,eAAY,IAAM,CAChC+M,GAAc,MAAS,CACzB,EAAG,CAACA,EAAa,CAAC,EAElB,SACE,OAAC,KAAY,CAAE,GAAGJ,GAChB,oBAAC,IAAK,CAAC,UAAU,SACf,oBAAC,QAAK,SAAWjM,GAAMA,EAAE,eAAe,EACtC,mBAAC,OACC,oBAAC,IAAK,CAAC,UAAU,SAAS,IAAK,EAE7B,oBAAC,KAAsB,EAAC,KAExB,OAAC,KAAuB,CAAC,oBAAqBkM,GAAU,aAAcO,EAAqB,KAAK,OAAQ,MAExG,OAAC,IAA0B,EAAC,KAG5B,OAAC,KAA6B,CAAC,SAAU,EAAQP,GAAW,wBAAyB,GAAM,KAE3F,OAAC,KAAiB,CAAC,SAAAnF,EAAA,CAAoB,KAEvC,OAAC,KAAe,EAAC,GACnB,EACF,EACF,EACCqF,OAAc,OAACQ,GAAA,CAA0B,aAAcR,GAAY,QAAA9M,GAAkB,IAAKyH,EAAA,CAAU,KACrG,QAAC,IAAK,CAAC,UAAU,MACf,oBAAC,KAAM,CAAmB,QAASkF,GAAQ,aAAcY,GAAeF,GAAOE,CAAU,EAAGL,EAAS,EACnG,mBAAC,KAAK,CAAC,QAAQ,yDAAyD,kBAAM,GADpE,aAEZ,KACA,OAAC,KAAU,CAAC,KAAML,GAAuB,QAAQ,YAAY,QAAS,IAAMQ,GAAO,MAAS,EAC1F,mBAAC,KAAK,CAAC,QAAQ,yBAAyB,kBAAM,GADhB,QAEhC,GACF,GACF,EACF,CAEJ,CAEA,MAAMG,GAAc,CAACC,GAAsBC,KAAkB,CAC3D,KAAM,CAAE,WAAAC,EAAW,KAAI,MAAsB,KAAyB,EAEhEC,GAAcD,IAAY,YAMhC,SAJoB,KAAS,SACpBC,GAAc,QAAM,MAAqBA,GAAaH,GAAcC,EAAK,EAAI,OACnF,CAACE,GAAaH,GAAcC,EAAK,CAAC,CAGvC,EAQaG,GAAqB,CAChCN,GACAO,GACAC,KAC8B,CAC9B,MAAMC,MAAiB,OAAgCT,EAAU,EAE3DU,GAAc,CAAE,GAAGD,GAAgB,cAAe,CAAE,GAAGA,GAAe,cAAe,IAAKD,EAAQ,CAAE,EAC1G,GAAID,IAAe,MAAO,CAExB,IAAII,GAAuB,GAC3B,MAAMC,GAAeL,GAAc,MAAM,IAAKM,IACxC,IAAc,QAAQ,KAAKA,EAAI,GAAKA,GAAK,cAAc,MAAQL,IACjEG,GAAuB,GAChBD,IAEAG,EAEV,EACD,OAAKF,IAEHC,GAAa,KAAKF,EAAW,EAExB,CACL,GAAGH,GACH,MAAOK,EACT,CACF,KAEE,OAAO,CACL,KAAML,IAAe,MAAQP,GAAW,MACxC,MAAO,CAACU,EAAW,CACrB,CAEJ,EAEMI,GAAwB,CAACrC,GAAwB+B,KAAqB,CAC1E,MAAMO,GAAgBd,GAAYxB,GAAO,QAAQ,KAAO,GAAIA,GAAO,KAAK,EAIxE,MAAO,CAAE,WAHkC,WAAQ,IAC1C6B,GAAmB7B,GAAQsC,IAAe,MAAOP,EAAO,EAC9D,CAACA,GAASO,GAAetC,EAAM,CAAC,EACjB,aAAcsC,GAAc,OAAQ,CACxD,EAEMC,GAAiC,CAAC,CACtC,aAAAC,GACA,aAAAC,GACA,QAAAzO,GACA,IAAA8C,EACF,IAA2C,CACzC,KAAM,CAAC4L,GAAW5B,EAAU,EAAI,KAAa,UAAU,wBAAwB,YAAY,EACrF,CAAE,aAAA6B,GAAc,QAAAC,EAAQ,EAAIP,GAAsBI,GAAc3L,EAAG,EAEnE2K,GAAegB,GAAa,QAAQ,KAAO,GAMjD,MAJA,aAAU,IAAM,CACd,CAACE,IAAgBC,GAAQ,MAAQF,GAAU,CAAE,QAAAE,GAAS,OAAQJ,GAAc,aAAAf,EAAa,CAAC,CAC5F,EAAG,CAACA,GAAce,GAAcI,GAASF,GAAWC,EAAY,CAAC,EAE7D7B,GAAW,UACb,SAAO,OAAC,IAAkB,CAAC,QAAM,KAAE,2DAA4D,aAAa,EAAG,EAGjH,MAAM+B,GAAmB,iBAAiBD,GAAQ,IAAI,IAAI9L,EAAG,IAAI,IAAI,KAAK,EAAE,QAAQ,CAAC,GAErF,SACE,OAAC,KACC,OAAQ0L,GACR,eAAgB1B,GAAW,MAAQ,GACnC,iBAAA+B,GACA,QAAA7O,EAAA,CACF,CAEJ,EAQasN,MAA4B,QAAK,CAAC,CAAE,QAAAtN,GAAS,aAAAyO,GAAc,IAAA3L,EAAI,IAAsC,CAChH,MAAMgM,GAAmB,CAAChM,GACpBiM,GAAaD,GAAmB,MAAQ,OACxC,CAACE,GAAWC,EAAY,KAAI,YAAwBF,EAAU,EAE9DG,GAAkBJ,GAAmB,CAAC,IAAiB,EAAI,OAAO,OAAO,IAAyB,EAExG,SACE,OAAC,MACC,SAAO,KAAE,2DAA4D,cAAc,EACnF,UAAAE,GACA,YAAaC,GACb,QAAAjP,GACA,gBAAAkP,GAEA,mBAACX,GAAA,CACC,aAAcS,GACd,QAAAhP,GACA,aAAAyO,GACA,IAAA3L,EAAA,CACF,EACF,CAEJ,CAAC,EAEDwK,GAA0B,YAAc,2B,mFCnOjC,SAASrJ,EAAkB,CAAE,OAAAkL,EAAQ,QAAAnP,EAAS,eAAA4I,EAAgB,cAAAwG,CAAc,EAA2B,CAC5G,SACE,OAAC,KACC,SAAO,KAAE,iDAAkD,aAAa,EACxE,cAAa,GACb,OAAAD,EACA,UAAW,IAAMnP,EAAQ,EAEzB,mBAAC,KAAa,CAAC,eAAA4I,EAAgC,QAAA5I,EAAkB,cAAAoP,CAAA,CAA8B,EACjG,CAEJ,C,0ICbO,SAASpL,EAAkB,CAAE,YAAAqL,CAAY,EAA2B,CACzE,KAAM,CAAE,MAAA5N,CAAM,KAAI,MAA+B,EAE3CqI,EAASrI,EAAM,QAAQ,EACvBJ,EAAOI,EAAM,MAAM,EAInB6N,IAFkBjO,KAAO,MAAsBA,CAAI,EAAI,OAGzD,KAAE,sCAAuC,0BAA0B,KACnE,KACE,qCACA,wFACF,EAEEkO,GAAY,OAAO,KAAKzF,CAAM,EAAE,OAAS,GAAKA,EAAO,KAAMhC,GAAUA,EAAM,KAAOA,EAAM,KAAK,EAEnG,SACE,QAAC,IAAK,CAAC,UAAU,SAAS,IAAK,EAC7B,qBAAC,IAAK,CAAC,UAAU,SAAS,IAAK,EAC7B,oBAAC,IAAI,CAAC,QAAQ,KACZ,mBAAC,KAAK,CAAC,QAAQ,uCAAuC,kBAAM,EAC9D,KACA,QAAC,IAAK,CAAC,UAAW,MAAO,IAAK,EAC5B,oBAAC,IAAI,CAAC,QAAQ,YAAY,MAAM,YAC7B,SAAAwH,EAAA,CACH,KACA,OAAC,KACC,aAAc,8FACd,SAAU,oBACV,YAAY;AAAA,2EAEZ,SAAO,KAAE,6CAA8C,QAAQ,EACjE,GACF,GACF,KACA,QAAC,IAAK,CAAC,UAAU,MAAM,IAAK,EAAG,WAAW,SACxC,oBAAC,KAAY,CAAC,OAAAxF,CAAA,CAAgB,EAC7ByF,MACC,OAAC,KAAM,CAAC,QAAQ,YAAY,KAAK,SAAS,QAASF,EAAa,KAAK,KACnE,mBAAC,KAAK,CAAC,QAAQ,4CAA4C,uBAAW,EACxE,KAEA,QAAC,IAAK,CAAC,UAAU,MAAM,IAAK,EAAG,WAAW,SACxC,oBAAC,IAAI,CACH,mBAAC,KAAK,CAAC,QAAQ,mDAAmD,8BAAkB,EACtF,KACA,OAAC,MACC,KAAK,OACL,KAAK,SACL,QAAQ,YACR,QAASA,EACT,KAAK,KACL,cAAY,oBAEZ,mBAAC,KAAK,CAAC,QAAQ,2CAA2C,sBAAU,EACtE,GACF,GAEJ,GACF,CAEJ,C,gfC5DO,SAASG,GAA2B,CAAE,OAAAlE,CAAO,EAA4B,CAC9E,MAAMmE,EAAcnE,EAAO,OAAQjJ,GAAU,CAAC,CAAC,QAAS,MAAM,EAAE,SAASA,EAAM,IAAI,CAAC,EAC9EqN,EAAkBpE,EAAO,UAAWjJ,GAAUA,EAAM,OAAS,OAAO,EACpEsN,EAAiBrE,EAAO,UAAWjJ,GAAUA,EAAM,OAAS,MAAM,EAElEuN,EAAeH,EAAY,IAAKI,GAAevE,EAAO,QAAQuE,CAAU,CAAC,EAEzEC,EAAsBxE,EAAOoE,CAAe,GAAG,OAAO,QAAU,EAEhEK,EAAoC,CAAC,EAE3C,QAAS7I,EAAQ,EAAGA,EAAQ4I,EAAqB5I,IAAS,CACxD,MAAM8I,EAAcJ,EAAa,IAAKK,GAAe,CAAC3E,EAAO2E,CAAU,EAAE,KAAM3E,EAAO2E,CAAU,EAAE,OAAO/I,CAAK,CAAC,CAAC,EAC1GgJ,EAAQ5E,EAAOoE,CAAe,GAAG,SAASxI,CAAK,EAC/CiJ,EAAO7E,EAAOqE,CAAc,GAAG,SAASzI,CAAK,KAE/C,OAAoBgJ,CAAK,GAC3BH,EAAU,KAAK,CACb,MAAAG,EACA,KAAAC,EACA,OAAQ,OAAO,YAAYH,CAAW,CACxC,CAAC,CAEL,CAEA,MAAO,CAAE,UAAAD,CAAU,CACrB,CC3BO,SAASK,GAAkB,CAAE,QAAAnF,CAAQ,EAA2B,CACrE,MAAMhL,KAAS,MAAWC,EAAS,EAC7BmQ,EAAeb,GAA2BvE,CAAO,EAEvD,SACE,QAAC,SAAM,UAAWhL,EAAO,MACvB,qBAAC,WACC,oBAAC,OACC,mBAAC,KAAK,CAAC,QAAQ,8CAA8C,0BAAc,EAC7E,KACA,OAAC,QACC,mBAAC,KAAK,CAAC,QAAQ,qDAAqD,6EAEpE,EACF,GACF,KACA,OAAC,SACC,oBAAC,MACC,oBAAC,MACC,mBAAC,KAAK,CAAC,QAAQ,qCAAqC,iBAAK,EAC3D,KACA,OAAC,MACC,mBAAC,KAAK,CAAC,QAAQ,sCAAsC,kBAAM,EAC7D,KACA,OAAC,MACC,mBAAC,KAAK,CAAC,QAAQ,oCAAoC,gBAAI,EACzD,GACF,EACF,KACA,OAAC,SACE,SAAAoQ,EAAa,UAAU,IAAI,CAAC,CAAE,MAAAH,EAAO,KAAAC,EAAM,OAAArG,CAAO,EAAG5C,IAAU,CAC9D,MAAMoJ,KAAe,OAAaxG,CAAM,EAExC,SACE,QAAC,MACC,oBAAC,MAAI,mBAACyG,GAAA,EAAa,CAAC,MAAAL,CAAA,CAAc,EAAG,KACrC,OAAC,MACC,mBAACM,GAAA,EAAO,CAAC,KAAMF,EAAc,UAAWrQ,EAAO,QAAS,EAC1D,KACA,OAAC,MACE,SAAAkQ,MACC,OAACM,GAAA,EAAO,CAAC,QAASN,EAChB,mBAACO,GAAA,EAAI,CAAC,KAAK,aAAc,GAC3B,EAEJ,IAXOxJ,CAYT,CAEJ,CAAC,EACH,GACF,CAEJ,CAEA,MAAMhH,GAAaS,IAA0B,CAC3C,SAAO,OAAI,CACT,MAAO,OACP,OAAQA,EAAM,QAAQ,EAAG,CAAC,EAE1B,QAAS,CACP,YAAa,MACb,MAAOA,EAAM,OAAO,KAAK,QAEzB,WAAY,CACV,SAAUA,EAAM,WAAW,UAAU,SACrC,MAAOA,EAAM,OAAO,KAAK,SAC3B,CACF,EAEA,SAAU,CACR,QAASA,EAAM,QAAQ,EAAG,CAAC,CAC7B,EAEA,mBAAoB,CAClB,YAAaA,EAAM,QAAQ,CAAC,CAC9B,EAEA,WAAY,CACV,iBAAkB,CAChB,MAAO,MACT,EAEA,iBAAkB,CAChB,MAAO,MACT,EAEA,iBAAkB,CAChB,MAAO,MACT,CACF,EAEA,kBAAmB,CACjB,UAAW,QACb,EAEA,6BAA8B,CAC5B,gBAAiBA,EAAM,OAAO,WAAW,SAC3C,CACF,CAAC,EACD,WAAS,OAAI,CACX,eAAgB,YAClB,CAAC,CACH,G,gBC5FO,MAAMgQ,GAAmB,CAAC,CAC/B,MAAAnO,EACA,SAAAL,EACA,eAAAyG,EACA,wBAAAgI,EAA0B,EAC5B,IAA6B,CAC3B,MAAM3Q,KAAS,MAAW,CAAS,EAE7B,CAAE,WAAA4Q,EAAY,WAAAC,CAAW,EAAIC,GAAgBnI,CAAc,EAE3DoI,EAAYF,EAAW,CAAE,MAAO,IAAK,KAAM,EAAM,EAAGtO,CAAK,EAEzD,CACJ,MAAA/B,EACA,QAAAQ,EACA,MAAOgQ,CACT,KAAIC,GAAA,GAAS,OACJ,KAAiB,EAAE,IAAItI,CAAc,EAC3C,CAACA,CAAc,CAAC,EAEbuI,KAAgB,eACnBC,IAAqB,CACpBjP,EAAS0O,EAAWO,EAAK,CAAC,CAC5B,EACA,CAACjP,EAAU0O,CAAU,CACvB,EAEM,CAACR,GAActI,EAAS,KAAI,MAAW,EAEvCsJ,GAAoB,SAAY,CACpCtJ,GAAU,CACZ,EAEA,GAAI9G,GAAWgQ,GAAY,OAASrI,EAClC,OAAO,KAGT,MAAM0I,KAAM,KAAiB,EAAE,oBAAoB1I,CAAc,EAEjE,GAAInI,GAAS,CAACwQ,GAAc,CAACA,GAAY,YAAY,aAAe,CAACK,EAAK,CACxE,MAAMC,GACJ9Q,GAAO,YACP,KACE,gDACA,+DACF,EACF,SACE,OAAC,OACC,oBAAC,KAAK,CAAC,QAAQ,mDAAmD,iDAC3B,CAAE,aAAA8Q,EAAa,GACtD,EACF,CAEJ,CAEA,MAAMC,EAAgBnB,IAAc,KAAK,QAAU,MAAa,KAE1DoB,GAAcR,GAAY,YAAY,YAGtCS,GAAmBrB,IAAc,MAAM,QAAQ,KAAMsB,IAAMA,GAAE,OAAS,oBAAoB,EAE1FC,GAAmBF,IAAoBA,GAAiB,OAAO,KAAMrP,IAAUA,GAAM,OAAO,OAAS,CAAC,EAE5G,SACE,oBACE,oBAACwP,GAAA,EAA+B,CAAC,iBAAkBP,EACjD,mBAACG,GAAA,CACC,MAAOT,EACP,QAAS,CAACA,CAAS,EACnB,IAAK,MAAQ,cACb,SAAUG,EACV,WAAY,OACZ,WAAYF,CAAA,CACd,EACF,EACCL,MACC,QAAC,OAAI,UAAW3Q,EAAO,QACrB,oBAACiI,EAAA,IACC,KAAK,SACL,QAASmJ,GACT,SAAUhB,IAAc,KAAK,QAAU,MAAa,QAEpD,mBAAC,KAAK,CAAC,QAAQ,4CAA4C,0BAAc,EAC3E,EACCmB,GAAiB,CAACI,OACjB,OAAChG,EAAA,GACC,SAAO,KAAE,kDAAmD,gBAAgB,EAC5E,SAAS,OACT,UAAW3L,EAAO,aAElB,mBAAC,KAAK,CAAC,QAAQ,uDAAuD,sDAEtE,EACF,EAED2R,OAAoB,OAACxB,GAAiB,CAAC,QAASsB,EAAA,CAAkB,GACrE,GAEJ,CAEJ,EAEM,EAAa/Q,IAA0B,CAC3C,WAAS,OAAI,CACX,QAASA,EAAM,QAAQ,EAAG,CAAC,EAC3B,SAAU,GAAGA,EAAM,YAAY,OAAO,EAAE,IAC1C,CAAC,EACD,gBAAc,OAAI,CAChB,OAAQA,EAAM,QAAQ,EAAG,CAAC,CAC5B,CAAC,CACH,GAOO,SAASoQ,GAAgBnI,EAAsC,CACpE,SAAO,WAAQ,IAAM,CACnB,MAAMkJ,KAAW,KAAiB,EAAE,oBAAoBlJ,CAAc,EACtE,GAAI,CAACkJ,EACH,MAAM,IAAI,MAAM,cAAclJ,CAAc,YAAY,EAG1D,GAAI,IAAC,OAAmCkJ,EAAS,IAAI,EACnD,MAAM,IAAI,MAAM,GAAGA,EAAS,IAAI,2CAA2C,EAG7E,MAAO,CACL,WAAaV,GAAsBA,EAAgC,KACnE,WAAY,CAACxE,EAAqBpK,KAA+B,CAAE,GAAGoK,EAAU,KAAMpK,CAAM,EAC9F,CACF,EAAG,CAACoG,CAAc,CAAC,CACrB,C,2BCvIO,MAAMmJ,GAAoB,CAAC,CAChC,UAAAxK,EACA,eAAAyK,EACA,QAAAjI,EACA,UAAAkI,EACA,cAAAC,EACA,mBAAAC,EACA,uBAAAC,EACA,wBAAAC,CACF,IAAa,CACX,MAAMC,KAAoB,WAAQ,IACzBvI,EAAQ,OAAO,CAACwI,EAAwBnB,OACtC,KAAkBA,EAAM,KAAK,EAAImB,EAAI,OAAOnB,EAAM,KAAK,EAAImB,EACjE,CAAC,CAAC,EACJ,CAACxI,CAAO,CAAC,EACN9J,KAAS,MAAW,EAAS,EAEnC,SACE,OAAC,OAAI,UAAWA,EAAO,QACpB,SAAAqS,EAAkB,IAAKlB,GAAU,CAChC,MAAM5Q,EAAOyR,EAAUb,EAAM,KAAK,EAE5BoB,GAAmBjL,IAAc6J,EAAM,MAEvCqB,GAAqBjS,GAAQgS,MAAmB,MAA0BhS,CAAI,EAAI,OAElFC,GADmBD,KAAO,MAAqBA,CAAI,EAAI,SAC3BiS,GAE5BC,EAAUlS,KAAO,MAAkBA,EAAK,MAAM,EAAI,OAExD,SACE,OAACmS,GAAA,IAEC,iBAAAH,GACA,KAAAhS,EACA,MAAAC,EACA,QAAAiS,EACA,QAAA3I,EACA,MAAAqH,EACA,eAAAY,EACA,mBAAAG,EACA,cAAAD,EACA,uBAAAE,EACA,cAAeC,CAAA,EAXVjB,EAAM,KAYb,CAEJ,CAAC,EACH,CAEJ,EACM,GAAazQ,IAA0B,CAC3C,WAAS,OAAI,CACX,QAAS,OACT,IAAKA,EAAM,QAAQ,CAAC,EACpB,aAAc,UACd,SAAU,MACZ,CAAC,CACH,G,mMC/DO,MAAMiS,GAAe,CAAC,CAC3B,MAAAxB,EACA,aAAAyB,EACA,kBAAAC,EACA,qBAAAC,EACA,MAAA7L,CACF,IAAyB,CACvB,MAAMjH,KAAS,MAAW,EAAS,EAE7B,CAAC+S,EAAaC,CAAc,KAAI,YAAS,EAAK,EAE9CC,EAAY9B,EAAM,kBAAoB,uBAA8BA,EAAM,iBAAiB,EAAI,OAE/FlL,KAAY,OAAC,QAAK,cAAE,EAE1B,SACE,oBACE,oBAACiN,GAAA,GACC,WACE,QAAC,OAAI,UAAWlT,EAAO,aACpB,UAAA6S,MACC,OAAC3M,GAAA,EAAW,CAAC,SAAO,KAAE,0CAA2C,YAAY,EAC3E,mBAACiN,GAAA,GACC,UAAWhC,EAAM,sBAAqB,MAA4B,EAClE,SAAWiC,GAAUP,EAAkBO,EAAOnM,CAAK,EACrD,EACF,KAEF,OAACoM,EAAmB,CAAC,QAAST,EAAc,SAAWU,GAAYR,EAAqBQ,EAASrM,CAAK,EAAG,KACzG,OAACsM,EAAiB,CAAC,QAASX,EAAc,SAAWU,GAAYR,EAAqBQ,EAASrM,CAAK,EAAG,GACzG,EAEF,YAAa,GACb,UAAU,eAEV,oBAAC,UAAO,KAAK,SAAS,UAAWjH,EAAO,WAAY,QAAS,IAAMgT,EAAe,CAACD,CAAW,EAC5F,oBAAC,KAAK,CAAC,QAAQ,wCAAwC,mBAAO,EAAS,IACtEA,KAAc,OAACtC,GAAA,EAAI,CAAC,KAAK,aAAc,MAAK,OAACA,GAAA,EAAI,CAAC,KAAK,YAAa,IACvE,EACF,KAEA,QAAC,OAAI,UAAWzQ,EAAO,aACrB,oBAAC,QAAM,mBAASiT,GAAW,IAAI,EAAE,OAAO,IAAI,EAAE,QAAQ,EAAI,EAAE,EAE3DL,EAAa,kBACZ,oBACG,UAAA3M,KACD,QAAC,MACC,QAAQ,yCACR,OAAQ,CAAE,cAAe2M,EAAa,aAAc,EACrD,kBACO,qBACR,GACF,EAEDA,EAAa,gBACZ,oBACG,UAAA3M,KACD,QAAC,KAAK,CAAC,QAAQ,sCAAsC,OAAQ,CAAE,YAAa2M,EAAa,WAAY,EAAG,6BACrF,mBACnB,GACF,GAEJ,GACF,CAEJ,EAEM,GAAalS,GAAyB,CAC1C,MAAM8S,KAAc,MAAkB9S,CAAK,EAE3C,MAAO,CACL,gBAAc,OAAI,CAChB,QAAS,CACP,eAAgB,eAClB,CACF,CAAC,EAED,gBAAc,OAAI,CAChB,MAAOA,EAAM,OAAO,KAAK,UACzB,YAAaA,EAAM,QAAQ,CAAC,CAC9B,CAAC,EAED,cAAY,OAAI8S,EAAa,CAC3B,MAAO9S,EAAM,OAAO,KAAK,KACzB,OAAQ,UAER,UAAW,CACT,eAAgB,WAClB,CACF,CAAC,CACH,CACF,E,eC7EO,MAAM+S,EAA0B,MAC1BC,EAAuB,KA4BvBC,EAAe,CAAC,CAC3B,KAAApT,EACA,MAAAC,EACA,WAAA6L,EACA,MAAApF,EACA,mBAAA2M,EACA,cAAA1C,EACA,kBAAA2B,EACA,aAAAgB,EACA,cAAAC,EACA,iBAAAC,EACA,MAAA5C,EACA,QAAArH,EACA,WAAAkK,GACA,eAAAC,GACA,kBAAAC,GACA,UAAA5M,EACA,eAAAyK,EACA,qBAAAe,EACF,IAAa,CACX,MAAM9S,MAAS,MAAW,CAAS,EAC7B,CAACmU,GAAYC,EAAa,KAAI,YAAwB,EACtDC,GAAWF,IAAY,gBAAkBA,GAAW,gBAAgB,MAAQ,eAAe,EAAI,CAAC,EAEhG,CAAE,UAAA7Q,EAAU,KAAI,MAA+B,EAE/CgR,GADsBxL,EAAA,EAAO,eAAe,qCAAuC,GAC5CxF,GAAU,sCAAsC,IAAM,GAAO,GAEpGiR,GAAoB,CACxB,GAAGF,GACH,MAAG,aAAUlD,EAAM,KAAK,CAC1B,EAEIoD,GAAkB,YAAcA,GAAkB,YAAY,MAAQpD,EAAM,mBAC9E,OAAQ,mDAAoD,CAC1D,wBAAyBoD,GAAkB,YAAY,KAAO,GAC9D,mBAAoBpD,EAAM,cAC1B,eAAgBA,EAAM,MAAM,YAAY,MAAQ,cAClD,CAAC,EAQG,OAAOoD,GAAkB,YAAe,UAAoBA,GAAkB,WAChFA,GAAkB,WAAW,IAAMpD,EAAM,eAGzCoD,GAAkB,WAAa,CAAC,EAChCA,GAAkB,WAAW,IAAMpD,EAAM,cACzCoD,GAAkB,WAAW,KAAOpD,EAAM,MAAM,YAAY,KAC5DoD,GAAkB,WAAW,WAAapD,EAAM,MAAM,YAAY,aAItE,SAASqD,IAA6B,CACpC,MAAMxU,MAAS,MAAW,CAAS,EACnC,SACE,OAAC,OAAI,UAAWA,GAAO,UACrB,mBAACwQ,GAAA,GACC,WACE,OAAC,KAAK,CAAC,QAAQ,yDAAyD,2IAGxE,EAGF,mBAACC,GAAA,GACC,KAAK,cACL,QAAS,IACP,OAAO,KACL,uFACA,QACF,EAEJ,EACF,EACF,CAEJ,CAGA,SAASgE,GAAa,CACpB,MAAAtD,GACA,MAAA3Q,GACA,MAAAyG,GACA,eAAAqN,GAAiB,EACnB,EAKG,CACD,MAAM1B,GAAkC,CACtC,cAAezB,GAAM,MAAM,cAC3B,YAAaA,GAAM,MAAM,cAAa,OAAuBA,GAAM,MAAM,UAAU,EAAI,MACzF,EACMuD,GAAuC,CAC3C,cAAe9B,GAAa,cAC5B,YAAaA,GAAa,WAC5B,EAEML,GAAmBjL,IAAc6J,GAAM,MAE7C,SACE,QAAClO,EAAA,EAAK,CAAC,UAAU,MAAM,WAAW,SAAS,IAAK,EAC9C,oBAACuR,GAAA,EAA2B,KAC5B,OAAC7B,GAAA,CACC,kBAAAE,EACA,MAAO1B,GACP,aAAcuD,GACd,qBAAA5B,GACA,MAAO7L,EAAA,CACT,EACCqN,OACC,OAACK,GAAA,GACC,eAAgB,IAAM5C,EAAeZ,GAAM,KAAK,EAChD,YAAaoB,EAAA,CACf,GAEJ,CAEJ,CAEA,MAAMqC,GAAoBrU,EAAK,QAAU,MAAa,WAGhDsU,MAAgB,aAAU/K,EAAQ,IAAKqH,IAAUA,GAAM,KAAK,CAAC,EAC7DiC,GAAQ,uBAA8BjC,EAAM,sBAAqB,MAA4B,CAAC,EAEpG,SACE,QAAClO,EAAA,EAAK,CAAC,UAAU,SAAS,IAAK,GAC7B,oBAAC,OAAI,UAAWjD,GAAO,QACrB,mBAAC8U,GAAA,GACC,UAAW,CAACR,GACZ,kBAAmB,CAACA,GACpB,YAAa,GACb,WAAYjI,EACZ,mBAAoB+H,GACpB,mBAAqBvC,IAAa+B,EAAmB/B,GAAU5K,CAAK,EACpE,GAAIkK,EAAM,MACV,MAAAlK,EAEA,KAAA1G,EACA,MAAOgU,GACP,SAAWpD,IAAUD,EAAcC,GAAOlK,CAAK,EAC/C,cAAA6M,EACA,WAAY,IAAMC,KAAiB,aAAU5C,CAAK,CAAC,EACnD,WAAY0C,EACZ,QAASgB,GACT,MAAAzB,GACA,mBAAoB,OAClB,OAACqB,GAAA,CAAa,MAAAtD,EAAc,MAAAlK,EAAc,MAAAzG,EAAc,eAAA8T,EAAA,CAAgC,EAE1F,IAAK,MAAQ,gBACb,oBAAqB,IAbhBnD,EAAM,KAcb,EACF,EACCyD,OAAqB,OAACG,EAAA,EAAU,CAAC,KAAAxU,EAAY,WAAAyT,GAAwB,eAAAC,EAAA,CAAgC,GACxG,CAEJ,EAEae,EAAoB,CAAC,CAAE,SAAAC,CAAS,IAAmC,CAC9E,MAAMjV,KAAS,MAAW,CAAS,EACnC,SAAO,OAAC,OAAI,UAAWA,EAAO,QAAU,SAAAiV,CAAA,CAAS,CACnD,EAEO,SAAS5B,EAAoB,CAClC,QAAAC,EACA,SAAApR,CACF,EAGG,CACD,MAAMK,EAAQ+Q,EAAQ,eAAiB,GAEjC4B,EAAuBC,GAAyC,CACpE,MAAMC,EAAsB,SAASD,EAAM,OAAO,MAAO,EAAE,EAErDE,EAAgB,MAAMD,CAAmB,GAAKA,IAAwB,EAAI,OAAYA,EAExFC,IAAkB/B,EAAQ,eAC5BpR,EAAS,CACP,GAAGoR,EACH,cAAA+B,CACF,CAAC,CAEL,EAEA,SACE,OAACnP,GAAA,GACC,WAAY,GACZ,SAAO,KAAE,wDAAyD,iBAAiB,EACnF,WAAS,KACP,0DACA,iLACF,EAEA,mBAACoP,GAAA,GACC,KAAK,SACL,MAAO,GACP,YAAa7B,EAAwB,SAAS,EAC9C,WAAY,GACZ,OAAQyB,EACR,aAAc3S,CAAA,CAChB,EACF,CAEJ,CAEO,SAASgR,EAAkB,CAChC,QAAAD,EACA,SAAApR,CACF,EAGG,CACD,MAAMK,EAAQ+Q,EAAQ,aAAe,GAE/BiC,EAAqBJ,GAAyC,CAClE,MAAMK,EAAcL,EAAM,OAAO,MAC7BK,IAAgBjT,GAClBL,EAAS,CACP,GAAGoR,EACH,YAAAkC,CACF,CAAC,CAEL,EAEA,SACE,OAACtP,GAAA,GACC,SAAO,KAAE,8CAA+C,UAAU,EAClE,WAAY,GACZ,WACE,QAAC,KAAK,CAAC,QAAQ,gDAAgD,wGAC2B,OAAC,QAAK,cAAE,EAAO,0CAEzG,EAGF,mBAACoP,GAAA,GACC,KAAK,OACL,MAAO,GACP,YAAa5B,EACb,WAAY,GACZ,OAAQ6B,EACR,aAAchT,CAAA,CAChB,EACF,CAEJ,CAEA,MAAM,EAAa7B,IAA0B,CAC3C,WAAS,OAAI,CACX,MAAO,uBACP,aAAcA,EAAM,QAAQ,CAAC,EAC7B,OAAQ,aAAaA,EAAM,OAAO,OAAO,IAAI,GAC7C,aAAcA,EAAM,MAAM,OAAO,QAEjC,OAAQ,CACN,SAAU,SACZ,CACF,CAAC,EACD,aAAW,OAAI,CACb,QAAS,OACT,WAAY,SACZ,UAAW,CACT,QAAS,IACT,OAAQ,SACV,CACF,CAAC,CACH,GCxSO,MAAM+U,WAAkB,eAAqB,CAClD,YAAYhT,EAAc,CACxB,MAAMA,CAAK,EAGb,mBAAiB0O,GAAqB,CACpC,KAAM,CAAE,QAAArH,EAAS,gBAAA4L,CAAgB,EAAI,KAAK,MAC1CA,EAAgB5L,EAAQ,OAAQ6L,GAAMA,EAAE,QAAUxE,EAAM,KAAK,CAAC,CAChE,EAEA,uBAAoB,CAAC8B,EAA8BhM,IAAkB,CACnE,KAAM,CAAE,QAAA6C,EAAS,gBAAA4L,CAAgB,EAAI,KAAK,MAC1CA,EACE5L,EAAQ,IAAI,CAAC8L,EAAMC,IACbA,IAAc5O,EACT2O,EAEF,CACL,GAAGA,EACH,kBAAmB3C,CACrB,CACD,CACH,CACF,EAEA,0BAAuB,CAACK,EAA4BrM,IAAkB,CACpE,KAAM,CAAE,QAAA6C,EAAS,gBAAA4L,CAAgB,EAAI,KAAK,MAC1CA,EACE5L,EAAQ,IAAI,CAAC8L,EAAMC,IACbA,IAAc5O,EACT2O,EAEF,CACL,GAAGA,EACH,MAAO,CACL,GAAGA,EAAK,MACR,cAAetC,EAAQ,cACvB,WAAYA,EAAQ,YAAc,gBAAuBA,EAAQ,WAAW,EAAI,MAClF,CACF,CACD,CACH,CACF,EAEA,wBAAqB,CAACzB,EAAsC5K,IAAkB,CAC5E,KAAM,CAAE,QAAA6C,EAAS,gBAAA4L,CAAgB,EAAI,KAAK,MAEpCI,EAAiBhM,EAAQ,IAAI,CAAC8L,EAAMC,IAAc,CACtD,GAAIA,IAAc5O,EAChB,OAAO2O,EAGT,MAAMG,EAAmB,KAAK,sBAAsBH,CAAI,EAGxD,OAAI/D,EAAS,OAASkE,GAAkB,KAC/BC,GAAUJ,EAAM/D,CAAQ,EAE1BoE,GAASL,EAAM/D,CAAQ,CAChC,CAAC,EAED6D,EAAgBI,CAAc,CAChC,EAEA,mBAAgB,CAAC3E,EAAkBlK,IAAkB,CACnD,KAAM,CAAE,QAAA6C,EAAS,gBAAA4L,CAAgB,EAAI,KAAK,MAE1CA,EACE5L,EAAQ,IAAI,CAAC8L,EAAMC,IACbA,IAAc5O,EACT2O,EAGF,CACL,GAAGA,EACH,MAAOzE,EAAM,MACb,UAAWyE,EAAK,MAAM,WAAa,GACnC,MAAO,CACL,GAAGA,EAAK,MACR,GAAGzE,EACH,WAAYA,EAAM,UACpB,CACF,CACD,CACH,CACF,EAEA,eAAa+E,GAAuB,CAClC,KAAM,CAAE,QAAApM,EAAS,gBAAA4L,CAAgB,EAAI,KAAK,MAE1C,GAAI,CAACQ,GAAU,CAACA,EAAO,YACrB,OAGF,MAAMC,EAAaD,EAAO,OAAO,MAC3BE,EAAWF,EAAO,YAAY,MACpC,GAAIC,IAAeC,EACjB,OAGF,MAAMC,EAAS,MAAM,KAAKvM,CAAO,EAC3B,CAACwM,CAAO,EAAID,EAAO,OAAOF,EAAY,CAAC,EAC7CE,EAAO,OAAOD,EAAU,EAAGE,CAAO,EAClCZ,EAAgBW,CAAM,CACxB,EAEA,2BAAyBlF,MAChB,KAAiB,EAAE,oBAAoBA,EAAM,aAAa,CAxGnE,CA2GA,QAAS,CACP,KAAM,CAAE,QAAArH,EAAS,YAAAyM,EAAa,UAAAjP,CAAU,EAAI,KAAK,MAC3CkP,KAAmB,MAAwB,CAAC,GAAG1M,EAAS,GAAGyM,CAAW,EAAGjP,CAAS,EAExF,SACE,OAAC,MAAe,CAAC,UAAW,KAAK,UAC/B,mBAAC,MAAS,CAAC,YAAY,mBAAmB,UAAU,WACjD,SAACmP,MAEE,OAAC,OAAI,IAAKA,EAAS,SAAW,GAAGA,EAAS,eACxC,oBAACxT,EAAA,EAAK,CAAC,UAAU,SACd,UAAA6G,EAAQ,IAAI,CAACqH,EAAOlK,IAAU,CAC7B,MAAMyP,EAAc,KAAK,MAAM,YAAcvF,EAAM,MAC7C5Q,EAAkB,KAAK,MAAM,OAAO4Q,EAAM,KAAK,GAAK,CACxD,OAAQ,CAAC,EACT,MAAO,MAAa,UACtB,EACM9E,EAAa,KAAK,sBAAsB8E,CAAK,EACnD,IAAI3Q,EAOJ,OANID,GAAQmW,EACVlW,KAAQ,MAA0BD,CAAI,EAC7BA,IACTC,KAAQ,MAAqBD,CAAI,GAG9B8L,KAoBH,OAACsH,EAAA,CACC,MAAA1M,EAEA,WAAAoF,EACA,KAAA9L,EACA,MAAAC,EACA,MAAA2Q,EACA,cAAe,KAAK,cACpB,cAAe,KAAK,cACpB,QAAS,CAAC,GAAGrH,EAAS,GAAGyM,CAAW,EACpC,mBAAoB,KAAK,mBACzB,iBAAkB,KAAK,MAAM,iBAC7B,kBAAmB,KAAK,kBACxB,qBAAsB,KAAK,qBAC3B,WAAYC,EAAiBrF,EAAM,KAAK,GAAG,OAC3C,eAAgBqF,EAAiBrF,EAAM,KAAK,GAAG,KAC/C,aAAc,KAAK,MAAM,aACzB,UAAW,KAAK,MAAM,UACtB,eAAgB,KAAK,MAAM,gBAhBtBA,EAAM,KAiBb,KArCE,OAACwF,GAAA,CAEC,MAAA1P,EACA,MAAOkK,EAAM,MACb,mBAAoB,IAAM,CACxB,MAAMyF,MAAoB,OAAiB,EAAE,oBAAoB,IAAI,EACjEA,IACF,KAAK,mBAAmBA,GAAmB3P,CAAK,CAEpD,EACA,cAAe,IAAM,CACnB,KAAK,cAAckK,CAAK,CAC1B,GAXK,GAAGA,EAAM,KAAK,IAAIlK,CAAK,EAY9B,CA0BN,CAAC,EACAwP,EAAS,aACZ,EACF,CAEJ,CACF,EACF,CAEJ,CACF,CAEA,SAAST,GAAUJ,EAAkB/D,EAAsE,CACzG,MAAO,CACL,GAAG+D,EACH,MAAO,CACL,MAAG,QAAKA,EAAK,MAAO,YAAY,EAChC,cAAY,OAAiB/D,CAAQ,CACvC,EACA,cAAeA,EAAS,GAC1B,CACF,CAEA,SAASoE,GAASL,EAAkB/D,EAAsE,CAExG,MAAMgF,KADe,KAAkBjB,CAAI,EACV,MAAQ,OAAwBA,CAAI,EAE/DkB,EAA2C,CAC/C,MAAOlB,EAAK,MACZ,kBAAmBA,EAAK,kBACxB,UAAW,GACX,cAAe/D,EAAS,IACxB,MAAO,CACL,MAAO+D,EAAK,MACZ,KAAM,GACN,cAAY,OAAiB/D,CAAQ,CACvC,CACF,EAEA,OAAIgF,GAAa,IAAC,KAAkBjB,CAAI,IACrCkB,EAAwC,MAAM,QAAUD,GAGpDC,CACT,CASA,MAAMH,GAAqB,CAAC,CAAE,MAAA1P,EAAO,mBAAA8P,EAAoB,cAAAjD,EAAe,MAAAkD,CAAM,IAA+B,CAC3G,MAAMC,EAAQD,EAAM,MAEd,CAACE,EAAaC,CAAc,KAAI,YAAkB,EAAK,EAEvDC,EAAgB,IAAM,CAC1BD,EAAgBE,GAAS,CAACA,CAAI,CAChC,EAEMC,EAAyB,IAAM,CACnCP,EAAmB,CACrB,EAEA,SACE,OAAC/B,EAAiB,CAChB,oBAACuC,GAAA,EAAiB,CAAC,MAAON,EAAO,UAAS,GAAC,MAAAhQ,EAAc,GAAIgQ,EAAO,OAAM,GAAC,YAAa,GACtF,qBAACO,GAAA,EAAI,CACH,oBAACA,GAAA,EAAK,QAAL,CACC,mBAAC,KAAK,CAAC,QAAQ,iEAAiE,4CAEhF,EACF,KACA,OAACA,GAAA,EAAK,YAAL,CACC,mBAAC,KAAK,CAAC,QAAQ,iDAAiD,6GAEhE,EACF,KACA,OAACA,GAAA,EAAK,OAAL,CACC,mBAAC/G,GAAA,EAAI,CAAC,KAAK,iBAAkB,GAC/B,KACA,QAAC+G,GAAA,EAAK,QAAL,CACC,oBAACvP,EAAA,GAAM,CAAc,QAAQ,YAAY,QAASqP,EAChD,mBAAC,KAAK,CAAC,QAAQ,kDAAkD,6BAAiB,GADxE,QAEZ,KACA,OAACrP,EAAA,GAAM,CAAc,QAAQ,cAAc,QAAS6L,EAClD,mBAAC,KAAK,CAAC,QAAQ,6CAA6C,wBAAY,GAD9D,QAEZ,GACF,KACA,OAAC0D,GAAA,EAAK,iBAAL,CACC,mBAACvP,EAAA,IAEC,QAASmP,EACT,KAAMF,EAAc,WAAa,aACjC,KAAK,OACL,KAAK,KAEL,mBAAC,KAAK,CAAC,QAAQ,6CAA6C,wBAAY,GANpE,SAON,EACF,GACF,EACCA,MACC,OAAC,OACC,mBAAC,OACC,mBAAC,QAAM,cAAK,UAAUF,EAAO,KAAM,CAAC,EAAE,EACxC,EACF,GAEJ,EACF,CAEJ,ECtTaxF,GAAc,CAAC,CAC1B,QAAA1H,EACA,YAAAyM,EACA,UAAAvE,EACA,aAAA6B,EACA,gBAAA4D,EACA,iBAAA1D,EACA,UAAAzM,EACA,eAAAyK,CACF,IAAa,CACX,MAAM/R,KAAS,MAAW,EAAS,EAEnC,SACE,OAAC,OAAI,UAAWA,EAAO,UACrB,mBAACyV,GAAA,CACC,KAAMzD,EACN,QAAAlI,EACA,YAAAyM,EACA,aAAA1C,EACA,gBAAiB4D,EACjB,iBAAA1D,EACA,UAAAzM,EACA,eAAAyK,CAAA,CACF,EACF,CAEJ,EAEM,GAAarR,IAA0B,CAC3C,aAAW,OAAI,CACb,gBAAiBA,EAAM,OAAO,WAAW,QACzC,OAAQ,MACV,CAAC,CACH,G,qCCzBO,MAAMgX,EAAoD,CAAC,CAChE,QAAA5N,EACA,cAAAoH,EACA,WAAAyG,EACA,UAAA3F,EACA,eAAArJ,CACF,IAAM,CACJ,KAAM,CAACpI,EAAMqX,CAAO,KAAI,YAAoB,CAC1C,OAAQ,CAAC,EACT,MAAO,MAAa,WACpB,aAAW,OAAW,EAAE,UAAU,CACpC,CAAC,EAEK5X,KAAS,MAAW,CAAS,KAEnC,aAAU,IAAM,CACd4X,EAAQ5F,IAAYlI,EAAQ,CAAC,GAAG,KAAK,CAAC,CACxC,EAAG,CAACkI,EAAWlI,CAAO,CAAC,EAEvB,KAAM,CACJ,MAAAtJ,EACA,QAAAQ,EACA,MAAOgQ,CACT,KAAIC,GAAA,GAAS,OACJ,KAAiB,EAAE,IAAItI,CAAc,EAC3C,CAACA,CAAc,CAAC,EAEbkP,KAAqB,eACxBC,IAA4B,CAC3B,GAAI,IAAC,OAAkBA,EAAY,GAAK,CAAC9G,EACvC,OAGF,KAAM,CAACG,CAAK,EAAIrH,EACV,CAAE,IAAKiO,EAAc,KAAA3W,EAAK,EAAI4P,EAC9BgH,GAAS5W,KAAS,MAAe,KACjC6W,GAAOH,GAAa,KAEpBI,GAAS,CACb,GAAG/G,EACH,GAAG2G,GACH,cAAeC,EACf,KAAAE,GACA,MAAO,CACL,KAAAA,GACA,WAAYH,GAAa,WACzB,MAAOA,GAAa,MACpB,WAAYA,GAAa,WAEzB,QAASA,GAAa,QACtB,MAAOA,GAAa,MAKpB,UAAWE,GAASF,GAAa,WAAa,KAAc,QAAUA,GAAa,UACnF,aAAcA,GAAa,YAC7B,CACF,EACA5G,EAAc,CAACgH,EAAM,CAAC,CACxB,EACA,CAAClH,EAAYlH,EAASoH,CAAa,CACrC,EAEA,GAAIlQ,GAAWgQ,GAAY,OAASrI,EAClC,OAAO,KAGT,MAAM0I,MAAM,KAAiB,EAAE,oBAAoB1I,CAAc,EAEjE,GAAInI,GAAS,CAACwQ,GAAc,CAACA,GAAY,YAAY,aAAe,CAACK,GAAK,CACxE,MAAMC,GAAe9Q,GAAO,SAAW,gEACvC,SACE,OAAC,OACC,oBAAC,KAAK,CAAC,QAAQ,uDAAuD,iDAC/B,CAAE,aAAA8Q,EAAa,GACtD,EACF,CAEJ,CAEA,MAAME,GAAcR,EAAW,WAAW,YAE1C,SACE,oBACG,UAAAlH,EAAQ,WACP,oBACE,oBAAC0H,GAAA,CACC,MAAO1H,EAAQ,CAAC,EAChB,QAAAA,EACA,IAAK,MAAQ,gBACb,SAAU+N,EACV,WAAYF,EACZ,WAAY3G,CAAA,CACd,GACEzQ,GAAM,QAAU,CAAC,GAAG,IAAK4X,OAClB,OAACC,EAAA,EAAe,CAAmB,MAAOD,EAAA,EAApBA,GAAI,OAAqB,CACvD,GACH,EAGD5X,MACC,OAAC,OAAI,UAAWP,EAAO,WACrB,mBAAC+U,EAAA,EAAU,CAAC,KAAAxU,CAAA,CAAY,EAC1B,GAEJ,CAEJ,EAEM,EAAaG,IAA0B,CAC3C,cAAY,OAAI,CACd,OAAQA,EAAM,QAAQ,EAAG,CAAC,CAC5B,CAAC,CACH,G,2BC/HO,MAAM2X,EAA0B,CAAC,CAAE,SAAA7V,EAAU,wBAAA8V,CAAwB,IAAoC,CAC9G,KAAM,CACJ,QAAAhX,EACA,UAAW,CAAE,OAAAG,CAAO,EACpB,SAAAC,EACA,MAAAF,CACF,KAAI,MAA+B,EAE7BxB,KAAS,MAAW,EAAS,EAE7B2B,EAAeH,EAAM,MAAM,EAEjC,SACE,OAAC,OAAI,UAAWxB,EAAO,QACnB,UAAA2B,IAAiB,IAAa,eAAiBA,IAAiB,IAAa,oBAC7E,OAACuB,GAAA,GACC,UAAWlD,EAAO,UAClB,MACEwC,KACI,KAAE,qDAAsD,aAAa,KACrE,KAAE,4CAA6C,oBAAoB,EAEzE,MAAOf,EAAO,gBAAgB,QAC9B,QAAS,CAAC,CAACA,EAAO,gBAAgB,QAElC,mBAAC,MACC,OAAQ,CAAC,CAAE,MAAO,CAAE,SAAAS,EAAU,IAAAC,EAAK,GAAGC,CAAM,CAAE,OAC5C,OAACE,EAAA,GACE,GAAGF,EACJ,SAAAI,EACA,SAAWH,GAAmC,CAE5CX,EAAS,aAAc,EAAE,EACzBQ,EAASG,GAAI,MAAQ,IAAI,EACzBiW,EAAwBjW,GAAI,KAAO,IAAI,CACzC,EACF,EAEF,KAAK,iBACL,QAAAf,EACA,MAAO,CACL,SAAU,CACR,MAAO,GACP,WAAS,KACP,0EACA,6BACF,CACF,CACF,EACF,EACF,EAEJ,CAEJ,EAEM,GAAaZ,IAA0B,CAC3C,aAAW,OAAI,CACb,MAAO,QACP,QAAS,CACP,WAAYA,EAAM,QAAQ,CAAC,CAC7B,CACF,CAAC,EACD,WAAS,OAAI,CACX,QAAS,OACT,cAAe,MACf,eAAgB,aAChB,WAAY,UACd,CAAC,CACH,G,kJCvDO,MAAM6X,GAAkB,UAMzBC,GAA+B,CAAC1O,EAAuBmN,IAA0C,CACrG,MAAMwB,KAAM,OAAqB3O,CAAO,EAClCkH,KAAa,OAAiBiG,EAAOwB,CAAG,EAAE,CAAC,EACjD,GAAI,CAACzH,EACH,OAGF,MAAM0H,EAAc5O,EAAQ,KAAMqH,GAAUA,EAAM,QAAUH,CAAU,EACtE,GAAI0H,GAAe,sBAAuBA,EACxC,OAAOA,CAIX,EAEMC,GAA2C,CAC/C,QAAS,CAAC,CACZ,EAEaC,MAAiB,OAAyB,gBAAgB,EAC1DC,MAAkB,OAAa,iBAAiB,EAChDC,MAAiB,OAA2B,gBAAgB,EAE5DC,MAAmB,OAAkC,kBAAkB,EACvEC,MAAmB,OAAqB,kBAAkB,EAC1DC,MAAoB,OAAa,mBAAmB,EACpDC,MAAiB,OAA2B,gBAAgB,EAC5DC,MAAmB,OAA8B,kBAAkB,EACnEC,MAAwB,OAAqD,uBAAuB,EACpGC,MAAoB,OAAqD,mBAAmB,EAC5FC,MAAuB,OAA2D,sBAAsB,EACxGC,MAA4B,OAAa,2BAA2B,EACpEC,MAAsB,OAAuD,qBAAqB,EAClGC,MAAoB,OAAqD,mBAAmB,EAE5FC,MAAyB,OAAa,wBAAwB,EAC9DC,MAA2B,OAGrC,0BAA0B,EAChBC,MAA2B,OACtC,0BACF,EAEaC,MAA+B,OAAclB,GAAemB,GAAY,CAEnFA,EAEG,QAAQJ,GAAyBzJ,GAAU,CAC1CA,EAAM,WAAU,OAAkB,CACpC,CAAC,EACA,QAAQ2I,GAAgB,CAAC3I,EAAO,CAAE,QAAAtB,CAAQ,IAAM,CAC/CsB,EAAM,QAAU8J,GAAS9J,EAAM,QAAStB,CAAO,CACjD,CAAC,EACA,QAAQkK,GAAkB5I,GAAU,CACnC,MAAM+J,KAAa,OAAsC,EACpDA,IAIL/J,EAAM,QAAU8J,GAAS9J,EAAM,QAAS,CACtC,cAAe+J,EAAW,IAC1B,MAAO,CACL,MAAO,GACP,cAAY,OAAiBA,CAAU,CACzC,CACF,CAAC,EACH,CAAC,EACA,QAAQlB,GAAgB,CAAC7I,EAAO,CAAE,QAAAtB,CAAQ,IAAM,CAC/C,MAAM0D,EAAoBpC,EAAM,QAAQ,OAAQkB,MAAU,KAAkBA,EAAM,KAAK,CAAC,EACxFlB,EAAM,QAAU,CAAC,GAAGtB,EAAS,GAAG0D,CAAiB,CACnD,CAAC,EACA,QAAQuH,GAA0B,CAAC3J,EAAO,CAAE,QAAAtB,CAAQ,IAAM,CACzD,MAAMwC,EAAQxC,EAAQ,qBAAqB,CAAC,EACtCsL,EAAqB,CACzB,GAAG9I,EACE,KAAMxC,EAAQ,WAAY,MAAOwC,GAAO,KAC/C,EAEAlB,EAAM,QAAU,CAACgK,CAAkB,CACrC,CAAC,EACA,QAAQT,GAAqB,CAACvJ,EAAOiK,IAAW,CAC/CjK,EAAM,QAAUA,EAAM,QAAQ,IAAKkB,GAC1BA,EAAM,QAAU+I,EAAO,QAAQ,MAClC,CACE,GAAG/I,EACH,MAAO,CACL,GAAGA,EAAM,MACT,cAAe+I,EAAO,QAAQ,aAChC,CACF,EACA/I,CACL,CACH,CAAC,EACA,QAAQsI,GAAmB,CAACxJ,EAAOiK,IAAW,CAC7CjK,EAAM,QAAUA,EAAM,QAAQ,IAAKkB,GAC1BA,EAAM,QAAU+I,EAAO,QAAQ,MAClC,CACE,GAAG/I,EACH,MAAO,CACL,GAAGA,EAAM,MACT,WAAY+I,EAAO,QAAQ,YAAc,gBAAuBA,EAAO,QAAQ,WAAW,EAAI,MAChG,CACF,EACA/I,CACL,CACH,CAAC,EAGH2I,EACG,QAAQf,GAAkB,CAAC9I,EAAO,CAAE,QAAAtB,CAAQ,IAAM,CACjDsB,EAAM,QAAU8J,GAAS9J,EAAM,QAAS,CACtC,cAAe,KACf,MAAO,MAAqB,SAAS,CACnC,KAAMtB,EACN,WAAY,CAAC,CAAE,GAAG,MAAkB,MAAO,CAAE,OAAQ,CAAC,CAAE,CAAE,CAAC,EAC3D,WAAY,EACd,CAAC,CACH,CAAC,CACH,CAAC,EACA,QAAQqK,GAAkB,CAAC/I,EAAO,CAAE,QAAAtB,CAAQ,IAAM,CACjDsB,EAAM,QAAUA,EAAM,QAAQ,OAAQkB,GAAUA,EAAM,QAAUxC,CAAO,CACzE,CAAC,EACA,QAAQsK,GAAoBhJ,GAAU,CACrCA,EAAM,QAAUA,EAAM,QAAQ,OAAQkB,GAAU,IAAC,KAAkBA,EAAM,KAAK,CAAC,CACjF,CAAC,EACA,QAAQ+H,GAAgB,CAACjJ,EAAO,CAAE,QAAAtB,CAAQ,IAAM,CAC/CsB,EAAM,QAAU,CAAC,GAAGA,EAAM,QAAS,GAAGtB,CAAO,CAC/C,CAAC,EACA,QAAQwK,GAAkB,CAAClJ,EAAO,CAAE,QAAAtB,CAAQ,IAAM,CACjD,MAAMwL,EAAgBlK,EAAM,QAAQ,KAAMkB,GAAUA,EAAM,QAAUxC,EAAQ,KAAK,EACjF,GAAKwL,IAILA,EAAc,MAAQxL,EAGlBA,EAAQ,OAAS,KAAoB,UAAYA,EAAQ,YAAY,CAEvE,MAAMyL,KAAkB,OAASnK,CAAK,GAAG,SAAW,CAAC,EAErD,IAAIoK,KAAoB,MAA4B,EACpD,GAAI,CACF,MAAMC,EAAuB9B,GAA6B4B,EAAiBzL,EAAQ,UAAU,EACzF2L,GAAsB,oBACxBD,EAAoBC,EAAqB,kBAE7C,OAAS9Z,EAAO,CACVA,aAAiB,SACnB,OAASA,CAAK,KAEd,OAAS,IAAI,MAAM,wDAAwD,CAAC,CAEhF,CAEA2Z,EAAc,kBAAoBE,CACpC,CACF,CAAC,EACA,QAAQd,GAA4BtJ,GAAU,CAC7CA,EAAM,QAAQ,QAASkB,GAAU,CAE/B,MACE,KAAkBA,EAAM,KAAK,GAC7BA,EAAM,MAAM,OAAS,KAAoB,UACzCA,EAAM,MAAM,WACZ,CAEA,MAAMiJ,KAAkB,OAASnK,CAAK,GAAG,SAAW,CAAC,EAE/Ce,EAAawH,GAA6B4B,EAAiBjJ,EAAM,MAAM,UAAU,EACjFkJ,EAAoBrJ,EAAaA,EAAW,qBAAoB,MAA4B,EAClGG,EAAM,kBAAoBkJ,CAC5B,CACF,CAAC,CACH,CAAC,EACA,QAAQjB,GAAuB,CAACnJ,EAAO,CAAE,QAAAtB,CAAQ,IAAM,CACtD,KAAM,CAAE,SAAA4L,EAAU,SAAAC,CAAS,EAAI7L,EAI/B,MADuB,MAAYsB,EAAM,QAASsK,CAAQ,EAExD,OAGF,MAAMzE,KAAiB,MAA6B7F,EAAM,QAASuK,EAAUD,CAAQ,EACrFtK,EAAM,QAAU6F,EAAe,IAAK3E,GAC9BA,EAAM,QAAUqJ,EACX,CACL,GAAGrJ,EACH,MAAOoJ,EACP,MAAO,CACL,GAAGpJ,EAAM,MACT,MAAOoJ,CACT,CACF,EAGKpJ,CACR,CACH,CAAC,EACA,QAAQkI,GAAmB,CAACpJ,EAAO,CAAE,QAAAtB,CAAQ,IAAM,CAClDsB,EAAM,WAAU,MAA6BA,EAAM,QAAStB,EAAQ,SAAUA,EAAQ,QAAQ,CAChG,CAAC,EAEA,QAAQgL,GAA0B,CAAC1J,EAAO,CAAE,QAAAtB,CAAQ,IAAM,CACzD,KAAM,CAAE,eAAAmH,EAAgB,kBAAAzD,CAAkB,EAAI1D,EAE9C,GAAImH,EAAe,SAAW,EAE5B,OAGF,MAAM/E,EAAY+E,EAAe,GAAG,CAAC,EAC/B2E,EAAqB1J,KAAY,OAAwBA,CAAS,EAAI,GAG5E,GAD4B0J,GAAsBpI,EAAkB,SAAW,EACtD,CACvB,MAAMqI,EAAwBzK,EAAM,QAAQ,UACzCkB,MACC,KAAkBA,EAAM,KAAK,MAC7B,OAAoBA,EAAM,KAAK,GAC/BA,EAAM,MAAM,aAAeJ,GAAW,KAC1C,EAEAd,EAAM,QAAQ,OAAOyK,EAAuB,CAAC,EAC7CzK,EAAM,QAAQ,CAAC,EAAE,MAAM,WAAac,GAAW,KACjD,CAGE,CAAC0J,GAAsBpI,EAAkB,SAAW,MAAK,OAAsBA,EAAkB,CAAC,EAAE,KAAK,IAIzGpC,EAAM,QAAQ,CAAC,EAAE,MAAM,WAAasI,GAGpCtI,EAAM,QAAQ,OAAO,EAAG,EAAG,CACzB,cAAe,KACf,MAAO,MAAqB,SAAS,CACnC,KAAM,KAAoB,OAC1B,QAAS,MAAU,KACnB,WAAY,CAAC,CAAE,GAAG,MAAkB,MAAO,CAAE,OAAQ,CAAC,CAAE,CAAE,CAAC,EAC3D,WAAYc,GAAW,MACvB,MAAOwH,EACT,CAAC,EACD,MAAOA,GACP,UAAW,YACb,CAAC,EAEL,CAAC,EACA,QAAQe,GAAsB,CAACrJ,EAAOiK,IAAW,CAChDjK,EAAM,QAAUA,EAAM,QAAQ,IAAKkB,GAC1BA,EAAM,QAAU+I,EAAO,QAAQ,MAClC,CACE,GAAG/I,EACH,MAAO,CACL,GAAG,MAAqB,SAAS,CAC/B,KAAM+I,EAAO,QAAQ,KACrB,WAAY,CAAC,CAAE,GAAG,MAAkB,MAAO,CAAE,OAAQ,CAAC,CAAE,CAAE,CAAC,EAC3D,WAAY,EACd,CAAC,EACD,MAAOA,EAAO,QAAQ,KACxB,CACF,EACA/I,CACL,CACH,CAAC,CACL,CAAC,EAEK4I,GAAW,CACfjQ,EACA6Q,IACiB,CACjB,MAAM1D,KAAQ,MAAanN,CAAO,EAC5BqH,EAAoB,CACxB,GAAGwJ,EACH,MAAA1D,EACA,UAAW,GACX,MAAO,CACL,GAAG0D,EAAW,MACd,KAAM,GACN,MAAA1D,CACF,EACA,kBAAmB0D,EAAW,mBAAqBC,GAAiBD,EAAW,KAAK,CACtF,EAEA,MAAO,CAAC,GAAG7Q,EAASqH,CAAK,CAC3B,EAEMyJ,GAAoB5D,GAAoD,CAC5E,GAAI,SAAkBA,CAAK,EAI3B,SAAO,MAA4B,CACrC,EC7Ra6D,GAAwB,CAAC,CACpC,gBAAAC,EACA,SAAA5Y,EACA,sBAAA6Y,EACA,SAAAC,EACA,YAAAC,CACF,IAAkC,CAChC,MAAMC,EAAuB3Y,GAAmC,CAC9DL,EAAS,CAAE,GAAG4Y,EAAiB,UAAWvY,EAAM,OAAS,MAAU,IAAK,CAAC,EACzE4Y,GAAuB5Y,EAAM,OAAS,MAAU,KAAMwY,EAAuBC,CAAQ,CACvF,EAEMI,KAAU,OAAiBN,EAAgB,UAAU,IAAI,EAEzDO,EAAoB,KAAmB,KAAMC,GAAOA,EAAG,QAAUR,EAAgB,WAAW,IAAI,EAEhGS,EAAwBhZ,GAAyC,CAErEL,EAAS,CACP,GAAG4Y,EACH,UAAW,CAAE,GAAGA,EAAgB,UAAW,KAAMvY,EAAM,OAAS,KAAa,OAAQ,CACvF,CAAC,EAEDiZ,GAAwBjZ,EAAM,OAAS,KAAa,QAASwY,EAAuBC,CAAQ,CAC9F,EAEMS,EAAwB,CAACtG,EAAoClO,GAAQ,IAAM,CAC/E,MAAM1E,GAAQ4S,EAAM,cAAc,MAC5BuG,GAAe,WAAWnZ,EAAK,GAAK,EAE1CL,KACE,OAAQ4Y,EAAkBa,GAAmB,CAC3CA,EAAe,UAAU,OAAO1U,EAAK,EAAIyU,EAC3C,CAAC,CACH,EAEAE,GAAqBF,GAAczU,GAAO8T,EAAuBC,CAAQ,CAC3E,EAEMhb,KAAS,MAAW,EAAS,EAEnC,SACE,OAAC,OAAI,UAAWA,EAAO,UAAU,QAC/B,oBAACiD,EAAA,EAAK,CAAC,UAAU,SAAS,IAAK,EAAG,MAAM,OACtC,oBAAC,UAAO,UAAWjD,EAAO,UAAU,OAClC,mBAAC4D,EAAA,EAAI,CAAC,QAAQ,OACZ,mBAAC,KAAK,CAAC,QAAQ,0CAA0C,2BAAe,EAC1E,EACF,KACA,QAACiY,GAAA,EAAc,CAAC,UAAW7b,EAAO,UAAU,UACzC,UAAA8a,EAAgB,cACf,OAAC5U,GAAA,EAAW,CAAC,SAAO,KAAE,8CAA+C,MAAM,EACzE,mBAAC4V,GAAA,IACC,QAAS,KACT,MAAO,KAAa,KAAMC,GAAMA,EAAE,QAAUjB,EAAgB,SAAS,EACrE,SAAUI,EACV,MAAO,GACT,EACF,KAEF,OAAChV,GAAA,GACC,MACE4U,EAAgB,aACZ,KAAE,kDAAmD,UAAU,KAC/D,KAAE,oDAAqD,YAAY,EAGzE,oBAAC7X,EAAA,EAAK,CAAC,UAAU,MAAM,IAAK,EAAG,WAAW,SACxC,oBAAC+Y,GAAA,EAAe,CAAC,SAAUT,EAAsB,MAAOF,CAAA,CAAmB,EAC1ED,KACC,oBACE,oBAAC9F,GAAA,GACC,KAAK,SACL,MAAO,GAKP,aAAcwF,EAAgB,UAAU,OAAO,CAAC,GAAK,GACrD,OAAS3F,GAAU,CACjBsG,EAAsBtG,EAAO,CAAC,CAChC,GAJK2F,EAAgB,UAAU,OAAO,CAAC,CAKzC,KACA,OAACmB,GAAA,EAAO,EAAC,KACT,OAAC3G,GAAA,GACC,KAAK,SACL,MAAO,GAEP,aAAcwF,EAAgB,UAAU,OAAO,CAAC,GAAK,GACrD,OAAS3F,GAAU,CACjBsG,EAAsBtG,EAAO,CAAC,CAChC,GAJK2F,EAAgB,UAAU,OAAO,CAAC,CAKzC,GACF,KAEA,OAACxF,GAAA,GACC,KAAK,SACL,MAAO,GAEP,aAAcwF,EAAgB,UAAU,OAAO,CAAC,GAAK,GACrD,OAAS3F,GAAU,CACjBsG,EAAsBtG,EAAO,CAAC,CAChC,GAJK2F,EAAgB,UAAU,OAAO,CAAC,CAKzC,GAEJ,EACF,GACF,EACCG,GAAa,WAAU,OAACvI,GAAA,GAAgB,CAAC,OAAQuI,GAAa,OAAQ,iBAAkB,GAAM,GACjG,EACF,CAEJ,EAEA,SAASE,GACPe,EACAnB,EACAC,EACA,CAEA,MAAMmB,EAAmBpB,EAAsB,KAAM5J,GAAUA,EAAM,MAAM,OAAS,KAAoB,MAAM,EAExGiL,EAAsBD,KACxB,OAAQA,GAAkB,MAAQE,GAAU,CACtCA,GAASA,EAAM,aACjBA,EAAM,QAAUH,EAChBG,EAAM,WAAW,CAAC,EAAE,QAAQ,QAAO,OAAeH,CAAO,GAAK,MAAU,KAE5E,CAAC,EACD,OACJE,GAAuBpB,EAAS7B,GAAiBiD,CAAmB,CAAC,CACvE,CAEA,SAASZ,GACPc,EACAvB,EACAC,EACA,CACA,MAAMuB,EAAsBxB,EAAsB,KAAM5J,GAAUA,EAAM,MAAM,OAAS,KAAoB,SAAS,EAE9GqL,KAAyB,OAAQD,EAAsBF,GAAU,CACjEA,GAASA,EAAM,MAAM,aACvBA,EAAM,MAAM,WAAW,CAAC,EAAE,UAAU,KAAOC,EAE/C,CAAC,EACDE,GAA0BxB,EAAS7B,GAAiBqD,EAAuB,KAAK,CAAC,CACnF,CAEA,SAASZ,GACPrZ,EACA0E,EACA8T,EACAC,EACA,CACA,MAAMuB,EAAsBxB,EAAsB,KAAM5J,GAAUA,EAAM,MAAM,OAAS,KAAoB,SAAS,EAE9GqL,KAAyB,OAAQD,EAAsBF,GAAU,CACjEA,GAASA,EAAM,MAAM,aACvBA,EAAM,MAAM,WAAW,CAAC,EAAE,UAAU,OAAOpV,CAAK,EAAI1E,EAExD,CAAC,EACDia,GAA0BxB,EAAS7B,GAAiBqD,EAAuB,KAAK,CAAC,CACnF,CAEO,SAASC,GAAkClG,EAAkE,CAClH,MAAM4F,EAAmB5F,EAAY,KAAMpF,GAAUA,EAAM,MAAM,OAAS,KAAoB,MAAM,EAE9FuL,EADsBnG,EAAY,KAAMpF,GAAUA,EAAM,MAAM,OAAS,KAAoB,SAAS,GACrD,MAAM,YAAc,CAAC,EACpEwL,EAAYR,GAAkB,MAAM,QACpCS,EAASF,EAAwB,CAAC,GAAG,WAAW,OAClD,CAAC,GAAGA,EAAwB,CAAC,GAAG,WAAW,MAAM,EACjD,CAAC,CAAC,EACAtb,EAAOsb,EAAwB,CAAC,GAAG,WAAW,MAAQ,KAAa,QAEzE,MAAO,CACL,UAAAC,EACA,UAAW,CACT,OAAAC,EACA,KAAAxb,CACF,CACF,CACF,CAEA,MAAM,GAAaV,IAA0B,CAC3C,oBAAkB,OAAI,CACpB,MAAOA,EAAM,OAAO,QAAQ,KAC5B,SAAUA,EAAM,WAAW,UAAU,SACrC,cAAe,YACf,QAAS,KAAKA,EAAM,QAAQ,CAAC,CAAC,EAChC,CAAC,EACD,UAAW,CACT,WAAS,OAAI,CACX,QAAS,OACT,OAAQ,aAAaA,EAAM,OAAO,OAAO,MAAM,GAC/C,KAAM,EACN,OAAQ,cACR,aAAcA,EAAM,MAAM,OAAO,OACnC,CAAC,EACD,aAAW,OAAI,CACb,QAAS,OACT,cAAe,MACf,QAASA,EAAM,QAAQ,CAAC,EACxB,KAAM,EACN,MAAO,MACT,CAAC,EACD,UAAQ,OAAI,CACV,WAAYA,EAAM,OAAO,WAAW,UACpC,QAAS,GAAGA,EAAM,QAAQ,EAAG,CAAC,IAAIA,EAAM,QAAQ,CAAC,CAAC,GAClD,aAAc,aAAaA,EAAM,OAAO,OAAO,IAAI,GACnD,KAAM,CACR,CAAC,CACH,CACF,G,wCCxPO,MAAMmc,GAAsB/S,GAC1BA,EAAQ,OAAQ6L,GAAMA,EAAE,gBAAkB,IAAuB,EAAE,SAAW,EAGvF,SAASmH,IAAwB,CAC/B,MAAMC,EAAwB,MAAW,cAAc,KAAoB,kBAAkB,EACvFC,EAAsB,MAAW,cAAc,KAAoB,yBAAyB,EAC5FvQ,EAAkBsQ,EAAwB,IAAa,QAAU,IAAa,cAE9EE,EAAmC,CAAC,EAC1C,OAAIF,GACFE,EAAiB,KAAK,IAAa,OAAO,EAExCD,GACFC,EAAiB,KAAK,IAAa,cAAe,IAAa,cAAc,EAGxE,CAAE,iBAAAA,EAAkB,gBAAAxQ,CAAgB,CAC7C,CAEO,MAAMyQ,GAAe,CAAC,CAC3B,QAAApT,EACA,aAAAnI,EACA,sBAAAwb,CACF,IAIM,CAEJ,MAAMC,EAAqBN,GAAsB,EAG3CO,EAAYR,GAAmB/S,CAAO,EACtCwT,EAA0BxT,EAAQ,CAAC,GAAG,eAAiB,GACvDyT,EAAsB5b,IAAiB,IAAa,eAGpD6b,EACJ,CAACD,GACDF,GACAF,EAAsB,KAAMM,IAAeA,GAAW,MAAQH,CAAuB,EAEjFI,EAAyB,CAACH,EAE1BI,EAAqBP,EAAmB,iBAAiB,SAAS,IAAa,OAAO,EACtFQ,EAAmBR,EAAmB,iBAAiB,SAAS,IAAa,aAAa,EAG1FS,EACJlc,IAAiB,IAAa,eAAiBgc,GAAsBD,EACjEI,GACJnc,IAAiB,IAAa,SAAW6b,GAAwBI,GAAoBJ,EAEvF,OAAOK,GAA+BC,EACxC,EC5CO,SAASC,GAAuB,CACrC,oBAAAC,EACA,sBAAAb,EACA,QAAArT,EACA,cAAAmU,CACF,EAAgC,CAC9B,KAAM,CAAE,UAAA3a,CAAU,KAAI,MAA+B,EAE/C,CAAC3B,CAAY,EAAI2B,EAAU,CAAC,MAAM,CAAC,EACnC4a,EAAYhB,GAAa,CAAE,QAAApT,EAAS,aAAAnI,EAAc,sBAAAwb,CAAsB,CAAC,EAEzE7J,EAAU,CACd,CAAE,SAAO,KAAE,qDAAsD,iBAAiB,EAAG,MAAO,IAAa,OAAQ,EACjH,CACE,SAAO,KAAE,yDAA0D,qBAAqB,EACxF,MAAO,IAAa,aACtB,CACF,EAIM6K,EAAkBD,EAAY,CAAC,EAAI,CAAC,IAAa,aAAa,EAEpE,SACE,QAACjb,EAAA,EAAK,CAAC,UAAU,SAAS,IAAK,EAAG,WAAW,aAC3C,qBAACA,EAAA,EAAK,CAAC,UAAU,SAAS,IAAK,EAC7B,oBAACW,EAAA,EAAI,CAAC,QAAQ,KACZ,mBAAC,KAAK,CAAC,QAAQ,+CAA+C,qBAAS,EACzE,KACA,QAACX,EAAA,EAAK,CAAC,UAAU,MAAM,IAAK,GAAK,WAAW,SAC1C,oBAACW,EAAA,EAAI,CAAC,QAAQ,YAAY,MAAM,YAC9B,mBAAC,KAAK,CAAC,QAAQ,gEAAgE,wDAE/E,EACF,KACA,OAACC,GAAA,GACC,eACE,oBACE,oBAACD,EAAA,EAAI,CAAC,MAAM,UAAU,QAAQ,KAC5B,mBAAC,KAAK,CAAC,QAAQ,gEAAgE,uCAE/E,EACF,KACA,OAAC,KACC,mBAAC,KAAK,CAAC,QAAQ,4EAA4E,6TAK3F,EACF,KACA,OAACA,EAAA,EAAI,CAAC,MAAM,UAAU,QAAQ,KAC5B,mBAAC,KAAK,CAAC,QAAQ,oEAAoE,2CAEnF,EACF,KACA,OAAC,KACC,mBAAC,KAAK,CAAC,QAAQ,gFAAgF,wNAI/F,EACF,GACF,EAEF,aAAa,8FACb,SAAS,8BACT,SAAO,KAAE,4DAA6D,kBAAkB,EAC1F,GACF,GACF,KACA,OAAC+F,GAAA,GACC,QAAA2J,EACA,SAAU0K,EACV,gBAAAG,EACA,MAAOxc,EACP,SAAUsc,EACV,cAAY,wBACd,EAECD,MACC,OAACpa,EAAA,EAAI,CAAC,MAAM,YACV,mBAAC,KAAK,CAAC,QAAQ,iEAAiE,uEAEhF,EACF,EAGD,CAACoa,MACA,mBACG,SAAAE,KACC,OAACta,EAAA,EAAI,CAAC,MAAM,YACT,SAAAjC,IAAiB,IAAa,WAC3B,KACE,mEACA,sLACF,KACA,KACE,+DACA,qHACF,EACN,KAEA,OAACiC,EAAA,EAAI,CAAC,MAAM,YACV,mBAAC,KAAK,CAAC,QAAQ,+DAA+D,uFAE9E,EACF,EAEJ,GAEJ,CAEJ,CC5HO,MAAMwa,GAAuD,CAClE,CAAC,IAAa,cAAc,EAAG,CAC7B,aAAc,wBACd,UAAW,6BACX,YACE,4HACF,SAAU,yFACZ,EACA,CAAC,IAAa,gBAAgB,EAAG,CAC/B,aAAc,wBACd,UAAW,6BACX,YACE,4HACF,SAAU,yFACZ,EACA,CAAC,IAAa,OAAO,EAAG,CACtB,aAAc,mCACd,UAAW,mCACX,YACE,mWACF,SAAU,qFACZ,EACA,CAAC,IAAa,aAAa,EAAG,CAC5B,aAAc,mCACd,UAAW,mCACX,YACE,mWACF,SAAU,qFACZ,CACF,EC3BA,SAASC,GACPC,EACAC,EACAlM,EACA,CACA,OAAIiM,MAAyB,OAAyCC,EAAalM,CAAiB,EAC3FoK,GAAkCpK,CAAiB,EAEnD,CACL,UAAW,MAAU,KACrB,UAAW,CACT,OAAQ,CAAC,CAAC,EACV,KAAM,KAAa,OACrB,CACF,CAEJ,CACO,SAASmM,GAAsBC,EAA4CH,EAAgC,CAChH,OAAOG,IAA0B,IAAS,CAACH,CAC7C,CAMO,MAAMI,GAAkB,CAC7BD,EACAH,EACAC,EACAlM,IACG,CACH,MAAMiC,EAAiBkK,GAAsBC,EAAuBH,CAAqB,EAEnF,CAACxD,EAAiB6D,CAAkB,KAAI,YAC5CN,GAA0BC,EAAuBC,EAAalM,CAAiB,CACjF,EAEA,sBAAU,IAAM,CACViM,GAAyB,CAAChK,GAC5BqK,EAAmBlC,GAAkCpK,CAAiB,CAAC,CAE3E,EAAG,CAACiC,EAAgBjC,EAAmBiM,CAAqB,CAAC,EAEtD,CAAE,gBAAAxD,EAAiB,mBAAA6D,CAAmB,CAC/C,E,gBCsCO,MAAMC,GAA0B,CAAC,CAAE,oBAAAZ,EAAqB,aAAAa,EAAc,KAAAC,CAAK,IAAa,CAC7F,KAAM,CACJ,SAAApd,EACA,UAAA4B,EACA,MAAA9B,EACA,UAAW,CAAE,OAAAC,CAAO,EACpB,QAAAH,CACF,KAAI,MAA+B,EAE7B,CAAE,iBAAAyd,EAAkB,WAAApH,EAAY,cAAAqH,EAAe,iBAAAC,EAAkB,iBAAAC,EAAiB,KAAIC,GAAA,GAAoB,EAC1GC,GAAsBtW,EAAA,EAAO,eAAe,qCAAuC,GAEnF6P,GAAe,CACnB,QAASrV,EAAU,SAAS,CAC9B,EAEM,CAAC,CAAE,QAAAwG,CAAQ,EAAGkR,CAAQ,KAAI,cAAWnB,GAA8BlB,EAAY,EAC/E0G,GAA2BvW,EAAA,EAAO,eAAe,2BAA6B,GAG9EyV,MAAc,WAAQ,IACnBzU,EAAQ,OAAQqH,GAAU,IAAC,KAAkBA,EAAM,KAAK,CAAC,EAC/D,CAACrH,CAAO,CAAC,EAGNuI,MAAoB,WAAQ,IACzBvI,EAAQ,OAAQqH,MAAU,OAAyBA,CAAK,CAAC,EAC/D,CAACrH,CAAO,CAAC,KAEZwV,EAAA,GAAc,IAAM,CAId,CAACtB,GAAuBqB,IAC1BrE,EAASrB,GAAyB,CAAE,eAAgB4E,GAAa,kBAAAlM,EAAkB,CAAC,CAAC,CAEzF,CAAC,EAED,KAAM,CAACjR,GAAMkG,GAAWqB,GAAgB4W,EAAc,EAAI/d,EAAM,CAC9D,OACA,YACA,iBACA,gBACF,CAAC,EAGK8c,MAAwB,OAA4Bld,EAAI,EACxDmc,MAAsB,OAA2Bnc,EAAI,EACrDoe,MAAuB,OAA0Bpe,EAAI,EACrD,CAACqe,GAAoBC,EAAiB,KAAI,YAAS,EAAK,EAExDC,GAAwBJ,IAAgB,sBAExC,CAAE,gBAAAzE,GAAiB,mBAAA6D,EAAmB,EAAID,GAC9CiB,GACArB,GACAC,GACAlM,EACF,EAEMuN,GACJR,IAAuBd,GAAwBiB,IAAgB,sBAAwB,MAGzF,aAAU,IAAM,CACVK,IAAuBtB,IACzBK,GAAmBlC,GAAkCpK,EAAiB,CAAC,CAE3E,EAAG,CAACuN,GAAqBvN,GAAmBiM,GAAuBK,EAAkB,CAAC,EAEtF,KAAM,CAAE,sBAAAxB,GAAuB,UAAW0C,EAAsB,KAAI,MAAyB,EAEvFC,MAAoB,eACvBxY,GAAuB,CACtB,GAAI,CAAAkY,GAMJ,GAAII,GAAqB,CACvB,MAAMG,EAAiB1N,GAAkB,GAAG,EAAE,EAC9C,GAAI,CAAC0N,EACH,OAGF,MAAMzY,GAAYyY,EAAe,MAEjCre,EAAS,YAAa4F,EAAS,EAC/BqQ,EAAWrU,EAAU,SAAS,EAAGgE,EAAS,CAC5C,MACEqQ,EAAWrU,EAAU,SAAS,EAAGgE,IAAchE,EAAU,WAAW,GAAK,GAAG,CAEhF,EACA,CAACkc,GAAsBnN,GAAmBuN,GAAqBle,EAAUiW,EAAYrU,CAAS,CAChG,KAGA,aAAU,IAAM,CACd5B,EAAS,UAAWoI,EAAS,CAAE,eAAgB,EAAM,CAAC,CACxD,EAAG,CAACA,EAAS6N,EAAYjW,CAAQ,CAAC,EAElC,MAAMse,MAA0B,OAAsC,IAAM,OAEtEC,GAAenW,EAAQ,SAAW,KAIxC,aAAU,IAAM,CACd,GAAI1I,IAAQ,IAAC,OAA2BA,EAAI,EAC1C,OAGF,MAAM8e,EAAmB5c,EAAU,WAAW,EAC9C,GAAI,CAAC4c,EACH,OAGF,MAAMjF,EAAc8D,EAAiBmB,CAAgB,EACrD,GAAI,CAACjF,EACH,OAGF,MAAMza,MAAQ,MAAqBya,CAAW,MAAK,MAA0BA,CAAW,EAExF4D,EAAare,IAAO,SAAW,EAAE,CACnC,EAAG,CAACue,EAAkBzb,EAAWub,EAAczd,EAAI,CAAC,EAEpD,MAAM+e,MAAqB,eACxBlJ,GAAyB,CACnBA,IAIL6I,GAAkB7I,CAAK,EAEvBvV,EAAS,YAAauV,CAAK,EAC7B,EACA,CAAC6I,GAAmBpe,CAAQ,CAC9B,EAEMuQ,MAAgB,eACpB,CAACuI,EAAkBD,IAAqB,IACf,MAAYzQ,EAASyQ,CAAQ,IAMpDS,EAAS5B,GAAsB,CAAE,SAAAoB,EAAU,SAAAD,CAAS,CAAC,CAAC,EAGlDjT,KAAckT,GAChB9Y,EAAS,YAAa6Y,CAAQ,EAElC,EACA,CAACjT,GAAWwC,EAASpI,CAAQ,CAC/B,EAEM0e,GAAgCC,GAA8B,EAE9D5I,MAAkB,eACrB3B,GAAiC,CAQhC,MAAMzD,GAFkB/O,EAAU,SAAS,EAED,OAAoC,KAAwB,EAEtG5B,EAAS,UAAW,CAAC,GAAGoU,EAAgB,GAAGzD,EAAiB,EAAG,CAAE,eAAgB,EAAM,CAAC,EACxF+N,GAA8BtK,CAAc,EAIxC,CAACkI,GAAuBqB,IAC1BrE,EAASrB,GAAyB,CAAE,eAAA7D,EAAgB,kBAAAzD,EAAkB,CAAC,CAAC,EAG1E2I,EAASlC,GAAehD,CAAc,CAAC,EACvCkF,EAASzB,GAA0B,CAAC,EAGpC,KAAM,CAACiB,GAAUD,EAAQ,KAAI,MAA+BzQ,EAASgM,CAAc,EAC/E0E,IAAYD,IACdS,EAAS3B,GAAkB,CAAE,SAAAmB,GAAU,SAAAD,EAAS,CAAC,CAAC,CAEtD,EACA,CAACzQ,EAASsW,GAA+B9c,EAAW5B,EAAUsc,EAAqBqB,EAAwB,CAC7G,EAEMiB,MAAgC,eACnCxK,GAAiC,CAChC,MAAM3E,EAAQ2E,EAAe,CAAC,EAE9B,GAAI,IAAC,OAAkB3E,EAAM,KAAK,EAChC,OAGF,MAAM/E,GAAa+E,EAAM,MAAM,KAE/BzP,EAAS,UAAWoU,EAAgB,CAAE,eAAgB,EAAM,CAAC,EAC7DsK,GAA8BtK,CAAc,EAE5CkF,EAASpB,GAAyB,CAAE,qBAAsB9D,EAAgB,WAAA1J,EAAW,CAAC,CAAC,EACvF0T,GAAkB,CACpB,EACA,CAACA,GAAmBpe,EAAU0e,EAA6B,CAC7D,EAIMG,GAAiCpD,GAAsB,GAAG,CAAC,KAEjE,aAAU,IAAM,CAEd,GADA+B,GAAiB,EACb9d,KAAS,IAAa,eAAgB,CACxC,MAAM6W,EAAO3U,EAAU,YAAY,EAEnC,GAAI,CAACid,GACH,OAOF,MAAMC,GAAe,CACnB,MAAO,IACP,cALCxC,MAAuB,KAAiB,EAAE,oBAAoBrV,EAAc,GAAG,KAChF4X,GAA+B,IAK/B,UAAW,GACX,qBAAmB,MAA4B,EAC/C,KAAAtI,EACA,QAAS,GACT,MAAO,CACL,MAAO,IACP,KAAM,GACN,KAAAA,CACF,CACF,EACA+C,EAASpB,GAAyB,CAAE,qBAAsB,CAAC4G,EAAY,EAAG,WAAYvI,CAAK,CAAC,CAAC,CAC/F,CACF,EAAG,CAAC7W,GAAMmf,GAAgCvC,EAAqB1a,EAAWqF,GAAgBuW,EAAgB,CAAC,EAE3G,MAAMnL,MAAmB,eAAa5C,GAAsB,CAC1D6J,EAASpC,GAAezH,CAAK,CAAC,CAChC,EAAG,CAAC,CAAC,KAGL,aAAU,IAAM,CACd,GAAI,IAAC,MAAYrH,EAASxC,EAAS,EAAG,CACpC,MAAMmZ,EAAY3W,EAAQ,GAAG,EAAE,GAAG,OAAS,KAC3CqW,GAAmBM,CAAS,CAC9B,CACF,EAAG,CAACnZ,GAAWwC,EAASqW,EAAkB,CAAC,EAE3C,MAAMO,MAAc,eACjBtf,GAA8B,CAC7B4Z,EAASjC,GAAiB3X,CAAI,CAAC,CACjC,EACA,CAAC4Z,CAAQ,CACX,EAEMhb,MAAS,MAAW,EAAS,EAM7BsY,MAA0B,eAC7BqI,GAA0B,CACzB,MAAMC,KAAa,aAAU9W,CAAO,EACpC8W,EAAW,CAAC,EAAE,cAAgBD,EAC9Bjf,EAAS,UAAWkf,EAAY,CAAE,eAAgB,EAAM,CAAC,EAEzDR,GAA8BQ,CAAU,EAExC5F,EAASlC,GAAe8H,CAAU,CAAC,CACrC,EACA,CAAC9W,EAASpI,EAAU0e,GAA+BpF,CAAQ,CAC7D,EAKM6F,GAAsBte,GAAkB,CAC5C,MAAMqe,KAAa,aAAU9W,CAAO,EAEpC,GAAI8W,EAAW,CAAC,EAAE,MAChB,MAAI,OAAkBA,EAAW,CAAC,EAAE,KAAK,EACvCA,EAAW,CAAC,EAAE,MAAM,KAAOre,MACtB,CAGL,MAAMue,GAA4B,CAChC,MAAG,aAAUF,EAAW,CAAC,EAAE,KAAK,EAChC,KAAMre,CACR,EACAqe,EAAW,CAAC,EAAE,MAAQE,EACxB,CAGFpf,EAAS,UAAWkf,EAAY,CAAE,eAAgB,EAAM,CAAC,EAEzDR,GAA8BQ,CAAU,EAExC5F,EAASlC,GAAe8H,CAAU,CAAC,EACnCd,GAAkB,CACpB,EAEMiB,MAA6B,eAAY,IAAM/F,EAAS/B,GAAkB,CAAC,EAAG,CAAC+B,CAAQ,CAAC,EAExFgG,MAA0B,eAC7BzK,GAA8ByE,EAAS9B,GAAe3C,CAAW,CAAC,EACnE,CAACyE,CAAQ,CACX,EAGM,CAACiG,GAAiBC,EAAkB,KAAI,YAAuB,CAAC,CAAC,EACjE,CAACC,GAAeC,EAAgB,KAAI,YAAwB,IAAI,EAEhEC,MAA8B,eAAY,IAAM,CACpDL,GAAwBC,EAAe,CACzC,EAAG,CAACA,GAAiBD,EAAuB,CAAC,EAEvC/C,MAAgB,eAAY,IAAM,CAEtC,GADmB3a,EAAU,MAAM,IAChB,IAAa,cAC9B5B,EAAS,OAAQ,IAAa,OAAO,EACrCA,EAAS,iBAAkB,IAAI,EAE/Buf,GAAgB,OAAS,GAAKI,GAA4B,EAC1DF,IAAiBzf,EAAS,YAAayf,EAAa,MAC/C,CACLzf,EAAS,OAAQ,IAAa,aAAa,EAG3C,MAAM4f,KAAY,KAAiB,EAAE,oBAAoBxX,EAAQ,CAAC,EAAE,aAAa,GAAG,KAChFwX,GACF5f,EAAS,iBAAkB4f,CAAS,EAGtClB,GAA8BtW,CAAO,EAErC,MAAMyM,GAAczM,EAAQ,OAAQqH,IAAUA,GAAM,gBAAkB,IAAuB,EAC7F+P,GAAmB3K,EAAW,EAC9BwK,GAA2B,EAC3BK,GAAiB9Z,EAAS,CAC5B,CACF,EAAG,CACDhE,EACA5B,EACAuf,GAAgB,OAChBI,GACAF,GACAf,GACAtW,EACAiX,GACAzZ,EACF,CAAC,EAEK,CAAE,aAAAia,GAAc,UAAAC,GAAW,YAAAC,GAAa,SAAAC,EAAS,EAAItD,GAAahd,IAAQ,IAAa,OAAO,EAEpG,GAAI,CAACA,GACH,OAAO,KAET,MAAM+H,GACJmV,IAAyBc,GACrB,CACE,eAAgB,CAACQ,GACjB,gBAAkBxW,GAAwB,CACxC,GAAI,CAAC9F,EAAU,sCAAsC,GAC/C,IAAC,OAAyCib,GAAalM,EAAiB,EAAG,CAC7EqN,GAAkB,EAAI,EACtB,MACF,CAEFhe,EAAS,uCAAwC,CAAC0H,CAAU,CAC9D,CACF,EACA,OAEAuY,GACJ9E,GAAmB/S,CAAO,GAC1B,EAAQqT,GAAsB,QAC9BrT,EAAQ,KAAMqH,GAAUgM,GAAsB,KAAMyE,GAAWA,EAAO,MAAQzQ,EAAM,aAAa,CAAC,EAEpG,SACE,oBACE,qBAACrN,GAAA,GACC,OAAQ,EACR,MAAOyd,GACP,UAAW,GACX,eACE,QAACte,EAAA,EAAK,CAAC,UAAU,MAAM,IAAK,GAAK,WAAW,SAC1C,oBAACW,EAAA,EAAI,CAAC,QAAQ,YAAY,MAAM,YAC7B,SAAA4d,EAAA,CACH,KACA,OAAC3d,GAAA,GACC,YAAa4d,GACb,aAAcC,GACd,SAAU,yCACV,MAAOF,EAAA,CACT,GACF,EAEF,WAAArY,GAGC,oBAA8B/H,EAAI,MACjC,OAACiX,EAAuB,CAAC,wBAAAC,GAAkD,SAAU0F,CAAA,CAAqB,EAI3GT,IAAuB5U,OACtB,OAACzF,GAAA,EAAK,CAAC,MAAOzB,EAAO,YAAY,QAAS,QAAS,CAAC,CAACA,EAAO,YAAY,QACtE,mBAACiW,EAAA,CACC,eAAA/O,GACA,QAAAmB,EACA,WAAY,IAAMgW,GAAkB,EACpC,cAAeQ,GACf,UAAWvB,CAAA,CACb,EACF,EAGDc,OACC,OAACjc,EAAA,EAAI,CACH,mBAAC,KAAK,CAAC,QAAQ,2DAA2D,mCAAuB,EACnG,EAID,CAACic,IAAyBL,IAAwB7W,OACjD,QAAC1F,EAAA,EAAK,CAAC,UAAU,SACf,oBAACC,GAAA,EAAK,CAAC,MAAOzB,EAAO,YAAY,QAAS,QAAS,CAAC,CAACA,EAAO,YAAY,QACtE,mBAAC,MACC,KAAK,aACL,OAAQ,CAAC,CAAE,MAAO,CAAE,IAAAU,EAAK,GAAGC,CAAM,CAAE,OAEhC,OAACsO,GAAA,CACE,GAAGtO,EACJ,eAAAuG,GACA,wBAAyB,CAAC4U,GAC1B,SAAUsD,EAAA,CACZ,EAGJ,QAAAvf,EACA,MAAO,CACL,SAAU,CACR,MAAO,GACP,WAAS,KACP,6EACA,gCACF,CACF,CACF,EACF,EACF,EACCwd,IAAS,WACR,oBACE,oBAAC+C,GAAA,EAAO,EAAC,KACT,OAAC9D,GAAA,CACC,oBAAAC,EACA,QAAAlU,EACA,sBAAAqT,GACA,cAAAc,EAAA,CACF,GACF,GAEJ,EAID,CAAC4B,OAAyB,OAA2Bze,EAAI,MACxD,QAAC6B,EAAA,EAAK,CAAC,UAAU,SAEf,oBAACuO,GAAA,CACC,QAAS+M,GACT,YAAalM,GACb,aAAc,IAAMyN,GAAkB,EACtC,gBAAArI,GACA,iBAAA1D,GACA,UAAWgL,EACX,UAAAzX,GACA,eAAgB6Y,EAAA,CAClB,EACC,CAACP,OACA,OAACpP,GAAA,GACC,WAAS,KACP,4DACA,+CACF,EACA,KAAMwP,GAEN,mBAAC/X,EAAA,IACC,KAAK,SACL,QAAS,IAAM,CACb+S,EAASnC,GAAgB,CAAC,CAC5B,EACA,QAAQ,YACR,cAAaiJ,EAAA,GAAU,WAAW,SAAS,SAC3C,SAAU9B,GACV,UAAWhgB,GAAO,eAElB,mBAAC,KAAK,CAAC,QAAQ,gDAAgD,qBAAS,EAC1E,EACF,EAGD2hB,IAA8BrD,IAAyB,CAACsB,IAAuBd,IAAS,WACvF,oBACE,oBAAC+C,GAAA,EAAO,EAAC,KACT,OAAC9D,GAAA,CACC,oBAAAC,EACA,sBAAAb,GACA,QAAArT,EACA,cAAAmU,EAAA,CACF,GACF,EAGD,CAAC2B,OACA,oBACE,oBAACiC,GAAA,EAAO,EAAC,KACT,QAAC5e,EAAA,EAAK,CAAC,UAAU,SAAS,IAAK,EAC7B,oBAACW,EAAA,EAAI,CAAC,QAAQ,KACZ,mBAAC,KAAK,CAAC,QAAQ,kDAAkD,uBAAW,EAC9E,KACA,OAACA,EAAA,EAAI,CAAC,QAAQ,YAAY,MAAM,YAC9B,mBAAC,KAAK,CAAC,QAAQ,mFAAmF,iFAElG,EACF,GACF,KAEA,OAACkO,GAAA,CACC,QAAAhI,EACA,UAAWiV,EACX,UAAAzX,GACA,eAAgB6Y,GAChB,mBAAqBlJ,GAAU,CAC7B+D,EAAShC,GAAiB/B,CAAK,CAAC,CAClC,EACA,cAAAhF,GACA,uBAAwB,CAACgF,EAAO7V,IAAS,CACvC4Z,EAAS1B,GAAqB,CAAE,MAAArC,EAAO,KAAA7V,CAAK,CAAC,CAAC,CAChD,EACA,wBAA0B4V,GAAU,CAClCgE,EAAS7B,GAAiBnC,CAAK,CAAC,CAClC,EACF,GACF,KAGF,QAAC/T,EAAA,EAAK,CAAC,UAAU,SACd,UAAA2c,OACC,OAAC/E,GAAA,CACC,gBAAAC,GACA,SAAU6D,GACV,sBAAuBtM,GACvB,SAAA2I,EACA,YAAa+D,EAAiBzX,IAAa,EAAE,EAC/C,KAEF,QAACrE,EAAA,EAAK,CAAC,UAAU,MACd,WAAC2c,IAAuB9W,EAAA,EAAO,uBAAsB,OAACiZ,GAAA,CAAmB,YAAArB,EAAA,CAA0B,EAEnGzB,MACC,OAAChX,EAAA,GAAM,CAAC,KAAK,UAAU,KAAK,SAAS,QAAQ,cAAc,QAAS+W,EAClE,mBAAC,KAAK,CAAC,QAAQ,yBAAyB,kBAAM,EAChD,EAED,CAACC,MACA,OAAChX,EAAA,IACC,cAAa6Z,EAAA,GAAU,WAAW,WAAW,cAC7C,KAAK,OACL,KAAK,SACL,QAAS,IAAMhC,GAAkB,EACjC,SAAUG,GAET,SAACL,MAEE,KAAE,oDAAqD,8BAA8B,KADrF,KAAE,2CAA4C,SAAS,CAC8B,CAC3F,GAEJ,GACF,EAGCK,OACC,OAACtU,EAAA,GACC,SAAO,KACL,2EACA,gDACF,EACA,SAAS,UAET,mBAAC,KAAK,CAAC,QAAQ,0EAA0E,oEAEzF,EACF,GAEJ,GAEJ,KAEA,OAACqW,GAAA,GACC,OAAQvC,GACR,SAAO,KACL,wEACA,6BACF,EACA,QACE,QAAC,OACC,oBAAC7b,EAAA,EAAI,CAAC,QAAQ,IACZ,mBAAC,KAAK,CAAC,QAAQ,+DAA+D,gLAG9E,EACF,KACA,OAAC,OAAG,GACN,EAEF,eAAa,KAAE,6DAA8D,YAAY,EACzF,KAAK,uBACL,UAAW,IAAM,CACflC,EAAS,uCAAwC,EAAI,EACrDge,GAAkB,EAAK,EACvB1E,EAAStB,GAAuB,CAAC,CACnC,EACA,UAAW,IAAMgG,GAAkB,EAAK,EAC1C,GACF,CAEJ,EAEA,SAASqC,GAAmB,CAAE,YAAArB,CAAY,EAAyD,CACjG,MAAMuB,KACJ,OAACC,EAAA,EAAI,CACF,cAAgB,IAAK9gB,MACpB,OAACoP,GAAA,EAAO,CAAkB,QAASpP,EAAK,aAAe,GAAI,UAAU,QACnE,mBAAC+gB,GAAA,GAEC,QAAS,IAAMzB,EAAYtf,EAAK,OAAS,KAAoB,IAAI,EACjE,MAAOA,EAAK,OAAS,IAFhBA,EAAK,KAGZ,GALYA,EAAK,KAMnB,CACD,EACH,EAGF,SACE,OAACghB,GAAA,EAAQ,CAAC,QAASH,EACjB,mBAACha,EAAA,GAAM,CAAC,QAAQ,YAAY,cAAa,wBAAyB,KAAK,aACrE,mBAAC,KAAK,CAAC,QAAQ,+CAA+C,0BAAc,EAC9E,EACF,CAEJ,CAEA,MAAM,GAAavH,IAA0B,CAC3C,kBAAgB,OAAI,CAClB,MAAO,aACT,CAAC,EACD,YAAU,OAAI,CACZ,QAAS,OACT,cAAe,MACf,WAAY,SACZ,MAAO,cACP,WAAYA,EAAM,WAAW,iBAC7B,WAAYA,EAAM,QAAQ,CAAC,EAC3B,SAAUA,EAAM,WAAW,KAAK,GAChC,OAAQ,SACV,CAAC,EACD,gBAAc,OAAI,CAChB,WAAYA,EAAM,QAAQ,EAAG,EAC7B,eAAgB,WAClB,CAAC,EACD,YAAU,OAAI,CACZ,MAAOA,EAAM,OAAO,KAAK,IAC3B,CAAC,CACH,GAEM2f,GAAgC,IAAM,CAC1C,KAAM,CAAE,SAAA3e,CAAS,KAAI,MAA+B,EAEpD,OAAQoU,GAAiC,CAEvC,MAAM3E,EAAQ2E,EAAe,CAAC,EAC9B,GAAI,CAAC3E,EACH,OAIF,GAAI,IADuB,KAAiB,EAAE,oBAAoBA,EAAM,aAAa,EAEnF,MAAM,IAAI,MAAM,uCAAuC,EAGzD,MAAI,OAAkBA,EAAM,KAAK,EAAG,CAClC,MAAM/E,EAAa+E,EAAM,MAAM,KAC/BzP,EAAS,aAAc0K,CAAU,CACnC,CACF,CACF,C,yECzxBA,KAAM,CAAE,+BAAAiW,CAA+B,EAAI,IAEpC,SAASC,GAGd,CACA,KAAM,CAACnF,EAAuBoF,CAAwB,KAAI,YAAuC,CAAC,CAAC,EAC7F,CAACC,EAAoB,CAAE,UAAA7f,CAAU,CAAC,EAAI0f,EAA+B,EAE3E,sBAAU,IAAM,IACM,MAAoB,EAC5B,QAAQ,MAAOhgB,GAAO,CAChC,KAAM,CAAE,KAAMqL,CAAW,EAAI,MAAM8U,EAAmB,CAAE,IAAKngB,EAAG,GAAI,EAAG,EAAI,EACvEqL,GAAY,aACd6U,EAA0BE,GAAS,CAAC,GAAGA,EAAMpgB,CAAE,CAAC,CAEpD,CAAC,CACH,EAAG,CAACmgB,CAAkB,CAAC,EAEhB,CAAE,sBAAArF,EAAuB,UAAAxa,CAAU,CAC5C,C,8KChBO,SAAS+f,EAAa,CAAE,MAAAviB,EAAO,SAAA8U,CAAS,EAAsB,CACnE,SACE,QAACtJ,EAAA,EAAK,CAAC,aAAW,MAAWgX,CAAa,EAAE,QAAS,SAAS,UAAU,MAAAxiB,EACtE,oBAAC,KAAG,SAAA8U,CAAA,CAAS,KACb,OAAC,KAAU,CAAC,KAAK,gBACf,mBAAC,KAAK,CAAC,QAAQ,sCAAsC,wBAAY,EACnE,GACF,CAEJ,CAEA,MAAM0N,EAAiBjiB,IAA0B,CAC/C,WAAS,OAAI,CACX,OAAQA,EAAM,QAAQ,CAAC,CACzB,CAAC,CACH,G,4ICNO,SAASkiB,GACd1W,EACyC,CACzC,MAAO,YAAaA,CACtB,CAEO,SAAS2W,GACd3W,EACuC,CACvC,MAAO,WAAYA,CACrB,C,+ICbA,MAAM4W,GAA2B,CAAC,CAAE,SAAAtb,EAAU,aAAA+G,EAAc,QAAAxO,CAAQ,IAAqC,CACvG,KAAM,CAAE,YAAagjB,EAAqB,GAAI,WAAAC,EAAW,EAAItb,GAAA,GAAa,UAAU,YAAY,SAAS,CACvG,QAASF,EACT,OAAQ+G,CACV,CAAC,EAEKK,EAAmB,GAAGpH,CAAQ,IAAI,IAAI,KAAK,EAAE,QAAQ,CAAC,GAE5D,OAAIwb,MACK,OAAC9a,GAAA,EAAkB,CAAC,QAAM,KAAE,oDAAqD,aAAa,EAAG,KAIxG,OAAC+a,GAAA,GACC,OAAQ1U,EACR,eAAgBwU,EAChB,iBAAAnU,EACA,QAAA7O,CAAA,CACF,CAEJ,EAOamjB,GAAsB,CAAC,CAAE,QAAAnjB,EAAS,SAAAyH,CAAS,IAAiC,CACvF,KAAM,CAACuH,EAAWC,CAAY,KAAI,YAAwB,MAAM,EAEhE,SACE,OAACmU,GAAA,GACC,UAAApU,EACA,YAAaC,EACb,QAAAjP,EACA,gBAAiB,OAAO,OAAO,KAAyB,EAExD,mBAAC+iB,GAAA,CAAyB,SAAAtb,EAAoB,aAAcuH,EAAW,QAAAhP,CAAA,CAAkB,EAC3F,CAEJ,E,wFCzCO,MAAMqjB,GAA0B,CAAC,CAAE,gBAAAC,CAAgB,IAAa,CACrE,KAAM,CACJ,QAAA/hB,EACA,MAAAE,EACA,UAAW,CAAE,OAAAC,CAAO,EACpB,SAAAC,EACF,KAAI,MAA+B,EAE7B4hB,KAAQ,MAAWC,CAAQ,EAC3B,CAAE,gBAAAC,EAAiB,UAAA7gB,EAAU,KAAI,OAAiC0gB,CAAe,EAEjFI,GAAYjiB,EAAM,WAAW,EAE7BkiB,MAAmD,WACvD,IACE,MAAM,KAAKF,EAAgB,KAAK,CAAC,EAAE,IAAKC,KAAe,CACrD,MAAOA,GACP,MAAOA,EACT,EAAE,EACJ,CAACD,CAAe,CAClB,EAEMG,MAA+C,WACnD,IAAOF,IAAaD,EAAgB,IAAIC,EAAS,GAAG,IAAKhW,KAAW,CAAE,MAAOA,GAAO,MAAOA,EAAM,EAAE,GAAM,CAAC,EAC1G,CAACgW,GAAWD,CAAe,CAC7B,EAEA,SACE,QAAC,OAAI,UAAWF,EAAM,QACpB,oBAACpgB,GAAA,GACC,cAAY,mBACZ,SAAO,KAAE,uEAAwE,WAAW,EAI5F,YAAY,+DACZ,MAAOzB,EAAO,WAAW,QACzB,QAAS,CAAC,CAACA,EAAO,WAAW,QAE7B,mBAAC,MACC,OAAQ,CAAC,CAAE,MAAO,CAAE,SAAAS,GAAU,IAAAC,GAAK,GAAGC,EAAM,CAAE,OAC5C,OAAC,OACE,GAAGA,GACJ,iBAAgB,GAChB,UAAWkhB,EAAM,MACjB,SAAW/gB,IAAU,CACnBb,GAAS,QAAS,EAAE,EACpBQ,GAASK,GAAM,KAAK,CACtB,EACA,QAASmhB,GACT,MAAO,GACP,UAAA/gB,GACA,SAAUA,EAAA,CACZ,EAEF,KAAK,YACL,QAAArB,EACA,MAAO,CACL,SAAU,CAAE,MAAO,GAAM,WAAS,KAAE,uDAAwD,WAAW,CAAE,CAC3G,EACF,EACF,KACA,OAAC4B,GAAA,GACC,cAAY,eACZ,SAAO,KAAE,+DAAgE,OAAO,EAIhF,YAAY,2DACZ,MAAOzB,EAAO,OAAO,QACrB,QAAS,CAAC,CAACA,EAAO,OAAO,QAEzB,mBAAC,MACC,OAAQ,CAAC,CAAE,MAAO,CAAE,IAAAU,GAAK,GAAGC,EAAM,CAAE,OAClC,OAAC,OACE,GAAGA,GACJ,iBAAgB,GAChB,QAASuhB,GACT,MAAO,GACP,SAAWphB,IAAU,CACnBb,GAAS,QAASa,GAAM,OAAS,EAAE,CACrC,EACA,UAAW+gB,EAAM,MACjB,UAAA3gB,GACA,SAAUA,EAAA,CACZ,EAEF,KAAK,QACL,QAAArB,EACA,MAAO,CACL,SAAU,CAAE,MAAO,GAAM,WAAS,KAAE,uDAAwD,WAAW,CAAE,CAC3G,EACF,EACF,GACF,CAEJ,EAEMiiB,EAAY7iB,IAA0B,CAC1C,WAAS,OAAI,CACX,QAAS,OACT,cAAe,MACf,eAAgB,aAEhB,YAAa,CACX,WAAYA,EAAM,QAAQ,CAAC,CAC7B,CACF,CAAC,EACD,SAAO,OAAI,CACT,MAAO,kBACT,CAAC,CACH,G,4BCjHO,MAAMkjB,EAA0B,IAAM,CAC3C,MAAM5jB,KAAS,MAAWC,EAAS,EAC7B,CACJ,SAAAsB,EACA,QAAAD,EACA,MAAAE,EACA,UAAW,CAAE,OAAAC,EAAO,CACtB,KAAI,MAA+B,EAE7BL,EAAOI,EAAM,MAAM,EACnBmH,EAAiBnH,EAAM,gBAAgB,EAE7C,SACE,QAACsC,GAAA,GACC,OAAQ,EACR,SAAO,KAAE,mEAAoE,yBAAyB,EAEtG,oBAACZ,GAAA,GACC,SAAO,KAAE,0DAA2D,gBAAgB,EACpF,eAAa,KACX,gEACA,yJACF,EAEA,oBAAC,OAAI,UAAWlD,EAAO,QACrB,oBAACkD,GAAA,EAAK,CAAC,QAAS,CAAC,CAACzB,GAAO,SAAS,QAAS,MAAOA,GAAO,SAAS,QAAS,UAAWzB,EAAO,YAC3F,mBAACsV,GAAA,GACE,GAAG/T,EAAS,UAAW,CACtB,QAAS,CACP,MAAO,QACP,WAAS,KACP,wEACA,6BACF,CACF,CACF,CAAC,EACD,MAAO,EACT,EACF,KACA,OAAC,MACC,KAAK,cACL,OAAQ,CAAC,CAAE,MAAO,CAAE,SAAAW,GAAU,IAAAC,GAAK,GAAGC,EAAM,CAAE,OAC5C,OAAC0Z,GAAA,IACE,GAAG1Z,GACJ,QAASyhB,GAAA,GACT,SAAWthB,IAAUL,GAASK,IAAO,KAAK,EAC1C,MAAO,GACP,UAAWvC,EAAO,SACpB,EAEF,QAAAsB,CAAA,CACF,GACF,EACF,EACCF,IAAS,KAAa,eAAiBuH,MACtC,OAACya,GAAuB,CAAC,gBAAiBza,CAAA,CAAgB,KAG5D,OAAC2C,GAAA,EAAW,EAAC,GACf,CAEJ,EAEMrL,GAAaS,IAA0B,CAC3C,eAAa,OAAI,CACf,aAAc,CAChB,CAAC,EACD,WAAS,OAAI,CACX,QAAS,OACT,cAAe,MACf,eAAgB,aAChB,WAAY,YACd,CAAC,EACD,YAAU,OAAI,CACZ,WAAYA,EAAM,QAAQ,EAAG,CAC/B,CAAC,CACH,G,wCCjFO,SAASojB,IAAsC,CACpD,KAAM,CAAE,MAAAtiB,CAAM,KAAI,MAA+B,EAE3CmH,EAAiBnH,EAAM,gBAAgB,EAE7C,OAAKmH,KAKH,OAAC7E,GAAA,GACC,OAAQ,EACR,SAAO,KACL,mFACA,yBACF,EACA,eAAa,KACX,kGACA,yDACF,EAEA,mBAACsf,GAAuB,CAAC,gBAAiBza,CAAA,CAAgB,EAC5D,EAhBO,IAkBX,C,4BC8CO,MAAMob,GAAgB,CAAC,CAAE,SAAApX,EAAU,QAAAqX,EAAS,gBAAAC,CAAgB,IAAa,CAC9E,MAAMjkB,KAAS,MAAW,EAAS,EAC7BE,MAAY,OAAmB,EAE/BgkB,KAAc,KAAwC,EACtDC,EAAgBD,EAAY,GAE5B,CAAE,sBAAAE,EAAsB,EAAIC,GAAyBF,CAAa,EAClE,CAACG,GAAcC,EAAe,KAAI,YAAS,EAAK,EAEhD,CAACC,EAAkB,KAAI,KAAsB,EAC7C,CAACC,EAAqB,KAAI,MAAyB,EAEnDla,MAAW,MAA8B2Z,EAAY,IAAI,EAEzDQ,MAAgC,WAAQ,IAGxC/X,GAAYqX,EACP,CAAE,MAAG,MAA2BrX,CAAQ,EAAG,MAAG,MAAsBqX,CAAO,CAAE,EAElFrX,KACK,MAA2BA,CAAQ,EAGxCqX,KACK,MAAsBA,CAAO,KAG/B,MAA6BzZ,EAAQ,EAC3C,CAACoC,EAAUqX,EAASzZ,EAAQ,CAAC,EAE1BmC,MAAU,MAAwB,CACtC,KAAM,WACN,cAAAgY,GACA,iBAAkB,EACpB,CAAC,EAEK,CACJ,aAAAC,GACA,MAAAnjB,GACA,UAAW,CAAE,aAAAojB,EAAa,EAC1B,QAAA1gB,EACF,EAAIwI,MAEJ,aAAU,IAAM,CAGVuX,GACF/f,GAAQ,CAEZ,EAAG,CAAC+f,EAAiB/f,EAAO,CAAC,EAC7B,MAAM9C,GAAOI,GAAM,MAAM,EACnBqjB,MAAkB,MAA2BzjB,IAAQ,KAAa,OAAO,EAEzEuH,GAAiBnH,GAAM,gBAAgB,EAEvCsjB,GAA8B,GAAQ1jB,QAAS,MAA2BA,EAAI,GAAOuH,KAErF,CAACoE,GAAmBC,EAAoB,KAAI,YAAS,EAAE,EAEvDE,GAAsB,CAACC,GAAM,KAAO,CACxCH,GAAqBG,EAAG,CAC1B,EAGMC,GAAS,MAAOrB,IAA0C,CAC9D,KAAM,CAAE,KAAA3K,GAAM,cAAA2jB,EAAc,EAAIhZ,GAEhC,GAAIgB,KAAsB,GAAI,CAC5B7M,GAAU,MAAM6M,EAAiB,EAC7B,CAACJ,GAAYkY,OAEf,MAAkC,EAEpC,MACF,IAEA,MAAwB,CAAE,WAAYlY,EAAW,SAAW,SAAU,SAAUvL,EAAK,CAAC,EAEtF,MAAM4jB,GAAiBH,MAAkB,OAAgC9Y,EAAM,KAAI,OAAyBA,EAAM,EAE5GkZ,GAAsBtY,KACxB,MAAyCA,CAAQ,KACjD,MAAmCZ,EAAM,EAEvCmZ,MAA4B,MAAmCnZ,EAAM,EAE3E,IAAIoZ,GAEJ,GAAKxY,EAeE,CAEL,MAAM7L,MAAiB,OAAoCmkB,GAAqBtY,EAAS,IAAI,EAC7FwY,GAAa,MAAMV,GAAsB,QACvCQ,GACAnkB,GACAkkB,GACAE,GACAH,EACF,CACF,SAvBEK,GAA0BrZ,EAAM,EAEhCoZ,GAAa,MAAMX,GAAmB,QAAQS,GAAqBD,GAAgBD,EAAa,EAE5FF,GAAiB,CACnB,MAAMtG,GAAcxS,GAAO,QAAQ,OAAQoF,IAAU,IAAC,MAAkBA,GAAM,KAAK,CAAC,EAC9EkB,GAAoBtG,GAAO,QAAQ,OAAQoF,OAAU,OAAyBA,EAAK,CAAC,KAC1F,MAAyC,CACvC,sBAAuBpF,GAAO,gBAAgB,uBAAyB,GACvE,6BAA8BA,GAAO,gBAAgB,8BAAgC,GACrF,iCAA+B,OAAyCwS,GAAalM,EAAiB,CACxG,CAAC,CACH,CAaF+R,GAAsBY,GAAgBE,GAA2BC,EAAU,CAE7E,EAEMlY,GAAiDxL,IAAiB,IACtE,MAAwB,CACtB,gBAAiBqH,EAAA,EAAO,UAAU,QAClC,OAAQ,MAAW,KAAK,MACxB,QAAS,MAAW,KAAK,GACzB,MAAO,OAAO,KAAKrH,EAAM,EAAE,SAAS,EACpC,WAAYkL,EAAW,SAAW,QACpC,CAAC,EACDzM,GAAU,MAAM,kEAAkE,CACpF,EAEMmlB,GAAqB,IAAM,IAC/B,MAAQ,KAAY,qBAAqB,KACzC,MAA4B,CAAE,WAAY1Y,EAAW,SAAW,QAAS,CAAC,EACtE,CAACA,GAAYkY,OAEf,MAAsC,EAExC,KAAgB,WAAW,EAAE,OAAO,CACtC,EAEA,GAAI,CAACzjB,GACH,OAAO,KAGT,MAAMkkB,GAAW,IAAc,QAAQ,KAAK3Y,GAAU,IAAI,MAAK,MAAaA,GAAU,IAAI,EAE1F,SACE,QAAC,KAAY,CAAE,GAAGD,GAChB,oBAAC,QAAK,SAAWjM,IAAMA,GAAE,eAAe,EAAG,UAAWT,EAAO,KAC3D,oBAAC,OAAI,UAAWA,EAAO,aACpB,UAAAikB,MACC,OAACtY,EAAA,GACC,SAAS,UACT,SAAO,KAAE,8DAA+D,yBAAyB,EAEjG,mBAAC,KAAK,CAAC,QAAQ,wDAAwD,gJAGvE,EACF,EAED2Z,OAAY,OAACC,EAAA,EAAc,EAAC,KAC7B,QAACtiB,GAAA,EAAK,CAAC,UAAU,SAAS,IAAK,EAE7B,oBAAC,KAAsB,EAAC,KAExB,OAAC2b,GAAA,EAAuB,CAAC,oBAAqB,CAAC,CAACjS,EAAU,aAAcO,GAAqB,KAAK,MAAO,GAExG4X,OACC,oBAEG,mBAA2B1jB,EAAI,MAAK,OAACiC,GAAA,EAA0B,EAAC,KAEhE,MAA0BjC,EAAI,MAAK,OAACwiB,EAAuB,EAAC,KAE5D,MAA2BxiB,EAAI,MAAK,OAAC0iB,GAAmC,EAAC,KAGzE,MAA2B1iB,EAAI,MAC9B,OAACokB,GAAA,GAA6B,CAAC,SAAU,EAAQ7Y,EAAW,wBAAyB,GAAO,KAG9F,OAAClE,GAAA,EAAiB,CAAC,SAAU0b,CAAA,CAAe,EAE3C,IAAC,MAAsB/iB,EAAI,MAAK,OAACqkB,GAAA,EAAe,EAAC,GACpD,KAIF,QAACxiB,GAAA,EAAK,CAAC,UAAU,MAAM,WAAW,SAChC,oBAACgF,EAAA,IACC,cAAY,YACZ,QAAQ,UACR,KAAK,SACL,QAAS0c,GAAc5Y,IAAWqB,GAAOrB,EAAM,EAAGkB,EAAS,EAC3D,SAAU2X,GACV,KAAMA,GAAe,UAAY,OAEjC,mBAAC,KAAK,CAAC,QAAQ,+CAA+C,gBAAI,EACpE,KAEA,OAAC3c,EAAA,GAAM,CAAC,QAAQ,YAAY,SAAU2c,GAAc,KAAK,SAAS,QAASS,GACzE,mBAAC,KAAK,CAAC,QAAQ,yBAAyB,kBAAM,EAChD,EAEC1Y,GAAY+Y,GAA4BlkB,EAAK,MAC5C,OAACyG,EAAA,GAAM,CAAC,QAAQ,YAAY,KAAK,SAAS,QAAS,IAAMsc,GAAgB,EAAI,EAAG,SAAUK,GACxF,mBAAC,KAAK,CAAC,QAAQ,oDAAoD,qBAAS,EAC9E,GAEJ,GACF,GACF,EACF,EAECN,OACC,oBACG,UAAAO,IAAmBV,MAClB,OAACjB,GAAmB,CAAC,SAAUiB,EAAe,QAAS,IAAMI,GAAgB,EAAK,EAAG,EAGtF,CAACM,OAAmB,OAACc,GAAA,GAAa,CAAC,QAAS,IAAMpB,GAAgB,EAAK,EAAG,GAC7E,GAEJ,CAEJ,EAEA,SAASF,GAAyBuB,EAAsB,CACtD,MAAM1lB,KAAY,OAAmB,EAE/B2lB,KAAsB,eACzBV,GAA4C,CAE3C,MAAMW,GAAuBX,EAAW,SAAS,GAAG,CAAC,GAAKA,EAAW,SAAS,GAAG,CAAC,IAAMS,EACpFE,EACF,KAAgB,QACd,KAAS,gBAAgB,UAAW,CAAE,IAAKA,EAAqB,eAAgB,SAAU,EAAG,OAAW,CACtG,YAAa,EACf,CAAC,CACH,GAEA5lB,EAAU,MACR,gDACA,8CACF,KACA,MAAW,4FAA4F,EAE3G,EACA,CAAC0lB,EAAa1lB,CAAS,CACzB,EAEM6lB,KAAyB,eAAY,CAAC5X,EAAoB6X,IAAiC,CAC/F,KAAM,CAAE,eAAArd,GAAgB,cAAAsd,GAAe,UAAAC,EAAU,EAAIF,EAC/CG,MAAwB,OAAcxd,GAAgBsd,GAAeC,GAAW/X,CAAI,EAC1F,KAAgB,QACd,KAAS,gBAAgBgY,GAAsB,eAAgBA,GAAuB,OAAW,CAC/F,YAAa,EACf,CAAC,CACH,CACF,EAAG,CAAC,CAAC,EAwBL,MAAO,CAAE,yBAtBqB,eAC5B,CACEhY,EACA6X,EACAb,KACG,CACH,GAAIvC,GAA8BuC,EAAU,EAAG,CAC7CU,EAAoBV,EAAU,EAC9B,MACF,SAAW,IAAc,WAAW,KAAKhX,CAAI,EAAG,CAC9C4X,EAAuB5X,EAAM6X,CAAO,EACpC,MACF,IAEA,MACE,gJACA,CAAE,aAAc,IAAc,WAAW,KAAK7X,CAAI,EAAI,aAAe,SAAU,CACjF,CACF,EACA,CAAC0X,EAAqBE,CAAsB,CAC9C,CAE+B,CACjC,CAEA,MAAML,GAA+BlkB,GAAwC,CAC3E,KAAM,CAAC+I,EAAU5B,CAAc,EAAInH,EAAM,CAAC,OAAQ,gBAAgB,CAAC,EAEnE,OAAQ+I,IAAa,KAAa,eAAiBA,IAAa,KAAa,iBAAmB5B,IAAmB,EACrH,EAEA,SAASyc,GAA0BrZ,EAAwB,CACzD,KAAM,CAAE,cAAArD,EAAe,eAAA6W,CAAe,EAAIxT,EAEtCrD,EACF,aAAa,QAAQ,MAAoB,MAAM,EAE/C,aAAa,QAAQ,MAAoB,OAAO,EAG9C6W,IACEA,EAAe,sBACjB,aAAa,QAAQ,MAA6B,MAAM,EAExD,aAAa,QAAQ,MAA6B,OAAO,EAG/D,CAEA,MAAM,GAAa7e,IAA0B,CAC3C,QAAM,OAAI,CACR,MAAO,OACP,OAAQ,OACR,QAAS,OACT,cAAe,QACjB,CAAC,EACD,gBAAc,OAAI,CAChB,WAAYA,EAAM,OAAO,WAAW,QACpC,SAAU,SACV,SAAUA,EAAM,YAAY,OAAO,GACnC,KAAM,CACR,CAAC,CACH,G,yHC7YO,SAAS0lB,EAAejY,EAAoBkY,EAAiB,CAC9D,IAAc,QAAQ,KAAKlY,CAAI,IACjCA,EAAK,cAAc,MAAQkY,GAEzB,IAAc,WAAW,aAAalY,CAAI,IAC5CA,EAAK,MAAQkY,GAGX,IAAc,WAAW,cAAclY,CAAI,IAC7CA,EAAK,OAASkY,EAElB,CAEO,SAASC,EAAoBnY,EAAsC,CACxE,MAAMoY,KAAY,aAAUpY,CAAI,EAChC,OAAAiY,EACEG,EAAU,QACV,QAAmB,MAAYA,EAAU,IAAI,EAAGA,EAAU,MAAM,MAAM,IAAI,IAAW,CAAC,CACxF,EAEI,IAAc,QAAQ,KAAKA,EAAU,IAAI,IAC3CA,EAAU,KAAK,cAAc,IAAM,GAGvBA,EAAU,KAAK,cAAc,aACvCA,EAAU,MAAQ,CAAE,KAAM,GAAI,MAAOA,EAAU,MAAM,KAAM,IAIxDA,CACT,CCRO,SAASC,EAAmB,CACjC,WAAAC,EACA,QAAAzC,EACA,gBAAAC,EAAkB,GAClB,MAAAyC,EAAQ,EACV,EAA4B,CAC1B,MAAMC,GAAiB,MAAsCF,CAAU,EACjE,CACJ,QAASG,EACT,OAAQC,EACR,MAAOC,EACT,KAAI,OAAoB,CAAE,eAAgBL,CAAW,CAAC,EAChD,CACJ,WAAAM,GACA,QAASC,GACT,MAAOC,EACT,KAAIC,GAAA,GAAkBP,GAAgBE,GAAkB,IAAI,EAE5D,GAAIC,IAAkBG,GACpB,SACE,OAACE,EAAA,EAAmB,CAAC,MAAM,aAAa,QAASC,EAAW,EAC1D,mBAACzb,EAAA,GACC,SAAS,QACT,SAAO,KAAE,0DAA2D,qBAAqB,EAExF,mBAAmBsb,IAAiBH,EAAc,EACrD,EACF,EAIJ,MAAM9lB,GAAU4lB,GAAoBI,GACpC,GAAIhmB,GACF,SACE,OAACmmB,EAAA,EAAmB,CAAC,MAAM,aAAa,QAASC,EAAW,EAAG,UAAW,GACvE,cACH,EAIJ,GAAI,CAACP,GAAoB,CAAC7lB,GACxB,SACE,OAACmmB,EAAA,EAAmB,CAAC,MAAM,aAAa,QAASC,EAAW,EAC1D,mBAAC1E,EAAY,CAAC,SAAO,KAAE,qDAAsD,gBAAgB,EAC3F,mBAAC,KAAK,CAAC,QAAQ,+DAA+D,4CAE9E,EACF,EACF,EAIJ,GAAIqE,KAAe,GACjB,SACE,OAACI,EAAA,EAAmB,CAAC,MAAM,aAAa,QAASC,EAAW,EAC1D,mBAAC1E,EAAY,CAAC,SAAO,KAAE,uDAAwD,kBAAkB,EAC/F,mBAAC,KAAK,CAAC,QAAQ,iDAAiD,gEAEhE,EACF,EACF,EAKJ,GAAI,CAACmE,EACH,OAAO,KAGT,MAAM5lB,GAAY4lB,EAAiB,KAC7BQ,GAAU,IAAc,IAAI,aAAapmB,EAAS,EAAIA,GAAU,cAAc,MAAW,OAAO,EAAI,KAEpGqmB,MAAkB,MAAqBT,EAAiB,KAAK,EAG7DU,GAFkB,IAAc,IAAI,cAActmB,EAAS,KAG7D,KAAE,sCAAuC,qBAAqB,KAC9D,KAAE,kCAAmC,iBAAiB,EAE1D,SACE,OAACkmB,EAAA,GACC,MAAM,aACN,YACE,QAAClkB,GAAA,EAAK,CAAC,UAAU,SACd,UAAAokB,GAEAC,OAAmB,OAACE,GAAA,EAAoB,EAAC,GAC5C,EAEF,QAASJ,EAAW,CAAE,KAAMG,EAAU,CAAC,EAEtC,SAAAb,KACC,OAAC3C,GAAa,CAAC,WAAS,OAAsBuC,EAAoBO,CAAgB,CAAC,EAAG,KAEtF,OAAC9C,GAAa,CAAC,SAAU8C,EAAkB,QAAA7C,EAAkB,gBAAAC,CAAA,CAAkC,EAEnG,CAEJ,CAEA,MAAMmD,EAAcK,IACX,CAAE,GAAGC,EAAgB,GAAI,kBAAmB,KAAM,GAAI,GAAGD,CAAe,GC/GpEC,EAAwC,CACnD,GAAI,iBACN,EAEMC,EAAa,IAAM,CACvB,KAAM,CAAE,WAAAlB,CAAW,EAAImB,GAAwB,EACzCC,EAAkBC,GAAsB,EACxC7D,EAAkB8D,GAAiB,EAEnC,CAAE,sBAAAhL,EAAuB,oBAAAC,GAAqB,aAAAgL,CAAa,KAAI,MAAe,EAEpF,MAAI,CAACvB,GAAc,CAAC1J,GAAyB,CAACC,MAE1C,OAAC0F,EAAY,CAAC,SAAO,KAAE,6DAA8D,qBAAqB,EACxG,mBAAC,KAAK,CAAC,QAAQ,8DAA8D,uDAE7E,EACF,EAIA+D,GAAc,CAACuB,EAAavB,EAAW,cAAc,KAErD,OAAC/D,EAAY,CAAC,SAAO,KAAE,2DAA4D,mBAAmB,EACpG,mBAAC,KAAK,CAAC,QAAQ,uDAAuD,qDAEtE,EACF,EAIA+D,KAEA,OAACD,EAAkB,CAAkC,WAAAC,EAAwB,gBAAAxC,CAAA,EAApD,KAAK,UAAUwC,CAAU,CAA6D,EAI/GoB,KAEA,OAACrB,EAAA,CAEC,WAAYqB,EACZ,MAAO,GACP,gBAAA5D,CAAA,EAHK,KAAK,UAAUwC,CAAU,CAIhC,KAKG,OAACwB,GAAA,EAAc,CACxB,EAEaC,GAAiB,CAAC,oBAAqB,WAAW,EAK/D,SAASD,IAAgB,CACvB,MAAMjE,EAAUmE,GAAqB,EAC/BlE,EAAkB8D,GAAiB,EACnC,CAAE,KAAA3mB,EAAO,GAAI,WAAAqlB,EAAa,EAAG,EAAImB,GAAwB,EAEzDQ,GAAa,EAAQ3B,EACrB4B,EAAkBH,GAAe,SAAS9mB,CAAI,EAE9CknB,EAAUD,KACZ,KAAE,qCAAsC,oBAAoB,KAC5D,KAAE,iCAAkC,gBAAgB,EAElDE,GAAWF,KACb,KAAE,sCAAuC,qBAAqB,KAC9D,KAAE,kCAAmC,iBAAiB,EAE1D,SACE,OAAClB,EAAA,GACC,MAAM,aACN,QAAS,CACP,GAAI,iBACJ,KAAMiB,GAAaG,GAAWD,CAChC,EAEA,mBAACvE,GAAa,CAAC,QAAAC,EAAkB,gBAAAC,CAAA,CAAkC,EACrE,CAEJ,CAIA,YAAeuE,GAAA,GAAsBb,CAAU,EAE/C,SAASC,IAA0B,CACjC,MAAMhL,KAAS,KAAgC,EACzC,CAAE,KAAAxb,CAAK,EAAIwb,EACX/b,EAAK,MAA6B+b,CAAM,EAG9C,MAAO,CAAE,WAFU,MAAgB/b,EAAI,EAAI,EAEtB,KAAAO,CAAK,CAC5B,CAEA,SAAS0mB,IAAwB,CAC/B,KAAM,CAACW,CAAY,KAAIC,GAAA,GAAmB,EACpCC,EAAaF,EAAa,IAAI,UAAU,GAAK,OAEnD,OAAO,MAAgBE,CAAU,CACnC,CAEA,SAASR,IAAuB,CAC9B,KAAM,CAAE,KAAA/mB,CAAK,EAAIwmB,GAAwB,EACnC,CAACa,CAAY,KAAIC,GAAA,GAAmB,EAEpCne,KAAW,MAA8BnJ,CAAI,EAMnD,OAJsBqnB,EAAa,IAAI,UAAU,KAC7C,MAA0BA,EAAa,IAAI,UAAU,GAAK,GAAIle,CAAQ,EACtE,MAGN,CAEA,SAASwd,IAAmB,CAC1B,KAAM,CAACU,CAAY,KAAIC,GAAA,GAAmB,EAG1C,OAFwBD,EAAa,IAAI,iBAAiB,CAG5D,C,2DC5IO,SAASG,GAAiB,CAC/B,SAAO,WAAQ,OAAM,MAAe,EAAG,CAAC,CAAC,CAC3C,C,oCCNO,SAASC,EAAmBC,EAAsBC,EAA0B,CACjF,MAAMC,EAAmBF,EAAa,QAAQ,sBAAuB,EAAE,EAAE,KAAK,EAE9E,IAAIzC,EAAU,GAAG2C,CAAgB,UAEjC,QAASC,EAAI,EAAGF,EAAe,SAAS1C,CAAO,EAAG4C,IAChD5C,EAAU,GAAG2C,CAAgB,UAAUC,CAAC,IAG1C,OAAO5C,CACT,C","sources":["webpack://grafana/./public/app/features/alerting/unified/components/create-folder/CreateNewFolder.tsx","webpack://grafana/./public/app/features/alerting/unified/components/export/ExportNewGrafanaRule.tsx","webpack://grafana/./public/app/features/alerting/unified/components/export/GrafanaModifyExport.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/AlertRuleNameInput.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/CloudRulesSourcePicker.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/FolderSelector.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/GrafanaFolderAndLabelsStep.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/alert-rule-form/simplifiedRouting/contactPoint/ContactPointSelector.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/alert-rule-form/simplifiedRouting/route-settings/ActiveTimingFields.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/alert-rule-form/simplifiedRouting/route-settings/MuteTimingFields.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/alert-rule-form/simplifiedRouting/route-settings/RouteTimings.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/alert-rule-form/simplifiedRouting/route-settings/RouteSettings.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/alert-rule-form/simplifiedRouting/AlertManagerRouting.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/alert-rule-form/simplifiedRouting/SimplifiedRouting.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/notificaton-preview/NotificationPreview.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/NotificationsStep.tsx","webpack://grafana/./public/app/features/alerting/unified/types/preview.ts","webpack://grafana/./public/app/features/alerting/unified/api/preview.ts","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/PreviewRuleResult.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/PreviewRule.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/alert-rule-form/ModifyExportRuleForm.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/labels/LabelsEditorModal.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/labels/LabelsFieldInForm.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/preview.ts","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/CloudAlertPreview.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/ExpressionEditor.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/ExpressionsEditor.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/QueryOptions.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/QueryWrapper.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/QueryRows.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/QueryEditor.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/RecordingRuleEditor.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/query-and-alert-condition/CloudDataSourceSelector.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/query-and-alert-condition/reducer.ts","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/query-and-alert-condition/SimpleCondition.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/query-and-alert-condition/utils.ts","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/query-and-alert-condition/SmartAlertTypeDetector.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/query-and-alert-condition/descriptions.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/query-and-alert-condition/useAdvancedMode.ts","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/query-and-alert-condition/QueryAndExpressionsStep.tsx","webpack://grafana/./public/app/features/alerting/unified/hooks/useRuleSourcesWithRuler.ts","webpack://grafana/./public/app/features/alerting/unified/AlertWarning.tsx","webpack://grafana/./public/app/features/alerting/unified/api/alertRuleModel.ts","webpack://grafana/./public/app/features/alerting/unified/components/export/GrafanaRuleExporter.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/GroupAndNamespaceFields.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/CloudEvaluationBehavior.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/RecordingRulesNameSpaceAndGroupStep.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/alert-rule-form/AlertRuleForm.tsx","webpack://grafana/./public/app/features/alerting/unified/rule-editor/clone.utils.ts","webpack://grafana/./public/app/features/alerting/unified/rule-editor/ExistingRuleEditor.tsx","webpack://grafana/./public/app/features/alerting/unified/rule-editor/RuleEditor.tsx","webpack://grafana/./public/app/features/alerting/unified/utils/accessControlHooks.ts","webpack://grafana/./public/app/features/alerting/unified/utils/duplicate.ts"],"sourcesContent":["import { css } from '@emotion/css';\nimport { useState } from 'react';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { selectors } from '@grafana/e2e-selectors';\nimport { Trans, t } from '@grafana/i18n';\nimport { Button, Field, Input, Label, Modal, Stack, useStyles2 } from '@grafana/ui';\nimport { useAppNotification } from 'app/core/copy/appNotification';\nimport { contextSrv } from 'app/core/core';\nimport { useNewFolderMutation } from 'app/features/browse-dashboards/api/browseDashboardsAPI';\nimport { AccessControlAction } from 'app/types/accessControl';\n\nimport { Folder } from '../../types/rule-form';\n\n/**\n * Provides a button and associated modal for creating a new folder\n */\nexport const CreateNewFolder = ({ onCreate }: { onCreate: (folder: Folder) => void }) => {\n  const [isCreatingFolder, setIsCreatingFolder] = useState(false);\n  const handleCreate = (folder: Folder) => {\n    onCreate(folder);\n    setIsCreatingFolder(false);\n  };\n  return (\n    <>\n      <Button\n        onClick={() => setIsCreatingFolder(true)}\n        type=\"button\"\n        icon=\"plus\"\n        fill=\"outline\"\n        variant=\"secondary\"\n        disabled={!contextSrv.hasPermission(AccessControlAction.FoldersCreate)}\n      >\n        <Trans i18nKey=\"alerting.create-new-folder.new-folder\">New folder</Trans>\n      </Button>\n      {isCreatingFolder && <FolderCreationModal onCreate={handleCreate} onClose={() => setIsCreatingFolder(false)} />}\n    </>\n  );\n};\n\nfunction FolderCreationModal({\n  onClose,\n  onCreate,\n}: {\n  onClose: () => void;\n  onCreate: (folder: Folder) => void;\n}): React.ReactElement {\n  const styles = useStyles2(getStyles);\n  const notifyApp = useAppNotification();\n  const [title, setTitle] = useState('');\n  const [createFolder] = useNewFolderMutation();\n\n  const onSubmit = async () => {\n    const { data, error } = await createFolder({ title });\n\n    if (error) {\n      notifyApp.error('Failed to create folder');\n    } else if (data) {\n      onCreate({ title: data.title, uid: data.uid });\n      notifyApp.success('Folder created');\n    }\n  };\n\n  return (\n    <Modal\n      className={styles.modal}\n      isOpen\n      title={t('alerting.create-new-folder.title-new-folder', 'New folder')}\n      onDismiss={onClose}\n      onClickBackdrop={onClose}\n    >\n      <Stack direction=\"column\" gap={2}>\n        <Field\n          label={\n            <Label htmlFor=\"folder\">\n              <Trans i18nKey=\"alerting.create-new-folder.folder.name\">Folder name</Trans>\n            </Label>\n          }\n        >\n          <Input\n            data-testid={selectors.components.AlertRules.newFolderNameField}\n            autoFocus={true}\n            id=\"folderName\"\n            placeholder={t('alerting.create-new-folder.placeholder-enter-a-name', 'Enter a name')}\n            value={title}\n            onChange={(e) => setTitle(e.currentTarget.value)}\n          />\n        </Field>\n\n        <Modal.ButtonRow>\n          <Button variant=\"secondary\" type=\"button\" onClick={onClose}>\n            <Trans i18nKey=\"alerting.create-new-folder.folder.cancel\">Cancel</Trans>\n          </Button>\n          <Button\n            onClick={onSubmit}\n            disabled={!title}\n            data-testid={selectors.components.AlertRules.newFolderNameCreateButton}\n          >\n            <Trans i18nKey=\"alerting.create-new-folder.folder.create\">Create</Trans>\n          </Button>\n        </Modal.ButtonRow>\n      </Stack>\n    </Modal>\n  );\n}\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  modal: css({\n    width: `${theme.breakpoints.values.sm}px`,\n  }),\n});\n","import { t } from '@grafana/i18n';\n\nimport { withPageErrorBoundary } from '../../withPageErrorBoundary';\nimport { AlertingPageWrapper } from '../AlertingPageWrapper';\nimport { ModifyExportRuleForm } from '../rule-editor/alert-rule-form/ModifyExportRuleForm';\n\nfunction ExportNewGrafanaRulePage() {\n  return (\n    <AlertingPageWrapper\n      navId=\"alert-list\"\n      pageNav={{\n        text: t('alerting.export-new-grafana-rule-page.text.export-new-grafana-rule', 'Export new Grafana rule'),\n        subTitle: 'Export a new rule definition in Terraform(HCL) format. Any changes you make will not be saved.',\n      }}\n    >\n      <ModifyExportRuleForm />\n    </AlertingPageWrapper>\n  );\n}\n\nexport default withPageErrorBoundary(ExportNewGrafanaRulePage);\n","import { useMemo } from 'react';\nimport { useParams } from 'react-router-dom-v5-compat';\n\nimport { Trans, t } from '@grafana/i18n';\nimport { locationService } from '@grafana/runtime';\nimport { Alert, LoadingPlaceholder } from '@grafana/ui';\n\nimport { RuleIdentifier } from '../../../../../types/unified-alerting';\nimport { useRuleWithLocation } from '../../hooks/useCombinedRule';\nimport { formValuesFromExistingRule } from '../../rule-editor/formDefaults';\nimport { stringifyErrorLike } from '../../utils/misc';\nimport * as ruleId from '../../utils/rule-id';\nimport { rulerRuleType } from '../../utils/rules';\nimport { createRelativeUrl } from '../../utils/url';\nimport { withPageErrorBoundary } from '../../withPageErrorBoundary';\nimport { AlertingPageWrapper } from '../AlertingPageWrapper';\nimport { ModifyExportRuleForm } from '../rule-editor/alert-rule-form/ModifyExportRuleForm';\n\nfunction GrafanaModifyExport() {\n  const { id } = useParams();\n  const ruleIdentifier = useMemo<RuleIdentifier | undefined>(() => {\n    return ruleId.tryParse(id, true);\n  }, [id]);\n\n  if (!ruleIdentifier) {\n    return (\n      <Alert title={t('alerting.grafana-modify-export.title-invalid-rule-id', 'Invalid rule ID')} severity=\"error\">\n        <Trans i18nKey=\"alerting.grafana-modify-export.body-invalid-rule-id\">\n          The rule UID in the page URL is invalid. Please check the URL and try again.\n        </Trans>\n      </Alert>\n    );\n  }\n\n  return <RuleModifyExport ruleIdentifier={ruleIdentifier} />;\n}\n\nfunction RuleModifyExport({ ruleIdentifier }: { ruleIdentifier: RuleIdentifier }) {\n  const { loading, error, result: rulerRule } = useRuleWithLocation({ ruleIdentifier: ruleIdentifier });\n\n  if (loading) {\n    return <LoadingPlaceholder text={t('alerting.rule-modify-export.text-loading-the-rule', 'Loading the rule...')} />;\n  }\n\n  if (error) {\n    return (\n      <Alert\n        title={t('alerting.rule-modify-export.title-cannot-load-modify-export', 'Cannot load modify export')}\n        severity=\"error\"\n      >\n        {stringifyErrorLike(error)}\n      </Alert>\n    );\n  }\n\n  if (!rulerRule && !loading) {\n    // alert rule does not exist\n    return (\n      <Alert\n        title={t('alerting.rule-modify-export.title-cannot-exist', 'Cannot load the rule. The rule does not exist')}\n        buttonContent=\"Go back to alert list\"\n        onRemove={() => locationService.replace(createRelativeUrl('/alerting/list'))}\n      />\n    );\n  }\n\n  if (rulerRule && !rulerRuleType.grafana.rule(rulerRule.rule)) {\n    // alert rule exists but is not a grafana-managed rule\n    return (\n      <Alert\n        title={t(\n          'alerting.rule-modify-export.title-grafanamanaged-alert',\n          'This rule is not a Grafana-managed alert rule'\n        )}\n        buttonContent=\"Go back to alert list\"\n        onRemove={() => locationService.replace(createRelativeUrl('/alerting/list'))}\n      />\n    );\n  }\n\n  if (rulerRule && rulerRuleType.grafana.rule(rulerRule.rule)) {\n    return (\n      <ModifyExportRuleForm\n        ruleForm={formValuesFromExistingRule(rulerRule)}\n        alertUid={rulerRule.rule.grafana_alert.uid}\n      />\n    );\n  }\n\n  return <Alert title={t('alerting.rule-modify-export.title-unknown-error', 'Unknown error')} />;\n}\n\nfunction GrafanaModifyExportPage() {\n  return (\n    <AlertingPageWrapper\n      navId=\"alert-list\"\n      pageNav={{\n        text: t('alerting.grafana-modify-export-page.text.modify-export', 'Modify export'),\n        subTitle:\n          'Modify the current alert rule and export the rule definition in the format of your choice. Any changes you make will not be saved.',\n      }}\n    >\n      <GrafanaModifyExport />\n    </AlertingPageWrapper>\n  );\n}\n\nexport default withPageErrorBoundary(GrafanaModifyExportPage);\n","import { Controller, useFormContext } from 'react-hook-form';\n\nimport { DataSourceInstanceSettings } from '@grafana/data';\nimport { selectors } from '@grafana/e2e-selectors';\nimport { Trans, t } from '@grafana/i18n';\nimport { Field, Input, Stack, Text } from '@grafana/ui';\nimport { DataSourcePicker } from 'app/features/datasources/components/picker/DataSourcePicker';\n\nimport { RuleFormType, RuleFormValues } from '../../types/rule-form';\nimport { isValidRecordingRulesTarget } from '../../utils/datasource';\nimport { isCloudRecordingRuleByType, isGrafanaRecordingRuleByType, isRecordingRuleByType } from '../../utils/rules';\n\nimport { RuleEditorSection } from './RuleEditorSection';\n\nconst recordingRuleNameValidationPattern = (type: RuleFormType) => ({\n  message: isGrafanaRecordingRuleByType(type)\n    ? 'Recording rule metric must be valid metric name. It may only contain letters, numbers, and colons. It may not contain whitespace.'\n    : 'Recording rule name must be valid metric name. It may only contain letters, numbers, and colons. It may not contain whitespace.',\n  value: /^[a-zA-Z_:][a-zA-Z0-9_:]*$/,\n});\n\n/**\n *  This component renders the input for the alert rule name.\n *  In case of recording rule, it also renders the input for the recording rule metric, and it validates this value.\n */\nexport const AlertRuleNameAndMetric = () => {\n  const {\n    control,\n    register,\n    watch,\n    formState: { errors },\n    setValue,\n  } = useFormContext<RuleFormValues>();\n\n  const ruleFormType = watch('type');\n  if (!ruleFormType) {\n    return null;\n  }\n  const isRecording = isRecordingRuleByType(ruleFormType);\n  const isGrafanaRecordingRule = isGrafanaRecordingRuleByType(ruleFormType);\n  const isCloudRecordingRule = isCloudRecordingRuleByType(ruleFormType);\n  const recordingLabel = isGrafanaRecordingRule ? 'recording rule and metric' : 'recording rule';\n  const namePlaceholder = isRecording ? 'recording rule' : 'alert rule';\n  const entityName = isRecording ? recordingLabel : 'alert rule';\n  return (\n    <RuleEditorSection\n      stepNo={1}\n      title={t('alerting.alert-rule-name-and-metric.title-section', 'Enter {{entityName}} name', { entityName })}\n      description={\n        <Text variant=\"bodySmall\" color=\"secondary\">\n          <Trans i18nKey=\"alerting.alert-rule-name-and-metric.description-section\">\n            Enter a name to identify your {{ entityName }}.\n          </Trans>\n        </Text>\n      }\n    >\n      <Stack direction=\"column\">\n        <Field\n          label={t('alerting.alert-rule-name-and-metric.label-name', 'Name')}\n          error={errors?.name?.message}\n          invalid={!!errors.name?.message}\n        >\n          <Input\n            data-testid={selectors.components.AlertRules.ruleNameField}\n            id=\"name\"\n            width={38}\n            {...register('name', {\n              required: {\n                value: true,\n                message: t('alerting.alert-rule-name-and-metric.message.must-enter-a-name', 'Must enter a name'),\n              },\n              pattern: isCloudRecordingRule\n                ? recordingRuleNameValidationPattern(RuleFormType.cloudRecording)\n                : undefined,\n            })}\n            aria-label={t('alerting.alert-rule-name-and-metric.aria-label-name', 'name')}\n            placeholder={t(\n              'alerting.alert-rule-name-and-metric.placeholder-name',\n              'Give your {{namePlaceholder}} a name',\n              { namePlaceholder }\n            )}\n          />\n        </Field>\n        {isGrafanaRecordingRule && (\n          <Field\n            label={t('alerting.alert-rule-name-and-metric.label-metric', 'Metric')}\n            error={errors?.metric?.message}\n            invalid={!!errors.metric?.message}\n          >\n            <Input\n              id=\"metric\"\n              width={38}\n              {...register('metric', {\n                required: {\n                  value: true,\n                  message: t(\n                    'alerting.alert-rule-name-and-metric.message.must-enter-a-metric-name',\n                    'Must enter a metric name'\n                  ),\n                },\n                pattern: recordingRuleNameValidationPattern(RuleFormType.grafanaRecording),\n              })}\n              aria-label={t('alerting.alert-rule-name-and-metric.metric-aria-label-metric', 'metric')}\n              placeholder={t(\n                'alerting.alert-rule-name-and-metric.metric-placeholder-recorded-metric',\n                'Give the name of the new recorded metric'\n              )}\n            />\n          </Field>\n        )}\n\n        {isGrafanaRecordingRule && (\n          <Field\n            id=\"target-data-source\"\n            data-testid=\"target-data-source\"\n            label={t('alerting.recording-rules.label-target-data-source', 'Target data source')}\n            description={t(\n              'alerting.recording-rules.description-target-data-source',\n              'The Prometheus data source to store recording rules in'\n            )}\n            error={errors.targetDatasourceUid?.message}\n            invalid={!!errors.targetDatasourceUid?.message}\n          >\n            <Controller\n              render={({ field: { onChange, ref, ...field } }) => (\n                <DataSourcePicker\n                  {...field}\n                  current={field.value}\n                  noDefault\n                  // Filter with `filter` prop instead of `type` prop to avoid showing the `-- Grafana --` data source\n                  filter={isValidRecordingRulesTarget}\n                  onChange={(ds: DataSourceInstanceSettings) => {\n                    setValue('targetDatasourceUid', ds.uid);\n                  }}\n                />\n              )}\n              name=\"targetDatasourceUid\"\n              control={control}\n              rules={{\n                required: {\n                  value: true,\n                  message: t(\n                    'alerting.alert-rule-name-and-metric.message.please-select-a-data-source',\n                    'Please select a data source'\n                  ),\n                },\n              }}\n            />\n          </Field>\n        )}\n      </Stack>\n    </RuleEditorSection>\n  );\n};\n","import { useCallback } from 'react';\n\nimport { DataSourceInstanceSettings } from '@grafana/data';\nimport { DataSourcePicker, DataSourcePickerProps } from 'app/features/datasources/components/picker/DataSourcePicker';\n\nimport { useRulesSourcesWithRuler } from '../../hooks/useRuleSourcesWithRuler';\n\ninterface Props extends DataSourcePickerProps {\n  disabled?: boolean;\n  onChange: (ds: DataSourceInstanceSettings) => void;\n  value: string | null;\n  onBlur?: () => void;\n  name?: string;\n}\n\nexport function CloudRulesSourcePicker({ value, disabled, ...props }: Props): JSX.Element {\n  const { rulesSourcesWithRuler: dataSourcesWithRuler, isLoading } = useRulesSourcesWithRuler();\n\n  const dataSourceFilter = useCallback(\n    (ds: DataSourceInstanceSettings): boolean => {\n      return dataSourcesWithRuler.some(({ uid }) => uid === ds.uid);\n    },\n    [dataSourcesWithRuler]\n  );\n\n  return (\n    <DataSourcePicker\n      disabled={isLoading || disabled}\n      noDefault\n      alerting\n      filter={dataSourceFilter}\n      current={value}\n      {...props}\n    />\n  );\n}\n","import { useCallback } from 'react';\nimport { Controller, useFormContext } from 'react-hook-form';\n\nimport { Trans, t } from '@grafana/i18n';\nimport { Field, Label, Stack } from '@grafana/ui';\nimport { NestedFolderPicker } from 'app/core/components/NestedFolderPicker/NestedFolderPicker';\n\nimport { Folder, RuleFormValues } from '../../types/rule-form';\nimport { CreateNewFolder } from '../create-folder/CreateNewFolder';\n\nexport function FolderSelector() {\n  const {\n    formState: { errors },\n    setValue,\n    watch,\n  } = useFormContext<RuleFormValues>();\n\n  const resetGroup = useCallback(() => {\n    setValue('group', '');\n  }, [setValue]);\n\n  const folder = watch('folder');\n\n  const handleFolderCreation = (folder: Folder) => {\n    resetGroup();\n    setValue('folder', folder);\n  };\n\n  return (\n    <Stack alignItems=\"center\">\n      {\n        <Field\n          label={\n            <Label\n              htmlFor=\"folder\"\n              description={t(\n                'alerting.folder-selector.description-select-folder',\n                'Select a folder to store your rule in.'\n              )}\n            >\n              <Trans i18nKey=\"alerting.rule-form.folder.label\">Folder</Trans>\n            </Label>\n          }\n          error={errors.folder?.message}\n          data-testid=\"folder-picker\"\n        >\n          <Stack direction=\"row\" alignItems=\"center\">\n            <Controller\n              render={({ field: { ref, ...field } }) => (\n                <div style={{ width: 420 }}>\n                  <NestedFolderPicker\n                    permission=\"view\"\n                    showRootFolder={false}\n                    invalid={!!errors.folder?.message}\n                    {...field}\n                    value={folder?.uid}\n                    onChange={(uid, title) => {\n                      if (uid && title) {\n                        setValue('folder', { title, uid });\n                      } else {\n                        setValue('folder', undefined);\n                      }\n\n                      resetGroup();\n                    }}\n                  />\n                </div>\n              )}\n              name=\"folder\"\n              rules={{\n                required: {\n                  value: true,\n                  message: t('alerting.folder-selector.message.select-a-folder', 'Select a folder'),\n                },\n              }}\n            />\n            <CreateNewFolder onCreate={handleFolderCreation} />\n          </Stack>\n        </Field>\n      }\n    </Stack>\n  );\n}\n","import { useState } from 'react';\nimport { useFormContext } from 'react-hook-form';\n\nimport { Trans, t } from '@grafana/i18n';\nimport { Stack, Text } from '@grafana/ui';\n\nimport { KBObjectArray, RuleFormValues } from '../../types/rule-form';\nimport { GRAFANA_RULES_SOURCE_NAME } from '../../utils/datasource';\n\nimport { FolderSelector } from './FolderSelector';\nimport { NeedHelpInfo } from './NeedHelpInfo';\nimport { RuleEditorSection } from './RuleEditorSection';\nimport { LabelsEditorModal } from './labels/LabelsEditorModal';\nimport { LabelsFieldInForm } from './labels/LabelsFieldInForm';\n\n/** Precondition: rule is Grafana managed.\n */\nexport function GrafanaFolderAndLabelsStep() {\n  const { setValue, getValues } = useFormContext<RuleFormValues>();\n  const [showLabelsEditor, setShowLabelsEditor] = useState(false);\n\n  function onCloseLabelsEditor(labelsToUpdate?: KBObjectArray) {\n    if (labelsToUpdate) {\n      setValue('labels', labelsToUpdate);\n    }\n    setShowLabelsEditor(false);\n  }\n\n  function SectionDescription() {\n    return (\n      <Stack direction=\"row\" gap={0.5} alignItems=\"center\">\n        <Text variant=\"bodySmall\" color=\"secondary\">\n          <Trans i18nKey=\"alerting.rule-form.folder-and-labels\">\n            Organize your alert rule with a folder and set of labels.\n          </Trans>\n        </Text>\n        <NeedHelpInfo\n          contentText={\n            <>\n              <p>\n                {t(\n                  'alerting.rule-form.folders.help-info',\n                  'Folders are used for storing alert rules. You can extend the access provided by a role to alert rules and assign permissions to individual folders.'\n                )}\n              </p>\n              <p>\n                {t(\n                  'alerting.rule-form.labels.help-info',\n                  'Labels are used to differentiate an alert from all other alerts.You can use them for searching, silencing, and routing notifications.'\n                )}\n              </p>\n            </>\n          }\n        />\n      </Stack>\n    );\n  }\n\n  return (\n    <RuleEditorSection\n      stepNo={3}\n      title={t('alerting.grafana-folder-and-labels-step.title-add-folder-and-labels', 'Add folder and labels')}\n      description={<SectionDescription />}\n    >\n      <Stack direction=\"column\" justify-content=\"flex-start\" align-items=\"flex-start\">\n        <FolderSelector />\n        <LabelsFieldInForm onEditClick={() => setShowLabelsEditor(true)} />\n        <LabelsEditorModal\n          isOpen={showLabelsEditor}\n          onClose={onCloseLabelsEditor}\n          dataSourceName={GRAFANA_RULES_SOURCE_NAME}\n          initialLabels={getValues('labels')}\n        />\n      </Stack>\n    </RuleEditorSection>\n  );\n}\n","import { QueryStatus } from '@reduxjs/toolkit/query';\nimport { isEmpty } from 'lodash';\nimport { useEffect } from 'react';\nimport { Controller, useFormContext } from 'react-hook-form';\n\nimport { ContactPointSelector as GrafanaManagedContactPointSelector, alertingAPI } from '@grafana/alerting/unstable';\nimport { Trans, t } from '@grafana/i18n';\nimport { Field, FieldValidationMessage, Stack, TextLink } from '@grafana/ui';\nimport { RuleFormValues } from 'app/features/alerting/unified/types/rule-form';\nimport { createRelativeUrl } from 'app/features/alerting/unified/utils/url';\n\nexport interface ContactPointSelectorProps {\n  alertManager: string;\n}\n\nexport function ContactPointSelector({ alertManager }: ContactPointSelectorProps) {\n  const { control, watch, trigger } = useFormContext<RuleFormValues>();\n\n  const selectedContactPointField = `contactPoints.${alertManager}.selectedContactPoint` as const;\n  const contactPointInForm = watch(selectedContactPointField);\n\n  // check if the contact point still exists, we'll use listReceiver to check if the contact point exists because getReceiver doesn't work with\n  // contact point titles but with UUIDs (which is not what we store on the alert rule definition)\n  const { currentData, status } = alertingAPI.endpoints.listReceiver.useQuery({\n    fieldSelector: `spec.title=${contactPointInForm}`,\n  });\n\n  const contactPointNotFound = contactPointInForm && status === QueryStatus.fulfilled && isEmpty(currentData?.items);\n\n  // validate the contact point and check if it still exists when we've gotten a response from the API\n  useEffect(() => {\n    if (contactPointInForm && status === QueryStatus.fulfilled) {\n      trigger(selectedContactPointField, { shouldFocus: true });\n    }\n  }, [contactPointInForm, selectedContactPointField, status, trigger]);\n\n  return (\n    <Stack direction=\"row\" alignItems=\"center\">\n      <Field\n        label={t('alerting.contact-point-selector.contact-point-picker-label-contact-point', 'Contact point')}\n        data-testid=\"contact-point-picker\"\n      >\n        <Controller\n          name={selectedContactPointField}\n          render={({ field: { onChange }, fieldState: { error } }) => (\n            <>\n              <Stack>\n                <GrafanaManagedContactPointSelector\n                  isClearable={false}\n                  onChange={(contactPoint) => onChange(contactPoint.spec.title)}\n                  width={50}\n                  value={contactPointInForm}\n                />\n                <LinkToContactPoints />\n              </Stack>\n\n              {/* Error can come from the required validation we have in here, or from the manual setError we do in the parent component.\n              The only way I found to check the custom error is to check if the field has a value and if it's not in the options. */}\n\n              {error && <FieldValidationMessage>{error?.message}</FieldValidationMessage>}\n            </>\n          )}\n          rules={{\n            validate: () => {\n              if (contactPointNotFound) {\n                return t(\n                  'alerting.contactPoints.validation.notFound',\n                  `Contact point \"{{contactPoint}}\" could not be found`,\n                  {\n                    contactPoint: contactPointInForm,\n                  }\n                );\n              }\n              return true;\n            },\n            required: {\n              value: true,\n              message: t(\n                'alerting.contact-point-selector.message.contact-point-is-required',\n                'Contact point is required.'\n              ),\n            },\n          }}\n          control={control}\n        />\n      </Field>\n    </Stack>\n  );\n}\nfunction LinkToContactPoints() {\n  const hrefToContactPoints = '/alerting/notifications';\n  return (\n    <TextLink\n      external\n      href={createRelativeUrl(hrefToContactPoints)}\n      aria-label={t(\n        'alerting.link-to-contact-points.aria-label-view-or-create-contact-points',\n        'View or create contact points'\n      )}\n    >\n      <Trans i18nKey=\"alerting.link-to-contact-points.view-or-create-contact-points\">\n        View or create contact points\n      </Trans>\n    </TextLink>\n  );\n}\n","import { css } from '@emotion/css';\nimport { Controller, useFormContext } from 'react-hook-form';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { t } from '@grafana/i18n';\nimport { Field, useStyles2 } from '@grafana/ui';\nimport MuteTimingsSelector from 'app/features/alerting/unified/components/alertmanager-entities/MuteTimingsSelector';\nimport { BaseAlertmanagerArgs } from 'app/features/alerting/unified/types/hooks';\nimport { RuleFormValues } from 'app/features/alerting/unified/types/rule-form';\nimport { mapMultiSelectValueToStrings } from 'app/features/alerting/unified/utils/amroutes';\n\n/** Provides a form field for use in simplified routing, for selecting appropriate mute timings */\nexport function ActiveTimingFields({ alertmanager }: BaseAlertmanagerArgs) {\n  const styles = useStyles2(getStyles);\n  const {\n    control,\n    formState: { errors },\n  } = useFormContext<RuleFormValues>();\n\n  return (\n    <Field\n      label={t('alerting.active-timing-fields.am-active-timing-select-label-active-timings', 'Active timings')}\n      data-testid=\"am-active-timing-select\"\n      description={t(\n        'alerting.mute-timing-fields.am-active-timing-select-description-active-timings',\n        'Select a time interval to define when to only send notifications for this alert rule'\n      )}\n      className={styles.muteTimingField}\n      invalid={!!errors.contactPoints?.[alertmanager]?.activeTimeIntervals}\n    >\n      <Controller\n        render={({ field: { onChange, ref, ...field } }) => (\n          <MuteTimingsSelector\n            alertmanager={alertmanager}\n            selectProps={{\n              ...field,\n              onChange: (value) => onChange(mapMultiSelectValueToStrings(value)),\n            }}\n          />\n        )}\n        control={control}\n        name={`contactPoints.${alertmanager}.activeTimeIntervals`}\n      />\n    </Field>\n  );\n}\nconst getStyles = (theme: GrafanaTheme2) => ({\n  muteTimingField: css({\n    marginTop: theme.spacing(1),\n  }),\n});\n","import { css } from '@emotion/css';\nimport { Controller, useFormContext } from 'react-hook-form';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { t } from '@grafana/i18n';\nimport { Field, useStyles2 } from '@grafana/ui';\nimport MuteTimingsSelector from 'app/features/alerting/unified/components/alertmanager-entities/MuteTimingsSelector';\nimport { BaseAlertmanagerArgs } from 'app/features/alerting/unified/types/hooks';\nimport { RuleFormValues } from 'app/features/alerting/unified/types/rule-form';\nimport { mapMultiSelectValueToStrings } from 'app/features/alerting/unified/utils/amroutes';\n\n/** Provides a form field for use in simplified routing, for selecting appropriate mute timings */\nexport function MuteTimingFields({ alertmanager }: BaseAlertmanagerArgs) {\n  const styles = useStyles2(getStyles);\n  const {\n    control,\n    formState: { errors },\n  } = useFormContext<RuleFormValues>();\n\n  return (\n    <Field\n      label={t('alerting.mute-timing-fields.am-mute-timing-select-label-mute-timings', 'Mute timings')}\n      data-testid=\"am-mute-timing-select\"\n      description={t(\n        'alerting.mute-timing-fields.am-mute-timing-select-description-mute-timings',\n        'Select a mute timing to define when not to send notifications for this alert rule'\n      )}\n      className={styles.muteTimingField}\n      invalid={!!errors.contactPoints?.[alertmanager]?.muteTimeIntervals}\n    >\n      <Controller\n        render={({ field: { onChange, ref, ...field } }) => (\n          <MuteTimingsSelector\n            alertmanager={alertmanager}\n            selectProps={{\n              ...field,\n              onChange: (value) => onChange(mapMultiSelectValueToStrings(value)),\n            }}\n          />\n        )}\n        control={control}\n        name={`contactPoints.${alertmanager}.muteTimeIntervals`}\n      />\n    </Field>\n  );\n}\nconst getStyles = (theme: GrafanaTheme2) => ({\n  muteTimingField: css({\n    marginTop: theme.spacing(1),\n  }),\n});\n","import { useFormContext } from 'react-hook-form';\n\nimport { Field, useStyles2 } from '@grafana/ui';\nimport { RuleFormValues } from 'app/features/alerting/unified/types/rule-form';\nimport { promDurationValidator, repeatIntervalValidator } from 'app/features/alerting/unified/utils/amroutes';\n\nimport { PromDurationInput } from '../../../../notification-policies/PromDurationInput';\nimport { getFormStyles } from '../../../../notification-policies/formStyles';\nimport { routeTimingsFields } from '../../../../notification-policies/routeTimingsFields';\nimport { TIMING_OPTIONS_DEFAULTS } from '../../../../notification-policies/timingOptions';\n\ninterface RouteTimingsProps {\n  alertManager: string;\n}\n\nexport function RouteTimings({ alertManager }: RouteTimingsProps) {\n  const formStyles = useStyles2(getFormStyles);\n  const {\n    register,\n    formState: { errors },\n    getValues,\n  } = useFormContext<RuleFormValues>();\n  return (\n    <>\n      <Field\n        label={routeTimingsFields.groupWait.label}\n        description={routeTimingsFields.groupWait.description}\n        invalid={!!errors.contactPoints?.[alertManager]?.groupWaitValue}\n        error={errors.contactPoints?.[alertManager]?.groupWaitValue?.message}\n      >\n        <PromDurationInput\n          {...register(`contactPoints.${alertManager}.groupWaitValue`, { validate: promDurationValidator })}\n          aria-label={routeTimingsFields.groupWait.ariaLabel}\n          className={formStyles.promDurationInput}\n          placeholder={TIMING_OPTIONS_DEFAULTS.group_wait}\n        />\n      </Field>\n      <Field\n        label={routeTimingsFields.groupInterval.label}\n        description={routeTimingsFields.groupInterval.description}\n        invalid={!!errors.contactPoints?.[alertManager]?.groupIntervalValue}\n        error={errors.contactPoints?.[alertManager]?.groupIntervalValue?.message}\n      >\n        <PromDurationInput\n          {...register(`contactPoints.${alertManager}.groupIntervalValue`, {\n            validate: promDurationValidator,\n          })}\n          aria-label={routeTimingsFields.groupInterval.ariaLabel}\n          className={formStyles.promDurationInput}\n          placeholder={TIMING_OPTIONS_DEFAULTS.group_interval}\n        />\n      </Field>\n      <Field\n        label={routeTimingsFields.repeatInterval.label}\n        description={routeTimingsFields.repeatInterval.description}\n        invalid={!!errors.contactPoints?.[alertManager]?.repeatIntervalValue}\n        error={errors.contactPoints?.[alertManager]?.repeatIntervalValue?.message}\n      >\n        <PromDurationInput\n          {...register(`contactPoints.${alertManager}.repeatIntervalValue`, {\n            validate: (value: string) => {\n              const groupInterval = getValues(`contactPoints.${alertManager}.repeatIntervalValue`);\n              return repeatIntervalValidator(value, groupInterval);\n            },\n          })}\n          aria-label={routeTimingsFields.repeatInterval.ariaLabel}\n          className={formStyles.promDurationInput}\n          placeholder={TIMING_OPTIONS_DEFAULTS.repeat_interval}\n        />\n      </Field>\n    </>\n  );\n}\n","import { css } from '@emotion/css';\nimport { useEffect, useState } from 'react';\nimport * as React from 'react';\nimport { Controller, useFormContext } from 'react-hook-form';\n\nimport { GrafanaTheme2, SelectableValue } from '@grafana/data';\nimport { Trans, t } from '@grafana/i18n';\nimport { Field, FieldValidationMessage, InlineField, MultiSelect, Stack, Switch, Text, useStyles2 } from '@grafana/ui';\nimport { MultiValueRemove, MultiValueRemoveProps } from '@grafana/ui/internal';\nimport { RuleFormValues } from 'app/features/alerting/unified/types/rule-form';\nimport {\n  commonGroupByOptions,\n  mapMultiSelectValueToStrings,\n  stringToSelectableValue,\n  stringsToSelectableValues,\n} from 'app/features/alerting/unified/utils/amroutes';\n\nimport { getFormStyles } from '../../../../notification-policies/formStyles';\nimport { TIMING_OPTIONS_DEFAULTS } from '../../../../notification-policies/timingOptions';\n\nimport { RouteTimings } from './RouteTimings';\n\nconst REQUIRED_FIELDS_IN_GROUPBY = ['grafana_folder', 'alertname'];\n\nconst DEFAULTS_TIMINGS = {\n  groupWaitValue: TIMING_OPTIONS_DEFAULTS.group_wait,\n  groupIntervalValue: TIMING_OPTIONS_DEFAULTS.group_interval,\n  repeatIntervalValue: TIMING_OPTIONS_DEFAULTS.repeat_interval,\n};\nconst DISABLE_GROUPING = '...';\n\nexport interface RoutingSettingsProps {\n  alertManager: string;\n}\nexport const RoutingSettings = ({ alertManager }: RoutingSettingsProps) => {\n  const formStyles = useStyles2(getFormStyles);\n  const {\n    control,\n    watch,\n    register,\n    setValue,\n    formState: { errors },\n  } = useFormContext<RuleFormValues>();\n  const [groupByOptions, setGroupByOptions] = useState(stringsToSelectableValues([]));\n  const { groupIntervalValue, groupWaitValue, repeatIntervalValue } = DEFAULTS_TIMINGS;\n  const overrideGrouping = watch(`contactPoints.${alertManager}.overrideGrouping`);\n  const overrideTimings = watch(`contactPoints.${alertManager}.overrideTimings`);\n  const groupByCount = watch(`contactPoints.${alertManager}.groupBy`)?.length ?? 0;\n\n  const styles = useStyles2(getStyles);\n  useEffect(() => {\n    if (overrideGrouping && groupByCount === 0) {\n      setValue(`contactPoints.${alertManager}.groupBy`, REQUIRED_FIELDS_IN_GROUPBY);\n    }\n  }, [overrideGrouping, setValue, alertManager, groupByCount]);\n\n  const separator = <span>, </span>;\n\n  return (\n    <Stack direction=\"column\">\n      <Stack direction=\"row\" gap={1} alignItems=\"center\" justifyContent=\"space-between\">\n        <InlineField\n          label={t('alerting.routing-settings.label-override-grouping', 'Override grouping')}\n          transparent={true}\n          className={styles.switchElement}\n        >\n          <Switch id=\"override-grouping-toggle\" {...register(`contactPoints.${alertManager}.overrideGrouping`)} />\n        </InlineField>\n        {!overrideGrouping && (\n          <Text variant=\"body\" color=\"secondary\">\n            <Trans\n              i18nKey=\"alerting.routing-settings.grouping\"\n              values={{ fields: REQUIRED_FIELDS_IN_GROUPBY.join(', ') }}\n            >\n              Grouping: <strong>{'{{fields}}'}</strong>\n            </Trans>\n          </Text>\n        )}\n      </Stack>\n      {overrideGrouping && (\n        <Field\n          label={t('alerting.routing-settings.label-group-by', 'Group by')}\n          description={t(\n            'alerting.routing-settings.description-group-by',\n            'Combine multiple alerts into a single notification by grouping them by the same label values. If empty, it is inherited from the default notification policy.'\n          )}\n          {...register(`contactPoints.${alertManager}.groupBy`)}\n          invalid={!!errors.contactPoints?.[alertManager]?.groupBy}\n          className={styles.optionalContent}\n        >\n          <Controller\n            rules={{\n              validate: (value: string[]) => {\n                if (!value || value.length === 0) {\n                  return 'At least one group by option is required.';\n                }\n                if (value.length === 1 && value[0] === DISABLE_GROUPING) {\n                  return true;\n                }\n                // we need to make sure that the required fields are included\n                const requiredFieldsIncluded = REQUIRED_FIELDS_IN_GROUPBY.every((field) => value.includes(field));\n                if (!requiredFieldsIncluded) {\n                  return `Group by must include ${REQUIRED_FIELDS_IN_GROUPBY.join(', ')}`;\n                }\n                return true;\n              },\n            }}\n            render={({ field: { onChange, ref, ...field }, fieldState: { error } }) => (\n              <>\n                <MultiSelect\n                  aria-label={t('alerting.routing-settings.aria-label-group-by', 'Group by')}\n                  {...field}\n                  allowCustomValue\n                  className={formStyles.input}\n                  onCreateOption={(opt: string) => {\n                    setGroupByOptions((opts) => [...opts, stringToSelectableValue(opt)]);\n\n                    // @ts-ignore-check: react-hook-form made me do this\n                    setValue(`contactPoints.${alertManager}.groupBy`, [...field.value, opt]);\n                  }}\n                  onChange={(value) => {\n                    return onChange(mapMultiSelectValueToStrings(value));\n                  }}\n                  options={[...commonGroupByOptions, ...groupByOptions]}\n                  components={{\n                    MultiValueRemove(\n                      props: React.PropsWithChildren<\n                        MultiValueRemoveProps &\n                          Array<SelectableValue<string>> & {\n                            data: {\n                              label: string;\n                              value: string;\n                              isFixed: boolean;\n                            };\n                          }\n                      >\n                    ) {\n                      const { data } = props;\n                      if (data.isFixed) {\n                        return null;\n                      }\n                      return MultiValueRemove(props);\n                    },\n                  }}\n                />\n                {error && <FieldValidationMessage>{error.message}</FieldValidationMessage>}\n              </>\n            )}\n            name={`contactPoints.${alertManager}.groupBy`}\n            control={control}\n          />\n        </Field>\n      )}\n      <Stack direction=\"row\" gap={1} alignItems=\"center\" justifyContent=\"space-between\">\n        <InlineField\n          label={t('alerting.routing-settings.label-override-timings', 'Override timings')}\n          transparent={true}\n          className={styles.switchElement}\n        >\n          <Switch id=\"override-timings-toggle\" {...register(`contactPoints.${alertManager}.overrideTimings`)} />\n        </InlineField>\n        {!overrideTimings && (\n          <Text variant=\"body\" color=\"secondary\">\n            <Trans i18nKey=\"alerting.routing-settings.group-wait\" values={{ groupWaitValue }}>\n              Group wait: <strong>{'{{groupWaitValue}}'}</strong>\n            </Trans>\n            {separator}\n            <Trans i18nKey=\"alerting.routing-settings.group-interval\" values={{ groupIntervalValue }}>\n              Group interval: <strong>{'{{groupIntervalValue}}'}</strong>\n            </Trans>\n            {separator}\n            <Trans i18nKey=\"alerting.routing-settings.repeat-interval\" values={{ repeatIntervalValue }}>\n              Repeat interval: <strong>{'{{repeatIntervalValue}}'}</strong>\n            </Trans>\n          </Text>\n        )}\n      </Stack>\n      {overrideTimings && (\n        <div className={styles.optionalContent}>\n          <RouteTimings alertManager={alertManager} />\n        </div>\n      )}\n    </Stack>\n  );\n};\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  switchElement: css({\n    flexFlow: 'row-reverse',\n    gap: theme.spacing(1),\n    alignItems: 'center',\n  }),\n  optionalContent: css({\n    marginLeft: '49px',\n    marginBottom: theme.spacing(1),\n  }),\n});\n","import { css } from '@emotion/css';\nimport { useFormContext } from 'react-hook-form';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { Trans, t } from '@grafana/i18n';\nimport { CollapsableSection, Stack, Text, useStyles2 } from '@grafana/ui';\nimport { RuleFormValues } from 'app/features/alerting/unified/types/rule-form';\nimport { AlertManagerDataSource } from 'app/features/alerting/unified/utils/datasource';\n\nimport { NeedHelpInfo } from '../../NeedHelpInfo';\n\nimport { ContactPointSelector } from './contactPoint/ContactPointSelector';\nimport { ActiveTimingFields } from './route-settings/ActiveTimingFields';\nimport { MuteTimingFields } from './route-settings/MuteTimingFields';\nimport { RoutingSettings } from './route-settings/RouteSettings';\n\ninterface AlertManagerManualRoutingProps {\n  alertManager: AlertManagerDataSource;\n}\n\nexport function AlertManagerManualRouting({ alertManager }: AlertManagerManualRoutingProps) {\n  const styles = useStyles2(getStyles);\n\n  const alertManagerName = alertManager.name;\n\n  const { watch } = useFormContext<RuleFormValues>();\n\n  const hasRouteSettings =\n    watch(`contactPoints.${alertManagerName}.overrideGrouping`) ||\n    watch(`contactPoints.${alertManagerName}.overrideTimings`) ||\n    watch(`contactPoints.${alertManagerName}.muteTimeIntervals`)?.length > 0;\n\n  return (\n    <Stack direction=\"column\">\n      <Stack direction=\"row\" alignItems=\"center\">\n        <div className={styles.firstAlertManagerLine} />\n        <div className={styles.alertManagerName}>\n          <Trans i18nKey=\"alerting.rule-form.simple-routing.alertmanager-label\">Alertmanager:</Trans>\n          <img src={alertManager.imgUrl} alt=\"Alert manager logo\" className={styles.img} />\n          {alertManagerName}\n        </div>\n        <div className={styles.secondAlertManagerLine} />\n      </Stack>\n      <Stack direction=\"row\" gap={1} alignItems=\"center\">\n        <ContactPointSelector alertManager={alertManagerName} />\n      </Stack>\n      {/* @TODO\n        we can show the contact point details here when it's selected but we currently don't have a\n        way to summarize the details from the ContactPoint type in @grafana/alerting\n      */}\n      <div className={styles.routingSection}>\n        <CollapsableSection\n          label={t(\n            'alerting.alert-manager-manual-routing.label-muting-grouping-and-timings-optional',\n            'Muting, grouping and timings (optional)'\n          )}\n          isOpen={hasRouteSettings}\n          className={styles.collapsableSection}\n          contentClassName={styles.collapsableSectionContent}\n        >\n          <Stack direction=\"column\" gap={1}>\n            <Stack direction=\"row\" gap={0.5} alignItems=\"center\">\n              <Text variant=\"bodySmall\" color=\"secondary\">\n                <Trans i18nKey=\"alerting.rule-form.simple-routing.optional-settings.description\">\n                  Configure how notifications for this alert rule are sent.\n                </Trans>\n              </Text>\n              <NeedHelpInfo\n                title={t(\n                  'alerting.alert-manager-manual-routing.title-muting-grouping-and-timings',\n                  'Muting, grouping, and timings'\n                )}\n                linkText={'Read about notification grouping'}\n                externalLink={\n                  'https://grafana.com/docs/grafana/latest/alerting/fundamentals/notifications/group-alert-notifications/'\n                }\n                contentText={\n                  <>\n                    <p>\n                      {t(\n                        'alerting.rule-form.simple-routing.optional-settings.help-info1',\n                        'Mute timings allows you to temporarily pause notifications for a specific recurring period, such as a regular maintenance window or weekends.'\n                      )}\n                    </p>\n                    {t(\n                      'alerting.rule-form.simple-routing.optional-settings.help-info2',\n                      'Grouping and timing options combine multiple alerts within a specific period into a single notification, allowing you to customize default options.'\n                    )}\n                  </>\n                }\n              />\n            </Stack>\n            <MuteTimingFields alertmanager={alertManagerName} />\n            <ActiveTimingFields alertmanager={alertManagerName} />\n            <RoutingSettings alertManager={alertManagerName} />\n          </Stack>\n        </CollapsableSection>\n      </div>\n    </Stack>\n  );\n}\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  firstAlertManagerLine: css({\n    height: 1,\n    width: theme.spacing(4),\n    backgroundColor: theme.colors.secondary.main,\n  }),\n  alertManagerName: css({\n    with: 'fit-content',\n  }),\n  secondAlertManagerLine: css({\n    height: '1px',\n    width: '100%',\n    flex: 1,\n    backgroundColor: theme.colors.secondary.main,\n  }),\n  img: css({\n    marginLeft: theme.spacing(2),\n    width: theme.spacing(3),\n    height: theme.spacing(3),\n    marginRight: theme.spacing(1),\n  }),\n  collapsableSection: css({\n    width: 'fit-content',\n    fontSize: theme.typography.body.fontSize,\n  }),\n  collapsableSectionContent: css({\n    padding: '0',\n  }),\n  routingSection: css({\n    display: 'flex',\n    flexDirection: 'column',\n    maxWidth: theme.breakpoints.values.xl,\n    border: `solid 1px ${theme.colors.border.weak}`,\n    borderRadius: theme.shape.radius.default,\n    padding: `${theme.spacing(1)} ${theme.spacing(2)}`,\n    marginTop: theme.spacing(2),\n  }),\n});\n","import { useMemo } from 'react';\nimport { useFormContext } from 'react-hook-form';\n\nimport { AlertmanagerProvider } from 'app/features/alerting/unified/state/AlertmanagerContext';\nimport { RuleFormValues } from 'app/features/alerting/unified/types/rule-form';\nimport { getAlertManagerDataSourcesByPermission } from 'app/features/alerting/unified/utils/datasource';\n\nimport { AlertManagerManualRouting } from './AlertManagerRouting';\n\nexport function SimplifiedRouting() {\n  const { getValues } = useFormContext<RuleFormValues>();\n  const contactPointsInAlert = getValues('contactPoints');\n\n  const allAlertManagersByPermission = getAlertManagerDataSourcesByPermission('notification');\n\n  // We decided to only show internal alert manager for now. Once we want to show external alert managers we can use this code\n  // const alertManagersDataSources = allAlertManagersByPermission.availableInternalDataSources.concat(\n  //   allAlertManagersByPermission.availableExternalDataSources\n  // );\n\n  const alertManagersDataSources = allAlertManagersByPermission.availableInternalDataSources;\n\n  const alertManagersDataSourcesWithConfigAPI = alertManagersDataSources.filter((am) => am.hasConfigurationAPI);\n\n  // we merge the selected contact points data for each alert manager, with the alert manager meta data\n  const alertManagersWithSelectedContactPoints = useMemo(\n    () =>\n      alertManagersDataSourcesWithConfigAPI.map((am) => {\n        const selectedContactPoint = contactPointsInAlert ? contactPointsInAlert[am.name] : undefined;\n        return {\n          alertManager: am,\n          selectedContactPoint: selectedContactPoint?.selectedContactPoint ?? '',\n          routeSettings: {\n            muteTimeIntervals: selectedContactPoint?.muteTimeIntervals ?? [],\n            activeTimeIntervals: selectedContactPoint?.activeTimeIntervals ?? [],\n            overrideGrouping: selectedContactPoint?.overrideGrouping ?? false,\n            groupBy: selectedContactPoint?.groupBy ?? [],\n            overrideTimings: selectedContactPoint?.overrideTimings ?? false,\n            groupWaitValue: selectedContactPoint?.groupWaitValue ?? '',\n            groupIntervalValue: selectedContactPoint?.groupIntervalValue ?? '',\n            repeatIntervalValue: selectedContactPoint?.repeatIntervalValue ?? '',\n          },\n        };\n      }),\n    [alertManagersDataSourcesWithConfigAPI, contactPointsInAlert]\n  );\n\n  return alertManagersWithSelectedContactPoints.map((alertManagerContactPoint, index) => {\n    return (\n      <AlertmanagerProvider\n        accessType={'notification'}\n        alertmanagerSourceName={alertManagerContactPoint.alertManager.name}\n        key={alertManagerContactPoint.alertManager.name + index}\n      >\n        <AlertManagerManualRouting alertManager={alertManagerContactPoint.alertManager} />\n      </AlertmanagerProvider>\n    );\n  });\n}\n","import { compact } from 'lodash';\nimport { Suspense, lazy } from 'react';\n\nimport { Trans, t } from '@grafana/i18n';\nimport { Button, LoadingPlaceholder, Stack, Text } from '@grafana/ui';\nimport { alertRuleApi } from 'app/features/alerting/unified/api/alertRuleApi';\nimport { AlertQuery } from 'app/types/unified-alerting-dto';\n\nimport { Folder, KBObjectArray } from '../../../types/rule-form';\nimport { useGetAlertManagerDataSourcesByPermissionAndConfig } from '../../../utils/datasource';\n\nconst NotificationPreviewByAlertManager = lazy(() => import('./NotificationPreviewByAlertManager'));\n\ninterface NotificationPreviewProps {\n  customLabels: KBObjectArray;\n  alertQueries: AlertQuery[];\n  condition: string | null;\n  folder?: Folder;\n  alertName?: string;\n  alertUid?: string;\n}\n\n// TODO the scroll position keeps resetting when we preview\n// this is to be expected because the list of routes dissapears as we start the request but is very annoying\nexport const NotificationPreview = ({\n  alertQueries,\n  customLabels,\n  condition,\n  folder,\n  alertName,\n  alertUid,\n}: NotificationPreviewProps) => {\n  const disabled = !condition || !folder;\n\n  const previewEndpoint = alertRuleApi.endpoints.preview;\n\n  const [trigger, { data = [], isLoading, isUninitialized: previewUninitialized }] = previewEndpoint.useMutation();\n\n  // potential instances are the instances that are going to be routed to the notification policies\n  // convert data to list of labels: are the representation of the potential instances\n  const potentialInstances = compact(data.flatMap((label) => label?.labels));\n\n  const onPreview = () => {\n    if (!folder || !condition) {\n      return;\n    }\n\n    // Get the potential labels given the alert queries, the condition and the custom labels (autogenerated labels are calculated on the BE side)\n    trigger({\n      alertQueries: alertQueries,\n      condition: condition,\n      customLabels: customLabels,\n      folder: folder,\n      alertName: alertName,\n      alertUid: alertUid,\n    });\n  };\n\n  //  Get alert managers's data source information\n  const alertManagerDataSources = useGetAlertManagerDataSourcesByPermissionAndConfig('notification');\n\n  const onlyOneAM = alertManagerDataSources.length === 1;\n\n  return (\n    <Stack direction=\"column\">\n      <Stack direction=\"row\" alignItems=\"flex-start\" justifyContent=\"space-between\">\n        <Stack direction=\"column\" gap={1}>\n          <Text element=\"h5\">\n            <Trans i18nKey=\"alerting.notification-preview.title\">Alert instance routing preview</Trans>\n          </Text>\n          {isLoading && previewUninitialized && (\n            <Text color=\"secondary\" variant=\"bodySmall\">\n              <Trans i18nKey=\"alerting.common.loading\">Loading...</Trans>\n            </Text>\n          )}\n          {previewUninitialized ? (\n            <Text color=\"secondary\" variant=\"bodySmall\">\n              <Trans i18nKey=\"alerting.notification-preview.uninitialized\">\n                When you have your folder selected and your query and labels are configured, click &quot;Preview\n                routing&quot; to see the results here.\n              </Trans>\n            </Text>\n          ) : (\n            <Text color=\"secondary\" variant=\"bodySmall\">\n              <Trans i18nKey=\"alerting.notification-preview.initialized\">\n                Based on the labels added, alert instances are routed to the following notification policies. Expand\n                each notification policy below to view more details.\n              </Trans>\n            </Text>\n          )}\n        </Stack>\n        <Button icon=\"sync\" variant=\"secondary\" type=\"button\" onClick={onPreview} disabled={disabled}>\n          <Trans i18nKey=\"alerting.notification-preview.preview-routing\">Preview routing</Trans>\n        </Button>\n      </Stack>\n      {!isLoading && !previewUninitialized && potentialInstances.length > 0 && (\n        <Suspense\n          fallback={\n            <LoadingPlaceholder text={t('alerting.notification-preview.text-loading-preview', 'Loading preview...')} />\n          }\n        >\n          {alertManagerDataSources.map((alertManagerSource) => (\n            <NotificationPreviewByAlertManager\n              alertManagerSource={alertManagerSource}\n              potentialInstances={potentialInstances}\n              onlyOneAM={onlyOneAM}\n              key={alertManagerSource.name}\n            />\n          ))}\n        </Suspense>\n      )}\n    </Stack>\n  );\n};\n","import { css } from '@emotion/css';\nimport { useState } from 'react';\nimport { useFormContext } from 'react-hook-form';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { Trans, t } from '@grafana/i18n';\nimport { config } from '@grafana/runtime';\nimport { RadioButtonGroup, Stack, Text, TextLink, useStyles2 } from '@grafana/ui';\nimport { AlertmanagerChoice } from 'app/plugins/datasource/alertmanager/types';\n\nimport { alertmanagerApi } from '../../api/alertmanagerApi';\nimport { KBObjectArray, RuleFormType, RuleFormValues } from '../../types/rule-form';\nimport { GRAFANA_RULES_SOURCE_NAME } from '../../utils/datasource';\nimport { isGrafanaManagedRuleByType, isGrafanaRecordingRuleByType, isRecordingRuleByType } from '../../utils/rules';\n\nimport { NeedHelpInfo } from './NeedHelpInfo';\nimport { RuleEditorSection } from './RuleEditorSection';\nimport { SimplifiedRouting } from './alert-rule-form/simplifiedRouting/SimplifiedRouting';\nimport { LabelsEditorModal } from './labels/LabelsEditorModal';\nimport { LabelsFieldInForm } from './labels/LabelsFieldInForm';\nimport { NotificationPreview } from './notificaton-preview/NotificationPreview';\n\ntype NotificationsStepProps = {\n  alertUid?: string;\n};\n\nenum RoutingOptions {\n  NotificationPolicy = 'notification policy',\n  ContactPoint = 'contact point',\n}\n\nfunction useHasInternalAlertmanagerEnabled() {\n  const { useGetGrafanaAlertingConfigurationStatusQuery } = alertmanagerApi;\n  const { currentData: amChoiceStatus } = useGetGrafanaAlertingConfigurationStatusQuery(undefined);\n  return (\n    amChoiceStatus?.alertmanagersChoice === AlertmanagerChoice.Internal ||\n    amChoiceStatus?.alertmanagersChoice === AlertmanagerChoice.All\n  );\n}\n\nexport const NotificationsStep = ({ alertUid }: NotificationsStepProps) => {\n  const { watch, getValues, setValue } = useFormContext<RuleFormValues>();\n  const styles = useStyles2(getStyles);\n\n  const [type, manualRouting] = watch(['type', 'manualRouting']);\n  const [showLabelsEditor, setShowLabelsEditor] = useState(false);\n\n  const dataSourceName = watch('dataSourceName') ?? GRAFANA_RULES_SOURCE_NAME;\n  const isGrafanaManaged = isGrafanaManagedRuleByType(type);\n  const simplifiedModeInNotificationsStepEnabled = config.featureToggles.alertingNotificationsStepMode ?? false;\n  const shouldRenderpreview = type === RuleFormType.grafana;\n  const hasInternalAlertmanagerEnabled = useHasInternalAlertmanagerEnabled();\n\n  const shouldAllowSimplifiedRouting = type === RuleFormType.grafana && hasInternalAlertmanagerEnabled;\n\n  function onCloseLabelsEditor(labelsToUpdate?: KBObjectArray) {\n    if (labelsToUpdate) {\n      setValue('labels', labelsToUpdate);\n    }\n    setShowLabelsEditor(false);\n  }\n\n  if (isGrafanaRecordingRuleByType(type)) {\n    return null;\n  }\n\n  const step = !isGrafanaManaged ? 4 : 5;\n\n  const switchMode =\n    isGrafanaManaged && simplifiedModeInNotificationsStepEnabled\n      ? {\n          isAdvancedMode: !manualRouting,\n          setAdvancedMode: (isAdvanced: boolean) => {\n            setValue('editorSettings.simplifiedNotificationEditor', !isAdvanced);\n            setValue('manualRouting', !isAdvanced);\n          },\n        }\n      : undefined;\n\n  const title = (() => {\n    if (isRecordingRuleByType(type)) {\n      return 'Add labels';\n    }\n    if (isGrafanaManaged) {\n      return 'Configure notifications';\n    }\n    return 'Configure labels and notifications';\n  })();\n\n  return (\n    <RuleEditorSection\n      stepNo={step}\n      title={title}\n      description={\n        <Stack direction=\"row\" gap={0.5} alignItems=\"center\">\n          {isRecordingRuleByType(type) ? (\n            <Text variant=\"bodySmall\" color=\"secondary\">\n              <Trans i18nKey=\"alerting.notifications-step.labels-better-manage-recording-rules\">\n                Add labels to help you better manage your recording rules.\n              </Trans>\n            </Text>\n          ) : (\n            shouldAllowSimplifiedRouting && (\n              <Text variant=\"bodySmall\" color=\"secondary\">\n                <Trans i18nKey=\"alerting.notifications-step.recipient-notification-fires\">\n                  Select who should receive a notification when an alert rule fires.\n                </Trans>\n              </Text>\n            )\n          )}\n        </Stack>\n      }\n      switchMode={switchMode}\n      fullWidth\n    >\n      {!isGrafanaManaged && (\n        <>\n          <LabelsFieldInForm onEditClick={() => setShowLabelsEditor(true)} />\n          <LabelsEditorModal\n            isOpen={showLabelsEditor}\n            onClose={onCloseLabelsEditor}\n            dataSourceName={dataSourceName}\n            initialLabels={getValues('labels')}\n          />\n        </>\n      )}\n      {shouldAllowSimplifiedRouting && (\n        <div className={styles.configureNotifications}>\n          <Text element=\"h5\">\n            <Trans i18nKey=\"alerting.notifications-step.recipient\">Recipient</Trans>\n          </Text>\n        </div>\n      )}\n      {shouldAllowSimplifiedRouting && simplifiedModeInNotificationsStepEnabled && (\n        <ManualAndAutomaticRoutingSimplified alertUid={alertUid} />\n      )}\n      {shouldAllowSimplifiedRouting && !simplifiedModeInNotificationsStepEnabled && (\n        <ManualAndAutomaticRouting alertUid={alertUid} />\n      )}\n      {!shouldAllowSimplifiedRouting && shouldRenderpreview && <AutomaticRooting alertUid={alertUid} />}\n    </RuleEditorSection>\n  );\n};\n\n/**\n * Preconditions:\n * - the alert rule is a grafana rule\n *\n * This component will render the switch between the select contact point routing and the notification policy routing.\n * It also renders the section body of the NotificationsStep, depending on the routing option selected.\n * If select contact point routing is selected, it will render the SimplifiedRouting component.\n * If notification policy routing is selected, it will render the AutomaticRouting component.\n *\n */\nfunction ManualAndAutomaticRouting({ alertUid }: { alertUid?: string }) {\n  const { watch, setValue } = useFormContext<RuleFormValues>();\n  const styles = useStyles2(getStyles);\n\n  const [manualRouting] = watch(['manualRouting']);\n\n  const routingOptions = [\n    {\n      label: t(\n        'alerting.manual-and-automatic-routing.routing-options.label.select-contact-point',\n        'Select contact point'\n      ),\n      value: RoutingOptions.ContactPoint,\n    },\n    {\n      label: t(\n        'alerting.manual-and-automatic-routing.routing-options.label.use-notification-policy',\n        'Use notification policy'\n      ),\n      value: RoutingOptions.NotificationPolicy,\n    },\n  ];\n\n  const onRoutingOptionChange = (option: RoutingOptions) => {\n    setValue('manualRouting', option === RoutingOptions.ContactPoint);\n  };\n\n  return (\n    <Stack direction=\"column\" gap={2}>\n      <Stack direction=\"column\">\n        <RadioButtonGroup\n          data-testid={manualRouting ? 'routing-options-contact-point' : 'routing-options-notification-policy'}\n          options={routingOptions}\n          value={manualRouting ? RoutingOptions.ContactPoint : RoutingOptions.NotificationPolicy}\n          onChange={onRoutingOptionChange}\n          className={styles.routingOptions}\n        />\n      </Stack>\n\n      <RoutingOptionDescription manualRouting={manualRouting} />\n\n      {manualRouting ? <SimplifiedRouting /> : <AutomaticRooting alertUid={alertUid} />}\n    </Stack>\n  );\n}\n\n/**\n * Preconditions:\n * - simple mode for notifications step is enabled\n * - the alert rule is a grafana rule\n *\n * This component will render the switch between the select contact point routing and the notification policy routing.\n * It also renders the section body of the NotificationsStep, depending on the routing option selected.\n * If select contact point routing is selected, it will render the SimplifiedRouting component.\n * If notification policy routing is selected, it will render the AutomaticRouting component.\n *\n */\nfunction ManualAndAutomaticRoutingSimplified({ alertUid }: { alertUid?: string }) {\n  const { watch } = useFormContext<RuleFormValues>();\n\n  const [manualRouting] = watch(['manualRouting']);\n\n  return (\n    <Stack direction=\"column\" gap={2}>\n      <RoutingOptionDescription manualRouting={manualRouting} />\n\n      {manualRouting ? <SimplifiedRouting /> : <AutomaticRooting alertUid={alertUid} />}\n    </Stack>\n  );\n}\n\ninterface AutomaticRootingProps {\n  alertUid?: string;\n}\n\nfunction AutomaticRooting({ alertUid }: AutomaticRootingProps) {\n  const { watch } = useFormContext<RuleFormValues>();\n  const [labels, queries, condition, folder, alertName] = watch([\n    'labels',\n    'queries',\n    'condition',\n    'folder',\n    'name',\n    'manualRouting',\n  ]);\n  return (\n    <NotificationPreview\n      alertQueries={queries}\n      customLabels={labels}\n      condition={condition}\n      folder={folder}\n      alertName={alertName}\n      alertUid={alertUid}\n    />\n  );\n}\n\n// Auxiliar components to build the texts and descriptions in the NotificationsStep\nfunction NeedHelpInfoForNotificationPolicy() {\n  return (\n    <NeedHelpInfo\n      contentText={\n        <Stack gap={1} direction=\"column\">\n          <Stack direction=\"column\" gap={0}>\n            <Trans i18nKey=\"alerting.need-help-info-for-notification-policy.notification-policies\">\n              Firing alert instances are routed to notification policies based on matching labels. The default\n              notification policy matches all alert instances.\n            </Trans>\n          </Stack>\n          <Stack direction=\"column\" gap={0}>\n            <Trans i18nKey=\"alerting.need-help-info-for-notification-policy.custom-labels\">\n              Custom labels change the way your notifications are routed. First, add labels to your alert rule and then\n              connect them to your notification policy by adding label matchers.\n            </Trans>\n            <TextLink\n              href={`https://grafana.com/docs/grafana/latest/alerting/fundamentals/notifications/notification-policies/`}\n              external\n            >\n              <Trans i18nKey=\"alerting.need-help-info-for-notification-policy.read-more\">\n                Read about notification policies.\n              </Trans>\n            </TextLink>\n          </Stack>\n        </Stack>\n      }\n      title={t('alerting.need-help-info-for-notification-policy.title-notification-routing', 'Notification routing')}\n    />\n  );\n}\n\nfunction NeedHelpInfoForContactpoint() {\n  return (\n    <NeedHelpInfo\n      contentText={\n        <>\n          <Trans i18nKey=\"alerting.need-help-info-for-contactpoint.select-contact-point\">\n            Select a contact point to notify all recipients in it.\n          </Trans>\n          <br />\n          <Trans i18nKey=\"alerting.need-help-info-for-contactpoint.customize-notifications\">\n            Muting, grouping, and timings options allow you to customize how notifications are sent.\n          </Trans>\n          <br />\n          <br />\n          <Trans i18nKey=\"alerting.need-help-info-for-contactpoint.notification-policies\">\n            Alternatively, toggle the <b>Advanced options</b> button to route notifications using notification policies\n            for greater flexibility.\n          </Trans>\n        </>\n      }\n      externalLink=\"https://grafana.com/docs/grafana/latest/alerting/fundamentals/notifications/\"\n      linkText=\"Read more about notifications\"\n      title={t(\n        'alerting.need-help-info-for-contactpoint.title-notify-by-selecting-a-contact-point',\n        'Notify by selecting a contact point'\n      )}\n    />\n  );\n}\ninterface NotificationsStepDescriptionProps {\n  manualRouting: boolean;\n}\n\nexport const RoutingOptionDescription = ({ manualRouting }: NotificationsStepDescriptionProps) => {\n  return (\n    <Stack alignItems=\"center\">\n      <Text variant=\"bodySmall\" color=\"secondary\">\n        {manualRouting\n          ? t(\n              'alerting.routing-option-description.manual',\n              'Notifications for firing alerts are routed to a selected contact point.'\n            )\n          : t(\n              'alerting.routing-option-description.matching-labels',\n              'Notifications for firing alerts are routed to contact points based on matching labels and the notification policy tree.'\n            )}\n      </Text>\n      {manualRouting ? <NeedHelpInfoForContactpoint /> : <NeedHelpInfoForNotificationPolicy />}\n    </Stack>\n  );\n};\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  routingOptions: css({\n    width: 'fit-content',\n  }),\n  configureNotifications: css({\n    display: 'flex',\n    flexDirection: 'column',\n    marginTop: theme.spacing(2),\n  }),\n});\n","import { PanelData } from '@grafana/data';\nimport { AlertQuery } from 'app/types/unified-alerting-dto';\n\nimport { RuleFormType } from './rule-form';\n\nexport type PreviewRuleRequest = GrafanaPreviewRuleRequest | CloudPreviewRuleRequest;\n\nexport type GrafanaPreviewRuleRequest = {\n  grafana_condition: {\n    condition: string;\n    data: AlertQuery[];\n    now: string;\n  };\n};\n\nexport type CloudPreviewRuleRequest = {\n  dataSourceUid: string;\n  dataSourceName: string;\n  expr: string;\n};\n\nexport type PreviewRuleResponse = {\n  ruleType: RuleFormType;\n  data: PanelData;\n};\n\nexport function isCloudPreviewRequest(request: PreviewRuleRequest): request is CloudPreviewRuleRequest {\n  return 'expr' in request;\n}\n\nexport function isGrafanaPreviewRequest(request: PreviewRuleRequest): request is GrafanaPreviewRuleRequest {\n  return 'grafana_condition' in request;\n}\n","import { Observable, of } from 'rxjs';\nimport { catchError, map, share } from 'rxjs/operators';\n\nimport {\n  DataFrameJSON,\n  LoadingState,\n  PanelData,\n  dataFrameFromJSON,\n  getDefaultTimeRange,\n  withLoadingIndicator,\n} from '@grafana/data';\nimport { getBackendSrv, toDataQueryError } from '@grafana/runtime';\n\nimport {\n  PreviewRuleRequest,\n  PreviewRuleResponse,\n  isCloudPreviewRequest,\n  isGrafanaPreviewRequest,\n} from '../types/preview';\nimport { RuleFormType } from '../types/rule-form';\nimport { GRAFANA_RULES_SOURCE_NAME } from '../utils/datasource';\n\nexport function previewAlertRule(request: PreviewRuleRequest): Observable<PreviewRuleResponse> {\n  if (isCloudPreviewRequest(request)) {\n    return fetchAlertRulePreview(request, request.dataSourceUid, RuleFormType.cloudAlerting);\n  }\n\n  if (isGrafanaPreviewRequest(request)) {\n    return fetchAlertRulePreview(request, GRAFANA_RULES_SOURCE_NAME, RuleFormType.grafana);\n  }\n\n  throw new Error('unsupported preview rule request');\n}\n\ntype AlertRulePreviewResponse = {\n  instances: DataFrameJSON[];\n};\n\nfunction fetchAlertRulePreview(\n  request: PreviewRuleRequest,\n  dataSourceUid: string,\n  ruleType: RuleFormType\n): Observable<PreviewRuleResponse> {\n  return withLoadingIndicator({\n    whileLoading: createResponse(ruleType),\n    source: getBackendSrv()\n      .fetch<AlertRulePreviewResponse>({\n        method: 'POST',\n        url: `/api/v1/rule/test/${dataSourceUid}`,\n        data: request,\n      })\n      .pipe(\n        map(({ data }) => {\n          return createResponse(ruleType, {\n            state: LoadingState.Done,\n            series: data.instances.map(dataFrameFromJSON),\n          });\n        }),\n        catchError((error: Error) => {\n          return of(\n            createResponse(ruleType, {\n              state: LoadingState.Error,\n              error: toDataQueryError(error),\n            })\n          );\n        }),\n        share()\n      ),\n  });\n}\n\nfunction createResponse(ruleType: RuleFormType, data: Partial<PanelData> = {}): PreviewRuleResponse {\n  return {\n    ruleType,\n    data: {\n      state: LoadingState.Loading,\n      series: [],\n      timeRange: getDefaultTimeRange(),\n      ...data,\n    },\n  };\n}\n","import { css } from '@emotion/css';\nimport * as React from 'react';\nimport AutoSizer from 'react-virtualized-auto-sizer';\n\nimport { FieldConfigSource, FieldMatcherID, GrafanaTheme2, LoadingState } from '@grafana/data';\nimport { Trans, t } from '@grafana/i18n';\nimport { PanelRenderer } from '@grafana/runtime';\nimport { TableCellDisplayMode, useStyles2 } from '@grafana/ui';\n\nimport { PreviewRuleResponse } from '../../types/preview';\nimport { RuleFormType } from '../../types/rule-form';\nimport { messageFromError } from '../../utils/redux';\n\ntype Props = {\n  preview: PreviewRuleResponse | undefined;\n};\n\nexport function PreviewRuleResult(props: Props): React.ReactElement | null {\n  const { preview } = props;\n  const styles = useStyles2(getStyles);\n\n  const fieldConfig: FieldConfigSource = {\n    defaults: {},\n    overrides: [\n      {\n        matcher: { id: FieldMatcherID.byName, options: 'Info' },\n        properties: [{ id: 'custom.displayMode', value: TableCellDisplayMode.JSONView }],\n      },\n    ],\n  };\n\n  if (!preview) {\n    return null;\n  }\n\n  const { data, ruleType } = preview;\n\n  if (data.state === LoadingState.Loading) {\n    return (\n      <div className={styles.container}>\n        <span>\n          <Trans i18nKey=\"alerting.preview-rule-result.loading-preview\">Loading preview...</Trans>\n        </span>\n      </div>\n    );\n  }\n\n  if (data.state === LoadingState.Error) {\n    return (\n      <div className={styles.container}>\n        {data.error\n          ? messageFromError(data.error)\n          : t('alerting.preview-rule-result.preview-failed', 'Failed to preview alert rule')}\n      </div>\n    );\n  }\n\n  return (\n    <div className={styles.container}>\n      <Trans i18nKey=\"alerting.preview-rule-result.preview-based-on-query-result\">\n        Preview based on the result of running the query, for this moment.\n      </Trans>\n      {ruleType === RuleFormType.grafana && (\n        <Trans i18nKey=\"alerting.preview-rule-result.no-data-error-handling-not-applied\">\n          Configuration for `no data` and `error handling` is not applied.\n        </Trans>\n      )}\n      <div className={styles.table}>\n        <AutoSizer>\n          {({ width, height }) => (\n            <div style={{ width: `${width}px`, height: `${height}px` }}>\n              <PanelRenderer\n                title=\"\"\n                width={width}\n                height={height}\n                pluginId=\"table\"\n                data={data}\n                fieldConfig={fieldConfig}\n              />\n            </div>\n          )}\n        </AutoSizer>\n      </div>\n    </div>\n  );\n}\n\nfunction getStyles(theme: GrafanaTheme2) {\n  return {\n    container: css({\n      margin: `${theme.spacing(2)} 0`,\n    }),\n    table: css({\n      flex: '1 1 auto',\n      height: '135px',\n      marginTop: theme.spacing(2),\n      border: `1px solid ${theme.colors.border.medium}`,\n      borderRadius: theme.shape.radius.default,\n    }),\n  };\n}\n","import { css } from '@emotion/css';\nimport * as React from 'react';\nimport { useCallback, useState } from 'react';\nimport { useFormContext } from 'react-hook-form';\nimport { useMountedState } from 'react-use';\nimport { takeWhile } from 'rxjs/operators';\n\nimport { GrafanaTheme2, LoadingState, dateTimeFormatISO } from '@grafana/data';\nimport { Trans, t } from '@grafana/i18n';\nimport { getDataSourceSrv } from '@grafana/runtime';\nimport { Alert, Button, Stack, useStyles2 } from '@grafana/ui';\n\nimport { previewAlertRule } from '../../api/preview';\nimport { useAlertQueriesStatus } from '../../hooks/useAlertQueriesStatus';\nimport { PreviewRuleRequest, PreviewRuleResponse } from '../../types/preview';\nimport { RuleFormType, RuleFormValues } from '../../types/rule-form';\nimport { isDataSourceManagedRuleByType } from '../../utils/rules';\n\nimport { PreviewRuleResult } from './PreviewRuleResult';\n\nconst fields: Array<keyof RuleFormValues> = ['type', 'dataSourceName', 'condition', 'queries', 'expression'];\n\nexport function PreviewRule(): React.ReactElement | null {\n  const styles = useStyles2(getStyles);\n  const [preview, onPreview] = usePreview();\n  const { watch } = useFormContext<RuleFormValues>();\n  const [type, condition, queries] = watch(['type', 'condition', 'queries']);\n  const { allDataSourcesAvailable } = useAlertQueriesStatus(queries);\n\n  if (!type || isDataSourceManagedRuleByType(type)) {\n    return null;\n  }\n\n  const isPreviewAvailable = Boolean(condition) && allDataSourcesAvailable;\n\n  return (\n    <div className={styles.container}>\n      <Stack>\n        {allDataSourcesAvailable && (\n          <Button disabled={!isPreviewAvailable} type=\"button\" variant=\"primary\" onClick={onPreview}>\n            <Trans i18nKey=\"alerting.preview-rule.preview-alerts\">Preview alerts</Trans>\n          </Button>\n        )}\n        {!allDataSourcesAvailable && (\n          <Alert\n            title={t('alerting.preview-rule.title-preview-is-not-available', 'Preview is not available')}\n            severity=\"warning\"\n          >\n            <Trans i18nKey=\"alerting.preview-rule.body-preview-is-not-available\">\n              Cannot display the query preview. Some of the data sources used in the queries are not available.\n            </Trans>\n          </Alert>\n        )}\n      </Stack>\n      <PreviewRuleResult preview={preview} />\n    </div>\n  );\n}\n\nexport function usePreview(): [PreviewRuleResponse | undefined, () => void] {\n  const [preview, setPreview] = useState<PreviewRuleResponse | undefined>();\n  const { getValues } = useFormContext<RuleFormValues>();\n  const isMounted = useMountedState();\n\n  const onPreview = useCallback(() => {\n    const values = getValues(fields);\n    const request = createPreviewRequest(values);\n\n    previewAlertRule(request)\n      .pipe(takeWhile((response) => !isCompleted(response), true))\n      .subscribe((response) => {\n        if (!isMounted()) {\n          return;\n        }\n        setPreview(response);\n      });\n  }, [getValues, isMounted]);\n\n  return [preview, onPreview];\n}\n\nfunction createPreviewRequest(values: any[]): PreviewRuleRequest {\n  const [type, dataSourceName, condition, queries, expression] = values;\n  const dsSettings = getDataSourceSrv().getInstanceSettings(dataSourceName);\n  if (!dsSettings) {\n    throw new Error(`Cannot find data source settings for ${dataSourceName}`);\n  }\n\n  switch (type) {\n    case RuleFormType.cloudAlerting:\n      return {\n        dataSourceUid: dsSettings.uid,\n        dataSourceName,\n        expr: expression,\n      };\n\n    case RuleFormType.grafana:\n      return {\n        grafana_condition: {\n          condition,\n          data: queries,\n          now: dateTimeFormatISO(Date.now()),\n        },\n      };\n\n    default:\n      throw new Error(`Alert type ${type} not supported by preview.`);\n  }\n}\n\nfunction isCompleted(response: PreviewRuleResponse): boolean {\n  switch (response.data.state) {\n    case LoadingState.Done:\n    case LoadingState.Error:\n      return true;\n    default:\n      return false;\n  }\n}\n\nfunction getStyles(theme: GrafanaTheme2) {\n  return {\n    container: css({\n      marginTop: theme.spacing(2),\n      maxWidth: `${theme.breakpoints.values.xxl}px`,\n    }),\n  };\n}\n","import { memo, useCallback, useEffect, useMemo, useState } from 'react';\nimport { FormProvider, useForm } from 'react-hook-form';\nimport { useAsync } from 'react-use';\n\nimport { Trans, t } from '@grafana/i18n';\nimport { Button, LinkButton, LoadingPlaceholder, Stack } from '@grafana/ui';\nimport { useAppNotification } from 'app/core/copy/appNotification';\n\nimport {\n  PostableRulerRuleGroupDTO,\n  RulerRuleDTO,\n  RulerRuleGroupDTO,\n} from '../../../../../../types/unified-alerting-dto';\nimport { alertRuleApi } from '../../../api/alertRuleApi';\nimport { fetchRulerRulesGroup } from '../../../api/ruler';\nimport { useDataSourceFeatures } from '../../../hooks/useCombinedRule';\nimport { useReturnTo } from '../../../hooks/useReturnTo';\nimport { DEFAULT_GROUP_EVALUATION_INTERVAL, getDefaultFormValues } from '../../../rule-editor/formDefaults';\nimport { RuleFormType, RuleFormValues } from '../../../types/rule-form';\nimport { GRAFANA_RULES_SOURCE_NAME } from '../../../utils/datasource';\nimport { formValuesToRulerGrafanaRuleDTO, getDefaultQueries } from '../../../utils/rule-form';\nimport { rulerRuleType } from '../../../utils/rules';\nimport { FileExportPreview } from '../../export/FileExportPreview';\nimport { GrafanaExportDrawer } from '../../export/GrafanaExportDrawer';\nimport { ExportFormats, HclExportProvider, allGrafanaExportProviders } from '../../export/providers';\nimport { AlertRuleNameAndMetric } from '../AlertRuleNameInput';\nimport AnnotationsStep from '../AnnotationsStep';\nimport { GrafanaEvaluationBehaviorStep } from '../GrafanaEvaluationBehavior';\nimport { GrafanaFolderAndLabelsStep } from '../GrafanaFolderAndLabelsStep';\nimport { NotificationsStep } from '../NotificationsStep';\nimport { QueryAndExpressionsStep } from '../query-and-alert-condition/QueryAndExpressionsStep';\n\ninterface ModifyExportRuleFormProps {\n  alertUid?: string;\n  ruleForm?: RuleFormValues;\n}\n\nexport function ModifyExportRuleForm({ ruleForm, alertUid }: ModifyExportRuleFormProps) {\n  const defaultValuesForNewRule: RuleFormValues = useMemo(() => {\n    const defaultRuleType = RuleFormType.grafana;\n\n    return {\n      ...getDefaultFormValues(),\n      condition: 'C',\n      queries: getDefaultQueries(false),\n      type: defaultRuleType,\n      evaluateEvery: DEFAULT_GROUP_EVALUATION_INTERVAL,\n    };\n  }, []);\n\n  const formAPI = useForm<RuleFormValues>({\n    mode: 'onSubmit',\n    defaultValues: ruleForm ?? defaultValuesForNewRule,\n    shouldFocusError: true,\n  });\n\n  const existing = Boolean(ruleForm);\n  const notifyApp = useAppNotification();\n  const { returnTo } = useReturnTo('/alerting/list');\n\n  const [exportData, setExportData] = useState<RuleFormValues | undefined>(undefined);\n  const [conditionErrorMsg, setConditionErrorMsg] = useState('');\n\n  const onInvalid = (): void => {\n    notifyApp.error('There are errors in the form. Please correct them and try again!');\n  };\n\n  const checkAlertCondition = (msg = '') => {\n    setConditionErrorMsg(msg);\n  };\n\n  const submit = (exportData: RuleFormValues | undefined) => {\n    if (conditionErrorMsg !== '') {\n      notifyApp.error(conditionErrorMsg);\n      return;\n    }\n    setExportData(exportData);\n  };\n\n  const onClose = useCallback(() => {\n    setExportData(undefined);\n  }, [setExportData]);\n\n  return (\n    <FormProvider {...formAPI}>\n      <Stack direction=\"column\">\n        <form onSubmit={(e) => e.preventDefault()}>\n          <div>\n            <Stack direction=\"column\" gap={3}>\n              {/* Step 1 */}\n              <AlertRuleNameAndMetric />\n              {/* Step 2 */}\n              <QueryAndExpressionsStep editingExistingRule={existing} onDataChange={checkAlertCondition} mode=\"draft\" />\n              {/* Step 3-4-5 */}\n              <GrafanaFolderAndLabelsStep />\n\n              {/* Step 4 & 5 */}\n              <GrafanaEvaluationBehaviorStep existing={Boolean(existing)} enableProvisionedGroups={true} />\n              {/* Notifications step*/}\n              <NotificationsStep alertUid={alertUid} />\n              {/* Annotations only for cloud and Grafana */}\n              <AnnotationsStep />\n            </Stack>\n          </div>\n        </form>\n        {exportData && <GrafanaRuleDesignExporter exportValues={exportData} onClose={onClose} uid={alertUid} />}\n        <Stack direction=\"row\">\n          <Button key=\"export-rule\" onClick={formAPI.handleSubmit((formValues) => submit(formValues), onInvalid)}>\n            <Trans i18nKey=\"alerting.modify-export-rule-form.action-buttons.export\">Export</Trans>\n          </Button>\n          <LinkButton href={returnTo} key=\"cancel\" variant=\"secondary\" onClick={() => submit(undefined)}>\n            <Trans i18nKey=\"alerting.common.cancel\">Cancel</Trans>\n          </LinkButton>\n        </Stack>\n      </Stack>\n    </FormProvider>\n  );\n}\n\nconst useGetGroup = (nameSpaceUID: string, group: string) => {\n  const { dsFeatures } = useDataSourceFeatures(GRAFANA_RULES_SOURCE_NAME);\n\n  const rulerConfig = dsFeatures?.rulerConfig;\n\n  const targetGroup = useAsync(async () => {\n    return rulerConfig ? await fetchRulerRulesGroup(rulerConfig, nameSpaceUID, group) : undefined;\n  }, [rulerConfig, nameSpaceUID, group]);\n\n  return targetGroup;\n};\n\ninterface GrafanaRuleDesignExportPreviewProps {\n  exportFormat: ExportFormats;\n  onClose: () => void;\n  exportValues: RuleFormValues;\n  uid?: string;\n}\nexport const getPayloadToExport = (\n  formValues: RuleFormValues,\n  existingGroup: RulerRuleGroupDTO<RulerRuleDTO> | null | undefined,\n  ruleUid?: string\n): PostableRulerRuleGroupDTO => {\n  const grafanaRuleDto = formValuesToRulerGrafanaRuleDTO(formValues);\n\n  const updatedRule = { ...grafanaRuleDto, grafana_alert: { ...grafanaRuleDto.grafana_alert, uid: ruleUid } };\n  if (existingGroup?.rules) {\n    // we have to update the rule in the group in the same position if it exists, otherwise we have to add it at the end\n    let alreadyExistsInGroup = false;\n    const updatedRules = existingGroup.rules.map((rule: RulerRuleDTO) => {\n      if (rulerRuleType.grafana.rule(rule) && rule.grafana_alert.uid === ruleUid) {\n        alreadyExistsInGroup = true;\n        return updatedRule;\n      } else {\n        return rule;\n      }\n    });\n    if (!alreadyExistsInGroup) {\n      // we have to add the updated rule at the end of the group\n      updatedRules.push(updatedRule);\n    }\n    return {\n      ...existingGroup,\n      rules: updatedRules,\n    };\n  } else {\n    // we have to create a new group with the updated rule\n    return {\n      name: existingGroup?.name ?? formValues.group,\n      rules: [updatedRule],\n    };\n  }\n};\n\nconst useGetPayloadToExport = (values: RuleFormValues, ruleUid?: string) => {\n  const rulerGroupDto = useGetGroup(values.folder?.uid ?? '', values.group);\n  const payload: PostableRulerRuleGroupDTO = useMemo(() => {\n    return getPayloadToExport(values, rulerGroupDto?.value, ruleUid);\n  }, [ruleUid, rulerGroupDto, values]);\n  return { payload, loadingGroup: rulerGroupDto.loading };\n};\n\nconst GrafanaRuleDesignExportPreview = ({\n  exportFormat,\n  exportValues,\n  onClose,\n  uid,\n}: GrafanaRuleDesignExportPreviewProps) => {\n  const [getExport, exportData] = alertRuleApi.endpoints.exportModifiedRuleGroup.useMutation();\n  const { loadingGroup, payload } = useGetPayloadToExport(exportValues, uid);\n\n  const nameSpaceUID = exportValues.folder?.uid ?? '';\n\n  useEffect(() => {\n    !loadingGroup && payload.name && getExport({ payload, format: exportFormat, nameSpaceUID });\n  }, [nameSpaceUID, exportFormat, payload, getExport, loadingGroup]);\n\n  if (exportData.isLoading) {\n    return <LoadingPlaceholder text={t('alerting.grafana-rule-design-export-preview.text-loading', 'Loading....')} />;\n  }\n\n  const downloadFileName = `modify-export-${payload.name}-${uid}-${new Date().getTime()}`;\n\n  return (\n    <FileExportPreview\n      format={exportFormat}\n      textDefinition={exportData.data ?? ''}\n      downloadFileName={downloadFileName}\n      onClose={onClose}\n    />\n  );\n};\n\ninterface GrafanaRuleDesignExporterProps {\n  onClose: () => void;\n  exportValues: RuleFormValues;\n  uid?: string;\n}\n\nexport const GrafanaRuleDesignExporter = memo(({ onClose, exportValues, uid }: GrafanaRuleDesignExporterProps) => {\n  const exportingNewRule = !uid;\n  const initialTab = exportingNewRule ? 'hcl' : 'yaml';\n  const [activeTab, setActiveTab] = useState<ExportFormats>(initialTab);\n\n  const formatProviders = exportingNewRule ? [HclExportProvider] : Object.values(allGrafanaExportProviders);\n\n  return (\n    <GrafanaExportDrawer\n      title={t('alerting.grafana-rule-design-exporter.title-export-group', 'Export Group')}\n      activeTab={activeTab}\n      onTabChange={setActiveTab}\n      onClose={onClose}\n      formatProviders={formatProviders}\n    >\n      <GrafanaRuleDesignExportPreview\n        exportFormat={activeTab}\n        onClose={onClose}\n        exportValues={exportValues}\n        uid={uid}\n      />\n    </GrafanaExportDrawer>\n  );\n});\n\nGrafanaRuleDesignExporter.displayName = 'GrafanaRuleDesignExporter';\n","import { t } from '@grafana/i18n';\nimport { Modal } from '@grafana/ui';\n\nimport { KBObjectArray } from '../../../types/rule-form';\n\nimport { LabelsSubForm } from './LabelsField';\n\nexport interface LabelsEditorModalProps {\n  isOpen: boolean;\n  initialLabels: Array<{\n    key: string;\n    value: string;\n  }>;\n  onClose: (labelsToUodate?: KBObjectArray) => void;\n  dataSourceName: string;\n}\nexport function LabelsEditorModal({ isOpen, onClose, dataSourceName, initialLabels }: LabelsEditorModalProps) {\n  return (\n    <Modal\n      title={t('alerting.labels-editor-modal.title-edit-labels', 'Edit labels')}\n      closeOnEscape\n      isOpen={isOpen}\n      onDismiss={() => onClose()}\n    >\n      <LabelsSubForm dataSourceName={dataSourceName} onClose={onClose} initialLabels={initialLabels} />\n    </Modal>\n  );\n}\n","import { useFormContext } from 'react-hook-form';\n\nimport { Trans, t } from '@grafana/i18n';\nimport { Button, Stack, Text } from '@grafana/ui';\n\nimport { RuleFormValues } from '../../../types/rule-form';\nimport { isRecordingRuleByType } from '../../../utils/rules';\nimport { NeedHelpInfo } from '../NeedHelpInfo';\n\nimport { LabelsInRule } from './LabelsField';\n\ninterface LabelsFieldInFormProps {\n  onEditClick: () => void;\n}\nexport function LabelsFieldInForm({ onEditClick }: LabelsFieldInFormProps) {\n  const { watch } = useFormContext<RuleFormValues>();\n\n  const labels = watch('labels');\n  const type = watch('type');\n\n  const isRecordingRule = type ? isRecordingRuleByType(type) : false;\n\n  const text = isRecordingRule\n    ? t('alerting.alertform.labels.recording', 'Add labels to your rule.')\n    : t(\n        'alerting.alertform.labels.alerting',\n        'Add labels to your rule for searching, silencing, or routing to a notification policy.'\n      );\n\n  const hasLabels = Object.keys(labels).length > 0 && labels.some((label) => label.key || label.value);\n\n  return (\n    <Stack direction=\"column\" gap={2}>\n      <Stack direction=\"column\" gap={1}>\n        <Text element=\"h5\">\n          <Trans i18nKey=\"alerting.labels-field-in-form.labels\">Labels</Trans>\n        </Text>\n        <Stack direction={'row'} gap={1}>\n          <Text variant=\"bodySmall\" color=\"secondary\">\n            {text}\n          </Text>\n          <NeedHelpInfo\n            externalLink={'https://grafana.com/docs/grafana/latest/alerting/fundamentals/alert-rules/annotation-label/'}\n            linkText={`Read about labels`}\n            contentText=\"The dropdown only displays labels that you have previously used for alerts.\n              Select a label from the options below or type in a new one.\"\n            title={t('alerting.labels-field-in-form.title-labels', 'Labels')}\n          />\n        </Stack>\n      </Stack>\n      <Stack direction=\"row\" gap={1} alignItems=\"center\">\n        <LabelsInRule labels={labels} />\n        {hasLabels ? (\n          <Button variant=\"secondary\" type=\"button\" onClick={onEditClick} size=\"sm\">\n            <Trans i18nKey=\"alerting.labels-field-in-form.edit-labels\">Edit labels</Trans>\n          </Button>\n        ) : (\n          <Stack direction=\"row\" gap={2} alignItems=\"center\">\n            <Text>\n              <Trans i18nKey=\"alerting.labels-field-in-form.no-labels-selected\">No labels selected</Trans>\n            </Text>\n            <Button\n              icon=\"plus\"\n              type=\"button\"\n              variant=\"secondary\"\n              onClick={onEditClick}\n              size=\"sm\"\n              data-testid=\"add-labels-button\"\n            >\n              <Trans i18nKey=\"alerting.labels-field-in-form.add-labels\">Add labels</Trans>\n            </Button>\n          </Stack>\n        )}\n      </Stack>\n    </Stack>\n  );\n}\n","import { DataFrame } from '@grafana/data';\n\nimport { GrafanaAlertState, Labels, isGrafanaAlertState } from '../../../../../types/unified-alerting-dto';\n\ninterface AlertPreviewInstance {\n  state: GrafanaAlertState;\n  info?: string;\n  labels: Labels;\n}\n\ninterface AlertPreview {\n  instances: AlertPreviewInstance[];\n}\n\n// Alerts previews come in a DataFrame format which is more suited for displaying time series data\n// In order to display a list of tags we need to transform DataFrame into set of labels\nexport function mapDataFrameToAlertPreview({ fields }: DataFrame): AlertPreview {\n  const labelFields = fields.filter((field) => !['State', 'Info'].includes(field.name));\n  const stateFieldIndex = fields.findIndex((field) => field.name === 'State');\n  const infoFieldIndex = fields.findIndex((field) => field.name === 'Info');\n\n  const labelIndexes = labelFields.map((labelField) => fields.indexOf(labelField));\n\n  const instanceStatusCount = fields[stateFieldIndex]?.values.length ?? 0;\n\n  const instances: AlertPreviewInstance[] = [];\n\n  for (let index = 0; index < instanceStatusCount; index++) {\n    const labelValues = labelIndexes.map((labelIndex) => [fields[labelIndex].name, fields[labelIndex].values[index]]);\n    const state = fields[stateFieldIndex]?.values?.[index];\n    const info = fields[infoFieldIndex]?.values?.[index];\n\n    if (isGrafanaAlertState(state)) {\n      instances.push({\n        state: state,\n        info: info,\n        labels: Object.fromEntries(labelValues),\n      });\n    }\n  }\n\n  return { instances };\n}\n","import { css } from '@emotion/css';\n\nimport { DataFrame, GrafanaTheme2 } from '@grafana/data';\nimport { Trans } from '@grafana/i18n';\nimport { Icon, TagList, Tooltip, useStyles2 } from '@grafana/ui';\n\nimport { labelsToTags } from '../../utils/labels';\nimport { AlertStateTag } from '../rules/AlertStateTag';\n\nimport { mapDataFrameToAlertPreview } from './preview';\n\ninterface CloudAlertPreviewProps {\n  preview: DataFrame;\n}\n\nexport function CloudAlertPreview({ preview }: CloudAlertPreviewProps) {\n  const styles = useStyles2(getStyles);\n  const alertPreview = mapDataFrameToAlertPreview(preview);\n\n  return (\n    <table className={styles.table}>\n      <caption>\n        <div>\n          <Trans i18nKey=\"alerting.cloud-alert-preview.alerts-preview\">Alerts preview</Trans>\n        </div>\n        <span>\n          <Trans i18nKey=\"alerting.cloud-alert-preview.running-query-preview\">\n            Preview based on the result of running the query for this moment.\n          </Trans>\n        </span>\n      </caption>\n      <thead>\n        <tr>\n          <th>\n            <Trans i18nKey=\"alerting.cloud-alert-preview.state\">State</Trans>\n          </th>\n          <th>\n            <Trans i18nKey=\"alerting.cloud-alert-preview.labels\">Labels</Trans>\n          </th>\n          <th>\n            <Trans i18nKey=\"alerting.cloud-alert-preview.info\">Info</Trans>\n          </th>\n        </tr>\n      </thead>\n      <tbody>\n        {alertPreview.instances.map(({ state, info, labels }, index) => {\n          const instanceTags = labelsToTags(labels);\n\n          return (\n            <tr key={index}>\n              <td>{<AlertStateTag state={state} />}</td>\n              <td>\n                <TagList tags={instanceTags} className={styles.tagList} />\n              </td>\n              <td>\n                {info && (\n                  <Tooltip content={info}>\n                    <Icon name=\"info-circle\" />\n                  </Tooltip>\n                )}\n              </td>\n            </tr>\n          );\n        })}\n      </tbody>\n    </table>\n  );\n}\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  table: css({\n    width: '100%',\n    margin: theme.spacing(2, 0),\n\n    caption: {\n      captionSide: 'top',\n      color: theme.colors.text.primary,\n\n      '& > span': {\n        fontSize: theme.typography.bodySmall.fontSize,\n        color: theme.colors.text.secondary,\n      },\n    },\n\n    'td, th': {\n      padding: theme.spacing(1, 1),\n    },\n\n    'td + td, th + th': {\n      paddingLeft: theme.spacing(3),\n    },\n\n    'thead th': {\n      '&:nth-child(1)': {\n        width: '80px',\n      },\n\n      '&:nth-child(2)': {\n        width: 'auto',\n      },\n\n      '&:nth-child(3)': {\n        width: '40px',\n      },\n    },\n\n    'td:nth-child(3)': {\n      textAlign: 'center',\n    },\n\n    'tbody tr:nth-child(2n + 1)': {\n      backgroundColor: theme.colors.background.secondary,\n    },\n  }),\n  tagList: css({\n    justifyContent: 'flex-start',\n  }),\n});\n","import { css } from '@emotion/css';\nimport { noop } from 'lodash';\nimport { useCallback, useMemo } from 'react';\nimport { useAsync } from 'react-use';\n\nimport { CoreApp, DataSourcePluginContextProvider, GrafanaTheme2, LoadingState } from '@grafana/data';\nimport { Trans, t } from '@grafana/i18n';\nimport { PromQuery } from '@grafana/prometheus';\nimport { getDataSourceSrv } from '@grafana/runtime';\nimport { DataQuery } from '@grafana/schema';\nimport { Alert, Button, useStyles2 } from '@grafana/ui';\nimport { LokiQuery } from 'app/plugins/datasource/loki/types';\n\nimport { isSupportedExternalRulesSourceType } from '../../utils/datasource';\n\nimport { CloudAlertPreview } from './CloudAlertPreview';\nimport { usePreview } from './PreviewRule';\n\nexport interface ExpressionEditorProps {\n  value?: string;\n  onChange: (value: string) => void;\n  dataSourceName: string; // will be a prometheus or loki datasource\n  showPreviewAlertsButton: boolean;\n}\n\nexport const ExpressionEditor = ({\n  value,\n  onChange,\n  dataSourceName,\n  showPreviewAlertsButton = true,\n}: ExpressionEditorProps) => {\n  const styles = useStyles2(getStyles);\n\n  const { mapToValue, mapToQuery } = useQueryMappers(dataSourceName);\n\n  const dataQuery = mapToQuery({ refId: 'A', hide: false }, value);\n\n  const {\n    error,\n    loading,\n    value: dataSource,\n  } = useAsync(() => {\n    return getDataSourceSrv().get(dataSourceName);\n  }, [dataSourceName]);\n\n  const onChangeQuery = useCallback(\n    (query: DataQuery) => {\n      onChange(mapToValue(query));\n    },\n    [onChange, mapToValue]\n  );\n\n  const [alertPreview, onPreview] = usePreview();\n\n  const onRunQueriesClick = async () => {\n    onPreview();\n  };\n\n  if (loading || dataSource?.name !== dataSourceName) {\n    return null;\n  }\n\n  const dsi = getDataSourceSrv().getInstanceSettings(dataSourceName);\n\n  if (error || !dataSource || !dataSource?.components?.QueryEditor || !dsi) {\n    const errorMessage =\n      error?.message ||\n      t(\n        'alerting.expression-editor.error-no-component',\n        'Data source plugin does not export any Query Editor component'\n      );\n    return (\n      <div>\n        <Trans i18nKey=\"alerting.expression-editor.could-not-load-editor\">\n          Could not load query editor due to: {{ errorMessage }}\n        </Trans>\n      </div>\n    );\n  }\n\n  const previewLoaded = alertPreview?.data.state === LoadingState.Done;\n\n  const QueryEditor = dataSource?.components?.QueryEditor;\n\n  // The Preview endpoint returns the preview as a single-element array of data frames\n  const previewDataFrame = alertPreview?.data?.series?.find((s) => s.name === 'evaluation results');\n  // The preview API returns arrays with empty elements when there are no firing alerts\n  const previewHasAlerts = previewDataFrame && previewDataFrame.fields.some((field) => field.values.length > 0);\n\n  return (\n    <>\n      <DataSourcePluginContextProvider instanceSettings={dsi}>\n        <QueryEditor\n          query={dataQuery}\n          queries={[dataQuery]}\n          app={CoreApp.CloudAlerting}\n          onChange={onChangeQuery}\n          onRunQuery={noop}\n          datasource={dataSource}\n        />\n      </DataSourcePluginContextProvider>\n      {showPreviewAlertsButton && (\n        <div className={styles.preview}>\n          <Button\n            type=\"button\"\n            onClick={onRunQueriesClick}\n            disabled={alertPreview?.data.state === LoadingState.Loading}\n          >\n            <Trans i18nKey=\"alerting.expression-editor.preview-alerts\">Preview alerts</Trans>\n          </Button>\n          {previewLoaded && !previewHasAlerts && (\n            <Alert\n              title={t('alerting.expression-editor.title-alerts-preview', 'Alerts preview')}\n              severity=\"info\"\n              className={styles.previewAlert}\n            >\n              <Trans i18nKey=\"alerting.expression-editor.there-firing-alerts-query\">\n                There are no firing alerts for your query.\n              </Trans>\n            </Alert>\n          )}\n          {previewHasAlerts && <CloudAlertPreview preview={previewDataFrame} />}\n        </div>\n      )}\n    </>\n  );\n};\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  preview: css({\n    padding: theme.spacing(2, 0),\n    maxWidth: `${theme.breakpoints.values.xl}px`,\n  }),\n  previewAlert: css({\n    margin: theme.spacing(1, 0),\n  }),\n});\n\ntype QueryMappers<T extends DataQuery = DataQuery> = {\n  mapToValue: (query: T) => string;\n  mapToQuery: (existing: T, value: string | undefined) => T;\n};\n\nexport function useQueryMappers(dataSourceName: string): QueryMappers {\n  return useMemo(() => {\n    const settings = getDataSourceSrv().getInstanceSettings(dataSourceName);\n    if (!settings) {\n      throw new Error(`Datasource ${dataSourceName} not found`);\n    }\n\n    if (!isSupportedExternalRulesSourceType(settings.type)) {\n      throw new Error(`${settings.type} is not supported as an expression editor`);\n    }\n\n    return {\n      mapToValue: (query: DataQuery) => (query as PromQuery | LokiQuery).expr,\n      mapToQuery: (existing: DataQuery, value: string | undefined) => ({ ...existing, expr: value }),\n    };\n  }, [dataSourceName]);\n}\n","import { css } from '@emotion/css';\nimport { useMemo } from 'react';\n\nimport { GrafanaTheme2, PanelData } from '@grafana/data';\nimport { useStyles2 } from '@grafana/ui';\nimport { isExpressionQuery } from 'app/features/expressions/guards';\nimport { ExpressionQuery, ExpressionQueryType } from 'app/features/expressions/types';\nimport { AlertQuery } from 'app/types/unified-alerting-dto';\n\nimport { Expression } from '../expressions/Expression';\n\nimport { errorFromCurrentCondition, errorFromPreviewData, warningFromSeries } from './util';\n\ninterface Props {\n  condition: string | null;\n  onSetCondition: (refId: string) => void;\n  panelData: Record<string, PanelData | undefined>;\n  queries: AlertQuery[];\n  onRemoveExpression: (refId: string) => void;\n  onUpdateRefId: (oldRefId: string, newRefId: string) => void;\n  onUpdateExpressionType: (refId: string, type: ExpressionQueryType) => void;\n  onUpdateQueryExpression: (query: ExpressionQuery) => void;\n}\n\nexport const ExpressionsEditor = ({\n  condition,\n  onSetCondition,\n  queries,\n  panelData,\n  onUpdateRefId,\n  onRemoveExpression,\n  onUpdateExpressionType,\n  onUpdateQueryExpression,\n}: Props) => {\n  const expressionQueries = useMemo(() => {\n    return queries.reduce((acc: ExpressionQuery[], query) => {\n      return isExpressionQuery(query.model) ? acc.concat(query.model) : acc;\n    }, []);\n  }, [queries]);\n  const styles = useStyles2(getStyles);\n\n  return (\n    <div className={styles.wrapper}>\n      {expressionQueries.map((query) => {\n        const data = panelData[query.refId];\n\n        const isAlertCondition = condition === query.refId;\n\n        const errorFromCondition = data && isAlertCondition ? errorFromCurrentCondition(data) : undefined;\n        const errorFromPreview = data ? errorFromPreviewData(data) : undefined;\n        const error = errorFromPreview || errorFromCondition;\n\n        const warning = data ? warningFromSeries(data.series) : undefined;\n\n        return (\n          <Expression\n            key={query.refId}\n            isAlertCondition={isAlertCondition}\n            data={data}\n            error={error}\n            warning={warning}\n            queries={queries}\n            query={query}\n            onSetCondition={onSetCondition}\n            onRemoveExpression={onRemoveExpression}\n            onUpdateRefId={onUpdateRefId}\n            onUpdateExpressionType={onUpdateExpressionType}\n            onChangeQuery={onUpdateQueryExpression}\n          />\n        );\n      })}\n    </div>\n  );\n};\nconst getStyles = (theme: GrafanaTheme2) => ({\n  wrapper: css({\n    display: 'flex',\n    gap: theme.spacing(2),\n    alignContent: 'stretch',\n    flexWrap: 'wrap',\n  }),\n});\n","import { css } from '@emotion/css';\nimport { useState } from 'react';\n\nimport { GrafanaTheme2, RelativeTimeRange, dateTime, getDefaultRelativeTimeRange, rangeUtil } from '@grafana/data';\nimport { Trans, t } from '@grafana/i18n';\nimport { Icon, InlineField, RelativeTimeRangePicker, Toggletip, clearButtonStyles, useStyles2 } from '@grafana/ui';\nimport { AlertQuery } from 'app/types/unified-alerting-dto';\n\nimport { AlertQueryOptions, MaxDataPointsOption, MinIntervalOption } from './QueryWrapper';\n\nexport interface QueryOptionsProps {\n  query: AlertQuery;\n  queryOptions: AlertQueryOptions;\n  onChangeTimeRange?: (timeRange: RelativeTimeRange, index: number) => void;\n  onChangeQueryOptions: (options: AlertQueryOptions, index: number) => void;\n  index: number;\n}\n\nexport const QueryOptions = ({\n  query,\n  queryOptions,\n  onChangeTimeRange,\n  onChangeQueryOptions,\n  index,\n}: QueryOptionsProps) => {\n  const styles = useStyles2(getStyles);\n\n  const [showOptions, setShowOptions] = useState(false);\n\n  const timeRange = query.relativeTimeRange ? rangeUtil.relativeToTimeRange(query.relativeTimeRange) : undefined;\n\n  const separator = <span>, </span>;\n\n  return (\n    <>\n      <Toggletip\n        content={\n          <div className={styles.queryOptions}>\n            {onChangeTimeRange && (\n              <InlineField label={t('alerting.query-options.label-time-range', 'Time Range')}>\n                <RelativeTimeRangePicker\n                  timeRange={query.relativeTimeRange ?? getDefaultRelativeTimeRange()}\n                  onChange={(range) => onChangeTimeRange(range, index)}\n                />\n              </InlineField>\n            )}\n            <MaxDataPointsOption options={queryOptions} onChange={(options) => onChangeQueryOptions(options, index)} />\n            <MinIntervalOption options={queryOptions} onChange={(options) => onChangeQueryOptions(options, index)} />\n          </div>\n        }\n        closeButton={true}\n        placement=\"bottom-start\"\n      >\n        <button type=\"button\" className={styles.actionLink} onClick={() => setShowOptions(!showOptions)}>\n          <Trans i18nKey=\"alerting.query-options.button-options\">Options</Trans>{' '}\n          {showOptions ? <Icon name=\"angle-right\" /> : <Icon name=\"angle-down\" />}\n        </button>\n      </Toggletip>\n\n      <div className={styles.staticValues}>\n        <span>{dateTime(timeRange?.from).locale('en').fromNow(true)}</span>\n\n        {queryOptions.maxDataPoints && (\n          <>\n            {separator}\n            <Trans\n              i18nKey=\"alerting.query-options.max-data-points\"\n              values={{ maxDataPoints: queryOptions.maxDataPoints }}\n            >\n              MD = {'{{maxDataPoints}}'}\n            </Trans>\n          </>\n        )}\n        {queryOptions.minInterval && (\n          <>\n            {separator}\n            <Trans i18nKey=\"alerting.query-options.min-interval\" values={{ minInterval: queryOptions.minInterval }}>\n              Min. Interval = {'{{minInterval}}'}\n            </Trans>\n          </>\n        )}\n      </div>\n    </>\n  );\n};\n\nconst getStyles = (theme: GrafanaTheme2) => {\n  const clearButton = clearButtonStyles(theme);\n\n  return {\n    queryOptions: css({\n      '> div': {\n        justifyContent: 'space-between',\n      },\n    }),\n\n    staticValues: css({\n      color: theme.colors.text.secondary,\n      marginRight: theme.spacing(1),\n    }),\n\n    actionLink: css(clearButton, {\n      color: theme.colors.text.link,\n      cursor: 'pointer',\n\n      '&:hover': {\n        textDecoration: 'underline',\n      },\n    }),\n  };\n};\n","import { css } from '@emotion/css';\nimport { cloneDeep } from 'lodash';\nimport * as React from 'react';\nimport { ChangeEvent, useState } from 'react';\nimport { useFormContext } from 'react-hook-form';\n\nimport {\n  CoreApp,\n  DataSourceApi,\n  DataSourceInstanceSettings,\n  GrafanaTheme2,\n  LoadingState,\n  PanelData,\n  RelativeTimeRange,\n  ThresholdsConfig,\n  getDefaultRelativeTimeRange,\n  rangeUtil,\n} from '@grafana/data';\nimport { Trans, t } from '@grafana/i18n';\nimport { config } from '@grafana/runtime';\nimport { DataQuery } from '@grafana/schema';\nimport { GraphThresholdsStyleMode, Icon, InlineField, Input, Stack, Tooltip, useStyles2 } from '@grafana/ui';\nimport { logInfo } from 'app/features/alerting/unified/Analytics';\nimport { QueryEditorRow } from 'app/features/query/components/QueryEditorRow';\nimport { AlertDataQuery, AlertQuery } from 'app/types/unified-alerting-dto';\n\nimport { RuleFormValues } from '../../types/rule-form';\nimport { msToSingleUnitDuration } from '../../utils/time';\nimport { ExpressionStatusIndicator } from '../expressions/ExpressionStatusIndicator';\n\nimport { QueryOptions } from './QueryOptions';\nimport { VizWrapper } from './VizWrapper';\n\nexport const DEFAULT_MAX_DATA_POINTS = 43200;\nexport const DEFAULT_MIN_INTERVAL = '1s';\n\nexport interface AlertQueryOptions {\n  maxDataPoints?: number | undefined;\n  minInterval?: string | undefined;\n}\n\ninterface Props {\n  data: PanelData;\n  error?: Error;\n  query: AlertQuery;\n  queries: AlertQuery[];\n  dsSettings: DataSourceInstanceSettings;\n  onChangeDataSource: (settings: DataSourceInstanceSettings, index: number) => void;\n  onChangeQuery: (query: DataQuery, index: number) => void;\n  onChangeTimeRange?: (timeRange: RelativeTimeRange, index: number) => void;\n  onRemoveQuery: (query: DataQuery) => void;\n  onDuplicateQuery: (query: AlertQuery) => void;\n  onRunQueries: () => void;\n  index: number;\n  thresholds: ThresholdsConfig;\n  thresholdsType?: GraphThresholdsStyleMode;\n  onChangeThreshold?: (thresholds: ThresholdsConfig, index: number) => void;\n  condition: string | null;\n  onSetCondition: (refId: string) => void;\n  onChangeQueryOptions: (options: AlertQueryOptions, index: number) => void;\n}\n\nexport const QueryWrapper = ({\n  data,\n  error,\n  dsSettings,\n  index,\n  onChangeDataSource,\n  onChangeQuery,\n  onChangeTimeRange,\n  onRunQueries,\n  onRemoveQuery,\n  onDuplicateQuery,\n  query,\n  queries,\n  thresholds,\n  thresholdsType,\n  onChangeThreshold,\n  condition,\n  onSetCondition,\n  onChangeQueryOptions,\n}: Props) => {\n  const styles = useStyles2(getStyles);\n  const [dsInstance, setDsInstance] = useState<DataSourceApi>();\n  const defaults = dsInstance?.getDefaultQuery ? dsInstance.getDefaultQuery(CoreApp.UnifiedAlerting) : {};\n\n  const { getValues } = useFormContext<RuleFormValues>();\n  const isSwitchModeEnabled = config.featureToggles.alertingQueryAndExpressionsStepMode ?? false;\n  const isAdvancedMode = isSwitchModeEnabled ? getValues('editorSettings.simplifiedQueryEditor') !== true : true;\n\n  const queryWithDefaults = {\n    ...defaults,\n    ...cloneDeep(query.model),\n  };\n\n  if (queryWithDefaults.datasource && queryWithDefaults.datasource?.uid !== query.datasourceUid) {\n    logInfo('rule query datasource and datasourceUid mismatch', {\n      queryModelDatasourceUid: queryWithDefaults.datasource?.uid || '',\n      queryDatasourceUid: query.datasourceUid,\n      datasourceType: query.model.datasource?.type || 'unknown type',\n    });\n    // There are occasions when the rule query model datasource UID and the datasourceUid do not match\n    // It's unclear as to why this happens, but we need better visibility on why this happens,\n    // so we log when it does, and make the query model datasource UID match the datasource UID\n    // We already elsewhere work under the assumption that the datasource settings are fetched from the datasourceUid property\n\n    // This check is necessary for some few cases where the datasource might be an string instead of an object\n    // see: https://github.com/grafana/grafana/issues/96040 for more context\n    if (typeof queryWithDefaults.datasource === 'object' && Boolean(queryWithDefaults.datasource)) {\n      queryWithDefaults.datasource.uid = query.datasourceUid;\n    } else {\n      // if the datasource is a string, we need to convert it to an object, and populate the fields from the query model\n      queryWithDefaults.datasource = {};\n      queryWithDefaults.datasource.uid = query.datasourceUid;\n      queryWithDefaults.datasource.type = query.model.datasource?.type;\n      queryWithDefaults.datasource.apiVersion = query.model.datasource?.apiVersion;\n    }\n  }\n\n  function SelectingDataSourceTooltip() {\n    const styles = useStyles2(getStyles);\n    return (\n      <div className={styles.dsTooltip}>\n        <Tooltip\n          content={\n            <Trans i18nKey=\"alerting.selecting-data-source-tooltip.tooltip-content\">\n              Not finding the data source you want? Some data sources are not supported for alerting. Click on the icon\n              for more information.\n            </Trans>\n          }\n        >\n          <Icon\n            name=\"info-circle\"\n            onClick={() =>\n              window.open(\n                ' https://grafana.com/docs/grafana/latest/alerting/fundamentals/data-source-alerting/',\n                '_blank'\n              )\n            }\n          />\n        </Tooltip>\n      </div>\n    );\n  }\n\n  // TODO add a warning label here too when the data looks like time series data and is used as an alert condition\n  function HeaderExtras({\n    query,\n    error,\n    index,\n    isAdvancedMode = true,\n  }: {\n    query: AlertQuery<AlertDataQuery>;\n    error?: Error;\n    index: number;\n    isAdvancedMode?: boolean;\n  }) {\n    const queryOptions: AlertQueryOptions = {\n      maxDataPoints: query.model.maxDataPoints,\n      minInterval: query.model.intervalMs ? msToSingleUnitDuration(query.model.intervalMs) : undefined,\n    };\n    const alertQueryOptions: AlertQueryOptions = {\n      maxDataPoints: queryOptions.maxDataPoints,\n      minInterval: queryOptions.minInterval,\n    };\n\n    const isAlertCondition = condition === query.refId;\n\n    return (\n      <Stack direction=\"row\" alignItems=\"center\" gap={1}>\n        <SelectingDataSourceTooltip />\n        <QueryOptions\n          onChangeTimeRange={onChangeTimeRange}\n          query={query}\n          queryOptions={alertQueryOptions}\n          onChangeQueryOptions={onChangeQueryOptions}\n          index={index}\n        />\n        {isAdvancedMode && (\n          <ExpressionStatusIndicator\n            onSetCondition={() => onSetCondition(query.refId)}\n            isCondition={isAlertCondition}\n          />\n        )}\n      </Stack>\n    );\n  }\n\n  const showVizualisation = data.state !== LoadingState.NotStarted;\n  //  the query editors want the entire array of queries passed as \"DataQuery\" NOT \"AlertQuery\"\n  // TypeScript isn't complaining here because the interfaces just happen to be compatible\n  const editorQueries = cloneDeep(queries.map((query) => query.model));\n  const range = rangeUtil.relativeToTimeRange(query.relativeTimeRange ?? getDefaultRelativeTimeRange());\n\n  return (\n    <Stack direction=\"column\" gap={0.5}>\n      <div className={styles.wrapper}>\n        <QueryEditorRow<AlertDataQuery>\n          hideRefId={!isAdvancedMode}\n          hideActionButtons={!isAdvancedMode}\n          collapsable={false}\n          dataSource={dsSettings}\n          onDataSourceLoaded={setDsInstance}\n          onChangeDataSource={(settings) => onChangeDataSource(settings, index)}\n          id={query.refId}\n          index={index}\n          key={query.refId}\n          data={data}\n          query={queryWithDefaults}\n          onChange={(query) => onChangeQuery(query, index)}\n          onRemoveQuery={onRemoveQuery}\n          onAddQuery={() => onDuplicateQuery(cloneDeep(query))}\n          onRunQuery={onRunQueries}\n          queries={editorQueries}\n          range={range}\n          renderHeaderExtras={() => (\n            <HeaderExtras query={query} index={index} error={error} isAdvancedMode={isAdvancedMode} />\n          )}\n          app={CoreApp.UnifiedAlerting}\n          hideHideQueryButton={true}\n        />\n      </div>\n      {showVizualisation && <VizWrapper data={data} thresholds={thresholds} thresholdsType={thresholdsType} />}\n    </Stack>\n  );\n};\n\nexport const EmptyQueryWrapper = ({ children }: React.PropsWithChildren<{}>) => {\n  const styles = useStyles2(getStyles);\n  return <div className={styles.wrapper}>{children}</div>;\n};\n\nexport function MaxDataPointsOption({\n  options,\n  onChange,\n}: {\n  options: AlertQueryOptions;\n  onChange: (options: AlertQueryOptions) => void;\n}) {\n  const value = options.maxDataPoints ?? '';\n\n  const onMaxDataPointsBlur = (event: ChangeEvent<HTMLInputElement>) => {\n    const maxDataPointsNumber = parseInt(event.target.value, 10);\n\n    const maxDataPoints = isNaN(maxDataPointsNumber) || maxDataPointsNumber === 0 ? undefined : maxDataPointsNumber;\n\n    if (maxDataPoints !== options.maxDataPoints) {\n      onChange({\n        ...options,\n        maxDataPoints,\n      });\n    }\n  };\n\n  return (\n    <InlineField\n      labelWidth={24}\n      label={t('alerting.max-data-points-option.label-max-data-points', 'Max data points')}\n      tooltip={t(\n        'alerting.max-data-points-option.tooltip-max-data-points',\n        'The maximum data points per series. Used directly by some data sources and used in calculation of auto interval. With streaming data this value is used for the rolling buffer.'\n      )}\n    >\n      <Input\n        type=\"number\"\n        width={10}\n        placeholder={DEFAULT_MAX_DATA_POINTS.toString()}\n        spellCheck={false}\n        onBlur={onMaxDataPointsBlur}\n        defaultValue={value}\n      />\n    </InlineField>\n  );\n}\n\nexport function MinIntervalOption({\n  options,\n  onChange,\n}: {\n  options: AlertQueryOptions;\n  onChange: (options: AlertQueryOptions) => void;\n}) {\n  const value = options.minInterval ?? '';\n\n  const onMinIntervalBlur = (event: ChangeEvent<HTMLInputElement>) => {\n    const minInterval = event.target.value;\n    if (minInterval !== value) {\n      onChange({\n        ...options,\n        minInterval,\n      });\n    }\n  };\n\n  return (\n    <InlineField\n      label={t('alerting.min-interval-option.label-interval', 'Interval')}\n      labelWidth={24}\n      tooltip={\n        <Trans i18nKey=\"alerting.min-interval-option.tooltip-interval\">\n          Interval sent to the data source. Recommended to be set to write frequency, for example <code>1m</code> if\n          your data is written every minute.\n        </Trans>\n      }\n    >\n      <Input\n        type=\"text\"\n        width={10}\n        placeholder={DEFAULT_MIN_INTERVAL}\n        spellCheck={false}\n        onBlur={onMinIntervalBlur}\n        defaultValue={value}\n      />\n    </InlineField>\n  );\n}\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  wrapper: css({\n    label: 'AlertingQueryWrapper',\n    marginBottom: theme.spacing(1),\n    border: `1px solid ${theme.colors.border.weak}`,\n    borderRadius: theme.shape.radius.default,\n\n    button: {\n      overflow: 'visible',\n    },\n  }),\n  dsTooltip: css({\n    display: 'flex',\n    alignItems: 'center',\n    '&:hover': {\n      opacity: 0.85,\n      cursor: 'pointer',\n    },\n  }),\n});\n","import { DragDropContext, DropResult, Droppable } from '@hello-pangea/dnd';\nimport { omit } from 'lodash';\nimport { PureComponent, useState } from 'react';\n\nimport {\n  DataSourceInstanceSettings,\n  LoadingState,\n  PanelData,\n  RelativeTimeRange,\n  getDataSourceRef,\n  rangeUtil,\n} from '@grafana/data';\nimport { Trans } from '@grafana/i18n';\nimport { getDataSourceSrv } from '@grafana/runtime';\nimport { DataQuery } from '@grafana/schema';\nimport { Button, Card, Icon, Stack } from '@grafana/ui';\nimport { QueryOperationRow } from 'app/core/components/QueryOperationRow/QueryOperationRow';\nimport { isExpressionQuery } from 'app/features/expressions/guards';\nimport { getDatasourceSrv } from 'app/features/plugins/datasource_srv';\nimport { AlertDataQuery, AlertQuery } from 'app/types/unified-alerting-dto';\n\nimport { getInstantFromDataQuery } from '../../utils/rule-form';\n\nimport { AlertQueryOptions, EmptyQueryWrapper, QueryWrapper } from './QueryWrapper';\nimport { errorFromCurrentCondition, errorFromPreviewData, getThresholdsForQueries } from './util';\n\ninterface Props {\n  // The query configuration\n  queries: AlertQuery[];\n  expressions: AlertQuery[];\n  data: Record<string, PanelData>;\n  onRunQueries: () => void;\n\n  // Query editing\n  onQueriesChange: (queries: AlertQuery[]) => void;\n  onDuplicateQuery: (query: AlertQuery) => void;\n  condition: string | null;\n  onSetCondition: (refId: string) => void;\n}\n\nexport class QueryRows extends PureComponent<Props> {\n  constructor(props: Props) {\n    super(props);\n  }\n\n  onRemoveQuery = (query: DataQuery) => {\n    const { queries, onQueriesChange } = this.props;\n    onQueriesChange(queries.filter((q) => q.refId !== query.refId));\n  };\n\n  onChangeTimeRange = (timeRange: RelativeTimeRange, index: number) => {\n    const { queries, onQueriesChange } = this.props;\n    onQueriesChange(\n      queries.map((item, itemIndex) => {\n        if (itemIndex !== index) {\n          return item;\n        }\n        return {\n          ...item,\n          relativeTimeRange: timeRange,\n        };\n      })\n    );\n  };\n\n  onChangeQueryOptions = (options: AlertQueryOptions, index: number) => {\n    const { queries, onQueriesChange } = this.props;\n    onQueriesChange(\n      queries.map((item, itemIndex) => {\n        if (itemIndex !== index) {\n          return item;\n        }\n        return {\n          ...item,\n          model: {\n            ...item.model,\n            maxDataPoints: options.maxDataPoints,\n            intervalMs: options.minInterval ? rangeUtil.intervalToMs(options.minInterval) : undefined,\n          },\n        };\n      })\n    );\n  };\n\n  onChangeDataSource = (settings: DataSourceInstanceSettings, index: number) => {\n    const { queries, onQueriesChange } = this.props;\n\n    const updatedQueries = queries.map((item, itemIndex) => {\n      if (itemIndex !== index) {\n        return item;\n      }\n\n      const previousSettings = this.getDataSourceSettings(item);\n\n      // Copy model if changing to a datasource of same type.\n      if (settings.type === previousSettings?.type) {\n        return copyModel(item, settings);\n      }\n      return newModel(item, settings);\n    });\n\n    onQueriesChange(updatedQueries);\n  };\n\n  onChangeQuery = (query: DataQuery, index: number) => {\n    const { queries, onQueriesChange } = this.props;\n\n    onQueriesChange(\n      queries.map((item, itemIndex) => {\n        if (itemIndex !== index) {\n          return item;\n        }\n\n        return {\n          ...item,\n          refId: query.refId,\n          queryType: item.model.queryType ?? '',\n          model: {\n            ...item.model,\n            ...query,\n            datasource: query.datasource!,\n          },\n        };\n      })\n    );\n  };\n\n  onDragEnd = (result: DropResult) => {\n    const { queries, onQueriesChange } = this.props;\n\n    if (!result || !result.destination) {\n      return;\n    }\n\n    const startIndex = result.source.index;\n    const endIndex = result.destination.index;\n    if (startIndex === endIndex) {\n      return;\n    }\n\n    const update = Array.from(queries);\n    const [removed] = update.splice(startIndex, 1);\n    update.splice(endIndex, 0, removed);\n    onQueriesChange(update);\n  };\n\n  getDataSourceSettings = (query: AlertQuery): DataSourceInstanceSettings | undefined => {\n    return getDataSourceSrv().getInstanceSettings(query.datasourceUid);\n  };\n\n  render() {\n    const { queries, expressions, condition } = this.props;\n    const thresholdByRefId = getThresholdsForQueries([...queries, ...expressions], condition);\n\n    return (\n      <DragDropContext onDragEnd={this.onDragEnd}>\n        <Droppable droppableId=\"alerting-queries\" direction=\"vertical\">\n          {(provided) => {\n            return (\n              <div ref={provided.innerRef} {...provided.droppableProps}>\n                <Stack direction=\"column\">\n                  {queries.map((query, index) => {\n                    const isCondition = this.props.condition === query.refId;\n                    const data: PanelData = this.props.data?.[query.refId] ?? {\n                      series: [],\n                      state: LoadingState.NotStarted,\n                    };\n                    const dsSettings = this.getDataSourceSettings(query);\n                    let error: Error | undefined = undefined;\n                    if (data && isCondition) {\n                      error = errorFromCurrentCondition(data);\n                    } else if (data) {\n                      error = errorFromPreviewData(data);\n                    }\n\n                    if (!dsSettings) {\n                      return (\n                        <DatasourceNotFound\n                          key={`${query.refId}-${index}`}\n                          index={index}\n                          model={query.model}\n                          onUpdateDatasource={() => {\n                            const defaultDataSource = getDatasourceSrv().getInstanceSettings(null);\n                            if (defaultDataSource) {\n                              this.onChangeDataSource(defaultDataSource, index);\n                            }\n                          }}\n                          onRemoveQuery={() => {\n                            this.onRemoveQuery(query);\n                          }}\n                        />\n                      );\n                    }\n\n                    return (\n                      <QueryWrapper\n                        index={index}\n                        key={query.refId}\n                        dsSettings={dsSettings}\n                        data={data}\n                        error={error}\n                        query={query}\n                        onChangeQuery={this.onChangeQuery}\n                        onRemoveQuery={this.onRemoveQuery}\n                        queries={[...queries, ...expressions]}\n                        onChangeDataSource={this.onChangeDataSource}\n                        onDuplicateQuery={this.props.onDuplicateQuery}\n                        onChangeTimeRange={this.onChangeTimeRange}\n                        onChangeQueryOptions={this.onChangeQueryOptions}\n                        thresholds={thresholdByRefId[query.refId]?.config}\n                        thresholdsType={thresholdByRefId[query.refId]?.mode}\n                        onRunQueries={this.props.onRunQueries}\n                        condition={this.props.condition}\n                        onSetCondition={this.props.onSetCondition}\n                      />\n                    );\n                  })}\n                  {provided.placeholder}\n                </Stack>\n              </div>\n            );\n          }}\n        </Droppable>\n      </DragDropContext>\n    );\n  }\n}\n\nfunction copyModel(item: AlertQuery, settings: DataSourceInstanceSettings): Omit<AlertQuery, 'datasource'> {\n  return {\n    ...item,\n    model: {\n      ...omit(item.model, 'datasource'),\n      datasource: getDataSourceRef(settings),\n    },\n    datasourceUid: settings.uid,\n  };\n}\n\nfunction newModel(item: AlertQuery, settings: DataSourceInstanceSettings): Omit<AlertQuery, 'datasource'> {\n  const isExpression = isExpressionQuery(item);\n  const isInstant = isExpression ? false : getInstantFromDataQuery(item);\n\n  const newQuery: Omit<AlertQuery, 'datasource'> = {\n    refId: item.refId,\n    relativeTimeRange: item.relativeTimeRange,\n    queryType: '',\n    datasourceUid: settings.uid,\n    model: {\n      refId: item.refId,\n      hide: false,\n      datasource: getDataSourceRef(settings),\n    },\n  };\n\n  if (isInstant && !isExpressionQuery(item)) {\n    (newQuery as AlertQuery<AlertDataQuery>).model.instant = isInstant;\n  }\n\n  return newQuery;\n}\n\ninterface DatasourceNotFoundProps {\n  index: number;\n  model: AlertDataQuery;\n  onUpdateDatasource: () => void;\n  onRemoveQuery: () => void;\n}\n\nconst DatasourceNotFound = ({ index, onUpdateDatasource, onRemoveQuery, model }: DatasourceNotFoundProps) => {\n  const refId = model.refId;\n\n  const [showDetails, setShowDetails] = useState<boolean>(false);\n\n  const toggleDetails = () => {\n    setShowDetails((show) => !show);\n  };\n\n  const handleUpdateDatasource = () => {\n    onUpdateDatasource();\n  };\n\n  return (\n    <EmptyQueryWrapper>\n      <QueryOperationRow title={refId} draggable index={index} id={refId} isOpen collapsable={false}>\n        <Card>\n          <Card.Heading>\n            <Trans i18nKey=\"alerting.datasource-not-found.this-datasource-has-been-removed\">\n              This datasource has been removed\n            </Trans>\n          </Card.Heading>\n          <Card.Description>\n            <Trans i18nKey=\"alerting.datasource-not-found.card-description\">\n              The datasource for this query was not found, it was either removed or is not installed correctly.\n            </Trans>\n          </Card.Description>\n          <Card.Figure>\n            <Icon name=\"question-circle\" />\n          </Card.Figure>\n          <Card.Actions>\n            <Button key=\"update\" variant=\"secondary\" onClick={handleUpdateDatasource}>\n              <Trans i18nKey=\"alerting.datasource-not-found.update-datasource\">Update datasource</Trans>\n            </Button>\n            <Button key=\"remove\" variant=\"destructive\" onClick={onRemoveQuery}>\n              <Trans i18nKey=\"alerting.datasource-not-found.remove-query\">Remove query</Trans>\n            </Button>\n          </Card.Actions>\n          <Card.SecondaryActions>\n            <Button\n              key=\"details\"\n              onClick={toggleDetails}\n              icon={showDetails ? 'angle-up' : 'angle-down'}\n              fill=\"text\"\n              size=\"sm\"\n            >\n              <Trans i18nKey=\"alerting.datasource-not-found.show-details\">Show details</Trans>\n            </Button>\n          </Card.SecondaryActions>\n        </Card>\n        {showDetails && (\n          <div>\n            <pre>\n              <code>{JSON.stringify(model, null, 2)}</code>\n            </pre>\n          </div>\n        )}\n      </QueryOperationRow>\n    </EmptyQueryWrapper>\n  );\n};\n","import { css } from '@emotion/css';\n\nimport { GrafanaTheme2, PanelData } from '@grafana/data';\nimport { useStyles2 } from '@grafana/ui';\nimport { AlertQuery } from 'app/types/unified-alerting-dto';\n\nimport { QueryRows } from './QueryRows';\n\ninterface Props {\n  panelData: Record<string, PanelData>;\n  queries: AlertQuery[];\n  expressions: AlertQuery[];\n  onRunQueries: () => void;\n  onChangeQueries: (queries: AlertQuery[]) => void;\n  onDuplicateQuery: (query: AlertQuery) => void;\n  condition: string | null;\n  onSetCondition: (refId: string) => void;\n}\n\nexport const QueryEditor = ({\n  queries,\n  expressions,\n  panelData,\n  onRunQueries,\n  onChangeQueries,\n  onDuplicateQuery,\n  condition,\n  onSetCondition,\n}: Props) => {\n  const styles = useStyles2(getStyles);\n\n  return (\n    <div className={styles.container}>\n      <QueryRows\n        data={panelData}\n        queries={queries}\n        expressions={expressions}\n        onRunQueries={onRunQueries}\n        onQueriesChange={onChangeQueries}\n        onDuplicateQuery={onDuplicateQuery}\n        condition={condition}\n        onSetCondition={onSetCondition}\n      />\n    </div>\n  );\n};\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  container: css({\n    backgroundColor: theme.colors.background.primary,\n    height: '100%',\n  }),\n});\n","import { css } from '@emotion/css';\nimport { FC, useCallback, useEffect, useState } from 'react';\nimport { useAsync } from 'react-use';\n\nimport { CoreApp, GrafanaTheme2, LoadingState, PanelData } from '@grafana/data';\nimport { Trans } from '@grafana/i18n';\nimport { getDataSourceSrv } from '@grafana/runtime';\nimport { DataQuery } from '@grafana/schema';\nimport { useStyles2 } from '@grafana/ui';\nimport { DataSourceType } from 'app/features/alerting/unified/utils/datasource';\nimport { getTimeSrv } from 'app/features/dashboard/services/TimeSrv';\nimport { QueryErrorAlert } from 'app/features/query/components/QueryErrorAlert';\nimport { LokiQueryType } from 'app/plugins/datasource/loki/dataquery.gen';\nimport { AlertQuery } from 'app/types/unified-alerting-dto';\n\nimport { isPromOrLokiQuery } from '../../utils/rule-form';\n\nimport { VizWrapper } from './VizWrapper';\n\nexport interface RecordingRuleEditorProps {\n  queries: AlertQuery[];\n  onChangeQuery: (updatedQueries: AlertQuery[]) => void;\n  runQueries: () => void;\n  panelData: Record<string, PanelData>;\n  dataSourceName: string;\n}\n\nexport const RecordingRuleEditor: FC<RecordingRuleEditorProps> = ({\n  queries,\n  onChangeQuery,\n  runQueries,\n  panelData,\n  dataSourceName,\n}) => {\n  const [data, setData] = useState<PanelData>({\n    series: [],\n    state: LoadingState.NotStarted,\n    timeRange: getTimeSrv().timeRange(),\n  });\n\n  const styles = useStyles2(getStyles);\n\n  useEffect(() => {\n    setData(panelData?.[queries[0]?.refId]);\n  }, [panelData, queries]);\n\n  const {\n    error,\n    loading,\n    value: dataSource,\n  } = useAsync(() => {\n    return getDataSourceSrv().get(dataSourceName);\n  }, [dataSourceName]);\n\n  const handleChangedQuery = useCallback(\n    (changedQuery: DataQuery) => {\n      if (!isPromOrLokiQuery(changedQuery) || !dataSource) {\n        return;\n      }\n\n      const [query] = queries;\n      const { uid: dataSourceId, type } = dataSource;\n      const isLoki = type === DataSourceType.Loki;\n      const expr = changedQuery.expr;\n\n      const merged = {\n        ...query,\n        ...changedQuery,\n        datasourceUid: dataSourceId,\n        expr,\n        model: {\n          expr,\n          datasource: changedQuery.datasource,\n          refId: changedQuery.refId,\n          editorMode: changedQuery.editorMode,\n          // Instant and range are used by Prometheus queries\n          instant: changedQuery.instant,\n          range: changedQuery.range,\n          // Query type is used by Loki queries\n          // On first render/when creating a recording rule, the query type is not set\n          // unless the user has changed it betwee range/instant. The cleanest way to handle this\n          // is to default to instant, or whatever the changed type is\n          queryType: isLoki ? changedQuery.queryType || LokiQueryType.Instant : changedQuery.queryType,\n          legendFormat: changedQuery.legendFormat,\n        },\n      };\n      onChangeQuery([merged]);\n    },\n    [dataSource, queries, onChangeQuery]\n  );\n\n  if (loading || dataSource?.name !== dataSourceName) {\n    return null;\n  }\n\n  const dsi = getDataSourceSrv().getInstanceSettings(dataSourceName);\n\n  if (error || !dataSource || !dataSource?.components?.QueryEditor || !dsi) {\n    const errorMessage = error?.message || 'Data source plugin does not export any Query Editor component';\n    return (\n      <div>\n        <Trans i18nKey=\"alerting.recording-rule-editor.error-no-query-editor\">\n          Could not load query editor due to: {{ errorMessage }}\n        </Trans>\n      </div>\n    );\n  }\n\n  const QueryEditor = dataSource.components.QueryEditor;\n\n  return (\n    <>\n      {queries.length && (\n        <>\n          <QueryEditor\n            query={queries[0]}\n            queries={queries}\n            app={CoreApp.UnifiedAlerting}\n            onChange={handleChangedQuery}\n            onRunQuery={runQueries}\n            datasource={dataSource}\n          />\n          {(data?.errors || []).map((err) => {\n            return <QueryErrorAlert key={err.message} error={err} />;\n          })}\n        </>\n      )}\n\n      {data && (\n        <div className={styles.vizWrapper}>\n          <VizWrapper data={data} />\n        </div>\n      )}\n    </>\n  );\n};\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  vizWrapper: css({\n    margin: theme.spacing(1, 0),\n  }),\n});\n","import { css } from '@emotion/css';\nimport { Controller, useFormContext } from 'react-hook-form';\n\nimport { DataSourceInstanceSettings, GrafanaTheme2 } from '@grafana/data';\nimport { t } from '@grafana/i18n';\nimport { Field, useStyles2 } from '@grafana/ui';\n\nimport { RuleFormType, RuleFormValues } from '../../../types/rule-form';\nimport { CloudRulesSourcePicker } from '../CloudRulesSourcePicker';\n\nexport interface CloudDataSourceSelectorProps {\n  disabled?: boolean;\n  onChangeCloudDatasource: (datasourceUid: string) => void;\n}\nexport const CloudDataSourceSelector = ({ disabled, onChangeCloudDatasource }: CloudDataSourceSelectorProps) => {\n  const {\n    control,\n    formState: { errors },\n    setValue,\n    watch,\n  } = useFormContext<RuleFormValues>();\n\n  const styles = useStyles2(getStyles);\n\n  const ruleFormType = watch('type');\n\n  return (\n    <div className={styles.flexRow}>\n      {(ruleFormType === RuleFormType.cloudAlerting || ruleFormType === RuleFormType.cloudRecording) && (\n        <Field\n          className={styles.formInput}\n          label={\n            disabled\n              ? t('alerting.cloud-data-source-selector.label-disabled', 'Data source')\n              : t('alerting.cloud-data-source-selector.label', 'Select data source')\n          }\n          error={errors.dataSourceName?.message}\n          invalid={!!errors.dataSourceName?.message}\n        >\n          <Controller\n            render={({ field: { onChange, ref, ...field } }) => (\n              <CloudRulesSourcePicker\n                {...field}\n                disabled={disabled}\n                onChange={(ds: DataSourceInstanceSettings) => {\n                  // reset expression as they don't need to persist after changing datasources\n                  setValue('expression', '');\n                  onChange(ds?.name ?? null);\n                  onChangeCloudDatasource(ds?.uid ?? null);\n                }}\n              />\n            )}\n            name=\"dataSourceName\"\n            control={control}\n            rules={{\n              required: {\n                value: true,\n                message: t(\n                  'alerting.cloud-data-source-selector.message.please-select-a-data-source',\n                  'Please select a data source'\n                ),\n              },\n            }}\n          />\n        </Field>\n      )}\n    </div>\n  );\n};\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  formInput: css({\n    width: '330px',\n    '& + &': {\n      marginLeft: theme.spacing(3),\n    },\n  }),\n  flexRow: css({\n    display: 'flex',\n    flexDirection: 'row',\n    justifyContent: 'flex-start',\n    alignItems: 'flex-end',\n  }),\n});\n","import { createAction, createReducer, original } from '@reduxjs/toolkit';\n\nimport {\n  ReducerID,\n  RelativeTimeRange,\n  getDataSourceRef,\n  getDefaultRelativeTimeRange,\n  getNextRefId,\n  rangeUtil,\n} from '@grafana/data';\nimport { DataQuery } from '@grafana/schema';\nimport { dataSource as expressionDatasource } from 'app/features/expressions/ExpressionDatasource';\nimport { isExpressionQuery } from 'app/features/expressions/guards';\nimport { ExpressionDatasourceUID, ExpressionQuery, ExpressionQueryType } from 'app/features/expressions/types';\nimport {\n  defaultCondition,\n  isReducerExpression,\n  isThresholdExpression,\n} from 'app/features/expressions/utils/expressionTypes';\nimport { AlertQuery } from 'app/types/unified-alerting-dto';\n\nimport { logError } from '../../../Analytics';\nimport { getDefaultOrFirstCompatibleDataSource } from '../../../utils/datasource';\nimport { getDefaultQueries, getInstantFromDataQuery } from '../../../utils/rule-form';\nimport { createDagFromQueries, getOriginOfRefId } from '../dag';\nimport { queriesWithUpdatedReferences, refIdExists } from '../util';\n\n// this one will be used as the refID when we create a new reducer for the threshold expression\nexport const NEW_REDUCER_REF = 'reducer';\n\nexport interface QueriesAndExpressionsState {\n  queries: AlertQuery[];\n}\n\nconst findDataSourceFromExpression = (queries: AlertQuery[], refId: string): AlertQuery | undefined => {\n  const dag = createDagFromQueries(queries);\n  const dataSource = getOriginOfRefId(refId, dag)[0];\n  if (!dataSource) {\n    return;\n  }\n\n  const originQuery = queries.find((query) => query.refId === dataSource);\n  if (originQuery && 'relativeTimeRange' in originQuery) {\n    return originQuery;\n  }\n\n  return;\n};\n\nconst initialState: QueriesAndExpressionsState = {\n  queries: [],\n};\n\nexport const duplicateQuery = createAction<AlertQuery>('duplicateQuery');\nexport const addNewDataQuery = createAction('addNewDataQuery');\nexport const setDataQueries = createAction<AlertQuery[]>('setDataQueries');\n\nexport const addNewExpression = createAction<ExpressionQueryType>('addNewExpression');\nexport const removeExpression = createAction<string>('removeExpression');\nexport const removeExpressions = createAction('removeExpressions');\nexport const addExpressions = createAction<AlertQuery[]>('addExpressions');\nexport const updateExpression = createAction<ExpressionQuery>('updateExpression');\nexport const updateExpressionRefId = createAction<{ oldRefId: string; newRefId: string }>('updateExpressionRefId');\nexport const rewireExpressions = createAction<{ oldRefId: string; newRefId: string }>('rewireExpressions');\nexport const updateExpressionType = createAction<{ refId: string; type: ExpressionQueryType }>('updateExpressionType');\nexport const updateExpressionTimeRange = createAction('updateExpressionTimeRange');\nexport const updateMaxDataPoints = createAction<{ refId: string; maxDataPoints: number }>('updateMaxDataPoints');\nexport const updateMinInterval = createAction<{ refId: string; minInterval: string }>('updateMinInterval');\n\nexport const resetToSimpleCondition = createAction('resetToSimpleCondition');\nexport const optimizeReduceExpression = createAction<{\n  updatedQueries: AlertQuery[];\n  expressionQueries: Array<AlertQuery<ExpressionQuery>>;\n}>('optimizeReduceExpression');\nexport const setRecordingRulesQueries = createAction<{ recordingRuleQueries: AlertQuery[]; expression: string }>(\n  'setRecordingRulesQueries'\n);\n\nexport const queriesAndExpressionsReducer = createReducer(initialState, (builder) => {\n  // data queries actions\n  builder\n    // simple condition actions\n    .addCase(resetToSimpleCondition, (state) => {\n      state.queries = getDefaultQueries();\n    })\n    .addCase(duplicateQuery, (state, { payload }) => {\n      state.queries = addQuery(state.queries, payload);\n    })\n    .addCase(addNewDataQuery, (state) => {\n      const datasource = getDefaultOrFirstCompatibleDataSource();\n      if (!datasource) {\n        return;\n      }\n\n      state.queries = addQuery(state.queries, {\n        datasourceUid: datasource.uid,\n        model: {\n          refId: '',\n          datasource: getDataSourceRef(datasource),\n        },\n      });\n    })\n    .addCase(setDataQueries, (state, { payload }) => {\n      const expressionQueries = state.queries.filter((query) => isExpressionQuery(query.model));\n      state.queries = [...payload, ...expressionQueries];\n    })\n    .addCase(setRecordingRulesQueries, (state, { payload }) => {\n      const query = payload.recordingRuleQueries[0];\n      const recordingRuleQuery = {\n        ...query,\n        ...{ expr: payload.expression, model: query?.model },\n      };\n\n      state.queries = [recordingRuleQuery];\n    })\n    .addCase(updateMaxDataPoints, (state, action) => {\n      state.queries = state.queries.map((query) => {\n        return query.refId === action.payload.refId\n          ? {\n              ...query,\n              model: {\n                ...query.model,\n                maxDataPoints: action.payload.maxDataPoints,\n              },\n            }\n          : query;\n      });\n    })\n    .addCase(updateMinInterval, (state, action) => {\n      state.queries = state.queries.map((query) => {\n        return query.refId === action.payload.refId\n          ? {\n              ...query,\n              model: {\n                ...query.model,\n                intervalMs: action.payload.minInterval ? rangeUtil.intervalToMs(action.payload.minInterval) : undefined,\n              },\n            }\n          : query;\n      });\n    });\n\n  // expressions actions\n  builder\n    .addCase(addNewExpression, (state, { payload }) => {\n      state.queries = addQuery(state.queries, {\n        datasourceUid: ExpressionDatasourceUID,\n        model: expressionDatasource.newQuery({\n          type: payload,\n          conditions: [{ ...defaultCondition, query: { params: [] } }],\n          expression: '',\n        }),\n      });\n    })\n    .addCase(removeExpression, (state, { payload }) => {\n      state.queries = state.queries.filter((query) => query.refId !== payload);\n    })\n    .addCase(removeExpressions, (state) => {\n      state.queries = state.queries.filter((query) => !isExpressionQuery(query.model));\n    })\n    .addCase(addExpressions, (state, { payload }) => {\n      state.queries = [...state.queries, ...payload];\n    })\n    .addCase(updateExpression, (state, { payload }) => {\n      const queryToUpdate = state.queries.find((query) => query.refId === payload.refId);\n      if (!queryToUpdate) {\n        return;\n      }\n\n      queryToUpdate.model = payload;\n\n      // the resample expression needs to also know what the relative time range is to work with, this means we have to copy it from the source node (data source query)\n      if (payload.type === ExpressionQueryType.resample && payload.expression) {\n        // findDataSourceFromExpression uses memoization and it doesn't always work with proxies when the proxy has been revoked\n        const originalQueries = original(state)?.queries ?? [];\n\n        let relativeTimeRange = getDefaultRelativeTimeRange();\n        try {\n          const dataSourceAlertQuery = findDataSourceFromExpression(originalQueries, payload.expression);\n          if (dataSourceAlertQuery?.relativeTimeRange) {\n            relativeTimeRange = dataSourceAlertQuery.relativeTimeRange;\n          }\n        } catch (error) {\n          if (error instanceof Error) {\n            logError(error);\n          } else {\n            logError(new Error('Error while trying to find data source from expression'));\n          }\n        }\n\n        queryToUpdate.relativeTimeRange = relativeTimeRange;\n      }\n    })\n    .addCase(updateExpressionTimeRange, (state) => {\n      state.queries.forEach((query) => {\n        // Resample expression needs to get the relativeTimeRange with its dataSource relativeTimeRange\n        if (\n          isExpressionQuery(query.model) &&\n          query.model.type === ExpressionQueryType.resample &&\n          query.model.expression\n        ) {\n          // findDataSourceFromExpression uses memoization and doesn't work with proxies\n          const originalQueries = original(state)?.queries ?? [];\n\n          const dataSource = findDataSourceFromExpression(originalQueries, query.model.expression);\n          const relativeTimeRange = dataSource ? dataSource.relativeTimeRange : getDefaultRelativeTimeRange();\n          query.relativeTimeRange = relativeTimeRange;\n        }\n      });\n    })\n    .addCase(updateExpressionRefId, (state, { payload }) => {\n      const { newRefId, oldRefId } = payload;\n\n      // if the new refId already exists we just refuse to update the state\n      const newRefIdExists = refIdExists(state.queries, newRefId);\n      if (newRefIdExists) {\n        return;\n      }\n\n      const updatedQueries = queriesWithUpdatedReferences(state.queries, oldRefId, newRefId);\n      state.queries = updatedQueries.map((query) => {\n        if (query.refId === oldRefId) {\n          return {\n            ...query,\n            refId: newRefId,\n            model: {\n              ...query.model,\n              refId: newRefId,\n            },\n          };\n        }\n\n        return query;\n      });\n    })\n    .addCase(rewireExpressions, (state, { payload }) => {\n      state.queries = queriesWithUpdatedReferences(state.queries, payload.oldRefId, payload.newRefId);\n    })\n    // removes the reduce expression when we have a instant data query\n    .addCase(optimizeReduceExpression, (state, { payload }) => {\n      const { updatedQueries, expressionQueries } = payload;\n\n      if (updatedQueries.length !== 1) {\n        // we only optimize when we have one data query\n        return;\n      }\n\n      const dataQuery = updatedQueries.at(0);\n      const isInstantDataQuery = dataQuery ? getInstantFromDataQuery(dataQuery) : false;\n\n      const shouldRemoveReducer = isInstantDataQuery && expressionQueries.length === 2;\n      if (shouldRemoveReducer) {\n        const reduceExpressionIndex = state.queries.findIndex(\n          (query) =>\n            isExpressionQuery(query.model) &&\n            isReducerExpression(query.model) &&\n            query.model.expression === dataQuery?.refId\n        );\n\n        state.queries.splice(reduceExpressionIndex, 1);\n        state.queries[1].model.expression = dataQuery?.refId;\n      }\n\n      const shouldAddReduceExpression =\n        !isInstantDataQuery && expressionQueries.length === 1 && isThresholdExpression(expressionQueries[0].model);\n      if (shouldAddReduceExpression) {\n        // add reducer to the second position\n        // we only update the refid and the model to point to the reducer expression\n        state.queries[1].model.expression = NEW_REDUCER_REF;\n\n        // insert in second position the reducer expression\n        state.queries.splice(1, 0, {\n          datasourceUid: ExpressionDatasourceUID,\n          model: expressionDatasource.newQuery({\n            type: ExpressionQueryType.reduce,\n            reducer: ReducerID.last,\n            conditions: [{ ...defaultCondition, query: { params: [] } }],\n            expression: dataQuery?.refId,\n            refId: NEW_REDUCER_REF,\n          }),\n          refId: NEW_REDUCER_REF,\n          queryType: 'expression',\n        });\n      }\n    })\n    .addCase(updateExpressionType, (state, action) => {\n      state.queries = state.queries.map((query) => {\n        return query.refId === action.payload.refId\n          ? {\n              ...query,\n              model: {\n                ...expressionDatasource.newQuery({\n                  type: action.payload.type,\n                  conditions: [{ ...defaultCondition, query: { params: [] } }],\n                  expression: '',\n                }),\n                refId: action.payload.refId,\n              },\n            }\n          : query;\n      });\n    });\n});\n\nconst addQuery = (\n  queries: AlertQuery[],\n  queryToAdd: Pick<AlertQuery, 'model' | 'datasourceUid' | 'relativeTimeRange'>\n): AlertQuery[] => {\n  const refId = getNextRefId(queries);\n  const query: AlertQuery = {\n    ...queryToAdd,\n    refId,\n    queryType: '',\n    model: {\n      ...queryToAdd.model,\n      hide: false,\n      refId,\n    },\n    relativeTimeRange: queryToAdd.relativeTimeRange ?? defaultTimeRange(queryToAdd.model),\n  };\n\n  return [...queries, query];\n};\n\nconst defaultTimeRange = (model: DataQuery): RelativeTimeRange | undefined => {\n  if (isExpressionQuery(model)) {\n    return;\n  }\n\n  return getDefaultRelativeTimeRange();\n};\n","import { css } from '@emotion/css';\nimport { produce } from 'immer';\nimport { Dispatch, FormEvent } from 'react';\nimport { UnknownAction } from 'redux';\n\nimport { GrafanaTheme2, PanelData, ReducerID, SelectableValue } from '@grafana/data';\nimport { Trans, t } from '@grafana/i18n';\nimport { InlineField, InlineFieldRow, Input, Select, Stack, Text, useStyles2 } from '@grafana/ui';\nimport { EvalFunction } from 'app/features/alerting/state/alertDef';\nimport { ThresholdSelect } from 'app/features/expressions/components/ThresholdSelect';\nimport { ExpressionQuery, ExpressionQueryType, reducerTypes, thresholdFunctions } from 'app/features/expressions/types';\nimport { getReducerType, isRangeEvaluator } from 'app/features/expressions/utils/expressionTypes';\nimport { AlertQuery } from 'app/types/unified-alerting-dto';\n\nimport { ToLabel } from '../../../../../expressions/components/ToLabel';\nimport { ExpressionResult } from '../../expressions/Expression';\n\nimport { updateExpression } from './reducer';\n\nexport interface SimpleCondition {\n  whenField?: string;\n  evaluator: {\n    params: number[];\n    type: EvalFunction;\n  };\n}\n\n/**\n * This is the simple condition editor if the user is in the simple mode in the query section\n */\nexport interface SimpleConditionEditorProps {\n  simpleCondition: SimpleCondition;\n  onChange: (condition: SimpleCondition) => void;\n  expressionQueriesList: Array<AlertQuery<ExpressionQuery>>;\n  dispatch: Dispatch<UnknownAction>;\n  previewData?: PanelData;\n}\n\n/**\n *\n * This represents the simple condition editor for the alerting query section\n * The state for this simple condition is kept in the parent component\n * But we have also to keep the reducer state in sync with this condition state (both kept in the parent)\n */\n\nexport const SimpleConditionEditor = ({\n  simpleCondition,\n  onChange,\n  expressionQueriesList,\n  dispatch,\n  previewData,\n}: SimpleConditionEditorProps) => {\n  const onReducerTypeChange = (value: SelectableValue<string>) => {\n    onChange({ ...simpleCondition, whenField: value.value ?? ReducerID.last });\n    updateReduceExpression(value.value ?? ReducerID.last, expressionQueriesList, dispatch);\n  };\n\n  const isRange = isRangeEvaluator(simpleCondition.evaluator.type);\n\n  const thresholdFunction = thresholdFunctions.find((fn) => fn.value === simpleCondition.evaluator?.type);\n\n  const onEvalFunctionChange = (value: SelectableValue<EvalFunction>) => {\n    // change the condition kept in the parent\n    onChange({\n      ...simpleCondition,\n      evaluator: { ...simpleCondition.evaluator, type: value.value ?? EvalFunction.IsAbove },\n    });\n    // update the reducer state where we store the queries\n    updateThresholdFunction(value.value ?? EvalFunction.IsAbove, expressionQueriesList, dispatch);\n  };\n\n  const onEvaluateValueChange = (event: FormEvent<HTMLInputElement>, index = 0) => {\n    const value = event.currentTarget.value;\n    const numericValue = parseFloat(value) || 0; // try to convert input to a number that isn't NaN\n\n    onChange(\n      produce(simpleCondition, (draftCondition) => {\n        draftCondition.evaluator.params[index] = numericValue;\n      })\n    );\n\n    updateThresholdValue(numericValue, index, expressionQueriesList, dispatch);\n  };\n\n  const styles = useStyles2(getStyles);\n\n  return (\n    <div className={styles.condition.wrapper}>\n      <Stack direction=\"column\" gap={0} width=\"100%\">\n        <header className={styles.condition.header}>\n          <Text variant=\"body\">\n            <Trans i18nKey=\"alerting.simpleCondition.alertCondition\">Alert condition</Trans>\n          </Text>\n        </header>\n        <InlineFieldRow className={styles.condition.container}>\n          {simpleCondition.whenField && (\n            <InlineField label={t('alerting.simple-condition-editor.label-when', 'WHEN')}>\n              <Select\n                options={reducerTypes}\n                value={reducerTypes.find((o) => o.value === simpleCondition.whenField)}\n                onChange={onReducerTypeChange}\n                width={20}\n              />\n            </InlineField>\n          )}\n          <InlineField\n            label={\n              simpleCondition.whenField\n                ? t('alerting.simple-condition-editor.label-of-query', 'OF QUERY')\n                : t('alerting.simple-condition-editor.label-when-query', 'WHEN QUERY')\n            }\n          >\n            <Stack direction=\"row\" gap={1} alignItems=\"center\">\n              <ThresholdSelect onChange={onEvalFunctionChange} value={thresholdFunction} />\n              {isRange ? (\n                <>\n                  <Input\n                    type=\"number\"\n                    width={10}\n                    // by using the key prop we can force the input to re-render whenever the defaultValue updates\n                    // this is because we have a useEffect() that updates the data structure but \"defaultValue\" will memoize the\n                    // first value before the useEffect() runs\n                    key={simpleCondition.evaluator.params[0]}\n                    defaultValue={simpleCondition.evaluator.params[0] ?? ''}\n                    onBlur={(event) => {\n                      onEvaluateValueChange(event, 0);\n                    }}\n                  />\n                  <ToLabel />\n                  <Input\n                    type=\"number\"\n                    width={10}\n                    key={simpleCondition.evaluator.params[1]}\n                    defaultValue={simpleCondition.evaluator.params[1] ?? ''}\n                    onBlur={(event) => {\n                      onEvaluateValueChange(event, 1);\n                    }}\n                  />\n                </>\n              ) : (\n                <Input\n                  type=\"number\"\n                  width={10}\n                  key={simpleCondition.evaluator.params[0]}\n                  defaultValue={simpleCondition.evaluator.params[0] ?? ''}\n                  onBlur={(event) => {\n                    onEvaluateValueChange(event, 0);\n                  }}\n                />\n              )}\n            </Stack>\n          </InlineField>\n        </InlineFieldRow>\n        {previewData?.series && <ExpressionResult series={previewData?.series} isAlertCondition={true} />}\n      </Stack>\n    </div>\n  );\n};\n\nfunction updateReduceExpression(\n  reducer: string,\n  expressionQueriesList: Array<AlertQuery<ExpressionQuery>>,\n  dispatch: Dispatch<UnknownAction>\n) {\n  // 1. make sure have have a reduce expression and that it is pointing to the data query\n  const reduceExpression = expressionQueriesList.find((query) => query.model.type === ExpressionQueryType.reduce);\n\n  const newReduceExpression = reduceExpression\n    ? produce(reduceExpression?.model, (draft) => {\n        if (draft && draft.conditions) {\n          draft.reducer = reducer;\n          draft.conditions[0].reducer.type = getReducerType(reducer) ?? ReducerID.last;\n        }\n      })\n    : undefined;\n  newReduceExpression && dispatch(updateExpression(newReduceExpression));\n}\n\nfunction updateThresholdFunction(\n  evaluator: EvalFunction,\n  expressionQueriesList: Array<AlertQuery<ExpressionQuery>>,\n  dispatch: Dispatch<UnknownAction>\n) {\n  const thresholdExpression = expressionQueriesList.find((query) => query.model.type === ExpressionQueryType.threshold);\n\n  const newThresholdExpression = produce(thresholdExpression, (draft) => {\n    if (draft && draft.model.conditions) {\n      draft.model.conditions[0].evaluator.type = evaluator;\n    }\n  });\n  newThresholdExpression && dispatch(updateExpression(newThresholdExpression.model));\n}\n\nfunction updateThresholdValue(\n  value: number,\n  index: number,\n  expressionQueriesList: Array<AlertQuery<ExpressionQuery>>,\n  dispatch: Dispatch<UnknownAction>\n) {\n  const thresholdExpression = expressionQueriesList.find((query) => query.model.type === ExpressionQueryType.threshold);\n\n  const newThresholdExpression = produce(thresholdExpression, (draft) => {\n    if (draft && draft.model.conditions) {\n      draft.model.conditions[0].evaluator.params[index] = value;\n    }\n  });\n  newThresholdExpression && dispatch(updateExpression(newThresholdExpression.model));\n}\n\nexport function getSimpleConditionFromExpressions(expressions: Array<AlertQuery<ExpressionQuery>>): SimpleCondition {\n  const reduceExpression = expressions.find((query) => query.model.type === ExpressionQueryType.reduce);\n  const thresholdExpression = expressions.find((query) => query.model.type === ExpressionQueryType.threshold);\n  const conditionsFromThreshold = thresholdExpression?.model.conditions ?? [];\n  const whenField = reduceExpression?.model.reducer;\n  const params = conditionsFromThreshold[0]?.evaluator?.params\n    ? [...conditionsFromThreshold[0]?.evaluator?.params]\n    : [0];\n  const type = conditionsFromThreshold[0]?.evaluator?.type ?? EvalFunction.IsAbove;\n\n  return {\n    whenField: whenField,\n    evaluator: {\n      params: params,\n      type: type,\n    },\n  };\n}\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  buttonSelectText: css({\n    color: theme.colors.primary.text,\n    fontSize: theme.typography.bodySmall.fontSize,\n    textTransform: 'uppercase',\n    padding: `0 ${theme.spacing(1)}`,\n  }),\n  condition: {\n    wrapper: css({\n      display: 'flex',\n      border: `solid 1px ${theme.colors.border.medium}`,\n      flex: 1,\n      height: 'fit-content',\n      borderRadius: theme.shape.radius.default,\n    }),\n    container: css({\n      display: 'flex',\n      flexDirection: 'row',\n      padding: theme.spacing(1),\n      flex: 1,\n      width: '100%',\n    }),\n    header: css({\n      background: theme.colors.background.secondary,\n      padding: `${theme.spacing(0.5)} ${theme.spacing(1)}`,\n      borderBottom: `solid 1px ${theme.colors.border.weak}`,\n      flex: 1,\n    }),\n  },\n});\n","import { DataSourceInstanceSettings } from '@grafana/data';\nimport { DataSourceJsonData } from '@grafana/schema/dist/esm/index';\nimport { contextSrv } from 'app/core/core';\nimport { ExpressionDatasourceUID } from 'app/features/expressions/types';\nimport { AccessControlAction } from 'app/types/accessControl';\nimport { AlertQuery } from 'app/types/unified-alerting-dto';\n\nimport { RuleFormType } from '../../../types/rule-form';\n\nexport const onlyOneDSInQueries = (queries: AlertQuery[]) => {\n  return queries.filter((q) => q.datasourceUid !== ExpressionDatasourceUID).length === 1;\n};\n\nfunction getAvailableRuleTypes() {\n  const canCreateGrafanaRules = contextSrv.hasPermission(AccessControlAction.AlertingRuleCreate);\n  const canCreateCloudRules = contextSrv.hasPermission(AccessControlAction.AlertingRuleExternalWrite);\n  const defaultRuleType = canCreateGrafanaRules ? RuleFormType.grafana : RuleFormType.cloudAlerting;\n\n  const enabledRuleTypes: RuleFormType[] = [];\n  if (canCreateGrafanaRules) {\n    enabledRuleTypes.push(RuleFormType.grafana);\n  }\n  if (canCreateCloudRules) {\n    enabledRuleTypes.push(RuleFormType.cloudAlerting, RuleFormType.cloudRecording);\n  }\n\n  return { enabledRuleTypes, defaultRuleType };\n}\n\nexport const getCanSwitch = ({\n  queries,\n  ruleFormType,\n  rulesSourcesWithRuler,\n}: {\n  rulesSourcesWithRuler: Array<DataSourceInstanceSettings<DataSourceJsonData>>;\n  queries: AlertQuery[];\n  ruleFormType: RuleFormType | undefined;\n}) => {\n  // get available rule types\n  const availableRuleTypes = getAvailableRuleTypes();\n\n  // check if we have only one query in queries and if it's a cloud datasource\n  const onlyOneDS = onlyOneDSInQueries(queries);\n  const dataSourceIdFromQueries = queries[0]?.datasourceUid ?? '';\n  const isRecordingRuleType = ruleFormType === RuleFormType.cloudRecording;\n\n  //let's check if we switch to cloud type\n  const canSwitchToCloudRule =\n    !isRecordingRuleType &&\n    onlyOneDS &&\n    rulesSourcesWithRuler.some((dsJsonData) => dsJsonData.uid === dataSourceIdFromQueries);\n\n  const canSwitchToGrafanaRule = !isRecordingRuleType;\n  // check for enabled types\n  const grafanaTypeEnabled = availableRuleTypes.enabledRuleTypes.includes(RuleFormType.grafana);\n  const cloudTypeEnabled = availableRuleTypes.enabledRuleTypes.includes(RuleFormType.cloudAlerting);\n\n  // can we switch to the other type? (cloud or grafana)\n  const canSwitchFromCloudToGrafana =\n    ruleFormType === RuleFormType.cloudAlerting && grafanaTypeEnabled && canSwitchToGrafanaRule;\n  const canSwitchFromGrafanaToCloud =\n    ruleFormType === RuleFormType.grafana && canSwitchToCloudRule && cloudTypeEnabled && canSwitchToCloudRule;\n\n  return canSwitchFromCloudToGrafana || canSwitchFromGrafanaToCloud;\n};\n","import { useFormContext } from 'react-hook-form';\n\nimport { DataSourceInstanceSettings } from '@grafana/data';\nimport { Trans, t } from '@grafana/i18n';\nimport { DataSourceJsonData } from '@grafana/schema';\nimport { RadioButtonGroup, Stack, Text } from '@grafana/ui';\nimport { AlertQuery } from 'app/types/unified-alerting-dto';\n\nimport { RuleFormType, RuleFormValues } from '../../../types/rule-form';\nimport { NeedHelpInfo } from '../NeedHelpInfo';\n\nimport { getCanSwitch } from './utils';\n\ninterface SmartAlertTypeDetectorProps {\n  editingExistingRule: boolean;\n  rulesSourcesWithRuler: Array<DataSourceInstanceSettings<DataSourceJsonData>>;\n  queries: AlertQuery[];\n  onClickSwitch: () => void;\n}\n\nexport function SmartAlertTypeDetector({\n  editingExistingRule,\n  rulesSourcesWithRuler,\n  queries,\n  onClickSwitch,\n}: SmartAlertTypeDetectorProps) {\n  const { getValues } = useFormContext<RuleFormValues>();\n\n  const [ruleFormType] = getValues(['type']);\n  const canSwitch = getCanSwitch({ queries, ruleFormType, rulesSourcesWithRuler });\n\n  const options = [\n    { label: t('alerting.smart-alert-type-detector.grafana-managed', 'Grafana-managed'), value: RuleFormType.grafana },\n    {\n      label: t('alerting.smart-alert-type-detector.data-source-managed', 'Data source-managed'),\n      value: RuleFormType.cloudAlerting,\n    },\n  ];\n\n  // if we can't switch to data-source managed, disable it\n  // TODO figure out how to show a popover to the user to indicate _why_ it's disabled\n  const disabledOptions = canSwitch ? [] : [RuleFormType.cloudAlerting];\n\n  return (\n    <Stack direction=\"column\" gap={1} alignItems=\"flex-start\">\n      <Stack direction=\"column\" gap={0}>\n        <Text variant=\"h5\">\n          <Trans i18nKey=\"alerting.smart-alert-type-detector.rule-type\">Rule type</Trans>\n        </Text>\n        <Stack direction=\"row\" gap={0.5} alignItems=\"center\">\n          <Text variant=\"bodySmall\" color=\"secondary\">\n            <Trans i18nKey=\"alerting.smart-alert-type-detector.select-where-alert-managed\">\n              Select where the alert rule will be managed.\n            </Trans>\n          </Text>\n          <NeedHelpInfo\n            contentText={\n              <>\n                <Text color=\"primary\" variant=\"h6\">\n                  <Trans i18nKey=\"alerting.smart-alert-type-detector.grafanamanaged-alert-rules\">\n                    Grafana-managed alert rules\n                  </Trans>\n                </Text>\n                <p>\n                  <Trans i18nKey=\"alerting.smart-alert-type-detector.grafanamanaged-alert-rules-description\">\n                    Grafana-managed alert rules allow you to create alerts that can act on data from any of our\n                    supported data sources, including having multiple data sources in the same rule. You can also add\n                    expressions to transform your data and set alert conditions. Using images in alert notifications is\n                    also supported.\n                  </Trans>\n                </p>\n                <Text color=\"primary\" variant=\"h6\">\n                  <Trans i18nKey=\"alerting.smart-alert-type-detector.data-sourcemanaged-alert-rules\">\n                    Data source-managed alert rules\n                  </Trans>\n                </Text>\n                <p>\n                  <Trans i18nKey=\"alerting.smart-alert-type-detector.data-sourcemanaged-alert-rules-description\">\n                    Data source-managed alert rules can be used for Grafana Mimir or Grafana Loki data sources which\n                    have been configured to support rule creation. The use of expressions or multiple queries is not\n                    supported.\n                  </Trans>\n                </p>\n              </>\n            }\n            externalLink=\"https://grafana.com/docs/grafana/latest/alerting/fundamentals/alert-rules/alert-rule-types/\"\n            linkText=\"Read about alert rule types\"\n            title={t('alerting.smart-alert-type-detector.title-alert-rule-types', 'Alert rule types')}\n          />\n        </Stack>\n      </Stack>\n      <RadioButtonGroup\n        options={options}\n        disabled={editingExistingRule}\n        disabledOptions={disabledOptions}\n        value={ruleFormType}\n        onChange={onClickSwitch}\n        data-testid=\"rule-type-radio-group\"\n      />\n      {/* editing an existing rule, we just show \"cannot be changed\" */}\n      {editingExistingRule && (\n        <Text color=\"secondary\">\n          <Trans i18nKey=\"alerting.smart-alert-type-detector.rule-type-cannot-be-changed\">\n            The alert rule type cannot be changed for an existing rule.\n          </Trans>\n        </Text>\n      )}\n      {/* in regular alert creation we tell the user what options they have when using a cloud data source */}\n      {!editingExistingRule && (\n        <>\n          {canSwitch ? (\n            <Text color=\"secondary\">\n              {ruleFormType === RuleFormType.grafana\n                ? t(\n                    'alerting.smart-alert-type-detector.switch-to-data-source-managed',\n                    'The data source selected in your query supports alert rule management. Switch to data source-managed if you want the alert rule to be managed by the data source instead of Grafana.'\n                  )\n                : t(\n                    'alerting.smart-alert-type-detector.switch-to-grafana-managed',\n                    'Switch to Grafana-managed to use expressions, multiple queries, images in notifications and various other features.'\n                  )}\n            </Text>\n          ) : (\n            <Text color=\"secondary\">\n              <Trans i18nKey=\"alerting.smart-alert-type-detector.rule-type-grafana-managed\">\n                Based on the selected data sources this alert rule will be Grafana-managed.\n              </Trans>\n            </Text>\n          )}\n        </>\n      )}\n    </Stack>\n  );\n}\n","import { RuleFormType } from '../../../types/rule-form';\n\ntype FormDescriptions = {\n  sectionTitle: string;\n  helpLabel: string;\n  helpContent: string;\n  helpLink: string;\n};\n\nexport const DESCRIPTIONS: Record<RuleFormType, FormDescriptions> = {\n  [RuleFormType.cloudRecording]: {\n    sectionTitle: 'Define recording rule',\n    helpLabel: 'Define your recording rule',\n    helpContent:\n      'Pre-compute frequently needed or computationally expensive expressions and save their result as a new set of time series.',\n    helpLink: 'https://grafana.com/docs/grafana/latest/alerting/alerting-rules/create-recording-rules/',\n  },\n  [RuleFormType.grafanaRecording]: {\n    sectionTitle: 'Define recording rule',\n    helpLabel: 'Define your recording rule',\n    helpContent:\n      'Pre-compute frequently needed or computationally expensive expressions and save their result as a new set of time series.',\n    helpLink: 'https://grafana.com/docs/grafana/latest/alerting/alerting-rules/create-recording-rules/',\n  },\n  [RuleFormType.grafana]: {\n    sectionTitle: 'Define query and alert condition',\n    helpLabel: 'Define query and alert condition',\n    helpContent:\n      'An alert rule consists of one or more queries and expressions that select the data you want to measure. Define queries and/or expressions and then choose one of them as the alert rule condition. This is the threshold that an alert rule must meet or exceed in order to fire. For more information on queries and expressions, see Query and transform data.',\n    helpLink: 'https://grafana.com/docs/grafana/latest/panels-visualizations/query-transform-data/',\n  },\n  [RuleFormType.cloudAlerting]: {\n    sectionTitle: 'Define query and alert condition',\n    helpLabel: 'Define query and alert condition',\n    helpContent:\n      'An alert rule consists of one or more queries and expressions that select the data you want to measure. Define queries and/or expressions and then choose one of them as the alert rule condition. This is the threshold that an alert rule must meet or exceed in order to fire. For more information on queries and expressions, see Query and transform data.',\n    helpLink: 'https://grafana.com/docs/grafana/latest/panels-visualizations/query-transform-data/',\n  },\n};\n","import { useEffect, useState } from 'react';\n\nimport { ReducerID } from '@grafana/data';\nimport { EvalFunction } from 'app/features/alerting/state/alertDef';\nimport { ExpressionQuery } from 'app/features/expressions/types';\nimport { AlertDataQuery, AlertQuery } from 'app/types/unified-alerting-dto';\n\nimport { areQueriesTransformableToSimpleCondition } from '../../../rule-editor/formProcessing';\n\nimport { SimpleCondition, getSimpleConditionFromExpressions } from './SimpleCondition';\n\nfunction initializeSimpleCondition(\n  isGrafanaAlertingType: boolean,\n  dataQueries: Array<AlertQuery<AlertDataQuery>>,\n  expressionQueries: Array<AlertQuery<ExpressionQuery>>\n) {\n  if (isGrafanaAlertingType && areQueriesTransformableToSimpleCondition(dataQueries, expressionQueries)) {\n    return getSimpleConditionFromExpressions(expressionQueries);\n  } else {\n    return {\n      whenField: ReducerID.last,\n      evaluator: {\n        params: [0],\n        type: EvalFunction.IsAbove,\n      },\n    };\n  }\n}\nexport function determineAdvancedMode(simplifiedQueryEditor: boolean | undefined, isGrafanaAlertingType: boolean) {\n  return simplifiedQueryEditor === false || !isGrafanaAlertingType;\n}\n\n/*\n  This hook is used mantain the state of the advanced mode, and the simple condition,\n  depending on the editor settings, the alert type, and the queries.\n   */\nexport const useAdvancedMode = (\n  simplifiedQueryEditor: boolean | undefined,\n  isGrafanaAlertingType: boolean,\n  dataQueries: Array<AlertQuery<ExpressionQuery | AlertDataQuery>>,\n  expressionQueries: Array<AlertQuery<ExpressionQuery>>\n) => {\n  const isAdvancedMode = determineAdvancedMode(simplifiedQueryEditor, isGrafanaAlertingType);\n\n  const [simpleCondition, setSimpleCondition] = useState<SimpleCondition>(\n    initializeSimpleCondition(isGrafanaAlertingType, dataQueries, expressionQueries)\n  );\n\n  useEffect(() => {\n    if (isGrafanaAlertingType && !isAdvancedMode) {\n      setSimpleCondition(getSimpleConditionFromExpressions(expressionQueries));\n    }\n  }, [isAdvancedMode, expressionQueries, isGrafanaAlertingType]);\n\n  return { simpleCondition, setSimpleCondition };\n};\n","import { css } from '@emotion/css';\nimport { cloneDeep } from 'lodash';\nimport { useCallback, useEffect, useMemo, useReducer, useState } from 'react';\nimport { Controller, useFormContext } from 'react-hook-form';\nimport { useEffectOnce } from 'react-use';\n\nimport { GrafanaTheme2, getDefaultRelativeTimeRange } from '@grafana/data';\nimport { selectors } from '@grafana/e2e-selectors';\nimport { Trans, t } from '@grafana/i18n';\nimport { config, getDataSourceSrv } from '@grafana/runtime';\nimport {\n  Alert,\n  Button,\n  ConfirmModal,\n  Divider,\n  Dropdown,\n  Field,\n  Menu,\n  MenuItem,\n  Stack,\n  Text,\n  Tooltip,\n  useStyles2,\n} from '@grafana/ui';\nimport { isExpressionQuery } from 'app/features/expressions/guards';\nimport {\n  ExpressionDatasourceUID,\n  ExpressionQuery,\n  ExpressionQueryType,\n  expressionTypes,\n} from 'app/features/expressions/types';\nimport { AlertQuery } from 'app/types/unified-alerting-dto';\n\nimport { useRulesSourcesWithRuler } from '../../../hooks/useRuleSourcesWithRuler';\nimport {\n  areQueriesTransformableToSimpleCondition,\n  isExpressionQueryInAlert,\n} from '../../../rule-editor/formProcessing';\nimport { RuleFormType, RuleFormValues } from '../../../types/rule-form';\nimport { getDefaultOrFirstCompatibleDataSource } from '../../../utils/datasource';\nimport { PromOrLokiQuery, isPromOrLokiQuery } from '../../../utils/rule-form';\nimport {\n  isCloudAlertingRuleByType,\n  isCloudRecordingRuleByType,\n  isDataSourceManagedRuleByType,\n  isGrafanaAlertingRuleByType,\n  isGrafanaManagedRuleByType,\n} from '../../../utils/rules';\nimport { ExpressionEditor } from '../ExpressionEditor';\nimport { ExpressionsEditor } from '../ExpressionsEditor';\nimport { NeedHelpInfo } from '../NeedHelpInfo';\nimport { QueryEditor } from '../QueryEditor';\nimport { RecordingRuleEditor } from '../RecordingRuleEditor';\nimport { RuleEditorSection } from '../RuleEditorSection';\nimport { errorFromCurrentCondition, errorFromPreviewData, findRenamedDataQueryReferences, refIdExists } from '../util';\n\nimport { CloudDataSourceSelector } from './CloudDataSourceSelector';\nimport { SimpleConditionEditor, getSimpleConditionFromExpressions } from './SimpleCondition';\nimport { SmartAlertTypeDetector } from './SmartAlertTypeDetector';\nimport { DESCRIPTIONS } from './descriptions';\nimport {\n  addExpressions,\n  addNewDataQuery,\n  addNewExpression,\n  duplicateQuery,\n  optimizeReduceExpression,\n  queriesAndExpressionsReducer,\n  removeExpression,\n  removeExpressions,\n  resetToSimpleCondition,\n  rewireExpressions,\n  setDataQueries,\n  setRecordingRulesQueries,\n  updateExpression,\n  updateExpressionRefId,\n  updateExpressionTimeRange,\n  updateExpressionType,\n} from './reducer';\nimport { useAdvancedMode } from './useAdvancedMode';\nimport { useAlertQueryRunner } from './useAlertQueryRunner';\nimport { onlyOneDSInQueries } from './utils';\n\ninterface Props {\n  editingExistingRule: boolean;\n  onDataChange: (error: string) => void;\n  /**\n   * The mode of the rule editor.\n   * - 'edit' standard rule editor mode\n   * - 'draft' non-saveable form mode used for exporting to provisioning formats\n   */\n  mode: 'edit' | 'draft';\n}\n\nexport const QueryAndExpressionsStep = ({ editingExistingRule, onDataChange, mode }: Props) => {\n  const {\n    setValue,\n    getValues,\n    watch,\n    formState: { errors },\n    control,\n  } = useFormContext<RuleFormValues>();\n\n  const { queryPreviewData, runQueries, cancelQueries, isPreviewLoading, clearPreviewData } = useAlertQueryRunner();\n  const isSwitchModeEnabled = config.featureToggles.alertingQueryAndExpressionsStepMode ?? false;\n\n  const initialState = {\n    queries: getValues('queries'),\n  };\n\n  const [{ queries }, dispatch] = useReducer(queriesAndExpressionsReducer, initialState);\n  const isOptimizeReducerEnabled = config.featureToggles.alertingUIOptimizeReducer ?? false;\n\n  // data queries only\n  const dataQueries = useMemo(() => {\n    return queries.filter((query) => !isExpressionQuery(query.model));\n  }, [queries]);\n\n  // expression queries only\n  const expressionQueries = useMemo(() => {\n    return queries.filter((query) => isExpressionQueryInAlert(query));\n  }, [queries]);\n\n  useEffectOnce(() => {\n    // we only remove or add the reducer(optimize reducer) expression when creating a new alert.\n    // When editing an alert, we assume the user wants to manually adjust expressions and queries for more control and customization.\n\n    if (!editingExistingRule && isOptimizeReducerEnabled) {\n      dispatch(optimizeReduceExpression({ updatedQueries: dataQueries, expressionQueries }));\n    }\n  });\n\n  const [type, condition, dataSourceName, editorSettings] = watch([\n    'type',\n    'condition',\n    'dataSourceName',\n    'editorSettings',\n  ]);\n  //if its a new rule, look at the local storage\n\n  const isGrafanaAlertingType = isGrafanaAlertingRuleByType(type);\n  const isRecordingRuleType = isCloudRecordingRuleByType(type);\n  const isCloudAlertRuleType = isCloudAlertingRuleByType(type);\n  const [showResetModeModal, setShowResetModal] = useState(false);\n\n  const simplifiedQueryInForm = editorSettings?.simplifiedQueryEditor;\n\n  const { simpleCondition, setSimpleCondition } = useAdvancedMode(\n    simplifiedQueryInForm,\n    isGrafanaAlertingType,\n    dataQueries,\n    expressionQueries\n  );\n\n  const simplifiedQueryStep =\n    isSwitchModeEnabled && isGrafanaAlertingType ? editorSettings?.simplifiedQueryEditor : false;\n\n  // If we switch to simple mode we need to update the simple condition with the data in the queries reducer\n  useEffect(() => {\n    if (simplifiedQueryStep && isGrafanaAlertingType) {\n      setSimpleCondition(getSimpleConditionFromExpressions(expressionQueries));\n    }\n  }, [simplifiedQueryStep, expressionQueries, isGrafanaAlertingType, setSimpleCondition]);\n\n  const { rulesSourcesWithRuler, isLoading: rulerSourcesIsLoading } = useRulesSourcesWithRuler();\n\n  const runQueriesPreview = useCallback(\n    (condition?: string) => {\n      if (isCloudAlertRuleType) {\n        // we will skip preview for cloud rules, these do not have any time series preview\n        // Grafana Managed rules and recording rules do\n        return;\n      }\n\n      if (simplifiedQueryStep) {\n        const lastExpression = expressionQueries.at(-1);\n        if (!lastExpression) {\n          return;\n        }\n\n        const condition = lastExpression.refId;\n        // we need to be sure the condition is set once we switch to simple mode\n        setValue('condition', condition);\n        runQueries(getValues('queries'), condition);\n      } else {\n        runQueries(getValues('queries'), condition || (getValues('condition') ?? ''));\n      }\n    },\n    [isCloudAlertRuleType, expressionQueries, simplifiedQueryStep, setValue, runQueries, getValues]\n  );\n\n  // whenever we update the queries we have to update the form too\n  useEffect(() => {\n    setValue('queries', queries, { shouldValidate: false });\n  }, [queries, runQueries, setValue]);\n\n  const noCompatibleDataSources = getDefaultOrFirstCompatibleDataSource() === undefined;\n\n  const emptyQueries = queries.length === 0;\n\n  // apply some validations and asserts to the results of the evaluation when creating or editing\n  // Grafana-managed alert rules and Grafa-managed recording rules\n  useEffect(() => {\n    if (type && !isGrafanaManagedRuleByType(type)) {\n      return;\n    }\n\n    const currentCondition = getValues('condition');\n    if (!currentCondition) {\n      return;\n    }\n\n    const previewData = queryPreviewData[currentCondition];\n    if (!previewData) {\n      return;\n    }\n\n    const error = errorFromPreviewData(previewData) ?? errorFromCurrentCondition(previewData);\n\n    onDataChange(error?.message || '');\n  }, [queryPreviewData, getValues, onDataChange, type]);\n\n  const handleSetCondition = useCallback(\n    (refId: string | null) => {\n      if (!refId) {\n        return;\n      }\n\n      runQueriesPreview(refId); //we need to run the queries to know if the condition is valid\n\n      setValue('condition', refId);\n    },\n    [runQueriesPreview, setValue]\n  );\n\n  const onUpdateRefId = useCallback(\n    (oldRefId: string, newRefId: string) => {\n      const newRefIdExists = refIdExists(queries, newRefId);\n      // TODO we should set an error and explain what went wrong instead of just refusing to update\n      if (newRefIdExists) {\n        return;\n      }\n\n      dispatch(updateExpressionRefId({ oldRefId, newRefId }));\n\n      // update condition too if refId was updated\n      if (condition === oldRefId) {\n        setValue('condition', newRefId);\n      }\n    },\n    [condition, queries, setValue]\n  );\n\n  const updateExpressionAndDatasource = useSetExpressionAndDataSource();\n\n  const onChangeQueries = useCallback(\n    (updatedQueries: AlertQuery[]) => {\n      // Most data sources triggers onChange and onRunQueries consecutively\n      // It means our reducer state is always one step behind when runQueries is invoked\n      // Invocation cycle => onChange -> dispatch(setDataQueries) -> onRunQueries -> setDataQueries Reducer\n      // As a workaround we update form values as soon as possible to avoid stale state\n      // This way we can access up to date queries in runQueriesPreview without waiting for re-render\n      const previousQueries = getValues('queries');\n\n      const expressionQueries = previousQueries.filter<AlertQuery<ExpressionQuery>>(isExpressionQueryInAlert);\n\n      setValue('queries', [...updatedQueries, ...expressionQueries], { shouldValidate: false });\n      updateExpressionAndDatasource(updatedQueries);\n\n      // we only remove or add the reducer(optimize reducer) expression when creating a new alert.\n      // When editing an alert, we assume the user wants to manually adjust expressions and queries for more control and customization.\n      if (!editingExistingRule && isOptimizeReducerEnabled) {\n        dispatch(optimizeReduceExpression({ updatedQueries, expressionQueries }));\n      }\n\n      dispatch(setDataQueries(updatedQueries));\n      dispatch(updateExpressionTimeRange());\n\n      // check if we need to rewire expressions (and which ones)\n      const [oldRefId, newRefId] = findRenamedDataQueryReferences(queries, updatedQueries);\n      if (oldRefId && newRefId) {\n        dispatch(rewireExpressions({ oldRefId, newRefId }));\n      }\n    },\n    [queries, updateExpressionAndDatasource, getValues, setValue, editingExistingRule, isOptimizeReducerEnabled]\n  );\n\n  const onChangeRecordingRulesQueries = useCallback(\n    (updatedQueries: AlertQuery[]) => {\n      const query = updatedQueries[0];\n\n      if (!isPromOrLokiQuery(query.model)) {\n        return;\n      }\n\n      const expression = query.model.expr;\n\n      setValue('queries', updatedQueries, { shouldValidate: false });\n      updateExpressionAndDatasource(updatedQueries);\n\n      dispatch(setRecordingRulesQueries({ recordingRuleQueries: updatedQueries, expression }));\n      runQueriesPreview();\n    },\n    [runQueriesPreview, setValue, updateExpressionAndDatasource]\n  );\n\n  // Using dataSourcesWithRuler[0] gives incorrect types - no undefined\n  // Using at(0) provides a safe type with undefined\n  const recordingRuleDefaultDatasource = rulesSourcesWithRuler.at(0);\n\n  useEffect(() => {\n    clearPreviewData();\n    if (type === RuleFormType.cloudRecording) {\n      const expr = getValues('expression');\n\n      if (!recordingRuleDefaultDatasource) {\n        return;\n      }\n\n      const datasourceUid =\n        (editingExistingRule && getDataSourceSrv().getInstanceSettings(dataSourceName)?.uid) ||\n        recordingRuleDefaultDatasource.uid;\n\n      const defaultQuery = {\n        refId: 'A',\n        datasourceUid,\n        queryType: '',\n        relativeTimeRange: getDefaultRelativeTimeRange(),\n        expr,\n        instant: true,\n        model: {\n          refId: 'A',\n          hide: false,\n          expr,\n        },\n      };\n      dispatch(setRecordingRulesQueries({ recordingRuleQueries: [defaultQuery], expression: expr }));\n    }\n  }, [type, recordingRuleDefaultDatasource, editingExistingRule, getValues, dataSourceName, clearPreviewData]);\n\n  const onDuplicateQuery = useCallback((query: AlertQuery) => {\n    dispatch(duplicateQuery(query));\n  }, []);\n\n  // update the condition if it's been removed\n  useEffect(() => {\n    if (!refIdExists(queries, condition)) {\n      const lastRefId = queries.at(-1)?.refId ?? null;\n      handleSetCondition(lastRefId);\n    }\n  }, [condition, queries, handleSetCondition]);\n\n  const onClickType = useCallback(\n    (type: ExpressionQueryType) => {\n      dispatch(addNewExpression(type));\n    },\n    [dispatch]\n  );\n\n  const styles = useStyles2(getStyles);\n\n  // Cloud alerts load data from form values\n  // whereas Grafana managed alerts load data from reducer\n  //when data source is changed in the cloud selector we need to update the queries in the reducer\n\n  const onChangeCloudDatasource = useCallback(\n    (datasourceUid: string) => {\n      const newQueries = cloneDeep(queries);\n      newQueries[0].datasourceUid = datasourceUid;\n      setValue('queries', newQueries, { shouldValidate: false });\n\n      updateExpressionAndDatasource(newQueries);\n\n      dispatch(setDataQueries(newQueries));\n    },\n    [queries, setValue, updateExpressionAndDatasource, dispatch]\n  );\n\n  // ExpressionEditor for cloud query needs to update queries in the reducer and in the form\n  // otherwise the value is not updated for Grafana managed alerts\n\n  const onChangeExpression = (value: string) => {\n    const newQueries = cloneDeep(queries);\n\n    if (newQueries[0].model) {\n      if (isPromOrLokiQuery(newQueries[0].model)) {\n        newQueries[0].model.expr = value;\n      } else {\n        // first time we come from grafana-managed type\n        // we need to convert the model to PromOrLokiQuery\n        const promLoki: PromOrLokiQuery = {\n          ...cloneDeep(newQueries[0].model),\n          expr: value,\n        };\n        newQueries[0].model = promLoki;\n      }\n    }\n\n    setValue('queries', newQueries, { shouldValidate: false });\n\n    updateExpressionAndDatasource(newQueries);\n\n    dispatch(setDataQueries(newQueries));\n    runQueriesPreview();\n  };\n\n  const removeExpressionsInQueries = useCallback(() => dispatch(removeExpressions()), [dispatch]);\n\n  const addExpressionsInQueries = useCallback(\n    (expressions: AlertQuery[]) => dispatch(addExpressions(expressions)),\n    [dispatch]\n  );\n\n  // we need to keep track of the previous expressions and condition reference to be able to restore them when switching back to grafana managed\n  const [prevExpressions, setPrevExpressions] = useState<AlertQuery[]>([]);\n  const [prevCondition, setPrevCondition] = useState<string | null>(null);\n\n  const restoreExpressionsInQueries = useCallback(() => {\n    addExpressionsInQueries(prevExpressions);\n  }, [prevExpressions, addExpressionsInQueries]);\n\n  const onClickSwitch = useCallback(() => {\n    const typeInForm = getValues('type');\n    if (typeInForm === RuleFormType.cloudAlerting) {\n      setValue('type', RuleFormType.grafana);\n      setValue('dataSourceName', null); // set data source name back to \"null\"\n\n      prevExpressions.length > 0 && restoreExpressionsInQueries();\n      prevCondition && setValue('condition', prevCondition);\n    } else {\n      setValue('type', RuleFormType.cloudAlerting);\n      // dataSourceName is used only by Mimir/Loki alerting and recording rules\n      // It should be empty for Grafana managed alert rules\n      const newDsName = getDataSourceSrv().getInstanceSettings(queries[0].datasourceUid)?.name;\n      if (newDsName) {\n        setValue('dataSourceName', newDsName);\n      }\n\n      updateExpressionAndDatasource(queries);\n\n      const expressions = queries.filter((query) => query.datasourceUid === ExpressionDatasourceUID);\n      setPrevExpressions(expressions);\n      removeExpressionsInQueries();\n      setPrevCondition(condition);\n    }\n  }, [\n    getValues,\n    setValue,\n    prevExpressions.length,\n    restoreExpressionsInQueries,\n    prevCondition,\n    updateExpressionAndDatasource,\n    queries,\n    removeExpressionsInQueries,\n    condition,\n  ]);\n\n  const { sectionTitle, helpLabel, helpContent, helpLink } = DESCRIPTIONS[type ?? RuleFormType.grafana];\n\n  if (!type) {\n    return null;\n  }\n  const switchMode =\n    isGrafanaAlertingType && isSwitchModeEnabled\n      ? {\n          isAdvancedMode: !simplifiedQueryStep,\n          setAdvancedMode: (isAdvanced: boolean) => {\n            if (!getValues('editorSettings.simplifiedQueryEditor')) {\n              if (!areQueriesTransformableToSimpleCondition(dataQueries, expressionQueries)) {\n                setShowResetModal(true);\n                return;\n              }\n            }\n            setValue('editorSettings.simplifiedQueryEditor', !isAdvanced);\n          },\n        }\n      : undefined;\n\n  const canSelectDataSourceManaged =\n    onlyOneDSInQueries(queries) &&\n    Boolean(rulesSourcesWithRuler.length) &&\n    queries.some((query) => rulesSourcesWithRuler.some((source) => source.uid === query.datasourceUid));\n\n  return (\n    <>\n      <RuleEditorSection\n        stepNo={2}\n        title={sectionTitle}\n        fullWidth={true}\n        description={\n          <Stack direction=\"row\" gap={0.5} alignItems=\"center\">\n            <Text variant=\"bodySmall\" color=\"secondary\">\n              {helpLabel}\n            </Text>\n            <NeedHelpInfo\n              contentText={helpContent}\n              externalLink={helpLink}\n              linkText={'Read more on our documentation website'}\n              title={helpLabel}\n            />\n          </Stack>\n        }\n        switchMode={switchMode}\n      >\n        {/* This is the cloud data source selector */}\n        {isDataSourceManagedRuleByType(type) && (\n          <CloudDataSourceSelector onChangeCloudDatasource={onChangeCloudDatasource} disabled={editingExistingRule} />\n        )}\n\n        {/* This is the PromQL Editor for recording rules */}\n        {isRecordingRuleType && dataSourceName && (\n          <Field error={errors.expression?.message} invalid={!!errors.expression?.message}>\n            <RecordingRuleEditor\n              dataSourceName={dataSourceName}\n              queries={queries}\n              runQueries={() => runQueriesPreview()}\n              onChangeQuery={onChangeRecordingRulesQueries}\n              panelData={queryPreviewData}\n            />\n          </Field>\n        )}\n\n        {rulerSourcesIsLoading && (\n          <Text>\n            <Trans i18nKey=\"alerting.query-and-expressions-step.loading-data-sources\">Loading data sources...</Trans>\n          </Text>\n        )}\n\n        {/* This is the PromQL Editor for Cloud rules */}\n        {!rulerSourcesIsLoading && isCloudAlertRuleType && dataSourceName && (\n          <Stack direction=\"column\">\n            <Field error={errors.expression?.message} invalid={!!errors.expression?.message}>\n              <Controller\n                name=\"expression\"\n                render={({ field: { ref, ...field } }) => {\n                  return (\n                    <ExpressionEditor\n                      {...field}\n                      dataSourceName={dataSourceName}\n                      showPreviewAlertsButton={!isRecordingRuleType}\n                      onChange={onChangeExpression}\n                    />\n                  );\n                }}\n                control={control}\n                rules={{\n                  required: {\n                    value: true,\n                    message: t(\n                      'alerting.query-and-expressions-step.message.a-valid-expression-is-required',\n                      'A valid expression is required'\n                    ),\n                  },\n                }}\n              />\n            </Field>\n            {mode === 'edit' && (\n              <>\n                <Divider />\n                <SmartAlertTypeDetector\n                  editingExistingRule={editingExistingRule}\n                  queries={queries}\n                  rulesSourcesWithRuler={rulesSourcesWithRuler}\n                  onClickSwitch={onClickSwitch}\n                />\n              </>\n            )}\n          </Stack>\n        )}\n\n        {/* This is the editor for Grafana managed rules and Grafana managed recording rules */}\n        {!rulerSourcesIsLoading && isGrafanaManagedRuleByType(type) && (\n          <Stack direction=\"column\">\n            {/* Data Queries */}\n            <QueryEditor\n              queries={dataQueries}\n              expressions={expressionQueries}\n              onRunQueries={() => runQueriesPreview()}\n              onChangeQueries={onChangeQueries}\n              onDuplicateQuery={onDuplicateQuery}\n              panelData={queryPreviewData}\n              condition={condition}\n              onSetCondition={handleSetCondition}\n            />\n            {!simplifiedQueryStep && (\n              <Tooltip\n                content={t(\n                  'alerting.query-and-expressions-step.no-compatible-sources',\n                  'You appear to have no compatible data sources'\n                )}\n                show={noCompatibleDataSources}\n              >\n                <Button\n                  type=\"button\"\n                  onClick={() => {\n                    dispatch(addNewDataQuery());\n                  }}\n                  variant=\"secondary\"\n                  data-testid={selectors.components.QueryTab.addQuery}\n                  disabled={noCompatibleDataSources}\n                  className={styles.addQueryButton}\n                >\n                  <Trans i18nKey=\"alerting.query-and-expressions-step.add-query\">Add query</Trans>\n                </Button>\n              </Tooltip>\n            )}\n            {/* We only show Switch for Grafana managed alerts */}\n            {canSelectDataSourceManaged && isGrafanaAlertingType && !simplifiedQueryStep && mode === 'edit' && (\n              <>\n                <Divider />\n                <SmartAlertTypeDetector\n                  editingExistingRule={editingExistingRule}\n                  rulesSourcesWithRuler={rulesSourcesWithRuler}\n                  queries={queries}\n                  onClickSwitch={onClickSwitch}\n                />\n              </>\n            )}\n            {/* Expression Queries */}\n            {!simplifiedQueryStep && (\n              <>\n                <Divider />\n                <Stack direction=\"column\" gap={0}>\n                  <Text element=\"h5\">\n                    <Trans i18nKey=\"alerting.query-and-expressions-step.expressions\">Expressions</Trans>\n                  </Text>\n                  <Text variant=\"bodySmall\" color=\"secondary\">\n                    <Trans i18nKey=\"alerting.query-and-expressions-step.manipulate-returned-queries-other-operations\">\n                      Manipulate data returned from queries with math and other operations.\n                    </Trans>\n                  </Text>\n                </Stack>\n\n                <ExpressionsEditor\n                  queries={queries}\n                  panelData={queryPreviewData}\n                  condition={condition}\n                  onSetCondition={handleSetCondition}\n                  onRemoveExpression={(refId) => {\n                    dispatch(removeExpression(refId));\n                  }}\n                  onUpdateRefId={onUpdateRefId}\n                  onUpdateExpressionType={(refId, type) => {\n                    dispatch(updateExpressionType({ refId, type }));\n                  }}\n                  onUpdateQueryExpression={(model) => {\n                    dispatch(updateExpression(model));\n                  }}\n                />\n              </>\n            )}\n            {/* action buttons */}\n            <Stack direction=\"column\">\n              {simplifiedQueryStep && (\n                <SimpleConditionEditor\n                  simpleCondition={simpleCondition}\n                  onChange={setSimpleCondition}\n                  expressionQueriesList={expressionQueries}\n                  dispatch={dispatch}\n                  previewData={queryPreviewData[condition ?? '']}\n                />\n              )}\n              <Stack direction=\"row\">\n                {!simplifiedQueryStep && config.expressionsEnabled && <TypeSelectorButton onClickType={onClickType} />}\n\n                {isPreviewLoading && (\n                  <Button icon=\"spinner\" type=\"button\" variant=\"destructive\" onClick={cancelQueries}>\n                    <Trans i18nKey=\"alerting.common.cancel\">Cancel</Trans>\n                  </Button>\n                )}\n                {!isPreviewLoading && (\n                  <Button\n                    data-testid={selectors.components.AlertRules.previewButton}\n                    icon=\"sync\"\n                    type=\"button\"\n                    onClick={() => runQueriesPreview()}\n                    disabled={emptyQueries}\n                  >\n                    {!simplifiedQueryStep\n                      ? t('alerting.queryAndExpressionsStep.preview', 'Preview')\n                      : t('alerting.queryAndExpressionsStep.previewCondition', 'Preview alert rule condition')}\n                  </Button>\n                )}\n              </Stack>\n            </Stack>\n\n            {/* No Queries */}\n            {emptyQueries && (\n              <Alert\n                title={t(\n                  'alerting.query-and-expressions-step.title-queries-expressions-configured',\n                  'No queries or expressions have been configured'\n                )}\n                severity=\"warning\"\n              >\n                <Trans i18nKey=\"alerting.query-and-expressions-step.body-queries-expressions-configured\">\n                  Create at least one query or expression to be alerted on\n                </Trans>\n              </Alert>\n            )}\n          </Stack>\n        )}\n      </RuleEditorSection>\n\n      <ConfirmModal\n        isOpen={showResetModeModal}\n        title={t(\n          'alerting.query-and-expressions-step.title-deactivate-advanced-options',\n          'Deactivate advanced options'\n        )}\n        body={\n          <div>\n            <Text element=\"p\">\n              <Trans i18nKey=\"alerting.queryAndExpressionsStep.disableAdvancedOptions.text\">\n                The selected queries and expressions cannot be converted to default. If you deactivate advanced options,\n                your query and condition will be reset to default settings.\n              </Trans>\n            </Text>\n            <br />\n          </div>\n        }\n        confirmText={t('alerting.query-and-expressions-step.confirmText-deactivate', 'Deactivate')}\n        icon=\"exclamation-triangle\"\n        onConfirm={() => {\n          setValue('editorSettings.simplifiedQueryEditor', true);\n          setShowResetModal(false);\n          dispatch(resetToSimpleCondition());\n        }}\n        onDismiss={() => setShowResetModal(false)}\n      />\n    </>\n  );\n};\n\nfunction TypeSelectorButton({ onClickType }: { onClickType: (type: ExpressionQueryType) => void }) {\n  const newMenu = (\n    <Menu>\n      {expressionTypes.map((type) => (\n        <Tooltip key={type.value} content={type.description ?? ''} placement=\"right\">\n          <MenuItem\n            key={type.value}\n            onClick={() => onClickType(type.value ?? ExpressionQueryType.math)}\n            label={type.label ?? ''}\n          />\n        </Tooltip>\n      ))}\n    </Menu>\n  );\n\n  return (\n    <Dropdown overlay={newMenu}>\n      <Button variant=\"secondary\" data-testid={'add-expression-button'} icon=\"angle-down\">\n        <Trans i18nKey=\"alerting.type-selector-button.add-expression\">Add expression</Trans>\n      </Button>\n    </Dropdown>\n  );\n}\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  addQueryButton: css({\n    width: 'fit-content',\n  }),\n  helpInfo: css({\n    display: 'flex',\n    flexDirection: 'row',\n    alignItems: 'center',\n    width: 'fit-content',\n    fontWeight: theme.typography.fontWeightMedium,\n    marginLeft: theme.spacing(1),\n    fontSize: theme.typography.size.sm,\n    cursor: 'pointer',\n  }),\n  helpInfoText: css({\n    marginLeft: theme.spacing(0.5),\n    textDecoration: 'underline',\n  }),\n  infoLink: css({\n    color: theme.colors.text.link,\n  }),\n});\n\nconst useSetExpressionAndDataSource = () => {\n  const { setValue } = useFormContext<RuleFormValues>();\n\n  return (updatedQueries: AlertQuery[]) => {\n    // update data source name and expression if it's been changed in the queries from the reducer when prom or loki query\n    const query = updatedQueries[0];\n    if (!query) {\n      return;\n    }\n\n    const dataSourceSettings = getDataSourceSrv().getInstanceSettings(query.datasourceUid);\n    if (!dataSourceSettings) {\n      throw new Error('The Data source has not been defined.');\n    }\n\n    if (isPromOrLokiQuery(query.model)) {\n      const expression = query.model.expr;\n      setValue('expression', expression);\n    }\n  };\n};\n","import { useEffect, useState } from 'react';\n\nimport { DataSourceInstanceSettings } from '@grafana/data';\n\nimport { featureDiscoveryApi } from '../api/featureDiscoveryApi';\nimport { getRulesDataSources } from '../utils/datasource';\n\nconst { useLazyDiscoverDsFeaturesQuery } = featureDiscoveryApi;\n\nexport function useRulesSourcesWithRuler(): {\n  rulesSourcesWithRuler: DataSourceInstanceSettings[];\n  isLoading: boolean;\n} {\n  const [rulesSourcesWithRuler, setRulesSourcesWithRuler] = useState<DataSourceInstanceSettings[]>([]);\n  const [discoverDsFeatures, { isLoading }] = useLazyDiscoverDsFeaturesQuery();\n\n  useEffect(() => {\n    const dataSources = getRulesDataSources();\n    dataSources.forEach(async (ds) => {\n      const { data: dsFeatures } = await discoverDsFeatures({ uid: ds.uid }, true);\n      if (dsFeatures?.rulerConfig) {\n        setRulesSourcesWithRuler((prev) => [...prev, ds]);\n      }\n    });\n  }, [discoverDsFeatures]);\n\n  return { rulesSourcesWithRuler, isLoading };\n}\n","import { css } from '@emotion/css';\nimport * as React from 'react';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { Trans } from '@grafana/i18n';\nimport { Alert, LinkButton, useStyles2 } from '@grafana/ui';\n\ninterface AlertWarningProps {\n  title: string;\n  children: React.ReactNode;\n}\nexport function AlertWarning({ title, children }: AlertWarningProps) {\n  return (\n    <Alert className={useStyles2(warningStyles).warning} severity=\"warning\" title={title}>\n      <p>{children}</p>\n      <LinkButton href=\"alerting/list\">\n        <Trans i18nKey=\"alerting.alert-warning.to-rule-list\">To rule list</Trans>\n      </LinkButton>\n    </Alert>\n  );\n}\n\nconst warningStyles = (theme: GrafanaTheme2) => ({\n  warning: css({\n    margin: theme.spacing(4),\n  }),\n});\n","export interface GrafanaGroupUpdatedResponse {\n  message: string;\n  /**\n   * UIDs of rules created from this request\n   */\n  created?: string[];\n  /**\n   * UIDs of rules updated from this request\n   */\n  updated?: string[];\n}\n\nexport interface CloudGroupUpdatedResponse {\n  error: string;\n  errorType: string;\n  status: 'error' | 'success';\n}\n\nexport type RulerGroupUpdatedResponse = GrafanaGroupUpdatedResponse | CloudGroupUpdatedResponse;\n\nexport function isGrafanaGroupUpdatedResponse(\n  response: RulerGroupUpdatedResponse\n): response is GrafanaGroupUpdatedResponse {\n  return 'message' in response;\n}\n\nexport function isCloudGroupUpdatedResponse(\n  response: RulerGroupUpdatedResponse\n): response is CloudGroupUpdatedResponse {\n  return 'status' in response;\n}\n","import { useState } from 'react';\n\nimport { t } from '@grafana/i18n';\nimport { LoadingPlaceholder } from '@grafana/ui';\n\nimport { alertRuleApi } from '../../api/alertRuleApi';\n\nimport { FileExportPreview } from './FileExportPreview';\nimport { GrafanaExportDrawer } from './GrafanaExportDrawer';\nimport { ExportFormats, allGrafanaExportProviders } from './providers';\n\ninterface GrafanaRuleExportPreviewProps {\n  alertUid: string;\n  exportFormat: ExportFormats;\n  onClose: () => void;\n}\n\nconst GrafanaRuleExportPreview = ({ alertUid, exportFormat, onClose }: GrafanaRuleExportPreviewProps) => {\n  const { currentData: ruleTextDefinition = '', isFetching } = alertRuleApi.endpoints.exportRules.useQuery({\n    ruleUid: alertUid,\n    format: exportFormat,\n  });\n\n  const downloadFileName = `${alertUid}-${new Date().getTime()}`;\n\n  if (isFetching) {\n    return <LoadingPlaceholder text={t('alerting.grafana-rule-export-preview.text-loading', 'Loading....')} />;\n  }\n\n  return (\n    <FileExportPreview\n      format={exportFormat}\n      textDefinition={ruleTextDefinition}\n      downloadFileName={downloadFileName}\n      onClose={onClose}\n    />\n  );\n};\n\ninterface GrafanaRulerExporterProps {\n  onClose: () => void;\n  alertUid: string;\n}\n\nexport const GrafanaRuleExporter = ({ onClose, alertUid }: GrafanaRulerExporterProps) => {\n  const [activeTab, setActiveTab] = useState<ExportFormats>('yaml');\n\n  return (\n    <GrafanaExportDrawer\n      activeTab={activeTab}\n      onTabChange={setActiveTab}\n      onClose={onClose}\n      formatProviders={Object.values(allGrafanaExportProviders)}\n    >\n      <GrafanaRuleExportPreview alertUid={alertUid} exportFormat={activeTab} onClose={onClose} />\n    </GrafanaExportDrawer>\n  );\n};\n","import { css } from '@emotion/css';\nimport { useMemo } from 'react';\nimport { Controller, useFormContext } from 'react-hook-form';\n\nimport { GrafanaTheme2, SelectableValue } from '@grafana/data';\nimport { t } from '@grafana/i18n';\nimport { Field, VirtualizedSelect, useStyles2 } from '@grafana/ui';\n\nimport { RuleFormValues } from '../../types/rule-form';\n\nimport { useGetNameSpacesByDatasourceName } from './useAlertRuleSuggestions';\n\ninterface Props {\n  rulesSourceName: string;\n}\n\nexport const GroupAndNamespaceFields = ({ rulesSourceName }: Props) => {\n  const {\n    control,\n    watch,\n    formState: { errors },\n    setValue,\n  } = useFormContext<RuleFormValues>();\n\n  const style = useStyles2(getStyle);\n  const { namespaceGroups, isLoading } = useGetNameSpacesByDatasourceName(rulesSourceName);\n\n  const namespace = watch('namespace');\n\n  const namespaceOptions: Array<SelectableValue<string>> = useMemo(\n    () =>\n      Array.from(namespaceGroups.keys()).map((namespace) => ({\n        label: namespace,\n        value: namespace,\n      })),\n    [namespaceGroups]\n  );\n\n  const groupOptions: Array<SelectableValue<string>> = useMemo(\n    () => (namespace && namespaceGroups.get(namespace)?.map((group) => ({ label: group, value: group }))) || [],\n    [namespace, namespaceGroups]\n  );\n\n  return (\n    <div className={style.flexRow}>\n      <Field\n        data-testid=\"namespace-picker\"\n        label={t('alerting.group-and-namespace-fields.namespace-picker-label-namespace', 'Namespace')}\n        // Disable translations as we don't intend to use this dropdown longterm,\n        // so avoiding us adding translations for the sake of it\n        // eslint-disable-next-line @grafana/i18n/no-untranslated-strings\n        description=\"Type to search for an existing namespace or create a new one\"\n        error={errors.namespace?.message}\n        invalid={!!errors.namespace?.message}\n      >\n        <Controller\n          render={({ field: { onChange, ref, ...field } }) => (\n            <VirtualizedSelect\n              {...field}\n              allowCustomValue\n              className={style.input}\n              onChange={(value) => {\n                setValue('group', ''); //reset if namespace changes\n                onChange(value.value);\n              }}\n              options={namespaceOptions}\n              width={42}\n              isLoading={isLoading}\n              disabled={isLoading}\n            />\n          )}\n          name=\"namespace\"\n          control={control}\n          rules={{\n            required: { value: true, message: t('alerting.group-and-namespace-fields.message.required', 'Required.') },\n          }}\n        />\n      </Field>\n      <Field\n        data-testid=\"group-picker\"\n        label={t('alerting.group-and-namespace-fields.group-picker-label-group', 'Group')}\n        // Disable translations as we don't intend to use this dropdown longterm,\n        // so avoiding us adding translations for the sake of it\n        // eslint-disable-next-line @grafana/i18n/no-untranslated-strings\n        description=\"Type to search for an existing group or create a new one\"\n        error={errors.group?.message}\n        invalid={!!errors.group?.message}\n      >\n        <Controller\n          render={({ field: { ref, ...field } }) => (\n            <VirtualizedSelect\n              {...field}\n              allowCustomValue\n              options={groupOptions}\n              width={42}\n              onChange={(value) => {\n                setValue('group', value.value ?? '');\n              }}\n              className={style.input}\n              isLoading={isLoading}\n              disabled={isLoading}\n            />\n          )}\n          name=\"group\"\n          control={control}\n          rules={{\n            required: { value: true, message: t('alerting.group-and-namespace-fields.message.required', 'Required.') },\n          }}\n        />\n      </Field>\n    </div>\n  );\n};\n\nconst getStyle = (theme: GrafanaTheme2) => ({\n  flexRow: css({\n    display: 'flex',\n    flexDirection: 'row',\n    justifyContent: 'flex-start',\n\n    '& > * + *': {\n      marginLeft: theme.spacing(3),\n    },\n  }),\n  input: css({\n    width: '330px !important',\n  }),\n});\n","import { css } from '@emotion/css';\nimport { Controller, useFormContext } from 'react-hook-form';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { t } from '@grafana/i18n';\nimport { Field, Input, Select, useStyles2 } from '@grafana/ui';\n\nimport { RuleFormType, RuleFormValues } from '../../types/rule-form';\nimport { timeOptions } from '../../utils/time';\n\nimport { GroupAndNamespaceFields } from './GroupAndNamespaceFields';\nimport { PreviewRule } from './PreviewRule';\nimport { RuleEditorSection } from './RuleEditorSection';\n\nexport const CloudEvaluationBehavior = () => {\n  const styles = useStyles2(getStyles);\n  const {\n    register,\n    control,\n    watch,\n    formState: { errors },\n  } = useFormContext<RuleFormValues>();\n\n  const type = watch('type');\n  const dataSourceName = watch('dataSourceName');\n\n  return (\n    <RuleEditorSection\n      stepNo={3}\n      title={t('alerting.cloud-evaluation-behavior.title-set-evaluation-behavior', 'Set evaluation behavior')}\n    >\n      <Field\n        label={t('alerting.cloud-evaluation-behavior.label-pending-period', 'Pending period')}\n        description={t(\n          'alerting.cloud-evaluation-behavior.description-pending-period',\n          'Period during which the threshold condition must be met to trigger an alert. Selecting \"None\" triggers the alert immediately once the condition is met.'\n        )}\n      >\n        <div className={styles.flexRow}>\n          <Field invalid={!!errors.forTime?.message} error={errors.forTime?.message} className={styles.inlineField}>\n            <Input\n              {...register('forTime', {\n                pattern: {\n                  value: /^\\d+$/,\n                  message: t(\n                    'alerting.cloud-evaluation-behavior.message.must-be-a-positive-integer',\n                    'Must be a positive integer.'\n                  ),\n                },\n              })}\n              width={8}\n            />\n          </Field>\n          <Controller\n            name=\"forTimeUnit\"\n            render={({ field: { onChange, ref, ...field } }) => (\n              <Select\n                {...field}\n                options={timeOptions}\n                onChange={(value) => onChange(value?.value)}\n                width={15}\n                className={styles.timeUnit}\n              />\n            )}\n            control={control}\n          />\n        </div>\n      </Field>\n      {type === RuleFormType.cloudAlerting && dataSourceName && (\n        <GroupAndNamespaceFields rulesSourceName={dataSourceName} />\n      )}\n\n      <PreviewRule />\n    </RuleEditorSection>\n  );\n};\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  inlineField: css({\n    marginBottom: 0,\n  }),\n  flexRow: css({\n    display: 'flex',\n    flexDirection: 'row',\n    justifyContent: 'flex-start',\n    alignItems: 'flex-start',\n  }),\n  timeUnit: css({\n    marginLeft: theme.spacing(0.5),\n  }),\n});\n","import { useFormContext } from 'react-hook-form';\n\nimport { t } from '@grafana/i18n';\n\nimport { RuleFormValues } from '../../types/rule-form';\n\nimport { GroupAndNamespaceFields } from './GroupAndNamespaceFields';\nimport { RuleEditorSection } from './RuleEditorSection';\n\nexport function RecordingRulesNameSpaceAndGroupStep() {\n  const { watch } = useFormContext<RuleFormValues>();\n\n  const dataSourceName = watch('dataSourceName');\n\n  if (!dataSourceName) {\n    return null;\n  }\n\n  return (\n    <RuleEditorSection\n      stepNo={3}\n      title={t(\n        'alerting.recording-rules-name-space-and-group-step.title-add-namespace-and-group',\n        'Add namespace and group'\n      )}\n      description={t(\n        'alerting.recording-rules-name-space-and-group-step.description-select-namespace-group-recording',\n        'Select the Namespace and Group for your recording rule.'\n      )}\n    >\n      <GroupAndNamespaceFields rulesSourceName={dataSourceName} />\n    </RuleEditorSection>\n  );\n}\n","import { css } from '@emotion/css';\nimport { useCallback, useEffect, useMemo, useState } from 'react';\nimport { FormProvider, SubmitErrorHandler, UseFormWatch, useForm } from 'react-hook-form';\nimport { useParams } from 'react-router-dom-v5-compat';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { Trans, t } from '@grafana/i18n';\nimport { config, locationService } from '@grafana/runtime';\nimport { Alert, Button, Stack, useStyles2 } from '@grafana/ui';\nimport { useAppNotification } from 'app/core/copy/appNotification';\nimport { contextSrv } from 'app/core/core';\nimport InfoPausedRule from 'app/features/alerting/unified/components/InfoPausedRule';\nimport {\n  getRuleGroupLocationFromFormValues,\n  getRuleGroupLocationFromRuleWithLocation,\n  isCloudAlertingRuleByType,\n  isCloudRecordingRuleByType,\n  isGrafanaManagedRuleByType,\n  isPausedRule,\n  isRecordingRuleByType,\n  rulerRuleType,\n} from 'app/features/alerting/unified/utils/rules';\nimport { isExpressionQuery } from 'app/features/expressions/guards';\nimport { RuleGroupIdentifier, RuleWithLocation } from 'app/types/unified-alerting';\nimport { PostableRuleGrafanaRuleDTO, RulerRuleDTO } from 'app/types/unified-alerting-dto';\n\nimport {\n  LogMessages,\n  logInfo,\n  logWarning,\n  trackAlertRuleFormCancelled,\n  trackAlertRuleFormError,\n  trackAlertRuleFormSaved,\n  trackNewGrafanaAlertRuleFormCancelled,\n  trackNewGrafanaAlertRuleFormError,\n  trackNewGrafanaAlertRuleFormSavedSuccess,\n} from '../../../Analytics';\nimport {\n  GrafanaGroupUpdatedResponse,\n  RulerGroupUpdatedResponse,\n  isGrafanaGroupUpdatedResponse,\n} from '../../../api/alertRuleModel';\nimport { useAddRuleToRuleGroup, useUpdateRuleInRuleGroup } from '../../../hooks/ruleGroup/useUpsertRuleFromRuleGroup';\nimport {\n  defaultFormValuesForRuleType,\n  formValuesFromExistingRule,\n  formValuesFromPrefill,\n  translateRouteParamToRuleType,\n} from '../../../rule-editor/formDefaults';\nimport {\n  areQueriesTransformableToSimpleCondition,\n  isExpressionQueryInAlert,\n} from '../../../rule-editor/formProcessing';\nimport { RuleFormType, RuleFormValues } from '../../../types/rule-form';\nimport { rulesNav } from '../../../utils/navigation';\nimport {\n  MANUAL_ROUTING_KEY,\n  SIMPLIFIED_QUERY_EDITOR_KEY,\n  formValuesToRulerGrafanaRuleDTO,\n  formValuesToRulerRuleDTO,\n} from '../../../utils/rule-form';\nimport { fromRulerRule, fromRulerRuleAndRuleGroupIdentifier } from '../../../utils/rule-id';\nimport { GrafanaRuleExporter } from '../../export/GrafanaRuleExporter';\nimport { AlertRuleNameAndMetric } from '../AlertRuleNameInput';\nimport AnnotationsStep from '../AnnotationsStep';\nimport { CloudEvaluationBehavior } from '../CloudEvaluationBehavior';\nimport { GrafanaEvaluationBehaviorStep } from '../GrafanaEvaluationBehavior';\nimport { GrafanaFolderAndLabelsStep } from '../GrafanaFolderAndLabelsStep';\nimport { NotificationsStep } from '../NotificationsStep';\nimport { RecordingRulesNameSpaceAndGroupStep } from '../RecordingRulesNameSpaceAndGroupStep';\nimport { RuleInspector } from '../RuleInspector';\nimport { QueryAndExpressionsStep } from '../query-and-alert-condition/QueryAndExpressionsStep';\n\ntype Props = {\n  existing?: RuleWithLocation;\n  prefill?: Partial<RuleFormValues>; // Existing implies we modify existing rule. Prefill only provides default form values\n  isManualRestore?: boolean;\n};\n\nexport const AlertRuleForm = ({ existing, prefill, isManualRestore }: Props) => {\n  const styles = useStyles2(getStyles);\n  const notifyApp = useAppNotification();\n\n  const routeParams = useParams<{ type: string; id: string }>();\n  const uidFromParams = routeParams.id;\n\n  const { redirectToDetailsPage } = useRedirectToDetailsPage(uidFromParams);\n  const [showEditYaml, setShowEditYaml] = useState(false);\n\n  const [addRuleToRuleGroup] = useAddRuleToRuleGroup();\n  const [updateRuleInRuleGroup] = useUpdateRuleInRuleGroup();\n\n  const ruleType = translateRouteParamToRuleType(routeParams.type);\n\n  const defaultValues: RuleFormValues = useMemo(() => {\n    // If we have an existing AND a prefill, then we're coming from the restore dialog\n    // and we want to merge the two\n    if (existing && prefill) {\n      return { ...formValuesFromExistingRule(existing), ...formValuesFromPrefill(prefill) };\n    }\n    if (existing) {\n      return formValuesFromExistingRule(existing);\n    }\n\n    if (prefill) {\n      return formValuesFromPrefill(prefill);\n    }\n\n    return defaultFormValuesForRuleType(ruleType);\n  }, [existing, prefill, ruleType]);\n\n  const formAPI = useForm<RuleFormValues>({\n    mode: 'onSubmit',\n    defaultValues,\n    shouldFocusError: true,\n  });\n\n  const {\n    handleSubmit,\n    watch,\n    formState: { isSubmitting },\n    trigger,\n  } = formAPI;\n\n  useEffect(() => {\n    // If the user is manually restoring an old version of a rule,\n    // we should trigger validation on the form so any problem areas are clearly highlighted for them to action\n    if (isManualRestore) {\n      trigger();\n    }\n  }, [isManualRestore, trigger]);\n  const type = watch('type');\n  const grafanaTypeRule = isGrafanaManagedRuleByType(type ?? RuleFormType.grafana);\n\n  const dataSourceName = watch('dataSourceName');\n\n  const showDataSourceDependantStep = Boolean(type && (isGrafanaManagedRuleByType(type) || !!dataSourceName));\n\n  const [conditionErrorMsg, setConditionErrorMsg] = useState('');\n\n  const checkAlertCondition = (msg = '') => {\n    setConditionErrorMsg(msg);\n  };\n\n  // @todo why is error not propagated to form?\n  const submit = async (values: RuleFormValues): Promise<void> => {\n    const { type, evaluateEvery } = values;\n\n    if (conditionErrorMsg !== '') {\n      notifyApp.error(conditionErrorMsg);\n      if (!existing && grafanaTypeRule) {\n        // new Grafana-managed rule\n        trackNewGrafanaAlertRuleFormError();\n      }\n      return;\n    }\n\n    trackAlertRuleFormSaved({ formAction: existing ? 'update' : 'create', ruleType: type });\n\n    const ruleDefinition = grafanaTypeRule ? formValuesToRulerGrafanaRuleDTO(values) : formValuesToRulerRuleDTO(values);\n\n    const ruleGroupIdentifier = existing\n      ? getRuleGroupLocationFromRuleWithLocation(existing)\n      : getRuleGroupLocationFromFormValues(values);\n\n    const targetRuleGroupIdentifier = getRuleGroupLocationFromFormValues(values);\n\n    let saveResult: RulerGroupUpdatedResponse;\n    // @TODO move this to a hook too to make sure the logic here is tested for regressions?\n    if (!existing) {\n      // when creating a new rule, we save the manual routing setting , and editorSettings.simplifiedQueryEditor to the local storage\n      storeInLocalStorageValues(values);\n      // save the rule to the rule group\n      saveResult = await addRuleToRuleGroup.execute(ruleGroupIdentifier, ruleDefinition, evaluateEvery);\n      // track the new Grafana-managed rule creation in the analytics\n      if (grafanaTypeRule) {\n        const dataQueries = values.queries.filter((query) => !isExpressionQuery(query.model));\n        const expressionQueries = values.queries.filter((query) => isExpressionQueryInAlert(query));\n        trackNewGrafanaAlertRuleFormSavedSuccess({\n          simplifiedQueryEditor: values.editorSettings?.simplifiedQueryEditor ?? false,\n          simplifiedNotificationEditor: values.editorSettings?.simplifiedNotificationEditor ?? false,\n          canBeTransformedToSimpleQuery: areQueriesTransformableToSimpleCondition(dataQueries, expressionQueries),\n        });\n      }\n    } else {\n      // when updating an existing rule\n      const ruleIdentifier = fromRulerRuleAndRuleGroupIdentifier(ruleGroupIdentifier, existing.rule);\n      saveResult = await updateRuleInRuleGroup.execute(\n        ruleGroupIdentifier,\n        ruleIdentifier,\n        ruleDefinition,\n        targetRuleGroupIdentifier,\n        evaluateEvery\n      );\n    }\n\n    redirectToDetailsPage(ruleDefinition, targetRuleGroupIdentifier, saveResult);\n    return;\n  };\n\n  const onInvalid: SubmitErrorHandler<RuleFormValues> = (errors): void => {\n    trackAlertRuleFormError({\n      grafana_version: config.buildInfo.version,\n      org_id: contextSrv.user.orgId,\n      user_id: contextSrv.user.id,\n      error: Object.keys(errors).toString(),\n      formAction: existing ? 'update' : 'create',\n    });\n    notifyApp.error('There are errors in the form. Please correct them and try again!');\n  };\n\n  const cancelRuleCreation = () => {\n    logInfo(LogMessages.cancelSavingAlertRule);\n    trackAlertRuleFormCancelled({ formAction: existing ? 'update' : 'create' });\n    if (!existing && grafanaTypeRule) {\n      // new Grafana-managed rule\n      trackNewGrafanaAlertRuleFormCancelled();\n    }\n    locationService.getHistory().goBack();\n  };\n\n  if (!type) {\n    return null;\n  }\n\n  const isPaused = rulerRuleType.grafana.rule(existing?.rule) && isPausedRule(existing?.rule);\n\n  return (\n    <FormProvider {...formAPI}>\n      <form onSubmit={(e) => e.preventDefault()} className={styles.form}>\n        <div className={styles.contentOuter}>\n          {isManualRestore && (\n            <Alert\n              severity=\"warning\"\n              title={t('alerting.alertVersionHistory.warning-restore-manually-title', 'Restoring rule manually')}\n            >\n              <Trans i18nKey=\"alerting.alertVersionHistory.warning-restore-manually\">\n                You are manually restoring an old version of this alert rule. Please review the changes carefully before\n                saving the rule definition.\n              </Trans>\n            </Alert>\n          )}\n          {isPaused && <InfoPausedRule />}\n          <Stack direction=\"column\" gap={3}>\n            {/* Step 1 */}\n            <AlertRuleNameAndMetric />\n            {/* Step 2 */}\n            <QueryAndExpressionsStep editingExistingRule={!!existing} onDataChange={checkAlertCondition} mode=\"edit\" />\n            {/* Step 3-4-5 */}\n            {showDataSourceDependantStep && (\n              <>\n                {/* Step 3 */}\n                {isGrafanaManagedRuleByType(type) && <GrafanaFolderAndLabelsStep />}\n\n                {isCloudAlertingRuleByType(type) && <CloudEvaluationBehavior />}\n\n                {isCloudRecordingRuleByType(type) && <RecordingRulesNameSpaceAndGroupStep />}\n\n                {/* Step 4 & 5 & 6*/}\n                {isGrafanaManagedRuleByType(type) && (\n                  <GrafanaEvaluationBehaviorStep existing={Boolean(existing)} enableProvisionedGroups={false} />\n                )}\n                {/* Notifications step*/}\n                <NotificationsStep alertUid={uidFromParams} />\n                {/* Annotations only for alerting rules */}\n                {!isRecordingRuleByType(type) && <AnnotationsStep />}\n              </>\n            )}\n\n            {/* actions */}\n            <Stack direction=\"row\" alignItems=\"center\">\n              <Button\n                data-testid=\"save-rule\"\n                variant=\"primary\"\n                type=\"button\"\n                onClick={handleSubmit((values) => submit(values), onInvalid)}\n                disabled={isSubmitting}\n                icon={isSubmitting ? 'spinner' : undefined}\n              >\n                <Trans i18nKey=\"alerting.alert-rule-form.action-buttons.save\">Save</Trans>\n              </Button>\n\n              <Button variant=\"secondary\" disabled={isSubmitting} type=\"button\" onClick={cancelRuleCreation}>\n                <Trans i18nKey=\"alerting.common.cancel\">Cancel</Trans>\n              </Button>\n\n              {existing && isCortexLokiOrRecordingRule(watch) && (\n                <Button variant=\"secondary\" type=\"button\" onClick={() => setShowEditYaml(true)} disabled={isSubmitting}>\n                  <Trans i18nKey=\"alerting.alert-rule-form.action-buttons.edit-yaml\">Edit YAML</Trans>\n                </Button>\n              )}\n            </Stack>\n          </Stack>\n        </div>\n      </form>\n\n      {showEditYaml && (\n        <>\n          {grafanaTypeRule && uidFromParams && (\n            <GrafanaRuleExporter alertUid={uidFromParams} onClose={() => setShowEditYaml(false)} />\n          )}\n\n          {!grafanaTypeRule && <RuleInspector onClose={() => setShowEditYaml(false)} />}\n        </>\n      )}\n    </FormProvider>\n  );\n};\n\nfunction useRedirectToDetailsPage(existingUid?: string) {\n  const notifyApp = useAppNotification();\n\n  const redirectGrafanaRule = useCallback(\n    (saveResult: GrafanaGroupUpdatedResponse) => {\n      // if the response contains no created or updated rules, we'll use the existing UID.\n      const newOrUpdatedRuleUid = (saveResult.created?.at(0) || saveResult.updated?.at(0)) ?? existingUid;\n      if (newOrUpdatedRuleUid) {\n        locationService.replace(\n          rulesNav.detailsPageLink('grafana', { uid: newOrUpdatedRuleUid, ruleSourceName: 'grafana' }, undefined, {\n            skipSubPath: true,\n          })\n        );\n      } else {\n        notifyApp.error(\n          'Cannot navigate to the new rule details page.',\n          'The rule was created but the UID is missing.'\n        );\n        logWarning('Cannot navigate to the new rule details page. The rule was created but the UID is missing.');\n      }\n    },\n    [existingUid, notifyApp]\n  );\n\n  const redirectCloudRulerRule = useCallback((rule: RulerRuleDTO, groupId: RuleGroupIdentifier) => {\n    const { dataSourceName, namespaceName, groupName } = groupId;\n    const updatedRuleIdentifier = fromRulerRule(dataSourceName, namespaceName, groupName, rule);\n    locationService.replace(\n      rulesNav.detailsPageLink(updatedRuleIdentifier.ruleSourceName, updatedRuleIdentifier, undefined, {\n        skipSubPath: true,\n      })\n    );\n  }, []);\n\n  const redirectToDetailsPage = useCallback(\n    (\n      rule: RulerRuleDTO | PostableRuleGrafanaRuleDTO,\n      groupId: RuleGroupIdentifier,\n      saveResult: RulerGroupUpdatedResponse\n    ) => {\n      if (isGrafanaGroupUpdatedResponse(saveResult)) {\n        redirectGrafanaRule(saveResult);\n        return;\n      } else if (rulerRuleType.dataSource.rule(rule)) {\n        redirectCloudRulerRule(rule, groupId);\n        return;\n      }\n\n      logWarning(\n        'Cannot navigate to the new rule details page. The response is not a GrafanaGroupUpdatedResponse and ruleDefinition is not a Cloud Ruler rule.',\n        { ruleFormType: rulerRuleType.dataSource.rule(rule) ? 'datasource' : 'grafana' }\n      );\n    },\n    [redirectGrafanaRule, redirectCloudRulerRule]\n  );\n\n  return { redirectToDetailsPage };\n}\n\nconst isCortexLokiOrRecordingRule = (watch: UseFormWatch<RuleFormValues>) => {\n  const [ruleType, dataSourceName] = watch(['type', 'dataSourceName']);\n\n  return (ruleType === RuleFormType.cloudAlerting || ruleType === RuleFormType.cloudRecording) && dataSourceName !== '';\n};\n\nfunction storeInLocalStorageValues(values: RuleFormValues) {\n  const { manualRouting, editorSettings } = values;\n\n  if (manualRouting) {\n    localStorage.setItem(MANUAL_ROUTING_KEY, 'true');\n  } else {\n    localStorage.setItem(MANUAL_ROUTING_KEY, 'false');\n  }\n\n  if (editorSettings) {\n    if (editorSettings.simplifiedQueryEditor) {\n      localStorage.setItem(SIMPLIFIED_QUERY_EDITOR_KEY, 'true');\n    } else {\n      localStorage.setItem(SIMPLIFIED_QUERY_EDITOR_KEY, 'false');\n    }\n  }\n}\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  form: css({\n    width: '100%',\n    height: '100%',\n    display: 'flex',\n    flexDirection: 'column',\n  }),\n  contentOuter: css({\n    background: theme.colors.background.primary,\n    overflow: 'hidden',\n    maxWidth: theme.breakpoints.values.xl,\n    flex: 1,\n  }),\n});\n","import { cloneDeep } from 'lodash';\n\nimport { RuleWithLocation } from 'app/types/unified-alerting';\nimport { RulerRuleDTO } from 'app/types/unified-alerting-dto';\n\nimport { generateCopiedName } from '../utils/duplicate';\nimport { getRuleName, rulerRuleType } from '../utils/rules';\n\nexport function changeRuleName(rule: RulerRuleDTO, newName: string) {\n  if (rulerRuleType.grafana.rule(rule)) {\n    rule.grafana_alert.title = newName;\n  }\n  if (rulerRuleType.dataSource.alertingRule(rule)) {\n    rule.alert = newName;\n  }\n\n  if (rulerRuleType.dataSource.recordingRule(rule)) {\n    rule.record = newName;\n  }\n}\n\nexport function cloneRuleDefinition(rule: RuleWithLocation<RulerRuleDTO>) {\n  const ruleClone = cloneDeep(rule);\n  changeRuleName(\n    ruleClone.rule,\n    generateCopiedName(getRuleName(ruleClone.rule), ruleClone.group.rules.map(getRuleName))\n  );\n\n  if (rulerRuleType.grafana.rule(ruleClone.rule)) {\n    ruleClone.rule.grafana_alert.uid = '';\n\n    // Provisioned alert rules have provisioned alert group which cannot be used in UI\n    if (Boolean(ruleClone.rule.grafana_alert.provenance)) {\n      ruleClone.group = { name: '', rules: ruleClone.group.rules };\n    }\n  }\n\n  return ruleClone;\n}\n","import { NavModelItem } from '@grafana/data';\nimport { Trans, t } from '@grafana/i18n';\nimport { Alert, Stack } from '@grafana/ui';\nimport { RuleIdentifier } from 'app/types/unified-alerting';\n\nimport { AlertWarning } from '../AlertWarning';\nimport { AlertingPageWrapper } from '../components/AlertingPageWrapper';\nimport { AlertRuleForm } from '../components/rule-editor/alert-rule-form/AlertRuleForm';\nimport { FederatedRuleWarning } from '../components/rule-viewer/FederatedRuleWarning';\nimport { useRuleWithLocation } from '../hooks/useCombinedRule';\nimport { useIsRuleEditable } from '../hooks/useIsRuleEditable';\nimport { RuleFormValues } from '../types/rule-form';\nimport { Annotation } from '../utils/constants';\nimport { stringifyErrorLike } from '../utils/misc';\nimport { rulerRuleToFormValues } from '../utils/rule-form';\nimport * as ruleId from '../utils/rule-id';\nimport { isFederatedRuleGroup, rulerRuleType } from '../utils/rules';\n\nimport { defaultPageNav } from './RuleEditor';\nimport { cloneRuleDefinition } from './clone.utils';\ninterface ExistingRuleEditorProps {\n  identifier: RuleIdentifier;\n  // Provide prefill if we are trying to restore an old version of an alert rule but we need the user to manually tweak the values\n  prefill?: Partial<RuleFormValues>;\n  // indicate if this is a manual restore\n  isManualRestore?: boolean;\n  // indicate if this is a cloning operation\n  clone?: boolean;\n}\n\nexport function ExistingRuleEditor({\n  identifier,\n  prefill,\n  isManualRestore = false,\n  clone = false,\n}: ExistingRuleEditorProps) {\n  const ruleSourceName = ruleId.ruleIdentifierToRuleSourceName(identifier);\n  const {\n    loading: loadingAlertRule,\n    result: ruleWithLocation,\n    error: fetchRuleError,\n  } = useRuleWithLocation({ ruleIdentifier: identifier });\n  const {\n    isEditable,\n    loading: loadingEditable,\n    error: errorEditable,\n  } = useIsRuleEditable(ruleSourceName, ruleWithLocation?.rule);\n\n  if (fetchRuleError || errorEditable) {\n    return (\n      <AlertingPageWrapper navId=\"alert-list\" pageNav={getPageNav()}>\n        <Alert\n          severity=\"error\"\n          title={t('alerting.existing-rule-editor.title-failed-to-load-rule', 'Failed to load rule')}\n        >\n          {stringifyErrorLike(errorEditable ?? fetchRuleError)}\n        </Alert>\n      </AlertingPageWrapper>\n    );\n  }\n\n  const loading = loadingAlertRule || loadingEditable;\n  if (loading) {\n    return (\n      <AlertingPageWrapper navId=\"alert-list\" pageNav={getPageNav()} isLoading={true}>\n        {null}\n      </AlertingPageWrapper>\n    );\n  }\n\n  if (!ruleWithLocation && !loading) {\n    return (\n      <AlertingPageWrapper navId=\"alert-list\" pageNav={getPageNav()}>\n        <AlertWarning title={t('alerting.existing-rule-editor.title-rule-not-found', 'Rule not found')}>\n          <Trans i18nKey=\"alerting.existing-rule-editor.sorry-this-rule-does-not-exist\">\n            Sorry! This rule does not exist.\n          </Trans>\n        </AlertWarning>\n      </AlertingPageWrapper>\n    );\n  }\n\n  if (isEditable === false) {\n    return (\n      <AlertingPageWrapper navId=\"alert-list\" pageNav={getPageNav()}>\n        <AlertWarning title={t('alerting.existing-rule-editor.title-cannot-edit-rule', 'Cannot edit rule')}>\n          <Trans i18nKey=\"alerting.existing-rule-editor.sorry-permission\">\n            Sorry! You do not have permission to edit this rule.\n          </Trans>\n        </AlertWarning>\n      </AlertingPageWrapper>\n    );\n  }\n\n  // we shouldn't get here because loading / error handling happens before this\n  if (!ruleWithLocation) {\n    return null;\n  }\n\n  const rulerRule = ruleWithLocation.rule;\n  const summary = rulerRuleType.any.alertingRule(rulerRule) ? rulerRule.annotations?.[Annotation.summary] : null;\n\n  const isFederatedRule = isFederatedRuleGroup(ruleWithLocation.group);\n  const isRecordingRule = rulerRuleType.any.recordingRule(rulerRule);\n\n  const pageTitle = isRecordingRule\n    ? t('alerting.editor.edit-recording-rule', 'Edit recording rule')\n    : t('alerting.editor.edit-alert-rule', 'Edit alert rule');\n\n  return (\n    <AlertingPageWrapper\n      navId=\"alert-list\"\n      subTitle={\n        <Stack direction=\"column\">\n          {summary}\n          {/* alerts and notifications and stuff */}\n          {isFederatedRule && <FederatedRuleWarning />}\n        </Stack>\n      }\n      pageNav={getPageNav({ text: pageTitle })}\n    >\n      {clone ? (\n        <AlertRuleForm prefill={rulerRuleToFormValues(cloneRuleDefinition(ruleWithLocation))} />\n      ) : (\n        <AlertRuleForm existing={ruleWithLocation} prefill={prefill} isManualRestore={isManualRestore} />\n      )}\n    </AlertingPageWrapper>\n  );\n}\n\nconst getPageNav = (pageNavOptions?: Partial<NavModelItem>): NavModelItem => {\n  return { ...defaultPageNav, id: 'alert-rule-edit', text: '', ...pageNavOptions };\n};\n","import { useParams } from 'react-router-dom-v5-compat';\n\nimport { NavModelItem } from '@grafana/data';\nimport { Trans, t } from '@grafana/i18n';\n\nimport { AlertWarning } from '../AlertWarning';\nimport { AlertingPageWrapper } from '../components/AlertingPageWrapper';\nimport { AlertRuleForm } from '../components/rule-editor/alert-rule-form/AlertRuleForm';\nimport { useURLSearchParams } from '../hooks/useURLSearchParams';\nimport { useRulesAccess } from '../utils/accessControlHooks';\nimport * as ruleId from '../utils/rule-id';\nimport { withPageErrorBoundary } from '../withPageErrorBoundary';\n\nimport { ExistingRuleEditor } from './ExistingRuleEditor';\nimport { formValuesFromQueryParams, translateRouteParamToRuleType } from './formDefaults';\nexport type RuleEditorPathParams = {\n  id?: string;\n  type?: 'recording' | 'alerting' | 'grafana-recording';\n};\n\nexport const defaultPageNav: Partial<NavModelItem> = {\n  id: 'alert-rule-view',\n};\n\nconst RuleEditor = () => {\n  const { identifier } = useRuleEditorPathParams();\n  const cloneIdentifier = useIdentifierFromCopy();\n  const isManualRestore = useManualRestore();\n\n  const { canCreateGrafanaRules, canCreateCloudRules, canEditRules } = useRulesAccess();\n\n  if (!identifier && !canCreateGrafanaRules && !canCreateCloudRules) {\n    return (\n      <AlertWarning title={t('alerting.rule-editor.get-content.title-cannot-create-rules', 'Cannot create rules')}>\n        <Trans i18nKey=\"alerting.rule-editor.get-content.sorry-allowed-create-rules\">\n          Sorry! You are not allowed to create rules.\n        </Trans>\n      </AlertWarning>\n    );\n  }\n\n  if (identifier && !canEditRules(identifier.ruleSourceName)) {\n    return (\n      <AlertWarning title={t('alerting.rule-editor.get-content.title-cannot-edit-rules', 'Cannot edit rules')}>\n        <Trans i18nKey=\"alerting.rule-editor.get-content.sorry-allowed-rules\">\n          Sorry! You are not allowed to edit rules.\n        </Trans>\n      </AlertWarning>\n    );\n  }\n\n  if (identifier) {\n    return (\n      <ExistingRuleEditor key={JSON.stringify(identifier)} identifier={identifier} isManualRestore={isManualRestore} />\n    );\n  }\n\n  if (cloneIdentifier) {\n    return (\n      <ExistingRuleEditor\n        key={JSON.stringify(identifier)}\n        identifier={cloneIdentifier}\n        clone={true}\n        isManualRestore={isManualRestore}\n      />\n    );\n  }\n\n  // for new alerting or recording rules\n  return <NewRuleEditor />;\n};\n\nexport const RECORDING_TYPE = ['grafana-recording', 'recording'];\n\n/**\n * This one is used for creating new rules (both alerting and recording rules)\n */\nfunction NewRuleEditor() {\n  const prefill = useDefaultsFromQuery();\n  const isManualRestore = useManualRestore();\n  const { type = '', identifier = '' } = useRuleEditorPathParams();\n\n  const isExisting = Boolean(identifier);\n  const isRecordingRule = RECORDING_TYPE.includes(type);\n\n  const newText = isRecordingRule\n    ? t('alerting.editor.new-recording-rule', 'New recording rule')\n    : t('alerting.editor.new-alert-rule', 'New alert rule');\n\n  const editText = isRecordingRule\n    ? t('alerting.editor.edit-recording-rule', 'Edit recording rule')\n    : t('alerting.editor.edit-alert-rule', 'Edit alert rule');\n\n  return (\n    <AlertingPageWrapper\n      navId=\"alert-list\"\n      pageNav={{\n        id: 'alert-rule-add',\n        text: isExisting ? editText : newText,\n      }}\n    >\n      <AlertRuleForm prefill={prefill} isManualRestore={isManualRestore} />\n    </AlertingPageWrapper>\n  );\n}\n\n// The pageNav property makes it difficult to only rely on AlertingPageWrapper\n// to catch errors.\nexport default withPageErrorBoundary(RuleEditor);\n\nfunction useRuleEditorPathParams() {\n  const params = useParams<RuleEditorPathParams>();\n  const { type } = params;\n  const id = ruleId.getRuleIdFromPathname(params);\n  const identifier = ruleId.tryParse(id, true);\n\n  return { identifier, type };\n}\n\nfunction useIdentifierFromCopy() {\n  const [searchParams] = useURLSearchParams();\n  const copyFromId = searchParams.get('copyFrom') ?? undefined;\n\n  return ruleId.tryParse(copyFromId);\n}\n\nfunction useDefaultsFromQuery() {\n  const { type } = useRuleEditorPathParams();\n  const [searchParams] = useURLSearchParams();\n\n  const ruleType = translateRouteParamToRuleType(type);\n\n  const queryDefaults = searchParams.has('defaults')\n    ? formValuesFromQueryParams(searchParams.get('defaults') ?? '', ruleType)\n    : undefined;\n\n  return queryDefaults;\n}\n\nfunction useManualRestore() {\n  const [searchParams] = useURLSearchParams();\n  const isManualRestore = searchParams.has('isManualRestore');\n\n  return isManualRestore;\n}\n","import { useMemo } from 'react';\n\nimport { getRulesAccess } from './access-control';\n\nexport function useRulesAccess() {\n  return useMemo(() => getRulesAccess(), []);\n}\n","export function generateCopiedName(originalName: string, exisitingNames: string[]) {\n  const nonDuplicateName = originalName.replace(/\\(copy( [0-9]+)?\\)$/, '').trim();\n\n  let newName = `${nonDuplicateName} (copy)`;\n\n  for (let i = 2; exisitingNames.includes(newName); i++) {\n    newName = `${nonDuplicateName} (copy ${i})`;\n  }\n\n  return newName;\n}\n"],"names":["CreateNewFolder","onCreate","isCreatingFolder","setIsCreatingFolder","handleCreate","folder","FolderCreationModal","onClose","styles","getStyles","notifyApp","title","setTitle","createFolder","onSubmit","data","error","e","theme","ExportNewGrafanaRulePage","GrafanaModifyExport","id","ruleIdentifier","RuleModifyExport","loading","rulerRule","GrafanaModifyExportPage","recordingRuleNameValidationPattern","type","AlertRuleNameAndMetric","control","register","watch","errors","setValue","ruleFormType","isRecording","isGrafanaRecordingRule","isCloudRecordingRule","recordingLabel","namePlaceholder","entityName","onChange","ref","field","ds","CloudRulesSourcePicker","value","disabled","props","dataSourcesWithRuler","isLoading","dataSourceFilter","uid","FolderSelector","resetGroup","handleFolderCreation","Stack","Field","Label","NestedFolderPicker","GrafanaFolderAndLabelsStep","getValues","showLabelsEditor","setShowLabelsEditor","onCloseLabelsEditor","labelsToUpdate","SectionDescription","Text","NeedHelpInfo","RuleEditorSection","LabelsFieldInForm","LabelsEditorModal","alertManager","trigger","selectedContactPointField","contactPointInForm","currentData","status","contactPointNotFound","contactPoint","LinkToContactPoints","FieldValidationMessage","TextLink","ActiveTimingFields","alertmanager","MuteTimingsSelector","MuteTimingFields","RouteTimings","formStyles","routeTimingsFields","PromDurationInput","groupInterval","REQUIRED_FIELDS_IN_GROUPBY","DEFAULTS_TIMINGS","DISABLE_GROUPING","RoutingSettings","groupByOptions","setGroupByOptions","groupIntervalValue","groupWaitValue","repeatIntervalValue","overrideGrouping","overrideTimings","groupByCount","separator","InlineField","Switch","opt","opts","MultiValue","AlertManagerManualRouting","alertManagerName","hasRouteSettings","CollapsableSection","SimplifiedRouting","contactPointsInAlert","alertManagersDataSourcesWithConfigAPI","am","selectedContactPoint","alertManagerContactPoint","index","NotificationPreviewByAlertManager","NotificationPreview","alertQueries","customLabels","condition","alertName","alertUid","previewEndpoint","alertRuleApi","previewUninitialized","potentialInstances","label","onPreview","alertManagerDataSources","onlyOneAM","Button","LoadingPlaceholder","alertManagerSource","RoutingOptions","useHasInternalAlertmanagerEnabled","useGetGrafanaAlertingConfigurationStatusQuery","alertmanagerApi","amChoiceStatus","NotificationsStep","manualRouting","dataSourceName","isGrafanaManaged","simplifiedModeInNotificationsStepEnabled","config","shouldRenderpreview","hasInternalAlertmanagerEnabled","shouldAllowSimplifiedRouting","step","switchMode","isAdvanced","ManualAndAutomaticRoutingSimplified","ManualAndAutomaticRouting","AutomaticRooting","routingOptions","onRoutingOptionChange","option","RadioButtonGroup","RoutingOptionDescription","labels","queries","NeedHelpInfoForNotificationPolicy","NeedHelpInfoForContactpoint","isCloudPreviewRequest","request","isGrafanaPreviewRequest","previewAlertRule","fetchAlertRulePreview","dataSourceUid","ruleType","withLoadingIndicator","createResponse","map","catchError","of","toDataQueryError","share","PreviewRuleResult","preview","fieldConfig","width","height","PanelRenderer","fields","PreviewRule","usePreview","allDataSourcesAvailable","useAlertQueriesStatus","isPreviewAvailable","Alert","setPreview","isMounted","useMountedState","values","createPreviewRequest","takeWhile","response","isCompleted","expression","dsSettings","ModifyExportRuleForm","ruleForm","defaultValuesForNewRule","defaultRuleType","formAPI","existing","returnTo","exportData","setExportData","conditionErrorMsg","setConditionErrorMsg","onInvalid","checkAlertCondition","msg","submit","GrafanaRuleDesignExporter","formValues","useGetGroup","nameSpaceUID","group","dsFeatures","rulerConfig","getPayloadToExport","existingGroup","ruleUid","grafanaRuleDto","updatedRule","alreadyExistsInGroup","updatedRules","rule","useGetPayloadToExport","rulerGroupDto","GrafanaRuleDesignExportPreview","exportFormat","exportValues","getExport","loadingGroup","payload","downloadFileName","exportingNewRule","initialTab","activeTab","setActiveTab","formatProviders","isOpen","initialLabels","onEditClick","text","hasLabels","mapDataFrameToAlertPreview","labelFields","stateFieldIndex","infoFieldIndex","labelIndexes","labelField","instanceStatusCount","instances","labelValues","labelIndex","state","info","CloudAlertPreview","alertPreview","instanceTags","AlertStateTag","TagList","Tooltip","Icon","ExpressionEditor","showPreviewAlertsButton","mapToValue","mapToQuery","useQueryMappers","dataQuery","dataSource","useAsync","onChangeQuery","query","onRunQueriesClick","dsi","errorMessage","previewLoaded","QueryEditor","previewDataFrame","s","previewHasAlerts","DataSourcePluginContextProvider","settings","ExpressionsEditor","onSetCondition","panelData","onUpdateRefId","onRemoveExpression","onUpdateExpressionType","onUpdateQueryExpression","expressionQueries","acc","isAlertCondition","errorFromCondition","warning","Expression","QueryOptions","queryOptions","onChangeTimeRange","onChangeQueryOptions","showOptions","setShowOptions","timeRange","Toggletip","RelativeTimeRangePicker","range","MaxDataPointsOption","options","MinIntervalOption","clearButton","DEFAULT_MAX_DATA_POINTS","DEFAULT_MIN_INTERVAL","QueryWrapper","onChangeDataSource","onRunQueries","onRemoveQuery","onDuplicateQuery","thresholds","thresholdsType","onChangeThreshold","dsInstance","setDsInstance","defaults","isAdvancedMode","queryWithDefaults","SelectingDataSourceTooltip","HeaderExtras","alertQueryOptions","ExpressionStatusIndicator","showVizualisation","editorQueries","QueryEditorRow","VizWrapper","EmptyQueryWrapper","children","onMaxDataPointsBlur","event","maxDataPointsNumber","maxDataPoints","Input","onMinIntervalBlur","minInterval","QueryRows","onQueriesChange","q","item","itemIndex","updatedQueries","previousSettings","copyModel","newModel","result","startIndex","endIndex","update","removed","expressions","thresholdByRefId","provided","isCondition","DatasourceNotFound","defaultDataSource","isInstant","newQuery","onUpdateDatasource","model","refId","showDetails","setShowDetails","toggleDetails","show","handleUpdateDatasource","QueryOperationRow","Card","onChangeQueries","RecordingRuleEditor","runQueries","setData","handleChangedQuery","changedQuery","dataSourceId","isLoki","expr","merged","err","QueryErrorAlert","CloudDataSourceSelector","onChangeCloudDatasource","NEW_REDUCER_REF","findDataSourceFromExpression","dag","originQuery","initialState","duplicateQuery","addNewDataQuery","setDataQueries","addNewExpression","removeExpression","removeExpressions","addExpressions","updateExpression","updateExpressionRefId","rewireExpressions","updateExpressionType","updateExpressionTimeRange","updateMaxDataPoints","updateMinInterval","resetToSimpleCondition","optimizeReduceExpression","setRecordingRulesQueries","queriesAndExpressionsReducer","builder","addQuery","datasource","recordingRuleQuery","action","queryToUpdate","originalQueries","relativeTimeRange","dataSourceAlertQuery","newRefId","oldRefId","isInstantDataQuery","reduceExpressionIndex","queryToAdd","defaultTimeRange","SimpleConditionEditor","simpleCondition","expressionQueriesList","dispatch","previewData","onReducerTypeChange","updateReduceExpression","isRange","thresholdFunction","fn","onEvalFunctionChange","updateThresholdFunction","onEvaluateValueChange","numericValue","draftCondition","updateThresholdValue","InlineFieldRow","Select","o","ThresholdSelect","ToLabel","reducer","reduceExpression","newReduceExpression","draft","evaluator","thresholdExpression","newThresholdExpression","getSimpleConditionFromExpressions","conditionsFromThreshold","whenField","params","onlyOneDSInQueries","getAvailableRuleTypes","canCreateGrafanaRules","canCreateCloudRules","enabledRuleTypes","getCanSwitch","rulesSourcesWithRuler","availableRuleTypes","onlyOneDS","dataSourceIdFromQueries","isRecordingRuleType","canSwitchToCloudRule","dsJsonData","canSwitchToGrafanaRule","grafanaTypeEnabled","cloudTypeEnabled","canSwitchFromCloudToGrafana","canSwitchFromGrafanaToCloud","SmartAlertTypeDetector","editingExistingRule","onClickSwitch","canSwitch","disabledOptions","DESCRIPTIONS","initializeSimpleCondition","isGrafanaAlertingType","dataQueries","determineAdvancedMode","simplifiedQueryEditor","useAdvancedMode","setSimpleCondition","QueryAndExpressionsStep","onDataChange","mode","queryPreviewData","cancelQueries","isPreviewLoading","clearPreviewData","useAlertQueryRunner","isSwitchModeEnabled","isOptimizeReducerEnabled","useEffectOnce","editorSettings","isCloudAlertRuleType","showResetModeModal","setShowResetModal","simplifiedQueryInForm","simplifiedQueryStep","rulerSourcesIsLoading","runQueriesPreview","lastExpression","noCompatibleDataSources","emptyQueries","currentCondition","handleSetCondition","updateExpressionAndDatasource","useSetExpressionAndDataSource","onChangeRecordingRulesQueries","recordingRuleDefaultDatasource","defaultQuery","lastRefId","onClickType","datasourceUid","newQueries","onChangeExpression","promLoki","removeExpressionsInQueries","addExpressionsInQueries","prevExpressions","setPrevExpressions","prevCondition","setPrevCondition","restoreExpressionsInQueries","newDsName","sectionTitle","helpLabel","helpContent","helpLink","canSelectDataSourceManaged","source","Divider","selectors","TypeSelectorButton","ConfirmModal","newMenu","Menu","MenuItem","Dropdown","useLazyDiscoverDsFeaturesQuery","useRulesSourcesWithRuler","setRulesSourcesWithRuler","discoverDsFeatures","prev","AlertWarning","warningStyles","isGrafanaGroupUpdatedResponse","isCloudGroupUpdatedResponse","GrafanaRuleExportPreview","ruleTextDefinition","isFetching","FileExportPreview","GrafanaRuleExporter","GrafanaExportDrawer","GroupAndNamespaceFields","rulesSourceName","style","getStyle","namespaceGroups","namespace","namespaceOptions","groupOptions","CloudEvaluationBehavior","time","RecordingRulesNameSpaceAndGroupStep","AlertRuleForm","prefill","isManualRestore","routeParams","uidFromParams","redirectToDetailsPage","useRedirectToDetailsPage","showEditYaml","setShowEditYaml","addRuleToRuleGroup","updateRuleInRuleGroup","defaultValues","handleSubmit","isSubmitting","grafanaTypeRule","showDataSourceDependantStep","evaluateEvery","ruleDefinition","ruleGroupIdentifier","targetRuleGroupIdentifier","saveResult","storeInLocalStorageValues","cancelRuleCreation","isPaused","InfoPausedRule","GrafanaEvaluationBehavior","AnnotationsStep","isCortexLokiOrRecordingRule","RuleInspector","existingUid","redirectGrafanaRule","newOrUpdatedRuleUid","redirectCloudRulerRule","groupId","namespaceName","groupName","updatedRuleIdentifier","changeRuleName","newName","cloneRuleDefinition","ruleClone","ExistingRuleEditor","identifier","clone","ruleSourceName","loadingAlertRule","ruleWithLocation","fetchRuleError","isEditable","loadingEditable","errorEditable","useIsRuleEditable","AlertingPageWrapper","getPageNav","summary","isFederatedRule","pageTitle","FederatedRuleWarning","pageNavOptions","defaultPageNav","RuleEditor","useRuleEditorPathParams","cloneIdentifier","useIdentifierFromCopy","useManualRestore","canEditRules","NewRuleEditor","RECORDING_TYPE","useDefaultsFromQuery","isExisting","isRecordingRule","newText","editText","withPageErrorBoundary","searchParams","useURLSearchParams","copyFromId","useRulesAccess","generateCopiedName","originalName","exisitingNames","nonDuplicateName","i"],"sourceRoot":""}