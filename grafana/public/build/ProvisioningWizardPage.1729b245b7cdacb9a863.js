"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[252],{70368:(H,S,r)=>{r.d(S,{w:()=>t});var e=r(92745),m=r(79162);function t(d){return d?(0,m.B)(d):{type:"github",title:(0,e.t)("provisioning.get-default-values.title.repository","Repository"),token:"",url:"",branch:"main",generateDashboardPreviews:!1,readOnly:!1,prWorkflow:!0,path:"grafana/",sync:{enabled:!1,target:"instance",intervalSeconds:60}}}},34888:(H,S,r)=>{r.d(S,{c:()=>l});var e=r(74848),m=r(41654),t=r(27594);const d=()=>[{id:"resource",header:"Resource",cell:({row:{original:i}})=>i.resource},{id:"created",header:"Created",cell:({row:{original:i}})=>i.create?.toString()||"-"},{id:"deleted",header:"Deleted",cell:({row:{original:i}})=>i.delete?.toString()||"-"},{id:"updated",header:"Updated",cell:({row:{original:i}})=>i.update?.toString()||"-"},{id:"unchanged",header:"Unchanged",cell:({row:{original:i}})=>i.noop?.toString()||"-"},{id:"errors",header:"Errors",cell:({row:{original:i}})=>i.error?.toString()||"-"},{id:"total",header:"Total",cell:({row:{original:i}})=>((i.create||0)+(i.delete||0)+(i.update||0)+(i.noop||0)+(i.error||0)).toString()}];function l({summary:i}){return(0,e.jsx)(m.B,{direction:"column",gap:2,children:(0,e.jsx)(t.j,{data:i,columns:d(),getRowId:x=>x.resource||"",pageSize:10})})}},48485:(H,S,r)=>{r.d(S,{c:()=>x});var e=r(74848),m=r(22803),t=r(92745),d=r(63142),l=r(41654),i=r(89640);function x(){const h=(0,d.of)(T);return(0,e.jsxs)("div",{className:h.container,children:[(0,e.jsxs)(l.B,{gap:.5,wrap:"wrap",children:[(0,e.jsx)(t.x6,{i18nKey:"provisioning.token-permissions-info.go-to",children:"Go to"}),(0,e.jsx)(i.Y,{external:!0,href:"https://github.com/settings/personal-access-tokens/new",children:"GitHub Personal Access Tokens"}),(0,e.jsx)(t.x6,{i18nKey:"provisioning.token-permissions-info.and-click",children:"and click"}),(0,e.jsx)("strong",{children:'"Fine-grained token".'}),(0,e.jsx)(t.x6,{i18nKey:"provisioning.token-permissions-info.make-sure",children:"Make sure to include these permissions"}),":"]}),(0,e.jsxs)("ul",{className:h.permissionsList,children:[(0,e.jsxs)("li",{children:["Content: ",(0,e.jsx)("span",{className:h.accessLevel,children:"Read and write"})]}),(0,e.jsxs)("li",{children:["Metadata: ",(0,e.jsx)("span",{className:h.accessLevel,children:"Read only"})]}),(0,e.jsxs)("li",{children:["Pull requests: ",(0,e.jsx)("span",{className:h.accessLevel,children:"Read and write"})]}),(0,e.jsxs)("li",{children:["Webhooks: ",(0,e.jsx)("span",{className:h.accessLevel,children:"Read and write"})]})]})]})}function T(h){return{container:(0,m.css)({marginBottom:h.spacing(1),position:"relative",width:"100%",display:"flex",flexDirection:"column",flex:"1 1 0",padding:h.spacing(h.components.panel.padding)}),permissionsList:(0,m.css)({marginTop:h.spacing(2),marginBottom:h.spacing(1),paddingLeft:h.spacing(3),li:(0,m.css)({marginBottom:h.spacing(1)})}),accessLevel:(0,m.css)({fontFamily:h.typography.fontFamilyMonospace,background:h.colors.background.secondary,borderRadius:h.shape.radius.default,padding:h.spacing(.25,.5)})}}},13833:(H,S,r)=>{r.r(S),r.d(S,{default:()=>Ge});var e=r(74848),m=r(54148),t=r(92745),d=r(13791),l=r(22803),i=r(96540),x=r(49785),T=r(32899),h=r(75234),Y=r(68143),$=r(63142),g=r(41654),z=r(31286),v=r(66404),V=r(34999),_=r(45861),P=r(33680),de=r(83813),pe=r(70368),Q=r(91555),ue=r(67170),ge=r(79162);const he=n=>{const o=["local.path","github.branch","github.url","github.token"],a={path:"repository.path",branch:"repository.branch",url:"repository.url",token:"repository.token"};for(const s of n)if(s.field){const c=s.field.replace("spec.","");if(o.includes(c)){const p=c.split("."),u=p[p.length-1];if(u in a)return[a[u],{message:s.detail||`Invalid ${u}`}]}}return[null,null]};var fe=r(6975),ee=r(8073),C=r(37386),K=r(63527);const re=(0,i.createContext)(void 0),ye=({children:n})=>{const[o,a]=(0,i.useState)({status:"idle"}),s=(0,i.useCallback)(p=>{a(p)},[]),c={stepStatusInfo:o,setStepStatusInfo:s,hasStepError:o.status==="error",isStepRunning:o.status==="running",isStepSuccess:o.status==="success",isStepIdle:o.status==="idle"};return(0,e.jsx)(re.Provider,{value:c,children:n})},J=()=>{const n=(0,i.useContext)(re);if(n===void 0)throw new Error("useStepStatus must be used within a StepStatusProvider");return n};function xe(n,o,a){const s=a?.items?.some(c=>c.target==="folder"&&c.name!==o);return n.filter(c=>a?.legacyStorage?c.target==="instance":c.target==="folder"?!0:c.target==="instance"?!s:!1)}function me(n,o){return(0,i.useMemo)(()=>{const a=[{target:"instance",label:(0,t.t)("provisioning.mode-options.instance.label","Sync all resources with external storage"),description:(0,t.t)("provisioning.mode-options.instance.description","Resources will be synced with external storage and provisioned into this instance. Existing Grafana resources will be migrated and merged if needed. After setup, all new resources and changes will be saved to external storage and automatically provisioned back into the instance."),subtitle:(0,t.t)("provisioning.mode-options.instance.subtitle","Use this option if you want to sync and manage your entire Grafana instance through external storage.")},{target:"folder",label:(0,t.t)("provisioning.mode-options.folder.label","Sync external storage to a new Grafana folder"),description:(0,t.t)("provisioning.mode-options.folder.description","After setup, a new Grafana folder will be created and synced with external storage. If any resources are present in external storage, they will be provisioned to this new folder. All new resources created in this folder will be stored and versioned in external storage."),subtitle:(0,t.t)("provisioning.mode-options.folder.subtitle","Use this option to sync external resources into a new folder without affecting the rest of your instance. You can repeat this process for up to 10 folders.")}];return xe(a,n,o)},[n,o])}function ve(n,o){const a=n?.items?.reduce((p,u)=>{const f=u.path??"";return f.endsWith(".json")||f.endsWith(".yaml")?p+1:p},0)??0;let s=[],c=0;return o?.instance?.forEach(p=>{switch(p.group){case"folders":case"folder.grafana.app":c+=p.count,s.push(`${p.count} ${p.count>1?"folders":"folder"}`);break;case"dashboard.grafana.app":c+=p.count,s.push(`${p.count} ${p.count>1?"dashboards":"dashboard"}`);break}}),{fileCount:a,resourceCount:c,resourceCountString:s.join(`,
`)}}function be({onOptionSelect:n,settingsData:o,repoName:a}){const{setStepStatusInfo:s}=J(),{register:c,control:p,setValue:u,watch:f,getValues:y,formState:{errors:j}}=(0,x.xW)(),I=(0,P.v$)(),L=(0,P.Bm)({name:a}),D=f("repository.sync.target"),B=me(a,o),{target:F}=B[0],{resourceCount:M,resourceCountString:W,fileCount:R}=(0,i.useMemo)(()=>ve(L.data,I.data),[L.data,I.data]),w=o?.legacyStorage||M>0,k=I.isLoading||L.isLoading;return(0,i.useEffect)(()=>{const A=y("repository");switch(A.type){case"github":const U=A.url??"github";u("repository.title",U.replace("https://github.com/",""));break;case"local":u("repository.title",A.path??"local");break}},[y,u]),(0,i.useEffect)(()=>{s({status:k?"running":"idle"})},[k,s]),(0,i.useEffect)(()=>{u("repository.sync.target",F),n(w)},[F,u,n,w]),k?(0,e.jsx)(z.a,{padding:4,children:(0,e.jsx)(fe._,{text:(0,t.t)("provisioning.bootstrap-step.text-loading-resource-information","Loading resource information...")})}):(0,e.jsx)(g.B,{direction:"column",gap:2,children:(0,e.jsxs)(g.B,{direction:"column",gap:2,children:[(0,e.jsx)(z.a,{alignItems:"center",padding:4,children:(0,e.jsxs)(g.B,{direction:"row",gap:4,alignItems:"flex-start",justifyContent:"center",children:[(0,e.jsxs)(g.B,{direction:"column",gap:1,alignItems:"center",children:[(0,e.jsx)(v.E,{color:"secondary",children:(0,e.jsx)(t.x6,{i18nKey:"provisioning.bootstrap-step.grafana",children:"Grafana instance"})}),(0,e.jsx)(g.B,{direction:"row",gap:2,children:(0,e.jsx)(v.E,{variant:"h4",children:M>0?W:(0,t.t)("provisioning.bootstrap-step.empty","Empty")})})]}),(0,e.jsxs)(g.B,{direction:"column",gap:1,alignItems:"center",children:[(0,e.jsx)(v.E,{color:"secondary",children:(0,e.jsx)(t.x6,{i18nKey:"provisioning.bootstrap-step.ext-storage",children:"External storage"})}),(0,e.jsx)(v.E,{variant:"h4",children:R>0?(0,t.t)("provisioning.bootstrap-step.files-count","{{count}} files",{count:R}):(0,t.t)("provisioning.bootstrap-step.empty","Empty")})]})]})}),(0,e.jsx)(x.xI,{name:"repository.sync.target",control:p,render:({field:{ref:A,onChange:U,...ne}})=>(0,e.jsx)(e.Fragment,{children:B.map(N=>(0,e.jsxs)(ee.Z,{isSelected:N.target===D,onClick:()=>{U(N.target)},noMargin:!0,...ne,children:[(0,e.jsx)(ee.Z.Heading,{children:N.label}),(0,e.jsx)(ee.Z.Description,{children:(0,e.jsxs)(g.B,{direction:"column",gap:3,children:[N.description,(0,e.jsx)(v.E,{color:"primary",children:N.subtitle})]})})]},N.target))})}),D==="folder"&&(0,e.jsx)(C.D,{label:(0,t.t)("provisioning.bootstrap-step.label-display-name","Display name"),description:(0,t.t)("provisioning.bootstrap-step.description-clear-repository-connection","Add a clear name for this repository connection"),error:j.repository?.title?.message,invalid:!!j.repository?.title,required:!0,noMargin:!0,children:(0,e.jsx)(K.p,{id:"repository-title",...c("repository.title",{required:(0,t.t)("provisioning.bootstrap-step.error-field-required","This field is required.")}),placeholder:(0,t.t)("provisioning.bootstrap-step.placeholder-my-repository-connection","My repository connection"),autoFocus:B.length===1&&B[0].target==="folder"})})]})})}var je=r(48767),Se=r(48485);function we(){const{register:n,control:o,setValue:a,formState:{errors:s},getValues:c}=(0,x.xW)(),[p,u]=(0,i.useState)(!1),f=c("repository.type"),y=f==="github";return(0,e.jsxs)(g.B,{direction:"column",children:[y&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(Se.c,{}),(0,e.jsx)(C.D,{noMargin:!0,label:(0,t.t)("provisioning.connect-step.label-access-token","GitHub access token"),required:!0,description:(0,t.t)("provisioning.connect-step.description-paste-your-git-hub-personal-access-token","Paste your GitHub personal access token"),error:s.repository?.token?.message,invalid:!!s.repository?.token,children:(0,e.jsx)(x.xI,{name:"repository.token",control:o,rules:{required:(0,t.t)("provisioning.connect-step.error-field-required","This field is required.")},render:({field:{ref:j,...I}})=>(0,e.jsx)(je.L4,{...I,id:"token",placeholder:(0,t.t)("provisioning.connect-step.placeholder-github-token","github_pat_yourTokenHere1234567890abcdEFGHijklMNOP"),isConfigured:p,onReset:()=>{a("repository.token",""),u(!1)}})})}),(0,e.jsx)(C.D,{noMargin:!0,label:(0,t.t)("provisioning.connect-step.label-repository-url","GitHub repository URL"),error:s.repository?.url?.message,invalid:!!s.repository?.url,description:(0,t.t)("provisioning.connect-step.description-repository-url","Paste the URL of your GitHub repository"),required:!0,children:(0,e.jsx)(K.p,{...n("repository.url",{required:(0,t.t)("provisioning.connect-step.error-field-required","This field is required."),pattern:{value:/^(?:https:\/\/github\.com\/)?[^/]+\/[^/]+$/,message:(0,t.t)("provisioning.connect-step.error-invalid-github-url","Please enter a valid GitHub repository URL")}}),id:"repository-url",placeholder:(0,t.t)("provisioning.connect-step.placeholder-github-url","https://github.com/username/repo")})}),(0,e.jsx)(C.D,{noMargin:!0,label:(0,t.t)("provisioning.connect-step.label-branch","Branch name"),description:(0,t.t)("provisioning.connect-step.description-branch","Branch to use for the GitHub repository"),error:s.repository?.branch?.message,invalid:!!s.repository?.branch,children:(0,e.jsx)(K.p,{...n("repository.branch"),id:"repository-branch",placeholder:(0,t.t)("provisioning.connect-step.placeholder-branch","main")})}),(0,e.jsx)(C.D,{noMargin:!0,label:(0,t.t)("provisioning.connect-step.label-path","Path to subdirectory in repository"),error:s.repository?.path?.message,invalid:!!s.repository?.path,description:(0,t.t)("provisioning.connect-step.description-github-path","This is the path to a subdirectory in your GitHub repository where dashboards will be stored and provisioned from"),children:(0,e.jsx)(K.p,{...n("repository.path"),id:"repository-path"})})]}),f==="local"&&(0,e.jsx)(C.D,{noMargin:!0,label:(0,t.t)("provisioning.connect-step.label-local-path","Local path"),error:s.repository?.path?.message,invalid:!!s.repository?.path,children:(0,e.jsx)(K.p,{...n("repository.path",{required:(0,t.t)("provisioning.connect-step.error-field-required","This field is required.")}),id:"repository-local-path",placeholder:(0,t.t)("provisioning.connect-step.placeholder-local-path","/path/to/repo")})})]})}var Z=r(32635),te=r(89640),se=r(53247);function Ce(){const{register:n,watch:o,setValue:a}=(0,x.xW)(),[s,c]=o(["repository.type","repository.readOnly"]),p=s==="github",u=(0,se.ED)(),f=(0,se.hF)();return(0,i.useEffect)(()=>{a("repository.sync.enabled",!0)},[a]),(0,e.jsxs)(g.B,{direction:"column",children:[p&&(0,e.jsx)(C.D,{label:(0,t.t)("provisioning.finish-step.label-update-instance-interval-seconds","Update instance interval (seconds)"),description:(0,t.t)("provisioning.finish-step.description-often-shall-instance-updates-git-hub","How often shall the instance pull updates from GitHub?"),required:!0,children:(0,e.jsx)(K.p,{...n("repository.sync.intervalSeconds",{valueAsNumber:!0}),type:"number",placeholder:(0,t.t)("provisioning.finish-step.placeholder","60")})}),(0,e.jsx)(C.D,{children:(0,e.jsx)(Z.S,{...n("repository.readOnly",{onChange:y=>{y.target.checked&&a("repository.prWorkflow",!1)}}),label:(0,t.t)("provisioning.finish-step.label-read-only","Read only"),description:(0,t.t)("provisioning.finish-step.description-read-only","Resources can't be modified through Grafana.")})}),p&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(C.D,{children:(0,e.jsx)(Z.S,{...n("repository.prWorkflow"),disabled:c,label:(0,t.t)("provisioning.finish-step.label-pr-workflow","Enable pull request option when saving"),description:(0,e.jsx)(t.x6,{i18nKey:"provisioning.finish-step.description-pr-enable-description",children:"Allows users to choose whether to open a pull request when saving changes. If the repository does not allow direct changes to the main branch, a pull request may still be required."})})}),(0,e.jsxs)(g.B,{direction:"column",gap:2,children:[(0,e.jsxs)(g.B,{direction:"column",gap:0,children:[(0,e.jsx)(v.E,{element:"h4",children:(0,e.jsx)(t.x6,{i18nKey:"provisioning.finish-step.title-enhance-github",children:"Enhance your GitHub experience"})}),(0,e.jsx)(v.E,{color:"secondary",variant:"bodySmall",children:(0,e.jsx)(t.x6,{i18nKey:"provisioning.finish-step.text-setup-later",children:"You can always set this up later"})})]}),(0,e.jsx)(C.D,{children:(0,e.jsx)(Z.S,{disabled:!f||!u,label:(0,t.t)("provisioning.finish-step.label-enable-previews","Enable dashboard previews in pull requests"),description:(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(t.x6,{i18nKey:"provisioning.finish-step.description-enable-previews",children:"Adds an image preview of dashboard changes in pull requests. Images of your Grafana dashboards will be shared in your Git repository and visible to anyone with repository access."})," ",(0,e.jsx)(v.E,{italic:!0,children:(0,e.jsxs)(t.x6,{i18nKey:"provisioning.finish-step.description-image-rendering",children:["Requires image rendering."," ",(0,e.jsx)(te.Y,{variant:"bodySmall",external:!0,href:"https://grafana.com/grafana/plugins/grafana-image-renderer",children:"Set up image rendering"})]})})]}),...n("repository.generateDashboardPreviews")})})]})]})]})}var Ee=r(30703);function Ie({visitedSteps:n=[],steps:o,activeStep:a=o[0]?.id}){const s=(0,$.of)(Be);return(0,e.jsx)("ol",{className:s.container,children:o.map((c,p)=>{const u=c.id===a,f=n.includes(c.id)&&!u,y=p===o.length-1,j=(0,l.cx)(s.stepText,{[s.activeStepText]:u});return(0,e.jsxs)("li",{className:s.stepContainer,children:[(0,e.jsxs)("div",{className:s.stepContent,children:[f?(0,e.jsx)("div",{className:(0,l.cx)(s.stepNumber,s.completedStepNumber),children:(0,e.jsx)(Ee.I,{name:"check",size:"sm"})}):(0,e.jsx)("div",{className:s.stepNumber,children:p+1}),(0,e.jsx)("div",{className:j,children:c.name})]}),!y&&(0,e.jsx)("div",{className:s.connector})]},c.id)})})}const Be=n=>({container:(0,l.css)({display:"flex",flexDirection:"column",margin:n.spacing(2,0),padding:0,listStyle:"none",width:200}),stepContainer:(0,l.css)({display:"flex",flexDirection:"column",alignItems:"flex-start",position:"relative"}),stepContent:(0,l.css)({display:"flex",alignItems:"center",padding:n.spacing(.5,0)}),stepNumber:(0,l.css)({display:"flex",justifyContent:"center",alignItems:"center",height:n.spacing(3),width:n.spacing(3),color:n.colors.text.secondary,fontSize:n.typography.size.sm,fontWeight:n.typography.fontWeightMedium,marginRight:n.spacing(1)}),completedStepNumber:(0,l.css)({color:n.colors.success.main}),stepText:(0,l.css)({color:n.colors.text.secondary,fontSize:n.typography.size.md}),activeStepText:(0,l.css)({color:n.colors.text.primary,fontWeight:n.typography.fontWeightMedium}),connector:(0,l.css)({width:"1px",backgroundColor:n.colors.border.medium,height:n.spacing(2),marginLeft:n.spacing(1.5),marginTop:n.spacing(.5)})});var X=r(68079),De=r(89599),ze=r(10378),Pe=r(92784);function Le({name:n}){const o=(0,P.Sw)(n?{name:n}:ze.hT),a=o.data;if(!a||o.isLoading)return null;const s=(0,Pe.a)(a.spec?.github);return(0,e.jsxs)(g.B,{direction:"column",gap:1,children:[(0,e.jsx)(v.E,{children:(0,e.jsx)(t.x6,{i18nKey:"provisioning.repository-link.grafana-repository-synced",children:"Your resources are now in your external storage and provisioned into your instance. From now on, your instance and the external storage will be synchronized."})}),s&&(0,e.jsx)(g.B,{direction:"row",gap:2,children:(0,e.jsx)(te.Y,{href:s,external:!0,children:(0,e.jsx)(t.x6,{i18nKey:"provisioning.repository-link.view-repository",children:"View repository"})})})]})}const Me=({progress:n})=>{const o=(0,$.of)(Re);return n===void 0?null:(0,e.jsx)("div",{className:o.container,children:(0,e.jsx)("div",{className:o.filler,style:{width:`${n}%`}})})},Re=n=>({container:(0,l.css)({height:"10px",width:"400px",backgroundColor:n.colors.background.secondary,borderRadius:n.shape.radius.pill,overflow:"hidden",margin:n.spacing(2,0)}),filler:(0,l.css)({height:"100%",background:n.colors.success.text,[n.transitions.handleMotion("no-preference","reduce")]:{transition:"width 0.5s ease-in-out"}})}),Ne=Me;var Oe=r(34888);function ie({job:n,isFinishedJob:o=!1}){if(!n?.status)return null;const{state:a,message:s,progress:c,summary:p,errors:u}=n.status,f=n.metadata?.labels?.["provisioning.grafana.app/repository"],y=()=>{switch(a){case"success":return(0,e.jsx)(V.F,{severity:"success",title:(0,t.t)("provisioning.job-status.status.title-job-completed-successfully","Job completed successfully")});case"error":return(0,e.jsx)(V.F,{severity:"error",title:(0,t.t)("provisioning.job-status.status.title-error-running-job","Error running job"),children:s??u?.join(`
`)})}return(0,e.jsxs)(g.B,{direction:"row",alignItems:"center",justifyContent:"center",gap:2,children:[["working","pending"].includes(a??"")&&(0,e.jsx)(X.y,{size:24}),(0,e.jsx)(v.E,{element:"h4",color:"secondary",children:s??a??""})]})};return(0,e.jsx)(g.B,{direction:"column",gap:2,children:(0,e.jsxs)(g.B,{direction:"column",gap:2,children:[y(),a&&!["success","error"].includes(a)&&(0,e.jsx)(g.B,{direction:"row",alignItems:"center",justifyContent:"center",gap:2,children:(0,e.jsx)(Ne,{progress:c??0})}),o&&p&&(0,e.jsxs)(g.B,{direction:"column",gap:2,children:[(0,e.jsx)(v.E,{variant:"h3",children:(0,e.jsx)(t.x6,{i18nKey:"provisioning.job-status.summary",children:"Summary"})}),(0,e.jsx)(Oe.c,{summary:p})]}),a==="success"?(0,e.jsx)(Le,{name:f}):(0,e.jsx)(De.a,{label:(0,t.t)("provisioning.job-status.label-view-details","View details"),isOpen:!1,children:(0,e.jsx)("pre",{children:JSON.stringify(n,null,2)})})]})})}function Te({jobUid:n,repositoryName:o}){const a=(0,i.useRef)(!1),{setStepStatusInfo:s}=J(),c=(0,P.$9)({name:o,uid:n}),p=a.current&&c.isError,u=c.data;return(0,i.useEffect)(()=>{const f=!u&&!a.current&&!c.isFetching;let y;return f&&(a.current=!0,y=setTimeout(()=>{c.refetch()},1e3)),c.isSuccess&&u?.status?.state!=="error"&&s({status:"success"}),()=>{y&&clearTimeout(y)}},[c,u,s]),p?(s({status:"error"}),(0,e.jsx)(V.F,{severity:"error",title:(0,t.t)("provisioning.job-status.no-job-found","No job found"),children:(0,e.jsx)(t.x6,{i18nKey:"provisioning.job-status.no-job-found-message",children:"The job may have been deleted or could not be retrieved. Cancel the current process and start again."})})):!u||c.isLoading||c.isFetching?(0,e.jsxs)(g.B,{direction:"row",alignItems:"center",justifyContent:"center",gap:2,children:[(0,e.jsx)(X.y,{size:24}),(0,e.jsx)(v.E,{element:"h4",color:"secondary",children:(0,e.jsx)(t.x6,{i18nKey:"provisioning.job-status.loading-finished-job",children:"Loading finished job..."})})]}):(0,e.jsx)(ie,{job:u,isFinishedJob:!0})}function ke({watch:n}){const{setStepStatusInfo:o}=J(),a=(0,P.L3)({fieldSelector:`metadata.name=${n.metadata?.name}`,watch:!0}),s=a?.data?.items?.[0],c=n.metadata?.labels?.["provisioning.grafana.app/repository"],u=!a.isUninitialized&&!a.isLoading&&!s&&!!c;return a.isLoading?(0,e.jsxs)(g.B,{direction:"row",alignItems:"center",justifyContent:"center",gap:2,children:[(0,e.jsx)(X.y,{size:24}),(0,e.jsx)(v.E,{element:"h4",color:"secondary",children:(0,e.jsx)(t.x6,{i18nKey:"provisioning.job-status.starting",children:"Starting..."})})]}):a.isError?(o({status:"error",error:"Error fetching active job"}),null):s?(0,e.jsx)(ie,{job:s,isFinishedJob:!1}):u?(0,e.jsx)(Te,{jobUid:n.metadata?.uid,repositoryName:c}):(0,e.jsxs)(g.B,{direction:"row",alignItems:"center",justifyContent:"center",gap:2,children:[(0,e.jsx)(X.y,{size:24}),(0,e.jsx)(v.E,{element:"h4",weight:"bold",children:(0,e.jsx)(t.x6,{i18nKey:"provisioning.job-status.starting",children:"Starting..."})})]})}function Ke({requiresMigration:n,isLegacyStorage:o}){const{setStepStatusInfo:a}=J(),[s]=(0,P.bS)(),{getValues:c,register:p,watch:u}=(0,x.xW)(),y=u("repository.type")==="github"&&o,[j,I]=(0,i.useState)(),L=async()=>{const[D,B]=c(["migrate.history","repositoryName"]);if(!B){a({status:"error",error:(0,t.t)("provisioning.synchronize-step.error-no-repository-name","No repository name provided")});return}try{a({status:"running"});const M=await s({name:B,jobSpec:n?{migrate:{history:D&&y}}:{pull:{incremental:!1}}}).unwrap();if(!M?.metadata?.name)return a({status:"error",error:(0,t.t)("provisioning.synchronize-step.error-no-job-id","Failed to start job")});I(M)}catch{a({status:"error",error:(0,t.t)("provisioning.synchronize-step.error-starting-job","Error starting job")})}};return j?(0,e.jsx)(ke,{watch:j}):(0,e.jsxs)(g.B,{direction:"column",gap:3,alignItems:"flex-start",children:[(0,e.jsx)(v.E,{color:"secondary",children:(0,e.jsx)(t.x6,{i18nKey:"provisioning.wizard.sync-description",children:"Sync resources with external storage. After this one-time step, all future updates will be automatically saved to the repository and provisioned back into the instance."})}),(0,e.jsx)(V.F,{title:(0,t.t)("provisioning.wizard.alert-title","Important: No data or configuration will be lost, but dashboards will be temporarily unavailable for a few minutes."),severity:"info",children:(0,e.jsxs)("ul",{style:{marginLeft:"16px"},children:[(0,e.jsx)("li",{children:(0,e.jsx)(t.x6,{i18nKey:"provisioning.wizard.alert-point-1",children:"Resources won't be able to be created, edited, or deleted during this process. In the last step, they will disappear."})}),(0,e.jsx)("li",{children:(0,e.jsx)(t.x6,{i18nKey:"provisioning.wizard.alert-point-2",children:"Once provisioning is complete, resources will reappear and be managed through external storage."})}),(0,e.jsx)("li",{children:(0,e.jsx)(t.x6,{i18nKey:"provisioning.wizard.alert-point-3",children:"The duration of this process depends on the number of resources involved."})}),(0,e.jsx)("li",{children:(0,e.jsxs)(t.x6,{i18nKey:"provisioning.wizard.alert-point-4",children:["Enterprise instance administrators can display an announcement banner to users. See"," ",(0,e.jsx)(te.Y,{external:!0,href:"https://grafana.com/docs/grafana/latest/administration/announcement-banner/",children:"this guide"})," ","for step-by-step instructions."]})})]})}),y&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(v.E,{element:"h3",children:(0,e.jsx)(t.x6,{i18nKey:"provisioning.synchronize-step.synchronization-options",children:"Synchronization options"})}),(0,e.jsx)(C.D,{noMargin:!0,children:(0,e.jsx)(Z.S,{...p("migrate.history"),id:"migrate-history",label:(0,t.t)("provisioning.wizard.sync-option-history","History"),description:(0,e.jsx)(t.x6,{i18nKey:"provisioning.synchronize-step.synchronization-description",children:"Include commits for each historical value"})})})]}),(0,e.jsx)(_.$n,{variant:"primary",onClick:L,children:(0,e.jsx)(t.x6,{i18nKey:"provisioning.wizard.button-start",children:"Begin synchronization"})})]})}const Fe=(0,h.J7)(),We=()=>[{id:"connection",name:(0,t.t)("provisioning.wizard.step-connect","Connect"),title:(0,t.t)("provisioning.wizard.title-connect","Connect to external storage"),submitOnNext:!0},{id:"bootstrap",name:(0,t.t)("provisioning.wizard.step-bootstrap","Choose what to synchronize"),title:(0,t.t)("provisioning.wizard.title-bootstrap","Choose what to synchronize"),submitOnNext:!0},{id:"synchronize",name:(0,t.t)("provisioning.wizard.step-synchronize","Synchronize with external storage"),title:(0,t.t)("provisioning.wizard.title-synchronize","Synchronize with external storage"),submitOnNext:!1},{id:"finish",name:(0,t.t)("provisioning.wizard.step-finish","Choose additional settings"),title:(0,t.t)("provisioning.wizard.title-finish","Choose additional settings"),submitOnNext:!0}];function Ae({type:n}){const[o,a]=(0,i.useState)("connection"),[s,c]=(0,i.useState)([]),[p,u]=(0,i.useState)(!1),[f,y]=(0,i.useState)(!1),[j,I]=(0,i.useState)(!1),{stepStatusInfo:L,setStepStatusInfo:D,isStepSuccess:B,isStepRunning:F,hasStepError:M}=J(),W=(0,P.F9)(),R=(0,m.Zp)(),w=We(),k=(0,$.of)(Ue),A=(0,pe.w)(),U=(0,x.mN)({defaultValues:{repository:{...A,type:n},migrate:{history:!0}}}),{watch:ne,setValue:N,getValues:He,trigger:$e,setError:Ve,formState:{isDirty:Je},handleSubmit:Ye}=U,G=ne("repositoryName"),[Qe]=(0,ue.A)(G),[Ze]=(0,P.So)(),q=w.findIndex(b=>b.id===o),oe=w[q];(0,i.useEffect)(()=>{W.data?.items.some(b=>b.target==="instance"&&b.name!==G)&&(Fe.publish({type:T.r1.alertError.name,payload:[(0,t.t)("provisioning.wizard-content.error-instance-repository-exists","Instance repository already exists")]}),R(Q.mL))},[R,G,W.data?.items]);const Xe=async b=>{try{await Ze({name:b}),setTimeout(()=>{R(Q.mL)},1e3)}catch{I(!1)}},ae=async()=>{if(o==="connection"||!G){R(Q.mL);return}I(!0),Xe(G)},qe=(0,i.useCallback)(b=>{const E=w.findIndex(O=>O.id===b);return E===-1||E>=w.length-1?(0,t.t)("provisioning.wizard.button-next","Finish"):w[E+1].name},[w]),ce=async()=>{q===w.length-1?R(Q.mL):(a(w[q+1].id),c(E=>[...new Set([...E,o])]),D({status:"idle"}))},_e=async()=>{if(oe?.submitOnNext){if((o==="connection"||o==="bootstrap")&&!await $e(["repository","repository.title"]))return;y(!0);try{const b=He(),E=(0,ge.t)(b.repository),O=await Qe(E);if(O.error){D({status:"error",error:"Repository request failed"});return}const le=O.data?.metadata?.name;le?(N("repositoryName",le),D({status:"success"}),ce()):console.error("Saved repository without a name:",O)}catch(b){if((0,Y.NF)(b)){const[E,O]=he(b.data.errors);E&&O&&Ve(E,O)}else D({status:"error",error:"Repository connection failed"})}finally{y(!1)}}else B&&ce()},et=()=>o!=="connection"&&M?!0:o==="synchronize"?!B:f||j||F;return(0,e.jsx)(x.Op,{...U,children:(0,e.jsxs)(g.B,{gap:6,direction:"row",alignItems:"flex-start",children:[(0,e.jsx)(Ie,{steps:w,activeStep:o,visitedSteps:s}),(0,e.jsx)("div",{className:k.divider}),(0,e.jsxs)("form",{onSubmit:Ye(_e),className:k.form,children:[(0,e.jsx)(de.F,{onDiscard:ae,confirmRedirect:Je&&o!=="finish"&&!j}),(0,e.jsxs)(g.B,{direction:"column",children:[(0,e.jsx)(z.a,{marginBottom:2,children:(0,e.jsxs)(v.E,{element:"h2",children:[q+1,". ",oe?.title]})}),M&&(0,e.jsx)(V.F,{severity:"error",title:"error"in L?L.error:""}),(0,e.jsxs)("div",{className:k.content,children:[o==="connection"&&(0,e.jsx)(we,{}),o==="bootstrap"&&(0,e.jsx)(be,{onOptionSelect:u,settingsData:W.data,repoName:G??""}),o==="synchronize"&&(0,e.jsx)(Ke,{requiresMigration:p,isLegacyStorage:!!W.data?.legacyStorage}),o==="finish"&&(0,e.jsx)(Ce,{})]}),(0,e.jsxs)(g.B,{gap:2,justifyContent:"flex-end",children:[(0,e.jsx)(_.$n,{variant:"secondary",onClick:ae,disabled:f||j,children:j?(0,t.t)("provisioning.wizard-content.button-cancelling","Cancelling..."):(0,t.t)("provisioning.wizard-content.button-cancel","Cancel")}),(0,e.jsx)(_.$n,{type:"submit",disabled:et(),children:f?(0,t.t)("provisioning.wizard-content.button-submitting","Submitting..."):qe(o)})]})]})]})]})})}const Ue=n=>({form:(0,l.css)({maxWidth:"900px",flexGrow:1}),divider:(0,l.css)({width:1,alignSelf:"stretch",backgroundColor:n.colors.border.weak,marginBottom:n.spacing(13)}),content:(0,l.css)({borderBottom:`1px solid ${n.colors.border.weak}`,paddingBottom:n.spacing(4),marginBottom:n.spacing(4)})});function Ge(){const{type:n}=(0,m.g)();return n?(0,e.jsx)(d.Y,{navId:"provisioning",pageNav:{text:n==="github"?"Configure Git Sync":"Configure local file path",subTitle:(0,t.t)("provisioning.connect-page.subTitle.connect-external-storage-manage-resources","Connect to an external storage to manage your resources")},children:(0,e.jsx)(d.Y.Contents,{children:(0,e.jsx)(ye,{children:(0,e.jsx)(Ae,{type:n})})})}):null}},67170:(H,S,r)=>{r.d(S,{A:()=>t});var e=r(96540),m=r(33680);function t(l){const[i,x]=(0,m.ZL)(),[T,h]=(0,m.hD)(),[Y,$]=(0,m.L)();return[(0,e.useCallback)(async z=>(await Y({name:l||"new",body:{spec:z}}).unwrap(),l?T({name:l,repository:{metadata:{name:l,finalizers:["cleanup","remove-orphan-resources"]},spec:z}}):i({repository:{metadata:d(z),spec:z}})),[i,l,T,Y]),l?h:x,$]}const d=l=>{const i=l.title.toLowerCase().replaceAll(/[^a-z0-9\-_]+/g,"");if(crypto.randomUUID&&i&&i.charAt(0)>="a"&&i.charAt(0)<="z"&&i.replaceAll(/[^a-z]/g,"").length>=3){const x=crypto.randomUUID().substring(0,7);return{name:`${i.substring(0,62-x.length)}-${x}`}}else return{generateName:"r"}}},79162:(H,S,r)=>{r.d(S,{B:()=>t,t:()=>m});const e=d=>{if(d.readOnly)return[];const l=["write"];return d.prWorkflow?[...l,"branch"]:l},m=d=>{const l={type:d.type,sync:d.sync,title:d.title||"",workflows:e(d)};switch(d.type){case"github":l.github={generateDashboardPreviews:d.generateDashboardPreviews,url:d.url||"",branch:d.branch,token:d.token,path:d.path};break;case"local":l.local={path:d.path},l.workflows=l.workflows.filter(i=>i!=="branch");break}return structuredClone(l)},t=d=>structuredClone({...d,...d.github,...d.local,branch:d.github?.branch||"",url:d.github?.url||"",generateDashboardPreviews:d.github?.generateDashboardPreviews||!1,readOnly:!d.workflows.length,prWorkflow:d.workflows.includes("write")})}}]);

//# sourceMappingURL=ProvisioningWizardPage.1729b245b7cdacb9a863.js.map