"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[5413],{73163:(z,L,t)=>{t.d(L,{Xx:()=>G,ko:()=>T});var m=t(60519),n=t(32899),E=t(95004),P=t(63704),v=t(68143),g=t(43173),M=t(73427),D=t(86967),i=t(92367);const K=(p,x,e)=>(l,c,h)=>(x.variables&&e&&(l=l.replace(/\$\w+/g,u=>{const r=u.slice(1);return x.variables.some(C=>C.key===r)&&e[r]!=null?e[r]:u})),p(l,c,h)),T=(p,x,e,l,c,h)=>!c||c.length===0?[]:c.map(r=>{const C=(0,m.vd)(p,x,e),I={...e,__dataContext:C},f=(y,A,b)=>l(y,{...I,...A},b);return h.valueRowIndex!==void 0&&!isNaN(h.valueRowIndex)?C.value.rowIndex=h.valueRowIndex:C.value.calculatedValue=h.calculatedValue,{title:l(r.title,I),confirmation:y=>K(f,r,y)(r.confirmation||`Are you sure you want to ${r.title}?`),onClick:(y,A,b)=>{let U=J(r,K(f,r,b));try{(0,v.AI)().fetch(U).subscribe({error:F=>{M.lE.emit(n.r1.alertError,["An error has occurred. Check console output for more details."]),console.error(F)},complete:()=>{M.lE.emit(n.r1.alertSuccess,["API call was successful"])}})}catch(F){M.lE.emit(n.r1.alertError,["An error has occurred. Check console output for more details."]),console.error(F);return}},oneClick:r.oneClick??!1,style:{backgroundColor:r.style?.backgroundColor??g.$.theme2.colors.secondary.main},variables:r.variables}}).filter(r=>!!r),J=(p,x)=>{const e=new URL(V(x(p.fetch.url))),l={};let c={url:e.toString(),method:p.fetch.method,data:_(p,x),headers:l};return p.fetch.headers&&p.fetch.headers.forEach(([h,u])=>{l[x(h)]=x(u)}),p.fetch.queryParams&&(p.fetch.queryParams?.forEach(([h,u])=>{e.searchParams.append(x(h),x(u))}),c.url=e.toString()),l["X-Grafana-Action"]="1",c.headers=l,c},G=(p=[],x=[])=>({name:"Default field",type:E.PU.string,config:{links:p,actions:x},values:[]}),V=p=>{if(p.startsWith("/")){const e=P.sQ.sanitizeUrl(p);p=(0,i.z)(e,[])}return p},_=(p,x)=>{let e=p.fetch.body?x(p.fetch.body):"{}";return p.fetch.method===D.DO.GET&&(e=void 0),e}},11205:(z,L,t)=>{t.d(L,{l:()=>E});var m=t(77154),n=t(68143);async function E(){return(0,n.AI)().get("api/live/list").then(P=>{const v=P.channels??[],g={},M=v.map(D=>{if(D.data){const i=new Set,K=(0,m.or)(D.data);for(const T of K.fields)i.add(T.name);g[D.channel]=Array.from(i).map(T=>({value:T,label:T}))}return{value:D.channel,label:D.channel+" ["+D.minute_rate+" msg/min]"}});return{channelFields:g,channels:M}})}},86967:(z,L,t)=>{t.d(L,{DO:()=>P,en:()=>m,gR:()=>n,xp:()=>E});var m=(i=>(i.Center="center",i.Left="left",i.LeftRight="leftright",i.Right="right",i.Scale="scale",i))(m||{}),n=(i=>(i.Bottom="bottom",i.Center="center",i.Scale="scale",i.Top="top",i.TopBottom="topbottom",i))(n||{}),E=(i=>(i.Contain="contain",i.Cover="cover",i.Fill="fill",i.Original="original",i.Tile="tile",i))(E||{}),P=(i=>(i.GET="GET",i.POST="POST",i.PUT="PUT",i))(P||{}),v=(i=>(i.Straight="straight",i))(v||{});const g={vertices:[]},M={connections:[]},D={infinitePan:!0,inlineEditing:!0,panZoom:!0,showAdvancedTypes:!0}},8149:(z,L,t)=>{t.r(L),t.d(L,{plugin:()=>ne});var m=t(16207),n=t(74848),E=t(22803),P=t(96540),v=t(38619),g=t(92745),M=t(34999),D=t(72636),i=t(18857),K=t(43243),T=t(65240),J=t(65642),G=t(75505),V=t(81160),_=t(68143);async function p(){return await(0,G.s)((0,_.AI)().fetch({method:"GET",url:"/apis",headers:{Accept:"application/json;g=apidiscovery.k8s.io;v=v2;as=APIGroupDiscoveryList,application/json;g=apidiscovery.k8s.io;v=v2beta1;as=APIGroupDiscoveryList,application/json"}}).pipe((0,V.T)(o=>{for(let a of o.data.items)for(let s of a.versions)for(let d of s.resources)if(d.responseKind.group=a.metadata.name,d.responseKind.version=s.version,d.subresources)for(let R of d.subresources)R.responseKind.group=a.metadata.name,R.responseKind.version=s.version;return o.data})))}function x(o){const a=[];for(let s of o.items)for(let d of s.versions)for(let R of d.resources)a.push(R);return a}var e=t(11205);const l=[{label:"Grafana",value:v.qD.Grafana,description:"Core grafana live features"},{label:"Data Sources",value:v.qD.DataSource,description:"Data sources with live support"},{label:"Plugins",value:v.qD.Plugin,description:"Plugins with live support"},{label:"Stream",value:v.qD.Stream,description:"data streams (eg, influx style)"},{label:"Watch",value:v.qD.Watch,description:"Watch k8s style resources"}];function c(o){const[a,s]=(0,P.useState)([]),[d,R]=(0,P.useMemo)(()=>{const O=[],N=[],B=o.value.scope,ae=o.value.namespace;if(!B?.length)return[O,N];const oe={};for(let re of a){const H=(0,v.DG)(re.value);!H||H.scope!==B||(oe[H.namespace]||(O.push({value:H.namespace,label:H.namespace}),oe[H.namespace]=!0),ae?.length&&ae===H.namespace&&N.push({...re,value:H.path}))}return[O,N]},[a,o.value.scope,o.value.namespace]);(0,P.useEffect)(()=>{(0,e.l)().then(O=>{s(O.channels)})},[o.value.scope]);const $=O=>{O.value&&o.onChange({scope:O.value,namespace:void 0,path:void 0})},w=O=>{o.onChange({scope:o.value?.scope,namespace:O?.value,path:void 0})},se=O=>{const{value:N,onChange:B}=o;B({scope:N.scope,namespace:N.namespace,path:O?.value})},X=async O=>{const N=await p();return x(N).filter(B=>B.verbs.includes("watch")).map(B=>({value:`${B.responseKind.group}/${B.responseKind.version}/${B.resource}`,resource:B}))},{scope:q,namespace:Q,path:ie}=o.value,ee=u(J.$W.theme2);return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(M.F,{title:(0,g.t)("live.live-channel-editor.title-grafana-live","Grafana Live"),severity:"info",children:(0,n.jsx)(g.x6,{i18nKey:"live.live-channel-editor.description-grafana-live",children:"This supports real-time event streams in Grafana core. This feature is under heavy development. Expect the interfaces and structures to change as this becomes more production ready."})}),(0,n.jsxs)("div",{children:[(0,n.jsxs)("div",{className:ee.dropWrap,children:[(0,n.jsx)(D.J,{children:(0,n.jsx)(g.x6,{i18nKey:"live.live-channel-editor.scope",children:"Scope"})}),(0,n.jsx)(i.l6,{options:l,value:l.find(O=>O.value===q),onChange:$})]}),q===v.qD.Watch&&(0,n.jsx)("div",{className:ee.dropWrap,children:(0,n.jsx)(K.G,{options:X,placeholder:(0,g.t)("live.live-channel-editor.placeholder-select-watchable-resource","Select watchable resource"),onChange:O=>{const N=O.resource;N&&o.onChange({scope:v.qD.Watch,namespace:N.responseKind.group,path:`${N.responseKind.version}/${N.resource}/${J.$W.bootData.user.uid}`})}})}),q&&(0,n.jsxs)("div",{className:ee.dropWrap,children:[(0,n.jsx)(D.J,{children:(0,n.jsx)(g.x6,{i18nKey:"live.live-channel-editor.namespace",children:"Namespace"})}),(0,n.jsx)(i.l6,{options:d,value:d.find(O=>O.value===Q)??(Q?{label:Q,value:Q}:void 0),onChange:w,allowCustomValue:!0,backspaceRemovesValue:!0,isClearable:!0})]}),q&&Q&&(0,n.jsxs)("div",{className:ee.dropWrap,children:[(0,n.jsx)(D.J,{children:(0,n.jsx)(g.x6,{i18nKey:"live.live-channel-editor.path",children:"Path"})}),(0,n.jsx)(i.l6,{options:R,value:h(R,ie),onChange:se,allowCustomValue:!0,backspaceRemovesValue:!0,isClearable:!0})]})]})]})}function h(o,a){const s=o.find(d=>d.value===a);if(s)return s;if(a)return{label:a,value:a}}const u=(0,T.N)(o=>({dropWrap:(0,E.css)({marginBottom:o.spacing(1)})}));var r=t(2543),C=t(51388),I=t(60519),f=t(28105),W=t(43173),y=t(33184),A=t(50275),b=t(52718),U=t(25205),F=t(50992),Z=t(45861),j=(o=>(o.Raw="raw",o.JSON="json",o.Auto="auto",o.None="none",o))(j||{}),S=(o=>(o.None="none",o.JSON="json",o.Influx="influx",o))(S||{});function Y({height:o,mode:a,body:s,addr:d,onSave:R}){const $=(0,P.useMemo)(()=>a===S.JSON?s?JSON.stringify(s,null,2):"{ }":s==null?"":`${s}`,[a,s]),w=X=>{a===S.JSON?R(JSON.parse(X)):R(X)},se=async()=>{if(a===S.Influx){if(d?.scope!=="stream"){alert("expected stream scope!");return}return(0,_.AI)().post(`api/live/push/${d.namespace}`,s)}if(!(0,v.aj)(d)){alert("invalid address");return}const X=await(0,y.oF)().publish(d,s);console.log("onPublishClicked (response from publish)",X)};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(F.B,{height:o-32,language:a===S.JSON?"json":"text",value:$,onBlur:w,onSave:w,showMiniMap:!1,showLineNumbers:!0}),(0,n.jsx)("div",{style:{height:32},children:(0,n.jsx)(Z.$n,{onClick:se,children:(0,n.jsx)(g.x6,{i18nKey:"live.live-publish.publish",children:"Publish"})})})]})}class te extends P.PureComponent{constructor(a){super(a),this.styles=k(W.$.theme2),this.streamObserver={next:s=>{(0,v.ew)(s)?this.setState({status:s,changed:Date.now()}):(0,v.Z7)(s)?this.setState({message:s.message,changed:Date.now()}):console.log("ignore",s)}},this.unsubscribe=()=>{this.subscription&&(this.subscription.unsubscribe(),this.subscription=void 0)},this.isValid=!!(0,y.oF)(),this.state={changed:0}}async componentDidMount(){this.loadChannel()}componentWillUnmount(){this.subscription&&this.subscription.unsubscribe()}componentDidUpdate(a){this.props.options?.channel!==a.options?.channel&&this.loadChannel()}async loadChannel(){const a=this.props.options?.channel;if(!(0,v.aj)(a)){console.log("INVALID",a),this.unsubscribe(),this.setState({addr:void 0});return}if((0,r.isEqual)(a,this.state.addr)){console.log("Same channel",this.state.addr);return}const s=(0,y.oF)();if(!s){console.log("INVALID",a),this.unsubscribe(),this.setState({addr:void 0});return}this.unsubscribe(),console.log("LOAD",a);try{this.subscription=s.getStream(a).subscribe(this.streamObserver),this.setState({addr:a,error:void 0})}catch(d){this.setState({addr:void 0,error:d})}}renderNotEnabled(){return(0,n.jsxs)(M.F,{title:(0,g.t)("live.live-panel.title-grafana-live","Grafana Live"),severity:"info",children:[(0,n.jsx)("p",{children:(0,n.jsx)(g.x6,{i18nKey:"live.live-panel.grafana-requires-feature",children:"Grafana live requires a feature flag to run"})}),(0,n.jsx)("b",{children:"custom.ini:"}),(0,n.jsx)("pre",{children:`[feature_toggles]
    enable = live`})]})}renderMessage(a){const{options:s}=this.props,{message:d}=this.state;if(!d)return(0,n.jsxs)("div",{children:[(0,n.jsx)("h4",{children:(0,n.jsx)(g.x6,{i18nKey:"live.live-panel.waiting-for-data",children:"Waiting for data:"})}),s.channel?.scope,"/",s.channel?.namespace,"/",s.channel?.path]});if(s.display===j.JSON)return(0,n.jsx)(A.B,{json:d,open:5});if(s.display===j.Auto&&d instanceof C.k9){const R={series:(0,I.we)({data:[d],theme:W.$.theme2,replaceVariables:w=>w,fieldConfig:{defaults:{},overrides:[]}}),state:f.Gu.Streaming},$={...this.props,options:{frameIndex:0,showHeader:!0}};return(0,n.jsx)(U.L,{...$,data:R,height:a})}return(0,n.jsx)("pre",{children:JSON.stringify(d)})}renderPublish(a){const{options:s}=this.props;return(0,n.jsx)(Y,{height:a,body:s.message,mode:s.publish??S.JSON,onSave:d=>this.props.onOptionsChange({...s,message:d}),addr:this.state.addr})}renderStatus(){const{status:a}=this.state;if(a?.state===v.ZF.Connected)return;let s="";return a&&(s=this.styles.status[a.state]),(0,n.jsx)("div",{className:(0,E.cx)(s,this.styles.statusWrap),children:a?.state})}renderBody(){const{status:a}=this.state,{options:s,height:d}=this.props;if(s.publish===S.JSON||s.publish===S.Influx){if(s.display===j.None)return this.renderPublish(d);const $=d/2;return(0,n.jsxs)("div",{children:[(0,n.jsx)("div",{style:{height:$,overflow:"hidden"},children:(0,n.jsx)(b.E,{autoHeightMin:"100%",autoHeightMax:"100%",children:this.renderMessage($)})}),(0,n.jsx)("div",{children:this.renderPublish($)})]})}return s.display===j.None?(0,n.jsx)("pre",{children:JSON.stringify(a)}):(0,n.jsx)("div",{style:{overflow:"hidden",height:d},children:(0,n.jsx)(b.E,{autoHeightMin:"100%",autoHeightMax:"100%",children:this.renderMessage(d)})})}render(){if(!this.isValid)return this.renderNotEnabled();const{addr:a,error:s}=this.state;return a?s?(0,n.jsxs)("div",{children:[(0,n.jsx)("h2",{children:(0,n.jsx)(g.x6,{i18nKey:"live.live-panel.error",children:"Error"})}),(0,n.jsx)("div",{children:JSON.stringify(s)})]}):(0,n.jsxs)(n.Fragment,{children:[this.renderStatus(),this.renderBody()]}):(0,n.jsx)(M.F,{title:(0,g.t)("live.live-panel.title-grafana-live","Grafana Live"),severity:"info",children:(0,n.jsx)(g.x6,{i18nKey:"live.live-panel.panel-editor-channel",children:"Use the panel editor to pick a channel"})})}}const k=(0,T.N)(o=>({statusWrap:(0,E.css)({margin:"auto",position:"absolute",top:0,right:0,background:o.components.panel.background,padding:"10px",zIndex:o.zIndex.modal}),status:{[v.ZF.Pending]:(0,E.css)({border:`1px solid ${o.v1.palette.orange}`}),[v.ZF.Connected]:(0,E.css)({border:`1px solid ${o.colors.success.main}`}),[v.ZF.Connecting]:(0,E.css)({border:`1px solid ${o.v1.palette.brandWarning}`}),[v.ZF.Disconnected]:(0,E.css)({border:`1px solid ${o.colors.warning.main}`}),[v.ZF.Shutdown]:(0,E.css)({border:`1px solid ${o.colors.error.main}`}),[v.ZF.Invalid]:(0,E.css)({border:"1px solid red"})}})),ne=new m.m(te).setPanelOptions(o=>{o.addCustomEditor({category:["Channel"],id:"channel",path:"channel",name:"Channel",editor:c,defaultValue:{}}),o.addRadio({path:"display",name:"Show message",description:"Display the last message received on this channel",settings:{options:[{value:j.Raw,label:"Raw Text"},{value:j.JSON,label:"JSON"},{value:j.Auto,label:"Auto"},{value:j.None,label:"None"}]},defaultValue:j.JSON}).addRadio({path:"publish",name:"Publish",description:"Display a form to publish values",settings:{options:[{value:S.None,label:"None"},{value:S.JSON,label:"JSON"},{value:S.Influx,label:"Influx"}]},defaultValue:S.None})})},25205:(z,L,t)=>{t.d(L,{L:()=>V});var m=t(74848),n=t(22803),E=t(84229),P=t(16515),v=t(57866),g=t(14477),M=t(43173),D=t(63142),i=t(64400),K=t(24343),T=t(18857),J=t(73163),G=t(32776);function V(u){const{data:r,height:C,width:I,options:f,fieldConfig:W,id:y,timeRange:A,replaceVariables:b}=u,U=(0,D.$j)(),F=(0,i.d2)(),Z=(0,G.gy)(r.series)?(0,G.S5)(r.series):r.series,j=Z?.length,S=Z.some(s=>s.fields.length>0),Y=_(Z,f),te=Z[Y];let k=C;if(!j||!S)return(0,m.jsx)(g.a,{panelId:y,fieldConfig:W,data:r});if(j>1){const s=U.spacing.gridSize*U.components.height.md,d=U.spacing.gridSize;k=C-s-d}const ne=F.sync&&F.sync()!==E.y.Off,o=(0,m.jsx)(K.X,{height:k,width:I,data:te,noHeader:!f.showHeader,showTypeIcons:f.showTypeIcons,resizable:!0,initialSortBy:f.sortBy,onSortByChange:s=>x(s,u),onColumnResize:(s,d)=>p(s,d,u),onCellFilterAdded:F.onAddAdHocFilter,footerOptions:f.footer,enablePagination:f.footer?.enablePagination,cellHeight:f.cellHeight,timeRange:A,enableSharedCrosshair:M.$.featureToggles.tableSharedCrosshair&&ne,fieldConfig:W,getActions:c,replaceVariables:b});if(j===1)return o;const a=Z.map((s,d)=>({label:(0,P.Ri)(s),value:d}));return(0,m.jsxs)("div",{className:h.wrapper,children:[o,(0,m.jsx)("div",{className:h.selectWrapper,children:(0,m.jsx)(T.l6,{options:a,value:a[Y],onChange:s=>e(s,u)})})]})}function _(u,r){return r.frameIndex>0&&r.frameIndex<u.length?r.frameIndex:0}function p(u,r,C){const{fieldConfig:I}=C,{overrides:f}=I,W=v.Ct.byName,y="custom.width",A=f.find(b=>b.matcher.id===W&&b.matcher.options===u);if(A){const b=A.properties.find(U=>U.id===y);b?b.value=r:A.properties.push({id:y,value:r})}else f.push({matcher:{id:W,options:u},properties:[{id:y,value:r}]});C.onFieldConfigChange({...I,overrides:f})}function x(u,r){r.onOptionsChange({...r.options,sortBy:u})}function e(u,r){r.onOptionsChange({...r.options,frameIndex:u.value||0})}const l=u=>u,c=(u,r,C,I)=>{const f=[],W=new Set;return(0,J.ko)(u,r,r.state.scopedVars,I??l,r.config.actions??[],{valueRowIndex:C}).forEach(A=>{const b=`${A.title}`;W.has(b)||(f.push(A),W.add(b))}),f},h={wrapper:(0,n.css)({display:"flex",flexDirection:"column",justifyContent:"space-between",height:"100%"}),selectWrapper:(0,n.css)({padding:"8px 8px 0px 8px"})}},32776:(z,L,t)=>{t.d(L,{S5:()=>p,fq:()=>g,gy:()=>x,l1:()=>V});var m=t(2543),n=t.n(m),E=t(57866),P=t(33553),v=t(95004);const g=e=>(!e.pluginVersion&&"columns"in e&&console.log("Was angular table",e),e.options),M={timeseries_to_rows:"seriesToRows",timeseries_to_columns:"seriesToColumns",timeseries_aggregations:"reduce",table:"merge"},D={avg:"mean",min:"min",max:"max",total:"sum",current:"lastNotNull",count:"count"},i={cell:"color-background",row:"color-background",value:"color-text"},K=(e,l)=>[-1/0,...e].map((c,h)=>({color:l[h],value:(0,m.isNumber)(c)?c:parseInt(c,10)})),T=(e,l)=>{const c=e.transformations??[];if(Object.keys(M).includes(l.transform)){const h={reducers:[]};l.transform==="timeseries_aggregations"&&(h.includeTimeField=!1,h.reducers=l.columns.map(u=>D[u.value])),c.push({id:M[l.transform],options:h})}return c},J=e=>{const c={matcher:{id:/^\/.*\/$/.test(e.pattern)?E.Ct.byRegexp:E.Ct.byName,options:e.pattern},properties:[]};return e.alias&&c.properties.push({id:"displayName",value:e.alias}),e.unit&&c.properties.push({id:"unit",value:e.unit}),e.decimals&&c.properties.push({id:"decimals",value:e.decimals}),e.type==="date"&&c.properties.push({id:"unit",value:`time: ${e.dateFormat}`}),e.type==="hidden"&&c.properties.push({id:"custom.hidden",value:!0}),e.link&&c.properties.push({id:"links",value:[{title:(0,m.defaultTo)(e.linkTooltip,""),url:(0,m.defaultTo)(e.linkUrl,""),targetBlank:(0,m.defaultTo)(e.linkTargetBlank,!1)}]}),e.colorMode&&c.properties.push({id:"custom.cellOptions",value:{type:i[e.colorMode]}}),e.align&&c.properties.push({id:"custom.align",value:e.align==="auto"?null:e.align}),e.thresholds?.length&&c.properties.push({id:"thresholds",value:{mode:P.O.Absolute,steps:K(e.thresholds,e.colors)}}),c},G=e=>{let l={custom:{}};if(e){if(l=(0,m.omitBy)({unit:e.unit,decimals:e.decimals,displayName:e.alias,custom:{align:e.align==="auto"?null:e.align}},m.isNil),e.thresholds.length){const c={mode:P.O.Absolute,steps:K(e.thresholds,e.colors)};l.thresholds=c}e.colorMode&&(l.custom.cellOptions={type:i[e.colorMode]})}return l},V=(e,l,c)=>{if(l==="table-old"&&c.angular){const h=c.angular,u=T(e,h),r=h.styles.find(f=>f.pattern==="/.*/"),C=G(r),I=h.styles.filter(f=>f.pattern!=="/.*/").map(J);e.transformations=u,e.fieldConfig={defaults:C,overrides:I}}return{}},_=e=>e?.filter(l=>l.meta?.custom?.parentRowIndex===void 0)||[e?.[0]],p=e=>{const l=[];return _(e).filter(h=>!!h&&h.length!==0)?.forEach(h=>{const u=e?.filter(f=>h.refId===f.refId&&f.meta?.custom?.parentRowIndex!==void 0),r=(0,m.groupBy)(u,f=>f.meta?.custom?.parentRowIndex),C=Object.keys(r).map(f=>r[f]),I={...h};u&&u.length>0&&I.fields.push({name:"nested",type:v.PU.nestedFrames,config:{},values:C}),l.push(I)}),l},x=e=>e?.some(l=>l.meta?.custom?.parentRowIndex!==void 0)}}]);

//# sourceMappingURL=livePanel.ca23b404c7315eaae051.js.map