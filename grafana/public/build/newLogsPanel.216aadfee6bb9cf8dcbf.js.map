{"version":3,"file":"newLogsPanel.216aadfee6bb9cf8dcbf.js","mappings":"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","sources":["webpack://grafana/./public/app/plugins/panel/logs-new/types.ts","webpack://grafana/./public/app/plugins/panel/logs-new/LogsPanel.tsx","webpack://grafana/./public/app/plugins/panel/logs-new/suggestions.ts","webpack://grafana/./public/app/plugins/panel/logs-new/module.tsx"],"sourcesContent":["import { Grammar } from 'prismjs';\n\nimport { CoreApp, DataFrame } from '@grafana/data';\nimport { LogListControlOptions } from 'app/features/logs/components/panel/LogList';\n\ntype onNewLogsReceivedType = (allLogs: DataFrame[], newLogs: DataFrame[]) => void;\ntype onLogOptionsChangeType = (option: keyof LogListControlOptions, value: string | boolean | string[]) => void;\n\nexport function isOnNewLogsReceivedType(callback: unknown): callback is onNewLogsReceivedType {\n  return typeof callback === 'function';\n}\n\nexport function isOnLogOptionsChange(callback: unknown): callback is onLogOptionsChangeType {\n  return typeof callback === 'function';\n}\n\nexport function isLogsGrammar(grammar: unknown): grammar is Grammar {\n  return grammar !== null && typeof grammar === 'object' && Object.getPrototypeOf(grammar) === Object.prototype;\n}\n\nexport function isCoreApp(app: unknown): app is CoreApp {\n  const apps = Object.values(CoreApp).map((coreApp) => coreApp.toString());\n  return typeof app === 'string' && apps.includes(app);\n}\n","import { css } from '@emotion/css';\nimport { useCallback, useEffect, useMemo, useRef, useState } from 'react';\n\nimport {\n  AbsoluteTimeRange,\n  CoreApp,\n  DataFrame,\n  DataHoverEvent,\n  GrafanaTheme2,\n  LoadingState,\n  LogRowModel,\n  LogSortOrderChangeEvent,\n  LogsSortOrder,\n  PanelProps,\n} from '@grafana/data';\nimport { config, getAppEvents } from '@grafana/runtime';\nimport { usePanelContext, useStyles2 } from '@grafana/ui';\nimport { LogList } from 'app/features/logs/components/panel/LogList';\nimport { PanelDataErrorView } from 'app/features/panel/components/PanelDataErrorView';\n\nimport { dataFrameToLogsModel, dedupLogRows } from '../../../features/logs/logsModel';\nimport { requestMoreLogs } from '../logs/LogsPanel';\nimport { useDatasourcesFromTargets } from '../logs/useDatasourcesFromTargets';\n\nimport { Options } from './panelcfg.gen';\nimport { isCoreApp, isLogsGrammar, isOnLogOptionsChange, isOnNewLogsReceivedType } from './types';\n\ninterface LogsPanelProps extends PanelProps<Options> {}\n\nexport const LogsPanel = ({\n  data,\n  timeZone,\n  fieldConfig,\n  options: {\n    controlsStorageKey,\n    dedupStrategy,\n    enableInfiniteScrolling,\n    grammar,\n    onLogOptionsChange,\n    onNewLogsReceived,\n    showControls,\n    showTime,\n    sortOrder,\n    syntaxHighlighting,\n    wrapLogMessage,\n  },\n  id,\n}: LogsPanelProps) => {\n  const style = useStyles2(getStyles);\n  const [logsContainer, setLogsContainer] = useState<HTMLDivElement | null>(null);\n  const [panelData, setPanelData] = useState(data);\n  const dataSourcesMap = useDatasourcesFromTargets(data.request?.targets);\n  // Prevents the scroll position to change when new data from infinite scrolling is received\n  const keepScrollPositionRef = useRef(false);\n  // Loading ref to prevent firing multiple requests\n  const loadingRef = useRef(false);\n  const { app, eventBus } = usePanelContext();\n\n  const logs = useMemo(() => {\n    const logsModel = panelData\n      ? dataFrameToLogsModel(panelData.series, panelData.request?.intervalMs, undefined, panelData.request?.targets)\n      : null;\n    return logsModel ? dedupLogRows(logsModel.rows, dedupStrategy) : [];\n  }, [dedupStrategy, panelData]);\n\n  useEffect(() => {\n    getAppEvents().publish(\n      new LogSortOrderChangeEvent({\n        order: sortOrder,\n      })\n    );\n  }, [sortOrder]);\n\n  useEffect(() => {\n    if (data.state !== LoadingState.Loading) {\n      setPanelData(data);\n    }\n  }, [data]);\n\n  const loadMoreLogs = useCallback(\n    async (scrollRange: AbsoluteTimeRange) => {\n      if (!data.request || !config.featureToggles.logsInfiniteScrolling || loadingRef.current) {\n        return;\n      }\n      loadingRef.current = true;\n\n      const onNewLogsReceivedCallback = isOnNewLogsReceivedType(onNewLogsReceived) ? onNewLogsReceived : undefined;\n\n      let newSeries: DataFrame[] = [];\n      try {\n        newSeries = await requestMoreLogs(dataSourcesMap, panelData, scrollRange, timeZone, onNewLogsReceivedCallback);\n      } catch (e) {\n        console.error(e);\n      } finally {\n        loadingRef.current = false;\n      }\n\n      keepScrollPositionRef.current = true;\n      setPanelData({\n        ...panelData,\n        series: newSeries,\n      });\n    },\n    [data.request, dataSourcesMap, onNewLogsReceived, panelData, timeZone]\n  );\n\n  const onLogRowHover = useCallback(\n    (row?: LogRowModel) => {\n      if (row) {\n        eventBus.publish(\n          new DataHoverEvent({\n            point: {\n              time: row.timeEpochMs,\n            },\n          })\n        );\n      }\n    },\n    [eventBus]\n  );\n\n  const initialScrollPosition = useMemo(() => {\n    /**\n     * In dashboards, users with newest logs at the bottom have the expectation of keeping the scroll at the bottom\n     * when new data is received. See https://github.com/grafana/grafana/pull/37634\n     */\n    if (data.request?.app === CoreApp.Dashboard || data.request?.app === CoreApp.PanelEditor) {\n      return sortOrder === LogsSortOrder.Ascending ? 'bottom' : 'top';\n    }\n    return 'top';\n  }, [data.request?.app, sortOrder]);\n\n  const storageKey = useMemo(() => {\n    if (controlsStorageKey) {\n      return controlsStorageKey;\n    }\n    if (!data.request) {\n      return undefined;\n    }\n    return `${data.request?.dashboardUID}.${id}`;\n  }, [controlsStorageKey, data.request, id]);\n\n  if (!logs.length) {\n    return <PanelDataErrorView fieldConfig={fieldConfig} panelId={id} data={data} needsStringField />;\n  }\n\n  return (\n    <div className={style.container} ref={(element: HTMLDivElement) => setLogsContainer(element)}>\n      {logs.length > 0 && logsContainer && (\n        <LogList\n          app={isCoreApp(app) ? app : CoreApp.Dashboard}\n          containerElement={logsContainer}\n          dedupStrategy={dedupStrategy}\n          displayedFields={[]}\n          enableLogDetails\n          grammar={isLogsGrammar(grammar) ? grammar : undefined}\n          initialScrollPosition={initialScrollPosition}\n          logs={logs}\n          loadMore={enableInfiniteScrolling ? loadMoreLogs : undefined}\n          onLogOptionsChange={isOnLogOptionsChange(onLogOptionsChange) ? onLogOptionsChange : undefined}\n          onLogLineHover={onLogRowHover}\n          showControls={showControls}\n          showTime={showTime}\n          sortOrder={sortOrder}\n          logOptionsStorageKey={storageKey}\n          syntaxHighlighting={syntaxHighlighting}\n          timeRange={data.timeRange}\n          timeZone={timeZone}\n          wrapLogMessage={wrapLogMessage}\n        />\n      )}\n    </div>\n  );\n};\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  container: css({\n    marginBottom: theme.spacing(1.5),\n    minHeight: '100%',\n    maxHeight: '100%',\n    display: 'flex',\n    flex: 1,\n    flexDirection: 'column',\n  }),\n});\n","import { VisualizationSuggestionsBuilder, VisualizationSuggestionScore } from '@grafana/data';\nimport { SuggestionName } from 'app/types/suggestions';\n\nimport { Options } from './panelcfg.gen';\n\nexport class LogsPanelSuggestionsSupplier {\n  getSuggestionsForData(builder: VisualizationSuggestionsBuilder) {\n    const list = builder.getListAppender<Options, {}>({\n      name: '',\n      pluginId: 'logs-new',\n      options: {},\n      fieldConfig: {\n        defaults: {\n          custom: {},\n        },\n        overrides: [],\n      },\n    });\n\n    const { dataSummary: ds } = builder;\n\n    // Require a string & time field\n    if (!ds.hasData || !ds.hasTimeField || !ds.hasStringField) {\n      return;\n    }\n\n    if (ds.preferredVisualisationType === 'logs') {\n      list.append({ name: SuggestionName.Logs, score: VisualizationSuggestionScore.Best });\n    } else {\n      list.append({ name: SuggestionName.Logs });\n    }\n  }\n}\n","import { PanelPlugin, LogsSortOrder, LogsDedupStrategy, LogsDedupDescription } from '@grafana/data';\nimport { t } from '@grafana/i18n';\n\nimport { LogsPanel } from './LogsPanel';\nimport { Options } from './panelcfg.gen';\nimport { LogsPanelSuggestionsSupplier } from './suggestions';\n\nexport const plugin = new PanelPlugin<Options>(LogsPanel)\n  .setPanelOptions((builder) => {\n    const category = [t('logs-new.category-logs', 'Logs')];\n    builder\n      .addBooleanSwitch({\n        path: 'showTime',\n        name: t('logs-new.name-time', 'Time'),\n        category,\n        description: '',\n        defaultValue: false,\n      })\n      .addBooleanSwitch({\n        path: 'wrapLogMessage',\n        name: t('logs-new.name-wrap-lines', 'Wrap lines'),\n        category,\n        description: '',\n        defaultValue: false,\n      })\n      .addBooleanSwitch({\n        path: 'syntaxHighlighting',\n        name: t('logs-new.name-syntax-highlighting', 'Enable syntax highlighting'),\n        category,\n        description: t(\n          'logs-new.description-syntax-highlighting',\n          'Use a predefined syntax coloring grammar to highlight relevant parts of the log lines'\n        ),\n        defaultValue: true,\n      })\n      .addBooleanSwitch({\n        path: 'enableLogDetails',\n        name: t('logs-new.name-enable-log-details', 'Enable log details'),\n        category,\n        description: '',\n        defaultValue: true,\n      })\n      .addBooleanSwitch({\n        path: 'showControls',\n        name: t('logs-new.name-show-controls', 'Show controls'),\n        category,\n        description: t(\n          'logs-new.description-show-controls',\n          'Display controls to jump to the last or first log line, and filters by log level'\n        ),\n        defaultValue: false,\n      })\n      .addBooleanSwitch({\n        path: 'enableInfiniteScrolling',\n        name: t('logs-new.name-infinite-scrolling', 'Enable infinite scrolling'),\n        category,\n        description: t(\n          'logs-new.description-infinite-scrolling',\n          'Experimental. Request more results by scrolling to the bottom of the logs list.'\n        ),\n        defaultValue: false,\n      })\n      .addRadio({\n        path: 'dedupStrategy',\n        name: t('logs-new.name-deduplication', 'Deduplication'),\n        category,\n        description: '',\n        settings: {\n          options: [\n            {\n              value: LogsDedupStrategy.none,\n              label: t('logs-new.deduplication-options.label-none', 'None'),\n              description: LogsDedupDescription[LogsDedupStrategy.none],\n            },\n            {\n              value: LogsDedupStrategy.exact,\n              label: t('logs-new.deduplication-options.label-exact', 'Exact'),\n              description: LogsDedupDescription[LogsDedupStrategy.exact],\n            },\n            {\n              value: LogsDedupStrategy.numbers,\n              label: t('logs-new.deduplication-options.label-numbers', 'Numbers'),\n              description: LogsDedupDescription[LogsDedupStrategy.numbers],\n            },\n            {\n              value: LogsDedupStrategy.signature,\n              label: t('logs-new.deduplication-options.label-signature', 'Signature'),\n              description: LogsDedupDescription[LogsDedupStrategy.signature],\n            },\n          ],\n        },\n        defaultValue: LogsDedupStrategy.none,\n      })\n      .addRadio({\n        path: 'sortOrder',\n        name: t('logs-new.name-order', 'Order'),\n        category,\n        description: '',\n        settings: {\n          options: [\n            { value: LogsSortOrder.Descending, label: t('logs-new.order-options.label-newest-first', 'Newest first') },\n            { value: LogsSortOrder.Ascending, label: t('logs-new.order-options.label-oldest-first', 'Oldest first') },\n          ],\n        },\n        defaultValue: LogsSortOrder.Descending,\n      });\n  })\n  .setSuggestionsSupplier(new LogsPanelSuggestionsSupplier());\n"],"names":["isOnNewLogsReceivedType","callback","isOnLogOptionsChange","isLogsGrammar","grammar","isCoreApp","app","apps","coreApp","data","timeZone","fieldConfig","controlsStorageKey","dedupStrategy","enableInfiniteScrolling","onLogOptionsChange","onNewLogsReceived","showControls","showTime","sortOrder","syntaxHighlighting","wrapLogMessage","id","style","getStyles","logsContainer","setLogsContainer","panelData","setPanelData","dataSourcesMap","useDatasourcesFromTargets","keepScrollPositionRef","loadingRef","eventBus","logs","logsModel","loadMoreLogs","scrollRange","config","onNewLogsReceivedCallback","newSeries","e","onLogRowHover","row","initialScrollPosition","storageKey","element","LogList","PanelDataErrorView","theme","LogsPanelSuggestionsSupplier","builder","list","ds","PanelPlugin","category"],"sourceRoot":""}