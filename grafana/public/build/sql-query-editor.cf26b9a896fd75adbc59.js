"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[168],{47805:(U,M,o)=>{o.r(M),o.d(M,{default:()=>vt});var e=o(74848),c=o(96540),S=o(16817),j=o(41778),B=o(35137),T=o(81045),w=o(25274),L=o(73287),I=o(51898),r=o(92745),V=o(6904),z=o(75686),A=o(40263),D=o(32300),P=o(30048),K=o(27489),ee=o(21285),W=o(45861),de=o(45967),ue=o(77824),k=o(11194),F=o(22803),q=o(63142),oe=o(22787),re=o(30703);function Se({isOpen:t,onCancel:a,onDiscard:n,onCopy:s}){const d=(0,c.useRef)(null),i=(0,q.of)(we);return(0,c.useEffect)(()=>{t&&d.current?.focus()},[t]),(0,e.jsxs)(oe.a,{title:(0,e.jsxs)("div",{className:i.modalHeaderTitle,children:[(0,e.jsx)(re.I,{name:"exclamation-triangle",size:"lg"}),(0,e.jsx)("span",{className:i.titleText,children:(0,e.jsx)(r.x6,{i18nKey:"grafana-sql.components.confirm-modal.warning",children:"Warning"})})]}),onDismiss:a,isOpen:t,children:[(0,e.jsx)("p",{children:(0,e.jsx)(r.x6,{i18nKey:"grafana-sql.components.confirm-modal.builder-mode",children:"Builder mode does not display changes made in code. The query builder will display the last changes you made in builder mode."})}),(0,e.jsx)("p",{children:(0,e.jsx)(r.x6,{i18nKey:"grafana-sql.components.confirm-modal.clipboard",children:"Do you want to copy your code to the clipboard?"})}),(0,e.jsxs)(oe.a.ButtonRow,{children:[(0,e.jsx)(W.$n,{type:"button",variant:"secondary",onClick:a,fill:"outline",children:(0,e.jsx)(r.x6,{i18nKey:"grafana-sql.components.confirm-modal.cancel",children:"Cancel"})}),(0,e.jsx)(W.$n,{variant:"destructive",type:"button",onClick:n,ref:d,children:(0,e.jsx)(r.x6,{i18nKey:"grafana-sql.components.confirm-modal.discard-code-and-switch",children:"Discard code and switch"})}),(0,e.jsx)(W.$n,{variant:"primary",onClick:s,children:(0,e.jsx)(r.x6,{i18nKey:"grafana-sql.components.confirm-modal.copy-code-and-switch",children:"Copy code and switch"})})]})]})}const we=t=>({titleText:(0,F.css)({paddingLeft:t.spacing(2)}),modalHeaderTitle:(0,F.css)({fontSize:t.typography.size.lg,float:"left",paddingTop:t.spacing(1),margin:t.spacing(0,2)})});var N=o(18857),le=o(97890);const Ie=({dataset:t,db:a,dialect:n,onChange:s,inputId:d,preconfiguredDataset:i})=>{const m=!!i||n==="postgres",l=(0,S.A)(async()=>(0,le.C)()&&m?(s((0,k.zL)(i)),[(0,k.zL)(i)]):(t&&s((0,k.zL)(t)),(await a.datasets()).map(k.zL)),[]);return(0,c.useEffect)(()=>{(0,le.C)()||(t?l.value&&l.value.find(g=>g.value===t)===void 0&&l.value.length>0&&s(l.value[0]):l.value&&l.value[0]&&s(l.value[0]))},[l.value,s,t]),(0,e.jsx)(N.l6,{"aria-label":(0,r.t)("grafana-sql.components.dataset-selector.aria-label-dataset-selector","Dataset selector"),inputId:d,value:t,options:l.value,onChange:s,disabled:l.loading,isLoading:l.loading,menuShouldPortal:!0})};var H=o(47184);const Te=({db:t,dataset:a,table:n,className:s,onChange:d,inputId:i})=>{const m=(0,S.A)(async()=>a?(await t.tables(a)).map(H.z):[],[a]);return(0,e.jsx)(N.l6,{className:s,disabled:m.loading,"aria-label":(0,r.t)("grafana-sql.components.table-selector.aria-label-table-selector","Table selector"),inputId:i,"data-testid":I.Tp.components.SQLQueryEditor.headerTableSelector,value:n,options:m.value,onChange:d,isLoading:m.loading,menuShouldPortal:!0,placeholder:m.loading?(0,r.t)("grafana-sql.components.table-selector.placeholder-loading","Loading tables"):(0,r.t)("grafana-sql.components.table-selector.placeholder-select-table","Select table"),allowCustomValue:!0})};function Oe({db:t,dialect:a,isQueryRunnable:n,onChange:s,onQueryRowChange:d,onRunQuery:i,preconfiguredDataset:m,query:l,queryRowFilter:g}){const{editorMode:p}=l,[v,x]=(0,L.A)(),[f,u]=(0,c.useState)(!1),h=t.toRawSql,y=(0,c.useId)(),b=[{label:(0,r.t)("grafana-sql.components.query-header.editor-modes.label-builder","Builder"),value:j.lX.Builder},{label:(0,r.t)("grafana-sql.components.query-header.editor-modes.label-code","Code"),value:j.lX.Code}],Q=(0,c.useCallback)(E=>{if(E===j.lX.Code&&(0,K.rR)("grafana_sql_editor_mode_changed",{datasource:l.datasource?.type,selectedEditorMode:j.lX.Code}),p===j.lX.Code){u(!0);return}s({...l,editorMode:E})},[p,s,l]),O=E=>{const X={...l,format:E.value!==void 0?E.value:k.gv.Table};(0,K.rR)("grafana_sql_format_changed",{datasource:l.datasource?.type,selectedFormat:X.format}),s(X)},$=E=>{if(E.value===l.dataset)return;const X={...l,dataset:E.value,table:void 0,sql:void 0,rawSql:""};s(X)},G=E=>{if(E.value===l.table)return;const X={...l,table:E.value,sql:void 0,rawSql:""};s(X)},R=()=>!(a==="influx"||!(0,le.C)()&&a==="postgres");return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsxs)(V.X,{children:[(0,e.jsx)(z.W,{label:(0,r.t)("grafana-sql.components.query-header.label-format","Format"),value:l.format,placeholder:(0,r.t)("grafana-sql.components.query-header.placeholder-select-format","Select format"),menuShouldPortal:!0,onChange:O,options:k.cO}),p===j.lX.Builder&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(ee.K,{id:`sql-filter-${y}`,label:(0,r.t)("grafana-sql.components.query-header.label-filter","Filter"),"data-testid":I.Tp.components.SQLQueryEditor.headerFilterSwitch,transparent:!0,showLabel:!0,value:g.filter,onChange:E=>{E.target instanceof HTMLInputElement&&((0,K.rR)("grafana_sql_filter_toggled",{datasource:l.datasource?.type,displayed:E.target.checked}),d({...g,filter:E.target.checked}))}}),(0,e.jsx)(ee.K,{id:`sql-group-${y}`,label:(0,r.t)("grafana-sql.components.query-header.label-group","Group"),"data-testid":I.Tp.components.SQLQueryEditor.headerGroupSwitch,transparent:!0,showLabel:!0,value:g.group,onChange:E=>{E.target instanceof HTMLInputElement&&((0,K.rR)("grafana_sql_group_toggled",{datasource:l.datasource?.type,displayed:E.target.checked}),d({...g,group:E.target.checked}))}}),(0,e.jsx)(ee.K,{id:`sql-order-${y}`,label:(0,r.t)("grafana-sql.components.query-header.label-order","Order"),"data-testid":I.Tp.components.SQLQueryEditor.headerOrderSwitch,transparent:!0,showLabel:!0,value:g.order,onChange:E=>{E.target instanceof HTMLInputElement&&((0,K.rR)("grafana_sql_order_toggled",{datasource:l.datasource?.type,displayed:E.target.checked}),d({...g,order:E.target.checked}))}}),(0,e.jsx)(ee.K,{id:`sql-preview-${y}`,label:(0,r.t)("grafana-sql.components.query-header.label-preview","Preview"),"data-testid":I.Tp.components.SQLQueryEditor.headerPreviewSwitch,transparent:!0,showLabel:!0,value:g.preview,onChange:E=>{E.target instanceof HTMLInputElement&&((0,K.rR)("grafana_sql_preview_toggled",{datasource:l.datasource?.type,displayed:E.target.checked}),d({...g,preview:E.target.checked}))}})]}),(0,e.jsx)(A.Z,{grow:1}),n?(0,e.jsx)(W.$n,{icon:"play",variant:"primary",size:"sm",onClick:()=>i(),children:(0,e.jsx)(r.x6,{i18nKey:"grafana-sql.components.query-header.run-query",children:"Run query"})}):(0,e.jsx)(de.m,{theme:"error",content:(0,e.jsxs)(r.x6,{i18nKey:"grafana-sql.components.query-header.content-invalid-query",children:["Your query is invalid. Check below for details. ",(0,e.jsx)("br",{}),"However, you can still run this query."]}),placement:"top",children:(0,e.jsx)(W.$n,{icon:"exclamation-triangle",variant:"secondary",size:"sm",onClick:()=>i(),children:(0,e.jsx)(r.x6,{i18nKey:"grafana-sql.components.query-header.run-query",children:"Run query"})})}),(0,e.jsx)(ue.z,{options:b,size:"sm",value:p,onChange:Q}),(0,e.jsx)(Se,{isOpen:f,onCopy:()=>{(0,K.rR)("grafana_sql_editor_mode_changed",{datasource:l.datasource?.type,selectedEditorMode:j.lX.Builder,type:"copy"}),u(!1),x(l.rawSql),s({...l,rawSql:h(l),editorMode:j.lX.Builder})},onDiscard:()=>{(0,K.rR)("grafana_sql_editor_mode_changed",{datasource:l.datasource?.type,selectedEditorMode:j.lX.Builder,type:"discard"}),u(!1),s({...l,rawSql:h(l),editorMode:j.lX.Builder})},onCancel:()=>{(0,K.rR)("grafana_sql_editor_mode_changed",{datasource:l.datasource?.type,selectedEditorMode:j.lX.Builder,type:"cancel"}),u(!1)}})]}),p===j.lX.Builder&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(B.$,{v:.5}),(0,e.jsxs)(D.U,{children:[R()&&(0,e.jsx)(P.c,{label:(0,r.t)("grafana-sql.components.query-header.label-dataset","Dataset"),width:25,children:(0,e.jsx)(Ie,{db:t,inputId:`sql-dataset-${y}`,dataset:l.dataset,dialect:a,preconfiguredDataset:m,onChange:$})}),(0,e.jsx)(P.c,{label:(0,r.t)("grafana-sql.components.query-header.label-table","Table"),width:25,children:(0,e.jsx)(Te,{db:t,inputId:`sql-tableselect-${y}`,dataset:l.dataset||m,table:l.table,onChange:G})})]})]})]})}var me=o(49185),Me=o(70713),Re=o(97504);function Be({children:t,onChange:a,query:n,width:s,height:d,editorLanguageDefinition:i}){const m=(0,c.useRef)(n);(0,c.useEffect)(()=>{m.current=n},[n]);const l=(0,c.useCallback)((g,p)=>{const v={...m.current,rawQuery:!0,rawSql:g};a(v,p)},[a]);return(0,e.jsx)(Re.Y,{width:s,height:d,query:n.rawSql,onChange:l,language:i,children:t})}var Z=o(41654),pe=o(76319),De=o(41053),Fe=o(40996),fe=o(55386),Le=o(68079);function Pe({db:t,query:a,onValidate:n,range:s}){const[d,i]=(0,c.useState)(),m=(0,q.$j)(),l=(0,c.useMemo)(()=>(0,fe.j_)("bytes"),[]),g=(0,c.useMemo)(()=>({error:(0,F.css)({color:m.colors.error.text,fontSize:m.typography.bodySmall.fontSize,fontFamily:m.typography.fontFamilyMonospace}),valid:(0,F.css)({color:m.colors.success.text}),info:(0,F.css)({color:m.colors.text.secondary})}),[m]),[p,v]=(0,De.A)(async f=>f.rawSql?.trim()===""?null:await t.validateQuery(f,s),[t]),[,]=(0,Fe.A)(async()=>{const f=await v(a);return f&&i(f),null},1e3,[a,v]);if((0,c.useEffect)(()=>{d?.isError&&n(!1),d?.isValid&&n(!0)},[d,n]),!p.value&&!p.loading)return null;const x=p.value?.error?$e(p.value.error):"";return(0,e.jsxs)(e.Fragment,{children:[p.loading&&(0,e.jsxs)("div",{className:g.info,children:[(0,e.jsx)(Le.y,{inline:!0,size:"xs"})," ",(0,e.jsx)(r.x6,{i18nKey:"grafana-sql.components.query-validator.validating-query",children:"Validating query..."})]}),!p.loading&&p.value&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(e.Fragment,{children:p.value.isValid&&p.value.statistics&&(0,e.jsx)("div",{className:g.valid,children:(0,e.jsxs)(r.x6,{i18nKey:"grafana-sql.components.query-validator.query-will-process",values:{bytes:(0,fe.cN)(l(p.value.statistics.TotalBytesProcessed))},children:[(0,e.jsx)(re.I,{name:"check"})," This query will process ",(0,e.jsx)("strong",{children:"{{bytes}}"})," when run."]})})}),(0,e.jsx)(e.Fragment,{children:p.value.isError&&(0,e.jsx)("div",{className:g.error,children:x})})]})]})}function $e(t){const a=t.split(":");return a.length>2?a.slice(2).join(":"):t}function ge({showTools:t,onFormatCode:a,onExpand:n,isExpanded:s,...d}){const i=(0,q.$j)(),[m,l]=(0,c.useState)(),g=(0,c.useMemo)(()=>({container:(0,F.css)({border:`1px solid ${i.colors.border.medium}`,borderTop:"none",padding:i.spacing(.5,.5,.5,.5),display:"flex",flexGrow:1,justifyContent:"space-between",fontSize:i.typography.bodySmall.fontSize}),error:(0,F.css)({color:i.colors.error.text,fontSize:i.typography.bodySmall.fontSize,fontFamily:i.typography.fontFamilyMonospace}),valid:(0,F.css)({color:i.colors.success.text}),info:(0,F.css)({color:i.colors.text.secondary}),hint:(0,F.css)({color:i.colors.text.disabled,whiteSpace:"nowrap",cursor:"help"})}),[i]);let p={};return!t&&m===void 0&&(p={height:0,padding:0,visibility:"hidden"}),(0,e.jsxs)("div",{className:g.container,style:p,children:[(0,e.jsx)("div",{children:d.onValidate&&(0,e.jsx)(Pe,{...d,onValidate:v=>{l(v),d.onValidate(v)}})}),t&&(0,e.jsx)("div",{children:(0,e.jsxs)(Z.B,{gap:1,children:[a&&(0,e.jsx)(pe.K,{onClick:()=>{(0,K.rR)("grafana_sql_query_formatted",{datasource:d.query.datasource?.type}),a()},name:"brackets-curly",size:"xs",tooltip:(0,r.t)("grafana-sql.components.query-toolbox.tooltip-format-query","Format query")}),n&&(0,e.jsx)(pe.K,{onClick:()=>{(0,K.rR)("grafana_sql_editor_expand",{datasource:d.query.datasource?.type,expanded:!s}),n(!s)},name:s?"angle-up":"angle-down",size:"xs",tooltip:s?(0,r.t)("grafana-sql.components.query-toolbox.tooltip-collapse","Collapse editor"):(0,r.t)("grafana-sql.components.query-toolbox.tooltip-expand","Expand editor")}),(0,e.jsx)(de.m,{content:(0,r.t)("grafana-sql.components.query-toolbox.content-hit-ctrlcmdreturn-to-run-query","Hit CTRL/CMD+Return to run query"),children:(0,e.jsx)(re.I,{className:g.hint,name:"keyboard"})})]})})]})}function Ae({db:t,query:a,onChange:n,onRunQuery:s,onValidate:d,queryToValidate:i,range:m}){const l=(0,q.$j)(),g=(0,q.of)(Qe),[p,v]=(0,c.useState)(!1),[x,f]=(0,me.A)(),[u,h]=(0,me.A)(),y=(0,c.useMemo)(()=>t.getEditorLanguageDefinition(),[t]),b=($,G)=>(0,e.jsx)(Be,{editorLanguageDefinition:y,query:a,width:$,height:G?G-f.height:void 0,onChange:n,children:({formatQuery:R})=>(0,e.jsx)("div",{ref:x,children:(0,e.jsx)(ge,{db:t,query:i,onValidate:d,onFormatCode:R,showTools:!0,range:m,onExpand:v,isExpanded:p})})}),Q=($=!1)=>$?(0,e.jsx)(Me.Ay,{children:({width:G,height:R})=>b(G,R)}):(0,e.jsx)("div",{ref:u,children:b()}),O=()=>(0,e.jsx)("div",{style:{width:h.width,height:h.height,background:l.colors.background.primary,display:"flex",alignItems:"center",justifyContent:"center"},children:(0,e.jsx)(r.x6,{i18nKey:"grafana-sql.components.raw-editor.render-placeholder.editing-in-expanded-code-editor",children:"Editing in expanded code editor"})});return(0,e.jsxs)(e.Fragment,{children:[p?O():Q(),p&&(0,e.jsx)(oe.a,{title:(0,r.t)("grafana-sql.components.raw-editor.title-query-num","Query {{queryNum}}",{queryNum:a.refId}),closeOnBackdropClick:!1,closeOnEscape:!1,className:g.modal,contentClassName:g.modalContent,isOpen:p,onDismiss:()=>{(0,K.rR)("grafana_sql_editor_expand",{datasource:a.datasource?.type,expanded:!1}),v(!1)},children:Q(!0)})]})}function Qe(t){return{modal:(0,F.css)({width:"95vw",height:"95vh"}),modalContent:(0,F.css)({height:"100%",paddingTop:0})}}var Ke=o(1667),Ne=o(27074);function he(t,a){if(!a||!t.sql?.columns)return a;const n=t.sql.columns.map((s,d)=>{const i=s.name?`${s.name}(${s.parameters?.map(m=>m.name).join(", ")})`:s.parameters?.map(m=>m.name).join(", ");return{value:i,label:`${d+1} - ${i}`}});return[{value:"",label:(0,r.t)("grafana-sql.utils.get-columns-width-indices.label-selected-columns","Selected columns"),options:n,expanded:!0},...a]}function te({query:t,onQueryChange:a,db:n}){return{onSqlChange:(0,c.useCallback)(d=>{const i=n.toRawSql,m=i({sql:d,dataset:t.dataset,table:t.table,refId:t.refId}),l={...t,sql:d,rawSql:m};a(l)},[n,a,t])}}var ze=o(26774),ve=o(72500),We=o(20301);function Ve({sql:t,columns:a,onSqlChange:n}){const s=(0,c.useCallback)(d=>{const i=d.map(l=>(0,w.xG)(l.property?.name)),m={...t,groupBy:i};n(m)},[n,t]);return(0,e.jsx)(ze.o,{items:t.groupBy,onChange:s,renderItem:Ue({options:a})})}function Ue({options:t}){return function(n,s,d){return(0,e.jsxs)(ve.M,{children:[(0,e.jsx)(N.l6,{value:n.property?.name?(0,H.z)(n.property.name):null,"aria-label":(0,r.t)("grafana-sql.components.make-render-column.render-column.aria-label-group-by","Group by"),options:t,menuShouldPortal:!0,onChange:({value:i})=>i&&s((0,w.xG)(i))}),(0,e.jsx)(We.Z,{title:(0,r.t)("grafana-sql.components.make-render-column.render-column.title-remove-group-by-column","Remove group by column"),icon:"times",variant:"secondary",onClick:d})]})}}function qe({fields:t,query:a,onQueryChange:n,db:s}){const{onSqlChange:d}=te({query:a,onQueryChange:n,db:s});let i=he(a,t);return(0,e.jsx)(Ve,{columns:i,sql:a.sql,onSqlChange:d})}var _=o(2543),J=o(63527);const Ge=[{description:"Sort by ascending",value:"ASC",icon:"sort-amount-up"},{description:"Sort by descending",value:"DESC",icon:"sort-amount-down"}];function Xe({sql:t,onSqlChange:a,columns:n,showOffset:s}){const d=(0,c.useCallback)(g=>{const p={...t,orderByDirection:g};a(p)},[a,t]),i=(0,c.useCallback)(g=>{const p={...t,limit:Number.parseInt(g.currentTarget.value,10)};a(p)},[a,t]),m=(0,c.useCallback)(g=>{const p={...t,offset:Number.parseInt(g.currentTarget.value,10)};a(p)},[a,t]),l=(0,c.useCallback)(g=>{const p={...t,orderBy:(0,w.Kj)(g?.value)};g===null&&(p.orderByDirection=void 0),a(p)},[a,t]);return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(P.c,{label:(0,r.t)("grafana-sql.components.order-by-row.label-order-by","Order by"),width:25,children:(0,e.jsxs)(ve.M,{children:[(0,e.jsx)(N.l6,{"aria-label":(0,r.t)("grafana-sql.components.order-by-row.aria-label-order-by","Order by"),options:n,value:t.orderBy?.property.name?(0,H.z)(t.orderBy.property.name):null,isClearable:!0,menuShouldPortal:!0,onChange:l}),(0,e.jsx)(B.$,{h:1.5}),(0,e.jsx)(ue.z,{options:Ge,disabled:!t?.orderBy?.property.name,value:t.orderByDirection,onChange:d})]})}),(0,e.jsx)(P.c,{label:(0,r.t)("grafana-sql.components.order-by-row.label-limit","Limit"),optional:!0,width:25,children:(0,e.jsx)(J.p,{type:"number",min:0,id:(0,_.uniqueId)("limit-"),value:t.limit||"",onChange:i})}),s&&(0,e.jsx)(P.c,{label:(0,r.t)("grafana-sql.components.order-by-row.label-offset","Offset"),optional:!0,width:25,children:(0,e.jsx)(J.p,{type:"number",id:(0,_.uniqueId)("offset-"),value:t.offset||"",onChange:m})})]})}function ke({fields:t,query:a,onQueryChange:n,db:s}){const{onSqlChange:d}=te({query:a,onQueryChange:n,db:s});let i=he(a,t);return(0,e.jsx)(Xe,{sql:a.sql,onSqlChange:d,columns:i})}var He=o(2863),C=o(52135),ye=o(25229),Je=o(27282);const ie={add:"Add",remove:"Remove"},xe={id:C.Aq.uuid(),type:"group"},be="timeFilter",je=[be],Ye={...C.d$.widgets,text:{...C.d$.widgets.text,factory:function(a){return(0,e.jsx)(J.p,{value:a?.value||"",placeholder:a?.placeholder,onChange:n=>a?.setValue(n.currentTarget.value)})}},number:{...C.d$.widgets.number,factory:function(a){return(0,e.jsx)(J.p,{value:a?.value,placeholder:a?.placeholder,type:"number",onChange:n=>a?.setValue(Number.parseInt(n.currentTarget.value,10))})}},datetime:{...C.d$.widgets.datetime,factory:function(a){if(a?.operator==="macros")return(0,e.jsx)(N.l6,{id:a.id,"aria-label":(0,r.t)("grafana-sql.components.widgets.aria-label-macros-value-selector","Macros value selector"),menuShouldPortal:!0,options:je.map(H.z),value:a?.value,onChange:s=>a.setValue(s.value)});const n=(0,ye.KQ)(a?.value).isValid()?(0,ye.KQ)(a?.value).utc():void 0;return(0,e.jsx)(Je.K,{onChange:s=>{a?.setValue(s?.format(C.d$.widgets.datetime.valueFormat))},date:n})},sqlFormatValue:(t,a,n,s,d,i)=>s==="macros"?je.includes(t)?t:void 0:typeof C.d$.widgets.datetime.sqlFormatValue=="string"||typeof C.d$.widgets.datetime.sqlFormatValue=="object"?void 0:C.d$.widgets.datetime.sqlFormatValue?.call(C.d$.ctx,t,a,n,s,d,i)||""}},Ze={...C.d$.settings,canRegroup:!1,maxNesting:1,canReorder:!1,showNot:!1,addRuleLabel:ie.add,deleteLabel:ie.remove,renderConjs:function(a){return(0,e.jsx)(N.l6,{id:a?.id,"aria-label":(0,r.t)("grafana-sql.components.settings.aria-label-conjunction","Conjunction"),"data-testid":I.Tp.components.SQLQueryEditor.filterConjunction,menuShouldPortal:!0,options:a?.conjunctionOptions?Object.keys(a?.conjunctionOptions).map(H.z):void 0,value:a?.selectedConjunction,onChange:n=>a?.setConjunction(n.value)})},renderField:function(a){const n=a?.config?.fields||{};return(0,e.jsx)(N.l6,{id:a?.id,width:25,"aria-label":(0,r.t)("grafana-sql.components.settings.aria-label-field","Field"),"data-testid":I.Tp.components.SQLQueryEditor.filterField,menuShouldPortal:!0,options:a?.items.map(s=>{const d=n[s.key].mainWidgetProps?.customProps?.icon;return{label:s.label,value:s.key,icon:d}}),value:a?.selectedKey,onChange:s=>{a?.setField(s.label)}})},renderButton:function(a){return(0,e.jsx)(W.$n,{type:"button",title:(0,r.t)("grafana-sql.components.settings.title-button-filter","{{ buttonLabel }} filter",{buttonLabel:a?.label}),onClick:a?.onClick,variant:"secondary",size:"md",icon:a?.label===ie.add?"plus":"times"})},renderOperator:function(a){return(0,e.jsx)(N.l6,{options:a?.items.map(n=>({label:n.label,value:n.key})),"aria-label":(0,r.t)("grafana-sql.components.settings.aria-label-operator","Operator"),"data-testid":I.Tp.components.SQLQueryEditor.filterOperator,menuShouldPortal:!0,value:a?.selectedKey,onChange:n=>{a?.setField(n.value||"")}})}};var _e=(t=>(t.IN="select_any_in",t.NOT_IN="select_not_any_in",t.MACROS="macros",t))(_e||{});const et=ot(C.d$),Ce=C.d$.types.text.widgets.text,tt=[...Ce.operators||[],"select_any_in","select_not_any_in"],at={...Ce,operators:tt},nt={...C.d$.types,text:{...C.d$.types.text,widgets:{...C.d$.types.text.widgets,text:at}},datetime:{...C.d$.types.datetime,widgets:{...C.d$.types.datetime.widgets,datetime:{...C.d$.types.datetime.widgets.datetime,operators:["macros",...C.d$.types.datetime.widgets.datetime.operators||[]]}}}},st={...C.d$,widgets:Ye,settings:Ze,operators:et,types:nt},ae=()=>"";function ot(t){const{...a}=t.operators,n=a.select_any_in.sqlFormatOp?.bind(t.ctx)||ae,s=a.select_any_in.formatOp?.bind(t.ctx)||ae,d=(p,v,x,f,u,h,y,b)=>n(p,v,ne(x),f,u,h,y,b),i=a.select_not_any_in.sqlFormatOp?.bind(t.ctx)||ae,m=a.select_not_any_in.formatOp?.bind(t.ctx)||ae,l=(p,v,x,f,u,h,y,b)=>i(p,v,ne(x),f,u,h,y,b);return{...a,select_any_in:{...a.select_any_in,formatOp:(p,v,x,f)=>s(p,v,ne(x),f),sqlFormatOp:d},select_not_any_in:{...a.select_not_any_in,formatOp:(p,v,x,f)=>m(p,v,ne(x),f),sqlFormatOp:l},macros:{label:(0,r.t)("grafana-sql.components.get-custom-operators.custom-operators.label.macros","Macros"),sqlFormatOp:(p,v,x)=>{if(x===be)return`$__timeFilter(${p})`;throw new Error("Invalid macro")}}}}function ne(t){return(0,_.isString)(t)?t.split(","):t}function rt({sql:t,config:a,onSqlChange:n}){const[s,d]=(0,c.useState)(),i=(0,c.useMemo)(()=>({...st,...a}),[a]);(0,c.useEffect)(()=>{if(!s){const l=C.Aq.checkTree(C.Aq.loadTree(t.whereJsonTree??xe),i);d(l)}},[i,t.whereJsonTree,s]),(0,c.useEffect)(()=>{t.whereJsonTree||d(C.Aq.checkTree(C.Aq.loadTree(xe),i))},[i,t.whereJsonTree]);const m=(0,c.useCallback)((l,g)=>{d(l);const p={...t,whereJsonTree:C.Aq.getTree(l),whereString:C.Aq.sqlFormat(l,g)};n(p)},[n,t]);return s?(0,e.jsx)(C.XK,{...i,value:s,onChange:m,renderBuilder:l=>(0,e.jsx)(C.M$,{...l})}):null}function se(t){return`
    display: flex;
    gap: 8px;
    flex-direction: ${t};`}(0,F.injectGlobal)`
  .group--header {
    ${se("row")}
  }

  .group-or-rule {
    ${se("column")}
    .rule {
      flex-direction: row;
    }
  }

  .rule--body {
    ${se("row")}
  }

  .group--children {
    ${se("column")}
  }

  .group--conjunctions:empty {
    display: none;
  }
`;function lt({query:t,fields:a,onQueryChange:n,db:s}){const d=(0,S.A)(async()=>it(a),[a]),{onSqlChange:i}=te({query:t,onQueryChange:n,db:s});return(0,e.jsx)(rt,{config:{fields:d.value||{}},sql:t.sql,onSqlChange:m=>{const l=(0,He.w)().getVariables();ct(m,l),i(m)}},JSON.stringify(d.value))}function it(t){const a={};for(const n of t)a[n.value]={type:n.raqbFieldType||"text",valueSources:["value"],mainWidgetProps:{customProps:{icon:n.icon}}};return a}function ct(t,a){const n=s=>"multi"in s&&s.multi&&(t.whereString?.includes(`\${${s.name}}`)||t.whereString?.includes(`$${s.name}`));a.some(s=>n(s))&&(t.whereString=t.whereString?.replaceAll("')",")"),t.whereString=t.whereString?.replaceAll("('","("))}var ce=o(36656),Y=o(79233);function Ee({columns:t,onParameterChange:a,value:n}){const s=(0,c.useId)();return(0,e.jsx)(P.c,{label:(0,r.t)("grafana-sql.components.select-column.label-column","Column"),width:25,children:(0,e.jsx)(N.l6,{value:n,"data-testid":I.Tp.components.SQLQueryEditor.selectColumn,inputId:s,menuShouldPortal:!0,options:[{label:"*",value:"*"},...t],allowCustomValue:!0,onChange:d=>a(d.value)})})}function dt({columns:t,query:a,onSqlChange:n,onParameterChange:s,currentColumnIndex:d}){const i=(0,q.of)(ut),m=a.sql?.columns?.[d],l=(0,c.useCallback)(v=>{const x=a.sql?.columns?.[v];if(!x)return;x.parameters=x.parameters?[...x.parameters,{type:ce._.FunctionParameter,name:""}]:[];const f={...a.sql,columns:a.sql?.columns?.map((u,h)=>h===v?x:u)};n(f)},[n,a.sql]),g=(0,c.useCallback)((v,x)=>{const f=a.sql?.columns?.[v];if(!f?.parameters)return;f.parameters=f.parameters?.filter((h,y)=>y!==x);const u={...a.sql,columns:a.sql?.columns?.map((h,y)=>y===v?f:h)};n(u)},[n,a.sql]);function p(v){return!m?.parameters||m.parameters.length<=1?null:m.parameters.map((f,u)=>u===0?null:(0,e.jsxs)(Z.B,{gap:2,children:[(0,e.jsx)(Y.c,{className:i.label,children:","}),(0,e.jsx)(J.p,{onChange:h=>s(u)(h.currentTarget.value),value:f.name,"aria-label":(0,r.t)("grafana-sql.components.select-custom-function-parameters.aria-label-parameter","Parameter {{index}} for column {{columnIndex}}",{index:u,columnIndex:v}),"data-testid":I.Tp.components.SQLQueryEditor.selectInputParameter,addonAfter:(0,e.jsx)(W.$n,{title:(0,r.t)("grafana-sql.components.select-custom-function-parameters.render-parameters.params.title-remove-parameter","Remove parameter"),type:"button",icon:"times",variant:"secondary",size:"md",onClick:()=>g(v,u)})})]},u))}return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(Y.c,{className:i.label,children:"("}),(0,e.jsx)(Ee,{columns:t,onParameterChange:v=>s(0)(v),value:(0,w.oG)(m?.parameters?.[0])}),p(d),(0,e.jsx)(W.$n,{type:"button",onClick:()=>l(d),variant:"secondary",size:"md",icon:"plus",title:(0,r.t)("grafana-sql.components.select-custom-function-parameters.title-add-parameter","Add parameter")}),(0,e.jsx)(Y.c,{className:i.label,children:")"})]})}const ut=()=>({label:(0,F.css)({padding:0,margin:0,width:"unset"})});function mt({query:t,onSqlChange:a,currentColumnIndex:n,db:s,columns:d}){const i=(0,c.useId)(),m=t.sql?.columns?.[n],l=(0,q.of)(pt),g=s.functions().find(u=>u.name===m?.name),[p,v]=(0,c.useState)([]);(0,c.useEffect)(()=>{(async()=>{if(!g)return;const h=[];for(const y of g.parameters??[])y.options?h.push(await y.options(t)):h.push([]);v(h)})()},[m?.name]);const x=(0,c.useCallback)((u,h)=>y=>{const b=t.sql?.columns?.[n];if(!b)return;b.parameters||(b.parameters=[]),b.parameters[u]===void 0?b.parameters[u]={type:ce._.FunctionParameter,name:y}:y==null&&h?(b.parameters=b.parameters.map((O,$)=>$===u?{...O,name:""}:O),b.parameters[b.parameters.length-1]?.name===""&&(b.parameters=b.parameters.filter(O=>O.name!==""))):y==null?b.parameters=b.parameters.filter((O,$)=>$!==u):b.parameters=b.parameters.map((O,$)=>$===u?{...O,name:y}:O);const Q={...t.sql,columns:t.sql?.columns?.map((O,$)=>$===n?b:O)};a(Q)},[n,a,t.sql]);function f(){return g?.parameters?g?.parameters.map((u,h)=>(0,e.jsxs)(Z.B,{alignItems:"flex-end",gap:2,children:[(0,e.jsx)(P.c,{label:u.name,width:25,optional:!u.required,children:(0,e.jsx)(e.Fragment,{children:u.options?(0,e.jsx)(N.l6,{value:(0,w.oG)(m?.parameters[h]),options:p?.[h],"data-testid":I.Tp.components.SQLQueryEditor.selectFunctionParameter(u.name),inputId:i,menuShouldPortal:!0,allowCustomValue:!0,isClearable:!0,onChange:y=>x(h,!0)(y?.value)}):(0,e.jsx)(J.p,{onChange:y=>x(h,!0)(y.currentTarget.value),value:m?.parameters[h]?.name,"data-testid":I.Tp.components.SQLQueryEditor.selectInputParameter})})}),g.parameters.length!==h+1&&(0,e.jsx)(Y.c,{className:l.label,children:","})]},h)):null}return m?.name===void 0?(0,e.jsx)(Ee,{columns:d,onParameterChange:u=>x(0)(u),value:(0,w.oG)(m?.parameters?.[0])}):g?(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(Y.c,{className:l.label,children:"("}),f(),(0,e.jsx)(Y.c,{className:l.label,children:")"})]}):(0,e.jsx)(dt,{query:t,onSqlChange:a,currentColumnIndex:n,columns:d,onParameterChange:x})}const pt=()=>({label:(0,F.css)({padding:0,margin:0,width:"unset"})});function ft({query:t,onQueryChange:a,db:n,columns:s}){const d=(0,q.of)(gt),{onSqlChange:i}=te({query:t,onQueryChange:a,db:n}),m=[];t.format===k.gv.Timeseries&&(m.push({label:(0,r.t)("grafana-sql.components.select-row.label.time","time"),value:"time"}),m.push({label:(0,r.t)("grafana-sql.components.select-row.label.value","value"),value:"value"}));const l=(0,c.useCallback)((f,u)=>h=>{const y={...f,name:h?.value,parameters:[{type:ce._.FunctionParameter,name:f.parameters?.[0]?.name||""}]},b={...t.sql,columns:t.sql?.columns?.map((Q,O)=>O===u?y:Q)};i(b)},[i,t.sql]),g=(0,c.useCallback)((f,u)=>h=>{let y={...f};h!==null?y={...f,alias:`"${h?.value?.trim()}"`}:delete y.alias;const b={...t.sql,columns:t.sql?.columns?.map((Q,O)=>O===u?y:Q)};i(b)},[i,t.sql]),p=(0,c.useCallback)(f=>()=>{const u=[...t.sql?.columns||[]];u.splice(f,1);const h={...t.sql,columns:u};i(h)},[i,t.sql]),v=(0,c.useCallback)(()=>{const f={...t.sql,columns:[...t.sql?.columns||[],(0,w.JD)()]};i(f)},[i,t.sql]),x=()=>{const f=[{label:(0,r.t)("grafana-sql.components.select-row.aggregate-options.options.label.aggregations","Aggregations"),options:[]},{label:(0,r.t)("grafana-sql.components.select-row.aggregate-options.options.label.macros","Macros"),options:[]}];for(const u of n.functions())u.name.startsWith("$__")?f[1].options.push({label:u.name,value:u.name}):f[0].options.push({label:u.name,value:u.name});return f};return(0,e.jsxs)(Z.B,{gap:2,wrap:"wrap",direction:"column",children:[t.sql?.columns?.map((f,u)=>(0,e.jsx)("div",{children:(0,e.jsxs)(Z.B,{gap:2,alignItems:"end",children:[(0,e.jsx)(P.c,{label:(0,r.t)("grafana-sql.components.select-row.label-data-operations","Data operations"),optional:!0,width:25,children:(0,e.jsx)(N.l6,{value:f.name?(0,H.z)(f.name):null,inputId:`select-aggregation-${u}-${(0,_.uniqueId)()}`,"data-testid":I.Tp.components.SQLQueryEditor.selectAggregation,isClearable:!0,menuShouldPortal:!0,allowCustomValue:!0,options:x(),onChange:l(f,u)})}),(0,e.jsx)(mt,{currentColumnIndex:u,columns:s,onSqlChange:i,query:t,db:n}),(0,e.jsx)(P.c,{label:(0,r.t)("grafana-sql.components.select-row.label-alias","Alias"),optional:!0,width:15,children:(0,e.jsx)(N.l6,{value:f.alias?(0,H.z)(f.alias):null,inputId:`select-alias-${u}-${(0,_.uniqueId)()}`,"data-testid":I.Tp.components.SQLQueryEditor.selectAlias,options:m,onChange:g(f,u),isClearable:!0,menuShouldPortal:!0,allowCustomValue:!0})}),(0,e.jsx)(W.$n,{title:(0,r.t)("grafana-sql.components.select-row.title-remove-column","Remove column"),type:"button",icon:"trash-alt",variant:"secondary",size:"md",onClick:p(u)})]})},u)),(0,e.jsx)(W.$n,{type:"button",onClick:v,variant:"secondary",title:(0,r.t)("grafana-sql.components.select-row.title-add-column","Add column"),size:"md",icon:"plus",className:d.addButton})]})}const gt=()=>({addButton:(0,F.css)({alignSelf:"flex-start"}),label:(0,F.css)({padding:0,margin:0,width:"unset"})}),ht=({query:t,db:a,queryRowFilter:n,onChange:s,onValidate:d,range:i})=>{const m=(0,S.A)(async()=>await a.fields(t),[a,t.dataset,t.table]);return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsxs)(Ke.D,{children:[(0,e.jsx)(D.U,{children:(0,e.jsx)(ft,{columns:m.value||[],query:t,onQueryChange:s,db:a})}),n.filter&&(0,e.jsx)(D.U,{children:(0,e.jsx)(P.c,{label:(0,r.t)("grafana-sql.components.visual-editor.label-filter-by-column-value","Filter by column value"),optional:!0,children:(0,e.jsx)(lt,{fields:m.value||[],query:t,onQueryChange:s,db:a})})}),n.group&&(0,e.jsx)(D.U,{children:(0,e.jsx)(P.c,{label:(0,r.t)("grafana-sql.components.visual-editor.label-group-by-column","Group by column"),children:(0,e.jsx)(qe,{fields:m.value||[],query:t,onQueryChange:s,db:a})})}),n.order&&(0,e.jsx)(D.U,{children:(0,e.jsx)(ke,{fields:m.value||[],query:t,onQueryChange:s,db:a})}),n.preview&&t.rawSql&&(0,e.jsx)(D.U,{children:(0,e.jsx)(Ne.l,{rawSql:t.rawSql,datasourceType:t.datasource?.type})})]}),(0,e.jsx)(ge,{db:a,query:t,onValidate:d,range:i})]})};function vt({datasource:t,query:a,onChange:n,onRunQuery:s,range:d,queryHeaderProps:i}){const[m,l]=(0,c.useState)(!0),g=t.getDB(),{preconfiguredDatabase:p}=t,v=i?.dialect??"other",{loading:x,error:f}=(0,S.A)(async()=>()=>{t.getDB(t.id).init!==void 0&&t.getDB(t.id).init()},[t]),u=(0,T.T)(a),[h,y]=(0,c.useState)({filter:!!u.sql?.whereString,group:!!u.sql?.groupBy?.[0]?.property.name,order:!!u.sql?.orderBy?.property.name,preview:!0}),[b,Q]=(0,c.useState)(u);(0,c.useEffect)(()=>()=>{t.getDB(t.id).dispose!==void 0&&t.getDB(t.id).dispose()},[t]);const O=(0,c.useCallback)(R=>{yt(R)&&s&&s()},[s]),$=(R,E=!0)=>{Q(R),n(R),(0,w.YW)(R.sql?.columns)&&R.sql?.columns.some(X=>X.name)&&!h.group&&y({...h,group:!0}),E&&O(R)},G=R=>{Q(R),n(R)};return x||f?null:(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(Oe,{db:g,preconfiguredDataset:p,onChange:G,onRunQuery:s,onQueryRowChange:y,queryRowFilter:h,query:u,isQueryRunnable:m,dialect:v}),(0,e.jsx)(B.$,{v:.5}),u.editorMode!==j.lX.Code&&(0,e.jsx)(ht,{db:g,query:u,onChange:R=>$(R,!1),queryRowFilter:h,onValidate:l,range:d}),u.editorMode===j.lX.Code&&(0,e.jsx)(Ae,{db:g,query:u,queryToValidate:b,onChange:$,onRunQuery:s,onValidate:l,range:d})]})}const yt=t=>!!t.rawSql},6904:(U,M,o)=>{o.d(M,{X:()=>j});var e=o(22803),c=o(96540),S=o(63142);const j=({children:T})=>{const w=(0,S.of)(B);return c.createElement("div",{className:w.root},T)},B=T=>({root:(0,e.css)({display:"flex",flexWrap:"wrap",alignItems:"center",gap:T.spacing(3),minHeight:T.spacing(4)})})},26774:(U,M,o)=>{o.d(M,{o:()=>j});var e=o(45861),c=o(96540),S=o(46936);const j=c.forwardRef(function({items:T,renderItem:w,onChange:L},I){const r=()=>{const A=[...T,{}];L(A)},V=(A,D)=>{const P=[...T];P[A]=D,L(P)},z=A=>{const D=[...T];D.splice(A,1),L(D)};return c.createElement(S.C,null,T.map((A,D)=>c.createElement("div",{key:D},w(A,P=>V(D,P),()=>z(D)))),c.createElement(e.$n,{ref:I,onClick:r,variant:"secondary",size:"md",icon:"plus","aria-label":"Add",type:"button"}))})},32300:(U,M,o)=>{o.d(M,{U:()=>B});var e=o(22803),c=o(96540),S=o(63142),j=o(46936);const B=({children:w})=>{const L=(0,S.of)(T);return c.createElement("div",{className:L.root},c.createElement(j.C,{gap:2},w))},T=w=>({root:(0,e.css)({padding:w.spacing(1),backgroundColor:w.colors.background.secondary,borderRadius:w.shape.radius.default})})},1667:(U,M,o)=>{o.d(M,{D:()=>S});var e=o(96540),c=o(46936);const S=({children:j})=>e.createElement(c.C,{gap:.5,direction:"column"},j)},46936:(U,M,o)=>{o.d(M,{C:()=>S});var e=o(96540),c=o(41654);const S=({children:j,wrap:B=!0,...T})=>{var w,L;return e.createElement(c.B,{wrap:B?"wrap":void 0,direction:(w=T.direction)!=null?w:"row",gap:(L=T.gap)!=null?L:2,...T},j)}},40263:(U,M,o)=>{o.d(M,{Z:()=>c});var e=o(96540);const c=({grow:S,shrink:j})=>e.createElement("div",{style:{display:"block",flexGrow:S,flexShrink:j}})},75686:(U,M,o)=>{o.d(M,{W:()=>T});var e=o(22803),c=o(96540),S=o(63142),j=o(18857),B=o(73744);function T({label:r,...V}){const[z]=(0,c.useState)(()=>Math.random().toString(16).slice(2)),A=(0,S.of)(I),D={SelectContainer:w,ValueContainer:L,SingleValue:L};return c.createElement("div",{className:A.root},r&&c.createElement("label",{className:A.label,htmlFor:z},r,":","\xA0"),c.createElement(j.l6,{openMenuOnFocus:!0,inputId:z,...V,components:D}))}const w=r=>{const{children:V}=r,z=(0,S.of)(I);return c.createElement(B.K,{...r,className:(0,e.cx)(r.className,z.container)},V)},L=r=>{const{className:V,children:z}=r,A=(0,S.of)(I);return c.createElement("div",{className:(0,e.cx)(V,A.valueContainer)},z)},I=r=>({root:(0,e.css)({display:"flex",fontSize:12,alignItems:"center"}),label:(0,e.css)({color:r.colors.text.secondary,whiteSpace:"nowrap"}),container:(0,e.css)({background:"none",borderColor:"transparent"}),valueContainer:(0,e.css)({display:"flex",alignItems:"center",flex:"initial",color:r.colors.text.secondary,fontSize:12})})},72500:(U,M,o)=>{o.d(M,{M:()=>j});var e=o(22803),c=o(63142),S=o(96540);const j=({children:w})=>{const L=(0,c.of)(T),I=S.Children.map(w,r=>(0,S.isValidElement)(r)&&r.props.invalid?(0,S.cloneElement)(r,{className:(0,e.cx)(r.props.className,L.invalidChild)}):r);return S.createElement("div",{className:L.root},I)},B=["","base","hovered","invalid","focused"],T=()=>({root:(0,e.css)({display:"flex","> *":{"&:not(:first-child)":{marginLeft:-1},"&:first-child":{borderTopRightRadius:0,borderBottomRightRadius:0},"&:last-child":{borderTopLeftRadius:0,borderBottomLeftRadius:0},"&:not(:first-child):not(:last-child)":{borderRadius:0},position:"relative",zIndex:B.indexOf("base"),"&:hover":{zIndex:B.indexOf("hovered")},"&:focus-within":{zIndex:B.indexOf("focused")}}}),invalidChild:(0,e.css)({zIndex:B.indexOf("invalid")})})}}]);

//# sourceMappingURL=sql-query-editor.cf26b9a896fd75adbc59.js.map