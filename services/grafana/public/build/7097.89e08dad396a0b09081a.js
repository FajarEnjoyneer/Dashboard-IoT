"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[7097],{87097:(ae,O,s)=>{s.d(O,{A:()=>Ye});var e=s(74848),l=s(96540),D=s(71468),n=s(92745),v=s(41654),U=s(17159),V=s(2989),x=s(73427),F=s(42939),G=s(8354),L=s(52045),i=s(22803),$=s(2543),se=s(6370),X=s(68143),M=s(63142),Z=s(31286),ne=s(89599),_=s(45967),k=s(30703),Y=s(34999),q=s(66404),de=s(89640),w=s(45861),ue=s(12737),me=s(77418),d=s(69788),m=s(49785),J=s(37386),z=s(63527),he=s(81971),Ae=s(54078),Ee=s(77236),fe=s(65642);const et="X-Prom-Label-Policy";function Be(a){let r=["loki"];return fe.$W.featureToggles.teamHttpHeadersMimir&&r.push("prometheus"),fe.$W.featureToggles.teamHttpHeadersTempo&&r.push("tempo"),!!a.basicAuth&&r.includes(a.type)}function ye(a){const o=/\{([^{}]*)\}/.exec(a);return o&&o.length>1?o[1].trim():""}function be(a){const o=/\{{0,1}([^\{\}]*)\}{0,1}/.exec(a);return o&&o.length>1?`{ ${o[1].trim()} }`:""}function tt(a){const o=/\w+\:\{{0,1}([^\{\}]*)\}{0,1}/.exec(a);return o&&o.length>1?o[1].trim():""}const ge=a=>{if(!a)return!1;const r=a.trim().replace(/^{|}$/g,"");return/^\s*(?:\s*\w+\s*(?:=|!=|=~|!~)\s*\"[^\"]+\"\s*,*)+\s*$/.test(r)},Te=a=>{const r=[];return a.length&&a.forEach(o=>{o.teamUid&&r.push(o.teamUid)}),r},De=(a,r)=>{const o=(0,n.t)("access-control.permissions.lbac-warning-team","Warning: This team has full data access if no LBAC rules are set.");return r.map(c=>{if(c.builtInRole&&c.permission!=="Admin"){const f=(0,n.t)("access-control.permissions.lbac-warning-basic-role",`Warning: ${c.builtInRole} may have full data access if permission is not removed.`);c.warning=f}else c.teamUid&&!a.includes(c.teamUid)&&(c.warning=o);return{...c}})},at=(a,r)=>{const o=t("access-control.permissions.lbac-warning-rule","Warning: This team might not have permission to the query the datasource.");return r.map(c=>(c.teamUid&&!a.includes(c.teamUid)&&(c.warning=o),{...c}))},pe=({isEditing:a,value:r,disabled:o,error:c,onChange:f})=>{const[C,y]=(0,l.useState)(ye(r)),B=(0,M.$j)(),P=(0,M.of)(Le);return(0,l.useEffect)(()=>{a||y(ye(r))},[a,r]),(0,e.jsx)("div",{className:P.wrapper,children:a?(0,e.jsx)(e.Fragment,{children:(0,e.jsx)(z.p,{className:P.input,value:C,onChange:g=>{const A=g.currentTarget.value;y(A),f&&f(`{ ${A} }`)},invalid:!!c,suffix:c&&(0,e.jsx)(_.m,{content:c,children:(0,e.jsx)(k.I,{name:"exclamation-triangle"})})})}):(0,e.jsx)("span",{style:{color:o?B.colors.text.disabled:"unset"},children:r&&r.trim()?(0,e.jsx)(Ae.Z,{query:r,language:{grammar:Ee.Ay,name:"logql"}}):(0,e.jsx)("span",{className:P.emptyValue,children:(0,e.jsx)(n.x6,{i18nKey:"team-lbac.editable-cell.empty-rule",children:"Empty rule"})})})})},Le=a=>({wrapper:(0,i.css)({padding:a.spacing(0,1)}),input:(0,i.css)({"& input":{fontFamily:a.typography.fontFamilyMonospace}}),emptyValue:(0,i.css)({fontStyle:"italic",color:a.colors.text.secondary})}),Pe=({onSubmit:a})=>{const r=(0,M.of)(Re),{handleSubmit:o,register:c,control:f,watch:C,formState:{errors:y}}=(0,m.mN)({mode:"onChange"}),B=C("teamUid"),P=C("rule"),g=()=>B?.length>0&&ge(P);return(0,e.jsxs)("div",{className:r.container,children:[(0,e.jsx)("h5",{className:r.heading,children:(0,e.jsx)(n.x6,{i18nKey:"team-lbac.create-team-lbacform.new-lbac-rule",children:"New LBAC Rule"})}),(0,e.jsxs)("div",{className:r.example,children:[(0,e.jsx)(n.x6,{i18nKey:"team-lbac.create-team-lbacform.new-lbac-rule-example",children:"Example:"}),(0,e.jsx)(pe,{value:'{ cluster="us-west-0", namespace=~"dev|prod" }',disabled:!0})]}),(0,e.jsx)("form",{id:"lbacForm",onSubmit:o(a),className:r.form,children:(0,e.jsxs)(v.B,{gap:2,direction:"column",children:[(0,e.jsx)(J.D,{label:(0,n.t)("team-lbac.create-team-lbacform.label-team","Team"),children:(0,e.jsx)(m.xI,{render:({field:{onChange:A,ref:S,...W}})=>(0,e.jsx)(he.e,{...W,onSelected:h=>A(h.value?.uid),className:r.teamPicker}),control:f,name:"teamUid",rules:{required:{value:!0,message:(0,n.t)("teamLBAC.create-team-lbacform.message.required","Required")}}})}),(0,e.jsx)(J.D,{label:(0,n.t)("team-lbac.create-team-lbacform.label-rule","Rule"),invalid:!!y.rule,error:y?.rule?.message,children:(0,e.jsx)(z.p,{className:r.input,type:"text",...c("rule",{required:"Rule is required",validate:A=>ge(A)||"Invalid LBAC rule syntax"}),placeholder:'{ cluster="us-west-0", namespace=~"dev|prod" }',invalid:!!y.rule})}),(0,e.jsx)("div",{className:r.buttonContainer,children:(0,e.jsx)(w.$n,{type:"submit",disabled:!g(),children:(0,e.jsx)(n.x6,{i18nKey:"team-lbac.create-team-lbacform.save",children:"Save"})})})]})})]})},Re=a=>({container:(0,i.css)({padding:a.spacing(2)}),heading:(0,i.css)({color:a.colors.text.primary,margin:`0 0 ${a.spacing(2)} 0`,fontSize:a.typography.h5.fontSize}),example:(0,i.css)({marginBottom:a.spacing(2),color:a.colors.text.secondary,fontSize:a.typography.size.sm}),form:(0,i.css)({display:"flex",flexDirection:"column",gap:a.spacing(2),width:"100%",maxWidth:"500px"}),input:(0,i.css)({width:"100%","& input":{fontFamily:a.typography.fontFamilyMonospace,width:"100%"}}),teamPicker:(0,i.css)({width:"100%"}),buttonContainer:(0,i.css)({display:"flex",justifyContent:"flex-end",marginTop:a.spacing(2)})});var oe=s(76319),je=s(44458),Oe=s(71555);const Me=({team:a,disabled:r,warning:o})=>{const c=(0,M.of)(Ie);if(!a)return(0,e.jsx)(e.Fragment,{});if(!a.name&&!a.avatarUrl){const f=a.id;return(0,e.jsx)("span",{className:c.notFound,children:(0,e.jsxs)(n.x6,{i18nKey:"team-lbac.team-label.placeholder",children:["Team with id ",{teamId:f}," not found"]})})}return(0,e.jsxs)("div",{className:c.wrapper,children:[a.avatarUrl&&(0,e.jsx)(Oe.e,{src:a.avatarUrl,alt:""}),(0,e.jsx)("span",{className:(0,i.cx)(c.label,{[c.disabled]:r}),children:a.name}),o&&(0,e.jsx)(_.m,{content:(0,e.jsx)(Z.a,{children:o}),children:(0,e.jsx)(k.I,{name:"exclamation-triangle",className:c.warning})})]})},Ie=a=>({wrapper:(0,i.css)({display:"flex",alignItems:"center"}),label:(0,i.css)({overflow:"hidden",marginLeft:a.spacing(2),marginRight:a.spacing(2)}),avatar:(0,i.css)({width:"24px",height:"24px"}),notFound:(0,i.css)({color:a.colors.text.secondary}),disabled:(0,i.css)({color:a.colors.text.disabled}),warning:(0,i.css)({color:a.colors.warning.main})}),Ue=({teamRules:a,team:r,disabled:o,onChange:c,warning:f})=>{const[C,y]=(0,l.useState)({}),[B,P]=(0,l.useState)({}),[g,A]=(0,l.useState)(a),[S,W]=(0,l.useState)({}),h=(0,M.of)(we);if((0,l.useEffect)(()=>{A(a)},[a]),!a?.length)return null;const H=(b,p)=>{P({...B,[b]:p?g[b]:void 0}),y({...C,[b]:p})},Q=(b,p)=>{P({...B,[b]:p})},le=b=>{const p=B[b];if(p){if(!ge(p)){W({...S,[b]:"Invalid LBAC rule syntax"});return}const re=g.map((ce,xe)=>xe===b&&p?p:ce);c(re),y({...C,[b]:!1})}},R=b=>{const p=g.slice(0,b).concat(g.slice(b+1));c(p)},K=()=>{y({...C,[g.length]:!0}),A(g.concat(""))},ee=b=>{H(b,!1),b===g.length-1&&!g[b]&&A(g.slice(0,-1))};return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsxs)("tr",{role:"row",children:[(0,e.jsx)("td",{children:(0,e.jsx)(Me,{team:r,warning:f})}),(0,e.jsx)("td",{}),(0,e.jsx)("td",{children:(0,e.jsx)(pe,{value:g[0],isEditing:C[0],error:S[0],onChange:b=>Q(0,b)})}),(0,e.jsx)("td",{children:o?(0,e.jsx)("div",{className:h.buttonsCell,children:(0,e.jsx)(w.$n,{tooltip:(0,n.t)("team-lbac.team-rules-row.tooltip-provisioned-rule","Provisioned rule"),size:"sm",icon:"lock"})}):(0,e.jsxs)("div",{className:h.buttonsCell,children:[g?.length===1&&!C[0]&&(0,e.jsx)("div",{className:h.buttonRight,children:(0,e.jsx)(oe.K,{name:"plus-circle",tooltip:(0,n.t)("team-lbac.team-rules-row.tooltip-add-new-rule","Add new rule"),"aria-label":(0,n.t)("team-lbac.team-rules-row.aria-label-add-team-rule","add team rule"),onClick:()=>K()})}),C[0]?(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)("div",{className:h.editButton,children:(0,e.jsx)(w.$n,{size:"sm",variant:"primary",onClick:()=>le(0),children:(0,e.jsx)(n.x6,{i18nKey:"team-lbac.team-rules-row.save",children:"Save"})})}),(0,e.jsx)("div",{className:h.editButton,children:(0,e.jsx)(w.$n,{size:"sm",variant:"secondary",onClick:()=>ee(0),children:(0,e.jsx)(n.x6,{i18nKey:"team-lbac.team-rules-row.cancel",children:"Cancel"})})})]}):(0,e.jsx)("div",{className:h.editButton,children:(0,e.jsx)(oe.K,{name:"pen","aria-label":(0,n.t)("team-lbac.team-rules-row.aria-label-edit-team-rule","edit team rule"),onClick:()=>H(0,!0)})}),(0,e.jsx)("div",{className:h.buttonRight,children:(0,e.jsx)(je.e,{"aria-label":(0,n.t)("team-lbac.team-rules-row.aria-label-delete-rule","Delete rule"),size:"sm",onConfirm:()=>R(0)})})]})})]},`${r.uid}-0`),g.length>1&&g.slice(1).map((b,p)=>(0,e.jsxs)("tr",{role:"row",children:[(0,e.jsx)("td",{}),(0,e.jsx)("td",{className:h.ruleOr,children:(0,e.jsx)(n.x6,{i18nKey:"team-lbac.team-rules-row.or",children:"OR"})}),(0,e.jsx)("td",{children:(0,e.jsx)(pe,{value:b,isEditing:C[p+1],error:S[p+1],onChange:re=>Q(p+1,re)})}),(0,e.jsx)("td",{children:o?(0,e.jsx)("div",{className:h.buttonsCell,children:(0,e.jsx)(w.$n,{tooltip:(0,n.t)("team-lbac.team-rules-row.tooltip-provisioned-rule","Provisioned rule"),size:"sm",icon:"lock"})}):(0,e.jsxs)("div",{className:h.buttonsCell,children:[p===g?.length-2&&!C[p+1]&&(0,e.jsx)("div",{className:h.buttonRight,children:(0,e.jsx)(oe.K,{name:"plus-circle",tooltip:(0,n.t)("team-lbac.team-rules-row.tooltip-add-new-rule","Add new rule"),"aria-label":(0,n.t)("team-lbac.team-rules-row.aria-label-add-team-rule","add team rule"),onClick:()=>K()})}),C[p+1]?(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)("div",{className:h.editButton,children:(0,e.jsx)(w.$n,{size:"sm",variant:"primary",onClick:()=>le(p+1),children:(0,e.jsx)(n.x6,{i18nKey:"team-lbac.team-rules-row.save",children:"Save"})})}),(0,e.jsx)("div",{className:h.editButton,children:(0,e.jsx)(w.$n,{size:"sm",variant:"secondary",onClick:()=>ee(p+1),children:(0,e.jsx)(n.x6,{i18nKey:"team-lbac.team-rules-row.cancel",children:"Cancel"})})})]}):(0,e.jsx)("div",{className:h.editButton,children:(0,e.jsx)(oe.K,{name:"pen","aria-label":(0,n.t)("team-lbac.team-rules-row.aria-label-edit-team-rule","edit team rule"),onClick:()=>H(p+1,!0)})}),(0,e.jsx)("div",{className:h.buttonRight,children:(0,e.jsx)(je.e,{"aria-label":(0,n.t)("team-lbac.team-rules-row.aria-label-delete-rule","Delete rule"),size:"sm",onConfirm:()=>R(p+1)})})]})})]},`${r.uid}-${p+1}`))]})},we=a=>({editButton:(0,i.css)({display:"flex",alignItems:"center",marginLeft:a.spacing(2)}),buttonRight:(0,i.css)({display:"flex",alignItems:"center",marginLeft:a.spacing(2),marginRight:a.spacing(.5)}),buttonsCell:(0,i.css)({display:"flex",justifyContent:"end",alignItems:"center"}),ruleOr:(0,i.css)({color:a.colors.text.secondary})});function We({teamLBACRules:a,teams:r}){const[o,c]=(0,l.useState)(""),[f,C]=(0,l.useState)("asc"),y=(0,l.useMemo)(()=>new Map(r.map(S=>[S.uid,S.name??""])),[r]),B=(0,l.useMemo)(()=>f==="asc"?(0,n.t)("team-lbac.team-lbaceditor-unconnected.sort-teams-ascending","Sort teams A-Z"):(0,n.t)("team-lbac.team-lbaceditor-unconnected.sort-teams-descending","Sort teams Z-A"),[f]),P=(0,l.useMemo)(()=>{const S=[...a].sort((W,h)=>{const H=y.get(W.teamUid)||"",Q=y.get(h.teamUid)||"";return f==="asc"?H.localeCompare(Q):Q.localeCompare(H)});return o?S.filter(W=>(y.get(W.teamUid)||"").toLowerCase().includes(o.toLowerCase())):S},[a,y,o,f]),g=(0,l.useCallback)(()=>{C(f==="asc"?"desc":"asc")},[f]),A=(0,l.useCallback)(()=>{c("")},[]);return{filterQuery:o,setFilterQuery:c,sortOrder:f,toggleSortOrder:g,sortIconTooltip:B,sortedAndFilteredRules:P,clearFilter:A}}var Ke=s(58120);function ve(a){return async r=>{const o=await(0,X.AI)().get(`api/datasources/uid/${a}/lbac/teams`);r((0,Ke.Tg)(o))}}function Ne(a,r){return async o=>{await(0,X.AI)().put(`api/datasources/uid/${a}/lbac/teams`,{...r}),o(ve(a))}}function Fe(a){return{teamLBACConfig:a.teamLBAC?.teamLBACConfig}}const $e={getTeamLBAC:ve,updateTeamLBACRules:Ne},ze=(0,D.connect)(Fe,$e),He=({teamLBACConfig:a,dataSourceConfig:r,readOnly:o,onTeamLBACUpdate:c,getTeamLBAC:f,updateTeamLBACRules:C,items:y})=>{const[B,P]=(0,l.useState)([]),[g,A]=(0,l.useState)(!1),[S,W]=(0,l.useState)(new Set),[h,H]=(0,l.useState)(new Set),[Q,le]=(0,l.useState)(new Set),R=(0,l.useMemo)(()=>a?.rules||[],[a?.rules]),K=(0,M.of)(Qe),[ee,b]=(0,l.useState)(!1),{filterQuery:p,setFilterQuery:re,sortOrder:ce,toggleSortOrder:xe,sortIconTooltip:Je,sortedAndFilteredRules:ie,clearFilter:Xe}=We({teamLBACRules:R,teams:B});(0,l.useEffect)(()=>{f(r.uid)},[r.uid,f]),(0,l.useEffect)(()=>{(async()=>{const E=R.map(te=>te.teamUid).filter(Boolean);if(![...new Set(E)]?.length)return;const j=((await(0,X.AI)().get("/api/teams/search",{teamUid:E}))?.teams).map(te=>({id:te.id,uid:te.uid,value:te.id,name:te.name,avatarUrl:te.avatarUrl}));P(j)})()},[R]),(0,l.useEffect)(()=>{if(!y?.length)return;const u=new Set(R.map(j=>j.teamUid)),E=new Set(y.map(j=>j.teamUid)),T=new Set(y.filter(j=>typeof j.builtInRole=="string"&&j.builtInRole.trim()!==""&&j.permission!=="Admin").map(j=>j.builtInRole)),N=new Set(Array.from(E).filter(j=>j!==void 0&&!u.has(j.toString())).map(j=>j?.toString()||"")),I=new Set(Array.from(u).filter(j=>j&&!E.has(j.toString())));I&&le(I),N&&H(N),T&&W(T)},[y,R]);const Ce=(0,l.useCallback)(async u=>{await C(r.uid,{rules:u}),await c()},[r.uid,c,C]),_e=async({teamUid:u,rule:E})=>{let T=[];R.find(I=>I.teamUid===u.toString())?T=R.map(I=>I.teamUid===u.toString()?{...I,rules:[...I.rules,be(E)]}:{...I}):T=R.concat({teamUid:u.toString(),rules:[be(E)]}),await Ce(T),A(!1)},ke=async(u,E)=>{const T=R.map(N=>N.teamUid===u?{...N,rules:E}:N);await Ce(T)},Se=x.TP.hasPermission(d.AccessControlAction.DataSourcesPermissionsWrite)&&!o,qe=u=>{if(u.userId)return u.userLogin;if(u.teamId)return u.team;if(u.builtInRole)return u.builtInRole};return(0,e.jsxs)(Z.a,{paddingBottom:2,children:[o&&(0,e.jsx)(me.r,{}),(0,e.jsxs)(v.B,{direction:"column",gap:3,children:[(0,e.jsxs)(se.A,{title:(0,n.t)("team-lbac.team-lbaceditor-unconnected.title-data-access","Data access"),description:(0,n.t)("team-lbac.team-lbaceditor-unconnected.description-data-access","Here you can configure access to specific data within the datasource using LogQL label selectors."),children:[(Q.size>0||h.size>0||S.size>0)&&R.length>0&&(0,e.jsxs)(Z.a,{marginBottom:3,children:[(0,e.jsx)(ne.S,{label:ee?(0,n.t)("team-lbac.team-lbaceditor-unconnected.hide-access-control-recommendations","Hide Access Control Recommendations"):(0,e.jsxs)(v.B,{direction:"row",alignItems:"center",gap:1,children:[(0,e.jsx)(_.m,{content:(0,n.t)("team-lbac.team-lbaceditor-unconnected.content-found-recommendation","Found recommendations"),children:(0,e.jsx)(k.I,{name:"exclamation-triangle",className:K.warning})}),(0,e.jsx)(n.x6,{i18nKey:"team-lbac.team-lbaceditor-unconnected.show-access-control-recommendations",children:"Show Access Control Recommendations"})]}),isOpen:ee,onToggle:()=>b(!ee)}),ee&&(0,e.jsxs)(Y.F,{title:(0,n.t)("team-lbac.team-lbaceditor-unconnected.title-access-control-recommendations","Access Control Recommendations"),severity:"warning",children:[(0,e.jsx)("p",{children:(0,e.jsx)(n.x6,{i18nKey:"team-lbac.team-lbaceditor-unconnected.ensure-proper-access-control-please-follow",children:"To ensure proper access control, please follow these recommendations:"})}),(0,e.jsxs)("ul",{className:K.warningList,children:[Q.size>0&&(0,e.jsxs)("li",{children:[(0,e.jsxs)(n.x6,{i18nKey:"team-lbac.team-lbaceditor-unconnected.add-query-permissions",children:[(0,e.jsx)("strong",{children:"Add Query Permissions:"})," The following teams do not have query permissions for the data source, and are therefore not able to query logs with the configured LBAC rules."]}),(0,e.jsx)("ul",{children:Array.from(Q).map(u=>{const E=B?.find(T=>T.uid?.toString()===u)?.name;return(0,e.jsx)("li",{className:K.warningList,children:E},u)})})]}),h.size>0&&(0,e.jsxs)("li",{children:[(0,e.jsxs)(n.x6,{i18nKey:"team-lbac.team-lbaceditor-unconnected.add-team-lbac-rules",children:[(0,e.jsx)("strong",{children:"Add Team LBAC Rules:"})," The following teams can query all logs. Please add Team LBAC rules for them:"]}),(0,e.jsx)("ul",{children:Array.from(h).map(u=>{const E=y?.find(T=>T.teamUid?.toString()===u);return E?(0,e.jsx)("li",{className:K.warningList,children:qe(E)},u):null})})]}),S.size>0&&(0,e.jsxs)("li",{children:[(0,e.jsxs)(n.x6,{i18nKey:"team-lbac.team-lbaceditor-unconnected.remove-unrestricted-access",children:[(0,e.jsx)("strong",{children:"Remove Unrestricted Access:"})," The following roles currently have unrestricted access to logs."]}),(0,e.jsx)("ul",{children:Array.from(S).map(u=>(0,e.jsx)("li",{className:K.warningList,children:(0,n.t)("team-lbac.team-lbaceditor-unconnected.role-warning-list","Role: {{role}}",{role:u})},u))})]})]})]})]}),(0,e.jsxs)(v.B,{direction:"column",gap:2,children:[(0,e.jsxs)(v.B,{direction:"column",children:[(0,e.jsx)(q.E,{variant:"h4",children:(0,e.jsx)(n.x6,{i18nKey:"team-lbac.team-lbaceditor-unconnected.lbac-labelbased-access-control",children:"LBAC (Label-based access control)"})}),(0,e.jsxs)(v.B,{alignItems:{xs:"flex-start",md:"center"},direction:{xs:"column",md:"row"},children:[(0,e.jsx)(q.E,{variant:"bodySmall",color:"secondary",children:(0,e.jsx)(n.x6,{i18nKey:"team-lbac.team-lbaceditor-unconnected.lbac-description",children:"Configure LBAC rules to restrict access for specific metrics/logs."})}),(0,e.jsx)(de.Y,{variant:"bodySmall",external:!0,href:"https://grafana.com/docs/grafana/latest/administration/data-source-management/teamlbac/create-teamlbac-rules/#lbac-rule",children:(0,e.jsx)(n.x6,{i18nKey:"team-lbac.team-lbaceditor-unconnected.learn-more-about-lbac-rules",children:"Learn more about LBAC rules"})})]})]}),Se&&(0,e.jsxs)(v.B,{direction:{xs:"column-reverse",md:"row"},alignItems:"flex-start",gap:2,children:[(0,e.jsx)(w.z9,{onClick:()=>A(!g),icon:g?"angle-down":"plus","aria-expanded":g,children:g?(0,n.t)("team-lbac.team-lbaceditor-unconnected.hide-lbac-rule","Hide LBAC rule"):(0,n.t)("team-lbac.team-lbaceditor-unconnected.add-a-lbac-rule","Add a LBAC rule")}),!(0,$.isEmpty)(R)&&(0,e.jsx)(ue.Z,{placeholder:(0,n.t)("team-lbac.team-lbaceditor-unconnected.filter-teams-placeholder","Filter teams"),value:p,onChange:re,width:30,escapeRegex:!1,"aria-label":(0,n.t)("team-lbac.team-lbaceditor-unconnected.filter-teams-aria-label","Filter LBAC rules by team name")}),g&&(0,e.jsx)(Z.a,{marginTop:2,children:(0,e.jsx)(Pe,{onSubmit:_e})})]})]})]}),!(0,$.isEmpty)(ie)&&(0,e.jsxs)("div",{className:K.tableContainer,children:[!(0,$.isEmpty)(p)&&(0,e.jsx)(Z.a,{marginBottom:2,children:(0,e.jsxs)(q.E,{variant:"bodySmall",children:[ie.length===1?(0,n.t)("team-lbac.team-lbaceditor-unconnected.filter-results-single","Showing 1 result"):(0,n.t)("team-lbac.team-lbaceditor-unconnected.filter-results-multiple","Showing {{count}} results",{count:ie.length}),(0,e.jsx)(w.$n,{onClick:Xe,fill:"text",size:"sm",icon:"times",variant:"secondary","aria-label":(0,n.t)("team-lbac.team-lbaceditor-unconnected.clear-filter-aria-label","Clear filter"),children:(0,n.t)("team-lbac.team-lbaceditor-unconnected.clear-filter","Clear")})]})}),(0,e.jsxs)("table",{className:K.table,role:"grid","aria-labelledby":"team_lbac_rules",children:[(0,e.jsx)("thead",{children:(0,e.jsxs)("tr",{children:[(0,e.jsx)("th",{style:{width:"30%"},className:K.sortableHeader,onClick:xe,"aria-sort":ce==="asc"?"ascending":"descending",children:(0,e.jsxs)(v.B,{direction:"row",alignItems:"center",gap:1,children:[(0,e.jsx)(n.x6,{i18nKey:"team-lbac.team-lbaceditor-unconnected.team",children:"Team"}),(0,e.jsx)(_.m,{content:Je,children:(0,e.jsx)(k.I,{name:ce==="asc"?"angle-up":"angle-down","aria-hidden":"true"})})]})}),(0,e.jsx)("th",{style:{width:"1%"}}),(0,e.jsx)("th",{children:(0,e.jsx)(n.x6,{i18nKey:"team-lbac.team-lbaceditor-unconnected.label-selector",children:"Label selector"})}),(0,e.jsx)("th",{style:{width:"1%"}})]})}),(0,e.jsx)("tbody",{children:ie.map((u,E)=>{const T=u.rules,N=u.teamUid;let I="";return Q.has(N)&&(I="Warning: This team may not have permission to query the datasource."),(0,e.jsx)(Ue,{teamRules:T,disabled:!Se,team:B.find(j=>j.uid===u.teamUid)||{name:"",avatarUrl:"",uid:""},onChange:j=>ke(N,j),warning:I},E)})})]}),(0,e.jsx)(Z.a,{marginTop:2,children:(0,e.jsx)(q.E,{variant:"bodySmall",color:"secondary",children:(0,e.jsxs)(n.x6,{i18nKey:"team-lbac.team-lbaceditor-unconnected.lbac-rules-note",children:["Note:",(0,e.jsx)("br",{}),"- LBAC rules will NOT apply to the query if the authenticated Cloud Access Policy token has any label selectors configured in Grafana Cloud.",(0,e.jsx)("br",{}),"- Changes to LBAC rules may take up to 5 minutes to be reflected due to query path caching."]})})})]})]})]})},Qe=a=>({warning:(0,i.css)({...a.typography.bodySmall,color:a.colors.warning.text}),warningList:(0,i.css)({...a.typography.bodySmall,listStylePosition:"inside",marginLeft:a.spacing(2)}),table:(0,i.css)({...a.typography.bodySmall,width:"100%",borderCollapse:"collapse","& th, & td":{padding:a.spacing(2),borderBottom:`1px solid ${a.colors.border.weak}`},"& th":{textAlign:"left",fontWeight:a.typography.fontWeightMedium}}),sortableHeader:(0,i.css)({cursor:"pointer","&:hover":{color:a.colors.text.link}}),tableContainer:(0,i.css)({overflowX:"auto"})}),Ve=ze(He);function Ge(a,r){const{uid:o}=r;return{resourceId:o,dataSourceConfig:a.dataSources.dataSource,teamLBACConfig:a.teamLBAC?.teamLBACConfig}}const Ze={loadDataSource:G.ak,loadDataSourceMeta:G.xI,updateDataSource:G.jB},Ye=(0,D.connect)(Ge,Ze)(({resourceId:a,dataSourceConfig:r,teamLBACConfig:o,loadDataSource:c,loadDataSourceMeta:f,updateDataSource:C})=>{(0,l.useEffect)(()=>{c(a)},[a,c]);const y=x.TP.hasPermissionInMetadata(d.AccessControlAction.DataSourcesPermissionsWrite,r);(0,l.useEffect)(()=>{c(a).then(f)},[c,f,a]);const B=()=>{c(a)},P=()=>h=>{if(!S||!o?.rules?.length)return h;const H=Te(o?.rules);return De(H,h)},{readOnly:g,hasWriteRights:A}=(0,L.u1)(r.uid),S=Be(r),W=g||!y||!A;return(0,e.jsxs)(v.B,{direction:"column",gap:2,children:[(0,F.z5)()&&(0,e.jsx)(V.Iz,{featureId:"data-source-permissions",eventVariant:"trial",featureName:"data source permissions",text:(0,n.t)("permissions.data-source-permissions.text-enable-source-permissions-during-trial-grafana","Enable data source permissions for free during your trial of Grafana Pro.")}),(0,e.jsx)(U.x,{resource:"datasources",resourceId:a,canSetPermissions:y,getWarnings:S?P():void 0,epilogue:S?h=>(0,e.jsx)(Ve,{dataSourceConfig:r,readOnly:W,onTeamLBACUpdate:B,items:h}):void 0})]})})},77418:(ae,O,s)=>{s.d(O,{r:()=>U});var e=s(74848),l=s(51898),D=s(92745),n=s(34999);const v="This data source was added by config and cannot be modified using the UI. Please contact your server admin to update this data source.";function U(){return(0,e.jsx)(n.F,{"data-testid":l.Tp.pages.DataSource.readOnly,severity:"info",title:(0,D.t)("datasources.data-source-read-only-message.title-provisioned-data-source","Provisioned data source"),children:v})}},52045:(ae,O,s)=>{s.d(O,{$k:()=>Y,BY:()=>X,S4:()=>w,Tn:()=>de,US:()=>M,Um:()=>_,_e:()=>ue,hx:()=>ne,k9:()=>k,oU:()=>se,u1:()=>me,xw:()=>q});var e=s(96540),l=s(92745),D=s(20018),n=s(45229),v=s(73427),U=s(11257),V=s(87745),x=s(52763),F=s(26437),G=s(62054),L=s(8354),i=s(18548),$=s(64003);const se=d=>{const m=(0,x.wA)();(0,e.useEffect)(()=>(m((0,L.PK)(d)),function(){m((0,D.N)({cleanupAction:z=>z.dataSourceSettings=i.IJ}))}),[d,m])},X=d=>{const m=(0,x.wA)();return()=>m((0,L.Ge)(d,F.b.DataSourcesEdit))},M=()=>{const d=(0,x.wA)(),m=(0,x.d4)(z=>z.dataSources.isLoadingDataSources),J=(0,x.d4)(z=>z.dataSources.dataSources);return(0,e.useEffect)(()=>{d((0,L.bn)())},[d]),{isLoading:m,dataSources:J}},Z=d=>{const m=useDispatch();useEffect(()=>{m(loadDataSource(d))},[m,d])},ne=()=>{const d=(0,x.wA)();(0,e.useEffect)(()=>{d((0,L.G2)())},[d])},_=()=>{const d=(0,x.wA)();return m=>{d((0,L.du)(m,F.b.DataSourcesEdit))}},k=()=>{const d=(0,x.wA)();return async m=>d((0,L.jB)(m))},Y=()=>{const d=(0,x.wA)(),{name:m}=(0,x.d4)(J=>J.dataSources.dataSource);return()=>{n.A.publish(new V.bY({title:(0,l.t)("datasources.use-delete-loaded-data-source.title.delete","Delete"),text:`Are you sure you want to delete the "${m}" data source?`,yesText:"Delete",icon:"trash-alt",onConfirm:()=>d((0,L.Qq)())}))}},q=d=>(0,x.d4)(m=>(0,$.U4)(m.dataSources,d)),de=d=>{const m=q(d);return(0,G.h)(m)},w=d=>(0,x.d4)(m=>(0,$.Fj)(m.dataSources,d)),ue=()=>(0,x.d4)(d=>d.dataSourceSettings),me=d=>{const m=q(d),J=m.readOnly===!0,z=v.TP.hasPermissionInMetadata(U.w.DataSourcesWrite,m),he=v.TP.hasPermissionInMetadata(U.w.DataSourcesDelete,m);return{readOnly:J,hasWriteRights:z,hasDeleteRights:he}}},62054:(ae,O,s)=>{s.d(O,{h:()=>D});var e=s(83175),l=s(92138);const D=n=>{const v=JSON.stringify({datasource:n.name,context:"explore"});return e.kM.renderUrl(l.I.assureBaseUrl("/explore"),{left:v})}},6370:(ae,O,s)=>{s.d(O,{A:()=>D});var e=s(96540),l=s(88941);const D=({children:n,...v})=>e.createElement(l.x,{...v,kind:"section"},n)},88941:(ae,O,s)=>{s.d(O,{x:()=>v});var e=s(96540),l=s(22803),D=s(63142),n=s(76319);const v=({children:U,title:V,description:x,isCollapsible:F=!1,isInitiallyOpen:G=!0,kind:L="section",className:i})=>{const{colors:$,typography:se,spacing:X}=(0,D.$j)(),[M,Z]=(0,e.useState)(F?G:!0),ne=M?"angle-up":"angle-down",_=L==="sub-section",k=`${M?"Collapse":"Expand"} section ${V}`,Y={header:(0,l.css)({display:"flex",justifyContent:"space-between",alignItems:"center"}),title:(0,l.css)({margin:0}),subtitle:(0,l.css)({margin:0,fontWeight:se.fontWeightRegular}),descriptionText:(0,l.css)({marginTop:X(_?.25:.5),marginBottom:0,...se.bodySmall,color:$.text.secondary}),content:(0,l.css)({marginTop:X(2)})};return e.createElement("div",{className:i},e.createElement("div",{className:Y.header},L==="section"?e.createElement("h3",{className:Y.title},V):e.createElement("h6",{className:Y.subtitle},V),F&&e.createElement(n.K,{name:ne,onClick:()=>Z(!M),type:"button",size:"xl","aria-label":k})),x&&e.createElement("p",{className:Y.descriptionText},x),M&&e.createElement("div",{className:Y.content},U))}},54078:(ae,O,s)=>{s.d(O,{Z:()=>U});var e=s(22803),l=s(28848),D=s(96540),n=s(63704),v=s(63142);function U({query:x,language:F,className:G}){const L=(0,v.$j)(),i=V(L),$=l.highlight(x,F.grammar,F.name);return D.createElement("div",{className:(0,e.cx)(i.editorField,"prism-syntax-highlight",G),"aria-label":"selector",dangerouslySetInnerHTML:{__html:n.sQ.sanitize($)}})}const V=x=>({editorField:(0,e.css)({fontFamily:x.typography.fontFamilyMonospace,fontSize:x.typography.bodySmall.fontSize})})}}]);

//# sourceMappingURL=7097.89e08dad396a0b09081a.js.map