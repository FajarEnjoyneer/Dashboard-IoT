"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[8622],{74572:(Ie,oe,t)=>{t.d(oe,{B:()=>ge});var e=t(74848),p=t(96540),d=t(92745),l=t(36490),le=t(34999),q=t(91984),B=t(97507),U=t(51740),b=t(52161),_=t(22316),T=t(49785),ce=t(37386),de=t(32635);const E=({pathPrefix:F,className:R,readOnly:M=!1})=>{const{register:A}=(0,T.xW)();return(0,e.jsx)("div",{className:R,children:(0,e.jsx)(ce.D,{disabled:M,children:(0,e.jsx)(de.S,{...A(`${F}sendResolved`),label:(0,d.t)("alerting.cloud-common-channel-settings.label-send-resolved","Send resolved"),disabled:M,description:(0,d.t)("alerting.cloud-common-channel-settings.description-whether-notify-about-resolved-alerts","Whether or not to notify about resolved alerts.")})})})};var ee=t(45517);const H=Object.freeze({__id:"",sendResolved:!0,secureSettings:{},settings:{},secureFields:{},type:"email"}),me=U.r.map(F=>({dto:F})),{useGetAlertmanagerConfigurationQuery:J}=q.m,ge=({contactPoint:F,alertManagerSourceName:R,readOnly:M=!1,editMode:A})=>{const{isLoading:ue,data:Q}=J(R),te=(0,b.AL)(R),[ne]=(0,B.Kt)({alertmanager:R}),[fe]=(0,B.Pm)({alertmanager:R}),[he]=(0,p.useMemo)(()=>F?(0,_.Iq)(F,U.r):[void 0,{}],[F]),se=async ie=>{const X=(0,_.QX)(ie,H);try{A&&F?await fe.execute({contactPoint:X,originalName:F.name}):await ne.execute({contactPoint:X}),l.Ny.push("/alerting/notifications")}catch{}},ae=!M&&!te;return(0,e.jsxs)(e.Fragment,{children:[!te&&(0,e.jsx)(le.F,{title:(0,d.t)("alerting.cloud-receiver-form.title-info","Info"),severity:"info",children:(0,e.jsx)(d.x6,{i18nKey:"alerting.cloud-receiver-form.body-info",children:"Note that empty string values will be replaced with global defaults where appropriate."})}),(0,e.jsx)(ee.k,{showDefaultRouteWarning:!ue&&!Q?.alertmanager_config.route,isEditable:ae,isTestable:ae,onSubmit:se,initialValues:he,notifiers:me,alertManagerSourceName:R,defaultItem:H,commonSettingsComponent:E})]})}},75887:(Ie,oe,t)=>{t.d(oe,{a:()=>$e});var e=t(74848),p=t(96540),d=t(92745),l=t(36490),le=t(6975),q=t(34999),B=t(97507),U=t(66056),b=t(52161),_=t(56476),T=t(52763),ce=t(91984),de=t(11018),E=t(22316),ee=t(1972),H=t(6135),me=t(53226),J=t(49785),ge=t(37386),F=t(32635);const R=({pathPrefix:s,className:P,readOnly:V=!1})=>{const{register:n}=(0,J.xW)();return(0,e.jsx)("div",{className:P,children:(0,e.jsx)(ge.D,{children:(0,e.jsx)(F.S,{...n(`${s}disableResolveMessage`),label:(0,d.t)("alerting.grafana-common-channel-settings.label-disable-resolved-message","Disable resolved message"),description:(0,d.t)("alerting.grafana-common-channel-settings.description-disable-resolved-message","Disable the resolve message [OK] that is sent when alerting state returns to false"),disabled:V})})})};var M=t(45517),A=t(22803),ue=t(63142),Q=t(22787),te=t(72636),ne=t(77824),fe=t(45861),he=t(95443),se=t(25471),ae=t(8402),ie=(s=>(s.predefined="Predefined",s.custom="Custom",s))(ie||{});const X=Object.values(ie).map(s=>({label:s,value:s})),je={annotations:[...he.kl],labels:[{key:"",value:""}]},Se=({isOpen:s,onDismiss:P,onTest:V})=>{const[n,i]=(0,p.useState)("Predefined"),m=(0,ue.of)(Oe),N=(0,J.mN)({defaultValues:je,mode:"onBlur"}),K=f=>{if(n==="Custom"){const I={annotations:f.annotations.filter(({key:o,value:x})=>!!o&&!!x).reduce((o,{key:x,value:j})=>({...o,[x]:j}),{}),labels:f.labels.filter(({key:o,value:x})=>!!o&&!!x).reduce((o,{key:x,value:j})=>({...o,[x]:j}),{})};V(I)}else V()};return(0,e.jsxs)(Q.a,{onDismiss:P,isOpen:s,title:(0,d.t)("alerting.test-contact-point-modal.title-test-contact-point","Test contact point"),children:[(0,e.jsxs)("div",{className:m.section,children:[(0,e.jsx)(te.J,{children:(0,e.jsx)(d.x6,{i18nKey:"alerting.test-contact-point-modal.notification-message",children:"Notification message"})}),(0,e.jsx)(ne.z,{options:X,value:n,onChange:f=>i(f)})]}),(0,e.jsx)(J.Op,{...N,children:(0,e.jsxs)("form",{onSubmit:N.handleSubmit(K),children:[n==="Predefined"&&(0,e.jsx)("div",{className:m.section,children:(0,e.jsxs)(d.x6,{i18nKey:"alerting.test-contact-point-modal.predefined-notification-message",children:["You will send a test notification that uses a predefined alert. If you have defined a custom template or message, for better results switch to ",(0,e.jsx)("strong",{children:"custom"})," notification message, from above."]})}),n==="Custom"&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)("div",{className:m.section,children:(0,e.jsx)(d.x6,{i18nKey:"alerting.test-contact-point-modal.custom-notification-message",children:"You will send a test notification that uses the annotations defined below. This is a good option if you use custom templates and messages."})}),(0,e.jsx)("div",{className:m.section,children:(0,e.jsx)(se.A,{})}),(0,e.jsx)("div",{className:m.section,children:(0,e.jsx)(ae.Ay,{})})]}),(0,e.jsx)(Q.a.ButtonRow,{children:(0,e.jsx)(fe.$n,{type:"submit",children:(0,e.jsx)(d.x6,{i18nKey:"alerting.test-contact-point-modal.send-test-notification",children:"Send test notification"})})})]})})]})},Oe=s=>({flexRow:(0,A.css)({display:"flex",flexDirection:"row",alignItems:"flex-start",marginBottom:s.spacing(1)}),section:(0,A.css)({marginBottom:s.spacing(2)})}),ve=Object.freeze({__id:"",secureSettings:{},settings:{},secureFields:{},disableResolveMessage:!1,type:"email"}),{useGrafanaNotifiersQuery:Ne}=ce.m,$e=({contactPoint:s,readOnly:P=!1,editMode:V})=>{const n=(0,T.wA)(),[i]=(0,B.Kt)({alertmanager:b.hY}),[m]=(0,B.Pm)({alertmanager:b.hY}),{onCallNotifierMeta:N,extendOnCallNotifierFeatures:K,extendOnCallReceivers:f,onCallFormValidators:I,isLoadingOnCallIntegration:o,hasOnCallError:x}=(0,me.VY)(),{data:j=[],isLoading:h}=Ne(),[S,L]=(0,p.useState)(),[a,D]=(0,p.useMemo)(()=>!s||h||o?[void 0,{}]:(0,E.Xo)(f(s)),[s,h,f,o]),$=async r=>{const C=(0,E.bB)(r,D,ve);try{V?s&&s.id?await m.execute({contactPoint:C,id:s.id,resourceVersion:s?.metadata?.resourceVersion}):s&&await m.execute({contactPoint:C,originalName:s.name}):await i.execute({contactPoint:C}),l.Ny.push("/alerting/notifications")}catch{}},Y=r=>{L(r)},Z=r=>{if(S){const C=D[S.__id],O=(0,E.qg)(S,ve,"test",C),w={alertManagerSourceName:b.hY,receivers:[{name:"test",grafana_managed_receiver_configs:[O]}],alert:r};n((0,de.bO)(w))}},z=!!((!P||s&&(0,_.Au)(s))&&!s?.provisioned),W=!P;if(h||o)return(0,e.jsx)(le._,{text:(0,d.t)("alerting.grafana-receiver-form.text-loading-notifiers","Loading notifiers...")});const xe=j.map(r=>r.type===H.J4.OnCall?{dto:K(r),meta:N}:{dto:r});return(0,e.jsxs)(e.Fragment,{children:[x&&(0,e.jsx)(q.F,{severity:"error",title:(0,d.t)("alerting.grafana-receiver-form.title-loading-on-call-integration-failed","Loading OnCall integration failed"),children:(0,e.jsx)(d.x6,{i18nKey:"alerting.grafana-receiver-form.body-loading-on-call-integration-failed",children:"Grafana OnCall plugin has been enabled in your Grafana instances but it is not reachable. Please check the plugin configuration"})}),s?.provisioned&&(0,e.jsx)(ee.Yi,{resource:ee.hk.ContactPoint}),(0,e.jsx)(M.k,{contactPointId:s?.id,isEditable:z,isTestable:W,onSubmit:$,initialValues:a,onTestChannel:Y,notifiers:xe,alertManagerSourceName:b.hY,defaultItem:{...ve},commonSettingsComponent:R,customValidators:{[H.J4.OnCall]:I},canManagePermissions:V&&s&&(0,U.T8)(b.hY,s)}),(0,e.jsx)(Se,{onDismiss:()=>L(void 0),isOpen:!!S,onTest:r=>Z(r)})]})}},45517:(Ie,oe,t)=>{t.d(oe,{k:()=>s});var e=t(74848),p=t(22803),d=t(49785),l=t(92745),le=t(68143),q=t(63142),B=t(34999),U=t(41654),b=t(37386),_=t(63527),T=t(45861),ce=t(64762),de=t(38396),E=t(97507),ee=t(28141),H=t(47797),me=t(74268),J=t(77788),ge=t(82203),F=t(77256),R=t(36200),M=t(2543),A=t(96540),ue=t(18857),Q=t(66404),te=t(98127),ne=t(53226),fe=t(48767),he=t(28365);function se({defaultValues:n,selectedChannelOptions:i,onResetSecureField:m,onDeleteSubform:N,errors:K,integrationPrefix:f,readOnly:I=!1,customValidators:o={}}){const{watch:x}=(0,d.xW)(),[j,h]=x([`${f}.settings`,`${f}.secureFields`]),S=`${f}.settings.`,L=a=>({required:ae(a,j,h),readOnly:ie(a,j,h)});return(0,e.jsx)(e.Fragment,{children:i.map((a,D)=>{const $=`${a.label}-${D}`,Y=j?.[a.showWhen.field];if(a.showWhen.field&&Y!==a.showWhen.is)return null;if(h&&h[a.secureFieldKey??a.propertyName])return(0,e.jsx)(b.D,{label:a.label,description:a.description,htmlFor:`${S}${a.propertyName}`,children:(0,e.jsx)(fe.L4,{id:`${S}${a.propertyName}`,onReset:()=>m(a.secureFieldKey??a.propertyName),isConfigured:!0})},$);const Z=(a.secure?K?.secureFields:K?.settings)?.[a.secureFieldKey??a.propertyName],z=n?.settings?.[a.propertyName];return(0,e.jsx)(he.e,{secureFields:h,onResetSecureField:m,onDeleteSubform:N,defaultValue:z,readOnly:I,error:Z,pathPrefix:S,option:a,customValidator:o[a.propertyName],getOptionMeta:L},$)})})}const ae=(n,i,m)=>n.required?n.dependsOn?!!i[n.dependsOn]||!!m[n.dependsOn]?!1:"Required":n.required?"Required":!1:!1,ie=(n,i,m)=>n.dependsOn?!!i[n.dependsOn]||!!m[n.dependsOn]:!1;var X=t(83904);function je({defaultValues:n,initialValues:i,pathPrefix:m,integrationIndex:N,onDuplicate:K,onDelete:f,onTest:I,notifiers:o,errors:x,commonSettingsComponent:j,isEditable:h=!0,isTestable:S,customValidators:L={}}){const a=(0,q.of)(Se),{control:D,watch:$,register:Y,trigger:Z,formState:z,setValue:W,getValues:xe}=(0,d.xW)(),r=`items.${N}`,C=`${r}.type`,O=`${r}.settings`,w=$(C)??n.type,ye=$(`${O}.parse_mode`),{loading:Ce}=(0,te.$)(c=>c.testReceivers),be=$(`${O}.integration_type`)!==ne.U0.NewIntegration;(0,A.useEffect)(()=>{Y(`${r}.__id`),Y(`${r}.secureFields`)},[Y,r]),(0,A.useEffect)(()=>{const c=$((y,{name:u,type:pe})=>{const Fe=u?y[u]:"";i&&u===C&&Fe===i.type&&pe==="change"&&W(O,i.settings),i&&u===`${O}.integration_type`&&Fe===ne.U0.ExistingIntegration&&W(`${O}.url`,i.settings.url)});return()=>c.unsubscribe()},[w,i,W,O,C,$]);const v=c=>{const y=xe(`${r}.secureFields`);y[c]&&W(`${r}.secureFields`,{...y,[c]:""})},g=c=>{const y=[];return c?.forEach(u=>{u.secure&&u.secureFieldKey&&y.push(u.secureFieldKey),u.subformOptions&&y.push(...g(u.subformOptions))}),y},G=(c,y)=>{g(y.subformOptions??[]).forEach(Fe=>{v(Fe)});const pe=c.startsWith(`${r}.settings.`)?c.slice(`${r}.settings.`.length):c;W(`${O}.${pe}`,void 0)},Te=(0,A.useMemo)(()=>(0,M.sortBy)(o,({dto:c,meta:y})=>[y?.order??0,c.name]).map(({dto:{name:c,type:y},meta:u})=>({label:(0,e.jsxs)(U.B,{alignItems:"center",gap:1,children:[c,u?.badge]}),value:y,description:u?.description,isDisabled:u?!u.enabled:!1})),[o]),k=async()=>{await Z(),Object.keys(z.errors).length===0&&I&&I()},re=o.find(({dto:{type:c}})=>c===w),Be=w==="telegram"&&!(ye==="None"||!ye),Re=re?.dto.options.filter(c=>c.required)??[],Ae=re?.dto.options.filter(c=>!c.required)??[],De=`contact-point-type-${m}`;return(0,e.jsxs)("div",{className:a.wrapper,"data-testid":"item-container",children:[(0,e.jsxs)("div",{className:a.topRow,children:[(0,e.jsx)("div",{children:(0,e.jsx)(b.D,{label:(0,l.t)("alerting.channel-sub-form.label-integration","Integration"),htmlFor:De,"data-testid":`${m}type`,children:(0,e.jsx)(d.xI,{name:C,control:D,defaultValue:n.type,render:({field:{ref:c,onChange:y,...u}})=>(0,e.jsx)(ue.l6,{disabled:!h,inputId:De,...u,width:37,options:Te,onChange:pe=>y(pe?.value)})})})}),(0,e.jsxs)("div",{className:a.buttons,children:[S&&I&&be&&(0,e.jsx)(T.$n,{disabled:Ce,size:"xs",variant:"secondary",type:"button",onClick:()=>k(),icon:Ce?"spinner":"message",children:(0,e.jsx)(l.x6,{i18nKey:"alerting.channel-sub-form.test",children:"Test"})}),h&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(T.$n,{size:"xs",variant:"secondary",type:"button",onClick:()=>K(),icon:"copy",children:(0,e.jsx)(l.x6,{i18nKey:"alerting.channel-sub-form.duplicate",children:"Duplicate"})}),f&&(0,e.jsx)(T.$n,{"data-testid":`${m}delete-button`,size:"xs",variant:"secondary",type:"button",onClick:()=>f(),icon:"trash-alt",children:(0,e.jsx)(l.x6,{i18nKey:"alerting.channel-sub-form.delete",children:"Delete"})})]})]})]}),re&&(0,e.jsxs)("div",{className:a.innerContent,children:[Be&&(0,e.jsx)(B.F,{title:(0,l.t)("alerting.contact-points.telegram.parse-mode-warning-title","Telegram messages are limited to 4096 UTF-8 characters."),severity:"warning",children:(0,e.jsxs)(l.x6,{i18nKey:"alerting.contact-points.telegram.parse-mode-warning-body",children:["If you use a ",(0,e.jsx)(Q.E,{variant:"code",children:"parse_mode"})," option other than ",(0,e.jsx)(Q.E,{variant:"code",children:"None"}),", truncation may result in an invalid message, causing the notification to fail. For longer messages, we recommend using an alternative contact method."]})}),(0,e.jsx)(se,{defaultValues:n,selectedChannelOptions:Re.length?Re:Ae,errors:x,onResetSecureField:v,onDeleteSubform:G,integrationPrefix:r,readOnly:!h,customValidators:L}),!!(Re.length&&Ae.length)&&(0,e.jsxs)(X.i,{label:(0,l.t)("alerting.channel-sub-form.label-section","Optional {{name}} settings",{name:re.dto.name}),children:[re.dto.info!==""&&(0,e.jsx)(B.F,{title:"",severity:"info",children:re.dto.info}),(0,e.jsx)(se,{defaultValues:n,selectedChannelOptions:Ae,onResetSecureField:v,onDeleteSubform:G,errors:x,integrationPrefix:r,readOnly:!h,customValidators:L})]}),(0,e.jsx)(X.i,{label:(0,l.t)("alerting.channel-sub-form.label-notification-settings","Notification settings"),children:(0,e.jsx)(j,{pathPrefix:m,readOnly:!h})})]})]})}const Se=n=>({buttons:(0,p.css)({"& > * + *":{marginLeft:n.spacing(1)}}),innerContent:(0,p.css)({maxWidth:"536px"}),wrapper:(0,p.css)({margin:n.spacing(2,0),padding:n.spacing(1),border:`solid 1px ${n.colors.border.medium}`,borderRadius:n.shape.radius.default}),topRow:(0,p.css)({display:"flex",flexDirection:"row",justifyContent:"space-between"}),channelSettingsHeader:(0,p.css)({marginTop:n.spacing(2)})});function Oe({pathPrefix:n}){const{register:i}=(0,d.xW)();return(0,A.useEffect)(()=>{i(`${n}.__id`),i(`${n}.__deleted`)},[i,n]),(0,e.jsx)(e.Fragment,{children:null})}function ve(n){if(n)return{...n,items:n.items.map(i=>({...i,settings:{...i.settings,http_config:i.settings?.http_config?Ne(i.settings?.http_config):void 0}}))}}function Ne(n){return $e(n)?n:{...(0,M.omit)(n,"authorization"),bearer_token:n.authorization?.credentials,bearer_token_file:n.authorization?.credentials_file}}function $e(n){return["bearer_token","bearer_token_file"].some(i=>i in n)}function s({initialValues:n,defaultItem:i,notifiers:m,alertManagerSourceName:N,onSubmit:K,onTestChannel:f,commonSettingsComponent:I,isEditable:o,isTestable:x,customValidators:j,showDefaultRouteWarning:h,contactPointId:S,canManagePermissions:L}){const a=(0,ce._2)(),D=(0,q.of)(P),$=(0,E.cB)({alertmanager:N}),Z=ve(n)??{name:"",items:[{...i,__id:String(Math.random())}]},z=(0,d.mN)({defaultValues:structuredClone(Z)});(0,de.o)(v=>v.unifiedAlerting.saveAMConfig=R.jA);const{handleSubmit:W,register:xe,formState:{errors:r,isSubmitting:C},getValues:O}=z,{fields:w,append:ye,remove:Ce}=(0,ge.r)({name:"items",formAPI:z,softDelete:!0}),Ke=async v=>{try{await K({...v,items:v.items.filter(g=>!g.__deleted)})}catch(g){if(g instanceof Error||(0,le.NF)(g)){a.error("Failed to save the contact point",V(g));const G=new Error("Failed to save the contact point");G.cause=g,(0,me.vV)(G)}throw g}},be=()=>{a.error("There are errors in the form. Please correct them and try again!")};return(0,e.jsxs)(d.Op,{...z,children:[h&&(0,e.jsx)(B.F,{severity:"warning",title:(0,l.t)("alerting.receiver-form.title-attention","Attention"),children:(0,e.jsx)(l.x6,{i18nKey:"alerting.receiver-form.body-attention",children:"Because there is no default policy configured yet, this contact point will automatically be set as default."})}),(0,e.jsxs)("form",{onSubmit:W(Ke,be),className:D.wrapper,children:[(0,e.jsxs)(U.B,{justifyContent:"space-between",alignItems:"center",children:[(0,e.jsxs)("h2",{className:D.heading,children:[!o&&(0,l.t)("alerting.receiver-form.contact-point","Contact point"),o&&n&&(0,l.t)("alerting.receiver-form.contact-point-update","Update contact point"),o&&!n&&(0,l.t)("alerting.receiver-form.contact-point-create","Create contact point")]}),L&&S&&(0,e.jsx)(ee.k,{resource:"receivers",resourceId:S,resourceName:n?.name,title:(0,l.t)("alerting.receiver-form.title-manage-contact-point-permissions","Manage contact point permissions")})]}),(0,e.jsx)(b.D,{label:(0,l.t)("alerting.receiver-form.label-name","Name"),invalid:!!r.name,error:r.name&&r.name.message,required:!0,children:(0,e.jsx)(_.p,{readOnly:!o,id:"name",...xe("name",{required:"Name is required",validate:async v=>{const g=n?.name;return $(v,g)}}),width:39,placeholder:(0,l.t)("alerting.receiver-form.name-placeholder-name","Name")})}),w.map((v,g)=>{const G=`items.${g}.`;if(v.__deleted)return(0,e.jsx)(Oe,{pathPrefix:G},v.__id);const Te=n?.items.find(({__id:k})=>k===v.__id);return(0,e.jsx)(je,{defaultValues:v,initialValues:Te,integrationIndex:g,onDuplicate:()=>{const k=O().items[g];ye({...k,__id:String(Math.random())})},onTest:f?()=>{const k=O().items[g];f(k)}:void 0,onDelete:()=>Ce(g),pathPrefix:G,notifiers:m,errors:r?.items?.[g],commonSettingsComponent:I,isEditable:o,isTestable:x,customValidators:j?j[v.type]:void 0},v.__id)}),o&&(0,e.jsx)(T.$n,{type:"button",icon:"plus",variant:"secondary",onClick:()=>ye({...i,__id:String(Math.random())}),children:(0,e.jsx)(l.x6,{i18nKey:"alerting.receiver-form.add-contact-point-integration",children:"Add contact point integration"})}),(0,e.jsxs)("div",{className:D.buttons,children:[o&&(0,e.jsxs)(e.Fragment,{children:[C&&(0,e.jsx)(T.$n,{disabled:!0,icon:"spinner",variant:"primary",children:(0,e.jsx)(l.x6,{i18nKey:"alerting.receiver-form.saving",children:"Saving..."})}),!C&&(0,e.jsx)(T.$n,{type:"submit",children:(0,e.jsx)(l.x6,{i18nKey:"alerting.receiver-form.save-contact-point",children:"Save contact point"})})]}),(0,e.jsx)(T.z9,{disabled:C,variant:"secondary","data-testid":"cancel-button",href:(0,F.nL)("/alerting/notifications",N),children:(0,e.jsx)(l.x6,{i18nKey:"alerting.common.cancel",children:"Cancel"})})]})]})]})}const P=n=>({heading:(0,p.css)({margin:n.spacing(2,0,3,0)}),buttons:(0,p.css)({marginTop:n.spacing(4),"& > * + *":{marginLeft:n.spacing(1)}}),wrapper:(0,p.css)({maxWidth:`${n.breakpoints.values.xl}px`})});function V(n){return(0,J.uz)(n)?n.data.detail:(0,H.q6)(n)}}}]);

//# sourceMappingURL=8622.081fd43076d609d42bb5.js.map