"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[9473],{39473:(L,h,t)=>{t.r(h),t.d(h,{plugin:()=>vt});var D=t(94644),e=t(74848),m=t(22803),T=t(92145),x=t(55127),p=t.n(x),l=t(96540),v=t(16817),E=t(739),P=t(63142),c=t(2543),R=t(46936),A=t(70713),Tt=t(27633);function X({children:s}){const n=(0,P.of)(Y);return l.createElement("div",{className:n.root},l.createElement(R.C,{gap:1},s))}const Y=s=>({root:(0,m.css)({padding:s.spacing(1,1,0,1),backgroundColor:s.colors.background.secondary,borderRadius:s.shape.radius.default})});var y=t(41654),O=t(37386),H=t(18857),J=t(77824),Z=t(21285),w=t(68079),K=t(65642),$=t(22429),k=t(72746),M=t(28998),q=t(67042),b=t(18615),N=t(9931);function _(s){return JSON.stringify(s)}function tt(s,n){let r=n;return window.__grafanaSceneContext&&window.__grafanaSceneContext instanceof k.H$&&(r=window.__grafanaSceneContext.state.editPanel?.getPanelId()),s===r}const at=[{label:"All data",value:!1},{label:"Annotations",value:!0,description:"Include annotations as regular data"}],nt="Contains a shared dashboard query";function et({data:s,query:n,onChange:r,onRunQuery:i}){const{value:o}=(0,v.A)(()=>(0,M.tR)().get()),f=(0,l.useMemo)(()=>(0,$.UA)().getCurrent()?.getPanelById(n.panelId??-124134),[n.panelId]),{value:g,loading:u}=(0,v.A)(async()=>{if(!f||!s)return[];const a=await(0,M.tR)().get(f.datasource);return Promise.all(f.targets.map(async d=>{const I=d.datasource?await(0,M.tR)().get(d.datasource):a,U=I.getQueryDisplayText||_,V=(0,q.E)(s,d.refId)??s;return{refId:d.refId,query:U(d),name:I.name,img:I.meta.info.logos.small,data:V.series,error:V.error}}))},[s,f]),C=(0,l.useCallback)(a=>{r(a),i()},[r,i]),S=(0,l.useCallback)(a=>{C({...n,panelId:a})},[n,C]),mt=(0,l.useCallback)(()=>{C({...n,withTransforms:!n.withTransforms})},[n,C]),gt=(0,l.useCallback)(a=>{C({...n,topic:a?E.QR.Annotations:void 0})},[n,C]),ht=a=>a.datasource?.uid===b.uv&&a.targets.some(d=>d.datasource?.uid===N.K),G=(0,l.useCallback)(a=>{const d=a.datasource??o,I=(0,M.tR)().getInstanceSettings(d)?.name,U=a.targets.length;return`${U} ${p()("query",U)} to ${I}`},[o]),Q=(0,$.UA)().getCurrent(),Dt=!!(n.withTransforms||f?.transformations?.length),F=(0,l.useMemo)(()=>Q?.panels.filter(a=>K.Ay.panels[a.type]&&a.targets&&!tt(a.id,Q.panelInEdit?.id)).map(a=>{let d=G(a),I=!1;return(a.datasource?.uid===N.K||ht(a))&&(d=nt,I=!0),{value:a.id,label:a.title??"Panel "+a.id,imgUrl:K.Ay.panels[a.type].info.logos.small,description:d,isDisabled:I}})??[],[Q,G]),Et=(0,P.of)(st),Ct=(0,T.Bi)();if(!Q)return null;if(F.length<1)return(0,e.jsx)("p",{className:Et.noQueriesText,children:"This dashboard does not have any other panels. Add queries to other panels and try again."});const It=F.find(a=>a.value===n.panelId);return(0,e.jsx)(X,{children:(0,e.jsxs)(y.B,{direction:"column",children:[(0,e.jsxs)(y.B,{gap:3,children:[(0,e.jsx)(O.D,{label:"Source panel",description:"Use query results from another panel",children:(0,e.jsx)(H.l6,{inputId:Ct,placeholder:"Choose panel",isSearchable:!0,options:F,value:It,onChange:a=>S(a.value)})}),(0,e.jsx)(O.D,{label:"Data",description:"Use data or annotations from the panel",children:(0,e.jsx)(J.z,{options:at,value:n.topic===E.QR.Annotations,onChange:gt})}),Dt&&(0,e.jsx)(O.D,{label:"Transform",description:"Apply transformations from the source panel",children:(0,e.jsx)(Z.K,{value:!!n.withTransforms,onChange:mt})})]}),u?(0,e.jsx)(w.y,{}):(0,e.jsx)(e.Fragment,{children:g&&!!g.length&&(0,e.jsx)(O.D,{label:"Queries from panel",children:(0,e.jsx)(y.B,{direction:"column",children:g.map((a,d)=>(0,e.jsxs)(y.B,{alignItems:"center",gap:1,children:[(0,e.jsx)("div",{children:a.refId}),(0,e.jsx)("img",{src:a.img,alt:a.name,title:a.name,width:16}),(0,e.jsx)("div",{children:a.query})]},d))})})})]})})}function st(s){return{noQueriesText:(0,m.css)({padding:s.spacing(1.25)})}}var j=t(62467),ot=t(72316),rt=t(56978),lt=t(81160),dt=t(69850),it=t(51575),z=t(96083),ut=t(57532),B=t(28105),ct=t(36674),W=t(8285);class ft extends D.mA{constructor(n){super(n)}getCollapsedText(n){return`Dashboard Reference: ${n.panelId}`}query(n){const r=n.scopedVars?.__sceneObject;let i=r?r.value.valueOf():void 0;if(!i)throw new Error("Can only be called from a scene");const o=n.targets[0];if(!o)return(0,j.of)({data:[]});const f=o.panelId;if(!f)return(0,j.of)({data:[]});let g=this.findSourcePanel(i,f);if(!g)return(0,j.of)({data:[],error:{message:"Could not find source panel"}});let u=g.state.$data;return!o.withTransforms&&u instanceof ct.Es&&(u=u.state.$data),!u||!u.getResultsStream?(0,j.of)({data:[]}):(0,ot.v)(()=>{!u.isActive&&u?.setContainerWidth&&u?.setContainerWidth(500);const C=(0,W.sf)(u);return u.getResultsStream().pipe((0,rt.B)(50),(0,lt.T)(S=>({data:this.getDataFramesForQueryTopic(S.data,o),state:S.data.state,errors:S.data.errors,error:S.data.error,key:"source-ds-provider"})),this.emitFirstLoadedDataIfMixedDS(n.requestId),(0,dt.j)(()=>C?.()))})}getDataFramesForQueryTopic(n,r){const i=n.annotations??[];return r.topic===E.QR.Annotations?i.map(o=>({...o,meta:{...o.meta,dataTopic:E.QR.Series}})):[...n.series.map(f=>({...f,fields:f.fields.map(g=>({...g,state:{...g.state}}))})),...i]}findSourcePanel(n,r){return(0,W.EX)(n,(0,W.XA)(r))}emitFirstLoadedDataIfMixedDS(n){return r=>{if(n.includes(b.bG)){let i=0;return r.pipe((0,it.s)(o=>[B.Gu.Done,B.Gu.Error].includes(o.state)&&i===0?(i++,(0,z.Y)(400)):(i++,(0,z.Y)(0))),(0,ut.$)(o=>o.state===B.Gu.Done||o.state===B.Gu.Error))}return r}}testDatasource(){return Promise.resolve({message:"",status:""})}}const vt=new D.tD(ft).setQueryEditor(et)},72316:(L,h,t)=>{t.d(h,{v:()=>m});var D=t(88483),e=t(15964);function m(T){return new D.c(function(x){(0,e.Tg)(T()).subscribe(x)})}},51575:(L,h,t)=>{t.d(h,{s:()=>x});var D=t(92908),e=t(92357),m=t(64878),T=t(15964);function x(p){return(0,D.N)(function(l,v){var E=!1,P=null,c=null,R=function(){if(c?.unsubscribe(),c=null,E){E=!1;var A=P;P=null,v.next(A)}};l.subscribe((0,m._)(v,function(A){c?.unsubscribe(),E=!0,P=A,c=(0,m._)(v,R,e.l),(0,T.Tg)(p(A)).subscribe(c)},function(){R(),v.complete()},void 0,function(){P=c=null}))})}},46936:(L,h,t)=>{t.d(h,{C:()=>m});var D=t(96540),e=t(41654);const m=({children:T,wrap:x=!0,...p})=>{var l,v;return D.createElement(e.B,{wrap:x?"wrap":void 0,direction:(l=p.direction)!=null?l:"row",gap:(v=p.gap)!=null?v:2,...p},T)}}}]);

//# sourceMappingURL=9473.81004b48ee555df694ae.js.map