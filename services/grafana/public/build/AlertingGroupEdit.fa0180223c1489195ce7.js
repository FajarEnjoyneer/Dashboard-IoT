"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[6102],{25521:(ae,F,a)=>{a.d(F,{G:()=>C});var e=a(74848),h=a(22803),I=a(92745),y=a(63142),B=a(59243),M=a(41654),o=a(30703),S=a(66404);function C({contentText:G,externalLink:v,linkText:D,title:j="Need help?"}){const A=(0,y.of)(K);return(0,e.jsx)(B.G,{content:(0,e.jsx)("div",{className:A.mutedText,children:G}),title:(0,e.jsxs)(M.B,{gap:.5,direction:"row",alignItems:"center",children:[(0,e.jsx)(o.I,{name:"question-circle"}),j]}),footer:v?(0,e.jsx)("a",{href:v,target:"_blank",rel:"noreferrer",children:(0,e.jsx)(M.B,{direction:"row",gap:.5,alignItems:"center",children:(0,e.jsxs)(S.E,{color:"link",children:[D," ",(0,e.jsx)(o.I,{size:"sm",name:"external-link-alt"})]})})}):void 0,closeButton:!0,placement:"bottom-start",children:(0,e.jsx)("div",{className:A.helpInfo,children:(0,e.jsxs)(M.B,{direction:"row",alignItems:"center",gap:.5,children:[(0,e.jsx)(o.I,{name:"question-circle",size:"sm"}),(0,e.jsx)(S.E,{variant:"bodySmall",color:"primary",children:(0,e.jsx)(I.x6,{i18nKey:"alerting.need-help-info.need-help",children:"Need help?"})})]})})})}const K=G=>({mutedText:(0,h.css)({color:G.colors.text.secondary,fontSize:G.typography.size.sm}),helpInfo:(0,h.css)({cursor:"pointer",textDecoration:"underline"})})},58872:(ae,F,a)=>{a.d(F,{P:()=>K});var e=a(74848),h=a(22803),I=a(51898),y=a(92745),B=a(63142),M=a(16780),o=a(41654),S=a(66404),C=a(21285);const K=({title:v,stepNo:D,children:j,fullWidth:A=!1,description:V,switchMode:W})=>{const L=(0,B.of)(G),H=I.Tp.components.AlertRules;return(0,e.jsx)("div",{className:L.parent,"data-testid":H.step(D.toString()),children:(0,e.jsx)(M.n,{className:(0,h.cx)(A&&L.fullWidth),label:(0,e.jsxs)(o.B,{direction:"row",alignItems:"center",justifyContent:"space-between",children:[(0,e.jsxs)(S.E,{variant:"h3",children:[D,". ",v]}),W&&(0,e.jsx)(S.E,{variant:"bodySmall",children:(0,e.jsx)(C.K,{"data-testid":H.stepAdvancedModeSwitch(D.toString()),value:W.isAdvancedMode,onChange:X=>{W.setAdvancedMode(X.currentTarget.checked)},label:(0,y.t)("alerting.rule-editor-section.label-advanced-options","Advanced options"),showLabel:!0,transparent:!0,className:L.reverse})})]}),children:(0,e.jsxs)(o.B,{direction:"column",children:[V&&(0,e.jsx)("div",{className:L.description,children:V}),j]})})})},G=v=>({parent:(0,h.css)({display:"flex",flexDirection:"row",border:`solid 1px ${v.colors.border.weak}`,borderRadius:v.shape.radius.default,padding:`${v.spacing(2)} ${v.spacing(3)}`}),description:(0,h.css)({marginTop:`-${v.spacing(2)}`}),fullWidth:(0,h.css)({width:"100%"}),reverse:(0,h.css)({flexDirection:"row-reverse",gap:v.spacing(1)})})},56638:(ae,F,a)=>{a.r(F),a.d(F,{default:()=>Me});var e=a(74848),h=a(22803),I=a(1932),y=a(96540),B=a(49785),M=a(54148),o=a(92745),S=a(36490),C=a(34999),K=a(36303),G=a(63142),v=a(37386),D=a(63527),j=a(41654),A=a(45861),V=a(71599),W=a(1506),L=a(64762),H=a(52763),X=a(86791),re=a(74268),U=a(70327),te=a(55143),ne=a(36826),de=a(44351),pe=a(8535),ge=a(11018),Q=a(80218),se=a(71639);const{useDeleteRuleGroupFromNamespaceMutation:me}=U.hK,{useLazyDiscoverDsFeaturesQuery:fe}=te.L;function ve(){const[n]=me(),[r]=fe();return(0,Q.Yb)(async s=>{const{dataSourceName:i,namespaceName:l,groupName:u}=s,{rulerConfig:p}=await r({rulesSourceName:i}).unwrap();if(!p)throw(0,se._)(i);const c=await n({rulerConfig:p,namespace:l,group:u}).unwrap();return await(0,pe.JD)((0,ge.Lc)({rulesSourceName:i})),c})}var he=a(62939),$=a(96137),xe=a(52161);const oe=()=>t("alerting.rule-groups.update.success","Successfully updated rule group");function Re(){const[n]=(0,se.D)(),[r]=U.hK.endpoints.getRuleGroupForNamespace.useLazyQuery(),[s]=U.hK.endpoints.upsertRuleGroupForNamespace.useMutation(),[i]=U.hK.endpoints.deleteRuleGroupFromNamespace.useMutation();return(0,Q.Yb)(async(l,u)=>{const p=[],c=(0,xe.z2)(l.dataSourceName);if(u.namespaceName){if(c)throw new Error("Moving a Grafana-managed rule group to another folder is currently not supported.");p.push((0,$.fO)({newNamespaceName:u.namespaceName}))}u.groupName&&p.push((0,$.KL)({groupName:u.groupName})),u.interval&&p.push((0,$.lF)({interval:u.interval})),u.ruleSwaps&&p.push((0,$.bw)({swaps:u.ruleSwaps}));const{newRuleGroupDefinition:g,rulerConfig:d}=await n(l,p),f=l.namespaceName,m=u.namespaceName??f,R=l.groupName,x=g.name,E=f!==m,N=R!==x;if(x&&N&&(await r({rulerConfig:d,namespace:m,group:x,notificationOptions:{showErrorAlert:!1}}).unwrap().catch(he.R))?.rules?.length)throw new Error("Target group already has rules, merging rule groups is currently not supported.");await s({rulerConfig:d,namespace:m,payload:g,notificationOptions:{showSuccessAlert:!1}}).unwrap();const w=d.dataSourceName==="grafana"?{groupName:x,namespace:{uid:m},groupOrigin:"grafana"}:{groupName:x,namespace:{name:m},groupOrigin:"datasource",rulesSource:{uid:d.dataSourceUid,name:d.dataSourceName,ruleSourceType:"datasource"}};return(E||N)&&!c&&await i({rulerConfig:d,namespace:f,group:R,notificationOptions:{showSuccessAlert:!1}}).unwrap().catch(O=>{(0,re.vV)(O)}),w})}function We(){const[n]=useProduceNewRuleGroup(),[r]=alertRuleApi.endpoints.upsertRuleGroupForNamespace.useMutation();return useAsync(async(s,i)=>{const{namespaceName:l}=s,u=updateRuleGroupAction({interval:i}),{newRuleGroupDefinition:p,rulerConfig:c}=await n(s,[u]);return r({rulerConfig:c,namespace:l,payload:p,notificationOptions:{successMessage:oe()}}).unwrap()})}function Ue(){const[n]=useProduceNewRuleGroup(),[r]=alertRuleApi.endpoints.getRuleGroupForNamespace.useLazyQuery(),[s]=alertRuleApi.endpoints.upsertRuleGroupForNamespace.useMutation(),[i]=alertRuleApi.endpoints.deleteRuleGroupFromNamespace.useMutation(),l=t("alerting.rule-groups.move.success","Successfully moved rule group");return useAsync(async(u,p,c,g)=>{if(isGrafanaRulesSource(u.dataSourceName))throw new Error("Moving a Grafana-managed rule group to another folder is currently not supported.");const d=moveRuleGroupAction({newNamespaceName:p,groupName:c,interval:g}),{newRuleGroupDefinition:f,rulerConfig:m}=await n(u,[d]),R=u.namespaceName,x=d.payload.newNamespaceName,E=u.groupName,N=d.payload.groupName;if(N&&(!!N&&E!==N)&&(await r({rulerConfig:m,namespace:x,group:N,notificationOptions:{showErrorAlert:!1}}).unwrap().catch(notFoundToNullOrThrow))?.rules?.length)throw new Error("Target group already has rules, merging rule groups is currently not supported.");return await s({rulerConfig:m,namespace:x,payload:f,notificationOptions:{successMessage:l}}).unwrap(),await i({rulerConfig:m,namespace:R,group:E,notificationOptions:{showSuccessAlert:!1}}).unwrap()})}function $e(){const[n]=useProduceNewRuleGroup(),[r]=alertRuleApi.endpoints.getRuleGroupForNamespace.useLazyQuery(),[s]=alertRuleApi.endpoints.upsertRuleGroupForNamespace.useMutation(),[i]=alertRuleApi.endpoints.deleteRuleGroupFromNamespace.useMutation();return useAsync(async(l,u,p)=>{const c=renameRuleGroupAction({groupName:u,interval:p}),{newRuleGroupDefinition:g,rulerConfig:d}=await n(l,[c]),f=l.groupName,m=c.payload.groupName,R=l.namespaceName,x=t("alerting.rule-groups.rename.success","Successfully renamed rule group");if((await r({rulerConfig:d,namespace:R,group:m,notificationOptions:{showErrorAlert:!1}}).unwrap().catch(notFoundToNullOrThrow))?.rules?.length)throw new Error("Target group has existing rules, merging rule groups is currently not supported.");const N=await s({rulerConfig:d,namespace:R,payload:g,notificationOptions:{successMessage:x}}).unwrap();return await i({rulerConfig:d,namespace:R,group:f,notificationOptions:{showSuccessAlert:!1}}).unwrap(),N})}function be(){const[n]=useProduceNewRuleGroup(),[r]=alertRuleApi.endpoints.upsertRuleGroupForNamespace.useMutation();return useAsync(async(s,i)=>{const{namespaceName:l}=s,u=reorderRulesInRuleGroupAction({swaps:i}),{newRuleGroupDefinition:p,rulerConfig:c}=await n(s,[u]);return r({rulerConfig:c,namespace:l,payload:p,notificationOptions:{successMessage:oe()}}).unwrap()})}var ie=a(18404),Ne=a(80276),ye=a(39187),Ee=a(84523),ue=a(67598),k=a(77256),b=a(29442),q=a(89332),Ge=a(30703),je=a(99887),De=a(94646),J=a(29609);function Oe({rules:n,groupInterval:r,onSwap:s}){const i=(0,G.of)(_),[l,u]=(0,y.useState)(n),p=(0,y.useCallback)(g=>{if(!g.destination)return;const d=[g.source.index,g.destination.index];s(d);const f=(0,I.jM)(l,m=>{(0,$.Ct)(m,d)});u(f)},[l,s]),c=(0,y.useMemo)(()=>l.map(g=>({...g,uid:(0,De.Ns)(g)})),[l]);return(0,e.jsxs)("div",{children:[(0,e.jsx)(ce,{ruleName:(0,o.t)("alerting.draggable-rules-table.rule-name","Rule name"),pendingPeriod:(0,o.t)("alerting.draggable-rules-table.pending-period","Pending period"),evalsToStartAlerting:(0,o.t)("alerting.draggable-rules-table.evals-to-start-alerting","Evaluations to start alerting"),className:i.listHeader}),(0,e.jsx)(q.JY,{onDragEnd:p,children:(0,e.jsx)(q.gL,{droppableId:"alert-list",mode:"standard",renderClone:(g,d,f)=>(0,e.jsx)(le,{provided:g,rule:c[f.source.index],isClone:!0,groupInterval:r}),children:g=>(0,e.jsxs)(j.B,{direction:"column",gap:0,ref:g.innerRef,...g.droppableProps,children:[c.map((d,f)=>(0,e.jsx)(q.sx,{draggableId:d.uid,index:f,isDragDisabled:!1,children:m=>(0,e.jsx)(le,{provided:m,rule:d,groupInterval:r},d.uid)},d.uid)),g.placeholder]})})})]})}const le=({provided:n,rule:r,groupInterval:s,isClone:i=!1})=>{const l=(0,G.of)(_),u=(0,J.qz)(r),p=J.p.any.alertingRule(r)?r.for:null,c=(0,J.O9)(p??"0s",s),g=J.p.any.recordingRule(r);return(0,e.jsx)(ce,{dragHandle:(0,e.jsx)(Ge.I,{name:"draggabledots"}),ruleName:u,pendingPeriod:p,evalsToStartAlerting:g?(0,e.jsx)(je.E,{text:(0,o.t)("alerting.draggable-rules-table.recording","Recording"),color:"purple"}):c,"data-testid":"reorder-alert-rule",className:(0,h.cx)(l.listItem,{[l.listItemClone]:i}),ref:n.innerRef,...n.draggableProps,...n.dragHandleProps})},ce=(0,y.forwardRef)(({dragHandle:n,ruleName:r,pendingPeriod:s,evalsToStartAlerting:i,className:l,...u},p)=>{const c=(0,G.of)(_);return(0,e.jsxs)("div",{className:(0,h.cx)(c.listItem,l),ref:p,...u,children:[(0,e.jsx)(j.B,{flex:"0 0 24px",children:n}),(0,e.jsx)(j.B,{flex:1,children:r}),(0,e.jsx)(j.B,{basis:"30%",children:s}),(0,e.jsx)(j.B,{basis:"30%",children:i})]})}),_=n=>({listItem:(0,h.css)({display:"flex",flexDirection:"row",alignItems:"center",gap:n.spacing(1),padding:`${n.spacing(1)} ${n.spacing(2)}`,"&:nth-child(even)":{background:n.colors.background.secondary}}),listItemClone:(0,h.css)({border:`solid 1px ${n.colors.primary.shade}`}),listHeader:(0,h.css)({fontWeight:n.typography.fontWeightBold,borderBottom:`1px solid ${n.colors.border.weak}`})});var Se=a(76944);const{useDiscoverDsFeaturesQuery:Pe}=te.L;function Ae(){const n=(0,H.wA)(),{dataSourceUid:r="",namespaceId:s="",groupName:i=""}=(0,M.g)(),{folder:l,loading:u}=(0,ie.a)(r==="grafana"?s:""),p=r==="grafana"?X.l$:r,{data:c,isLoading:g,error:d}=Pe({uid:p}),[f,m]=(0,Q.Yb)(async z=>n(U.hK.endpoints.getRuleGroupForNamespace.initiate({rulerConfig:z,namespace:s,group:i})).unwrap());(0,y.useEffect)(()=>{s&&i&&c?.rulerConfig&&f.execute(c.rulerConfig)},[s,i,c?.rulerConfig,f]);const R=u||g||(0,Q.VP)(m),{result:x,error:E}=m,N={text:(0,o.t)("alerting.group-edit.page-title","Edit rule group"),parentItem:{text:l?.title??s,url:(0,b.tx)([["namespace",l?.title??s],["group",i]])}};if(c&&!c.rulerConfig)return(0,e.jsx)(ne.d,{pageNav:N,title:i,navId:"alert-list",isLoading:R,children:(0,e.jsx)(C.F,{title:(0,o.t)("alerting.group-edit.group-not-editable","Selected group cannot be edited"),children:(0,e.jsx)(o.x6,{i18nKey:"alerting.group-edit.group-not-editable-description",children:"This group belongs to a data source that does not support editing."})})});const w=r==="grafana"?{namespace:{uid:s},groupName:i,groupOrigin:"grafana"}:{rulesSource:{uid:r,name:c?.name??"",ruleSourceType:"datasource"},namespace:{name:s},groupName:i,groupOrigin:"datasource"};return(0,e.jsxs)(ne.d,{pageNav:N,title:(0,o.t)("alerting.group-edit.title","Edit evaluation group"),navId:"alert-list",isLoading:R,children:[(0,e.jsxs)(e.Fragment,{children:[!!d&&(0,e.jsx)(C.F,{title:(0,o.t)("alerting.group-edit.ds-error","Error loading data source details"),bottomSpacing:0,topSpacing:2,children:(0,e.jsx)("div",{children:(0,k.JZ)(d)})}),!!E&&(0,e.jsx)(C.F,{title:(0,o.t)("alerting.group-edit.rule-group-error","Error loading rule group"),bottomSpacing:0,topSpacing:2,children:(0,k.JZ)(E)})]}),x&&(0,e.jsx)(Ce,{rulerGroup:x,groupIdentifier:w}),!x&&(0,e.jsx)(W.L,{entity:`${s}/${i}`})]})}const Me=(0,K.Xc)(Ae,{style:"page"});function Ce({rulerGroup:n,groupIdentifier:r}){const s=(0,G.of)(Te),i=(0,L._2)(),{returnTo:l}=(0,ye.h)(b.TN.detailsPageLinkFromGroupIdentifier(r)),{folder:u}=(0,ie.a)(r.groupOrigin==="grafana"?r.namespace.uid:""),{waitForGroupConsistency:p}=(0,Ne.zx)(),[c]=Re(),[g]=ve(),[d,f]=(0,y.useState)([]),[m,R]=(0,y.useState)(!1),x=n?.interval??Ee.T6,{register:E,handleSubmit:N,getValues:w,setValue:z,formState:{errors:O,dirtyFields:ee,isSubmitting:Y}}=(0,B.mN)({mode:"onBlur",shouldFocusError:!0,defaultValues:{name:n.name,interval:n.interval,namespace:r.groupOrigin==="datasource"?r.namespace.name:void 0}}),Le=(0,y.useCallback)(T=>{f(P=>(0,I.jM)(P,Z=>{Z.push(T)}))},[]),we=async T=>{try{const P={namespaceName:ee.namespace?T.namespace:void 0,groupName:ee.name?T.name:void 0,interval:ee.interval?T.interval:void 0,ruleSwaps:d.length?d:void 0},Z=await c.execute((0,ue.Rc)(r),P);(!!P.namespaceName||!!P.groupName)&&await p(Z);const Ke=(0,o.t)("alerting.group-edit.form.update-success","Successfully updated the rule group");i.success(Ke),Fe(Z)}catch(P){(0,re.vV)(P instanceof Error?P:new Error("Failed to update rule group")),i.error((0,o.t)("alerting.group-edit.form.update-error","Failed to update rule group"),(0,k.JZ)(P))}},Be=async()=>{await g.execute((0,ue.Rc)(r)),await p(r),Ie()};return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsxs)("form",{onSubmit:N(we),children:[r.groupOrigin==="datasource"&&(0,e.jsx)(v.D,{label:(0,o.t)("alerting.group-edit.form.namespace-label","Namespace"),required:!0,invalid:!!O.namespace,error:O.namespace?.message,className:s.input,children:(0,e.jsx)(D.p,{id:"namespace",...E("namespace",{required:(0,o.t)("alerting.group-edit.form.namespace-required","Namespace is required")})})}),r.groupOrigin==="grafana"&&(0,e.jsx)(v.D,{label:(0,o.t)("alerting.group-edit.form.folder-label","Folder"),required:!0,children:(0,e.jsx)(D.p,{id:"folder",value:u?.title??"",readOnly:!0})}),(0,e.jsx)(v.D,{label:(0,o.t)("alerting.group-edit.form.group-name-label","Evaluation group name"),required:!0,invalid:!!O.name,error:O.name?.message,className:s.input,children:(0,e.jsx)(D.p,{id:"group-name",...E("name",{required:(0,o.t)("alerting.group-edit.form.group-name-required","Group name is required")})})}),(0,e.jsx)(v.D,{label:(0,o.t)("alerting.group-edit.form.interval-label","Evaluation interval"),description:(0,o.t)("alerting.group-edit.form.interval-description","How often is the group evaluated"),invalid:!!O.interval,error:O.interval?.message,className:s.input,htmlFor:"interval",children:(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(D.p,{id:"interval",...E("interval",(0,Se.i)(n.rules)),className:s.intervalInput}),(0,e.jsx)(de.gv,{currentInterval:w("interval"),onSelect:T=>z("interval",T,{shouldValidate:!0,shouldDirty:!0})})]})}),(0,e.jsx)(v.D,{label:(0,o.t)("alerting.group-edit.form.rules-label","Alerting and recording rules"),description:(0,o.t)("alerting.group-edit.form.rules-description","Drag rules to reorder"),children:(0,e.jsx)(Oe,{rules:n.rules,groupInterval:x,onSwap:Le})}),(0,e.jsxs)(j.B,{children:[(0,e.jsx)(A.$n,{type:"submit",disabled:Y,icon:Y?"spinner":void 0,children:(0,e.jsx)(o.x6,{i18nKey:"alerting.group-edit.form.save",children:"Save"})}),(0,e.jsx)(A.z9,{variant:"secondary",disabled:Y,href:l,children:(0,e.jsx)(o.x6,{i18nKey:"alerting.common.cancel",children:"Cancel"})})]})]}),r.groupOrigin==="datasource"&&(0,e.jsxs)(j.B,{direction:"row",justifyContent:"flex-end",children:[(0,e.jsx)(A.$n,{type:"button",variant:"destructive",onClick:()=>R(!0),disabled:Y,children:(0,e.jsx)(o.x6,{i18nKey:"alerting.group-edit.form.delete",children:"Delete"})}),(0,e.jsx)(V.u,{isOpen:m,title:(0,o.t)("alerting.group-edit.form.delete-title","Delete rule group"),body:(0,o.t)("alerting.group-edit.form.delete-body","Are you sure you want to delete this rule group?"),confirmText:(0,o.t)("alerting.group-edit.form.delete-confirm","Delete"),onConfirm:Be,onDismiss:()=>R(!1)})]})]})}const Te=n=>({intervalInput:(0,h.css)({marginBottom:n.spacing(.5)}),input:(0,h.css)({maxWidth:"600px"})});function Fe(n){if(n.groupOrigin==="datasource"){const{rulesSource:r,namespace:s,groupName:i}=n;S.Ny.replace(b.TN.editPageLink(r.uid,s.name,i,{skipSubPath:!0}))}else{const{namespace:r,groupName:s}=n;S.Ny.replace(b.TN.editPageLink("grafana",r.uid,s,{skipSubPath:!0}))}}function Ie(){S.Ny.replace((0,b.Mo)(void 0,{skipSubPath:!0}))}}}]);

//# sourceMappingURL=AlertingGroupEdit.fa0180223c1489195ce7.js.map