"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[9886],{61293:(w,S,r)=>{r.d(S,{x:()=>V});var e=r(74848),x=r(22803),m=r(96540),L=r(51898),a=r(92745),R=r(45861),h=r(63142),j=r(22787),P=r(41654),O=r(37386),g=r(72636),M=r(63527),B=r(64762),G=r(73427),U=r(18346),z=r(11257);const V=({onCreate:c})=>{const[f,u]=(0,m.useState)(!1),p=D=>{c(D),u(!1)};return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(R.$n,{onClick:()=>u(!0),type:"button",icon:"plus",fill:"outline",variant:"secondary",disabled:!G.TP.hasPermission(z.w.FoldersCreate),children:(0,e.jsx)(a.x6,{i18nKey:"alerting.create-new-folder.new-folder",children:"New folder"})}),f&&(0,e.jsx)($,{onCreate:p,onClose:()=>u(!1)})]})};function $({onClose:c,onCreate:f}){const u=(0,h.of)(y),p=(0,B._2)(),[D,T]=(0,m.useState)(""),[A]=(0,U.Vc)(),H=async()=>{const{data:N,error:k}=await A({title:D});k?p.error("Failed to create folder"):N&&(f({title:N.title,uid:N.uid}),p.success("Folder created"))};return(0,e.jsx)(j.a,{className:u.modal,isOpen:!0,title:(0,a.t)("alerting.create-new-folder.title-new-folder","New folder"),onDismiss:c,onClickBackdrop:c,children:(0,e.jsxs)(P.B,{direction:"column",gap:2,children:[(0,e.jsx)(O.D,{label:(0,e.jsx)(g.J,{htmlFor:"folder",children:(0,e.jsx)(a.x6,{i18nKey:"alerting.create-new-folder.folder.name",children:"Folder name"})}),children:(0,e.jsx)(M.p,{"data-testid":L.Tp.components.AlertRules.newFolderNameField,autoFocus:!0,id:"folderName",placeholder:(0,a.t)("alerting.create-new-folder.placeholder-enter-a-name","Enter a name"),value:D,onChange:N=>T(N.currentTarget.value)})}),(0,e.jsxs)(j.a.ButtonRow,{children:[(0,e.jsx)(R.$n,{variant:"secondary",type:"button",onClick:c,children:(0,e.jsx)(a.x6,{i18nKey:"alerting.create-new-folder.folder.cancel",children:"Cancel"})}),(0,e.jsx)(R.$n,{onClick:H,disabled:!D,"data-testid":L.Tp.components.AlertRules.newFolderNameCreateButton,children:(0,e.jsx)(a.x6,{i18nKey:"alerting.create-new-folder.folder.create",children:"Create"})})]})]})})}const y=c=>({modal:(0,x.css)({width:`${c.breakpoints.values.sm}px`})})},45097:(w,S,r)=>{r.r(S),r.d(S,{default:()=>_e,supportedImportTypes:()=>He});var e=r(74848),x=r(96540),m=r(49785),L=r(42941),a=r(92745),R=r(43173),h=r(41654),j=r(37386),P=r(16203),O=r(89599),g=r(31286),M=r(66404),B=r(3271),G=r(18027),U=r(21285),z=r(97095),V=r(45861),$=r(68079),y=r(57688),c=r(3208),f=r(76792),u=r(52161),p=r(77256),D=r(88547),T=r(36826),A=r(61293),H=r(38133),N=r(25521),k=r(22803),J=r(2543),xe=r(16817),ye=r(36490),re=r(34999),oe=r(63142),ne=r(22787),De=r(71599),Ee=r(50992),se=r(64762),ie=r(74268),je=r(5709);const Me=je.H.injectEndpoints({endpoints:t=>({convertToGMA:t.mutation({query:({payload:o,targetFolderUID:n,pauseRecordingRules:s,pauseAlerts:l,dataSourceUID:i,targetDatasourceUID:v})=>({url:"/api/convert/prometheus/config/v1/rules",method:"POST",body:o,headers:{"X-Grafana-Alerting-Datasource-UID":i,"X-Grafana-Alerting-Recording-Rules-Paused":s,"X-Grafana-Alerting-Alert-Rules-Paused":l,"X-Disable-Provenance":!0,...n?{"X-Grafana-Alerting-Folder-UID":n}:{},...v?{"X-Grafana-Alerting-Target-Datasource-UID":v}:{}}})})})});var Ie=r(29442),le=r(29609),Te=r(75505),Re=r(68143),Ce=r(70327),Pe=r(55143),ue=r(59672);async function Ae(t){return(await(0,Te.s)((0,Re.AI)().fetch({url:"/api/folders",params:{parentUid:t},method:"GET",showErrorAlert:!1,showSuccessAlert:!1})))?.data}function Fe(t,o=!1){const[n,s]=(0,x.useState)([]);return(0,x.useEffect)(()=>{(async()=>{const l=o?[]:await Ae(t);s(l)})()},[t,o]),n}function Le(t,o,n){const s=Fe(o?.uid||"",t),l=t||s.length===0;return{rulesThatMightBeOverwritten:Se(s,n,l)}}function Oe(t,o){const n=t?void 0:o,{rulerRules:s,isLoading:l}=(0,ue.h$)(n);return{rulesToBeImported:s,isloadingCloudRules:l}}function Se(t,o,n=!0){const[s]=Ce.hK.endpoints.rulerNamespace.useLazyQuery(),[l,i]=(0,x.useState)({});return(0,x.useEffect)(()=>{if(n||(0,J.isEmpty)(t)||(0,J.isEmpty)(o)){i({});return}const v=t.filter(E=>Object.keys(o).includes(E.title));(async()=>{const E={};await Promise.all(v.map(async F=>{const{data:I}=await s({namespace:F.uid,rulerConfig:Pe.b});if(I){const C=Object.keys(I)[0];C&&(E[C]=I[C]||[])}})),i(E)})()},[t,o,n,s]),l}var Be=r(20382);function Q(t){return typeof t=="object"&&!!t}function Ue(t){if(!Q(t))return!1;const o="alert"in t&&typeof t.alert=="string"?t.alert:void 0,n="record"in t&&typeof t.record=="string"?t.record:void 0;return!(!("expr"in t&&typeof t.expr=="string"?t.expr:void 0)||!o&&!n||o&&n||"for"in t&&typeof t.for!="string"||"labels"in t&&!Q(t.labels)||"annotations"in t&&!Q(t.annotations))}function We(t){if(!Q(t))return!1;const o="name"in t&&typeof t.name=="string"?t.name:void 0,n="rules"in t&&Array.isArray(t.rules)?t.rules:void 0;return!o||!n?!1:n.every(Ue)}function Ge(t){if(!Q(t))return{isValid:!1,error:"Invalid YAML format: missing or invalid groups array"};if(!("groups"in t)||"groups"in t&&!Array.isArray(t.groups))return{isValid:!1,error:"Invalid YAML format: missing or invalid groups array"};if(!Array.isArray(t.groups))return{isValid:!1,error:"Invalid YAML format: missing or invalid groups array"};if("namespace"in t&&typeof t.namespace!="string")return{isValid:!1,error:"Invalid YAML format: namespace must be a string"};const n={groups:t.groups.map((s,l)=>{if(We(s))return s;throw new Error(`Invalid YAML format: missing or invalid groups array at index ${l}`)})};return"namespace"in t&&typeof t.namespace=="string"&&(n.namespace=t.namespace),{isValid:!0,data:n}}function Ne(t,o){const n=(0,Be.Hh)(t),s=Ge(n);if(!s.isValid)throw new Error(s.error);const l=s.data;return{[l.namespace??o]:l.groups}}async function ce(t,o){const n=await t.text();return Ne(n,o)}const Ke=["SyntheticMonitoringCheckFailureAtHighSensitivity","SyntheticMonitoringCheckFailureAtMediumSensitivity","SyntheticMonitoringCheckFailureAtLowSensitivity","instance_job_severity:probe_success:mean5m"],de=()=>(0,e.jsx)(re.F,{title:(0,a.t)("alerting.import-to-gma.confirm-modal.plugin-rules-warning.title","Some rules are excluded from import"),severity:"info",children:(0,e.jsx)(M.E,{variant:"body",children:(0,e.jsx)(a.x6,{i18nKey:"alerting.import-to-gma.confirm-modal.plugin-rules-warning.text",children:"We have detected that some rules are managed by plugins. These rules will not be imported."})})}),be=()=>(0,e.jsx)(re.F,{title:(0,a.t)("alerting.import-to-gma.confirm-modal.not-using-rules-managed-by-integrations-or-plugins.title","Information"),severity:"info",children:(0,e.jsx)(M.E,{variant:"body",children:(0,e.jsx)(a.x6,{i18nKey:"alerting.import-to-gma.confirm-modal.not-using-rules-managed-by-integrations-or-plugins.text",children:"Rules managed by integrations or plugins should not be imported to Grafana-managed rules."})})}),te={},Ye=({importPayload:t,isOpen:o,onDismiss:n})=>{const s=(0,se._2)(),l=(0,oe.of)(ge),{importSource:i,selectedDatasourceName:v,selectedDatasourceUID:d,yamlFile:E,targetFolder:F,namespace:I,ruleGroup:C,targetDatasourceUID:W,yamlImportTargetDatasourceUID:K,pauseRecordingRules:X,pauseAlertingRules:q}=t,_=o&&i==="datasource"?v??"":void 0,{rulesToBeImported:Z,isloadingCloudRules:pe}=Oe(!o||i==="yaml",_),{value:ee=te}=(0,xe.A)(async()=>{if(!E||i!=="yaml")return te;try{return await ce(E,E.name)}catch(Y){return s.error((0,a.t)("alerting.import-to-gma.yaml-error","Failed to parse YAML file: {{error}}",{error:(0,p.JZ)(Y)})),te}},[i,E]),{filteredConfig:b,someRulesAreSkipped:he}=(0,x.useMemo)(()=>i==="datasource"?Ve(Z,I,C):{filteredConfig:ee,someRulesAreSkipped:!1},[I,C,i,ee,Z]),{rulesThatMightBeOverwritten:ve}=Le(!o,F,b),[er]=Me.useConvertToGMAMutation(),ae=(0,se._2)();if(pe)return(0,e.jsx)(ne.a,{isOpen:o,title:(0,a.t)("alerting.import-to-gma.confirm-modal.loading","Loading..."),onDismiss:n,onClickBackdrop:n,children:(0,e.jsx)(M.E,{children:(0,a.t)("alerting.import-to-gma.confirm-modal.loading-body","Preparing data to be imported. This can take a while...")})});async function rr(){if(!K&&!d){ae.error((0,a.t)("alerting.import-to-gma.error","Failed to import alert rules: {{error}}",{error:"No data source selected"}));return}try{await er({dataSourceUID:i==="yaml"?K??"":d??"",targetFolderUID:F?.uid,pauseRecordingRules:X,pauseAlerts:q,payload:b,targetDatasourceUID:W}).unwrap();const Y=(0,J.isEmpty)(F?.uid);(0,ie.iF)({importSource:i,isRootFolder:Y,namespace:I,ruleGroup:C,pauseRecordingRules:X,pauseAlertingRules:q});const or=(0,Ie.tx)(Y?[]:[["namespace",F?.title??""]],{skipSubPath:!0});ae.success((0,a.t)("alerting.import-to-gma.success","Successfully imported alert rules to Grafana-managed rules.")),ye.Ny.push(or)}catch(Y){(0,ie.Tc)({importSource:i}),ae.error((0,a.t)("alerting.import-to-gma.error","Failed to import alert rules: {{error}}",{error:(0,p.JZ)(Y)}))}}if((0,J.isEmpty)(b))return(0,e.jsx)(ne.a,{isOpen:o,title:(0,a.t)("alerting.import-to-gma.confirm-modal.no-rules-title","No rules to import"),onDismiss:n,onClickBackdrop:n,children:(0,e.jsxs)(h.B,{direction:"column",gap:2,children:[he&&(0,e.jsx)(de,{}),(0,e.jsx)(M.E,{children:i==="yaml"?(0,a.t)("alerting.import-to-gma.confirm-modal.no-rules-body-yaml","There are no rules to import. Please select a different yaml file."):(0,a.t)("alerting.import-to-gma.confirm-modal.no-rules-body","There are no rules to import. Please select a different namespace or rule group.")})]})});const tr=(0,a.t)("alerting.import-to-gma.confirm-modal.title","Confirm import"),ar=(0,a.t)("alerting.import-to-gma.confirm-modal.confirm","Import");return(0,e.jsx)(De.u,{isOpen:o,title:tr,confirmText:ar,confirmButtonVariant:"primary",modalClass:l.modal,body:(0,e.jsxs)(h.B,{direction:"column",gap:2,children:[!(0,J.isEmpty)(ve)&&(0,e.jsx)(ze,{targetFolderRules:ve}),(0,e.jsx)(be,{}),he&&(0,e.jsx)(de,{}),(0,e.jsx)(M.E,{variant:"h6",children:(0,e.jsx)(a.x6,{i18nKey:"alerting.to-gma.confirm-modal.summary",children:"The following alert rules will be imported:"})}),b&&(0,e.jsx)(me,{rules:b})]}),onConfirm:rr,onDismiss:n})};function Ve(t,o,n){const s={};let l=!1;return Object.entries(t).forEach(([i,v])=>{if(o&&i!==o)return;const d=v.filter(E=>!(n&&E.name!==n)).map(E=>{const F=E.rules.filter(I=>we(I)?(l=!0,!1):!0);return{...E,rules:F}}).filter(E=>E.rules.length>0);d.length>0&&(s[i]=d)}),{filteredConfig:s,someRulesAreSkipped:l}}function we(t){if((0,le.Tm)(t)||t.labels?.namespace?.startsWith("integrations-"))return!0;if(!(t.labels?.namespace==="synthetic_monitoring"))return!1;const l=(0,le.qz)(t);return Ke.some(i=>i===l)}function me({rules:t}){const o=(0,oe.of)(ge);return(0,e.jsx)("div",{className:o.content,children:(0,e.jsx)(Ee.B,{width:"100%",height:500,language:"json",value:JSON.stringify(t,null,4),monacoOptions:{minimap:{enabled:!1},scrollBeyondLastLine:!1,lineNumbers:"on",readOnly:!0}})})}const ge=()=>({content:(0,k.css)({flex:"1 1 100%"}),modal:(0,k.css)({width:"800px"})});function ze({targetFolderRules:t}){const[o,n]=(0,L.A)(!1);return(0,e.jsxs)(h.B,{direction:"column",gap:2,children:[(0,e.jsx)(re.F,{title:(0,a.t)("alerting.to-gma.confirm-modal.title-warning","Warning"),severity:"warning",children:(0,e.jsx)(M.E,{variant:"body",children:(0,e.jsx)(a.x6,{i18nKey:"alerting.to-gma.confirm-modal.body",children:"The target folder is not empty, some rules may be overwritten or removed. Are you sure you want to import these alert rules to Grafana-managed rules?"})})}),t&&(0,e.jsx)(O.S,{label:(0,a.t)("alerting.import-to-gma.confirm-modal.target-folder-rules","Target folder rules that might be overwritten"),isOpen:o,onToggle:n,collapsible:!0,children:(0,e.jsx)(me,{rules:t})})]})}var fe=r(43243);const $e=({rulesSourceName:t})=>{const{control:o,watch:n,formState:{errors:s},setValue:l}=(0,m.xW)(),i=n("namespace"),{namespaceGroups:v,isLoading:d}=(0,ue.$i)(t),E=(0,x.useMemo)(()=>Array.from(v.keys()).map(I=>({label:I,value:I})),[v]),F=(0,x.useMemo)(()=>i&&v.get(i)?.map(I=>({label:I,value:I}))||[],[i,v]);return(0,x.useEffect)(()=>{l("namespace",""),l("ruleGroup","")},[t,l]),(0,e.jsxs)(h.B,{direction:"row",gap:2,children:[(0,e.jsx)(j.D,{htmlFor:"namespace-picker","data-testid":"namespace-picker",label:(0,a.t)("alerting.import-to-gma.namespace.label","Namespace"),description:(0,a.t)("alerting.import-to-gma.namespace.description","Type to search for an existing namespace"),error:s.namespace?.message,invalid:!!s.namespace?.message,children:(0,e.jsx)(m.xI,{render:({field:{onChange:I,ref:C,...W}})=>(0,e.jsx)(fe.G,{...W,onChange:K=>{l("ruleGroup",""),I(K?.value)},id:"namespace-picker",placeholder:(0,a.t)("alerting.namespace-and-group-filter.select-namespace","Select namespace"),options:E,width:42,loading:d,disabled:d||!t,isClearable:!0}),name:"namespace",control:o})}),(0,e.jsx)(j.D,{htmlFor:"group-picker","data-testid":"group-picker",label:(0,a.t)("alerting.import-to-gma.group.label","Group"),description:(0,a.t)("alerting.import-to-gma.group.description","Type to search for an existing group"),error:s.ruleGroup?.message,invalid:!!s.ruleGroup?.message,children:(0,e.jsx)(m.xI,{render:({field:{ref:I,...C}})=>(0,e.jsx)(fe.G,{...C,options:F,width:42,onChange:W=>{l("ruleGroup",W?.value??"")},id:"group-picker",placeholder:(0,a.t)("alerting.namespace-and-group-filter.select-group","Select group"),loading:d,disabled:d||!i||!t,isClearable:!0}),name:"ruleGroup",control:o})})]})},He=[u.ol.Prometheus,u.ol.Loki],Je=()=>{const t=(0,m.mN)({defaultValues:{importSource:"datasource",yamlFile:null,yamlImportTargetDatasourceUID:void 0,selectedDatasourceUID:void 0,selectedDatasourceName:void 0,pauseAlertingRules:!0,pauseRecordingRules:!0,targetFolder:void 0,targetDatasourceUID:void 0}}),{register:o,handleSubmit:n,watch:s,control:l,setValue:i,formState:{errors:v,isSubmitting:d}}=t,[E,F]=(0,L.A)(!0),[I,C]=s(["selectedDatasourceName","importSource"]),[W,K]=(0,x.useState)(null),X=R.$.featureToggles.alertingImportYAMLUI,q=async Z=>{K(Z)},_=[{label:(0,a.t)("alerting.import-to-gma.source.datasource","Existing data source-managed rules"),description:(0,a.t)("alerting.import-to-gma.source.datasource-description","Import rules from existing data sources"),value:"datasource"}];return X&&_.push({label:(0,a.t)("alerting.import-to-gma.source.yaml","Prometheus YAML file"),description:(0,a.t)("alerting.import-to-gma.source.yaml-description","Import rules from a Prometheus YAML file."),value:"yaml"}),(0,e.jsx)(T.d,{navId:"alert-list",pageNav:{text:(0,a.t)("alerting.import-to-gma.pageTitle","Import alert rules")},children:(0,e.jsx)(h.B,{gap:2,direction:"column",children:(0,e.jsx)(m.Op,{...t,children:(0,e.jsxs)("form",{onSubmit:n(q),children:[(0,e.jsxs)(h.B,{direction:"column",gap:1,children:[(0,e.jsx)(j.D,{label:(0,a.t)("alerting.import-to-gma.import-source","Import source"),invalid:!!v.importSource,error:v.importSource?.message,htmlFor:"import-source",noMargin:!0,children:(0,e.jsx)(m.xI,{render:({field:{onChange:Z,ref:pe,...ee}})=>(0,e.jsx)(P.a,{...ee,onChange:b=>i("importSource",b),options:_}),control:l,name:"importSource"})}),C==="datasource"&&(0,e.jsx)(qe,{}),X&&C==="yaml"&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(Qe,{}),(0,e.jsx)(Xe,{})]}),(0,e.jsxs)(O.S,{label:(0,a.t)("alerting.import-to-gma.additional-settings","Additional settings"),isOpen:E,onToggle:F,collapsible:!0,children:[(0,e.jsxs)(g.a,{marginLeft:1,children:[(0,e.jsx)(g.a,{marginBottom:2,children:(0,e.jsx)(M.E,{variant:"h5",children:(0,a.t)("alerting.import-to-gma.import-location-and-filters","Import location and filters")})}),(0,e.jsxs)(h.B,{direction:"column",gap:2,children:[(0,e.jsx)(ke,{}),C==="datasource"&&(0,e.jsx)($e,{rulesSourceName:I||void 0})]})]}),(0,e.jsx)(B.c,{}),(0,e.jsxs)(g.a,{children:[(0,e.jsx)(g.a,{marginLeft:1,marginBottom:1,children:(0,e.jsx)(M.E,{variant:"h5",children:(0,a.t)("alerting.import-to-gma.alert-rules","Alert rules")})}),(0,e.jsx)(G.I,{transparent:!0,label:(0,a.t)("alerting.import-to-gma.pause.label","Pause imported alerting rules"),labelWidth:30,htmlFor:"pause-alerting-rules",children:(0,e.jsx)(U.K,{transparent:!0,id:"pause-alerting-rules",...o("pauseAlertingRules"),showLabel:!1})})]}),(0,e.jsx)(B.c,{}),(0,e.jsxs)(g.a,{children:[(0,e.jsx)(g.a,{marginBottom:1,marginLeft:1,children:(0,e.jsx)(M.E,{variant:"h5",children:(0,a.t)("alerting.import-to-gma.recording-rules","Recording rules")})}),(0,e.jsx)(z.C,{children:(0,e.jsx)(G.I,{transparent:!0,label:(0,a.t)("alerting.import-to-gma.pause-recording.label","Pause imported recording rules"),labelWidth:30,htmlFor:"pause-recording-rules",children:(0,e.jsx)(U.K,{transparent:!0,id:"pause-recording-rules",...o("pauseRecordingRules")})})}),(0,e.jsx)(g.a,{marginLeft:1,width:50,children:(0,e.jsx)(Ze,{})})]})]})]}),(0,e.jsx)(g.a,{marginTop:2,children:(0,e.jsxs)(h.B,{gap:1,children:[(0,e.jsx)(V.$n,{type:"submit",variant:"primary",disabled:d,children:(0,e.jsxs)(h.B,{direction:"row",gap:2,alignItems:"center",children:[d&&(0,e.jsx)($.y,{inline:!0}),(0,e.jsx)(a.x6,{i18nKey:"alerting.import-to-gma.action-button",children:"Import"})]})}),(0,e.jsx)(V.z9,{variant:"secondary",href:"/alerting/list",children:(0,e.jsx)(a.x6,{i18nKey:"common.cancel",children:"Cancel"})})]})}),W&&(0,e.jsx)(Ye,{isOpen:!!W,onDismiss:()=>K(null),importPayload:W})]})})})})};function Qe(){const{formState:{errors:t}}=(0,m.xW)();return(0,e.jsx)(j.D,{label:(0,a.t)("alerting.import-to-gma.yaml.label","Prometheus YAML file"),invalid:!!t.yamlFile,error:t.yamlFile?.message,description:(0,a.t)("alerting.import-to-gma.yaml.description","Select a Prometheus-compatible YAML file to import"),noMargin:!0,children:(0,e.jsx)(m.xI,{name:"yamlFile",render:({field:{onChange:o,ref:n,...s}})=>(0,e.jsx)(y.e,{...s,onFileUpload:l=>{const i=l.currentTarget.files?.item(0);o(i),l.currentTarget.value=""},size:"sm",showFileName:!0,accept:".yaml,.yml,.json"}),rules:{required:{value:!0,message:(0,a.t)("alerting.import-to-gma.yaml.required-message","Please select a file")},validate:async o=>{if(!o)return(0,a.t)("alerting.import-to-gma.yaml.required-message","Please select a file");try{return await ce(o,o.name),!0}catch(n){return(0,a.t)("alerting.import-to-gma.yaml-error","Failed to parse YAML file: {{error}}",{error:(0,p.JZ)(n)})}}}})})}function Xe(){const{formState:{errors:t},setValue:o,getValues:n}=(0,m.xW)();return(0,e.jsx)(j.D,{label:(0,a.t)("alerting.import-to-gma.yaml.target-datasource","Target data source"),description:(0,a.t)("alerting.import-to-gma.yaml.target-datasource-description","Select the data source that will be queried by the imported rules. Make sure metrics used in the imported rules are available in this data source."),invalid:!!t.yamlImportTargetDatasourceUID,error:t.yamlImportTargetDatasourceUID?.message,htmlFor:"yaml-target-data-source",noMargin:!0,children:(0,e.jsx)(m.xI,{name:"yamlImportTargetDatasourceUID",render:({field:{onChange:s,ref:l,value:i,...v}})=>(0,e.jsx)(f.s,{...v,current:i,noDefault:!0,inputId:"yaml-target-data-source",alerting:!0,filter:d=>(0,u.bS)(d.type),onChange:d=>{o("yamlImportTargetDatasourceUID",d.uid),!n("targetDatasourceUID")&&(0,u.Gb)(d)&&o("targetDatasourceUID",d.uid)}}),rules:{required:{value:!0,message:(0,a.t)("alerting.import-to-gma.yaml.target-datasource-required","Please select a target data source")}}})})}function Ze(){const{control:t,formState:{errors:o},setValue:n}=(0,m.xW)();return(0,e.jsx)(j.D,{required:!0,label:(0,a.t)("alerting.recording-rules.label-target-data-source","Target data source"),description:(0,a.t)("alerting.recording-rules.description-target-data-source","The Prometheus data source to store recording rules in"),htmlFor:"recording-rules-target-data-source",error:o.targetDatasourceUID?.message,invalid:!!o.targetDatasourceUID?.message,noMargin:!0,children:(0,e.jsx)(m.xI,{render:({field:{onChange:s,ref:l,...i}})=>(0,e.jsx)(f.s,{...i,current:i.value,inputId:"recording-rules-target-data-source",noDefault:!0,filter:u.Gb,onChange:v=>{n("targetDatasourceUID",v.uid)}}),name:"targetDatasourceUID",control:t,rules:{required:{value:!0,message:(0,a.t)("alerting.recording-rules.target-data-source-required","Please select a target data source")}}})})}function ke(){const{control:t,formState:{errors:o},setValue:n}=(0,m.xW)();return(0,e.jsx)(j.D,{label:(0,a.t)("alerting.import-to-gma.target-folder.label","Target folder"),description:(0,a.t)("alerting.import-to-gma.target-folder.description","The folder to import the rules to"),error:o.targetFolder?.message,htmlFor:"folder-picker",noMargin:!0,children:(0,e.jsxs)(h.B,{gap:2,children:[(0,e.jsx)(m.xI,{name:"targetFolder",render:({field:{onChange:s,ref:l,...i}})=>(0,e.jsx)(h.B,{width:42,children:(0,e.jsx)(c.NestedFolderPicker,{permission:"view",showRootFolder:!1,invalid:!!o.targetFolder?.message,...i,value:i.value?.uid,onChange:(v,d)=>{v&&d?n("targetFolder",{title:d,uid:v}):n("targetFolder",void 0)}})}),control:t}),(0,e.jsx)(A.x,{onCreate:s=>{n("targetFolder",s)}})]})})}function qe(){const{control:t,formState:{errors:o},setValue:n,getValues:s}=(0,m.xW)();return(0,e.jsx)(j.D,{label:(0,e.jsxs)(h.B,{direction:"row",gap:1,children:[(0,e.jsx)(M.E,{variant:"bodySmall",color:"secondary",children:(0,a.t)("alerting.import-to-gma.datasource.label","Data source")}),(0,e.jsx)(N.G,{externalLink:"https://grafana.com/docs/grafana/latest/alerting/alerting-rules/alerting-migration/",linkText:"Read importing to Grafana alerting",contentText:(0,a.t)("alerting.import-to-gma.datasource.help-info.content","The dropdown only displays Mimir or Loki data sources that have the ruler API available."),title:(0,a.t)("alerting.import-to-gma.datasource.help-info.title","Data source")})]}),invalid:!!o.selectedDatasourceName,error:o.selectedDatasourceName?.message,htmlFor:"datasource-picker",noMargin:!0,children:(0,e.jsx)(m.xI,{name:"selectedDatasourceName",render:({field:{onChange:l,ref:i,...v}})=>(0,e.jsx)(H.q,{...v,width:50,inputId:"datasource-picker",onChange:d=>{if(n("selectedDatasourceUID",d.uid),n("selectedDatasourceName",d.name),!s("targetDatasourceUID")){const F=(0,u.Gb)(d)?d.uid:void 0;n("targetDatasourceUID",F)}}}),control:t,rules:{required:{value:!0,message:(0,a.t)("alerting.import-to-gma.datasource.required-message","Please select a data source")}}})})}const _e=(0,D.S)(Je)},38133:(w,S,r)=>{r.d(S,{q:()=>a});var e=r(74848),x=r(96540),m=r(76792),L=r(24296);function a({value:R,disabled:h,...j}){const{rulesSourcesWithRuler:P,isLoading:O}=(0,L.z)(),g=(0,x.useCallback)(M=>P.some(({uid:B})=>B===M.uid),[P]);return(0,e.jsx)(m.s,{disabled:O||h,noDefault:!0,alerting:!0,filter:g,current:R,...j})}},25521:(w,S,r)=>{r.d(S,{G:()=>P});var e=r(74848),x=r(22803),m=r(92745),L=r(63142),a=r(59243),R=r(41654),h=r(30703),j=r(66404);function P({contentText:g,externalLink:M,linkText:B,title:G="Need help?"}){const U=(0,L.of)(O);return(0,e.jsx)(a.G,{content:(0,e.jsx)("div",{className:U.mutedText,children:g}),title:(0,e.jsxs)(R.B,{gap:.5,direction:"row",alignItems:"center",children:[(0,e.jsx)(h.I,{name:"question-circle"}),G]}),footer:M?(0,e.jsx)("a",{href:M,target:"_blank",rel:"noreferrer",children:(0,e.jsx)(R.B,{direction:"row",gap:.5,alignItems:"center",children:(0,e.jsxs)(j.E,{color:"link",children:[B," ",(0,e.jsx)(h.I,{size:"sm",name:"external-link-alt"})]})})}):void 0,closeButton:!0,placement:"bottom-start",children:(0,e.jsx)("div",{className:U.helpInfo,children:(0,e.jsxs)(R.B,{direction:"row",alignItems:"center",gap:.5,children:[(0,e.jsx)(h.I,{name:"question-circle",size:"sm"}),(0,e.jsx)(j.E,{variant:"bodySmall",color:"primary",children:(0,e.jsx)(m.x6,{i18nKey:"alerting.need-help-info.need-help",children:"Need help?"})})]})})})}const O=g=>({mutedText:(0,x.css)({color:g.colors.text.secondary,fontSize:g.typography.size.sm}),helpInfo:(0,x.css)({cursor:"pointer",textDecoration:"underline"})})},59672:(w,S,r)=>{r.d(S,{$i:()=>B,DJ:()=>M,h$:()=>G});var e=r(10378),x=r(96540),m=r(70327),L=r(55143),a=r(74869);const{usePrometheusRuleNamespacesQuery:R,useLazyRulerRulesQuery:h,useRulerRulesQuery:j}=m.hK,{useDiscoverDsFeaturesQuery:P}=L.L,O={},g=(0,a.wS)();function M(y){const{data:c,isLoading:f}=P({rulesSourceName:y}),[u,{data:p=O,isLoading:D}]=h(),{data:T=[],isLoading:A}=R({ruleSourceName:y},{skip:!g});return(0,x.useEffect)(()=>{c?.rulerConfig&&!g&&u({rulerConfig:c.rulerConfig})},[c?.rulerConfig,u]),{labels:(0,x.useMemo)(()=>A||D?new Map:g?V(T):$(p),[T,p,A,D]),isLoading:A||D||f}}function B(y){const{data:c,isLoading:f}=P(y?{rulesSourceName:y}:e.hT,{skip:!y}),[u,{data:p=O,isLoading:D}]=h(),{data:T=[],isLoading:A}=R(y&&g?{ruleSourceName:y}:e.hT);return(0,x.useEffect)(()=>{c?.rulerConfig&&!g&&u({rulerConfig:c.rulerConfig})},[c?.rulerConfig,u]),{namespaceGroups:(0,x.useMemo)(()=>A||D?new Map:g?U(T):z(p),[T,p,A,D]),isLoading:A||D||f,promNamespaces:T}}function G(y){const{data:c,isLoading:f}=P(y?{rulesSourceName:y}:e.hT),{data:u=O,isLoading:p}=j(c?.rulerConfig?{rulerConfig:c.rulerConfig}:e.hT);return{isLoading:p||f,rulerRules:u}}function U(y){const c=new Map;return y.forEach(f=>{c.set(f.name,f.groups.map(u=>u.name))}),c}function z(y){const c=new Map;return Object.entries(y).forEach(([f,u])=>{c.set(f,u.map(p=>p.name))}),c}function V(y){return y.flatMap(f=>f.groups).flatMap(f=>f.rules).reduce((f,u)=>(u.labels&&Object.entries(u.labels).forEach(([p,D])=>{if(!p||!D)return;const T=f.get(p);T?T.add(D):f.set(p,new Set([D]))}),f),new Map)}function $(y){const c=new Map;return Object.entries(y).flatMap(([u,p])=>p).flatMap(u=>u.rules).reduce((u,p)=>(p.labels&&Object.entries(p.labels).forEach(([D,T])=>{if(!D||!T)return;const A=u.get(D);A?A.add(T):u.set(D,new Set([T]))}),u),c)}},24296:(w,S,r)=>{r.d(S,{z:()=>a});var e=r(96540),x=r(55143),m=r(52161);const{useLazyDiscoverDsFeaturesQuery:L}=x.L;function a(){const[R,h]=(0,e.useState)([]),[j,{isLoading:P}]=L();return(0,e.useEffect)(()=>{(0,m.qi)().forEach(async g=>{const{data:M}=await j({uid:g.uid},!0);M?.rulerConfig&&h(B=>[...B,g])})},[j]),{rulesSourcesWithRuler:R,isLoading:P}}}}]);

//# sourceMappingURL=AlertingImportFromDSRules.965337117394da161726.js.map