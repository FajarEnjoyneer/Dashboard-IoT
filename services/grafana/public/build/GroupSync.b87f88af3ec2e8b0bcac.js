"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[8573],{99686:(Z,E,n)=>{n.d(E,{P:()=>U,o:()=>L});var e=n(2543),x=n.n(e),u=n(96540),M=n(45214),i=n(24705),p=n(73427),S=n(11257),I=n(34418);const L=D=>{const[f,j]=(0,u.useState)(D),{value:v=[]}=(0,i.A)(async()=>p.TP.licensedAccessControlEnabled()&&p.TP.hasPermission(S.w.ActionRolesList)?(0,I.RL)(f):Promise.resolve([]),[f]);return[{roleOptions:v},j]},U=D=>{const[f,j]=(0,u.useState)({});return(0,M.A)(()=>{if(!p.TP.licensedAccessControlEnabled()||!p.TP.hasPermission(S.w.ActionRolesList))return;const v=Object.keys(f).map(d=>typeof d=="number"?d:parseInt(d,10)),C=(0,e.difference)(D,v);Promise.all(C.map(d=>(0,I.RL)(d).then(K=>[d,K]))).then(d=>{j({...f,...Object.fromEntries(d)})})},[D]),f}},56878:(Z,E,n)=>{n.r(E),n.d(E,{default:()=>ie});var e=n(74848),x=n(2543),u=n(96540),M=n(71468),i=n(92745),p=n(41654),S=n(12737),I=n(45861),L=n(71599),U=n(34999),D=n(27594),f=n(34213),j=n(63722),v=n(13791),C=n(59812),d=n(99686),K=n(50201),H=n(89640);function Q(){return(0,e.jsx)(K.p,{variant:"call-to-action",message:(0,i.t)("groupsync.empty-state.title","You haven't created any group mappings yet"),children:(0,e.jsxs)(i.x6,{i18nKey:"groupsync.empty-state.pro-tip",children:["Want to manage Grafana access through groups in your Identity Provider? Create group mappings to Grafana RBAC roles."," ",(0,e.jsx)(H.Y,{external:!0,href:"https://grafana.com/docs/grafana/latest/administration/group-attribute-sync",children:"Learn more"})]})})}var z=n(37386),V=n(63527),W=n(73427),X=n(24705),A=n(68143);const b=50;function N(s,t,r){const o={page:s,perPage:t};return typeof r.groupID=="string"&&r.groupID.trim().length>0&&(o.groupID=encodeURIComponent(r.groupID)),(0,A.AI)().get("/api/groupsync/groups",o)}async function k(s,t){await(0,A.AI)().post(`/api/groupsync/groups/${encodeURIComponent(s)}`,t)}async function Y(s,t){await(0,A.AI)().put(`/api/groupsync/groups/${encodeURIComponent(s)}`,t)}async function q(s){await(0,A.AI)().delete(`/api/groupsync/groups/${encodeURIComponent(s)}`)}function _(s,t){const[r,o]=(0,u.useState)([]),[g,l]=(0,u.useState)(!0),[c,P]=(0,u.useState)(!1),[O,m]=(0,u.useState)(0),[a,T]=(0,u.useState)(s),[h,G]=(0,u.useState)(t);(0,X.A)(async()=>{l(!0);const y=await N(a,b,h);o(y.groups),m(y.total),l(!1),c||P(!0)},[a,h]);function w(y){G({...h,groupID:y})}async function R(y){let F=a;y&&(T(1),F=1),l(!0);const B=await N(F,b,h);o(B.groups),m(B.total),l(!1)}return{groups:r,loading:g,initialized:c,total:O,page:a,setPage:T,filters:h,setGroupIDFilter:w,refresh:R}}const J={groupID:"",mappings:{}};function ee(s=J){const[t,r]=(0,u.useState)(s);return{group:t,setGroupID:o=>{r({...t,groupID:o})},setRoles:(o,g)=>{r(l=>{const c=(0,x.cloneDeep)(l.mappings);return c[o]===void 0?c[o]={roles:g}:c[o].roles=g,{...l,mappings:c}})},canSave:()=>!(t.groupID.length===0||(0,x.isEqual)(t.mappings,s.mappings)),save:o=>s.groupID===""?k(t.groupID,t.mappings[o]):Y(t.groupID,t.mappings[o]),reset:()=>{r(J)}}}function te({onSave:s}){const t=ee(),[{roleOptions:r}]=(0,d.o)(W.TP.user.orgId),[o,g]=(0,u.useState)([]),[l,c]=(0,u.useState)(!1),P=m=>{m.preventDefault(),c(!0),t.save(W.TP.user.orgId).then(()=>{c(!1),g([]),s(t.group),t.reset()}).catch(a=>{console.error(a)})},O=m=>{t.setGroupID(m.currentTarget.value)};return(0,e.jsx)("form",{onSubmit:P,children:(0,e.jsxs)(p.B,{gap:1,alignItems:"end",children:[(0,e.jsx)(z.D,{label:(0,i.t)("groupsync.new-mapping-form.label-group-id","Group ID"),style:{marginBottom:0},children:(0,e.jsx)(V.p,{type:"text",name:"groupID",value:t.group.groupID,onChange:O,width:50})}),(0,e.jsx)(z.D,{label:(0,i.t)("groupsync.new-mapping-form.label-roles","Roles"),style:{marginBottom:0},children:(0,e.jsx)(C.n,{appliedRoles:o,onRolesChange:m=>{g(m),t.setRoles(W.TP.user.orgId,m.map(a=>a.uid))},roleOptions:r,basicRoleDisabled:!0,canUpdateRoles:!0})}),(0,e.jsx)(I.$n,{type:"submit",disabled:!t.canSave()||l,children:(0,e.jsx)(i.x6,{i18nKey:"groupsync.new-mapping-form.save",children:"Save"})})]})})}function ne(s){const t=[];for(const r of s)for(const[o,g]of Object.entries(r.mappings))t.push({groupID:r.groupID,orgID:parseInt(o,10),roles:g.roles});return t}function oe(s){const t=new Set;return s.forEach(r=>t.add(r.orgID)),Array.from(t)}function se({groupsList:s}){const[t,r]=(0,u.useState)(!1);return(0,e.jsxs)(p.B,{direction:"column",gap:2,children:[(0,e.jsxs)(p.B,{justifyContent:"space-between",children:[(0,e.jsx)(p.B,{gap:1,children:(0,e.jsx)(S.Z,{value:s.filters.groupID,onChange:s.setGroupIDFilter,placeholder:(0,i.t)("groupsync.group-sync-editor.placeholder-search-by-group-id","Search by group ID"),width:60})}),(0,e.jsx)(I.$n,{onClick:()=>r(!t),children:t?(0,i.t)("groupsync.group-sync-editor.close-button-drawer","Close"):(0,i.t)("groupsync.group-sync-editor.new-button-drawer","New")})]}),(0,e.jsx)(j.a,{in:t,children:(0,e.jsx)("div",{className:"cta-form",style:{marginBottom:0},children:(0,e.jsxs)(p.B,{direction:"column",gap:1,children:[(0,e.jsx)("h5",{children:(0,e.jsx)(i.x6,{i18nKey:"groupsync.group-sync-editor.new-group-mapping",children:"New group mapping"})}),t&&(0,e.jsx)(te,{onSave:()=>s.refresh(!0)})]})})})]})}function re({userOrgs:s}){const[t,r]=(0,u.useState)(""),o=_(1,{groupID:""}),g=ne(o.groups),l=oe(g);l.length===0&&l.push(1);const c=(0,d.P)(l),P=s.length===1;function O(){q(t).then(()=>{o.refresh(!1)}).finally(()=>{r("")})}const m=(0,u.useMemo)(()=>[{id:"groupID",header:"Group",cell:({cell:a})=>(0,e.jsx)("code",{children:a.value})},{id:"roles",header:"Roles",cell:({cell:a})=>{const{orgID:T,groupID:h}=a.row.original,G=c[a.row.original.orgID]||[],w=R=>{const y=o.groups.find($=>$.groupID===h);if(y===void 0)throw new Error("expected groupsList to contain table item");const B={...(0,x.cloneDeep)(y).mappings[T],roles:R.map($=>$.uid)};Y(h,B)};return(0,e.jsx)(C.n,{appliedRoles:G.filter(R=>a.row.original.roles.includes(R.uid)),onRolesChange:w,roleOptions:G,basicRoleDisabled:!0,apply:!0,canUpdateRoles:!0})}},{id:"delete",header:"",cell:({cell:a})=>(0,e.jsx)(p.B,{justifyContent:"end",children:(0,e.jsx)(I.$n,{variant:"secondary",onClick:()=>r(a.row.original.groupID),icon:"trash-alt","aria-label":(0,i.t)("groupsync.group-sync-editor.delete-group-mapping","Delete group mapping")})})}],[o,c]);return(0,e.jsxs)(v.Y,{navId:"groupsync",children:[(0,e.jsx)(L.u,{isOpen:!(0,x.isEmpty)(t),title:(0,i.t)("groupsync.group-sync-editor.title-delete-group-mappings","Delete group mappings"),body:(0,i.t)("groupsync.group-sync-editor.body-delete-group-mappings","Are you sure you want to delete all mappings for this group?"),confirmText:(0,i.t)("groupsync.group-sync-editor.confirm-text-delete-group-mappings","Delete"),onConfirm:O,onDismiss:()=>r("")}),(0,e.jsx)(v.Y.Contents,{isLoading:o.loading&&!o.initialized,children:(0,e.jsxs)(p.B,{direction:"column",gap:1,children:[(0,e.jsx)(U.F,{severity:"warning",title:(0,i.t)("groupsync.group-sync-editor.title-deprecated-feature","Deprecated Feature"),children:(0,e.jsx)("p",{children:(0,e.jsx)(i.x6,{i18nKey:"groupsync.group-sync-editor.text-deprecated-feature",children:"This feature is deprecated and your rules will stop working in June 2025. Please migrate to external group sync in the desired team's settings and assign roles to teams."})})}),(0,e.jsx)(se,{groupsList:o,singleOrg:P}),o.initialized&&o.groups.length>0?(0,e.jsx)(D.j,{columns:m,data:g,getRowId:a=>`${a.orgID}/${a.groupID}`}):(0,e.jsx)(Q,{}),o.total>50&&(0,e.jsx)(p.B,{justifyContent:"end",children:(0,e.jsx)(f.d,{currentPage:o.page,numberOfPages:Math.ceil(o.total/50),onNavigate:a=>{o.setPage(a)}})})]})})]})}const ae=s=>({userOrgs:s.organization.userOrgs}),ie=(0,M.connect)(ae,{})(re)}}]);

//# sourceMappingURL=GroupSync.b87f88af3ec2e8b0bcac.js.map